name: "ðŸ”„ Concurrency Control + Runner Self-Heal + Auto-Retry (Stable Logs)"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  REPORT_DIR: .github/echo_report

jobs:
  ##########################################################################
  # 0. Runner ì²´í¬ & Clean-up
  ##########################################################################
  prep_and_clean:
    name: "Runner Pre-Check / Cleanup"
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      disk_ok: ${{ steps.check.outputs.disk_ok }}
      mem_ok:  ${{ steps.check.outputs.mem_ok }}

    steps:
      - name: Prep dirs (initial)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          touch "${LOG_DIR}/.keep" "${REPORT_DIR}/.keep"

      - name: Snapshot (before cleanup)
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo "=== SNAPSHOT BEFORE CLEANUP ==="
            uname -a || true
            df -h || true
            free -m || true
            docker ps -a || true
            docker images || true
          } | tee "${LOG_DIR}/00_before_cleanup.txt"

      - name: Cleanup docker & caches
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo ">>> docker prune"
            docker system prune -af || true
            docker volume prune -f || true
            echo ">>> apt clean"
            sudo apt-get clean || true
            sudo apt-get autoremove -y || true
          } | tee "${LOG_DIR}/01_cleanup.txt"

      - name: Resource check
        id: check
        shell: bash
        run: |
          set -Eeuo pipefail
          DISK=$(df -BG / | awk 'NR==2 {gsub("G","",$4); print $4}')
          MEM=$(free -m | awk '/Mem:/ {print $4}')
          DISK_OK="true"
          MEM_OK="true"
          if [ "$DISK" -lt 2 ]; then DISK_OK="false"; fi
          if [ "$MEM" -lt 512 ]; then MEM_OK="false"; fi

          echo "disk_ok=$DISK_OK" >> $GITHUB_OUTPUT
          echo "mem_ok=$MEM_OK" >> $GITHUB_OUTPUT
          {
            echo "=== RESOURCE CHECK ==="
            echo "DISK=${DISK}G"
            echo "DISK_OK=$DISK_OK"
            echo "MEM=${MEM}MB"
            echo "MEM_OK=$MEM_OK"
          } | tee "${LOG_DIR}/02_resource_check.txt"

      - name: Upload runner prep logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runner-prep
          path: ${{ env.LOG_DIR }}/


  ##########################################################################
  # 1. Attempt #1
  ##########################################################################
  attempt1:
    name: "Build & Test â€” Attempt #1"
    runs-on: ubuntu-latest
    needs: prep_and_clean
    continue-on-error: true
    outputs:
      status: ${{ steps.mark.outputs.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: pip

      - name: Prepare dirs
        shell: bash
        run: |
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"

      - name: Install Node deps
        shell: bash
        id: npminstall
        run: |
          npm ci 2>&1 | tee "${LOG_DIR}/11_npm_attempt1.txt"

      - name: Install Python deps
        shell: bash
        run: |
          pip install -r requirements.txt 2>&1 | tee "${LOG_DIR}/12_pip_attempt1.txt"

      - name: Build/Test
        id: buildtest
        shell: bash
        run: |
          echo "=== Attempt #1 ===" | tee "${LOG_DIR}/13_attempt1_run.txt"
          npm run lint 2>&1 | tee -a "${LOG_DIR}/13_attempt1_run.txt"
          npm run format:check 2>&1 | tee -a "${LOG_DIR}/13_attempt1_run.txt"
          npm run build 2>&1 | tee -a "${LOG_DIR}/13_attempt1_run.txt"

          if [ -d dist ] && [ -n "$(ls -A dist)" ]; then
            echo "success" > .result
          else
            echo "failure" > .result
          fi

      - name: Mark status
        id: mark
        run: |
          STATUS=$(cat .result)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Attempt1: $STATUS" | tee "${LOG_DIR}/14_attempt1_status.txt"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: attempt1-logs
          path: ${{ env.LOG_DIR }}/


  ##########################################################################
  # 2. Attempt #2 (Auto Retry)
  ##########################################################################
  attempt2:
    name: "Build & Test â€” Attempt #2 (Retry)"
    runs-on: ubuntu-latest
    needs: [prep_and_clean, attempt1]
    if: ${{ needs.attempt1.outputs.status != 'success' }}
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: pip

      - name: Prepare dirs
        run: |
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"

      - name: Install Node deps
        shell: bash
        run: |
          npm ci 2>&1 | tee "${LOG_DIR}/21_npm_attempt2.txt"

      - name: Install Python deps
        shell: bash
        run: |
          pip install -r requirements.txt 2>&1 | tee "${LOG_DIR}/22_pip_attempt2.txt"

      - name: Build/Test (retry)
        shell: bash
        run: |
          echo "=== Attempt #2 ===" | tee "${LOG_DIR}/23_attempt2_run.txt"
          npm run lint 2>&1 | tee -a "${LOG_DIR}/23_attempt2_run.txt"
          npm run format:check 2>&1 | tee -a "${LOG_DIR}/23_attempt2_run.txt"
          npm run build 2>&1 | tee -a "${LOG_DIR}/23_attempt2_run.txt"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: attempt2-logs
          path: ${{ env.LOG_DIR }}/


  ##########################################################################
  # 3. Final Report
  ##########################################################################
  final_report:
    name: "Final Summary"
    runs-on: ubuntu-latest
    needs:
      - prep_and_clean
      - attempt1
      - attempt2
    if: always()

    steps:
      - name: Gather report
        run: |
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          {
            echo "=== Final Result ==="
            echo "Attempt1=${{ needs.attempt1.outputs.status }}"
            echo "Attempt2=${{ needs.attempt2.result }}"
            echo "Disk OK=${{ needs.prep_and_clean.outputs.disk_ok }}"
            echo "Mem OK=${{ needs.prep_and_clean.outputs.mem_ok }}"
          } | tee "${REPORT_DIR}/final_summary.txt"

      - uses: actions/upload-artifact@v4
        with:
          name: final-summary
          path: ${{ env.REPORT_DIR }}/
