name: Dependabot Service Provisioning (with Echo Preview)

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: dependabot-provision-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  SERVICES: "python java linux ubuntu docker teradata nodejs"
  PREVIEW_LINES: "120"
  ECHO_DEBUG: "false"

jobs:
  prepare-assets:
    name: Prepare & Echo generated assets
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]' }}
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable debug echo (optional)
        if: env.ECHO_DEBUG == 'true'
        run: |
          set -x
          echo "Debug echo enabled (set -x)."

      - name: Generate service blueprints
        run: |
          set -euo pipefail

          preview() {
            local path="$1"
            local n="${2:-${PREVIEW_LINES}}"
            if [[ -f "$path" ]]; then
              echo "::group::Preview: $path (first ${n} lines)"
              echo "```"
              head -n "$n" "$path"
              echo "```"
              echo "::endgroup::"
              {
                echo "### Preview: \`$path\` (first ${n} lines)"
                echo
                echo '```'
                head -n "$n" "$path"
                echo '```'
                echo
              } >> "$GITHUB_STEP_SUMMARY"
            else
              echo "::warning:: File not found for preview: $path"
              {
                echo "### Preview: \`$path\`"
                echo
                echo "> ⚠️ File not found"
                echo
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          declare -A images=(
            [python]='python:3.11-slim'
            [java]='eclipse-temurin:17-jdk'
            [linux]='debian:stable-slim'
            [ubuntu]='ubuntu:22.04'
            [docker]='docker:dind'
            [teradata]='alpine:3.19'
            [nodejs]='node:20-alpine'
          )

          echo "Generating blueprints for services: ${SERVICES}"
          echo "Services: ${SERVICES}" >> "$GITHUB_STEP_SUMMARY"

          for service in ${SERVICES}; do
            service_dir="infrastructure/${service}"
            mkdir -p "${service_dir}/config"

            image="${images[$service]}"
            title="$(tr '[:lower:]' '[:upper:]' <<< ${service:0:1})${service:1}"

            cat > "${service_dir}/Dockerfile" <<DOCKERFILE
# Auto-generated Dockerfile for ${title} service
FROM ${image}
LABEL org.opencontainers.image.title="${title} service"
LABEL org.opencontainers.image.description="Container for ${title} workloads managed by Dependabot workflows"

RUN mkdir -p /opt/service && \
    echo "Provisioning ${title} runtime" > /opt/service/INSTALLATION.log

COPY config /opt/service/config
WORKDIR /opt/service

CMD ["/bin/sh", "-c", "echo '${title} container ready'; sleep 5"]
DOCKERFILE

            cat > "${service_dir}/server-install.sh" <<SERVER
#!/usr/bin/env bash
set -euo pipefail
# Simulated server installation script for ${title} service
log_dir="/opt/service"
mkdir -p "${log_dir}"
{
  echo "[${title}] Starting server installation"
  echo "[${title}] Installing core packages"
  echo "[${title}] Installation complete"
} > "${log_dir}/server-install.log"
SERVER
            chmod +x "${service_dir}/server-install.sh"

            cat > "${service_dir}/firewall-rules.sh" <<'FIREWALL'
#!/usr/bin/env bash
set -euo pipefail
# Simulated firewall configuration
cat <<RULES
allow from 10.0.0.0/8 to any port 443
allow from 172.16.0.0/12 to any port 8443
allow from 192.168.0.0/16 to any port 9000
RULES
FIREWALL
            chmod +x "${service_dir}/firewall-rules.sh"

            cat > "${service_dir}/network-setup.sh" <<NETWORK
#!/usr/bin/env bash
set -euo pipefail
# Simulated network creation for ${title} service
network_name="${service}-network"
echo "Creating network ${network_name}"
docker network create "${network_name}" >/dev/null 2>&1 || docker network inspect "${network_name}" >/dev/null
NETWORK
            chmod +x "${service_dir}/network-setup.sh"

            cat > "${service_dir}/${service}.md" <<DOC
# ${title} Service Blueprint

This document is automatically generated by the Dependabot service provisioning workflow.

- **Container Image:** ${image}
- **Purpose:** Provision containerized resources for ${title} updates.
- **Server Installation Script:** \`server-install.sh\`
- **Firewall Rules:** \`firewall-rules.sh\`
- **Network Setup:** \`network-setup.sh\`
DOC

            touch "${service_dir}/config/${service}-config.yaml"

            echo "Created assets for ${service}"

            preview "${service_dir}/Dockerfile"
            preview "${service_dir}/server-install.sh"
            preview "${service_dir}/firewall-rules.sh"
            preview "${service_dir}/network-setup.sh"
            preview "${service_dir}/${service}.md"
          done

      - name: Summarize generated structure (echo)
        run: |
          set -euo pipefail
          echo "::group::Generated file tree"
          find infrastructure -maxdepth 2 -type f -print | sort
          echo "::endgroup::"
          {
            echo "## Generated File Tree"
            echo
            echo '```'
            find infrastructure -maxdepth 2 -type f -print | sort
            echo '```'
            echo
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload service artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-service-assets
          path: infrastructure/
          if-no-files-found: error

  build-images:
    name: Build images (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [prepare-assets]
    if: ${{ github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]' }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        service: [python, java, linux, ubuntu, docker, teradata, nodejs]

    steps:
      - name: Download service artifacts
        uses: actions/download-artifact@v4
        with:
          name: dependabot-service-assets
          path: infrastructure

      - name: Echo service context
        run: |
          set -euo pipefail
          svc="${{ matrix.service }}"
          echo "Service = ${svc}"
          echo "Service = ${svc}" >> "$GITHUB_STEP_SUMMARY"

      - name: Ensure Docker is available
        run: |
          set -euo pipefail
          docker version
          docker info

      - name: Build ${{ matrix.service }} image (echo command)
        run: |
          set -euo pipefail
          svc="${{ matrix.service }}"
          echo "::group::Docker build command"
          echo docker build --tag "dependabot/${svc}-service:ci" "infrastructure/${svc}"
          echo "::endgroup::"
          docker build \
            --tag "dependabot/${svc}-service:ci" \
            "infrastructure/${svc}"

      - name: (Optional) Create local network (echo)
        run: |
          set -euo pipefail
          svc="${{ matrix.service }}"
          echo "Creating docker network: ${svc}-network"
          docker network create "${svc}-network" >/dev/null 2>&1 || docker network inspect "${svc}-network" >/dev/null

      - name: Cleanup local network (always, echo)
        if: always()
        run: |
          set -euo pipefail
          svc="${{ matrix.service }}"
          echo "Removing docker network: ${svc}-network"
          docker network rm "${svc}-network" >/dev/null 2>&1 || true
