name: Dependabot Service Provisioning

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  provision:
    if: github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    runs-on: ubuntu-latest
    name: Provision service containers for Dependabot updates
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare service directories and assets
        run: |
          set -euo pipefail

          echo "Initializing service asset generation"

          declare -A images
          images[python]='python:3.11-slim'
          images[java]='eclipse-temurin:17-jdk'
          images[linux]='debian:stable-slim'
          images[ubuntu]='ubuntu:22.04'
          images[docker]='docker:dind'
          images[teradata]='alpine:3.19'
          images[nodejs]='node:20-alpine'

          echo "Configured image map: ${!images[@]}"

          for service in "${!images[@]}"; do
            echo "Generating assets for ${service}"
            service_dir="infrastructure/${service}"
            mkdir -p "${service_dir}/config"
            image="${images[$service]}"
            title="${service^}"

            echo "Writing Dockerfile for ${service}"

            echo "Composing Dockerfile template for ${service}"
            cat <<DOCKERFILE > "${service_dir}/Dockerfile"
# ${title} 서비스를 위한 자동 생성된 Dockerfile
FROM ${image}
LABEL org.opencontainers.image.title="${title} service"
LABEL org.opencontainers.image.description="Container for ${title} workloads managed by Dependabot workflows"

RUN mkdir -p /opt/service && \
    echo "Provisioning ${title} runtime" > /opt/service/INSTALLATION.log

COPY config /opt/service/config
WORKDIR /opt/service

CMD ["/bin/sh", "-c", "echo '${title} container ready'; sleep 5"]
DOCKERFILE

            echo "Creating server install script for ${service}"
            cat <<SERVER > "${service_dir}/server-install.sh"
#!/usr/bin/env bash
set -euo pipefail

# Simulated server installation script for ${title} service
log_dir="/opt/service"
mkdir -p "${log_dir}"
echo "[${title}] Starting server installation" > "${log_dir}/server-install.log"
echo "[${title}] Installing core packages" >> "${log_dir}/server-install.log"
echo "[${title}] Installation complete" >> "${log_dir}/server-install.log"
SERVER
            chmod +x "${service_dir}/server-install.sh"

            echo "Creating firewall rules script for ${service}"
            cat <<FIREWALL > "${service_dir}/firewall-rules.sh"
#!/usr/bin/env bash
set -euo pipefail

# Simulated firewall configuration for ${title} service
cat <<RULES
allow from 10.0.0.0/8 to any port 443
allow from 172.16.0.0/12 to any port 8443
allow from 192.168.0.0/16 to any port 9000
RULES
FIREWALL
            chmod +x "${service_dir}/firewall-rules.sh"

            echo "Creating network setup script for ${service}"
            cat <<NETWORK > "${service_dir}/network-setup.sh"
#!/usr/bin/env bash
set -euo pipefail

# Simulated network creation for ${title} service
network_name="${service}-network"
echo "Creating network ${network_name}"
docker network create "${network_name}" >/dev/null 2>&1 || docker network inspect "${network_name}" >/dev/null
NETWORK
            chmod +x "${service_dir}/network-setup.sh"

            echo "Writing documentation blueprint for ${service}"
            cat <<DOC > "${service_dir}/${service}.md"
# ${title} Service Blueprint

This document is automatically generated by the Dependabot service provisioning workflow.

- **Container Image:** ${image}
- **Purpose:** Provision containerized resources for ${title} updates.
- **Server Installation Script:** `server-install.sh`
- **Firewall Rules:** `firewall-rules.sh`
- **Network Setup:** `network-setup.sh`
DOC

            touch "${service_dir}/config/${service}-config.yaml"
            echo "Created assets for ${service}" >&2
          done

          echo "Completed service asset generation"


      - name: Build container images
        run: |
          set -euo pipefail
          echo "Starting container image builds"
          services=(python java linux ubuntu docker teradata nodejs)
          echo "Ensuring shared CI network exists"
          docker network create dependabot-ci-network >/dev/null 2>&1 || docker network inspect dependabot-ci-network >/dev/null
          for service in "${services[@]}"; do
            echo "Building image for ${service}"
            docker build --tag "dependabot/${service}-service:ci" "infrastructure/${service}"
          done

          echo "Finished container image builds"

      - name: Summarize generated structure
        run: |
          set -euo pipefail
          echo "Listing generated service assets"
          find infrastructure -maxdepth 2 -type f -print | sort
          echo "Service asset listing complete"

      - name: Upload service artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-service-assets
          path: infrastructure/
          if-no-files-found: error

      - name: Cleanup provisioned networks
        if: always()
        run: |
          set -euo pipefail
          echo "Cleaning up Docker networks"
          docker network rm dependabot-ci-network >/dev/null 2>&1 || true
          for service in python java linux ubuntu docker teradata nodejs; do
            echo "Removing network for ${service}"
            docker network rm "${service}-network" >/dev/null 2>&1 || true
          done
          echo "Docker network cleanup complete"
