name: "ğŸ¢ Master Docker Ops: Build, Secure, Scale & Backup"

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'Dockerfile'
      - 'src/**'
  workflow_dispatch:
    inputs:
      replica_count:
        description: 'ìƒì„±í•  ë³µì œ ì»¨í…Œì´ë„ˆ ìˆ˜ (Scaling)'
        required: true
        default: '3'
      environment:
        description: 'ë°°í¬ í™˜ê²½ (staging/production)'
        required: true
        default: 'production'

env:
  # ì‹œìŠ¤í…œ ê²½ë¡œ ì„¤ì •
  WORK_DIR: "./ops-data/workspace"
  BACKUP_DIR: "./ops-data/backups"
  REPLICA_DIR: "./ops-data/replicas"
  AUDIT_LOG: "./ops-data/audit.log"
  IMAGE_NAME: "finance-service-app"
  NETWORK_NAME: "fin-secure-net"

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  # ======================================================
  # JOB 1: ì¸í”„ë¼ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡°í™” (Setup)
  # ======================================================
  setup-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“‚ Construct Directory Architecture
        run: |
          echo "Initializing Operation Directories..."
          
          # 1. ì‘ì—… ê³µê°„ (Workspace)
          mkdir -p ${{ env.WORK_DIR }}/{app,config,data,logs}
          
          # 2. ë°±ì—… ì €ì¥ì†Œ (Backup Vault)
          mkdir -p ${{ env.BACKUP_DIR }}/{images,containers,configs,databases}
          
          # 3. ë³µì œ ë° ìŠ¤ì¼€ì¼ë§ ê³µê°„ (Replication)
          mkdir -p ${{ env.REPLICA_DIR }}/{config,data}
          
          # 4. ê¶Œí•œ ë° ê°ì‚¬ ë¡œê·¸ ì„¤ì •
          touch ${{ env.AUDIT_LOG }}
          echo "[INFO] $(date) - Directory Structure Created" >> ${{ env.AUDIT_LOG }}
          chmod -R 750 ./ops-data
          
          # êµ¬ì¡° í™•ì¸
          ls -R ./ops-data

      - name: ğŸ“¤ Share Context
        uses: actions/upload-artifact@v4
        with:
          name: ops-structure
          path: ./ops-data

  # ======================================================
  # JOB 2: ë³´ì•ˆ ë¹Œë“œ ë° ì´ë¯¸ì§€ ê²€ì¦ (Build & Secure)
  # ======================================================
  build-and-secure:
    needs: setup-infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ë°ëª¨ìš© Dockerfile ìƒì„± (ì—†ì„ ê²½ìš°)
      - name: ğŸ“ Generate Secure Dockerfile
        run: |
          if [ ! -f Dockerfile ]; then
            cat <<EOF > Dockerfile
            FROM alpine:latest
            RUN apk add --no-cache curl
            WORKDIR /app
            COPY . .
            CMD ["tail", "-f", "/dev/null"]
            EOF
          fi

      - name: ğŸ”¨ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }},${{ env.IMAGE_NAME }}:latest

      - name: ğŸ” Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_NAME }}:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0' # ìš´ì˜ì‹œ 1ë¡œ ë³€ê²½ ê¶Œì¥

      - name: ğŸ“¦ Archive Image (Tarball)
        run: |
          mkdir -p ${{ env.BACKUP_DIR }}/images
          docker save ${{ env.IMAGE_NAME }}:latest -o ${{ env.BACKUP_DIR }}/images/${{ env.IMAGE_NAME }}-${{ github.sha }}.tar
          gzip ${{ env.BACKUP_DIR }}/images/*.tar
          echo "âœ… Image Built and Archived"

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ${{ env.BACKUP_DIR }}/images

  # ======================================================
  # JOB 3: ë°°í¬, ìŠ¤ì¼€ì¼ë§ ë° ë¡œë“œë°¸ëŸ°ì‹± (Deploy & Scale)
  # ======================================================
  deploy-cluster:
    needs: build-and-secure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Load Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./loaded-images

      - name: ğŸ³ Load Docker Image
        run: |
          gunzip -c ./loaded-images/*.tar.gz | docker load
          docker network create ${{ env.NETWORK_NAME }} || true

      # 1. ë©”ì¸ ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: ğŸš€ Deploy Primary Container
        run: |
          docker run -d \
            --name ${{ env.IMAGE_NAME }}-primary \
            --network ${{ env.NETWORK_NAME }} \
            --restart always \
            -v ${{ github.workspace }}/${{ env.WORK_DIR }}/data:/app/data \
            ${{ env.IMAGE_NAME }}:latest
            
      # 2. ë³µì œ ì»¨í…Œì´ë„ˆ ìƒì„± (Scaling Loop)
      - name: ğŸ”„ Create Replica Containers
        run: |
          REPLICA_COUNT=${{ github.event.inputs.replica_count }}
          echo "Scaling out to $REPLICA_COUNT replicas..."
          
          for i in $(seq 1 $REPLICA_COUNT); do
            echo "Starting Replica #$i..."
            docker run -d \
              --name ${{ env.IMAGE_NAME }}-replica-$i \
              --network ${{ env.NETWORK_NAME }} \
              --restart always \
              -e REPLICA_ID=$i \
              ${{ env.IMAGE_NAME }}:latest
          done

      # 3. Nginx ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • ìë™ ìƒì„± ë° ì‹¤í–‰
      - name: âš–ï¸ Deploy Load Balancer (Nginx)
        run: |
          # Nginx ì„¤ì • ë™ì  ìƒì„±
          cat <<EOF > nginx.conf
          events {}
          http {
              upstream backend {
                  server ${{ env.IMAGE_NAME }}-primary:8080;
                  # Loop to add replicas
                  $(for i in $(seq 1 ${{ github.event.inputs.replica_count }}); do echo "        server ${{ env.IMAGE_NAME }}-replica-$i:8080;"; done)
              }
              server {
                  listen 80;
                  location / {
                      proxy_pass http://backend;
                  }
              }
          }
          EOF
          
          # Nginx ì‹¤í–‰
          docker run -d \
            --name load-balancer \
            --network ${{ env.NETWORK_NAME }} \
            -p 80:80 \
            -v $(pwd)/nginx.conf:/etc/nginx/nginx.conf:ro \
            nginx:alpine

      - name: ğŸ©º Health Check
        run: |
          sleep 5
          docker ps
          # ì‹¤ì œ ì„œë¹„ìŠ¤ë¼ë©´ curl localhost/health ë“±ì„ ìˆ˜í–‰

  # ======================================================
  # JOB 4: ì „ì²´ ì‹œìŠ¤í…œ ë°±ì—… ë° ì •ë¦¬ (Backup & Cleanup)
  # ======================================================
  backup-operations:
    needs: deploy-cluster
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ’¾ Full System Backup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p ${{ env.BACKUP_DIR }}/snapshot-$TIMESTAMP
          
          # 1. ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìŠ¤ëƒ…ìƒ· Export
          docker ps -q | xargs -I {} docker export {} -o ${{ env.BACKUP_DIR }}/snapshot-$TIMESTAMP/{}.tar
          
          # 2. ë¡œê·¸ ë° ì„¤ì • ë°±ì—…
          echo "Backup created at $TIMESTAMP" > ${{ env.BACKUP_DIR }}/backup-info.txt
          
          # 3. ë°±ì—… íŒŒì¼ ì••ì¶•
          tar -czf backup-full-$TIMESTAMP.tar.gz ${{ env.BACKUP_DIR }}

      - name: â˜ï¸ Upload Backup to Secure Storage
        uses: actions/upload-artifact@v4
        with:
          name: finance-ops-backup
          path: backup-full-*.tar.gz
          retention-days: 30
