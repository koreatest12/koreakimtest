name: Spring Boot Ultra CI/CD (Fixed Semantic Release) ğŸš€ğŸ›¡ï¸ğŸ“„

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

permissions:
  contents: write      # Semantic Release íƒœê·¸ ìƒì„± ë° ì»¤ë°‹
  packages: write      # GHCR ì´ë¯¸ì§€ ì—…ë¡œë“œ
  actions: write
  checks: write
  security-events: write
  issues: write
  pull-requests: write

jobs:
  # ==================================================================================
  # JOB 1: ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì •ì /ë³´ì•ˆ ë¶„ì„ + [ë³´ê³ ì„œ]
  # ==================================================================================
  build_analyze_secure:
    name: 1. Build & Secure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with: { java-version: '17', distribution: 'temurin', cache: 'maven' }

      - name: Ensure Maven Wrapper
        run: |
          if [ ! -f mvnw ]; then mvn -N io.takari:maven:wrapper; fi
          chmod +x mvnw

      - name: Build with Maven
        run: ./mvnw -B clean verify package -DskipTests=false

      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with: { scan-type: 'fs', ignore-unfixed: true, format: 'table', severity: 'CRITICAL,HIGH' }

      - name: Extract JAR
        id: jar_file
        run: |
          JAR_FILE=$(find target/ -name "*.jar" | grep -v "original" | head -n 1)
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with: { name: spring-boot-app-deployable-jar, path: ${{ steps.jar_file.outputs.jar_path }} }

      # [ë³´ê³ ì„œ 1]
      - name: ğŸ“ Generate Build Report
        run: |
          echo "# ğŸ—ï¸ CI/CD Execution Report" > report_1_build.md
          echo "### 1. Build & Security" >> report_1_build.md
          echo "- **Result**: âœ… Success" >> report_1_build.md
          echo "- **Artifact**: $(basename ${{ steps.jar_file.outputs.jar_path }})" >> report_1_build.md
          echo "---" >> report_1_build.md

      - name: Upload Report 1
        uses: actions/upload-artifact@v4
        with: { name: report-fragment-1, path: report_1_build.md }

  # ==================================================================================
  # JOB 2: ë¶€í•˜ í…ŒìŠ¤íŠ¸ + [ë³´ê³ ì„œ]
  # ==================================================================================
  performance_test:
    name: 2. Load Test (k6)
    runs-on: ubuntu-latest
    needs: build_analyze_secure
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with: { name: spring-boot-app-deployable-jar, path: ./target }
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with: { java-version: '17', distribution: 'temurin' }

      - name: Start App & Create Script
        run: |
          nohup java -jar ./target/*.jar &
          echo 'import http from "k6/http"; import { sleep } from "k6"; export const options = { vus: 5, duration: "3s" }; export default function () { http.get("http://localhost:8080"); sleep(1); }' > load-test.js
          sleep 15

      - name: Run k6
        uses: grafana/k6-action@v0.3.0
        with: { filename: load-test.js }

      # [ë³´ê³ ì„œ 2]
      - name: ğŸ“ Generate Perf Report
        run: |
          echo "### 2. Performance Test" > report_2_perf.md
          echo "- **Status**: âœ… Passed (k6)" >> report_2_perf.md
          echo "---" >> report_2_perf.md

      - name: Upload Report 2
        uses: actions/upload-artifact@v4
        with: { name: report-fragment-2, path: report_2_perf.md }

  # ==================================================================================
  # JOB 3: ë°±ì—… ë° DB ë¤í”„ + [ë³´ê³ ì„œ]
  # ==================================================================================
  backup_and_dump:
    name: 3. Backup & Dump
    runs-on: ubuntu-latest
    needs: build_analyze_secure
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with: { name: spring-boot-app-deployable-jar, path: ./backup-staging }

      - name: Generate Timestamp
        id: time
        run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Backup & Dump
        run: |
          mkdir -p ./final_backups
          cp ./backup-staging/*.jar ./final_backups/app_backup_${{ steps.time.outputs.timestamp }}.jar
          echo "INSERT INTO logs VALUES ('Backup');" > ./final_backups/db_dump_${{ steps.time.outputs.timestamp }}.sql

      - name: Upload Backup
        uses: actions/upload-artifact@v4
        with: { name: service-backup, path: ./final_backups/*, retention-days: 30 }

      # [ë³´ê³ ì„œ 3]
      - name: ğŸ“ Generate Backup Report
        run: |
          echo "### 3. Backup" > report_3_backup.md
          echo "- **Time**: ${{ steps.time.outputs.timestamp }}" >> report_3_backup.md
          echo "- **Files**: JAR & SQL Dump saved." >> report_3_backup.md
          echo "---" >> report_3_backup.md

      - name: Upload Report 3
        uses: actions/upload-artifact@v4
        with: { name: report-fragment-3, path: report_3_backup.md }

  # ==================================================================================
  # JOB 4: ì‹œë§¨í‹± ë¦´ë¦¬ìŠ¤ (NPM ì—ëŸ¬ ìˆ˜ì • ë²„ì „) + [ë³´ê³ ì„œ]
  # ==================================================================================
  semantic_release:
    name: 4. Semantic Release (Fix)
    runs-on: ubuntu-latest
    needs: [build_analyze_secure, performance_test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # [í•µì‹¬ ìˆ˜ì •] .releaserc.json íŒŒì¼ ìƒì„±
      # NPM í”ŒëŸ¬ê·¸ì¸ì„ ì œê±°í•˜ê³  GitHub í”ŒëŸ¬ê·¸ì¸ë§Œ ì‚¬ìš©í•˜ì—¬ NPM_TOKEN ì—ëŸ¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
      - name: Create Release Config (Disable NPM)
        run: |
          cat <<EOF > .releaserc.json
          {
            "branches": ["main"],
            "plugins": [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              "@semantic-release/github"
            ]
          }
          EOF
          echo "âœ… .releaserc.json created without npm plugin."

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 19
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # [ë³´ê³ ì„œ 4]
      - name: ğŸ“ Generate Release Report
        run: |
          echo "### 4. Release Info" > report_4_release.md
          if [ "${{ steps.semantic.outputs.new_release_published }}" == "true" ]; then
            echo "- **New Version**: ${{ steps.semantic.outputs.new_release_version }}" >> report_4_release.md
            echo "- **Status**: ğŸš€ Published to GitHub" >> report_4_release.md
          else
            echo "- **Status**: No new release (no relevant changes)." >> report_4_release.md
          fi
          echo "---" >> report_4_release.md

      - name: Upload Report 4
        uses: actions/upload-artifact@v4
        with: { name: report-fragment-4, path: report_4_release.md }

  # ==================================================================================
  # JOB 5: ìµœì¢… ë³´ê³ ì„œ í†µí•©
  # ==================================================================================
  generate_final_report:
    name: 5. Generate Final Report
    runs-on: ubuntu-latest
    needs: [build_analyze_secure, performance_test, backup_and_dump, semantic_release]
    if: always()
    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-fragment-*
          merge-multiple: true
          path: ./reports

      - name: Combine Reports
        run: |
          cat ./reports/report_1_build.md > FINAL_REPORT.md
          echo "" >> FINAL_REPORT.md
          cat ./reports/report_2_perf.md >> FINAL_REPORT.md
          echo "" >> FINAL_REPORT.md
          cat ./reports/report_3_backup.md >> FINAL_REPORT.md
          echo "" >> FINAL_REPORT.md
          if [ -f ./reports/report_4_release.md ]; then
            cat ./reports/report_4_release.md >> FINAL_REPORT.md
          else
            echo "### 4. Release Info" >> FINAL_REPORT.md
            echo "- Skipped (Not main branch)" >> FINAL_REPORT.md
          fi
          cat FINAL_REPORT.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with: { name: 00-FINAL-EXECUTION-REPORT, path: FINAL_REPORT.md, retention-days: 90 }

  # ==================================================================================
  # JOB 6: ë°°í¬
  # ==================================================================================
  deploy:
    name: 6. Deployment
    needs: [generate_final_report]
    runs-on: ubuntu-latest
    steps:
      - name: Execute Deployment
        run: echo "ğŸš€ Deployment Started (See Final Report for details)"
