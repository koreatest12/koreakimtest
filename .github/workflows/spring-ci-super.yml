name: "ğŸ¦ Finance Ops: Secure Build, Encrypt, Replicate & Release"

on:
  push:
    tags:
      - 'v*' # v1.0.0, v1.0.1 ë“± íƒœê·¸ í‘¸ì‹œ ì‹œ ë¦´ë¦¬ì¦ˆ ëª¨ë“œ ì‘ë™
  workflow_dispatch:
    inputs:
      compliance_mode:
        description: 'ì»´í”Œë¼ì´ì–¸ìŠ¤ ê°ì‚¬ ëª¨ë“œ í™œì„±í™”'
        required: true
        type: boolean
        default: true
      deploy_target:
        description: 'ë°°í¬ ëŒ€ìƒ ì‹œìŠ¤í…œ (DR/PROD)'
        required: true
        default: 'PROD_PRIMARY'

env:
  # 1. ì‹œìŠ¤í…œ ì‹ë³„ì ë° ê²½ë¡œ ì„¤ì •
  SYSTEM_ID: "KOR-FIN-CORE-01"
  IMAGE_NAME: "finance-ledger-service"
  PRIMARY_DIR: "./secure-storage/primary"
  RESERVE_DIR: "./secure-storage/dr-site"    # ì¬í•´ë³µêµ¬(DR) ì„¼í„° ì‹œë®¬ë ˆì´ì…˜
  WORM_DIR: "./secure-storage/worm-audit"    # ìœ„ë³€ì¡° ë°©ì§€(Write Once Read Many) ì•„ì¹´ì´ë¸Œ
  AUDIT_LOG: "./audit-report.log"

permissions:
  contents: write  # ë¦´ë¦¬ì¦ˆ ìƒì„±ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìš”
  security-events: write # ë³´ì•ˆ ìŠ¤ìº” ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
  packages: write

jobs:
  secure-finance-pipeline:
    name: ğŸ›¡ï¸ Build, Audit & Release
    runs-on: ubuntu-latest

    steps:
      # ======================================================
      # Phase 1: ì´ˆê¸°í™” ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ê°ì‚¬ ì‹œì‘
      # ======================================================
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“ Initialize Audit Trail (ê°ì‚¬ ë¡œê·¸ ì‹œì‘)
        run: |
          echo "===== FINANCE COMPLIANCE AUDIT LOG =====" > ${{ env.AUDIT_LOG }}
          echo "TIMESTAMP: $(date -u)" >> ${{ env.AUDIT_LOG }}
          echo "ACTOR: ${{ github.actor }}" >> ${{ env.AUDIT_LOG }}
          echo "COMMIT: ${{ github.sha }}" >> ${{ env.AUDIT_LOG }}
          echo "SYSTEM_ID: ${{ env.SYSTEM_ID }}" >> ${{ env.AUDIT_LOG }}
          echo "----------------------------------------" >> ${{ env.AUDIT_LOG }}

      - name: ğŸ“‚ Create Secure Directory Structure
        run: |
          mkdir -p ${{ env.PRIMARY_DIR }}/{artifacts,logs,data}
          mkdir -p ${{ env.RESERVE_DIR }}/{artifacts,logs,data}
          mkdir -p ${{ env.WORM_DIR }}
          echo "âœ… Security Zones Created." >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 2: ë¹Œë“œ ë° ë³´ì•ˆ ìŠ¤ìº” (Vulnerability Scan)
      # ======================================================
      - name: ğŸ“ Generate Secure Dockerfile (ë°ëª¨ìš©)
        if: ${{ !hashFiles('Dockerfile') }}
        run: |
          cat <<EOF > Dockerfile
          FROM alpine:3.18
          # ê¸ˆìœµ ê·œì •: Root ê¶Œí•œ ì‚¬ìš© ê¸ˆì§€ ë° ì‚¬ìš©ì ë¶„ë¦¬
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          USER finsvc
          WORKDIR /app
          RUN echo "Financial Transaction Ledger Initialized" > ledger.dat
          CMD ["tail", "-f", "/dev/null"]
          EOF

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.ref_name }}

      - name: ğŸ” Trivy Vulnerability Scan (ì·¨ì•½ì  ì ê²€)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ github.ref_name }}'
          format: 'table'
          exit-code: '0' # ì‹¤ì œ ìš´ì˜ ì‹œ 1ë¡œ ì„¤ì •í•˜ì—¬ ì·¨ì•½ì  ë°œê²¬ ì‹œ ë¹Œë“œ ì¤‘ë‹¨ ê¶Œì¥
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # ======================================================
      # Phase 3: ì‹¤í–‰, ì¶”ì¶œ ë° ë¬´ê²°ì„± ê²€ì¦ (Hashing)
      # ======================================================
      - name: ğŸš€ Run Container & Verify Health
        run: |
          docker run -d --name ${{ env.IMAGE_NAME }}-run ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          sleep 5
          if [ $(docker inspect -f '{{.State.Running}}' ${{ env.IMAGE_NAME }}-run) = "true" ]; then
             echo "âœ… Service Health: HEALTHY" >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ Service Health: FAILED" >> ${{ env.AUDIT_LOG }}
             exit 1
          fi

      - name: ğŸ“¦ Export Artifacts & Generate Checksums (ë¬´ê²°ì„± í™•ë³´)
        run: |
          # 1. ì´ë¯¸ì§€ ì¶”ì¶œ
          docker save -o ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}.tar ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          
          # 2. ë°ì´í„° ì¶”ì¶œ
          docker cp ${{ env.IMAGE_NAME }}-run:/app ${{ env.PRIMARY_DIR }}/data/
          
          # 3. SHA256 í•´ì‹œ ìƒì„± (ê¸ˆìœµ ë¬´ê²°ì„± í•„ìˆ˜)
          cd ${{ env.PRIMARY_DIR }}/artifacts
          sha256sum ${{ env.IMAGE_NAME }}.tar > ${{ env.IMAGE_NAME }}.tar.sha256
          
          echo "âœ… Artifacts Exported & Hashed." >> $GITHUB_WORKSPACE/${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 4: ë°ì´í„° ì•”í˜¸í™” ë° ì´ì¤‘í™” (Encryption & DR)
      # ======================================================
      - name: ğŸ” Encrypt Sensitive Data (ì•”í˜¸í™”)
        run: |
          # ë°ëª¨ìš© ëŒ€ì¹­í‚¤ ì•”í˜¸í™” (ì‹¤ì œë¡œëŠ” Key Vault ì‚¬ìš© ê¶Œì¥)
          gpg --batch --passphrase "FinanceSecretKey123!" --symmetric --cipher-algo AES256 \
          -o ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}.tar.gpg \
          ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}.tar
          
          echo "âœ… Data Encrypted (AES-256)." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ”„ Replicate to DR Site (ì¬í•´ë³µêµ¬ ë³µì œ)
        run: |
          # ì˜ˆë¹„ ë””ë ‰í† ë¦¬ë¡œ ë™ê¸°í™”
          cp -r ${{ env.PRIMARY_DIR }}/* ${{ env.RESERVE_DIR }}/
          
          # WORM(Write Once) ì•„ì¹´ì´ë¹™ ì‹œë®¬ë ˆì´ì…˜
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_NAME="audit_pkg_${TIMESTAMP}.zip"
          zip -r ${{ env.WORM_DIR }}/${ARCHIVE_NAME} ${{ env.PRIMARY_DIR }}
          
          echo "âœ… DR Replication & WORM Archiving Complete." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker rm -f ${{ env.IMAGE_NAME }}-run || true

      # ======================================================
      # Phase 5: ì •ì‹ ë¦´ë¦¬ì¦ˆ ì¶œì‹œ (Release Launch)
      # ======================================================
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "ğŸš€ Release ${{ github.ref_name }} (Secure Build)"
          body: |
            ## ğŸ¦ Finance Security Release
            **System ID:** ${{ env.SYSTEM_ID }}
            **Deploy Target:** ${{ inputs.deploy_target }}
            
            ### ğŸ›¡ï¸ Compliance & Security
            - [x] Docker Image Built & Scanned
            - [x] Integrity Check (SHA256) Passed
            - [x] Data Encrypted (AES-256)
            - [x] Replicated to DR Site
            
            ### ğŸ“‚ Artifacts Info
            Check the attached assets for the audit log and secure image.
          files: |
            ${{ env.AUDIT_LOG }}
            ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}.tar.sha256
            ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}.tar.gpg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ======================================================
      # Phase 6: ìµœì¢… ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ê°ì‚¬ ì¦ì ìš©)
      # ======================================================
      - name: â˜ï¸ Upload Audit Evidence
        uses: actions/upload-artifact@v4
        with:
          name: finance-audit-evidence-${{ github.ref_name }}
          path: |
            ${{ env.AUDIT_LOG }}
            ops-data/
            secure-storage/
          retention-days: 90 # ê¸ˆìœµ ê·œì •ì— ë”°ë¥¸ ì¥ê¸° ë³´ê´€
