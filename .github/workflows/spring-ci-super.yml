name: Spring Boot Final CI/CD Pipeline (Maven) ğŸš€âœ…

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì •ì˜ (Trigger Configuration)
on:
  push:
    branches: [ "main", "develop" ] # main ë˜ëŠ” develop ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
  pull_request:
    branches: [ "main", "develop" ] # í•´ë‹¹ ë¸Œëœì¹˜ë¡œ PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ

# 2. ì‘ì—… ê¶Œí•œ ì •ì˜
permissions:
  contents: read
  packages: write
  actions: write

# 3. ì‘ì—…(Jobs) ì •ì˜
jobs:
  build_and_test:
    name: Build, Test, and Package
    # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest 

    # ì‘ì—… ë‹¨ê³„(Steps) ì •ì˜
    steps:
    
      # 3-1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìµœì‹  ì½”ë“œ í™•ë³´)
      - name: 1. Checkout Code (ìµœì‹  ì†ŒìŠ¤ì½”ë“œ í™•ë³´)
        uses: actions/checkout@v4

      # 3-2. Java í™˜ê²½ ì„¤ì • (JDK 17 ì„¤ì • ë° Maven ìºì‹œ)
      - name: 2. Set up JDK 17 Environment (Adoptium/Temurin)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin' 
          # Maven ì˜ì¡´ì„± ìºì‹œë¥¼ í™œì„±í™”í•˜ì—¬ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶• ë° ìµœì‹  ë¦¬ì†ŒìŠ¤ ë¡œë”© ì§€ì›
          cache: 'maven'

      # 3-3. Maven Wrapper ê¶Œí•œ ë¶€ì—¬ (ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •)
      - name: 3. Grant execute permission to mvnw
        run: chmod +x mvnw
        
      # 3-4. Maven ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìµœì‹  ë¦¬ì†ŒìŠ¤ ì»´íŒŒì¼ ë° ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸)
      - name: 4. Maven Build & Comprehensive Test Execution (CLEAN PACKAGE)
        # -B: Batch mode (Non-interactive)
        # -DskipTests=false: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì„ ëª…ì‹œì ìœ¼ë¡œ ë³´ì¥
        # 'clean verify package'ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ë©´ JAR íŒŒì¼ ìƒì„± ë¶ˆê°€
        run: mvn -B clean verify package -DskipTests=false
        
      # 3-5. **[ê²½ê³  ë©”ì‹œì§€ í•´ê²°]** ìµœì¢… JAR íŒŒì¼ ì´ë¦„ ì¶”ì¶œ
      # spring-boot-maven-pluginì— ì˜í•´ ìƒì„±ëœ ìµœì¢… ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ë§Œ ì •í™•í•˜ê²Œ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
      - name: 5. Extract Final Executable JAR File Name (Warning Fix)
        id: jar_file
        run: |
          # spring-boot-maven-pluginì´ ìƒì„±í•œ *-exec.jar ë˜ëŠ” *SNAPSHOT.jar íŒŒì¼ì„ ìš°ì„ ì ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
          JAR_FILE=$(find target/ -name "*-exec.jar" -o -name "*SNAPSHOT.jar" | grep -v original | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: Executable JAR file not found in target directory!"
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "Final JAR Path: $JAR_FILE"

      # 3-6. ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (CDë¥¼ ìœ„í•œ JAR íŒŒì¼ ì¤€ë¹„)
      - name: 6. Upload Deployable JAR Artifact (ê²½ê³  ì—†ì´ ìµœì¢… íŒŒì¼ë§Œ)
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          # ì •í™•í•˜ê²Œ ì¶”ì¶œëœ ìµœì¢… JAR íŒŒì¼ ê²½ë¡œë§Œ ì‚¬ìš©
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7 

# 4. ë°°í¬ ì‘ì—… (CD Place Holder)
# ì´ ì‘ì—…ì€ CI(í†µí•©)ê°€ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  deploy:
    name: Deployment Stage (CD)
    runs-on: ubuntu-latest
    needs: build_and_test # build_and_test Jobì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    
    steps:
      - name: 1. Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./downloaded-artifact

      - name: 2. Deployment Placeholder (ë°°í¬ ì‹¤í–‰)
        run: |
          echo "---------------------------------------------------------"
          echo "CI ì„±ê³µ! ì´ì œ ë‹¤ìŒ ë‹¨ê³„ì¸ ì„œë²„ ë°°í¬(CD)ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          echo "ë‹¤ìš´ë¡œë“œëœ JAR íŒŒì¼ì€ './downloaded-artifact'ì— ìœ„ì¹˜í•˜ë©°, ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          echo "---------------------------------------------------------"
          # ì—¬ê¸°ì— ì‹¤ì œ ë°°í¬ ë¡œì§ (ì˜ˆ: SSH, SCP, Docker push ë“±)ì„ ì¶”ê°€í•˜ì„¸ìš”.
