name: Spring Boot Ultra CI/CD (Backup & Dump Included) ğŸš€ğŸ›¡ï¸ğŸ’¾

# 1. íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

# 2. ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  packages: write
  actions: write
  checks: write
  security-events: write

# 3. ì‘ì—… ì •ì˜
jobs:
  # === Job 1: ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë³´ì•ˆ ì§„ë‹¨ ===
  build_and_secure:
    name: 1. Build, Test & Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # Maven Wrapper ìë™ ë³µêµ¬ ë° ê¶Œí•œ ë¶€ì—¬
      - name: Ensure Maven Wrapper & Permissions
        run: |
          if [ ! -f mvnw ]; then
            echo "âš ï¸ 'mvnw' not found. Generating automatically..."
            mvn -N io.takari:maven:wrapper
          fi
          chmod +x mvnw

      # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: Build with Maven Wrapper
        run: ./mvnw -B clean verify package -DskipTests=false

      # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ê²Œì‹œ
      - name: Publish JUnit Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'

      # ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # ìµœì¢… JAR ì¶”ì¶œ
      - name: Extract Final JAR Path
        id: jar_file
        run: |
          JAR_FILE=$(find target/ -name "*.jar" | grep -v "original" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: No executable JAR found!"
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT

      # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7

  # === Job 2: [NEW] ì„œë¹„ìŠ¤ ë°±ì—… ë° ë¤í”„ ìƒì„± ===
  # ë°°í¬ ì „, í˜„ì¬ ìƒíƒœì˜ ì•„í‹°íŒ©íŠ¸ì™€ DB ë¤í”„ë¥¼ ìƒì„±í•˜ì—¬ ë³„ë„ ì €ì¥ì†Œì— ë³´ê´€í•©ë‹ˆë‹¤.
  backup_and_dump:
    name: 2. Service Backup & DB Dump
    runs-on: ubuntu-latest
    needs: build_and_secure # ë¹Œë“œê°€ ì„±ê³µí•´ì•¼ ë°±ì—… ì§„í–‰

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./backup-staging

      - name: Generate Timestamp
        id: time
        run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      # (1) ì„œë¹„ìŠ¤ ì•„í‹°íŒ©íŠ¸(JAR) ë°±ì—…
      # ë²„ì „ ê´€ë¦¬ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¶™ì—¬ ë°±ì—… í´ë”ë¡œ ì´ë™
      - name: Backup Service Artifact (JAR)
        run: |
          mkdir -p ./final_backups
          cp ./backup-staging/*.jar ./final_backups/app_backup_${{ steps.time.outputs.timestamp }}.jar
          echo "âœ… Service JAR backed up."

      # (2) ë°ì´í„°ë² ì´ìŠ¤ ë¤í”„(Dump) ìƒì„± ì‹œë®¬ë ˆì´ì…˜
      # ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ ì£¼ì„ ì²˜ë¦¬ëœ ëª…ë ¹ì–´ë¥¼ í™œì„±í™”í•˜ê³  Secretsë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Generate Database Dump (Simulation)
        run: |
          echo "Connecting to Database..."
          # [ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ]
          # mysqldump -h ${{ secrets.DB_HOST }} -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASS }} my_database > ./final_backups/db_dump_${{ steps.time.outputs.timestamp }}.sql
          
          # [ì‹œë®¬ë ˆì´ì…˜: ë¤í”„ íŒŒì¼ ìƒì„±]
          echo "INSERT INTO users VALUES (1, 'Backup Test');" > ./final_backups/db_dump_${{ steps.time.outputs.timestamp }}.sql
          echo "âœ… Database Dump generated successfully."

      # (3) ë°±ì—… ë° ë¤í”„ íŒŒì¼ í†µí•© ì—…ë¡œë“œ
      # GitHub Actions Artifactì— ë°±ì—…ë³¸ì„ ì €ì¥ (ë˜ëŠ” AWS S3ë¡œ ì „ì†¡ ê°€ëŠ¥)
      - name: Upload Backup & Dump Bundle
        uses: actions/upload-artifact@v4
        with:
          name: service-backup-dump-${{ steps.time.outputs.timestamp }}
          path: ./final_backups/*
          retention-days: 30 # ë°±ì—…ì€ 30ì¼ê°„ ë³´ê´€

  # === Job 3: ë°°í¬ ë‹¨ê³„ ===
  deploy:
    name: 3. Deployment Stage
    needs: [build_and_secure, backup_and_dump] # ë°±ì—…ê¹Œì§€ ì™„ë£Œë˜ì–´ì•¼ ë°°í¬ ì§„í–‰
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./downloaded-artifact

      - name: Execute Deployment
        run: |
          echo "ğŸš€ Starting Deployment..."
          ls -l ./downloaded-artifact
          echo "Deploy logic (SSH/Docker/Cloud) goes here."
