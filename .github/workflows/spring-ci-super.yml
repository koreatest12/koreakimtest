name: "ğŸ›¡ï¸ Finance Ops V4: Atomic Non-Stop Pipeline"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      log_level:
        description: 'ë¡œê·¸ ë ˆë²¨ ì„¤ì •'
        default: 'DEBUG'

env:
  # 1. ì‹œìŠ¤í…œ í™˜ê²½
  TZ: 'Asia/Seoul'
  DEBIAN_FRONTEND: noninteractive
  
  # 2. ì»¨í…Œì´ë„ˆ/íŒŒì¼ ì„¤ì •
  IMAGE_NAME: "finance-ledger-service"
  CONTAINER_NAME: "finance-ledger-svc-run"
  TARGET_FILE: "/app/ledger.dat"
  
  # 3. ë³´ì•ˆ ê²½ë¡œ (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš© ê¶Œì¥)
  OPS_ROOT: "${{ github.workspace }}/ops-data"
  BACKUP_DIR: "${{ github.workspace }}/ops-data/backup"
  AUDIT_LOG: "${{ github.workspace }}/ops-data/audit.log"
  
  # 4. ì•”í˜¸í™” í‚¤ (ìš´ì˜ ì‹œ Secrets ì‚¬ìš©)
  BACKUP_KEY: "finance-critical-key-v4"

jobs:
  atomic-ops-execution:
    name: ğŸš€ Atomic Ops Execution (No Skip)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      # ======================================================
      # Phase 1: ì¸í”„ë¼ í†µí•© ì´ˆê¸°í™” (Initialization)
      # ======================================================
      - name: ğŸ“¥ Checkout & Setup Environment
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Initialize Infrastructure (Atomic Setup)
        run: |
          echo "===== PHASE 1: INIT ====="
          
          # 1. ë””ë ‰í† ë¦¬ ì¼ê´„ ìƒì„±
          mkdir -p ${{ env.OPS_ROOT }}/{primary/data,backup,restore_test}
          
          # 2. ê°ì‚¬ ë¡œê·¸ ì‹œì‘
          touch ${{ env.AUDIT_LOG }}
          {
            echo "START_TIME: $(date)"
            echo "RUNNER_OS: $(uname -a)"
            echo "ACTOR: ${{ github.actor }}"
          } >> ${{ env.AUDIT_LOG }}
          
          # 3. í•„ìˆ˜ íˆ´ ì‚¬ì „ ì ê²€ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
          for tool in openssl zip; do
            if ! command -v $tool &> /dev/null; then
              echo "Installing $tool..."
              sudo apt-get update && sudo apt-get install -y $tool
            fi
          done
          
          # 4. ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì§„í–‰)
          df -h >> ${{ env.AUDIT_LOG }}
          echo "âœ… Initialization Complete"

      # ======================================================
      # Phase 2: ë¹Œë“œ ë° ì‹¤í–‰ (Build & Run)
      # ======================================================
      - name: ğŸ³ Build & Run Container (Force Execution)
        run: |
          echo "===== PHASE 2: DOCKER OPS =====" >> ${{ env.AUDIT_LOG }}
          
          # 1. Dockerfile ìƒì„± (Heredoc ì•ˆì „ ë¬¸ë²•)
          cat <<EOF > Dockerfile
          FROM alpine:3.18
          RUN apk add --no-cache bash openssl
          WORKDIR /app
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          # ì´ˆê¸° íŒŒì¼ ìƒì„±
          RUN echo "Finance Ledger Init: $(date)" > ledger.dat && \
              chown finsvc:finsvc ledger.dat && \
              chmod 644 ledger.dat
          USER finsvc
          CMD ["tail", "-f", "/dev/null"]
          EOF
          
          # 2. ë¹Œë“œ ë° ì‹¤í–‰
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart=on-failure:3 \
            --memory="512m" \
            ${{ env.IMAGE_NAME }}:latest
            
          echo "âœ… Container Started: $(date)" >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 3: ì§„ë‹¨ ë° ìê°€ ì¹˜ìœ  í†µí•© (Atomic Heal)
      # YAML ifë¬¸ì„ ì œê±°í•˜ê³  ì‰˜ ë‚´ë¶€ ë¡œì§ìœ¼ë¡œ í†µí•©í•˜ì—¬ ìŠ¤í‚µ ë°©ì§€
      # ======================================================
      - name: ğŸ©º Diagnose & Self-Heal (Atomic Logic)
        run: |
          echo "===== PHASE 3: DIAGNOSE & HEAL =====" >> ${{ env.AUDIT_LOG }}
          echo "Waiting for container warmup..."
          sleep 5
          
          # [í•µì‹¬] ì§„ë‹¨ê³¼ ì¹˜ìœ ë¥¼ í•˜ë‚˜ì˜ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ì—ì„œ ì²˜ë¦¬
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
            echo "âœ… [DIAGNOSIS] File Found. Integrity OK." | tee -a ${{ env.AUDIT_LOG }}
          else
            echo "âš ï¸ [DIAGNOSIS] File Missing! Triggering Atomic Healing..." | tee -a ${{ env.AUDIT_LOG }}
            
            # ê°•ì œ ì¹˜ìœ  ë¡œì§ ì‹¤í–‰
            docker exec ${{ env.CONTAINER_NAME }} sh -c "echo 'Healed Data Payload' > ${{ env.TARGET_FILE }}"
            
            # ì¹˜ìœ  ê²°ê³¼ ì¬ê²€ì¦
            if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
               echo "âœ… [HEALING] Recovery Successful." | tee -a ${{ env.AUDIT_LOG }}
            else
               echo "âŒ [HEALING] CRITICAL FAILURE. Manual Intervention Required." | tee -a ${{ env.AUDIT_LOG }}
               exit 1 # ì—¬ê¸°ì„œë§Œ ìœ ì¼í•˜ê²Œ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨
            fi
          fi

      # ======================================================
      # Phase 4: ì¶”ì¶œ, ë©”íƒ€ë°ì´í„°, ì•”í˜¸í™” (Backup Ops)
      # ======================================================
      - name: ğŸ“¦ Secure Backup & Encryption
        run: |
          echo "===== PHASE 4: BACKUP OPS =====" >> ${{ env.AUDIT_LOG }}
          
          # 1. ë°ì´í„° ì¶”ì¶œ
          docker cp ${{ env.CONTAINER_NAME }}:${{ env.TARGET_FILE }} ${{ env.OPS_ROOT }}/primary/data/ledger.dat
          
          # 2. ë©”íƒ€ë°ì´í„° ìƒì„± (JSON)
          cat <<EOF > ${{ env.OPS_ROOT }}/primary/data/metadata.json
          {
            "timestamp": "$(date -u)",
            "runner": "${{ runner.os }}",
            "commit": "${{ github.sha }}",
            "file_hash": "$(sha256sum ${{ env.OPS_ROOT }}/primary/data/ledger.dat | awk '{print $1}')"
          }
          EOF
          
          # 3. ì••ì¶• ë° ì•”í˜¸í™” (AES-256-CBC with PBKDF2)
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_NAME="finance_full_${TIMESTAMP}.tar.gz"
          ENC_NAME="${ARCHIVE_NAME}.enc"
          
          # ê²½ë¡œ ì´ë™í•˜ì—¬ ìƒëŒ€ê²½ë¡œë¡œ ì••ì¶•
          cd ${{ env.OPS_ROOT }}/primary
          tar -czf ../../${{ env.BACKUP_DIR }}/${ARCHIVE_NAME} .
          cd - > /dev/null
          
          # OpenSSL ì•”í˜¸í™”
          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
            -in ${{ env.BACKUP_DIR }}/${ARCHIVE_NAME} \
            -out ${{ env.BACKUP_DIR }}/${ENC_NAME} \
            -k "${{ env.BACKUP_KEY }}"
            
          # ì›ë³¸ ì‚­ì œ (ë³´ì•ˆ)
          rm ${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}
          
          echo "âœ… Encrypted Backup Created: ${ENC_NAME}" | tee -a ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 5: ê°•ì œ ë³µì› í…ŒìŠ¤íŠ¸ (Verify Drill)
      # ë³„ë„ input ì¡°ê±´ ì—†ì´ ë¬´ì¡°ê±´ ìˆ˜í–‰ (ìŠ¤í‚µ ë°©ì§€)
      # ======================================================
      - name: ğŸ§ª Mandatory Restore Drill (Verification)
        run: |
          echo "===== PHASE 5: RESTORE DRILL =====" >> ${{ env.AUDIT_LOG }}
          
          # ìµœì‹  ì•”í˜¸í™” íŒŒì¼ ì°¾ê¸°
          LATEST_ENC=$(ls -t ${{ env.BACKUP_DIR }}/*.enc | head -1)
          echo "Testing Artifact: $LATEST_ENC"
          
          RESTORE_TARGET="${{ env.OPS_ROOT }}/restore_test/restored.tar.gz"
          
          # 1. ë³µí˜¸í™” í…ŒìŠ¤íŠ¸
          openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 \
            -in "$LATEST_ENC" \
            -out "$RESTORE_TARGET" \
            -k "${{ env.BACKUP_KEY }}"
            
          if [ $? -eq 0 ]; then
             echo "âœ… [DRILL] Decryption Success." | tee -a ${{ env.AUDIT_LOG }}
          else
             echo "âŒ [DRILL] Decryption Failed." | tee -a ${{ env.AUDIT_LOG }}
             exit 1
          fi
          
          # 2. ì••ì¶• í•´ì œ ë° ë°ì´í„° ê²€ì¦
          tar -xzf "$RESTORE_TARGET" -C ${{ env.OPS_ROOT }}/restore_test
          
          if [ -f "${{ env.OPS_ROOT }}/restore_test/data/ledger.dat" ]; then
             echo "âœ… [DRILL] Data Integrity Verified (File Exists)." | tee -a ${{ env.AUDIT_LOG }}
             cat ${{ env.OPS_ROOT }}/restore_test/data/metadata.json >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ [DRILL] Data Corruption Detected." | tee -a ${{ env.AUDIT_LOG }}
             exit 1
          fi

      # ======================================================
      # Phase 6: ì •ë¦¬ ë° ì¦ì  ì œì¶œ (Finalization)
      # ======================================================
      - name: ğŸ§¹ Final Cleanup & Evidence Upload
        if: always() # ì‹¤íŒ¨í•´ë„ ì¦ì ì€ ë‚¨ê²¨ì•¼ í•¨
        run: |
          echo "===== PHASE 6: FINALIZE =====" >> ${{ env.AUDIT_LOG }}
          echo "END_TIME: $(date)" >> ${{ env.AUDIT_LOG }}
          
          # ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          
          # í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ (ê³µê°„ í™•ë³´)
          rm -rf ${{ env.OPS_ROOT }}/restore_test
          rm -rf ${{ env.OPS_ROOT }}/primary

      - name: â˜ï¸ Upload Audit Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: finance-compliance-audit-v4
          path: |
            ${{ env.BACKUP_DIR }}/*.enc
            ${{ env.AUDIT_LOG }}
          retention-days: 90
