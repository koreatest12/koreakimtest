name: Spring Boot Ultra CI/CD Pipeline (Security+Test+Docker) ğŸš€ğŸ›¡ï¸

# 1. íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€

# 2. ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  packages: write
  actions: write
  checks: write     # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì‘ì„±ì„ ìœ„í•œ ê¶Œí•œ
  security-events: write # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì €ì¥ì„ ìœ„í•œ ê¶Œí•œ

# 3. ì‘ì—… ì •ì˜
jobs:
  # === Job 1: ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ë° ë³´ì•ˆ ì§„ë‹¨ ===
  build_and_secure:
    name: 1. Build, Test & Security Scan
    runs-on: ubuntu-latest

    steps:
      # 1-1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1-2. JDK 17 ì„¤ì • ë° ìºì‹±
      - name: Set up JDK 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 1-3. [Failsafe] Maven Wrapper ìë™ ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬
      # mvnw íŒŒì¼ì´ ì—†ìœ¼ë©´ ì‹œìŠ¤í…œì˜ mvnì„ ì‚¬ìš©í•´ ìƒì„±í•´ë²„ë¦½ë‹ˆë‹¤. (ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨)
      - name: Ensure Maven Wrapper Exists & Grant Permissions
        run: |
          if [ ! -f mvnw ]; then
            echo "âš ï¸ 'mvnw' not found. Generating Maven Wrapper automatically..."
            mvn -N io.takari:maven:wrapper
          fi
          chmod +x mvnw
          ./mvnw --version

      # 1-4. ì˜ì¡´ì„± ê²€ì‚¬ ë° ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
      - name: Build with Maven Wrapper
        run: ./mvnw -B clean verify package -DskipTests=false

      # 1-5. [NEW] í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸ ê²Œì‹œ
      # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œì—ë„ ì‹¤í–‰ë˜ì–´ ì–´ë–¤ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆëŠ”ì§€ GitHub UIì—ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      - name: Publish JUnit Test Report
        uses: mikepenz/action-junit-report@v4
        if: always() # ë¹Œë“œ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'

      # 1-6. [NEW] íŒŒì¼ ì‹œìŠ¤í…œ ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
      # í”„ë¡œì íŠ¸ ë‚´ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë‚˜ ì„¤ì • íŒŒì¼ì— ì¹˜ëª…ì ì¸ ë³´ì•ˆ í—ˆì ì´ ìˆëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
      - name: Run Trivy Vulnerability Scanner (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # 1-7. ìµœì¢… JAR íŒŒì¼ ì¶”ì¶œ (ê²½ê³  ì œê±° ë¡œì§)
      - name: Extract Final JAR Path
        id: jar_file
        run: |
          JAR_FILE=$(find target/ -name "*.jar" | grep -v "original" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: No executable JAR found!"
            exit 1
          fi
          echo "Found JAR: $JAR_FILE"
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT

      # 1-8. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Deployable JAR
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7

  # === Job 2: ë„ì»¤ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì„ íƒ ì‚¬í•­) ===
  # ì‹¤ì œ ë°°í¬ ì „, ì»¨í…Œì´ë„ˆí™”ê°€ ê°€ëŠ¥í•œì§€ ë¯¸ë¦¬ ë¹Œë“œí•´ë´…ë‹ˆë‹¤.
  docker_build_test:
    name: 2. Docker Build Test
    runs-on: ubuntu-latest
    needs: build_and_secure
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: target/
      
      # ê°„ë‹¨í•œ Dockerfileì´ ì—†ì–´ë„ ë¹Œë“œ ê°€ëŠ¥í•œì§€ í™•ì¸ (Spring Boot Buildpack í™œìš© ê°€ëŠ¥)
      # ì—¬ê¸°ì„œëŠ” Dockerfileì´ ìˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, ì—†ìœ¼ë©´ ì´ ë‹¨ê³„ë¥¼ ìŠ¤í‚µí•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥
      - name: Check Dockerfile existence
        id: check_docker
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No Dockerfile found, skipping build."
          fi

      - name: Build Docker Image (Test)
        if: steps.check_docker.outputs.exists == 'true'
        run: docker build . --file Dockerfile --tag my-spring-app:test

  # === Job 3: ë°°í¬ ë‹¨ê³„ ===
  deploy:
    name: 3. Deployment Stage
    needs: build_and_secure # ë¹Œë“œ ë° ë³´ì•ˆ ê²€ì‚¬ê°€ í†µê³¼í•´ì•¼ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./downloaded-artifact

      - name: Deployment Logic
        run: |
          echo "âœ… All tests and security scans passed."
          echo "ğŸš€ Deploying $(ls ./downloaded-artifact/*.jar)..."
          # ì—¬ê¸°ì— ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (AWS S3 ì—…ë¡œë“œ, SCP ì „ì†¡ ë“±) ì¶”ê°€
