name: "üõ°Ô∏è Finance Ops V5: Absolute Path & Atomic Execution"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log Level'
        default: 'DEBUG'

env:
  # 1. ÏãúÏä§ÌÖú ÌôòÍ≤Ω
  TZ: 'Asia/Seoul'
  DEBIAN_FRONTEND: noninteractive
  
  # 2. Ïª®ÌÖåÏù¥ÎÑà/ÌååÏùº ÏÑ§Ï†ï
  IMAGE_NAME: "finance-ledger-service"
  CONTAINER_NAME: "finance-ledger-svc-run"
  TARGET_FILE: "/app/ledger.dat"
  
  # 3. Î≥¥Ïïà Í≤ΩÎ°ú (Ï†ÑÏ≤¥ Ï†àÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö© - ${{ github.workspace }} ÌôúÏö©)
  # Ï£ºÏùò: ÎßàÏßÄÎßâÏóê Ïä¨ÎûòÏãú(/)Î•º ÎÑ£ÏßÄ ÏïäÏäµÎãàÎã§.
  OPS_ROOT: "${{ github.workspace }}/ops-data"
  PRIMARY_DIR: "${{ github.workspace }}/ops-data/primary"
  BACKUP_DIR: "${{ github.workspace }}/ops-data/backup"
  RESTORE_DIR: "${{ github.workspace }}/ops-data/restore_test"
  AUDIT_LOG: "${{ github.workspace }}/ops-data/audit.log"
  
  # 4. ÏïîÌò∏Ìôî ÌÇ§
  BACKUP_KEY: "finance-critical-key-v5-fixed"

jobs:
  atomic-ops-execution:
    name: üöÄ Atomic Ops (Absolute Paths)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      # ======================================================
      # Phase 1: Ïù∏ÌîÑÎùº ÌÜµÌï© Ï¥àÍ∏∞Ìôî (Initialization)
      # ======================================================
      - name: üì• Checkout & Setup Environment
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Initialize Infrastructure (Absolute Paths)
        run: |
          echo "===== PHASE 1: INIT ====="
          
          # 1. Ï†àÎåÄ Í≤ΩÎ°ú ÌôïÏù∏ Î∞è ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          echo "Workspace Root: ${{ github.workspace }}"
          
          # -p ÏòµÏÖòÏúºÎ°ú ÏÉÅÏúÑ ÎîîÎ†âÌÜ†Î¶¨ÍπåÏßÄ Ìïú Î≤àÏóê ÏÉùÏÑ±
          mkdir -p "${{ env.PRIMARY_DIR }}/data"
          mkdir -p "${{ env.BACKUP_DIR }}"
          mkdir -p "${{ env.RESTORE_DIR }}"
          
          # 2. Í∞êÏÇ¨ Î°úÍ∑∏ Ï¥àÍ∏∞Ìôî
          touch "${{ env.AUDIT_LOG }}"
          {
            echo "START_TIME: $(date)"
            echo "SYSTEM_PATH: $PATH"
          } >> "${{ env.AUDIT_LOG }}"
          
          # 3. ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ Í≤ÄÏ¶ù (ÎîîÎ≤ÑÍπÖÏö©)
          echo "‚úÖ Created Directories:"
          ls -R "${{ env.OPS_ROOT }}"
          
          # 4. ÌïÑÏàò Ìà¥ ÏÑ§Ïπò
          sudo apt-get update && sudo apt-get install -y openssl zip

      # ======================================================
      # Phase 2: ÎπåÎìú Î∞è Ïã§Ìñâ (Build & Run)
      # ======================================================
      - name: üê≥ Build & Run Container
        run: |
          echo "===== PHASE 2: DOCKER OPS =====" >> "${{ env.AUDIT_LOG }}"
          
          # Dockerfile ÏÉùÏÑ±
          cat <<EOF > Dockerfile
          FROM alpine:3.18
          RUN apk add --no-cache bash openssl
          WORKDIR /app
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          RUN echo "Finance Ledger Data V5" > ledger.dat && \
              chown finsvc:finsvc ledger.dat && \
              chmod 644 ledger.dat
          USER finsvc
          CMD ["tail", "-f", "/dev/null"]
          EOF
          
          # ÎπåÎìú Î∞è Ïã§Ìñâ
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart=on-failure:3 \
            --memory="512m" \
            ${{ env.IMAGE_NAME }}:latest
            
          echo "‚úÖ Container Started" >> "${{ env.AUDIT_LOG }}"

      # ======================================================
      # Phase 3: ÏßÑÎã® Î∞è ÏûêÍ∞Ä ÏπòÏú† (Atomic Heal)
      # ======================================================
      - name: ü©∫ Diagnose & Self-Heal
        run: |
          echo "===== PHASE 3: DIAGNOSE & HEAL =====" >> "${{ env.AUDIT_LOG }}"
          sleep 5
          
          # ÌååÏùº Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
            echo "‚úÖ [DIAGNOSIS] File Found." | tee -a "${{ env.AUDIT_LOG }}"
          else
            echo "‚ö†Ô∏è [DIAGNOSIS] File Missing! Healing..." | tee -a "${{ env.AUDIT_LOG }}"
            docker exec ${{ env.CONTAINER_NAME }} sh -c "echo 'Healed Data V5' > ${{ env.TARGET_FILE }}"
            
            if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
               echo "‚úÖ [HEALING] Success." | tee -a "${{ env.AUDIT_LOG }}"
            else
               echo "‚ùå [HEALING] Failed." | tee -a "${{ env.AUDIT_LOG }}"
               exit 1
            fi
          fi

      # ======================================================
      # Phase 4: Î∞±ÏóÖ Î∞è ÏïîÌò∏Ìôî (Fixed: Absolute Paths)
      # ======================================================
      - name: üì¶ Secure Backup & Encryption
        run: |
          echo "===== PHASE 4: BACKUP OPS =====" >> "${{ env.AUDIT_LOG }}"
          
          # 1. Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú (Ï†àÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö©)
          docker cp ${{ env.CONTAINER_NAME }}:${{ env.TARGET_FILE }} "${{ env.PRIMARY_DIR }}/data/ledger.dat"
          
          # 2. Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
          echo "{\"timestamp\":\"$(date)\"}" > "${{ env.PRIMARY_DIR }}/data/metadata.json"
          
          # 3. [FIXED] ÏïïÏ∂ï (tar) - Ï†àÎåÄ Í≤ΩÎ°ú Î¨∏Ï†ú Ìï¥Í≤∞
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_NAME="finance_full_${TIMESTAMP}.tar.gz"
          ENC_NAME="${ARCHIVE_NAME}.enc"
          
          echo "Creating Archive at: ${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}"
          
          # [ÌïµÏã¨ ÏàòÏ†ï] 
          # -C ÏòµÏÖòÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏÜåÏä§ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥ÎèôÌïú Ìö®Í≥ºÎ•º ÎÉÑ.
          # Ï∂úÎ†• ÌååÏùº(f)ÏùÄ Ï†àÎåÄ Í≤ΩÎ°úÎ°ú ÏßÄÏ†ï.
          tar -czf "${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}" -C "${{ env.PRIMARY_DIR }}" .
          
          if [ -f "${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}" ]; then
             echo "‚úÖ Archive Created." | tee -a "${{ env.AUDIT_LOG }}"
          else
             echo "‚ùå Archive Creation Failed." | tee -a "${{ env.AUDIT_LOG }}"
             ls -ld "${{ env.BACKUP_DIR }}"
             exit 1
          fi
          
          # 4. ÏïîÌò∏Ìôî (OpenSSL) - Ï†àÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö©
          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
            -in "${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}" \
            -out "${{ env.BACKUP_DIR }}/${ENC_NAME}" \
            -k "${{ env.BACKUP_KEY }}"
            
          # ÏõêÎ≥∏ ÏÇ≠Ï†ú
          rm "${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}"
          
          echo "‚úÖ Backup Encrypted: ${ENC_NAME}" | tee -a "${{ env.AUDIT_LOG }}"

      # ======================================================
      # Phase 5: Í∞ïÏ†ú Î≥µÏõê ÌÖåÏä§Ìä∏ (Mandatory Drill)
      # ======================================================
      - name: üß™ Mandatory Restore Drill
        run: |
          echo "===== PHASE 5: RESTORE DRILL =====" >> "${{ env.AUDIT_LOG }}"
          
          # ÏµúÏã† ÏïîÌò∏Ìôî ÌååÏùº Ï∞æÍ∏∞ (Ï†àÎåÄ Í≤ΩÎ°ú)
          LATEST_ENC=$(ls -t "${{ env.BACKUP_DIR }}"/*.enc | head -1)
          RESTORE_TARGET="${{ env.RESTORE_DIR }}/restored.tar.gz"
          
          echo "Restoring from: $LATEST_ENC"
          
          # 1. Î≥µÌò∏Ìôî
          openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 \
            -in "$LATEST_ENC" \
            -out "$RESTORE_TARGET" \
            -k "${{ env.BACKUP_KEY }}"
            
          # 2. ÏïïÏ∂ï Ìï¥Ï†ú (Ï†àÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö©)
          tar -xzf "$RESTORE_TARGET" -C "${{ env.RESTORE_DIR }}"
          
          # 3. Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
          if [ -f "${{ env.RESTORE_DIR }}/data/ledger.dat" ]; then
             echo "‚úÖ [DRILL] Data Verified." | tee -a "${{ env.AUDIT_LOG }}"
          else
             echo "‚ùå [DRILL] Data Missing." | tee -a "${{ env.AUDIT_LOG }}"
             ls -R "${{ env.RESTORE_DIR }}"
             exit 1
          fi

      # ======================================================
      # Phase 6: ÎßàÎ¨¥Î¶¨
      # ======================================================
      - name: üßπ Final Cleanup & Upload
        if: always()
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          rm -rf "${{ env.PRIMARY_DIR }}"
          rm -rf "${{ env.RESTORE_DIR }}"

      - name: ‚òÅÔ∏è Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: finance-compliance-evidence
          path: |
            ${{ env.BACKUP_DIR }}/*.enc
            ${{ env.AUDIT_LOG }}
          retention-days: 90
