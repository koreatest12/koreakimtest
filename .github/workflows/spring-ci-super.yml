name: "ğŸ›¡ï¸ Finance Ops V3: Zero-Error Build, Backup & Integrity Drill"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_restore_test:
        description: 'ë°±ì—… ì¦‰ì‹œ ë³µì› í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ (Drill)'
        required: true
        type: boolean
        default: true

env:
  # 1. ì‹œìŠ¤í…œ í™˜ê²½ ì„¤ì •
  TZ: 'Asia/Seoul'
  DEBIAN_FRONTEND: noninteractive
  
  # 2. ì»¨í…Œì´ë„ˆ ë° íŒŒì¼ ì„¤ì •
  IMAGE_NAME: "finance-ledger-service"
  CONTAINER_NAME: "finance-ledger-svc-run"
  TARGET_FILE: "/app/ledger.dat"
  
  # 3. ë³´ì•ˆ ìŠ¤í† ë¦¬ì§€ ê²½ë¡œ
  OPS_ROOT: "./ops-data"
  PRIMARY_DIR: "./ops-data/primary"
  BACKUP_DIR: "./ops-data/backup"
  RESTORE_TEST_DIR: "./ops-data/restore_test"
  AUDIT_LOG: "./ops-data/audit-trail.log"
  
  # 4. (ì£¼ì˜) ì‹¤ì œ ìš´ì˜ ì‹œì—” ${{ secrets.BACKUP_KEY }} ì‚¬ìš© í•„ìˆ˜
  BACKUP_KEY: "finance-secret-key-2025-complex-salt"

jobs:
  finance-ops-pipeline:
    name: ğŸ¥ Ops Pipeline (Build -> Heal -> Encrypt -> Verify)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      # ======================================================
      # Phase 1: ì¸í”„ë¼ ì´ˆê¸°í™” ë° ì‚¬ì „ ì ê²€
      # ======================================================
      - name: ğŸ“¥ Checkout & Setup
        uses: actions/checkout@v4

      - name: ğŸ’¾ Pre-flight Check (Disk & Tools)
        run: |
          echo "Checking System Resources..."
          
          # 1. ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          AVAILABLE=$(df -k . | awk 'NR==2 {print $4}')
          if [ "$AVAILABLE" -lt 2097152 ]; then # 2GB
             echo "âŒ Error: Insufficient Disk Space (<2GB)."
             exit 1
          fi
          
          # 2. í•„ìˆ˜ íˆ´ í™•ì¸
          command -v openssl >/dev/null || { echo "âŒ OpenSSL not found"; exit 1; }
          command -v zip >/dev/null || { echo "âŒ Zip not found"; exit 1; }
          
          echo "âœ… Pre-flight Check Passed."

      - name: ğŸ“‚ Initialize Secure Zones
        run: |
          mkdir -p ${{ env.PRIMARY_DIR }}/{data,artifacts}
          mkdir -p ${{ env.BACKUP_DIR }}
          mkdir -p ${{ env.RESTORE_TEST_DIR }}
          
          # ê°ì‚¬ ë¡œê·¸ í—¤ë” ì‘ì„±
          echo "===== FINANCE OPS AUDIT LOG =====" > ${{ env.AUDIT_LOG }}
          echo "TIMESTAMP: $(date)" >> ${{ env.AUDIT_LOG }}
          echo "ACTOR: ${{ github.actor }}" >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 2: Docker ë¹Œë“œ ë° ì‹¤í–‰ (Robust)
      # ======================================================
      - name: ğŸ“ Generate Secure Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM alpine:3.18
          RUN apk add --no-cache bash openssl
          WORKDIR /app
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          # íŒŒì¼ ìƒì„± ë° íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
          RUN echo "Finance Data Generated at $(date)" > ledger.dat && \
              chown finsvc:finsvc ledger.dat && \
              chmod 644 ledger.dat
          USER finsvc
          CMD ["tail", "-f", "/dev/null"]
          EOF
          echo "âœ… Dockerfile Generated." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ”¨ Build & Run Container
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # ë¦¬ì†ŒìŠ¤ ì œí•œì„ ë‘” ìƒíƒœë¡œ ì‹¤í–‰
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart=on-failure:3 \
            --memory="512m" \
            ${{ env.IMAGE_NAME }}:latest
            
          echo "âœ… Container Running." >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 3: ì§„ë‹¨ ë° ìê°€ ì¹˜ìœ  (Self-Healing Logic)
      # ======================================================
      - name: ğŸ” Diagnose File Existence
        id: verify_file
        run: |
          echo "Diagnosing container filesystem..."
          sleep 5
          
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
            echo "âœ… File Found."
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ File Missing."
            echo "file_exists=false" >> $GITHUB_OUTPUT
            # ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
            docker exec ${{ env.CONTAINER_NAME }} ls -R /app >> ${{ env.AUDIT_LOG }}
          fi

      # [FIXED] êµ¬ë¬¸ ì—ëŸ¬ ìˆ˜ì •: ë”°ì˜´í‘œ(")ë¡œ ê°ì‹¸ì„œ YAML íŒŒì‹± ì—ëŸ¬ ë°©ì§€
      - name: ğŸ’Š Self-Heal:Recover Missing Data
        if: "${{ steps.verify_file.outputs.file_exists == 'false' }}"
        run: |
          echo "âš ï¸ Triggering Self-Healing Protocol..."
          docker exec ${{ env.CONTAINER_NAME }} sh -c "echo 'Recovered Data via Protocol' > ${{ env.TARGET_FILE }}"
          
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
             echo "âœ… Self-Healing Success." >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ Self-Healing Failed. Aborting." >> ${{ env.AUDIT_LOG }}
             exit 1
          fi

      # ======================================================
      # Phase 4: ë³´ì•ˆ ë°±ì—… ë° ì•”í˜¸í™” (Encryption)
      # ======================================================
      - name: ğŸ“¦ Secure Extraction & Metadata
        run: |
          # 1. ë°ì´í„° ì¶”ì¶œ
          docker cp ${{ env.CONTAINER_NAME }}:${{ env.TARGET_FILE }} ${{ env.PRIMARY_DIR }}/data/ledger.dat
          
          # 2. ë©”íƒ€ë°ì´í„° ìƒì„± (JSON)
          cat <<EOF > ${{ env.PRIMARY_DIR }}/data/metadata.json
          {
            "backup_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source_image": "${{ env.IMAGE_NAME }}:latest",
            "commit_sha": "${{ github.sha }}",
            "integrity_hash": "$(sha256sum ${{ env.PRIMARY_DIR }}/data/ledger.dat | awk '{print $1}')"
          }
          EOF
          
          echo "âœ… Data & Metadata Extracted." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ” Encrypt Archive (AES-256)
        id: encryption
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ARCHIVE_NAME="finance_backup_${TIMESTAMP}.tar.gz"
          ENC_NAME="${ARCHIVE_NAME}.enc"
          
          # ì••ì¶•
          cd ${{ env.PRIMARY_DIR }}
          tar -czf ../../${{ env.BACKUP_DIR }}/${ARCHIVE_NAME} .
          cd ../..
          
          # ì•”í˜¸í™” (PBKDF2 ì ìš©)
          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
            -in ${{ env.BACKUP_DIR }}/${ARCHIVE_NAME} \
            -out ${{ env.BACKUP_DIR }}/${ENC_NAME} \
            -k "${{ env.BACKUP_KEY }}"
            
          # ì›ë³¸ ì‚­ì œ (ë³´ì•ˆ)
          rm ${{ env.BACKUP_DIR }}/${ARCHIVE_NAME}
          
          # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
          echo "enc_filename=${ENC_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Backup Encrypted: ${ENC_NAME}" >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 5: ë°±ì—… ë³µì› í…ŒìŠ¤íŠ¸ (Recovery Drill) - NEW!
      # ======================================================
      - name: ğŸ§ª Verify Backup (Restore Drill)
        if: "${{ github.event.inputs.run_restore_test == 'true' || true }}"
        run: |
          echo "ğŸ§ª Starting Restore Drill..."
          ENC_FILE="${{ env.BACKUP_DIR }}/${{ steps.encryption.outputs.enc_filename }}"
          RESTORE_TAR="${{ env.RESTORE_TEST_DIR }}/restored.tar.gz"
          
          # 1. ë³µí˜¸í™” í…ŒìŠ¤íŠ¸
          openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 \
            -in $ENC_FILE \
            -out $RESTORE_TAR \
            -k "${{ env.BACKUP_KEY }}"
            
          if [ $? -eq 0 ]; then
             echo "âœ… Decryption Test Passed." >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ Decryption Test Failed!" >> ${{ env.AUDIT_LOG }}
             exit 1
          fi
          
          # 2. ì••ì¶• í•´ì œ ë° ë°ì´í„° í™•ì¸
          tar -xzf $RESTORE_TAR -C ${{ env.RESTORE_TEST_DIR }}
          if [ -f "${{ env.RESTORE_TEST_DIR }}/data/ledger.dat" ]; then
             echo "âœ… Data Integrity Verified." >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ Restored Data Missing!" >> ${{ env.AUDIT_LOG }}
             exit 1
          fi

      # ======================================================
      # Phase 6: ë§ˆë¬´ë¦¬ ë° ì¦ì  ì—…ë¡œë“œ
      # ======================================================
      - name: ğŸ§¹ Secure Cleanup
        if: always()
        run: |
          # ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          # í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ (ê³µê°„ í™•ë³´)
          rm -rf ${{ env.RESTORE_TEST_DIR }}

      - name: ğŸ“¢ Ops Notification
        if: success()
        run: echo "ğŸš€ [SUCCESS] Backup Pipeline & Restore Drill Completed Successfully."

      - name: â˜ï¸ Upload Compliance Evidence
        uses: actions/upload-artifact@v4
        with:
          name: finance-compliance-evidence
          path: |
            ${{ env.BACKUP_DIR }}/*.enc
            ${{ env.AUDIT_LOG }}
          retention-days: 90
