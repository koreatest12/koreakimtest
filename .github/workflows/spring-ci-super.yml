name: Spring Boot Super CI/CD Pipeline (Maven) ğŸš€

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì •ì˜ (Trigger Configuration)
# main ë˜ëŠ” develop ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë˜ê±°ë‚˜, ì´ ë¸Œëœì¹˜ë¡œ PRì´ ë“¤ì–´ì˜¬ ë•Œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

# 2. ì‘ì—… ê¶Œí•œ ì •ì˜
# GitHub Actionsê°€ ì½”ë“œë¥¼ ì½ê³ (read) ì•„í‹°íŒ©íŠ¸ë¥¼ ì—…ë¡œë“œ(write) í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
permissions:
  contents: read
  packages: write
  actions: write

# 3. ì‘ì—…(Jobs) ì •ì˜
jobs:
  build_and_test:
    name: Build, Test, and Package
    # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest 

    # ì‘ì—… ë‹¨ê³„(Steps) ì •ì˜
    steps:
    
      # 3-1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìµœì‹  ì½”ë“œ í™•ë³´)
      - name: 1. Checkout Code (ìµœì‹  ì†ŒìŠ¤ì½”ë“œ í™•ë³´)
        uses: actions/checkout@v4
        
      # 3-2. Java í™˜ê²½ ì„¤ì • (JDK 17 ì„¤ì • ë° Maven ìºì‹œ)
      - name: 2. Set up JDK 17 Environment (Adoptium/Temurin)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin' 
          # Maven ì˜ì¡´ì„± ìºì‹œë¥¼ í™œì„±í™”í•˜ì—¬ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
          cache: 'maven'

      # 3-3. Maven ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ê³„)
      - name: 3. Maven Build & Comprehensive Test Execution
        # 'clean verify'ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ë¹Œë“œ ì¤‘ë‹¨
        # 'package'ëŠ” 'verify' ë‹¨ê³„ í›„ì— ì‹¤í–‰ë˜ì–´ JAR íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
        run: mvn clean verify package
        
      # 3-4. ìµœì¢… JAR íŒŒì¼ ì´ë¦„ ì¶”ì¶œ
      # target ë””ë ‰í† ë¦¬ì—ì„œ ìƒì„±ëœ .jar íŒŒì¼ì˜ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.
      - name: 4. Extract JAR File Name
        id: jar_file
        run: |
          JAR_FILE=$(find target/ -name "*.jar" | head -n 1)
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
        
      # 3-5. ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (CDë¥¼ ìœ„í•œ JAR íŒŒì¼ ì¤€ë¹„)
      - name: 5. Upload Deployable JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          # 3-4 ë‹¨ê³„ì—ì„œ ì¶”ì¶œí•œ ë™ì  íŒŒì¼ ê²½ë¡œ ì‚¬ìš©
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7 # ì•„í‹°íŒ©íŠ¸ ë³´ì¡´ ê¸°ê°„ 7ì¼ ì„¤ì • (ìš´ì˜ ì •ì±…ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥)

# 4. ë°°í¬ ì‘ì—… (CD Place Holder)
# ì´ ì‘ì—…ì€ CI(í†µí•©)ê°€ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  deploy:
    name: Deployment Stage (CD)
    runs-on: ubuntu-latest
    needs: build_and_test # build_and_test Jobì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    
    steps:
      - name: Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./downloaded-artifact

      - name: Deployment Placeholder
        run: |
          echo "---------------------------------------------------------"
          echo "CI ì„±ê³µ! ì´ì œ ë‹¤ìŒ ë‹¨ê³„ì¸ ì„œë²„ ë°°í¬(CD)ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          echo "ë‹¤ìš´ë¡œë“œëœ JAR íŒŒì¼ì€ './downloaded-artifact'ì— ìœ„ì¹˜í•©ë‹ˆë‹¤."
          echo "---------------------------------------------------------"
          # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ (ì˜ˆ: SCP, SSHë¥¼ í†µí•´ AWS EC2 ë˜ëŠ” GCP VMìœ¼ë¡œ ë°°í¬)ë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤.
          # ì˜ˆì‹œ: scp ./downloaded-artifact/*.jar user@your-server-ip:/path/to/app/
          # ì˜ˆì‹œ: ssh user@your-server-ip "sudo systemctl restart spring-app"
