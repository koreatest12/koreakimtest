name: Spring Boot Mega CI/CD Pipeline (All-in-One) ğŸš€ğŸ›¡ï¸ğŸ³ğŸ’¾

# 1. íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

# 2. ê¶Œí•œ ì„¤ì • (Docker Push, Release, Security ë“±)
permissions:
  contents: write      # Semantic Release íƒœê·¸ ìƒì„± ë° ì»¤ë°‹
  packages: write      # GHCR(Docker) ì´ë¯¸ì§€ ì—…ë¡œë“œ
  actions: write
  checks: write
  security-events: write
  issues: write
  pull-requests: write

jobs:
  # ==================================================================================
  # JOB 1: ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì •ì  ë¶„ì„(SonarQube), ë³´ì•ˆ ì§„ë‹¨(Trivy)
  # ==================================================================================
  build_analyze_secure:
    name: 1. Build, Analyze & Secure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # SonarQube ë¶„ì„ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # [Maven Wrapper ìë™ ë³µêµ¬]
      - name: Ensure Maven Wrapper & Permissions
        run: |
          if [ ! -f mvnw ]; then
            echo "âš ï¸ 'mvnw' not found. Generating automatically..."
            mvn -N io.takari:maven:wrapper
          fi
          chmod +x mvnw

      # [ì •ì  ì½”ë“œ ë¶„ì„] SonarCloud Scan (í† í°ì´ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ë„˜ì–´ê°)
      # ì‹¤ì œ ì‚¬ìš© ì‹œ Settings > Secretsì— SONAR_TOKEN ë“±ë¡ í•„ìš”
      - name: Static Code Analysis (SonarCloud)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -n "$SONAR_TOKEN" ]; then
            ./mvnw -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
              -Dsonar.projectKey=my-spring-boot-project
          else
            echo "âš ï¸ SONAR_TOKEN not set. Skipping Static Analysis."
            ./mvnw -B clean verify package -DskipTests=false
          fi

      # [ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”] Trivy
      - name: Run Trivy Security Scan (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # [ìµœì¢… JAR ì¶”ì¶œ]
      - name: Extract Final JAR Path
        id: jar_file
        run: |
          JAR_FILE=$(find target/ -name "*.jar" | grep -v "original" | head -n 1)
          if [ -z "$JAR_FILE" ]; then echo "Error: No JAR found!"; exit 1; fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7

  # ==================================================================================
  # JOB 2: ë¶€í•˜ í…ŒìŠ¤íŠ¸ (Performance Testing - k6)
  # ==================================================================================
  performance_test:
    name: 2. Performance Load Test (k6)
    runs-on: ubuntu-latest
    needs: build_analyze_secure
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./target

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
      - name: Start Application for Testing
        run: |
          nohup java -jar ./target/*.jar &
          echo "Waiting for application to start..."
          sleep 20 # ì•± êµ¬ë™ ëŒ€ê¸° ì‹œê°„ (í•„ìš”ì‹œ ì¡°ì •)

      # k6 ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      - name: Ensure k6 Script Exists
        run: |
          if [ ! -f load-test.js ]; then
            echo "Creating default k6 load test script..."
            echo 'import http from "k6/http"; import { sleep } from "k6"; export const options = { vus: 10, duration: "10s" }; export default function () { http.get("http://localhost:8080"); sleep(1); }' > load-test.js
          fi

      # k6 ì‹¤í–‰
      - name: Run k6 Load Test
        uses: grafana/k6-action@v0.3.0
        with:
          filename: load-test.js

  # ==================================================================================
  # JOB 3: ì¸í”„ë¼ ì½”ë“œ ê²€ì¦ (Infrastructure as Code - Terraform)
  # ==================================================================================
  infra_validate:
    name: 3. Infra Validation (Terraform)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # tf íŒŒì¼ì´ ì—†ìœ¼ë©´ ë”ë¯¸ íŒŒì¼ ìƒì„±í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
      - name: Check Terraform Files
        run: |
          if [ -z "$(find . -name '*.tf')" ]; then
             echo "No Terraform files found. Creating dummy for validation check."
             echo 'output "hello" { value = "world" }' > main.tf
          fi

      - name: Terraform Format & Init
        run: |
          terraform fmt -check
          terraform init

      - name: Terraform Validate
        run: terraform validate

  # ==================================================================================
  # JOB 4: ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° í‘¸ì‹œ (Docker Hub / GHCR)
  # ==================================================================================
  container_push:
    name: 4. Docker Build & Push
    runs-on: ubuntu-latest
    needs: build_analyze_secure
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: target/

      # Dockerfileì´ ì—†ìœ¼ë©´ ìë™ ìƒì„±
      - name: Ensure Dockerfile Exists
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Creating default Dockerfile..."
            echo 'FROM eclipse-temurin:17-jdk-alpine' > Dockerfile
            echo 'COPY target/*.jar app.jar' >> Dockerfile
            echo 'ENTRYPOINT ["java","-jar","/app.jar"]' >> Dockerfile
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest,ghcr.io/${{ github.repository }}:${{ github.sha }}

  # ==================================================================================
  # JOB 5: ë°±ì—… ë° DB ë¤í”„ (Backup)
  # ==================================================================================
  backup_and_dump:
    name: 5. Backup & DB Dump
    runs-on: ubuntu-latest
    needs: build_analyze_secure
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./backup-staging

      - name: Generate Timestamp
        id: time
        run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Backup JAR & Generate Dump
        run: |
          mkdir -p ./final_backups
          cp ./backup-staging/*.jar ./final_backups/app_backup_${{ steps.time.outputs.timestamp }}.jar
          # DB Dump ì‹œë®¬ë ˆì´ì…˜
          echo "INSERT INTO logs VALUES ('Backup Test');" > ./final_backups/db_dump_${{ steps.time.outputs.timestamp }}.sql

      - name: Upload Backup Bundle
        uses: actions/upload-artifact@v4
        with:
          name: service-backup-${{ steps.time.outputs.timestamp }}
          path: ./final_backups/*
          retention-days: 30

  # ==================================================================================
  # JOB 6: ìë™ ë²„ì „ íƒœê¹… ë° ë¦´ë¦¬ìŠ¤ (Semantic Release)
  # ==================================================================================
  semantic_release:
    name: 6. Semantic Release
    runs-on: ubuntu-latest
    needs: [build_analyze_secure, container_push]
    if: github.ref == 'refs/heads/main' # ë©”ì¸ ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 19
          branches: |
            [
              "+([0-9])?(.{+([0-9]),x}).x",
              "main",
              "next",
              "next-major",
              { "name": "beta", "prerelease": true },
              { "name": "alpha", "prerelease": true }
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # JOB 7: ë°°í¬ (Deployment)
  # ==================================================================================
  deploy:
    name: 7. Final Deployment
    needs: [backup_and_dump, infra_validate, performance_test]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./deploy-ready

      - name: Execute Deployment
        run: echo "ğŸš€ Deploying to Production Server..."
