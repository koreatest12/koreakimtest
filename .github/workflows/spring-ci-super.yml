name: "ğŸ³ Docker Build & Replication Ops (Build, Run, Backup, Sync)"

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      image_name:
        description: 'ë¹Œë“œí•  ë„ì»¤ ì´ë¯¸ì§€ ì´ë¦„'
        required: true
        default: 'my-service-app'
      version_tag:
        description: 'ì´ë¯¸ì§€ íƒœê·¸ (ë²„ì „)'
        required: true
        default: 'v1.0.0'

env:
  # ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
  IMAGE_NAME: ${{ github.event.inputs.image_name || 'my-service-app' }}
  TAG: ${{ github.event.inputs.version_tag || 'v1.0.0' }}
  PRIMARY_DIR: "./ops-data/primary"     # ì£¼ ìš´ì˜ ë””ë ‰í† ë¦¬
  RESERVE_DIR: "./ops-data/reserve"     # ì˜ˆë¹„(ë°±ì—…) ë””ë ‰í† ë¦¬

jobs:
  docker-replication-pipeline:
    name: ğŸ—ï¸ Build, Run & Replicate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. ì‘ì—… ê³µê°„ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± (ì£¼/ì˜ˆë¹„)
      - name: ğŸ“‚ Create Operational Directories
        run: |
          echo "Creating directory structure..."
          mkdir -p ${{ env.PRIMARY_DIR }}/artifacts
          mkdir -p ${{ env.PRIMARY_DIR }}/container-fs
          mkdir -p ${{ env.RESERVE_DIR }}/artifacts
          mkdir -p ${{ env.RESERVE_DIR }}/container-fs
          
          echo "âœ… Directories Created:"
          ls -R ./ops-data

      # 3. í…ŒìŠ¤íŠ¸ìš© Dockerfile ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì´ ë‹¨ê³„ ìƒëµ ê°€ëŠ¥)
      - name: ğŸ“ Generate Demo Dockerfile (If not exists)
        run: |
          if [ ! -f Dockerfile ]; then
            echo "No Dockerfile found. Creating a demo Dockerfile..."
            cat <<EOF > Dockerfile
            FROM alpine:latest
            WORKDIR /app
            RUN echo "Service Started at $(date)" > status.log
            RUN echo "Critical Data Content" > data.txt
            CMD ["tail", "-f", "/dev/null"]
          EOF
          fi

      # 4. ë„ì»¤ ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (Build)
      - name: ğŸ”¨ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œí•˜ì§€ ì•Šê³  ë¡œì»¬ ë„ì»¤ ë°ëª¬ì— ë¡œë“œ
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.TAG }}

      # 6. ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (Install/Run)
      - name: ğŸš€ Run Container
        run: |
          echo "Starting Container..."
          docker run -d --name ${{ env.IMAGE_NAME }}-container ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          
          echo "Wait for initialization..."
          sleep 5
          
          echo "âœ… Container Status:"
          docker ps -a | grep ${{ env.IMAGE_NAME }}

      # 7. ì´ë¯¸ì§€ ì¶”ì¶œ ë° ì£¼ ë””ë ‰í† ë¦¬ì— ì €ì¥ (Image Artifact Generation)
      - name: ğŸ“¦ Export Image to Primary Dir
        run: |
          echo "Saving Docker Image as Tarball..."
          docker save -o ${{ env.PRIMARY_DIR }}/artifacts/${{ env.IMAGE_NAME }}_${{ env.TAG }}.tar ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          
          echo "âœ… Image saved to ${{ env.PRIMARY_DIR }}/artifacts/"

      # 8. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë°ì´í„° ì¶”ì¶œ (Container File System Extraction)
      - name: ğŸ“¤ Extract Container Filesystem
        run: |
          echo "Copying data from running container..."
          # ì»¨í…Œì´ë„ˆì˜ /app ë””ë ‰í† ë¦¬ë¥¼ í˜¸ìŠ¤íŠ¸ë¡œ ë³µì‚¬
          docker cp ${{ env.IMAGE_NAME }}-container:/app ${{ env.PRIMARY_DIR }}/container-fs/
          
          echo "âœ… Filesystem copied to ${{ env.PRIMARY_DIR }}/container-fs/"

      # 9. ì˜ˆë¹„ ë””ë ‰í† ë¦¬ë¡œ ì´ì¤‘ ë³µì œ (Replication / Sync)
      - name: ğŸ”„ Replicate to Reserve Directory (Backup Strategy)
        run: |
          echo "Syncing Primary to Reserve..."
          
          # ì´ë¯¸ì§€ ë³µì œ
          cp ${{ env.PRIMARY_DIR }}/artifacts/*.tar ${{ env.RESERVE_DIR }}/artifacts/
          
          # ì»¨í…Œì´ë„ˆ ë°ì´í„° ë³µì œ
          cp -r ${{ env.PRIMARY_DIR }}/container-fs/* ${{ env.RESERVE_DIR }}/container-fs/
          
          echo "âœ… Replication Complete."
          tree ./ops-data || ls -R ./ops-data

      # 10. ì»¨í…Œì´ë„ˆ ì •ë¦¬ (Cleanup)
      - name: ğŸ§¹ Cleanup Container
        if: always()
        run: |
          docker stop ${{ env.IMAGE_NAME }}-container || true
          docker rm ${{ env.IMAGE_NAME }}-container || true

      # 11. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Github Actions Artifacts)
      - name: â˜ï¸ Upload Replicated Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ops-replication-data
          path: ./ops-data/
          retention-days: 1
