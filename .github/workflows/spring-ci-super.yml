name: "ğŸ›¡ï¸ Finance Ops: Zero-Error Build, Encrypt & Backup System v2"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      debug_trace:
        description: 'ìƒì„¸ ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”'
        required: true
        type: boolean
        default: true

env:
  # ì‹œìŠ¤í…œ ì„¤ì •
  TZ: 'Asia/Seoul'  # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
  IMAGE_NAME: "finance-ledger-service"
  CONTAINER_NAME: "finance-ledger-svc-run"
  TARGET_FILE: "/app/ledger.dat"
  
  # ì €ì¥ ê²½ë¡œ
  PRIMARY_DIR: "./ops-data/primary"
  BACKUP_DIR: "./ops-data/backup"
  AUDIT_LOG: "./ops-data/audit-trail.log"
  
  # (ë°ëª¨ìš©) ë°±ì—… ì•”í˜¸í™” í‚¤ - ì‹¤ì œ ìš´ì˜ì‹œì—” Secrets ì‚¬ìš© ê¶Œì¥
  BACKUP_KEY: "finance-secret-key-2025"

jobs:
  diagnostic-pipeline:
    name: ğŸ¥ Build, Diagnose, Encrypt & Backup
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      # ======================================================
      # Phase 1: í™˜ê²½ ì ê²€ ë° ì´ˆê¸°í™”
      # ======================================================
      - name: ğŸ“¥ Checkout & Setup
        uses: actions/checkout@v4

      - name: ğŸ’¾ Check Disk Space (Pre-flight Check)
        run: |
          echo "Checking available disk space..."
          df -h
          AVAILABLE=$(df -k . | awk 'NR==2 {print $4}')
          if [ "$AVAILABLE" -lt 1048576 ]; then
             echo "âŒ Error: Not enough disk space (<1GB)."
             exit 1
          fi
          echo "âœ… Disk Space Check Passed."

      - name: ğŸ“‚ Initialize Secure Storage
        run: |
          mkdir -p ${{ env.PRIMARY_DIR }}/{data,artifacts}
          mkdir -p ${{ env.BACKUP_DIR }}
          touch ${{ env.AUDIT_LOG }}
          echo "[INFO] Pipeline Started: $(date)" >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 2: Docker í™˜ê²½ êµ¬ì„± (Robust Build)
      # ======================================================
      - name: ğŸ“ Force-Generate Correct Dockerfile
        run: |
          echo "Overwriting Dockerfile to ensure file existence..."
          
          cat <<EOF > Dockerfile
          FROM alpine:3.18
          RUN apk add --no-cache bash openssl
          WORKDIR /app
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          # [ì¤‘ìš”] íŒŒì¼ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          RUN echo "Finance Ledger Data - Created at Build Time: $(date)" > ledger.dat && \
              chown finsvc:finsvc ledger.dat && \
              chmod 644 ledger.dat
          USER finsvc
          CMD ["tail", "-f", "/dev/null"]
          EOF
          
          echo "âœ… Dockerfile regenerated." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ”¨ Build & Run Container
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart=on-failure:3 \
            ${{ env.IMAGE_NAME }}:latest
            
          echo "âœ… Container Started." >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 3: ì§„ë‹¨ ë° ìê°€ ì¹˜ìœ  (Diagnosis & Self-Healing)
      # ======================================================
      - name: ğŸ” Verify File Existence (Diagnostic)
        id: verify_file
        run: |
          echo "Checking if file exists inside container..."
          sleep 5
          
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
            echo "âœ… File FOUND at ${{ env.TARGET_FILE }}"
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "[INFO] File check passed." >> ${{ env.AUDIT_LOG }}
          else
            echo "âŒ File NOT FOUND at ${{ env.TARGET_FILE }}"
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "[WARN] File check failed. Triggering Self-Healing." >> ${{ env.AUDIT_LOG }}
            
            echo "==== CONTAINER DEBUG INFO ===="
            docker exec ${{ env.CONTAINER_NAME }} ls -R /app || echo "Container Dead"
          fi

      # [FIXED] ë¬¸ë²• ì—ëŸ¬ ìˆ˜ì • ì™„ë£Œ (${{ }} ì ìš©)
      - name: ğŸ’Š Self-Heal: Generate Data if Missing
        if: ${{ steps.verify_file.outputs.file_exists == 'false' }}
        run: |
          echo "âš ï¸ Attempting Self-Healing: Generating file at runtime..."
          docker exec ${{ env.CONTAINER_NAME }} sh -c "echo 'Recovered Data via Self-Heal' > ${{ env.TARGET_FILE }}"
          
          if docker exec ${{ env.CONTAINER_NAME }} [ -f "${{ env.TARGET_FILE }}" ]; then
             echo "âœ… Self-Healing SUCCESS." >> ${{ env.AUDIT_LOG }}
          else
             echo "âŒ Self-Healing FAILED." >> ${{ env.AUDIT_LOG }}
             exit 1
          fi

      # ======================================================
      # Phase 4: ë³´ì•ˆ ë°±ì—… ë° ì•”í˜¸í™” (Backup & Security)
      # ======================================================
      - name: ğŸ“¦ Secure Copy & Backup
        run: |
          echo "Copying data..."
          docker cp ${{ env.CONTAINER_NAME }}:${{ env.TARGET_FILE }} ${{ env.PRIMARY_DIR }}/data/ledger_backup.dat
          
          if [ -f "${{ env.PRIMARY_DIR }}/data/ledger_backup.dat" ]; then
            echo "âœ… Copy Successful."
          else
            echo "âŒ Local Copy Failed."
            exit 1
          fi

      - name: ğŸ” Encrypt & Archive (AES-256)
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_FILE="${{ env.BACKUP_DIR }}/finance-backup-${TIMESTAMP}.tar.gz"
          ENC_FILE="${BACKUP_FILE}.enc"
          
          echo "Compressing..."
          tar -czf $BACKUP_FILE ${{ env.PRIMARY_DIR }}
          
          echo "Encrypting (AES-256)..."
          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 10000 \
            -in $BACKUP_FILE \
            -out $ENC_FILE \
            -k "${{ env.BACKUP_KEY }}"
            
          # ì›ë³¸ ì••ì¶•íŒŒì¼ ì‚­ì œ (ë³´ì•ˆìƒ ì•”í˜¸í™” íŒŒì¼ë§Œ ë‚¨ê¹€)
          rm $BACKUP_FILE
          
          # í•´ì‹œ ìƒì„±
          sha256sum $ENC_FILE > ${ENC_FILE}.sha256
          
          echo "âœ… Backup Encrypted & Secured: $ENC_FILE" >> ${{ env.AUDIT_LOG }}

      # ======================================================
      # Phase 5: ì •ë¦¬ ë° ë¦¬í¬íŒ…
      # ======================================================
      - name: ğŸ§¹ Cleanup Environment
        if: always()
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      - name: â˜ï¸ Upload Audit Evidence
        uses: actions/upload-artifact@v4
        with:
          name: finance-secure-evidence
          path: |
            ${{ env.BACKUP_DIR }}/*.enc
            ${{ env.BACKUP_DIR }}/*.sha256
            ${{ env.AUDIT_LOG }}
          retention-days: 30
