name: "ğŸ¦ Finance Ops: Secure Release (Fixed & Enhanced)"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: true
        type: boolean
        default: true

env:
  IMAGE_NAME: "finance-ledger-service"
  TAG: ${{ github.ref_name }}
  CONTAINER_NAME: "finance-ledger-svc-run"
  PRIMARY_DIR: "./secure-storage/primary"
  RESERVE_DIR: "./secure-storage/dr-site"
  AUDIT_LOG: "./audit-report.log"

jobs:
  secure-pipeline:
    name: ğŸ›¡ï¸ Build, Run & Verify
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. ìš´ì˜ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
      - name: ğŸ“‚ Create Operations Structure
        run: |
          echo "Initializing Finance Ops Environment..."
          mkdir -p ${{ env.PRIMARY_DIR }}/{artifacts,logs,data}
          mkdir -p ${{ env.RESERVE_DIR }}
          
          # ê°ì‚¬ ë¡œê·¸ ì‹œì‘
          echo "[INFO] Workflow Started at $(date)" > ${{ env.AUDIT_LOG }}

      # 3. [FIXED] Dockerfile ìƒì„± (ë¬¸ë²• ì—ëŸ¬ ë°©ì§€ìš© ì•ˆì „í•œ ë°©ì‹)
      - name: ğŸ“ Generate Robust Dockerfile
        run: |
          # ê¸°ì¡´ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„± (ë“¤ì—¬ì“°ê¸° ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ printf ì‚¬ìš©í•˜ì§€ ì•Šê³  ë‹¨ìˆœí™”ëœ cat ì‚¬ìš©)
          if [ ! -f Dockerfile ]; then
            echo "No Dockerfile found. Generating secure default..."
            
            # ---------------------------------------------------------
            # ì¤‘ìš”: ì•„ë˜ EOFëŠ” ì¤„ì˜ ë§¨ ì•ì— ë¶™ì—¬ì•¼ ì•ˆì „í•˜ì§€ë§Œ,
            # YAML ê°€ë…ì„±ì„ ìœ„í•´ <<-EOF ë¥¼ ì‚¬ìš©í•˜ê³  ì•ì— íƒ­(Tab)ì„ í—ˆìš©í•©ë‹ˆë‹¤.
            # í•˜ì§€ë§Œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ ì•„ë˜ì²˜ëŸ¼ ì‘ì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
            # ---------------------------------------------------------
            cat <<EOF > Dockerfile
          FROM alpine:3.18
          # 1. ë³´ì•ˆ ìœ ì € ìƒì„±
          RUN addgroup -S finsvc && adduser -S finsvc -G finsvc
          # 2. ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì • ë° ê¶Œí•œ ë¶€ì—¬ (ROOT ê¶Œí•œìœ¼ë¡œ ìˆ˜í–‰)
          WORKDIR /app
          RUN chown -R finsvc:finsvc /app
          # 3. ìœ ì € ì „í™˜
          USER finsvc
          # 4. ì´ˆê¸° ë°ì´í„° ìƒì„±
          RUN echo "Finance Ledger Initialized: \$(date)" > ledger.dat
          # 5. í”„ë¡œì„¸ìŠ¤ ìœ ì§€
          CMD ["tail", "-f", "/dev/null"]
          EOF
          
          fi
          
          echo "âœ… Dockerfile Generated:"
          cat Dockerfile

      # 4. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. ì´ë¯¸ì§€ ë¹Œë“œ
      - name: ğŸ”¨ Build Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.TAG }}

      # 6. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ìë™ ë³µêµ¬ (Self-Healing)
      - name: ğŸš€ Run Container (Secure Mode)
        run: |
          echo "Starting Container: ${{ env.CONTAINER_NAME }}"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°
          docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë¦¬ì†ŒìŠ¤ ì œí•œ ë° ì¬ì‹œì‘ ì •ì±… ì ìš©)
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --memory="512m" \
            --cpus="0.5" \
            --restart=on-failure:3 \
            ${{ env.IMAGE_NAME }}:${{ env.TAG }}
            
          # ì‹¤í–‰ ì§í›„ ìƒíƒœ í™•ì¸
          docker ps -a | grep ${{ env.CONTAINER_NAME }}

      # 7. ì •ë°€ í—¬ìŠ¤ ì²´í¬ (Smart Wait Loop)
      - name: ğŸ©º Health Check & Debugging
        run: |
          echo "Checking service health..."
          
          # ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°
          RETRIES=10
          for i in $(seq 1 $RETRIES); do
            STATUS=$(docker inspect -f '{{.State.Running}}' ${{ env.CONTAINER_NAME }} 2>/dev/null)
            
            if [ "$STATUS" == "true" ]; then
              echo "âœ… Service is HEALTHY (Attempt $i)"
              exit 0
            fi
            
            echo "â³ Waiting... ($i/$RETRIES)"
            sleep 3
          done
          
          # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì¶œë ¥ í›„ ì¢…ë£Œ
          echo "âŒ Service FAILED to start."
          echo "===== CONTAINER LOGS ====="
          docker logs ${{ env.CONTAINER_NAME }}
          exit 1

      # 8. ì•„í‹°íŒ©íŠ¸ ì¶”ì¶œ ë° í•´ì‹œ ê²€ì¦ (Backup & Integrity)
      - name: ğŸ“¦ Secure Backup & Hash
        if: success()
        run: |
          echo "Starting Backup Process..."
          
          # 1. ì´ë¯¸ì§€ ì €ì¥
          docker save -o ${{ env.PRIMARY_DIR }}/artifacts/image.tar ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          
          # 2. ë°ì´í„° ì¶”ì¶œ
          docker cp ${{ env.CONTAINER_NAME }}:/app/ledger.dat ${{ env.PRIMARY_DIR }}/data/
          
          # 3. ë¬´ê²°ì„± ê²€ì¦ (SHA256)
          cd ${{ env.PRIMARY_DIR }}/artifacts
          sha256sum image.tar > checksum.sha256
          
          echo "âœ… Backup & Integrity Check Complete"
          ls -lR ../../

      # 9. í´ë¦°ì—…
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      # 10. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: â˜ï¸ Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: finance-audit-logs
          path: |
            ${{ env.AUDIT_LOG }}
            ${{ env.PRIMARY_DIR }}
