name: Spring Boot Final CI/CD Pipeline (Maven - Stable) ğŸš€âœ…

# 1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì •ì˜ (Trigger Configuration)
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

# 2. ì‘ì—… ê¶Œí•œ ì •ì˜
permissions:
  contents: read
  packages: write
  actions: write

# 3. ì‘ì—…(Jobs) ì •ì˜
jobs:
  build_and_test:
    name: Build, Test, and Package
    # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest 

    # ì‘ì—… ë‹¨ê³„(Steps) ì •ì˜
    steps:
    
      # 3-1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìµœì‹  ì½”ë“œ í™•ë³´)
      - name: 1. Checkout Code (ìµœì‹  ì†ŒìŠ¤ì½”ë“œ í™•ë³´)
        uses: actions/checkout@v4

      # 3-2. Java í™˜ê²½ ì„¤ì • (JDK 17 ì„¤ì • ë° Maven ìºì‹œ)
      - name: 2. Set up JDK 17 Environment (Adoptium/Temurin)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin' 
          # Maven ì˜ì¡´ì„± ìºì‹œë¥¼ í™œì„±í™”í•˜ì—¬ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
          cache: 'maven'

      # 3-3. **[ì—ëŸ¬ í•´ê²° ë°˜ì˜]** Maven Wrapper ê¶Œí•œ ë¶€ì—¬ ë° ì—ëŸ¬ ë¬´ì‹œ
      # 'mvnw' íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì—†ë”ë¼ë„ ì›Œí¬í”Œë¡œìš°ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
      - name: 3. Grant execute permission to mvnw (Error Handled)
        # '|| true' ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì´ ì—†ê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•´ë„ Jobì„ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•ŠìŠµë‹ˆë‹¤.
        # ëŒ€ë¶€ë¶„ì˜ ê²½ìš° actions/checkoutì´ ê¶Œí•œì„ ìœ ì§€í•˜ì§€ë§Œ, í™•ì‹¤í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        run: |
          if [ -f mvnw ]; then
            chmod +x mvnw
            echo "mvnw ì‹¤í–‰ ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "ê²½ê³ : 'mvnw' íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ 'mvn' ëª…ë ¹ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        # ë‹¨, ë‹¤ìŒ ë‹¨ê³„ì—ì„œ 'mvn' ëŒ€ì‹  'mvnw'ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒì¼ì´ ì—†ì„ ë•Œ ì‹¤íŒ¨í•˜ë¯€ë¡œ, 
        # ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì•ˆì •ì ì¸ 'mvn' ëª…ë ¹ì„ ì‚¬ìš©í•˜ë„ë¡ ìœ ì§€í•©ë‹ˆë‹¤.

      # 3-4. Maven ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìµœì‹  ë¦¬ì†ŒìŠ¤ ì»´íŒŒì¼ ë° ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸)
      - name: 4. Maven Build & Comprehensive Test Execution (CLEAN PACKAGE)
        # ì•ˆì •ì„±ì„ ìœ„í•´ 'mvn' ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (mvnw íŒŒì¼ ìœ ë¬´ì— ê´€ê³„ ì—†ì´ ë™ì‘)
        # -B: Batch mode, -DskipTests=false: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì„ ëª…ì‹œì ìœ¼ë¡œ ë³´ì¥
        run: mvn -B clean verify package -DskipTests=false
        
      # 3-5. **[ê²½ê³  ë©”ì‹œì§€ í•´ê²° ë°˜ì˜]** ìµœì¢… JAR íŒŒì¼ ì´ë¦„ ì¶”ì¶œ
      # spring-boot-maven-pluginì— ì˜í•´ ìƒì„±ëœ ìµœì¢… ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ë§Œ ì •í™•í•˜ê²Œ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
      - name: 5. Extract Final Executable JAR File Name (Warning Fix Applied)
        id: jar_file
        run: |
          # ìµœì¢… ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼(*.jar)ì„ ì°¾ë˜, ì›ë³¸ í´ë˜ìŠ¤ JAR íŒŒì¼(original)ì€ ì œì™¸í•©ë‹ˆë‹¤.
          # ì´ëŠ” Overwriting ê²½ê³ ë¥¼ ë°œìƒì‹œí‚¤ëŠ” íŒŒì¼ì„ íšŒí”¼í•˜ê³ , ìµœì¢… ì‚°ì¶œë¬¼ë§Œ ì„ íƒí•©ë‹ˆë‹¤.
          JAR_FILE=$(find target/ -name "*.jar" | grep -v "original" | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "ì˜¤ë¥˜: target ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìµœì¢… JAR íŒŒì¼ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "ìµœì¢… JAR íŒŒì¼ ê²½ë¡œ: $JAR_FILE"

      # 3-6. ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (CDë¥¼ ìœ„í•œ JAR íŒŒì¼ ì¤€ë¹„)
      - name: 6. Upload Deployable JAR Artifact (ê²½ê³  ì—†ì´ ìµœì¢… íŒŒì¼ë§Œ)
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          # ì •í™•í•˜ê²Œ ì¶”ì¶œëœ ìµœì¢… JAR íŒŒì¼ ê²½ë¡œë§Œ ì‚¬ìš©
          path: ${{ steps.jar_file.outputs.jar_path }}
          retention-days: 7 

# 4. ë°°í¬ ì‘ì—… (CD Place Holder)
  deploy:
    name: Deployment Stage (CD)
    runs-on: ubuntu-latest
    needs: build_and_test # CI Jobì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    
    steps:
      - name: 1. Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-deployable-jar
          path: ./downloaded-artifact

      - name: 2. Deployment Placeholder (ë°°í¬ ì‹¤í–‰)
        run: |
          echo "---------------------------------------------------------"
          echo "CI ì„±ê³µ! ì´ì œ ë‹¤ìŒ ë‹¨ê³„ì¸ ì„œë²„ ë°°í¬(CD)ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
          echo "ë‹¤ìš´ë¡œë“œëœ JAR íŒŒì¼ì€ './downloaded-artifact'ì— ìˆìœ¼ë©°, ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          echo "---------------------------------------------------------"
          # ì‹¤ì œ ë°°í¬ ë¡œì§ì„ ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”. (ì˜ˆ: SSHë¥¼ í†µí•œ ì„œë²„ ì ‘ê·¼ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘)
