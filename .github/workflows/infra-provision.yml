name: Comprehensive Infrastructure Provisioning

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/infra-provision.yml'

permissions:
  contents: read

jobs:
  provision:
    name: Provision infrastructure components
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create permissions artifact via echo
        run: |
          mkdir -p artifacts
          echo "Temporary workflow permissions file" | tee artifacts/permissions.txt
          ls -l artifacts

      - name: Update and upgrade server packages
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y

      - name: Install required tooling
        run: |
          sudo apt-get install -y docker.io genisoimage ufw curl
          sudo systemctl start docker
          docker --version
          genisoimage --version
          ufw --version

      - name: Build sample container image
        run: |
          cat <<'DOCKERFILE' > Dockerfile.workflow
          FROM alpine:3.19
          RUN adduser -D workflow
          USER workflow
          CMD ["/bin/sh", "-c", "echo container ready"]
          DOCKERFILE
          docker build -t workflow/sample:latest -f Dockerfile.workflow .
          docker images workflow/sample:latest

      - name: Run container from built image
        run: |
          docker run --rm workflow/sample:latest

      - name: Package ISO from artifacts
        run: |
          mkdir -p iso-src
          cp artifacts/permissions.txt iso-src/
          genisoimage -quiet -o workflow-artifacts.iso iso-src
          ls -l workflow-artifacts.iso

      - name: Download official resource via curl
        run: |
          curl -L https://www.example.com -o official-resource.html
          head -n 5 official-resource.html

      - name: Configure firewall (ufw)
        run: |
          sudo ufw --force reset
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow 22
          sudo ufw --force enable
          sudo ufw status verbose

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: workflow-provisioning-artifacts
          path: |
            artifacts/permissions.txt
            workflow-artifacts.iso
            official-resource.html
            Dockerfile.workflow
            iso-src
