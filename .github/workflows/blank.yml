name: "🚀 CI — Safe Node (≤10 inputs, no-skip)"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        options: [full, lite]
        default: full
      node_version:
        default: "20"
      workdir:
        default: "."
      run_tests:
        type: boolean
        default: true
      boot_if_missing:
        type: boolean
        default: true
      install_cmd:
        default: "auto"

permissions:
  contents: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      CI_WORKDIR: ${{ github.event.inputs.workdir || '.' }}
      CI_NODE_VERSION: ${{ github.event.inputs.node_version || '20' }}
      CI_RUN_TESTS: ${{ github.event.inputs.run_tests || 'true' }}
      CI_BOOT_IF_MISSING: ${{ github.event.inputs.boot_if_missing || 'true' }}
      CI_INSTALL_CMD: ${{ github.event.inputs.install_cmd || 'auto' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}"

      - name: Install jq (for script checks)
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Detect Node project & lockfile
        id: detect
        shell: bash
        run: |
          set -Eeuo pipefail
          cd "${{ env.CI_WORKDIR }}"
          HAS_PKGJSON="false"
          HAS_LOCK="false"
          [[ -f package.json ]] && HAS_PKGJSON="true"
          [[ -f package-lock.json || -f npm-shrinkwrap.json ]] && HAS_LOCK="true"
          echo "has_pkgjson=${HAS_PKGJSON}" >> "$GITHUB_OUTPUT"
          echo "has_lock=${HAS_LOCK}" >> "$GITHUB_OUTPUT"

      - name: Bootstrap minimal package.json (optional)
        if: ${{ steps.detect.outputs.has_pkgjson != 'true' && env.CI_BOOT_IF_MISSING == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          cd "${{ env.CI_WORKDIR }}"
          echo '⚠️ No package.json found — creating a minimal one (bootstrap).'
          cat > package.json <<'JSON'
          {
            "name": "koreakimtest",
            "version": "0.1.0",
            "private": true,
            "scripts": {
              "lint": "echo no-lint && exit 0",
              "test": "node -e \"console.log('ok')\""
            }
          }
          JSON

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.CI_NODE_VERSION }}

      - name: Enable npm cache (when lockfile exists or bootstrapped)
        if: ${{ steps.detect.outputs.has_lock == 'true' || env.CI_BOOT_IF_MISSING == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.CI_NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            ${{ env.CI_WORKDIR }}/package-lock.json
            ${{ env.CI_WORKDIR }}/npm-shrinkwrap.json

      - name: "Install deps (auto: ci if lock, else install)"
        shell: bash
        run: |
          set -Eeuo pipefail
          cd "${{ env.CI_WORKDIR }}"

          if [[ ! -f package.json ]]; then
            echo "ℹ️ package.json absent and boot_if_missing=false → skipping install."
            exit 0
          fi

          # custom install command
          if [[ "${{ env.CI_INSTALL_CMD }}" != "auto" && -n "${{ env.CI_INSTALL_CMD }}" ]]; then
            echo "▶ Running custom install: ${{ env.CI_INSTALL_CMD }}"
            bash -lc "${{ env.CI_INSTALL_CMD }}" | tee "$GITHUB_WORKSPACE/${LOG_DIR}/install.log"
            exit 0
          fi

          if [[ -f package-lock.json || -f npm-shrinkwrap.json ]]; then
            echo "▶ npm ci (lockfile detected)"
            npm ci 2>&1 | tee "$GITHUB_WORKSPACE/${LOG_DIR}/npm-ci.log"
          else
            echo "▶ npm install (no lockfile)"
            npm install 2>&1 | tee "$GITHUB_WORKSPACE/${LOG_DIR}/npm-install.log"
          fi

      - name: Lint (best-effort)
        shell: bash
        run: |
          set +e
          cd "${{ env.CI_WORKDIR }}"
          if [[ -f package.json ]] && jq -e '.scripts.lint' package.json >/dev/null 2>&1; then
            npm run lint 2>&1 | tee "$GITHUB_WORKSPACE/${LOG_DIR}/lint.log" || true
          else
            echo "no lint script" | tee "$GITHUB_WORKSPACE/${LOG_DIR}/lint.log"
          fi

      - name: Test (best-effort, toggle by input)
        if: ${{ env.CI_RUN_TESTS == 'true' }}
        shell: bash
        run: |
          set +e
          cd "${{ env.CI_WORKDIR }}"
          if [[ -f package.json ]] && jq -e '.scripts.test' package.json >/dev/null 2>&1; then
            npm test --if-present 2>&1 | tee "$GITHUB_WORKSPACE/${LOG_DIR}/test.log" || true
          else
            echo "no test script" | tee "$GITHUB_WORKSPACE/${LOG_DIR}/test.log"
          fi

      - name: Show tree
        shell: bash
        run: |
          set -Eeuo pipefail
          ls -al
          echo "--- workdir ---"
          (cd "${{ env.CI_WORKDIR }}"; ls -al)

      - name: Upload logs/artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            ${{ env.LOG_DIR }}
            ${{ env.CI_WORKDIR }}/package.json
            ${{ env.CI_WORKDIR }}/package-lock.json
          retention-days: 7
