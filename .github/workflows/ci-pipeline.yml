# .github/workflows/ci-pipeline.yml

name: â˜• Java & ğŸ Python & ğŸ˜ DB Workflow

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê¸°ëŠ¥

jobs:
  # ========================================
  # â˜• 1. Java ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‘ì—…
  # ========================================
  java-build-and-test:
    runs-on: ubuntu-latest

    # ----------------------------------------
    # ğŸ˜ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± (ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ)
    # ----------------------------------------
    # 'services' ë¸”ë¡ì€ ì‘ì—…ì´ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ì„ì‹œ DB ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    services:
      postgres:
        image: postgres:14 # PostgreSQL 14 ë²„ì „ ì´ë¯¸ì§€ ì‚¬ìš©
        env:
          POSTGRES_USER: db_user
          POSTGRES_PASSWORD: db_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432 # í˜¸ìŠ¤íŠ¸ì˜ 5432 í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆì˜ 5432 í¬íŠ¸ì™€ ë§¤í•‘
        # ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” í—¬ìŠ¤ ì²´í¬ ì˜µì…˜
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 2. JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: 3. Java ì¢…ì†ì„± ìºì‹œ (Maven)
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 4. Java ì¢…ì†ì„± ì„¤ì¹˜ ë° ë¹Œë“œ (Maven)
        run: mvn clean install
        # 'mvn install'ì€ pom.xmlì„ ì½ì–´ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬(ì¢…ì†ì„±)ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì½”ë“œë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.

      - name: 5. Java í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (DB ì—°ê²°)
        run: mvn test
        env:
          # ì„œë¹„ìŠ¤ DBì— ì—°ê²°í•˜ê¸° ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          # (ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ application.properties/yml ë“±ì—ì„œ ì´ ë³€ìˆ˜ë“¤ì„ ì‚¬ìš©í•´ì•¼ í•¨)
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/test_db
          SPRING_DATASOURCE_USERNAME: db_user
          SPRING_DATASOURCE_PASSWORD: db_password

  # ========================================
  # ğŸ 2. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‘ì—…
  # ========================================
  python-script:
    runs-on: ubuntu-latest
    needs: java-build-and-test # Java ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ (ì„ íƒ ì‚¬í•­)

    # ----------------------------------------
    # ğŸ˜ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± (ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ)
    # ----------------------------------------
    # Python ì‘ì—…ë„ ë³„ë„ì˜ DB ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: db_user
          POSTGRES_PASSWORD: db_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 2. Python 3.10 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # pip ì¢…ì†ì„± ìºì‹œ

      - name: 3. Python ì¢…ì†ì„± ì„¤ì¹˜ (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # 'requirements.txt' íŒŒì¼ì— ëª…ì‹œëœ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

      - name: 4. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŠ” ë°ì´í„° ì‘ì—…)
        run: python src/my_script.py
        env:
          # Python ìŠ¤í¬ë¦½íŠ¸ê°€ DBì— ì—°ê²°í•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: db_user
          DB_PASSWORD: db_password
