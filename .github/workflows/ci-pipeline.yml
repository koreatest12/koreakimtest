# .github/workflows/ci-cd-pipeline.yml

name: ğŸ³ Java & Python CI/CD (Build, Test, Containerize)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ==================================================
  # â˜• 1. Java: ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì»¨í…Œì´ë„ˆ ìƒì„±
  # ==================================================
  java-build-test-and-containerize:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: db_user
          POSTGRES_PASSWORD: db_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 1-1. (ë””ë²„ê¹…) Java ì‘ì—… íŒŒì¼ ëª©ë¡ í™•ì¸
        run: |
          echo "--- Java Job: í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd) ---"
          echo "--- â€¼ï¸ ì—¬ê¸°ì„œ Javaìš© Dockerfileì˜ ì‹¤ì œ ê²½ë¡œì™€ íŒŒì¼ëª…ì„ í™•ì¸í•˜ì„¸ìš” â€¼ï¸ ---"
          ls -R
          echo "--------------------------------"

      - name: 2. JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: 3. Maven ì¢…ì†ì„± ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 4. Java ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
        run: mvn clean package

      - name: 5. Java í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (DB ì—°ê²°)
        run: mvn test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/test_db
          SPRING_DATASOURCE_USERNAME: db_user
          SPRING_DATASOURCE_PASSWORD: db_password

      - name: 6. Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: 7. Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-java
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/java-app
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: 8. GitHub Container Registry(GHCR) ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 9. Docker ë¹Œë“œ ë° í‘¸ì‹œ (Java)
        uses: docker/build-push-action@v5
        with:
          context: .
          # â€¼ï¸ [1ë²ˆ ìˆ˜ì • ì§€ì ] â€¼ï¸
          # '1-1. (ë””ë²„ê¹…)' ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ ë³´ê³  ì‹¤ì œ Dockerfile ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
          # ì˜ˆ: íŒŒì¼ëª…ì´ ê·¸ëƒ¥ 'Dockerfile'ì´ë¼ë©´ -> file: ./Dockerfile
          # ì˜ˆ: íŒŒì¼ì´ 'java-app/Dockerfile'ì— ìˆë‹¤ë©´ -> file: ./java-app/Dockerfile
          file: ./Dockerfile.java 
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-java.outputs.tags }}
          labels: ${{ steps.meta-java.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================================================
  # ğŸ 2. Python: í…ŒìŠ¤íŠ¸, ì»¨í…Œì´ë„ˆ ìƒì„±
  # ==================================================
  python-test-and-containerize:
    runs-on: ubuntu-latest
    needs: java-build-test-and-containerize

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: db_user
          POSTGRES_PASSWORD: db_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 1-1. (ë””ë²„ê¹…) Python ì‘ì—… íŒŒì¼ ëª©ë¡ í™•ì¸
        run: |
          echo "--- Python Job: í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd) ---"
          echo "--- â€¼ï¸ ì—¬ê¸°ì„œ Python ìŠ¤í¬ë¦½íŠ¸ì™€ Dockerfileì˜ ì‹¤ì œ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš” â€¼ï¸ ---"
          ls -R
          echo "--------------------------------"

      - name: 2. Python 3.10 ì„¤ì • (pip + ìºì‹œ)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: 3. Python ì¢…ì†ì„± ì„¤ì¹˜ (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Python ìŠ¤í¬ë¦½íŠ¸/í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (DB ì‘ì—…)
        # â€¼ï¸ [2ë²ˆ ìˆ˜ì • ì§€ì ] â€¼ï¸
        # '1-1. (ë””ë²„ê¹…)' ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ ë³´ê³  ì‹¤ì œ Python ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
        # ì˜ˆ: python main.py
        # ì˜ˆ: python my_app/run_script.py
        run: python src/my_script.py 
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USER: db_user
          DB_PASSWORD: db_password
      
      # â€¼ï¸ [3ë²ˆ ìˆ˜ì • ì§€ì ] â€¼ï¸
      # ë§Œì•½ requirements.txt íŒŒì¼ì´ ë£¨íŠ¸ì— ì—†ìœ¼ë©´ ì´ ê²½ë¡œë„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: 5. requirements.txt ê²½ë¡œ í™•ì¸ (ì˜ˆì‹œ)
        run: echo "Checking for requirements.txt at root" && ls requirements.txt

      - name: 6. Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: 7. Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-python
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/python-app
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: 8. GitHub Container Registry(GHCR) ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 9. Docker ë¹Œë“œ ë° í‘¸ì‹œ (Python)
        uses: docker/build-push-action@v5
        with:
          context: .
          # â€¼ï¸ [4ë²ˆ ìˆ˜ì • ì§€ì ] â€¼ï¸
          # '1-1. (ë””ë²„ê¹…)' ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ ë³´ê³  ì‹¤ì œ Pythonìš© Dockerfile ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
          # ì˜ˆ: file: ./Dockerfile
          # ì˜ˆ: file: ./python_app/Dockerfile
          file: ./Dockerfile.python 
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-python.outputs.tags }}
          labels: ${{ steps.meta-python.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
