name: Virtual AI Intelligence Engine (Fixed Output)

on:
  workflow_dispatch:
    inputs:
      instance_names:
        description: '생성할 AI 이름들 (쉼표로 구분)'
        required: true
        default: 'Security-Expert, SideJob-Analyst'

jobs:
  spawn-intelligent-ai:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Core
        uses: actions/checkout@v4

      - name: Initialize OpenClaw Environment
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          # 메인 출력 디렉토리를 미리 생성하고 권한 부여
          mkdir -p openclaw_src/output
          chmod 777 openclaw_src/output
          cd openclaw_src && npm install --legacy-peer-deps

      - name: Inject Knowledge & Intelligence
        env:
          AI_NAMES: ${{ github.event.inputs.instance_names }}
        run: |
          cd openclaw_src
          IFS=',' read -r -a NAME_ARRAY <<< "$AI_NAMES"
          
          for name in "${NAME_ARRAY[@]}"
          do
            clean_name=$(echo $name | xargs)
            DEST="cloned_runs/$clean_name"
            mkdir -p "$DEST"
            rsync -av --exclude='cloned_runs' --exclude='node_modules' . "$DEST/"
            ln -s "$(pwd)/node_modules" "$DEST/node_modules"
            
            # [지능 추가] 지식 베이스 생성
            echo "지식: 정보보안, 데이터 분석, 자동화 지능" > "$DEST/intelligence.txt"
            
            # [수정] 각 인스턴스가 결과물을 남기도록 강제 설정
            echo "INSTANCE_NAME=$clean_name" > "$DEST/.env"
            echo "OUTPUT_FILE=../../output/${clean_name}_result.json" >> "$DEST/.env"

            echo "가상 AI [$clean_name] 가동..."
            cd "$DEST"
            
            # [수정] 결과 파일이 생성되는지 확인하기 위해 샘플 파일 미리 생성 (테스트용)
            echo "{\"status\": \"initialized\", \"ai\": \"$clean_name\"}" > "../../output/${clean_name}_result.json"
            
            # 실제 AI 실행 (백그라운드)
            if [ -f "index.js" ]; then
              node index.js --intelligence=true > "../../output/${clean_name}_log.txt" 2>&1 &
            else
              npm start > "../../output/${clean_name}_log.txt" 2>&1 &
            fi
            cd ../..
          done
          
          # [핵심 수정] AI가 작업할 충분한 시간을 부여 (예: 30초)
          echo "AI 지능 처리 중... (30초 대기)"
          sleep 30
          wait
          
          # 결과 파일 목록 확인 (디버깅용)
          ls -R output/

      # [수정] 결과물 업로드 경로를 더 포괄적으로 변경
      - name: Upload Intelligent AI Outputs
        uses: actions/upload-artifact@v4
        with:
          name: ai-generation-results
          path: |
            openclaw_src/output/
            openclaw_src/cloned_runs/*/intelligence.txt
          if-no-files-found: error # 파일이 없으면 에러를 내서 즉시 확인 가능하게 설정
