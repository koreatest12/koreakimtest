name: OpenClaw Mass Generation Engine (Optimized)

on:
  workflow_dispatch:
    inputs:
      gen_count:
        description: '생성할 개수 (Mass Generation Count)'
        required: true
        default: '5'

jobs:
  mass-generate:
    runs-on: ubuntu-latest

    steps:
      # 1. 메인 저장소 체크아웃
      - name: Checkout Main Repository
        uses: actions/checkout@v4

      # 2. OpenClaw 저장소 클론 및 구조 생성
      - name: Clone OpenClaw & Setup Directories
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          mkdir -p openclaw_src/output
          echo "OpenClaw cloned and output directory created."

      # 3. Node.js 환경 설정 (캐시 에러 해결 버전)
      - name: Setup Node.js (v22)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # 캐시 경로를 openclaw_src 내부의 lock 파일로 명시적 지정
          cache: 'npm'
          cache-dependency-path: 'openclaw_src/package-lock.json'

      # 4. 의존성 설치 (에러 무시 및 강제 설치 옵션 포함)
      - name: Install Dependencies
        run: |
          cd openclaw_src
          npm install --legacy-peer-deps
          npm audit fix --force || true

      # 5. 대량 생성 및 파일 재실행 로직
      - name: Execute Mass Generation and Rerun
        env:
          GEN_COUNT: ${{ github.event.inputs.gen_count }}
          # 필요 시 여기에 API 키를 추가하세요.
        run: |
          cd openclaw_src
          echo "Starting mass generation process..."
          
          for i in $(seq 1 $GEN_COUNT)
          do
            echo "[Step $i] Generating and executing..."
            
            # 1) AI 생성 실행 (저장소의 기본 실행 명령 사용)
            # 프로젝트의 실제 진입점(예: index.js 또는 main.js)에 맞게 자동 실행
            npm start -- --index=$i --out=output/gen_$i.txt || node index.js --index=$i || echo "Execution failed for item $i"
            
            # 2) 생성된 결과물이나 복제된 파일을 다시 참조하여 실행하는 로직 (예시)
            if [ -f "output/gen_$i.txt" ]; then
              echo "Re-processing generated file $i..."
              # 생성된 파일을 다시 입력값으로 사용하는 추가 로직을 여기에 작성하세요.
            fi
          done

      # 6. 생성된 모든 결과물 및 로그 저장
      - name: Archive All Results
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-mass-gen-results
          path: |
            openclaw_src/output/
            openclaw_src/**/*.log
          if-no-files-found: warn
