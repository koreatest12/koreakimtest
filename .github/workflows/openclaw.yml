name: OpenClaw Mass Copy & Rerun Engine

on:
  workflow_dispatch:
    inputs:
      gen_count:
        description: '반복 실행 횟수 (Mass Count)'
        required: true
        default: '5'

jobs:
  execute-openclaw:
    runs-on: ubuntu-latest

    steps:
      # 1. 기본 저장소 체크아웃
      - name: Checkout Current Repository
        uses: actions/checkout@v4

      # 2. OpenClaw 저장소 복제 (캐시 설정보다 먼저 수행되어야 함)
      - name: Clone OpenClaw Repository
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          mkdir -p openclaw_src/output
          mkdir -p openclaw_src/cloned_runs

      # 3. Node.js 환경 설정 (캐시 없이 먼저 설정하여 경로 에러 방지)
      - name: Setup Node.js (v22)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 4. 의존성 설치 (캐시 경로 문제를 피하기 위해 수동 캐시 사용 또는 직접 설치)
      - name: Install Dependencies
        run: |
          cd openclaw_src
          npm install --legacy-peer-deps
          npm audit fix --force || true

      # 5. [핵심] 파일 복제 및 대량 재실행 로직
      - name: Mass Clone and Rerun
        env:
          GEN_COUNT: ${{ github.event.inputs.gen_count }}
        run: |
          cd openclaw_src
          echo "시작: $GEN_COUNT 개의 인스턴스 복제 및 실행"
          
          for i in $(seq 1 $GEN_COUNT)
          do
            echo "[작업 $i] 기존 파일 복제 중..."
            # 각 실행을 위한 독립적인 디렉토리 생성 (파일 복제 및 분리)
            mkdir -p "cloned_runs/run_$i"
            cp -r ./* "cloned_runs/run_$i" --exclude=cloned_runs
            
            echo "[작업 $i] 복제본 실행..."
            cd "cloned_runs/run_$i"
            
            # 실제 실행 명령어 (프로젝트 구조에 따라 index.js 또는 npm start)
            if [ -f "index.js" ]; then
              node index.js --mode=mass --id=$i > "../../output/log_$i.txt" 2>&1 || echo "Run $i failed"
            else
              npm start -- --id=$i > "../../output/log_$i.txt" 2>&1 || echo "Run $i failed"
            fi
            
            cd ../..
          done

      # 6. 생성된 모든 결과물 저장
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-mass-results
          path: |
            openclaw_src/output/
            openclaw_src/cloned_runs/run_*/output/
          if-no-files-found: warn
