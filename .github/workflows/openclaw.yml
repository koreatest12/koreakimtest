name: Virtual AI Intelligence Engine

on:
  workflow_dispatch:
    inputs:
      instance_names:
        description: '생성할 AI 이름들 (쉼표로 구분)'
        required: true
        default: 'Security-Expert, SideJob-Analyst, Dev-Master'

jobs:
  spawn-intelligent-ai:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Core
        uses: actions/checkout@v4

      - name: Initialize OpenClaw Environment
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          cd openclaw_src && npm install --legacy-peer-deps

      # [지능 주입 단계] 각 가상 AI에게 지식 및 성격 부여
      - name: Inject Knowledge & Intelligence
        env:
          AI_NAMES: ${{ github.event.inputs.instance_names }}
        run: |
          cd openclaw_src
          mkdir -p knowledge_base
          
          # AI 이름 리스트를 배열로 변환
          IFS=',' read -r -a NAME_ARRAY <<< "$AI_NAMES"
          
          for name in "${NAME_ARRAY[@]}"
          do
            clean_name=$(echo $name | xargs) # 공백 제거
            DEST="cloned_runs/$clean_name"
            mkdir -p "$DEST"
            rsync -av --exclude='cloned_runs' --exclude='node_modules' . "$DEST/"
            ln -s "$(pwd)/node_modules" "$DEST/node_modules"
            
            # [지식 데이터 주입] 각 AI마다 다른 전문 지식 텍스트 파일 생성
            case $clean_name in
              "Security-Expert")
                echo "지식: 정보보안기사, 네트워크 보안, 침해사고 분석" > "$DEST/intelligence.txt"
                echo "성격: 분석적이고 철저함" >> "$DEST/intelligence.txt"
                ;;
              "SideJob-Analyst")
                echo "지식: 수익화 파이프라인, 제휴 마케팅, 자동화 부업" > "$DEST/intelligence.txt"
                echo "성격: 창의적이고 효율 중심" >> "$DEST/intelligence.txt"
                ;;
              *)
                echo "지식: 범용 인공지능 지식" > "$DEST/intelligence.txt"
                echo "성격: 친절하고 협력적임" >> "$DEST/intelligence.txt"
                ;;
            esac

            # [지능 로직 반영] 실행 시 지식 파일을 읽도록 설정
            echo "INSTANCE_NAME=$clean_name" > "$DEST/.env"
            echo "KNOWLEDGE_FILE=intelligence.txt" >> "$DEST/.env"

            echo "가상 AI [$clean_name] 지능 주입 완료. 가동 시작..."
            cd "$DEST"
            # 가상 AI 실행 (지식 기반 모드로 실행한다고 가정)
            node index.js --intelligence=true > "../../output/${clean_name}_log.txt" 2>&1 &
            cd ../..
          done
          wait

      - name: Upload Intelligent AI Logs
        uses: actions/upload-artifact@v4
        with:
          name: intelligent-ai-outputs
          path: openclaw_src/output/
