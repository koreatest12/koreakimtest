name: OpenClaw Advanced AI Developer

on:
  workflow_dispatch:
    inputs:
      gen_count:
        description: '동시 실행할 AI 인스턴스 개수'
        required: true
        default: '3'
      ai_model:
        description: '사용할 AI 모델 (gpt-4, claude-3, etc.)'
        required: true
        default: 'gpt-4o'

jobs:
  develop-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          mkdir -p openclaw_src/output
          mkdir -p openclaw_src/cloned_runs

      - name: Install Node.js & Tools
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build Core Engine
        run: |
          cd openclaw_src
          npm install --legacy-peer-deps

      # [추가 개발] 동적 설정값 생성 및 대량 실행
      - name: Dynamic AI Instance Scaling
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL_NAME: ${{ github.event.inputs.ai_model }}
          GEN_COUNT: ${{ github.event.inputs.gen_count }}
        run: |
          cd openclaw_src
          for i in $(seq 1 $GEN_COUNT)
          do
            DEST="cloned_runs/run_$i"
            mkdir -p "$DEST"
            rsync -av --exclude='cloned_runs' --exclude='node_modules' . "$DEST/"
            ln -s "$(pwd)/node_modules" "$DEST/node_modules"
            
            # [기능 추가] 각 인스턴스별 고유 설정 파일(.env) 생성
            echo "INSTANCE_ID=$i" > "$DEST/.env"
            echo "AI_MODEL=$MODEL_NAME" >> "$DEST/.env"
            echo "API_KEY=$OPENAI_API_KEY" >> "$DEST/.env"
            echo "OUTPUT_PATH=../../output/result_$i.json" >> "$DEST/.env"

            echo "[Instance $i] AI 프로그램 가동 중..."
            cd "$DEST"
            # 프로그램의 메인 로직 실행 (실제 파일명에 맞춰 자동 탐색)
            if [ -f "main.js" ]; then
              node main.js > "../../output/log_$i.txt" 2>&1 &
            elif [ -f "index.js" ]; then
              node index.js > "../../output/log_$i.txt" 2>&1 &
            else
              npm start > "../../output/log_$i.txt" 2>&1 &
            fi
            cd ../..
          done
          
          # 백그라운드 작업 완료 대기
          wait
          echo "모든 AI 인스턴스의 작업이 완료되었습니다."

      - name: Archive AI Generated Assets
        uses: actions/upload-artifact@v4
        with:
          name: ai-generation-final-outputs
          path: openclaw_src/output/
