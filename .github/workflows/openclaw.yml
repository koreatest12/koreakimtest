name: OpenClaw Mass Copy & Rerun Engine (Fixed)

on:
  workflow_dispatch:
    inputs:
      gen_count:
        description: '반복 실행 횟수 (Mass Count)'
        required: true
        default: '5'

jobs:
  execute-openclaw:
    runs-on: ubuntu-latest

    steps:
      # 1. 기본 저장소 체크아웃
      - name: Checkout Current Repository
        uses: actions/checkout@v4

      # 2. OpenClaw 저장소 복제
      - name: Clone OpenClaw Repository
        run: |
          git clone --recursive https://github.com/koreatest12/openclaw.git openclaw_src
          mkdir -p openclaw_src/output
          mkdir -p openclaw_src/cloned_runs

      # 3. Node.js 환경 설정 (v22)
      - name: Setup Node.js (v22)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 4. 의존성 설치
      - name: Install Dependencies
        run: |
          cd openclaw_src
          npm install --legacy-peer-deps

      # 5. [수정됨] rsync를 이용한 안전한 대량 복제 및 실행
      - name: Mass Clone and Rerun
        env:
          GEN_COUNT: ${{ github.event.inputs.gen_count }}
        run: |
          cd openclaw_src
          echo "시작: $GEN_COUNT 개의 인스턴스 복제 및 실행"
          
          # rsync가 설치되어 있는지 확인 (기본적으로 Ubuntu runner에 설치되어 있음)
          for i in $(seq 1 $GEN_COUNT)
          do
            echo "[작업 $i] 인스턴스 생성 중..."
            DEST="cloned_runs/run_$i"
            mkdir -p "$DEST"
            
            # cp --exclude 대신 rsync를 사용하여 무한 복제 방지 및 안전한 복사
            rsync -av --exclude='cloned_runs' --exclude='node_modules' . "$DEST/"
            
            echo "[작업 $i] 의존성 링크 및 실행..."
            # 용량 절약을 위해 node_modules는 심볼릭 링크로 연결 (속도 향상)
            ln -s "$(pwd)/node_modules" "$DEST/node_modules"
            
            cd "$DEST"
            
            # 실제 실행 (로그를 상위 output 폴더로 집계)
            if [ -f "index.js" ]; then
              node index.js --id=$i > "../../output/log_$i.txt" 2>&1 || echo "Run $i failed"
            else
              npm start -- --id=$i > "../../output/log_$i.txt" 2>&1 || echo "Run $i failed"
            fi
            
            cd ../..
          done

      # 6. 생성된 모든 결과물 저장
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-mass-results
          path: |
            openclaw_src/output/
            openclaw_src/cloned_runs/run_*/output/
          if-no-files-found: warn
