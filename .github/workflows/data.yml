name: "ğŸ¦ Teradata FinOps Batch â€” EchoOps + Audit + Snapshot + ISO + DR(1d) + DBA (EchoCall)"

on:
  push:
    branches: [ "main" ]
  # ìˆ˜ë™ ì‹¤í–‰ (â‰¤10 inputs)
  workflow_dispatch:
    inputs:
      mode:                  # 1
        description: "ì‹¤í–‰ ëª¨ë“œ (full / lite)"
        type: choice
        options: [full, lite]
        default: full
      gen_rows:              # 2
        description: "ê°€ìƒ ë°ì´í„° í–‰ ìˆ˜ (ë¹ˆê°’=ENV GEN_ROWS)"
        required: false
        default: ""
      expected_rows:         # 3
        description: "í’ˆì§ˆê²€ì¦ ê¸°ëŒ€ ë¡œìš° ìˆ˜ (ë¹ˆê°’=ENV EXPECTED_ROWCOUNT)"
        required: false
        default: ""
      dr_backup:             # 4
        description: "DR(ì™¸ë¶€) ë°±ì—… ì‹œë„ ì—¬ë¶€"
        type: choice
        options: ["true", "false"]
        default: "false"
      include_masking_audit: # 5
        description: "ë§ˆìŠ¤í‚¹ ì •ì±… ê°ì‚¬ ë¡œê·¸ í¬í•¨"
        type: choice
        options: ["true", "false"]
        default: "true"
      include_healthcheck:   # 6
        description: "í—¬ìŠ¤/ë³´ì•ˆ ì ê²€ í¬í•¨"
        type: choice
        options: ["true", "false"]
        default: "true"
      include_schema_diff:   # 7
        description: "DDL/TPT ìŠ¤í‚¤ë§ˆ ë³€ê²½ diff ê¸°ë¡"
        type: choice
        options: ["true", "false"]
        default: "true"
      sla_tracking:          # 8
        description: "SLA ì‹œê°„ ì¸¡ì •/ì¬ì‹œë„ ê¸°ë¡"
        type: choice
        options: ["true", "false"]
        default: "true"

  # ë§¤ì¼ 15:30 UTC == KST 00:30
  schedule:
    - cron: "30 15 * * *"

permissions:
  contents: write    # ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œ/íƒœê·¸

env:
  # ê³µí†µ ë””ë ‰í† ë¦¬
  DATA_ROOT: /home/runner/td_data
  LOG_DIR: /home/runner/td_data/logs
  ARTIFACT_DIR: /home/runner/td_data/release

  # í…Œì´ë¸”
  TBL_STAGE: STG_DATA
  TBL_FINAL: FINAL_DATA
  TBL_AUDIT: LOAD_AUDIT_LOG
  TARGET_TABLE: FINAL_DATA

  # ë°ì´í„°/í’ˆì§ˆ
  GEN_ROWS: "500000"
  EXPECTED_ROWCOUNT: "500000"

  # DR
  DR_RETENTION_DAYS: "1"
  DR_DIR_NAME: "dr_backup"
  DR_TOPOLOGY_DIR: "governance/dr_site"

jobs:
  teradata_pipeline_job:
    name: "Teradata FinOps EchoOps"
    runs-on: ubuntu-latest

    steps:
      #######################################################################
      # 0) ì²´í¬ì•„ì›ƒ + EchoHelpers ì„¤ì¹˜ (ì „ ë‹¨ê³„ ê³µí†µ ì‚¬ìš©)
      #######################################################################
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ§° EchoHelpers ì„¤ì¹˜ (EchoCall / safe_run / writeln)"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          cat > /tmp/echo_helpers.sh <<'EOSH'
          #!/usr/bin/env bash
          set -Eeuo pipefail

          ECHO_OK="âœ…"; ECHO_WARN="âš ï¸"; ECHO_FAIL="âŒ"; ECHO_RUN="â–¶"; ECHO_STEP="ğŸ”¸"

          ts(){ date '+%Y-%m-%d %H:%M:%S%z'; }
          echoinit(){
            echo "${ECHO_STEP} [INIT] $(ts) $*"
          }
          echolog(){
            # usage: echolog "label" "message"
            local label="${1:-LOG}"; shift || true
            echo "${ECHO_STEP} [$label] $(ts) $*"
          }
          # ec: EchoCall â€” ë‹¨ì¼ ëª…ë ¹ ì‹¤í–‰ ë˜í¼
          ec(){
            # usage: ec "LABEL" CMD...
            local label="$1"; shift
            echo "${ECHO_RUN} [$label] $(ts) :: START"
            if "$@" 2>&1 | tee -a "${LOG_DIR}/${label}.log" ; then
              echo "${ECHO_OK} [$label] $(ts) :: OK"
              return 0
            else
              local rc=$?
              echo "${ECHO_FAIL} [$label] $(ts) :: FAIL rc=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return $rc
            fi
          }
          # safe_run: ì‹¤íŒ¨í•´ë„ ê³„ì†
          safe_run(){
            local label="$1"; shift || true
            echo "${ECHO_RUN} [$label] $(ts) :: START (safe)"
            if "$@" 2>&1 | tee -a "${LOG_DIR}/${label}.log" ; then
              echo "${ECHO_OK} [$label] $(ts) :: OK(safe)"
              return 0
            else
              local rc=$?
              echo "${ECHO_WARN} [$label] $(ts) :: CONTINUE rc=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return 0
            fi
          }
          # writeln: íŒŒì¼ì— ì•ˆì „íˆ append
          writeln(){
            # usage: writeln FILE "text..."
            local f="$1"; shift
            mkdir -p "$(dirname "$f")"
            printf "%s\n" "$*" >> "$f"
          }
          # writefile: íŒŒì¼ ìƒì„±(ë®ì–´ì“°ê¸°)
          writefile(){
            local f="$1"; shift
            mkdir -p "$(dirname "$f")"
            printf "%s\n" "$*" > "$f"
          }
          # try_install: apt-get ì„¤ì¹˜ (ì—ëŸ¬ ë¬´ì‹œ)
          try_install(){
            # usage: try_install pkga pskb ...
            sudo apt-get update -y || true
            sudo apt-get install -y "$@" || true
          }
          EOSH
          chmod +x /tmp/echo_helpers.sh
          source /tmp/echo_helpers.sh
          echoinit "Echo helpers ready"; echo

      #######################################################################
      # 0.1) SLA íƒ€ì´ë¨¸ ì‹œì‘
      #######################################################################
      - name: "â± SLA ì‹œì‘"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          writefile "${LOG_DIR}/start_epoch.txt" "$(date +%s)"
          writefile "${LOG_DIR}/sla_timing.log" "SLA_START_TS=$(date +%Y-%m-%dT%H:%M:%S%z)"

      #######################################################################
      # 1) ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
      #######################################################################
      - name: "ğŸ“‚ ë””ë ‰í† ë¦¬ ìƒì„±"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          ec "dirs.create" bash -lc 'mkdir -p "${DATA_ROOT}"/{source_files,landing_zone,logs,archive,extract_out,tmp,quality,release,history,governance,health,"${DR_DIR_NAME}","${DR_TOPOLOGY_DIR}"}'
          writefile "${LOG_DIR}/retention_policy.log" "[RETENTION] FINAL_DATA masked/indef; STG_DATA 30d; AUDIT_LOG 365d; DR keep ${DR_RETENTION_DAYS}d"

      #######################################################################
      # 2) ê°€ìƒ ë°ì´í„° ìƒì„± (ê¸°ë³¸ 50ë§Œí–‰)
      #######################################################################
      - name: "ğŸ— ë°ì´í„° ìƒì„± (ê°€ìƒ ëŒ€ëŸ‰)"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          set -Eeuo pipefail
          ROWS_IN="${{ github.event.inputs.gen_rows || '' }}"
          ROWS="${ROWS_IN:-${GEN_ROWS}}"
          SRC="${DATA_ROOT}/landing_zone/input_$(date +%Y%m%d).csv"
          writefile "${DATA_ROOT}/tmp/generated_rowcount.txt" "${ROWS}"
          writefile "${SRC}" "COL1,COL2,AMOUNT,LOAD_TS"
          # ë¹ ë¥¸ ìƒì„±ê¸° (GNU seq + awk)
          ec "data.generate" bash -lc '
            seq 1 '"${ROWS}"' | awk -v now="$(date +%Y-%m-%dT%H:%M:%S%z)" '\''{
              amt=int(100+rand()*999900);
              m=int(1000+rand()*9000);
              note=(amt>900000)? sprintf("MERCHANT_%d_FLAG-HIGH_%d",m,$1) : sprintf("MERCHANT_%d_NOTE_%d",m,$1);
              printf("%d,%s,%d,%s\n",$1,note,amt,now);
            }'\'' >> "'"${SRC}"'"
          '
          ec "data.preview" bash -lc "sed -n '1,5p' '${SRC}' && tail -n 5 '${SRC}' && ls -lh '${SRC}'"

      #######################################################################
      # 3) í™˜ê²½ ìŠ¤ëƒ…ìƒ· & í—¬ìŠ¤ì²´í¬(ì˜µì…˜)
      #######################################################################
      - name: "ğŸ” í™˜ê²½ ìŠ¤ëƒ…ìƒ·"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          SNAP="${LOG_DIR}/env_snapshot.txt"
          writefile "$SNAP" "===== $(date) ====="
          safe_run "env.uname" uname -a
          safe_run "env.df" bash -lc "df -h | tee -a '$SNAP'"
          safe_run "env.free" bash -lc "free -m | tee -a '$SNAP'"
          safe_run "env.ctx" bash -lc "env | sort | tee -a '$SNAP'"

      - name: "ğŸ©º í—¬ìŠ¤/ë³´ì•ˆ ì ê²€"
        if: ${{ github.event.inputs.include_healthcheck != 'false' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          safe_run "health.dmesg" bash -lc "dmesg | tail -n 50"
          safe_run "health.sockets" bash -lc "ss -tuna | head -n 20"
          safe_run "health.top" bash -lc "top -b -n1 | head -n 20"
          safe_run "health.curl" bash -lc "curl -I https://example.com | head -n 5 || true"

      #######################################################################
      # 4) DDL/TPT/SQL ì •ì˜ ë°±ì—… + ìŠ¤í‚¤ë§ˆ diff(ì˜µì…˜)
      #######################################################################
      - name: "ğŸ§± DDL/TPT/SQL ë°±ì—…"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          mkdir -p "${DATA_ROOT}/source_files/sql" "${DATA_ROOT}/source_files/tpt"
          writefile "${DATA_ROOT}/source_files/sql/create_tables.sql" "-- (ìƒëµ ê°€ëŠ¥) STG_DATA/FINAL_DATA/AUDIT í…Œì´ë¸” ì •ì˜ ìƒ˜í”Œ"
          writefile "${DATA_ROOT}/source_files/sql/proc_LOAD_AND_MERGE.sql" "REPLACE PROCEDURE LOAD_AND_MERGE(...) /* sample */"
          writefile "${DATA_ROOT}/source_files/sql/quality_queries.sql" "-- í’ˆì§ˆ ì¿¼ë¦¬ ìƒ˜í”Œ"
          writefile "${DATA_ROOT}/source_files/tpt/load_stg_data.tpt" "DEFINE JOB LOAD_STG_DATA /* sample */"
          echolog DDL "ìŠ¤í‚¤ë§ˆ ì›ë³¸ ì €ì¥ ì™„ë£Œ"

      - name: "ğŸ§¾ ìŠ¤í‚¤ë§ˆ ë³€ê²½ diff"
        if: ${{ github.event.inputs.include_schema_diff != 'false' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          PREV="${DATA_ROOT}/history/last_create_tables.sql"
          CURR="${DATA_ROOT}/source_files/sql/create_tables.sql"
          DIFF="${LOG_DIR}/schema_diff.log"
          if [ -f "$PREV" ]; then
            diff -u "$PREV" "$CURR" > "$DIFF" || true
          else
            writefile "$DIFF" "[first run/no previous schema]"
          fi
          cp "$CURR" "$PREV"
          safe_run "schema.diff.head" bash -lc "sed -n '1,120p' '$DIFF'"

      #######################################################################
      # 5) ë°ì´í„° ì ì¬ & ë³‘í•© (ì‹œë®¬) + DBA/í’ˆì§ˆ/ê±°ë²„ë„ŒìŠ¤
      #######################################################################
      - name: "ğŸ”„ Load & Merge (ì‹œë®¬)"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          BATCH_ID="BATCH_$(date +%Y%m%d_%H%M%S)"
          writefile "${LOG_DIR}/batch_id.txt" "${BATCH_ID}"
          SRC="${DATA_ROOT}/landing_zone/input_$(date +%Y%m%d).csv"
          GEN=$(cat "${DATA_ROOT}/tmp/generated_rowcount.txt" 2>/dev/null || echo "${GEN_ROWS}")
          EXP_IN="${{ github.event.inputs.expected_rows || '' }}"
          EXP="${EXP_IN:-${EXPECTED_ROWCOUNT}}"
          writefile "${LOG_DIR}/pipeline_status.log" "STATUS_CODE=0
          STATUS_MSG=OK(vdata)
          BATCH_ID=${BATCH_ID}
          SRC_FILE=${SRC}
          ROW_EXPECTED=${EXP}
          ROW_LOADED=${GEN}"
          echolog LOAD "ì‹œë®¬: ${GEN}í–‰ STG ë¡œë“œ â†’ PROC MERGE â†’ ê°ì‚¬ê¸°ë¡"

      - name: "ğŸ§  DBA ë¶„ì„ ë¡œê·¸"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          BID="$(cat "${LOG_DIR}/batch_id.txt" 2>/dev/null || echo UNKNOWN)"
          writefile "${LOG_DIR}/partition_access.log" "Today partition accessed; SRC_BATCH=${BID} (simulated)"
          writefile "${LOG_DIR}/lock_contention.log" "No blocking detected (simulated)"
          writefile "${LOG_DIR}/query_plan_sample.log" "Plan: partitioned access on SRC_BATCH (simulated)"
          writefile "${LOG_DIR}/tuning_recommendations.log" "Add SI (SRC_BATCH, LOAD_TS) for dashboards (simulated)"

      - name: "âœ… í’ˆì§ˆ ê²€ì¦"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          STATUS="${LOG_DIR}/pipeline_status.log"
          EXP="$(grep '^ROW_EXPECTED=' "$STATUS" | cut -d= -f2 || true)"
          ACT="$(grep '^ROW_LOADED=' "$STATUS"   | cut -d= -f2 || true)"
          [ -z "$EXP" ] && EXP="${EXPECTED_ROWCOUNT}"
          [ -z "$ACT" ] && ACT="0"
          HIGH=$(grep -c 'FLAG-HIGH' "${DATA_ROOT}/landing_zone"/input_*.csv || echo 0)
          if [ "$ACT" -gt 0 ]; then HIGH_RATIO=$(( HIGH*100/ACT )); else HIGH_RATIO=0; fi
          writefile "${DATA_ROOT}/quality/quality_check.log" "EXPECTED_ROWCOUNT=${EXP}
          ACTUAL_ROWCOUNT=${ACT}
          HIGH_RATIO_PERCENT=${HIGH_RATIO}"
          safe_run "quality.head" bash -lc "sed -n '1,80p' '${DATA_ROOT}/quality/quality_check.log'"

      - name: "ğŸ›¡ ë§ˆìŠ¤í‚¹ ì •ì±… ê°ì‚¬(ì˜µì…˜)"
        if: ${{ github.event.inputs.include_masking_audit != 'false' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          writefile "${LOG_DIR}/masking_audit.log" "[MASK] FINAL_DATA: ë¯¼ê°í•„ë“œ ë§ˆìŠ¤í‚¹/í† í°í™”, STG 24h ë‚´ ì ‘ê·¼ì°¨ë‹¨ (simulated)"

      - name: "ğŸ” ê¶Œí•œ/ì ‘ê·¼ì œì–´ ê°ì‚¬"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          writefile "${LOG_DIR}/acl_audit.sql" "-- GRANT/REVOKE ìƒ˜í”Œ (ë¬¸ì„œ/ê°ì‚¬ìš©)"

      - name: "ğŸ§® ìœ ì§€ë³´ìˆ˜/ìš©ëŸ‰/DRí”Œë ˆì´ë¶"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          writefile "${LOG_DIR}/stats_maintenance.log" "COLLECT STATS on (COL1,SRC_BATCH,LOAD_TS) (simulated)"
          writefile "${LOG_DIR}/capacity_growth.log" "Track daily MB for STG/FINAL (simulated)"
          writefile "${DATA_ROOT}/governance/recovery_playbook.txt" "RPO 15m / RTO 30m (simulated)"
          writefile "${DATA_ROOT}/${DR_TOPOLOGY_DIR}/dr_topology.txt" "Primary/DR topology & flow (simulated)"
          writefile "${DATA_ROOT}/governance/table_classification.log" "STG:HIGH_RAW / FINAL:MASKED_CONF / AUDIT:OPS_AUDIT"

      #######################################################################
      # 6) Snapshot (tar.gz/ISO) + DR ë³´ê´€(1ì¼ ë¡œí…Œì´ì…˜)
      #######################################################################
      - name: "ğŸ—œ tar.gz ìŠ¤ëƒ…ìƒ·"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          SNAP_TAG="td-snapshot-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:8}"
          SNAP_FILE="${ARTIFACT_DIR}/${SNAP_TAG}.tar.gz"
          writefile "${LOG_DIR}/snapshot_tag.txt" "SNAP_TAG=${SNAP_TAG}
          SNAP_FILE=${SNAP_FILE}"
          mkdir -p "${ARTIFACT_DIR}"
          ec "snapshot.tgz" bash -lc "tar -czf '${SNAP_FILE}' -C '${DATA_ROOT}' logs quality extract_out source_files landing_zone tmp health governance history || true"
          safe_run "snapshot.hash" bash -lc "sha256sum '${SNAP_FILE}' > '${LOG_DIR}/snapshot_hash.txt' || echo failed > '${LOG_DIR}/snapshot_hash.txt'"

      - name: "ğŸ§Š ISO ìŠ¤ëƒ…ìƒ· (ì‹¤íŒ¨ ë¬´ì‹œ)"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          SNAP_TAG="$(grep '^SNAP_TAG=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2)"
          ISO="${ARTIFACT_DIR}/${SNAP_TAG}.iso"
          SRC_DIR="${DATA_ROOT}/tmp/iso_${SNAP_TAG}"
          mkdir -p "${SRC_DIR}"
          safe_run "iso.seed" bash -lc "cp -r '${DATA_ROOT}/logs' '${SRC_DIR}/' && cp -r '${DATA_ROOT}/quality' '${SRC_DIR}/' && cp -r '${DATA_ROOT}/governance' '${SRC_DIR}/' && true"
          safe_run "iso.pkg" bash -lc "sudo apt-get update -y && sudo apt-get install -y genisoimage xorriso"
          if command -v genisoimage >/dev/null 2>&1 ; then
            safe_run "iso.mk1" bash -lc "genisoimage -quiet -J -r -o '${ISO}' '${SRC_DIR}'"
          fi
          if [ ! -s "${ISO}" ] && command -v xorriso >/dev/null 2>&1 ; then
            safe_run "iso.mk2" bash -lc "xorriso -as mkisofs -J -r -o '${ISO}' '${SRC_DIR}'"
          fi
          safe_run "iso.hash" bash -lc "[ -s '${ISO}' ] && sha256sum '${ISO}' > '${LOG_DIR}/iso_hash.txt' || echo 'no-iso' > '${LOG_DIR}/iso_hash.txt'"

      - name: "ğŸŒ DR ë°±ì—… + 1ì¼ ë¡œí…Œì´ì…˜"
        shell: bash
        env:
          DR_KEY: ${{ secrets.DR_BACKUP_KEY }}
        run: |
          source /tmp/echo_helpers.sh
          SNAP_TAG="$(grep '^SNAP_TAG=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2)"
          SNAP_FILE="$(grep '^SNAP_FILE=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2)"
          DR_DATE_DIR="${DATA_ROOT}/${DR_DIR_NAME}/$(date +%Y-%m-%d)"
          mkdir -p "${DR_DATE_DIR}"
          safe_run "dr.copy.tgz" bash -lc "cp -f '${SNAP_FILE}' '${DR_DATE_DIR}/${SNAP_TAG}.tar.gz'"
          if [ -s "${ARTIFACT_DIR}/${SNAP_TAG}.iso" ]; then
            safe_run "dr.copy.iso" bash -lc "cp -f '${ARTIFACT_DIR}/${SNAP_TAG}.iso' '${DR_DATE_DIR}/${SNAP_TAG}.iso'"
          fi
          writefile "${DR_DATE_DIR}/${SNAP_TAG}.meta.txt" "EXTERNAL_UPLOAD_STATUS=$([ -n "${DR_KEY:-}" ] && echo OK || echo SKIP)
          RETENTION_DAYS=${DR_RETENTION_DAYS}
          TS=$(date +%Y-%m-%dT%H:%M:%S%z)"
          # ë¡œí…Œì´ì…˜
          safe_run "dr.rotate" bash -lc "find '${DATA_ROOT}/${DR_DIR_NAME}' -type f -mtime +${DR_RETENTION_DAYS} -print -delete"

      #######################################################################
      # 7) ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œ(ì˜µì…˜) + ê±°ë²„ë„ŒìŠ¤ + HTML ë³´ê³ ì„œ
      #######################################################################
      - name: "ğŸš€ GitHub Release ì—…ë¡œë“œ (ì˜µì…˜)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          SNAP_TAG="$(grep '^SNAP_TAG=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2)"
          SNAP_FILE="$(grep '^SNAP_FILE=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2)"
          ISO="${ARTIFACT_DIR}/${SNAP_TAG}.iso"
          if [ -n "${SNAP_TAG}" ] && [ -s "${SNAP_FILE}" ]; then
            if [ -s "${ISO}" ]; then
              safe_run "release.upload" gh release create "${SNAP_TAG}" "${SNAP_FILE}" "${ISO}" --title "${SNAP_TAG}" --notes "Auto snapshot (tar.gz+iso)"
            else
              safe_run "release.upload" gh release create "${SNAP_TAG}" "${SNAP_FILE}" --title "${SNAP_TAG}" --notes "Auto snapshot (tar.gz)"
            fi
          else
            echolog RELEASE "ìŠ¤ëƒ…ìƒ· ì •ë³´ ì—†ìŒ â€” ë¦´ë¦¬ì¦ˆ ìƒëµ"
          fi

      - name: "ğŸ§‘â€ğŸ’¼ ê±°ë²„ë„ŒìŠ¤/ì˜¨ì½œ ê¸°ë¡"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          writefile "${DATA_ROOT}/governance/governance_approval.log" "APPROVER=COMPLIANCE_TEAM; ONCALL=ETL_OnCall; SLA=KST 06:00"

      - name: "ğŸ–¨ HTML ìš”ì•½ ë¦¬í¬íŠ¸"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          OUT="${ARTIFACT_DIR}/report_${GITHUB_RUN_ID}.html"
          SNAP_TAG="$(grep '^SNAP_TAG=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2 || true)"
          SNAP_FILE="$(grep '^SNAP_FILE=' '${LOG_DIR}/snapshot_tag.txt' | cut -d= -f2 || true)"
          writefile "$OUT" "<html><body><h1>Teradata FinOps Summary</h1><p>tag=${SNAP_TAG}</p><p>tar=${SNAP_FILE}</p></body></html>"
          safe_run "report.head" bash -lc "sed -n '1,60p' '${OUT}'"

      #######################################################################
      # 8) SLA ì¢…ë£Œ + ê°ì‚¬ìš”ì•½ + ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ + ì™„ë£Œ
      #######################################################################
      - name: "â± SLA ì¢…ë£Œ"
        if: ${{ github.event.inputs.sla_tracking != 'false' }}
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          END=$(date +%s)
          START=$(cat "${LOG_DIR}/start_epoch.txt" 2>/dev/null || echo "$END")
          DUR=$((END-START))
          writeln "${LOG_DIR}/sla_timing.log" "SLA_END_TS=$(date +%Y-%m-%dT%H:%M:%S%z)"
          writeln "${LOG_DIR}/sla_timing.log" "SLA_DURATION_SEC=${DUR}"
          echolog SLA "duration=${DUR}s"

      - name: "ğŸ§¾ ê°ì‚¬ ìš”ì•½ ë¡œê·¸"
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          AUD="${LOG_DIR}/audit_run_summary.log"
          writefile "$AUD" "=== PIPELINE AUDIT SUMMARY ===
          TS=$(date +%Y-%m-%dT%H:%M:%S%z)
          REPO=${GITHUB_REPOSITORY}
          ACTOR=${GITHUB_ACTOR}
          SHA=${GITHUB_SHA}"
          safe_run "audit.head" bash -lc "sed -n '1,80p' '${AUD}'"

      - name: "ğŸ“¦ Artifact ì—…ë¡œë“œ"
        uses: actions/upload-artifact@v4
        with:
          name: teradata-run-${{ github.run_id }}
          path: |
            ${{ env.DATA_ROOT }}/logs/**
            ${{ env.DATA_ROOT }}/quality/**
            ${{ env.DATA_ROOT }}/source_files/**
            ${{ env.DATA_ROOT }}/release/**
            ${{ env.DATA_ROOT }}/landing_zone/**
            ${{ env.DATA_ROOT }}/${{ env.DR_DIR_NAME }}/**
            ${{ env.DATA_ROOT }}/${{ env.DR_TOPOLOGY_DIR }}/**
            ${{ env.DATA_ROOT }}/extract_out/**
            ${{ env.DATA_ROOT }}/tmp/**
            ${{ env.DATA_ROOT }}/health/**
            ${{ env.DATA_ROOT }}/governance/**
            ${{ env.DATA_ROOT }}/history/**
          if-no-files-found: warn
          retention-days: 14

      - name: "âœ… íŒŒì´í”„ë¼ì¸ ì™„ë£Œ (í•­ìƒ ì„±ê³µ)"
        if: always()
        shell: bash
        run: |
          source /tmp/echo_helpers.sh
          echolog DONE "ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ â€” EchoOps(EchoCall)ë¡œ í‘œì¤€í™”ëœ ë¡œê·¸ê°€ ì‚°ì¶œë¬¼ì— í¬í•¨ë©ë‹ˆë‹¤."
          exit 0
