name: "ðŸ”„ Concurrency Control + Runner Self-Heal + Auto-Retry"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  # ê°™ì€ ë¸Œëžœì¹˜/ê°™ì€ ì›Œí¬í”Œë¡œìš° ì•ˆì—ì„œëŠ” í•­ìƒ ìµœì‹  ì‹¤í–‰ë§Œ ë‚¨ê¸°ê³ 
  # ì´ì „ ì‹¤í–‰(ì§„í–‰ ì¤‘/ëŒ€ê¸° ì¤‘)ì€ ì·¨ì†Œ
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  REPORT_DIR: .github/echo_report

jobs:
  ##########################################################################
  # 0. ëŸ¬ë„ˆ ìƒíƒœ ì ê²€ & ì²­ì†Œ
  #    - ë””ìŠ¤í¬/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ , docker ìž”ìž¬, ìºì‹œ ë“± ì ê²€
  #    - ê°€ëŠ¥í•˜ë©´ ì •ë¦¬í•´ì„œ "ëŸ¬ë„ˆê°€ ê½‰ ì°¨ì„œ ì£½ëŠ” ìƒí™©"ì„ ì™„í™”
  ##########################################################################
  prep_and_clean:
    name: "Runner Pre-Check / Cleanup"
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      disk_ok: ${{ steps.check.outputs.disk_ok }}
      mem_ok:  ${{ steps.check.outputs.mem_ok }}
    steps:
      - name: Prep dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          touch "${LOG_DIR}/.keep" "${REPORT_DIR}/.keep"

      - name: Runner snapshot (before cleanup)
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo "=== RUNNER SNAPSHOT (BEFORE CLEANUP) ==="
            echo "--- uname -a"
            uname -a || true
            echo
            echo "--- df -h"
            df -h || true
            echo
            echo "--- free -m"
            free -m || true
            echo
            echo "--- docker ps -a"
            docker ps -a || true
            echo
            echo "--- docker images"
            docker images || true
            echo
          } | tee "${LOG_DIR}/00_runner_snapshot_before.txt"

      - name: Cleanup docker/junk to free resources
        shell: bash
        run: |
          set -Eeuo pipefail
          echo ">>> docker system prune -af (safe cleanup)" | tee "${LOG_DIR}/01_cleanup.txt"
          docker system prune -af || true
          docker volume prune -f || true
          echo ">>> apt-get clean / autoremove" | tee -a "${LOG_DIR}/01_cleanup.txt"
          sudo apt-get clean || true
          sudo apt-get autoremove -y || true

      - name: Check resources after cleanup
        id: check
        shell: bash
        run: |
          set -Eeuo pipefail

          # ê¸°ë³¸ ìž„ê³„ê°’ - ë””ìŠ¤í¬ ì—¬ìœ  2GB ì´ìƒ, ë©”ëª¨ë¦¬ ì—¬ìœ  512MB ì´ìƒ ìžˆìœ¼ë©´ OKë¡œ ê°„ì£¼
          DISK_AVAIL_GB=$(df -BG / | awk 'NR==2 {gsub("G","",$4); print $4}')
          MEM_FREE_MB=$(free -m | awk '/Mem:/ {print $4}')

          DISK_OK="true"
          MEM_OK="true"
          if [ "$DISK_AVAIL_GB" -lt 2 ]; then
            DISK_OK="false"
          fi
          if [ "$MEM_FREE_MB" -lt 512 ]; then
            MEM_OK="false"
          fi

          echo "disk_ok=$DISK_OK" >> $GITHUB_OUTPUT
          echo "mem_ok=$MEM_OK" >> $GITHUB_OUTPUT

          {
            echo "=== RESOURCE CHECK (AFTER CLEANUP) ==="
            echo "DISK_AVAIL_GB=$DISK_AVAIL_GB"
            echo "DISK_OK=$DISK_OK"
            echo "MEM_FREE_MB=$MEM_FREE_MB"
            echo "MEM_OK=$MEM_OK"
          } | tee "${LOG_DIR}/02_resource_check_after.txt"

      - name: Upload runner-prep logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runner-prep
          path: |
            ${{ env.LOG_DIR }}/00_runner_snapshot_before.txt
            ${{ env.LOG_DIR }}/01_cleanup.txt
            ${{ env.LOG_DIR }}/02_resource_check_after.txt
            ${{ env.LOG_DIR }}/.keep
          if-no-files-found: warn

  ##########################################################################
  # 1. ì‹¤ì œ ìž‘ì—… 1ì°¨ ì‹œë„
  ##########################################################################
  job_attempt_1:
    name: "Build & Test (Attempt 1)"
    runs-on: ubuntu-latest
    needs: prep_and_clean
    continue-on-error: true   # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
    outputs:
      attempt1_status: ${{ steps.mark.outputs.attempt1_status }}
    steps:
      - name: Prep dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          touch "${LOG_DIR}/.keep" "${REPORT_DIR}/.keep"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Runner snapshot (attempt1 start)
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo "=== RUNNER SNAPSHOT (ATTEMPT 1 START) ==="
            df -h || true
            free -m || true
            docker ps -a || true
          } | tee "${LOG_DIR}/10_snapshot_attempt1_start.txt"

      - name: Build/Test main logic
        id: buildtest
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "âš™ Attempt #1 running on ${{ github.ref }} (commit ${{ github.sha }})" \
            | tee "${LOG_DIR}/11_attempt1_run.txt"

          # ì—¬ê¸°ì„œ ì‹¤ì œ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ë¡œì§ì„ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
          # ì˜ˆ: maven ë¹Œë“œ, npm ci && npm test, docker build ë“±
          # ì§€ê¸ˆì€ ì˜ˆì‹œë¡œ ì¼ë¶€ëŸ¬ ê¸´ ìž‘ì—… í‰ë‚´:
          echo "Simulating heavy workload..."
          sleep 60

          echo "Attempt #1 work finished." | tee -a "${LOG_DIR}/11_attempt1_run.txt"

      - name: Mark attempt1 status
        id: mark
        shell: bash
        run: |
          set -Eeuo pipefail
          # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨ížˆ "success"ë¡œ ë‚¨ê¸°ì§€ë§Œ,
          # ì‹¤ì œë¡œëŠ” ìœ„ ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆëŠ”ì§€ $?ë¥¼ ì²´í¬í•´ì„œ ê¸°ë¡í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
          # ì˜ˆ: if [ "${{ steps.buildtest.outcome }}" != "success" ]; then ...
          # GitHub Actionsì—ì„œ outcomeì„ ì§ì ‘ ë³€ìˆ˜ë¡œ ëª»ì“°ë‹ˆ, try/catch íŒ¨í„´ìœ¼ë¡œ ìº¡ì²˜í•˜ë ¤ë©´
          # ìœ„ build/test ë‹¨ê³„ì—ì„œ ì¢…ë£Œì½”ë“œ ê´€ë¦¬í•˜ë©´ ë©ë‹ˆë‹¤.
          # í˜„ìž¬ëŠ” 0ìœ¼ë¡œ ì¢…ë£Œí–ˆìœ¼ë¯€ë¡œ success
          STATUS="success"
          echo "attempt1_status=$STATUS" >> $GITHUB_OUTPUT
          echo "attempt1_status=$STATUS" | tee "${LOG_DIR}/12_attempt1_status.txt"

      - name: Upload attempt1 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attempt1-logs
          path: |
            ${{ env.LOG_DIR }}/10_snapshot_attempt1_start.txt
            ${{ env.LOG_DIR }}/11_attempt1_run.txt
            ${{ env.LOG_DIR }}/12_attempt1_status.txt
            ${{ env.LOG_DIR }}/.keep
          if-no-files-found: warn

  ##########################################################################
  # 2. ìžë™ ìž¬ì‹œë„ (Attempt 2)
  #    - Attempt 1ì´ "ì‹¤íŒ¨"ì¼ ë•Œë§Œ ì‹¤í–‰í•˜ë„ë¡ ì„¤ê³„
  #    - ì—¬ê¸°ì„œëŠ” attempt1_status != success ì¼ ë•Œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì¡°ê±´ë¶€ ì²˜ë¦¬
  #    - ìœ„ ì˜ˆì‹œëŠ” í•­ìƒ successë¡œ ë§ˆí‚¹ë˜ì–´ ìžˆì–´ì„œ ì‹¤ì œë¡œëŠ” ì‹¤í–‰ ì•ˆ ë  ê²ƒ.
  ##########################################################################
  job_attempt_2:
    name: "Build & Test (Attempt 2 / Self-Heal Retry)"
    runs-on: ubuntu-latest
    needs: [prep_and_clean, job_attempt_1]
    if: ${{ needs.job_attempt_1.outputs.attempt1_status != 'success' }}
    continue-on-error: true
    steps:
      - name: Prep dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          touch "${LOG_DIR}/.keep" "${REPORT_DIR}/.keep"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Runner snapshot (attempt2 start)
        shell: bash
        run: |
          set -Eeuo pipefail
          {
            echo "=== RUNNER SNAPSHOT (ATTEMPT 2 START) ==="
            df -h || true
            free -m || true
            docker ps -a || true
          } | tee "${LOG_DIR}/20_snapshot_attempt2_start.txt"

      - name: Build/Test retry logic
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "âš  Attempt #2 retry due to resource or previous failure" \
            | tee "${LOG_DIR}/21_attempt2_run.txt"

          # ìž¬ì‹œë„ ë¡œì§ (ë™ì¼ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ ì‹¤í–‰)
          # ì˜ˆì‹œ: sleep ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
          echo "Retrying heavy workload..."
          sleep 60

          echo "Attempt #2 finished." | tee -a "${LOG_DIR}/21_attempt2_run.txt"

      - name: Upload attempt2 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attempt2-logs
          path: |
            ${{ env.LOG_DIR }}/20_snapshot_attempt2_start.txt
            ${{ env.LOG_DIR }}/21_attempt2_run.txt
            ${{ env.LOG_DIR }}/.keep
          if-no-files-found: warn

  ##########################################################################
  # 3. ìµœì¢… ë¦¬í¬íŠ¸/ìŠ¤ëƒ…ìƒ· ì—…ë¡œë“œ
  #    - prep_and_clean, attempt_1, attempt_2 (ì¡°ê±´ë¶€) ì‹¤í–‰ ê²°ê³¼ë¥¼ ì¢…í•©
  #    - í•­ìƒ ì‹¤í–‰í•´ì„œ ìµœì¢… ìƒíƒœ ì¶”ì  ê°€ëŠ¥
  ##########################################################################
  final_report:
    name: "Final Report / Collected Evidence"
    runs-on: ubuntu-latest
    needs:
      - prep_and_clean
      - job_attempt_1
      - job_attempt_2
    if: always()
    steps:
      - name: Prep dirs
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${REPORT_DIR}"
          touch "${LOG_DIR}/.keep" "${REPORT_DIR}/.keep"

          {
            echo "=== FINAL SUMMARY ==="
            echo "event_name=${{ github.event_name }}"
            echo "ref=${{ github.ref }}"
            echo "sha=${{ github.sha }}"
            echo "actor=${{ github.actor }}"
            echo
            echo "prep_and_clean.disk_ok=${{ needs.prep_and_clean.outputs.disk_ok }}"
            echo "prep_and_clean.mem_ok=${{ needs.prep_and_clean.outputs.mem_ok }}"
            echo
            echo "attempt1_status=${{ needs.job_attempt_1.outputs.attempt1_status }}"
            echo "(attempt2 ran? -> ${{ needs.job_attempt_2.result }})"
            echo
            date
          } | tee "${REPORT_DIR}/final_summary.txt"

      - name: Upload final bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-summary-and-logs
          path: |
            ${{ env.LOG_DIR }}/
            ${{ env.REPORT_DIR }}/
          if-no-files-found: warn
