name: "ğŸš€ Ultimate Enterprise Maven Pipeline"

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰
  push:
    branches: [ "main" ]

# ê¶Œí•œ ì„¤ì • (Docker íŒ¨í‚¤ì§€, ë³´ì•ˆ ê²°ê³¼, í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì‘ì„± ë“±)
permissions:
  contents: read
  packages: write
  security-events: write
  checks: write

env:
  MAVEN_VERSION: '3.9.6'
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'enterprise-app'
  DOCKER_IMAGE_NAME: 'enterprise-demo'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build, Quality, Doc & Deploy

    steps:
      # ----------------------------------------------------------------
      # 1. ì´ˆê¸° ì„¤ì • ë° ìµœì í™”
      # ----------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ’¾ Cache Maven Packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # ----------------------------------------------------------------
      # 2. Maven ìˆ˜ë™ ì„¤ì¹˜ (ìš”ì²­ ìœ ì§€)
      # ----------------------------------------------------------------
      - name: â¬‡ï¸ Manual Install Apache Maven
        run: |
          if [ ! -d "apache-maven-${MAVEN_VERSION}" ]; then
            wget -q https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
            tar -xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
          fi
          echo "$(pwd)/apache-maven-${MAVEN_VERSION}/bin" >> $GITHUB_PATH
          export PATH="$(pwd)/apache-maven-${MAVEN_VERSION}/bin:$PATH"
          mvn -version

      # ----------------------------------------------------------------
      # 3. ê³ ê¸‰ í”„ë¡œì íŠ¸ íŒŒì¼ ë° êµ¬ì¡° ìƒì„± (ì—…ê·¸ë ˆì´ë“œ)
      # ----------------------------------------------------------------
      - name: ğŸ“‚ Generate Enterprise Project Files
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/company/core
          mkdir -p ${PROJECT_ROOT}/src/test/java/com/company/core
          mkdir -p ${PROJECT_ROOT}/src/main/resources
          mkdir -p ${PROJECT_ROOT}/k8s

          # [ì—…ê·¸ë ˆì´ë“œ] pom.xmlì— ì½”ë“œ í’ˆì§ˆ(SpotBugs) ë° ë¬¸ì„œí™”(Javadoc) í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.company</groupId>
              <artifactId>enterprise-core</artifactId>
              <version>1.0.0</version>
              
              <properties>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              </properties>

              <dependencies>
                  <dependency>
                      <groupId>org.slf4j</groupId>
                      <artifactId>slf4j-api</artifactId>
                      <version>2.0.9</version>
                  </dependency>
                  <dependency>
                      <groupId>ch.qos.logback</groupId>
                      <artifactId>logback-classic</artifactId>
                      <version>1.4.11</version>
                  </dependency>
                  <dependency>
                      <groupId>org.junit.jupiter</groupId>
                      <artifactId>junit-jupiter-api</artifactId>
                      <version>5.10.0</version>
                      <scope>test</scope>
                  </dependency>
                  <dependency>
                      <groupId>org.junit.jupiter</groupId>
                      <artifactId>junit-jupiter-engine</artifactId>
                      <version>5.10.0</version>
                      <scope>test</scope>
                  </dependency>
              </dependencies>

              <build>
                  <plugins>
                      <plugin>
                          <groupId>org.apache.maven.plugins</groupId>
                          <artifactId>maven-surefire-plugin</artifactId>
                          <version>3.1.2</version>
                      </plugin>
                      <plugin>
                          <groupId>org.apache.maven.plugins</groupId>
                          <artifactId>maven-javadoc-plugin</artifactId>
                          <version>3.6.3</version>
                          <executions>
                              <execution>
                                  <id>attach-javadocs</id>
                                  <goals><goal>jar</goal></goals>
                              </execution>
                          </executions>
                      </plugin>
                  </plugins>
              </build>
          </project>
          EOF

          # Java ì†ŒìŠ¤ ìƒì„±
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/company/core/Application.java
          package com.company.core;
          import org.slf4j.Logger;
          import org.slf4j.LoggerFactory;
          
          /**
           * Enterprise Application Entry Point.
           */
          public class Application {
              private static final Logger logger = LoggerFactory.getLogger(Application.class);
              
              public String getStatus() { return "Active"; }
              
              public static void main(String[] args) {
                  logger.info("Starting Enterprise Service...");
                  logger.info("System Status: " + new Application().getStatus());
              }
          }
          EOF

          # í…ŒìŠ¤íŠ¸ ì½”ë“œ ìƒì„±
          cat <<EOF > ${PROJECT_ROOT}/src/test/java/com/company/core/ApplicationTest.java
          package com.company.core;
          import org.junit.jupiter.api.Test;
          import static org.junit.jupiter.api.Assertions.*;
          class ApplicationTest {
              @Test
              void testStatus() {
                  Application app = new Application();
                  assertEquals("Active", app.getStatus());
              }
          }
          EOF

          # Dockerfile ìƒì„±
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM eclipse-temurin:17-jre-alpine
          WORKDIR /app
          COPY target/*.jar app.jar
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF

          # [ì—…ê·¸ë ˆì´ë“œ] Kubernetes Deployment íŒŒì¼ ë™ì  í…œí”Œë¦¿ ìƒì„±
          cat <<EOF > ${PROJECT_ROOT}/k8s/deployment.template.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: enterprise-app
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: enterprise-app
            template:
              metadata:
                labels:
                  app: enterprise-app
              spec:
                containers:
                - name: enterprise-app
                  image: GHCR_IMAGE_PLACEHOLDER
                  ports:
                  - containerPort: 8080
          EOF
          
          echo "âœ… Project files generated successfully."

      # ----------------------------------------------------------------
      # 4. ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ë° ë¬¸ì„œí™” ìˆ˜í–‰
      # ----------------------------------------------------------------
      - name: ğŸ—ï¸ Maven Build & Verify
        working-directory: ${{ env.PROJECT_ROOT }}
        # package ëŒ€ì‹  verifyë¥¼ ì‚¬ìš©í•˜ì—¬ í†µí•© í…ŒìŠ¤íŠ¸ ë° í’ˆì§ˆ ê²€ì‚¬ ìˆ˜í–‰
        run: mvn clean verify -B

      # [ì—…ê·¸ë ˆì´ë“œ] ë¹Œë“œ ê²°ê³¼ë¬¼(JAR) ë° ë¬¸ì„œ(Javadoc)ë¥¼ GitHub ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-artifacts
          path: |
            ${{ env.PROJECT_ROOT }}/target/*.jar
            ${{ env.PROJECT_ROOT }}/target/site/apidocs/
          retention-days: 5

      # ----------------------------------------------------------------
      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë° ë³´ì•ˆ ì ê²€
      # ----------------------------------------------------------------
      - name: ğŸ“Š Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: "${{ env.PROJECT_ROOT }}/target/surefire-reports/*.xml"

      - name: ğŸ›¡ï¸ Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.PROJECT_ROOT }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      # ----------------------------------------------------------------
      # 6. ë©€í‹° ì•„í‚¤í…ì²˜ Docker ë¹Œë“œ & ë°°í¬ (ì—…ê·¸ë ˆì´ë“œ)
      # ----------------------------------------------------------------
      - name: ğŸ³ Set up QEMU (For Multi-Arch)
        uses: docker/setup-qemu-action@v3

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # [ì—…ê·¸ë ˆì´ë“œ] amd64ì™€ arm64(ë§¥ë¶ ë“±)ë¥¼ ë™ì‹œì— ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ ë¹Œë“œ
      - name: ğŸ“¦ Build and Push Multi-Arch Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_ROOT }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      # ----------------------------------------------------------------
      # 7. Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± (ì—…ê·¸ë ˆì´ë“œ)
      # ----------------------------------------------------------------
      # [ì—…ê·¸ë ˆì´ë“œ] ë¹Œë“œëœ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ K8s ì„¤ì • íŒŒì¼ì— ì‹¤ì œ ì£¼ì…
      - name: â˜¸ï¸ Generate Final Kubernetes Manifest
        run: |
          IMAGE_TAG="ghcr.io/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"
          sed "s|GHCR_IMAGE_PLACEHOLDER|$IMAGE_TAG|g" ${PROJECT_ROOT}/k8s/deployment.template.yaml > ${PROJECT_ROOT}/k8s/deployment.final.yaml
          
          echo "âœ… Kubernetes Manifest Generated:"
          cat ${PROJECT_ROOT}/k8s/deployment.final.yaml

      - name: ğŸ“¤ Upload K8s Manifest
        uses: actions/upload-artifact@v4
        with:
          name: k8s-manifests
          path: ${{ env.PROJECT_ROOT }}/k8s/deployment.final.yaml
