name: "ğŸ¦ Financial Enterprise Core: Oracle & Multi-Server Simulation"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  packages: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  RESOURCE_PATH: 'financial-core/src/main/resources'
  ORACLE_HOME: '/opt/oracle/product/19c/dbhome_1'

jobs:
  # 1. ì»´íŒŒì¼ ì„œë²„ ë‹¨ê³„ (CI: Compile & Build)
  compile-server:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Central Compile Server
    outputs:
      artifact-path: ${{ steps.build.outputs.path }}
    steps:
      - name: ğŸ“¥ Checkout Source
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Oracle-Compatible Files
        run: |
          mkdir -p ${RESOURCE_PATH}/sql
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core

          # [pom.xml] Oracle JDBC ë“œë¼ì´ë²„ ì¶”ê°€
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [DatabaseManager.java] Oracle ëª¨ë“œ ì§€ì› ë° ì¬ê¸°ë™ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/DatabaseManager.java
          package com.bank.core;
          import java.sql.*;

          public class DatabaseManager {
              public static Connection getConnection() throws Exception {
                  // Oracle/H2 í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ ë“œë¼ì´ë²„ ë¡œë“œ
                  Class.forName("org.h2.Driver"); 
                  return DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");
              }

              public static void restartOracleServer() {
                  System.out.println("ğŸ”„ [ORACLE-SYS] Initiating Oracle DB Instance Shutdown...");
                  System.out.println("ğŸ”„ [ORACLE-SYS] Clearing Buffer Cache & Redo Logs...");
                  System.out.println("âœ… [ORACLE-SYS] Oracle Database Server Restarted Successfully.");
              }

              public static void initSchema() throws Exception {
                  try (Connection conn = getConnection(); Statement stmt = conn.createStatement()) {
                      stmt.execute("CREATE TABLE FIN_DATA (ID RAW(16) PRIMARY KEY, ACCOUNT_NO VARCHAR2(20), AMOUNT NUMBER, TS TIMESTAMP)");
                  }
              }
          }
          EOF

          # [FinancialSystem.java] ëŒ€ëŸ‰ ë°ì´í„°(10ë§Œê±´) ë°˜ì˜
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  DatabaseManager.restartOracleServer(); // ì„œë²„ ì¬ê¸°ë™ ê¸°ëŠ¥ í˜¸ì¶œ
                  DatabaseManager.initSchema();
                  
                  int total = 100000; // ë°ì´í„° ëŒ€ëŸ‰ ì¦ì„¤ (10ë§Œê±´)
                  int batchSize = 10000;
                  
                  try (Connection conn = DatabaseManager.getConnection()) {
                      conn.setAutoCommit(false);
                      PreparedStatement pstmt = conn.prepareStatement("INSERT INTO FIN_DATA VALUES (?, ?, ?, CURRENT_TIMESTAMP)");
                      
                      long start = System.currentTimeMillis();
                      for (int i = 1; i <= total; i++) {
                          pstmt.setBytes(1, java.nio.ByteBuffer.allocate(16).putLong(UUID.randomUUID().getMostSignificantBits()).putLong(UUID.randomUUID().getLeastSignificantBits()).array());
                          pstmt.setString(2, "ACC-" + (100000 + i));
                          pstmt.setLong(3, (long)(Math.random() * 10000000));
                          pstmt.addBatch();
                          if (i % batchSize == 0) pstmt.executeBatch();
                      }
                      pstmt.executeBatch();
                      conn.commit();
                      System.out.println("ğŸš€ [DATA-LOAD] Oracle Financial Data: " + total + " records injected in " + (System.currentTimeMillis() - start) + "ms");
                  }
              }
          }
          EOF

      - name: ğŸ”¨ Compile & Package
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-core
          path: ${{ env.PROJECT_ROOT }}/target

  # 2. ì‹¤í–‰ ì„œë²„ ë‹¨ê³„ (CD: Deployment & Execution)
  execution-server:
    needs: compile-server
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle Database Execution Server
    steps:
      - name: ğŸ“¥ Download Compiled Artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-core
          path: ./target

      - name: ğŸš€ Run Oracle Simulation & Batch Job
        run: |
          # ì•„í‹°íŒ©íŠ¸ êµ¬ì¡° ì¬êµ¬ì„± ë° ì‹¤í–‰
          java -cp "target/classes:target/dependency/*" com.bank.core.FinancialSystem

      - name: ğŸš€ Sync to Repository
        run: |
          # ì´ ë‹¨ê³„ëŠ” ì†ŒìŠ¤ ë³€ê²½ì‚¬í•­ì„ ë‹¤ì‹œ í‘¸ì‹œí•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê²½ìš° Checkout í›„ ì§„í–‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì•„í‹°íŒ©íŠ¸ ë°°í¬ ìœ„ì£¼ë¡œ ì§„í–‰í•˜ë¯€ë¡œ ì†ŒìŠ¤ ìƒì„± ë¡œê·¸ë§Œ ë‚¨ê¹€
          echo "Oracle Multi-Server Simulation Completed"
