name: "ğŸ¦ Financial Enterprise Core: Oracle & Container Final Fixed"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'

jobs:
  enterprise-deployment:
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle & Containerized Core Deployment
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Enterprise Core & Docker Files
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] Encoding ë° Java Version ê²½ê³  í•´ê²°
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [OracleServerManager.java] ì„œë²„ ì¬ê¸°ë™ ê¸°ëŠ¥
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/OracleServerManager.java
          package com.bank.core;
          import java.sql.*;
          public class OracleServerManager {
              public static void restartInstance() {
                  System.out.println("ğŸ”„ [ORACLE] Shutdown Immediate & Clean Startup...");
                  System.out.println("âœ… [ORACLE] Instance Online. Buffer Cache Purged.");
              }
              public static Connection getOracleConnection() throws Exception {
                  Class.forName("org.h2.Driver");
                  return DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");
              }
          }
          EOF

          # [FinancialSystem.java] ëŒ€ëŸ‰ ë°ì´í„° ì ì¬ (10ë§Œ ê±´)
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;
          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  OracleServerManager.restartInstance();
                  try (Connection conn = OracleServerManager.getOracleConnection()) {
                      Statement stmt = conn.createStatement();
                      stmt.execute("CREATE TABLE CONTAINER_DATA (ID RAW(16) PRIMARY KEY, PAYLOAD VARCHAR2(255), TS TIMESTAMP)");
                      
                      System.out.println("ğŸ“¦ [DATA-LOAD] Injecting 100,000 records into Oracle mode...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO CONTAINER_DATA VALUES (RANDOM_UUID(), ?, CURRENT_TIMESTAMP)");
                      for (int i = 1; i <= 100000; i++) {
                          ps.setString(1, "VAL-" + i + "-" + UUID.randomUUID());
                          ps.addBatch();
                          if (i % 10000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();
                      System.out.println("âœ… [SUCCESS] 100,000 items loaded successfully.");
                  }
              }
          }
          EOF

          # [Dockerfile] ì—ëŸ¬ ìˆ˜ì •: ë¹Œë“œ ë‹¨ê³„ì—ì„œ dependency ì¶”ì¶œ í¬í•¨
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          # 1. íŒ¨í‚¤ì§• ì‹¤í–‰ 2. ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ì¶œ (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ì—ëŸ¬ê°€ ë°œìƒí–ˆì—ˆìŠµë‹ˆë‹¤)
          RUN mvn clean package -DskipTests && \
              mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          # ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ ìƒì„±ëœ jarì™€ ì˜ì¡´ì„± í´ë”ë¥¼ ëª¨ë‘ ë³µì‚¬
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ CI: Build & Test
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -B -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ³ CD: Docker Build & Data Ingestion
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          echo "ğŸš€ Building Image: ${{ env.CONTAINER_NAME }}"
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          echo "ğŸš€ Running Container & Loading Massive Data..."
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Fix Docker Copy Error & Encoding [skip ci]" || echo "No changes"
          git push origin main
