name: "ğŸ§ All-in-One CI/CD Pipeline (Ultra-Stable Final) â€” EchoOps"

# 1. íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ main, master, '**/create-and-manage-linux-images**' ]
    tags: 
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., latest or v1.0.0)'
        required: false
        default: 'latest'
      environment:
        description: 'Deployment environment'
        required: false
        default: 'Staging'
        type: choice
        options:
          - Staging
          - Production
          
permissions:
  contents: read
  packages: write 
  id-token: write
  deployments: write

env:
  REGISTRY: ghcr.io
  ECHO_PREFIX: "[EchoOps][CI/CD]"

jobs:
  # 1. ì´ë¯¸ì§€ ë¹Œë“œ, ë³´ì•ˆ ê²€ì¦ ë° í‘¸ì‹œ
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix: # ìŠ¤í‚µ ì—†ì´ ëª¨ë“  í•­ëª© ë¬´ì¡°ê±´ ì‹¤í–‰
        include:
          - name: ubuntu
            context: ./docker/ubuntu
            dockerfile: ./docker/ubuntu/Dockerfile
          - name: ubi
            context: ./docker/ubi
            dockerfile: ./docker/ubi/Dockerfile
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Multi-Arch Tools (QEMU & Buildx)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        
      # Hadolint ì˜¤ë¥˜ ë°œìƒí•´ë„ ê°•í–‰í•˜ë„ë¡ continue-on-error: true ìœ ì§€ ë° ignore ì¶”ê°€
      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
          failure-threshold: warning
          ignore: DL3005,DL3007 # Dockerfile ìˆ˜ì • ì „ê¹Œì§€ ì˜¤ë¥˜ ë¬´ì‹œ
        continue-on-error: true 

      - name: Prepare Image Metadata & Build Params
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.name }}"
          SHA_TAG="${IMAGE_NAME}:sha-${GITHUB_SHA}"
          TAGS="${SHA_TAG}"
          
          # 1. íƒœê·¸ ê²°ì • ë¡œì§
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
          fi
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_REF_NAME}"
          fi
          
          # 2. Load/Push/Platform ê²°ì • ë¡œì§
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            PUSH_MODE="false"
            LOAD_MODE="true"
            BUILD_PLATFORMS="linux/amd64"
          else
            PUSH_MODE="true"
            LOAD_MODE="false"
            BUILD_PLATFORMS="linux/amd64,linux/arm64"
          fi

          # GITHUB_OUTPUT íŒŒì¼ì— ë³€ìˆ˜ ì €ì¥ (ì•ˆì •ì ì¸ Boolean ì „ë‹¬ ë° Deprecation í•´ê²°)
          echo "image_sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_tags=${TAGS}" >> "$GITHUB_OUTPUT"
          echo "push_mode=${PUSH_MODE}" >> "$GITHUB_OUTPUT"
          echo "load_mode=${LOAD_MODE}" >> "$GITHUB_OUTPUT"
          echo "build_platforms=${BUILD_PLATFORMS}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and Push Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ steps.meta.outputs.build_platforms }}
          push: ${{ steps.meta.outputs.push_mode }} 
          load: ${{ steps.meta.outputs.load_mode }}
          tags: ${{ steps.meta.outputs.image_tags }}
          cache-from: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }}
          cache-to: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }},mode=max

      # Smoke TestëŠ” Load Modeì¼ ë•Œë§Œ ì‹¤í–‰ ê°€ëŠ¥
      - name: Smoke Test Image (Only on Load Mode)
        if: steps.meta.outputs.load_mode == 'true'
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          docker run --rm "${IMAGE}" bash -lc "
            test -f /etc/app/permissions.conf;
            test -d /opt/app/data;
            test -d /var/log/app;
            echo 'Smoke test passed.';
          "
          
      - name: Scan Image for Vulnerabilities (Trivy Security Gate)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: table
          severity: CRITICAL,HIGH 
          exit-code: 1 
          ignore-unfixed: true
          
      - name: Generate and Upload SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: cyclonedx
          output: sbom-${{ matrix.name }}.json
          scan-type: image
          
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-sbom-${{ github.run_number }}
          path: sbom-${{ matrix.name }}.json
          retention-days: 30 

      - name: Save Image and Upload to Artifacts (Short-term)
        if: steps.meta.outputs.load_mode == 'true'
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          TAR_NAME="${{ matrix.name }}.tar.gz"
          docker save "${IMAGE}" | gzip > "${TAR_NAME}"
      - name: Upload Image Artifact
        if: steps.meta.outputs.load_mode == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-${{ github.run_number }}
          path: ${{ matrix.name }}.tar.gz
          retention-days: 7

      - name: Long-term Image Backup to Cloud Storage
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        # ì‹¤ì œ ë°±ì—… ëª…ë ¹ì–´ (ì¸í”„ë¼ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
        run: |
          echo "${{ env.ECHO_PREFIX}} Backing up ${{ matrix.name }}.tar.gz to S3/GCS..."

  # 2. ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    needs: [build-and-push]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Staging')
      )
    runs-on: ubuntu-latest
    environment: Staging 
    steps:
      - name: Determine Image Tag (ì…¸ ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì • ë°˜ì˜)
        id: tag
        run: |
          TAG='${{ github.sha }}'
          
          # ì…¸ ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²•ì„ í‘œì¤€ Bash íŒ¨í„´ ë¹„êµë¡œ ìˆ˜ì •
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/tags/"* ]]; then
            # startsWith("refs/heads/main", "refs/tags/") ì˜¤ë¥˜ ìˆ˜ì •:
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Staging Environment
        # ë°°í¬ ëª…ë ¹ì–´ëŠ” ì‚¬ìš©ìì˜ ì¸í”„ë¼ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Staging."

  # 3. ìš´ì˜ í™˜ê²½ ë°°í¬ (ìˆ˜ë™ ìŠ¹ì¸ í¬í•¨)
  deploy-production:
    needs: [deploy-staging]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Production')
      )
    runs-on: ubuntu-latest
    environment: 
      name: Production 
      url: https://your-production-url.com
    steps:
      - name: Determine Image Tag (ì…¸ ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì • ë°˜ì˜)
        id: tag
        run: |
          TAG='${{ github.sha }}'
          
          # ì…¸ ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²•ì„ í‘œì¤€ Bash íŒ¨í„´ ë¹„êµë¡œ ìˆ˜ì •
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/tags/"* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Production Environment
        # ë°°í¬ ëª…ë ¹ì–´ëŠ” ì‚¬ìš©ìì˜ ì¸í”„ë¼ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Production."
          
      - name: Scale up Server Replicas
        # ì„œë²„ ì„¤ì¹˜ ì¦ê°€/í™•ì¥ ë¡œì§
        run: |
          echo "${{ env.ECHO_PREFIX}} Scaling up deployment to desired capacity (e.g., 5 replicas)."
