name: "ğŸ§ All-in-One CI/CD Pipeline (No Skip) â€” EchoOps"

# 1. íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ main, master, '**/create-and-manage-linux-images**' ]
    tags: # íƒœê·¸ í‘¸ì‹œë„ ë°°í¬ íŠ¸ë¦¬ê±°ë¡œ ì‚¬ìš©
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•´ input ì„¤ì •
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., latest or v1.0.0)'
        required: false
        default: 'latest'
      environment:
        description: 'Deployment environment'
        required: false
        default: 'Staging'
        type: choice
        options:
          - Staging
          - Production
          
permissions:
  contents: read
  packages: write # GHCR push
  id-token: write # Cloud Provider OIDC ì¸ì¦
  deployments: write # GitHub Environments ì‚¬ìš©

env:
  REGISTRY: ghcr.io
  ECHO_PREFIX: "[EchoOps][CI/CD]"

jobs:
  # 1. ì´ë¯¸ì§€ ë¹Œë“œ, ë³´ì•ˆ ê²€ì¦ ë° í‘¸ì‹œ
  # (ì´ì „ì˜ 'filter-changes' Jobì„ ì œê±°í•˜ê³  matrixë¥¼ ê³ ì •í•˜ì—¬ ë¬´ì¡°ê±´ ì‹¤í–‰)
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix: # ëª¨ë“  í•­ëª©ì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•˜ì—¬ ìŠ¤í‚µ ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰
        include:
          - name: ubuntu
            context: ./docker/ubuntu
            dockerfile: ./docker/ubuntu/Dockerfile
          - name: ubi
            context: ./docker/ubi
            dockerfile: ./docker/ubi/Dockerfile
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Multi-Arch Tools (QEMU & Buildx)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        
      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
        continue-on-error: true

      - name: Prepare Image Metadata & Tags
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.name }}"
          SHA_TAG="${IMAGE_NAME}:sha-${GITHUB_SHA}"
          TAGS="${SHA_TAG}"
          
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
          fi
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_REF_NAME}"
          fi
          
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "image_sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and Push Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64, linux/arm64 
          push: ${{ github.event_name != 'pull_request' }}
          load: true 
          tags: ${{ steps.meta.outputs.image_tags }}
          cache-from: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }}
          cache-to: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }},mode=max

      - name: Smoke Test Image
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          docker run --rm "${IMAGE}" bash -lc "
            test -f /etc/app/permissions.conf;
            test -d /opt/app/data;
            test -d /var/log/app;
            echo 'Smoke test passed.';
          "
          
      - name: Scan Image for Vulnerabilities (Trivy Security Gate)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: table
          severity: CRITICAL,HIGH 
          exit-code: 1 
          ignore-unfixed: true
          
      - name: Generate and Upload SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: cyclonedx
          output: sbom-${{ matrix.name }}.json
          scan-type: image
          
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-sbom-${{ github.run_number }}
          path: sbom-${{ matrix.name }}.json
          retention-days: 30 

      - name: Save Image and Upload to Artifacts (Short-term)
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          TAR_NAME="${{ matrix.name }}.tar.gz"
          docker save "${IMAGE}" | gzip > "${TAR_NAME}"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-${{ github.run_number }}
          path: ${{ matrix.name }}.tar.gz
          retention-days: 7

      - name: Long-term Image Backup to Cloud Storage
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        # ì´ ìŠ¤í…ì€ ì‹¤ì œ S3, GCS ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸/ì•¡ì…˜ìœ¼ë¡œ ëŒ€ì²´ë˜ì–´ì•¼ í•¨
        run: |
          echo "${ECHO_PREFIX} Backing up ${{ matrix.name }}.tar.gz to S3/GCS..."
          # ì‹¤ì œ ë°±ì—… ëª…ë ¹ì–´: aws s3 cp ... ë˜ëŠ” gcloud storage cp ...

  # 2. ìŠ¤í…Œì´ì§• ë°°í¬ 
  # (ì´ì „ ë²„ì „ì˜ 'needs' ì¡°ê±´ì„ 'build-and-push'ì˜ ì„±ê³µìœ¼ë¡œë§Œ ë‹¨ìˆœí™”)
  deploy-staging:
    needs: [build-and-push]
    # Push ì„±ê³µ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë¬´ì¡°ê±´ ì‹¤í–‰ (ë¹Œë“œ ì„±ê³µ ê°€ì •)
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Staging')
      )
    runs-on: ubuntu-latest
    environment: Staging 
    steps:
      - name: Determine Image Tag
        id: tag
        run: |
          TAG='${{ github.sha }}'
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && startsWith("${{ github.ref }}", "refs/tags/") ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Staging Environment
        # ì‹¤ì œ ë°°í¬ ë¡œì§ (K8s/ECS/VM)
        run: |
          echo "${ECHO_PREFIX} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Staging."
          # ì˜ˆì‹œ: K8s ëª…ë ¹ì–´ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          # kubectl set image deployment/app-staging app-container=${{ env.REGISTRY }}/${{ github.repository_owner }}/app:${{ steps.tag.outputs.DEPLOY_TAG }}

  # 3. ìš´ì˜ í™˜ê²½ ë°°í¬ (ìˆ˜ë™ ìŠ¹ì¸ í¬í•¨)
  deploy-production:
    # Staging ë°°í¬ ì„±ê³µ ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë¬´ì¡°ê±´ ì‹¤í–‰ (Staging ì„±ê³µ ê°€ì •)
    needs: [deploy-staging]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Production')
      )
    runs-on: ubuntu-latest
    environment: 
      name: Production # ìˆ˜ë™ ìŠ¹ì¸/ê²€í† ì ì„¤ì •ì€ GitHub UIì—ì„œ ì§„í–‰
      url: https://your-production-url.com
    steps:
      - name: Determine Image Tag
        id: tag
        run: |
          TAG='${{ github.sha }}'
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && startsWith("${{ github.ref }}", "refs/tags/") ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Production Environment
        # ì‹¤ì œ ë°°í¬ ë¡œì§ (K8s/ECS/VM)
        run: |
          echo "${ECHO_PREFIX} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Production."
          # ì˜ˆì‹œ: K8s ëª…ë ¹ì–´ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          # kubectl set image deployment/app-prod app-container=${{ env.REGISTRY }}/${{ github.repository_owner }}/app:${{ steps.tag.outputs.DEPLOY_TAG }}
          
      - name: Scale up Server Replicas (Post-Deployment)
        # ì„œë²„ ì„¤ì¹˜ ì¦ê°€/í™•ì¥ ë¡œì§
        run: |
          echo "${ECHO_PREFIX} Scaling up deployment to desired capacity (e.g., 5 replicas)."
          # ì˜ˆì‹œ: K8s replica ìˆ˜ë¥¼ 5ë¡œ ì¦ê°€ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          # kubectl scale deployment app-prod --replicas=5
