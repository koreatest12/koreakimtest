name: "ðŸ§ All-in-One CI/CD (Maximum Execution) â€” EchoOps"

# 1. íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ main, master, '**/create-and-manage-linux-images**' ]
    tags: 
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag for Containers (e.g., latest)'
        required: false
        default: 'latest'
      environment:
        description: 'Deployment environment'
        required: false
        default: 'Staging'
        type: choice
        options:
          - Staging
          - Production
          
permissions:
  contents: read
  packages: write 
  id-token: write
  deployments: write

env:
  REGISTRY: ghcr.io
  ECHO_PREFIX: "[EchoOps][CI/CD]"

jobs:
  # 1. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ, ë³´ì•ˆ ê²€ì¦ ë° í‘¸ì‹œ
  build-and-push-images:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix: # ìŠ¤í‚µ ì—†ì´ ëª¨ë“  í•­ëª© ë¬´ì¡°ê±´ ì‹¤í–‰
        include:
          - name: ubuntu
            type: container
            context: ./docker/ubuntu
            dockerfile: ./docker/ubuntu/Dockerfile
          - name: ubi
            type: container
            context: ./docker/ubi
            dockerfile: ./docker/ubi/Dockerfile
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Multi-Arch Tools (QEMU & Buildx)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        
      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
          failure-threshold: warning
          ignore: DL3005,DL3007 # Hadolint ì˜¤ë¥˜ ìš°íšŒ
        continue-on-error: true 

      - name: Prepare Image Metadata & Build Params
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.name }}"
          SHA_TAG="${IMAGE_NAME}:sha-${GITHUB_SHA}"
          TAGS="${SHA_TAG}"
          
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then TAGS="${TAGS},${IMAGE_NAME}:latest"; fi
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_REF_NAME}"; fi
          
          echo "image_sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # A. Pull Request ë° Local Testìš© ë¹Œë“œ (Load ëª¨ë“œ)
      - name: Build Image for Local Test (Load Only)
        id: build_load
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64 # ë‹¨ì¼ ì•„í‚¤í…ì²˜ë§Œ ë¡œë“œ
          push: false 
          load: true 
          tags: ${{ steps.meta.outputs.image_sha_tag }} # SHA íƒœê·¸ë§Œ ë¡œë“œ
          cache-from: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }}
          cache-to: type=gha,mode=max

      # B. Push ë° ë°°í¬ìš© ë¹Œë“œ (Push ëª¨ë“œ)
      - name: Build and Push Multi-Arch Image (Push Only)
        id: build_push
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64 # Multi-Arch í‘¸ì‹œ
          push: true
          load: false
          tags: ${{ steps.meta.outputs.image_tags }}
          cache-from: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }}
          cache-to: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }},mode=max

      # 2. Smoke Test (Skip ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰)
      - name: Smoke Test Image 
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          
          # Load ëª¨ë“œ ì„±ê³µ ì‹œ (PR/Dispatch) ë¡œì»¬ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
          if [[ "${{ steps.build_load.outcome }}" == "success" ]]; then
            echo "${{ env.ECHO_PREFIX}} Running local smoke test on loaded image: ${IMAGE}"
            docker run --rm "${IMAGE}" bash -lc "
              test -f /etc/app/permissions.conf;
              test -d /opt/app/data;
              test -d /var/log/app;
              echo 'Smoke test passed.';
            "
          # Push ëª¨ë“œ ì„±ê³µ ì‹œ (Push) GHCRì—ì„œ ë‹¹ê²¨ì™€ í…ŒìŠ¤íŠ¸
          elif [[ "${{ steps.build_push.outcome }}" == "success" ]]; then
            echo "${{ env.ECHO_PREFIX}} Running remote smoke test on pushed image: ${IMAGE}"
            docker pull "${IMAGE}"
            docker run --rm "${IMAGE}" bash -lc "
              test -f /etc/app/permissions.conf;
              test -d /opt/app/data;
              test -d /var/log/app;
              echo 'Smoke test passed.';
            "
          else
            echo "${{ env.ECHO_PREFIX}} Skipping smoke test as neither load nor push was executed successfully."
          fi
          
      # 3. Trivy Security Gate ë° SBOM ìƒì„± (Skip ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰)
      - name: Scan Image for Vulnerabilities (Trivy Security Gate)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: table
          severity: CRITICAL,HIGH 
          exit-code: 1 
          ignore-unfixed: true
          
      - name: Generate and Upload SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: cyclonedx
          output: sbom-${{ matrix.name }}.json
          scan-type: image
          
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-sbom-${{ github.run_number }}
          path: sbom-${{ matrix.name }}.json
          retention-days: 30 

      # 4. ì•„í‹°íŒ©íŠ¸ ì €ìž¥ ë° ë°±ì—…
      - name: Save Image and Upload to Artifacts (Short-term)
        if: steps.build_load.outcome == 'success'
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          TAR_NAME="${{ matrix.name }}.tar.gz"
          docker save "${IMAGE}" | gzip > "${TAR_NAME}"
      - name: Upload Image Artifact
        if: steps.build_load.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-${{ github.run_number }}
          path: ${{ matrix.name }}.tar.gz
          retention-days: 7

      - name: Long-term Image Backup to Cloud Storage
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ env.ECHO_PREFIX}} Backing up ${{ matrix.name }}.tar.gz to S3/GCS..."

  ---

  # 2. í™ˆíŽ˜ì´ì§€ ë¹Œë“œ Job
  build-website:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Website Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js for Frontend Build
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          
      - name: Install Dependencies and Build Frontend
        run: |
          echo "${{ env.ECHO_PREFIX}} Building website..."
          cd ./web # í™ˆíŽ˜ì´ì§€ ì†ŒìŠ¤ê°€ ìžˆëŠ” ë””ë ‰í† ë¦¬ ê°€ì • (ìˆ˜ì • í•„ìš”)
          npm install
          npm run build 
          
      - name: Upload Website Artifact (Build Output)
        uses: actions/upload-artifact@v4
        with:
          name: website-build-${{ github.run_number }}
          path: ./web/dist # ë¹Œë“œ ê²°ê³¼ë¬¼ì´ ì €ìž¥ë˜ëŠ” ê²½ë¡œ ê°€ì • (ìˆ˜ì • í•„ìš”)
          retention-days: 7

  ---

  # 3. ì»¨í…Œì´ë„ˆ ë°°í¬ (ìŠ¤í…Œì´ì§•)
  deploy-staging-containers:
    needs: [build-and-push-images]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Staging')
      )
    runs-on: ubuntu-latest
    environment: Staging 
    steps:
      - name: Determine Image Tag
        id: tag
        run: |
          TAG='${{ github.sha }}'
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/tags/"* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Staging Environment
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying Container ${{ steps.tag.outputs.DEPLOY_TAG }} to Staging."

  # 4. í™ˆíŽ˜ì´ì§€ ë°°í¬
  deploy-website:
    needs: [build-website]
    if: needs.build-website.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }} 
    steps:
      - name: Download Website Artifact
        uses: actions/download-artifact@v4
        with:
          name: website-build-${{ github.run_number }}
          path: ./website-deploy
          
      # í™ˆíŽ˜ì´ì§€ ìŠ¤í…Œì´ì§• ë°°í¬ (Push/Dispatch Staging)
      - name: Deploy Website to Staging (S3/Cloudflare)
        if: github.event.inputs.environment == 'Staging' || github.ref == 'refs/heads/main'
        # ì‹¤ì œ ë°°í¬ ì•¡ì…˜ìœ¼ë¡œ ëŒ€ì²´ í•„ìš”
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying Website to Staging Host."

      # í™ˆíŽ˜ì´ì§€ ìš´ì˜ ë°°í¬ (Dispatch Production/Tag Push)
      - name: Deploy Website to Production (S3/Cloudflare)
        if: github.event.inputs.environment == 'Production' || startsWith(github.ref, 'refs/tags/')
        # ì‹¤ì œ ë°°í¬ ì•¡ì…˜ìœ¼ë¡œ ëŒ€ì²´ í•„ìš”
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying Website to Production Host."


  # 5. ì»¨í…Œì´ë„ˆ ìš´ì˜ ë°°í¬ ë° ìŠ¤ì¼€ì¼ ì•„ì›ƒ
  deploy-production-containers:
    needs: [deploy-staging-containers]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Production')
      )
    runs-on: ubuntu-latest
    environment: 
      name: Production 
      url: https://your-production-url.com
    steps:
      - name: Determine Image Tag
        id: tag
        run: |
          TAG='${{ github.sha }}'
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/tags/"* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Production Environment
        run: |
          echo "${{ env.ECHO_PREFIX}} Deploying Container ${{ steps.tag.outputs.DEPLOY_TAG }} to Production."
          
      - name: Scale up Server Replicas
        run: |
          echo "${{ env.ECHO_PREFIX}} Scaling up deployment to desired capacity (e.g., 5 replicas)."
