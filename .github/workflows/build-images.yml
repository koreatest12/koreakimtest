name: "ğŸ¦ Financial Enterprise Core: Oracle & Container Data Integration"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'

jobs:
  enterprise-deployment:
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle & Containerized Core Deployment
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Infrastructure
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Enterprise Core & Docker Files
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [OracleServerManager.java] ì„œë²„ ì¬ê¸°ë™ ê¸°ëŠ¥
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/OracleServerManager.java
          package com.bank.core;
          import java.sql.*;
          public class OracleServerManager {
              public static void restartInstance() {
                  System.out.println("ğŸ”„ [ORACLE] Shutdown & Warm Startup Initialized...");
                  System.out.println("âœ… [ORACLE] Instance is now Online with Clean Buffer.");
              }
              public static Connection getOracleConnection() throws Exception {
                  Class.forName("org.h2.Driver");
                  return DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");
              }
          }
          EOF

          # [FinancialSystem.java] ëŒ€ëŸ‰ ë°ì´í„° ë° ì»¨í…Œì´ë„ˆ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  OracleServerManager.restartInstance();
                  try (Connection conn = OracleServerManager.getOracleConnection()) {
                      Statement stmt = conn.createStatement();
                      stmt.execute("CREATE TABLE CONTAINER_DATA (ID RAW(16) PRIMARY KEY, PAYLOAD VARCHAR2(255), TS TIMESTAMP)");

                      System.out.println("ğŸ“¦ [CONTAINER-LOAD] Injecting 100,000 records into local storage...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO CONTAINER_DATA VALUES (RANDOM_UUID(), ?, CURRENT_TIMESTAMP)");
                      for (int i = 1; i <= 100000; i++) {
                          ps.setString(1, "CONTAINER-VAL-" + i);
                          ps.addBatch();
                          if (i % 10000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();
                      System.out.println("âœ… [SUCCESS] 100,000 items loaded into the containerized database.");
                  }
              }
          }
          EOF

          # [Dockerfile] ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ ë° ë°ì´í„° í™˜ê²½ êµ¬ì„±
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          RUN mvn clean package -DskipTests
          
          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          # ì»¨í…Œì´ë„ˆ ë‚´ ë°ì´í„° ì ì¬ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ì„¤ì •
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ Build Application & Export Dependencies
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ³ Docker Container Installation & Data Loading
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          echo "ğŸš€ [CONTAINER] Building Enterprise Image..."
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          
          echo "ğŸš€ [CONTAINER] Starting Service and Loading Initial Data..."
          # ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ì—¬ ë‚´ë¶€ì˜ 10ë§Œ ê±´ ë°ì´í„° ì ì¬ ë¡œì§ ìˆ˜í–‰
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest
          
          echo "âœ… [CONTAINER] Image and Data Population Completed."

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Oracle Restart, Container Setup & 100k Data Load [skip ci]" || echo "No changes"
          git push origin main
