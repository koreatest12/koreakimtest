name: "ğŸ§ All-in-One CI/CD Pipeline â€” EchoOps"

# 1. íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ main, master, '**/create-and-manage-linux-images**' ]
    tags: # íƒœê·¸ í‘¸ì‹œë„ ë°°í¬ íŠ¸ë¦¬ê±°ë¡œ ì‚¬ìš©
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•´ input ì„¤ì •
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., latest or v1.0.0)'
        required: false
        default: 'latest'
      environment:
        description: 'Deployment environment'
        required: false
        default: 'Staging'
        type: choice
        options:
          - Staging
          - Production
          
permissions:
  contents: read
  packages: write # GHCR push
  id-token: write # Cloud Provider OIDC ì¸ì¦
  deployments: write # GitHub Environments ì‚¬ìš©

env:
  REGISTRY: ghcr.io
  ECHO_PREFIX: "[EchoOps][CI/CD]"

jobs:
  # 1. ë³€ê²½ ê°ì§€ ë° ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
  filter-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Paths Filter (Change Detection)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ubuntu:
              - 'docker/ubuntu/Dockerfile'
              - 'docker/ubuntu/**'
              - '.github/workflows/ci-cd-unified.yml' # ì›Œí¬í”Œë¡œìš° ë³€ê²½ ì‹œì—ë„ ì¬ë¹Œë“œ
            ubi:
              - 'docker/ubi/Dockerfile'
              - 'docker/ubi/**'
              - '.github/workflows/ci-cd-unified.yml'

  # 2. ì´ë¯¸ì§€ ë¹Œë“œ, ë³´ì•ˆ ê²€ì¦ ë° í‘¸ì‹œ
  build-and-push:
    needs: filter-changes
    if: needs.filter-changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.filter-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Multi-Arch Tools (QEMU & Buildx)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      - uses: docker/setup-buildx-action@v3
        
      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
        continue-on-error: true # ë¦°íŠ¸ ì˜¤ë¥˜ëŠ” ë¹Œë“œë¥¼ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•ŠìŒ

      - name: Prepare Image Metadata & Tags
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.name }}"
          SHA_TAG="${IMAGE_NAME}:sha-${GITHUB_SHA}"
          TAGS="${SHA_TAG}"
          
          # main ë¸Œëœì¹˜/íƒœê·¸ì— ë”°ë¥¸ íƒœê·¸ ì¶”ê°€
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
          fi
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_REF_NAME}"
          fi
          
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "image_sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # ê¸°ëŠ¥: Multi-Arch & Registry Cache ì ìš©
      - name: Build and Push Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64, linux/arm64 # Multi-Arch ë¹Œë“œ
          push: ${{ github.event_name != 'pull_request' }}
          load: true 
          tags: ${{ steps.meta.outputs.image_tags }}
          cache-from: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }}
          cache-to: type=gha,type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/buildcache:${{ matrix.name }},mode=max

      - name: Smoke Test Image
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          docker run --rm "${IMAGE}" bash -lc "
            test -f /etc/app/permissions.conf;
            test -d /opt/app/data;
            test -d /var/log/app;
            echo 'Smoke test passed.';
          "
          
      # ê¸°ëŠ¥: ë³´ì•ˆ ê²Œì´íŠ¸ (CRITICAL/HIGH ì‹œ ì‹¤íŒ¨)
      - name: Scan Image for Vulnerabilities (Trivy Security Gate)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: table
          severity: CRITICAL,HIGH # CRITICAL/HIGH ì·¨ì•½ì  ë°œê²¬ ì‹œ
          exit-code: 1 # ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
          ignore-unfixed: true

      # ê¸°ëŠ¥: SBOM ìƒì„± ë° ì•„í‹°íŒ©íŠ¸ ì €ì¥
      - name: Generate and Upload SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: cyclonedx
          output: sbom-${{ matrix.name }}.json
          scan-type: image
          
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-sbom-${{ github.run_number }}
          path: sbom-${{ matrix.name }}.json
          retention-days: 30 # SBOMì€ ì¥ê¸° ë³´ì¡´

      # ê¸°ëŠ¥: ì¥ê¸° ë°±ì—… (Tag Push ì‹œ S3/GCSì— ì €ì¥)
      - name: Save Image and Upload to Artifacts (Short-term)
        run: |
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          TAR_NAME="${{ matrix.name }}.tar.gz"
          docker save "${IMAGE}" | gzip > "${TAR_NAME}"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-${{ github.run_number }}
          path: ${{ matrix.name }}.tar.gz
          retention-days: 7

      - name: Long-term Image Backup to Cloud Storage
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        # ì´ ì•¡ì…˜ì€ S3, GCS ë“± ì™¸ë¶€ ìŠ¤í† ë¦¬ì§€ì— ì—…ë¡œë“œí•˜ëŠ” ì‚¬ìš©ì ì§€ì •/ë§ˆì¼“í”Œë ˆì´ìŠ¤ ì•¡ì…˜ìœ¼ë¡œ ëŒ€ì²´ë˜ì–´ì•¼ í•¨
        run: |
          echo "${ECHO_PREFIX} Backing up ${{ matrix.name }}.tar.gz to S3/GCS..."
          # aws s3 cp ${{ matrix.name }}.tar.gz s3://${{ secrets.BACKUP_BUCKET }}/artifacts/
          # gcloud storage cp ${{ matrix.name }}.tar.gz gs://${{ secrets.BACKUP_BUCKET }}/artifacts/

  # 3. ìŠ¤í…Œì´ì§• ë°°í¬ (main/tag push ì„±ê³µ ì‹œ)
  deploy-staging:
    needs: [build-and-push]
    # main ë¸Œëœì¹˜ push, íƒœê·¸ push, ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ (Staging í™˜ê²½ ì„ íƒ ì‹œ)ì—ë§Œ ì‹¤í–‰
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Staging')
      )
    runs-on: ubuntu-latest
    environment: Staging # GitHub Environment ì‚¬ìš©
    steps:
      - name: Determine Image Tag
        id: tag
        run: |
          TAG='${{ github.sha }}'
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && startsWith("${{ github.ref }}", "refs/tags/") ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Staging Environment
        # ì‹¤ì œ K8s/ECS ë°°í¬ ì½”ë“œë¥¼ ì—¬ê¸°ì— ì‘ì„±
        run: |
          echo "${ECHO_PREFIX} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Staging (K8s/ECS)"
          # ì˜ˆì‹œ: K8s ëª…ë ¹ì–´
          # kubectl set image deployment/app-staging app-container=${{ env.REGISTRY }}/${{ github.repository_owner }}/app:${{ steps.tag.outputs.DEPLOY_TAG }}
          # kubectl rollout status deployment/app-staging

  # 4. ìš´ì˜ í™˜ê²½ ë°°í¬ (ìˆ˜ë™ ìŠ¹ì¸ í¬í•¨)
  deploy-production:
    # Staging ë°°í¬ ì„±ê³µ ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ (Production í™˜ê²½ ì„ íƒ ì‹œ)ì—ë§Œ ì‹¤í–‰
    needs: [deploy-staging]
    if: |
      success() && (
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'Production')
      )
    runs-on: ubuntu-latest
    environment: 
      name: Production # GitHub Environment ì„¤ì • (ìˆ˜ë™ ìŠ¹ì¸ ê¸°ëŠ¥ í™œìš©)
      url: https://your-production-url.com
    steps:
      - name: Determine Image Tag
        id: tag
        # Stagingê³¼ ë™ì¼í•œ íƒœê·¸ ê²°ì • ë¡œì§ ì‚¬ìš©
        run: |
          TAG='${{ github.sha }}'
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG='latest'
          elif [[ "${{ github.event_name }}" == "push" && startsWith("${{ github.ref }}", "refs/tags/") ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          fi
          echo "DEPLOY_TAG=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Deploy Image to Production Environment
        # ì‹¤ì œ K8s/ECS ë°°í¬ ì½”ë“œë¥¼ ì—¬ê¸°ì— ì‘ì„±
        run: |
          echo "${ECHO_PREFIX} Deploying ${{ steps.tag.outputs.DEPLOY_TAG }} to Production (K8s/ECS)"
          # ì˜ˆì‹œ: K8s ëª…ë ¹ì–´
          # kubectl set image deployment/app-prod app-container=${{ env.REGISTRY }}/${{ github.repository_owner }}/app:${{ steps.tag.outputs.DEPLOY_TAG }}
          # kubectl rollout status deployment/app-prod
          
      # ê¸°ëŠ¥: ì„œë²„ ì„¤ì¹˜ ì¦ê°€ (Scale Out)
      - name: Scale up Server Replicas
        run: |
          echo "${ECHO_PREFIX} Scaling up deployment to desired capacity (e.g., 5 replicas)."
          # ì˜ˆì‹œ: K8s replica ìˆ˜ë¥¼ 5ë¡œ ì¦ê°€
          # kubectl scale deployment app-prod --replicas=5 
          # ë˜ëŠ” ASG Desired Capacity ì¡°ì • ì½”ë“œ
