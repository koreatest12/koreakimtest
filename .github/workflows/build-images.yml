name: "üöÄ Auto-Gen (Images included), Backup & Deploy"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'enterprise-app/**'

permissions:
  contents: write
  packages: write
  security-events: write
  checks: write

env:
  MAVEN_VERSION: '3.9.6'
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'enterprise-app'
  DOCKER_IMAGE_NAME: 'enterprise-demo'
  BACKUP_DIR: 'backups'

jobs:
  full-execution:
    runs-on: ubuntu-latest
    name: üõ†Ô∏è Gen Images, Code, Build & Dump

    steps:
      # ----------------------------------------------------------------
      # 1. ÌôòÍ≤Ω ÏÑ§Ï†ï Î∞è Ï∫êÏãú
      # ----------------------------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: üíæ Cache Maven Packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # ----------------------------------------------------------------
      # 2. Maven ÏàòÎèô ÏÑ§Ïπò
      # ----------------------------------------------------------------
      - name: ‚¨áÔ∏è Manual Install Apache Maven
        run: |
          if [ ! -d "apache-maven-${MAVEN_VERSION}" ]; then
            wget -q https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
            tar -xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
          fi
          echo "$(pwd)/apache-maven-${MAVEN_VERSION}/bin" >> $GITHUB_PATH
          export PATH="$(pwd)/apache-maven-${MAVEN_VERSION}/bin:$PATH"

      # ----------------------------------------------------------------
      # 3. ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùº ÏÉùÏÑ± (ÏΩîÎìú, XML, Docker, K8s)
      # ----------------------------------------------------------------
      - name: üìÇ Generate Project Structure & Files
        run: |
          echo "üõ†Ô∏è Generating Project..."
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/company/core
          mkdir -p ${PROJECT_ROOT}/src/test/java/com/company/core
          mkdir -p ${PROJECT_ROOT}/src/main/resources/customer_images # [NEW] Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ìè¥Îçî
          mkdir -p ${PROJECT_ROOT}/k8s
          mkdir -p ${PROJECT_ROOT}/${BACKUP_DIR}

          # [3-1] pom.xml
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.company</groupId>
              <artifactId>enterprise-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              </properties>
              <dependencies>
                  <dependency><groupId>org.slf4j</groupId><artifactId>slf4j-api</artifactId><version>2.0.9</version></dependency>
                  <dependency><groupId>ch.qos.logback</groupId><artifactId>logback-classic</artifactId><version>1.4.11</version></dependency>
                  <dependency><groupId>org.junit.jupiter</groupId><artifactId>junit-jupiter-api</artifactId><version>5.10.0</version><scope>test</scope></dependency>
                  <dependency><groupId>org.junit.jupiter</groupId><artifactId>junit-jupiter-engine</artifactId><version>5.10.0</version><scope>test</scope></dependency>
              </dependencies>
              <build>
                  <plugins>
                      <plugin><groupId>org.apache.maven.plugins</groupId><artifactId>maven-surefire-plugin</artifactId><version>3.1.2</version></plugin>
                      <plugin>
                          <groupId>org.apache.maven.plugins</groupId><artifactId>maven-javadoc-plugin</artifactId><version>3.6.3</version>
                          <configuration><encoding>UTF-8</encoding><doclint>none</doclint><failOnError>false</failOnError></configuration>
                      </plugin>
                  </plugins>
              </build>
          </project>
          EOF

          # [3-2] logback.xml
          cat <<EOF > ${PROJECT_ROOT}/src/main/resources/logback.xml
          <configuration>
            <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
              <encoder><pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern></encoder>
            </appender>
            <root level="INFO"><appender-ref ref="STDOUT" /></root>
          </configuration>
          EOF

          # [3-3] settings.xml
          cat <<EOF > ${PROJECT_ROOT}/settings.xml
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <localRepository/><interactiveMode>true</interactiveMode><offline>false</offline>
          </settings>
          EOF

          # [3-4] Java Source
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/company/core/Application.java
          package com.company.core;
          import org.slf4j.Logger; import org.slf4j.LoggerFactory;
          /** Enterprise App Entry Point */
          public class Application {
              private static final Logger logger = LoggerFactory.getLogger(Application.class);
              /** @return status string */
              public String getStatus() { return "Active"; }
              /** @param args arguments */
              public static void main(String[] args) {
                  logger.info("Starting Enterprise Service...");
                  logger.info("System Status: " + new Application().getStatus());
              }
          }
          EOF

          cat <<EOF > ${PROJECT_ROOT}/src/test/java/com/company/core/ApplicationTest.java
          package com.company.core;
          import org.junit.jupiter.api.Test; import static org.junit.jupiter.api.Assertions.*;
          class ApplicationTest {
              @Test void testStatus() { assertEquals("Active", new Application().getStatus()); }
          }
          EOF

          # [3-5] Dockerfile & K8s
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM eclipse-temurin:17-jre
          WORKDIR /app
          COPY target/*.jar app.jar
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF

          cat <<EOF > ${PROJECT_ROOT}/k8s/deployment.template.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata: { name: enterprise-app }
          spec:
            replicas: 2
            selector: { matchLabels: { app: enterprise-app } }
            template:
              metadata: { labels: { app: enterprise-app } }
              spec:
                containers:
                - name: enterprise-app
                  image: GHCR_IMAGE_PLACEHOLDER
                  ports: [{ containerPort: 8080 }]
                  livenessProbe: { exec: { command: ["java", "-version"] }, initialDelaySeconds: 15 }
          EOF

          echo "‚úÖ Basic files generated."

      # ----------------------------------------------------------------
      # 4. [NEW] Í∞ÄÏÉÅ Í≥†Í∞ù Ï†ïÎ≥¥ Ïù¥ÎØ∏ÏßÄ ÎåÄÎüâ ÏÉùÏÑ± (Bulk Image Gen)
      # ----------------------------------------------------------------
      - name: üñºÔ∏è Generate Bulk Customer Images
        run: |
          echo "üé® Installing ImageMagick for generation..."
          sudo apt-get update && sudo apt-get install -y imagemagick

          IMAGE_DIR="${PROJECT_ROOT}/src/main/resources/customer_images"
          echo "üìÇ Generating images in: $IMAGE_DIR"

          # 50Í∞úÏùò Í∞ÄÏÉÅ Í≥†Í∞ù Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î£®ÌîÑ
          for i in {1..50}; do
            # ÎûúÎç§ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
            CUSTOMER_ID=$(shuf -i 1000000-9999999 -n 1)
            R=$((RANDOM % 255))
            G=$((RANDOM % 255))
            B=$((RANDOM % 255))
            BG_COLOR="rgb($R,$G,$B)"
            FILENAME="$IMAGE_DIR/customer_profile_$(printf "%03d" $i).png"

            # ImageMagickÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ID Ïπ¥Îìú Ïä§ÌÉÄÏùº)
            convert -size 400x250 xc:white \
              -fill "$BG_COLOR" -draw "rectangle 0,0 400,50" \
              -fill white -pointsize 20 -gravity North -annotate +0+15 "Virtual Customer Card" \
              -gravity Center \
              -fill black -pointsize 24 -annotate +0-20 "ID: $CUSTOMER_ID" \
              -fill gray -pointsize 14 -annotate +0+20 "Account Type: Premium" \
              -fill black -pointsize 12 -gravity South -annotate +0+10 "Generated by GitHub Actions" \
              -bordercolor black -border 2 \
              "$FILENAME"
            
            # ÏÉùÏÑ± Î°úÍ∑∏ (5Í∞úÎßàÎã§ Ìïú Î≤àÏî©Îßå Ï∂úÎ†•ÌïòÏó¨ Î°úÍ∑∏ Í≥ºÎ∂ÄÌïò Î∞©ÏßÄ)
            if (( $i % 10 == 0 )); then
                echo "‚úÖ Generated $i/50 images..."
            fi
          done
          
          echo "‚ú® Total 50 customer images generated successfully."
          ls -lh $IMAGE_DIR | head -n 10

      [Image of customer profile dummy data card]

      # ----------------------------------------------------------------
      # 5. ÏÜåÏä§ ÏΩîÎìú Î∞±ÏóÖ (Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
      # ----------------------------------------------------------------
      - name: üì¶ Backup Source Code
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="source_backup_${TIMESTAMP}.tar.gz"
          
          # enterprise-app Ï†ÑÏ≤¥(ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®) ÏïïÏ∂ï
          tar --exclude='target' -czf $BACKUP_FILE ${PROJECT_ROOT}
          
          echo "SOURCE_BACKUP_NAME=$BACKUP_FILE" >> $GITHUB_ENV

      - name: üì§ Upload Source Backup
        uses: actions/upload-artifact@v4
        with:
          name: Source-Backup-With-Images-${{ github.run_id }}
          path: ${{ env.SOURCE_BACKUP_NAME }}
          retention-days: 30

      # ----------------------------------------------------------------
      # 6. Git Commit & Push (Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
      # ----------------------------------------------------------------
      - name: üöÄ Commit & Push to Repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ${PROJECT_ROOT}
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "üöÄ Update: Added 50 virtual customer images [skip ci]"
            git push
            echo "‚úÖ Git Push complete!"
          fi

      # ----------------------------------------------------------------
      # 7. Maven ÎπåÎìú (Ïù¥ÎØ∏ÏßÄÎ•º JARÏóê Ìè¨Ìï®)
      # ----------------------------------------------------------------
      - name: üèóÔ∏è Maven Build & Verify
        working-directory: ${{ env.PROJECT_ROOT }}
        run: mvn clean verify -B -s settings.xml

      # ----------------------------------------------------------------
      # 8. ÎπåÎìú Î∞è Ïù¥ÎØ∏ÏßÄ Îç§ÌîÑ
      # ----------------------------------------------------------------
      - name: üíæ Dump Artifacts, Logs & Images
        uses: actions/upload-artifact@v4
        with:
          name: Full-Dump-${{ github.run_id }}
          path: |
            ${{ env.PROJECT_ROOT }}/target/*.jar
            ${{ env.PROJECT_ROOT }}/src/main/resources/customer_images/*.png
            ${{ env.PROJECT_ROOT }}/pom.xml
            ${{ env.PROJECT_ROOT }}/src/main/resources/logback.xml
          retention-days: 90

      # ----------------------------------------------------------------
      # 9. Î≥¥Ïïà Ïä§Ï∫î & Î∞∞Ìè¨
      # ----------------------------------------------------------------
      - name: üõ°Ô∏è Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.PROJECT_ROOT }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: üê≥ Docker Build & Push
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.PROJECT_ROOT }}
          push: false # Îç∞Î™®Ïö©Ïù¥ÎØÄÎ°ú Ìë∏ÏãúÎäî ÏÉùÎûµÌïòÍ±∞ÎÇò trueÎ°ú Î≥ÄÍ≤Ω
          tags: ghcr.io/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: ‚ò∏Ô∏è Generate K8s Manifest
        run: |
          IMAGE_TAG="ghcr.io/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          sed "s|GHCR_IMAGE_PLACEHOLDER|$IMAGE_TAG|g" ${PROJECT_ROOT}/k8s/deployment.template.yaml > ${PROJECT_ROOT}/k8s/deployment.final.yaml

      - name: üì§ Dump K8s Manifest
        uses: actions/upload-artifact@v4
        with:
          name: K8s-Manifest-Dump
          path: ${{ env.PROJECT_ROOT }}/k8s/deployment.final.yaml
