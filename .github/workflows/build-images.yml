name: "ğŸ¦ Financial Enterprise Core: Container Lifecycle & Data Persistence"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'

jobs:
  enterprise-deployment:
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle & Containerized Core Deployment
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Enterprise Core & Docker Files
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] ì¸ì½”ë”© ë° ìë°” ë²„ì „ ìµœì í™”
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [OracleServerManager.java] ì„œë²„ ìƒíƒœ ê´€ë¦¬
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/OracleServerManager.java
          package com.bank.core;
          import java.sql.*;
          public class OracleServerManager {
              public static void logStatus(String msg) {
                  System.out.println("ğŸ“¢ [SYSTEM-LOG] " + msg);
              }
              public static Connection getOracleConnection() throws Exception {
                  Class.forName("org.h2.Driver");
                  // DB_CLOSE_DELAY=-1ì„ í†µí•´ ì¬ê¸°ë™ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì—ë„ ë©”ëª¨ë¦¬ ë°ì´í„° ìœ ì§€
                  return DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");
              }
          }
          EOF

          # [FinancialSystem.java] ì¬ê¸°ë™ í›„ ë°ì´í„° ì¶”ê°€ ì ì¬ ë¡œì§
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;
          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  try (Connection conn = OracleServerManager.getOracleConnection()) {
                      Statement stmt = conn.createStatement();
                      // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„± (ì¬ê¸°ë™ í›„ ì²´í¬ìš©)
                      stmt.execute("CREATE TABLE IF NOT EXISTS CONTAINER_DATA (ID RAW(16) PRIMARY KEY, PAYLOAD VARCHAR2(255), TS TIMESTAMP)");
                      
                      // í˜„ì¬ ë°ì´í„° ê°œìˆ˜ í™•ì¸
                      ResultSet rs = stmt.executeQuery("SELECT COUNT(*) FROM CONTAINER_DATA");
                      rs.next();
                      int currentCount = rs.getInt(1);
                      
                      String mode = (currentCount == 0) ? "INITIAL" : "RECOVERY/POST-RESTART";
                      OracleServerManager.logStatus("Current Data Rows: " + currentCount + " | Mode: " + mode);

                      System.out.println("ğŸ“¦ [DATA-LOAD] Injecting 50,000 records...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO CONTAINER_DATA VALUES (RANDOM_UUID(), ?, CURRENT_TIMESTAMP)");
                      for (int i = 1; i <= 50000; i++) {
                          ps.setString(1, mode + "-VAL-" + i + "-" + UUID.randomUUID().toString().substring(0,8));
                          ps.addBatch();
                          if (i % 5000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();
                      
                      rs = stmt.executeQuery("SELECT COUNT(*) FROM CONTAINER_DATA");
                      rs.next();
                      System.out.println("âœ… [SUCCESS] Total Data Rows after this run: " + rs.getInt(1));
                  }
              }
          }
          EOF

          # [Dockerfile]
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          RUN mvn clean package -DskipTests && \
              mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ Build & Dependency Export
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -B -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ³ Docker Build & Lifecycle Management
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          echo "ğŸš€ [1/4] Building Image..."
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          
          echo "ğŸš€ [2/4] Initial Run: Loading first batch..."
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest
          
          echo "ğŸ”„ [3/4] Container Restarting..."
          # ì‹¤ì œ ìš´ì˜ í™˜ê²½ì²˜ëŸ¼ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í–ˆë‹¤ê°€ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
          docker restart ${{ env.CONTAINER_NAME }}
          # ì¬ê¸°ë™ í›„ ë¡œê·¸ í™•ì¸ (ë‚´ë¶€ Java ë¡œì§ì´ ë‹¤ì‹œ ì‹¤í–‰ë¨)
          docker logs ${{ env.CONTAINER_NAME }}
          
          echo "ğŸš€ [4/4] Post-Restart: Verification Complete."

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Container Restart & Data Persistence Logic [skip ci]" || echo "No changes"
          git push origin main
