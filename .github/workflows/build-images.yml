name: "ğŸš€ Spring Super CI V6: Oracle, Container & MB-Optimized"

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ê°•ì œ ì¢…ì†ì„± ì—…ë°ì´íŠ¸'
        type: boolean
        default: false
      backup_retention:
        description: 'ë°±ì—… ë³´ê´€ ê¸°ê°„(ì¼)'
        default: '30'

env:
  # 1. ì‹œìŠ¤í…œ ì„¤ì •
  APP_NAME: "finance-core-system"
  JAVA_VERSION: '17'
  DISTRIBUTION: 'temurin'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'
  # 2. ì„œë¹„ìŠ¤ ì •ì˜
  SERVICE_POSTGRES: "postgres:15-alpine"
  SERVICE_REDIS: "redis:7-alpine"
  # 3. ê²½ë¡œ ì„¤ì •
  ARTIFACT_DIR: "super-artifacts"
  SIZE_REPORT: "size_report_mb.txt"

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # ======================================================
  # JOB 1: ì„œë¹„ìŠ¤ ì¸í”„ë¼ ì¤€ë¹„ (MB ìµœì í™”)
  # ======================================================
  provision-infra-mb:
    name: ğŸ“¥ Provision Services (MB Optimized)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Initialize
        run: |
          mkdir -p services
          echo "===== INFRA SIZE REPORT (MB) =====" > ${{ env.SIZE_REPORT }}

      - name: ğŸ³ Pull & Compress Services
        run: |
          for img in ${{ env.SERVICE_POSTGRES }} ${{ env.SERVICE_REDIS }}; do
            docker pull -q $img
            SAFE_NAME=$(echo $img | tr '/:' '_')
            docker save $img | gzip > "services/${SAFE_NAME}.tar.gz"
            SIZE_MB=$(du -m "services/${SAFE_NAME}.tar.gz" | cut -f1)
            echo " - $SAFE_NAME: ${SIZE_MB} MB" >> ${{ env.SIZE_REPORT }}
          done

      - name: ğŸ“¤ Upload Infra Pack
        uses: actions/upload-artifact@v4
        with:
          name: infra-pack-mb
          path: services

  # ======================================================
  # JOB 2: ê¸ˆìœµ ì½”ì–´ ë¹Œë“œ, ì»¨í…Œì´ë„ˆ ì ì¬ ë° ë°ì´í„° ë³‘í•©
  # ======================================================
  build-and-deploy-mb:
    name: ğŸ’ Oracle & Container Data Integration
    needs: provision-infra-mb
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17 & Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.DISTRIBUTION }}
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Financial Core Logic (Data Merge & Persistence)
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          # [pom.xml] ìƒì„± (Encoding & Version Warning í•´ê²°)
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [FinancialSystem.java] ë°ì´í„° ì ì¬ ë° ë³‘í•© ë¡œì§
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;
          public class FinancialSystem {
              private static final String URL = "jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1";
              public static void main(String[] args) throws Exception {
                  Class.forName("org.h2.Driver");
                  try (Connection conn = DriverManager.getConnection(URL, "sa", "")) {
                      Statement stmt = conn.createStatement();
                      stmt.execute("CREATE TABLE IF NOT EXISTS RAW_STAGING (ID RAW(16), VAL NUMBER)");
                      stmt.execute("CREATE TABLE IF NOT EXISTS MERGED_LEDGER (ID RAW(16) PRIMARY KEY, TOTAL_VAL NUMBER, TS TIMESTAMP)");

                      ResultSet rs = stmt.executeQuery("SELECT COUNT(*) FROM RAW_STAGING");
                      rs.next();
                      int count = rs.getInt(1);
                      String mode = (count == 0) ? "INITIAL" : "RESTART_MERGE";
                      
                      System.out.println("ğŸš€ [" + mode + "] Loading 50,000 records...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO RAW_STAGING VALUES (RANDOM_UUID(), ?)");
                      for (int i = 0; i < 50000; i++) {
                          ps.setLong(1, (long)(Math.random() * 1000));
                          ps.addBatch();
                          if (i % 10000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();

                      System.out.println("ğŸ”„ Consolidating Data into MERGED_LEDGER...");
                      stmt.execute("INSERT INTO MERGED_LEDGER SELECT ID, VAL, CURRENT_TIMESTAMP FROM RAW_STAGING WHERE ID NOT IN (SELECT ID FROM MERGED_LEDGER)");
                      
                      rs = stmt.executeQuery("SELECT COUNT(*) FROM MERGED_LEDGER");
                      rs.next();
                      System.out.println("âœ… Current Merged Records: " + rs.getInt(1));
                  }
              }
          }
          EOF

          # [Dockerfile]
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          RUN mvn clean package -DskipTests && mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ Build & Package (MB Aware)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -B -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          JAR_SIZE=$(du -m target/*.jar | cut -f1)
          echo "APP_JAR_SIZE: ${JAR_SIZE} MB" >> ../${{ env.SIZE_REPORT }}

      - name: ğŸ³ Docker Deployment & Lifecycle (Restart & Merge)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          echo "ğŸš€ Initial Run (Staging Data)"
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest
          
          echo "ğŸ”„ Restarting Container (Data Recovery & Merge)"
          docker restart ${{ env.CONTAINER_NAME }}
          docker logs ${{ env.CONTAINER_NAME }}

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: application-binaries-mb
          path: ${{ env.PROJECT_ROOT }}/target/*.jar

  # ======================================================
  # JOB 3: ìµœì¢… ë°±ì—… ë° ë¦¬í¬íŠ¸
  # ======================================================
  master-backup-mb:
    name: ğŸ’¾ Master Backup (MB Report)
    needs: [provision-infra-mb, build-and-deploy-mb]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./full-system
      - name: ğŸ“¦ Final Snapshot
        run: |
          zip -9 -r DR_SNAPSHOT.zip ./full-system
          du -m DR_SNAPSHOT.zip
      - name: ğŸ“¢ Final Summary
        run: echo "âœ… Enterprise Data Integration & Container Lifecycle Completed Successfully."
