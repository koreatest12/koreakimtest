name: "ğŸ¦ Financial Enterprise Core: Maven to Oracle Data Migration"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'

jobs:
  # 1. ë¹Œë“œ ë° ë°ì´í„° ìƒì„± ì„œë²„
  build-and-prep:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Maven Build & Data Prep
    outputs:
      artifact-path: ${{ steps.save.outputs.path }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Create Enterprise Structure
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] Oracle JDBC & Migration Driver
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [DataMigrator.java] Maven ë°ì´í„° -> Oracle ì´ê´€ í•µì‹¬ ë¡œì§
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/DataMigrator.java
          package com.bank.core;
          import java.sql.*;
          import java.util.*;

          public class DataMigrator {
              public static void main(String[] args) throws Exception {
                  // 1. Oracle ì„œë²„ ì¬ê¸°ë™ ì‹œë®¬ë ˆì´ì…˜
                  System.out.println("ğŸ”„ [SYS] Restarting Oracle Instance for Migration...");
                  
                  // 2. ì†ŒìŠ¤ ë°ì´í„°(Maven/H2) ë° íƒ€ê²Ÿ(Oracle) ì—°ê²°
                  Class.forName("org.h2.Driver");
                  Connection sourceConn = DriverManager.getConnection("jdbc:h2:mem:source_db;DB_CLOSE_DELAY=-1", "sa", "");
                  Connection oracleConn = DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");

                  // 3. ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
                  Statement srcStmt = sourceConn.createStatement();
                  srcStmt.execute("CREATE TABLE MAVEN_RAW (ID INT, VAL VARCHAR(255))");
                  
                  Statement oraStmt = oracleConn.createStatement();
                  oraStmt.execute("CREATE TABLE ORA_FINANCIAL_CORE (ORA_ID RAW(16) PRIMARY KEY, DATA_VAL VARCHAR2(255), MIGRATED_AT TIMESTAMP)");

                  // 4. ëŒ€ëŸ‰ ë°ì´í„° ìƒì„± (Maven side)
                  System.out.println("ğŸ“¦ [STEP 1] Generating 100,000 Maven Raw Records...");
                  PreparedStatement ps = sourceConn.prepareStatement("INSERT INTO MAVEN_RAW VALUES (?, ?)");
                  for(int i=0; i<100000; i++) {
                      ps.setInt(1, i);
                      ps.setString(2, "FIN-DATA-" + UUID.randomUUID());
                      ps.addBatch();
                      if(i % 10000 == 0) ps.executeBatch();
                  }
                  ps.executeBatch();

                  // 5. Oracleë¡œ ë°ì´í„° ì´ê´€ (Data Migration)
                  System.out.println("ğŸš€ [STEP 2] Migrating Data to Oracle Server...");
                  long start = System.currentTimeMillis();
                  ResultSet rs = srcStmt.executeQuery("SELECT * FROM MAVEN_RAW");
                  PreparedStatement oraPs = oracleConn.prepareStatement(
                      "INSERT INTO ORA_FINANCIAL_CORE VALUES (RANDOM_UUID(), ?, CURRENT_TIMESTAMP)");

                  int count = 0;
                  while(rs.next()) {
                      oraPs.setString(1, rs.getString("VAL"));
                      oraPs.addBatch();
                      if(++count % 10000 == 0) oraPs.executeBatch();
                  }
                  oraPs.executeBatch();
                  
                  System.out.println("âœ… [COMPLETED] 100,000 records migrated to Oracle in " + (System.currentTimeMillis()-start) + "ms");
              }
          }
          EOF

      - name: ğŸ”¨ Compile
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸš€ Execute Migration Server
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          java -cp "target/classes:target/dependency/*" com.bank.core.DataMigrator

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Maven to Oracle ETL Pipeline Integration [skip ci]" || echo "No changes"
          git push origin main
