name: "ğŸ¦ Financial Enterprise Core: Data Merge & Dependabot Automation"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request: # Dependabot ìë™ ìŠ¹ì¸ì„ ìœ„í•´ ì¶”ê°€

permissions:
  contents: write
  pull-requests: write # Dependabot ìŠ¹ì¸ ê¶Œí•œ

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'

jobs:
  # [ì¶”ê°€] 1. Dependabot ìë™ ìŠ¹ì¸ ë° ë³‘í•© ì‘ì—…
  dependabot-automation:
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: ğŸ¤– Fetch Dependabot Metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Approve Minor/Patch Updates
        if: ${{ steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”€ Enable Auto-Merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. ë©”ì¸ ì—”í„°í”„ë¼ì´ì¦ˆ ë°°í¬ ë° ë°ì´í„° ë³‘í•© ì‘ì—…
  enterprise-deployment:
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle & Container Data Merge
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17 & Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Core & Data Merge Logic
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] 
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [FinancialSystem.java] ë°ì´í„° ë³‘í•©(Merge) ë¡œì§ ì¶”ê°€
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              private static final String URL = "jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1";
              
              public static void main(String[] args) throws Exception {
                  Class.forName("org.h2.Driver");
                  try (Connection conn = DriverManager.getConnection(URL, "sa", "")) {
                      Statement stmt = conn.createStatement();
                      // 1. ì´ˆê¸° í…Œì´ë¸” ìƒì„± (ì„ì‹œ ì˜ì—­ ë° í†µí•© ì˜ì—­)
                      stmt.execute("CREATE TABLE IF NOT EXISTS RAW_STAGING (ID RAW(16), VAL NUMBER)");
                      stmt.execute("CREATE TABLE IF NOT EXISTS MERGED_LEDGER (ID RAW(16) PRIMARY KEY, TOTAL_VAL NUMBER, UPDATED_AT TIMESTAMP)");

                      // 2. ë°ì´í„° ì ì¬ ì‹œë®¬ë ˆì´ì…˜
                      System.out.println("ğŸ“¦ [STAGING] Loading 50,000 raw records...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO RAW_STAGING VALUES (RANDOM_UUID(), ?)");
                      for (int i = 0; i < 50000; i++) {
                          ps.setLong(1, (long)(Math.random() * 1000));
                          ps.addBatch();
                          if (i % 10000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();

                      // 3. ë°ì´í„° ë³‘í•©(Merge) ê¸°ëŠ¥ ìˆ˜í–‰ (Oracle MERGE ë¬¸ ìŠ¤íƒ€ì¼)
                      System.out.println("ğŸ”„ [MERGE] Consolidating staging data into Merged Ledger...");
                      long start = System.currentTimeMillis();
                      stmt.execute(
                          "INSERT INTO MERGED_LEDGER (ID, TOTAL_VAL, UPDATED_AT) " +
                          "SELECT ID, VAL, CURRENT_TIMESTAMP FROM RAW_STAGING"
                      );
                      
                      ResultSet rs = stmt.executeQuery("SELECT COUNT(*) FROM MERGED_LEDGER");
                      rs.next();
                      System.out.println("âœ… [SUCCESS] Data Merge Completed. Total Rows: " + rs.getInt(1) + " (" + (System.currentTimeMillis()-start) + "ms)");
                  }
              }
          }
          EOF

          # [Dockerfile]
          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          RUN mvn clean package -DskipTests && mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ Build & Dependency Export
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -B -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ³ Container Restart & Data Merge Simulation
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          echo "ğŸš€ First Run: Data Staging"
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest
          
          echo "ğŸ”„ Restarting Container for Data Consolidation..."
          docker restart ${{ env.CONTAINER_NAME }}
          docker logs ${{ env.CONTAINER_NAME }}

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Data Merge Logic & Dependabot Auto-Merge [skip ci]" || echo "No changes"
          git push origin main
