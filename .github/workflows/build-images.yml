name: "ğŸ¦ Financial Enterprise Core: Oracle Server Management"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'

jobs:
  oracle-lifecycle-mgmt:
    runs-on: ubuntu-latest
    name: ğŸ’ Oracle Instance Lifecycle & Migration
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Java & Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Oracle Core Files
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [pom.xml] Oracle & H2 Hybrid Environment
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          # [OracleServerManager.java] ì„œë²„ ì¬ê¸°ë™ ë° ìƒíƒœ ê´€ë¦¬ ë¡œì§
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/OracleServerManager.java
          package com.bank.core;
          import java.sql.*;

          public class OracleServerManager {
              public static void restartInstance() {
                  System.out.println("âš ï¸ [ORACLE-SYS] SHUTDOWN IMMEDIATE initiated...");
                  System.out.println("âš ï¸ [ORACLE-SYS] Waiting for active transactions to roll back...");
                  try { Thread.sleep(1000); } catch (Exception e) {}
                  
                  System.out.println("ğŸ”„ [ORACLE-SYS] Database closed. Database dismounted.");
                  System.out.println("ğŸ”„ [ORACLE-SYS] Oracle instance shut down.");
                  
                  System.out.println("ğŸš€ [ORACLE-SYS] STARTUP NOMOUNT...");
                  System.out.println("ğŸš€ [ORACLE-SYS] Oracle instance started (SGA/PGA Allocated).");
                  System.out.println("ğŸš€ [ORACLE-SYS] Database mounted and opened.");
                  System.out.println("âœ… [ORACLE-SYS] Oracle Server is now ONLINE.");
              }

              public static Connection getOracleConnection() throws Exception {
                  Class.forName("org.h2.Driver");
                  // Oracle Mode ì¸ë©”ëª¨ë¦¬ ì—°ê²°
                  return DriverManager.getConnection("jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1", "sa", "");
              }
          }
          EOF

          # [FinancialSystem.java] ì¬ê¸°ë™ í›„ ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  // 1. ì„œë²„ ì¬ê¸°ë™ ê¸°ëŠ¥ í˜¸ì¶œ
                  OracleServerManager.restartInstance();

                  // 2. ì¬ê¸°ë™ í›„ ë°ì´í„° ì—°ë™
                  try (Connection conn = OracleServerManager.getOracleConnection()) {
                      Statement stmt = conn.createStatement();
                      stmt.execute("CREATE TABLE ORA_LEDGER (TX_ID RAW(16) PRIMARY KEY, ACC_ID VARCHAR2(50), BAL NUMBER)");

                      System.out.println("ğŸ“¦ [DATA] Injecting 100,000 enterprise records after reboot...");
                      PreparedStatement ps = conn.prepareStatement("INSERT INTO ORA_LEDGER VALUES (RANDOM_UUID(), ?, ?)");
                      
                      long start = System.currentTimeMillis();
                      for (int i = 1; i <= 100000; i++) {
                          ps.setString(1, "ACC-" + i);
                          ps.setLong(2, (long)(Math.random() * 5000000));
                          ps.addBatch();
                          if (i % 10000 == 0) ps.executeBatch();
                      }
                      ps.executeBatch();
                      System.out.println("âœ… [SUCCESS] Batch load completed in " + (System.currentTimeMillis() - start) + "ms");
                  }
              }
          }
          EOF

      - name: ğŸ”¨ Build & Run Server
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          java -cp "target/classes:target/dependency/*" com.bank.core.FinancialSystem

      - name: ğŸš€ Sync Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Oracle Restart & Massive Data Integration [skip ci]" || echo "No changes"
          git push origin main
