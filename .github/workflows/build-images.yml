name: "üè¶ Financial Enterprise Core: DB, Concurrency & Security"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'financial-core/**'
      - 'reports/**'

permissions:
  contents: write
  packages: write
  security-events: write

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  RESOURCE_PATH: 'financial-core/src/main/resources'
  REPORT_DIR: 'reports'

jobs:
  financial-ops:
    runs-on: ubuntu-latest
    name: üí∏ FinOps & Resource Generation
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üèóÔ∏è Generate Enterprise Resources & Files
        run: |
          # ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ ÏÉùÏÑ±
          mkdir -p ${RESOURCE_PATH}/sql
          mkdir -p ${RESOURCE_PATH}/data
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          mkdir -p ${REPORT_DIR}

          # 1. [schema.sql] DB Ïä§ÌÇ§Îßà Î∂ÑÎ¶¨
          cat <<EOF > ${RESOURCE_PATH}/sql/schema.sql
          CREATE TABLE IF NOT EXISTS USERS (
              ID VARCHAR(50) PRIMARY KEY,
              PASSWORD_HASH VARCHAR(100),
              BALANCE BIGINT,
              STATUS VARCHAR(20) DEFAULT 'ACTIVE'
          );
          CREATE TABLE IF NOT EXISTS TRANSACTIONS (
              TX_ID UUID PRIMARY KEY,
              USER_ID VARCHAR(50),
              AMOUNT BIGINT,
              TS TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          EOF

          # 2. [app-config.properties] ÏÑúÎπÑÏä§ ÏÑ§Ï†ï ÌååÏùº
          cat <<EOF > ${RESOURCE_PATH}/app-config.properties
          db.url=jdbc:h2:mem:fin_db;DB_CLOSE_DELAY=-1
          db.user=sa
          db.password=
          system.batch.size=5000
          system.target.records=50000
          EOF

          # 3. [pom.xml] ÏùòÏ°¥ÏÑ± ÏÑ§Ï†ï
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
              </dependencies>
          </project>
          EOF

          # 4. [DatabaseManager.java] Î¶¨ÏÜåÏä§ Î°úÎìú Î°úÏßÅ Í∞úÏÑ†
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/DatabaseManager.java
          package com.bank.core;
          import java.sql.*;
          import java.nio.file.*;
          import java.io.InputStream;
          import java.util.Scanner;

          public class DatabaseManager {
              public static Connection getConnection() throws Exception {
                  Class.forName("org.h2.Driver");
                  return DriverManager.getConnection("jdbc:h2:mem:fin_db;DB_CLOSE_DELAY=-1", "sa", "");
              }
              public static void initSchema() throws Exception {
                  try (Connection conn = getConnection(); 
                       Statement stmt = conn.createStatement();
                       InputStream is = DatabaseManager.class.getResourceAsStream("/sql/schema.sql")) {
                      if (is == null) throw new RuntimeException("Schema file not found!");
                      String sql = new Scanner(is).useDelimiter("\\\\A").next();
                      stmt.execute(sql);
                  }
              }
          }
          EOF

          # 5. [FinancialSystem.java] ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              public static void main(String[] args) throws Exception {
                  DatabaseManager.initSchema();
                  System.out.println("üè¶ Database Schema Initialized from Resource File");
                  
                  int total = 50000;
                  int batchSize = 5000;
                  
                  try (Connection conn = DatabaseManager.getConnection()) {
                      conn.setAutoCommit(false);
                      PreparedStatement pstmt = conn.prepareStatement("INSERT INTO USERS (ID, PASSWORD_HASH, BALANCE) VALUES (?, ?, ?)");
                      
                      long start = System.currentTimeMillis();
                      for (int i = 1; i <= total; i++) {
                          pstmt.setString(1, "USR-" + UUID.randomUUID().toString().substring(0,8));
                          pstmt.setString(2, "HASH-" + i);
                          pstmt.setLong(3, 1000000);
                          pstmt.addBatch();
                          if (i % batchSize == 0) pstmt.executeBatch();
                      }
                      pstmt.executeBatch();
                      conn.commit();
                      System.out.println("‚úÖ Successfully injected " + total + " records in " + (System.currentTimeMillis() - start) + "ms");
                  }
              }
          }
          EOF

      - name: üèóÔ∏è Build & Execute
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          java -cp "target/classes:target/dependency/*" com.bank.core.FinancialSystem

      - name: üöÄ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "üè¶ Financial Core: Resource Separation & DB Optimization [skip ci]" || echo "No changes"
          git push origin main
