name: "ðŸ” Spring Boot JDBC CI + DB Test (V8 - Scale Load Test)"

on:
  push:
    branches: [ "main", "develop", "feature/**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL ìœ ì € (ê¸°ë³¸ root)"
        required: false
        default: "root"
      mysql_pass:
        description: "MySQL íŒ¨ìŠ¤ì›Œë“œ (ê¸°ë³¸ password)"
        required: false
        default: "password"
      mysql_db:
        description: "DBëª… (ê¸°ë³¸ mydb)"
        required: false
        default: "mydb"
      table_name:
        description: "í…ŒìŠ¤íŠ¸ í…Œì´ë¸”ëª… (ê¸°ë³¸ users)"
        required: false
        default: "users"
      scale_count:
        description: "ë°˜ë³µ í…ŒìŠ¤íŠ¸ íšŸìˆ˜ (SCALE)"
        required: false
        default: "50"

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  # ê¸°ë³¸ ìŠ¤ì¼€ì¼ ê°’ (ìž…ë ¥ì´ ì—†ìœ¼ë©´ ì´ ê°’ì„ ì‚¬ìš©)
  DEFAULT_SCALE: 50

jobs:
  build-and-test:
    name: "Build + MySQL Init + Spring Boot Test + JDBC Smoke Scale Test"
    runs-on: ubuntu-22.04
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: mydb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword --silent"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=20

    steps:
      #################################################################
      # 0. ì¤€ë¹„: ì²´í¬ì•„ì›ƒ + ë¡œê·¸ ë””ë ‰í† ë¦¬ í™•ë³´
      #################################################################
      - name: "[echo] Checkout repo"
        uses: actions/checkout@v4

      - name: "[echo] Prepare echo dirs (logs, artifacts)"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}"
          {
            echo "[$(date +'%F %T%z')] LOG_DIR=${LOG_DIR}"
            echo "[$(date +'%F %T%z')] ARTIFACT_DIR=${ARTIFACT_DIR}"
            echo "runner.os=$(uname -a)"
            echo "pwd=$(pwd)"
          } | tee "${LOG_DIR}/runner_info.log"

      #################################################################
      # 1. JDK / Maven ì„¸íŒ…
      #################################################################
      - name: "[echo] Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      #################################################################
      # 2. MySQL health ëŒ€ê¸°
      #################################################################
      - name: "[echo] Wait for MySQL service to be healthy"
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "Waiting for mysql service health..." | tee "${LOG_DIR}/mysql_wait.log"
          for i in {1..30}; do
            HEALTH=$(docker inspect --format='{{json .State.Health.Status}}' ${{ job.services.mysql.id }})
            echo "[$i] MySQL health: $HEALTH" | tee -a "${LOG_DIR}/mysql_wait.log"
            if [ "$HEALTH" = "\"healthy\"" ]; then
              echo "MySQL is healthy." | tee -a "${LOG_DIR}/mysql_wait.log"
              break
            fi
            sleep 2
          done

      #################################################################
      # 3. MySQL client ì„¤ì¹˜ + ìŠ¤í‚¤ë§ˆ ìƒì„±
      #################################################################
      - name: "[echo] Install MySQL client"
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y mysql-client

      - name: "[echo] Init schema (CREATE TABLE users)"
        shell: bash
        run: |
          set -Eeuo pipefail
          DB_USER="${{ github.event.inputs.mysql_user || 'root' }}"
          DB_PASS="${{ github.event.inputs.mysql_pass || 'password' }}"
          DB_NAME="${{ github.event.inputs.mysql_db   || 'mydb' }}"
          TBL="${{ github.event.inputs.table_name     || 'users' }}"
          
          SQL_CREATE="CREATE TABLE IF NOT EXISTS ${TBL} ( \
            id   INT AUTO_INCREMENT PRIMARY KEY, \
            name VARCHAR(100) NOT NULL, \
            age  INT NOT NULL \
          );"
          
          echo "[SCHEMA] Creating table '${TBL}' in DB '${DB_NAME}'..." | tee "${LOG_DIR}/mysql_schema_init.log"
          mysql -h 127.0.0.1 -P 3306 -u"${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" -e "${SQL_CREATE}" \
            2>&1 | tee -a "${LOG_DIR}/mysql_schema_init.log"
          
          mysql -h 127.0.0.1 -P 3306 -u"${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" -e "SHOW TABLES;" \
            2>&1 | tee -a "${LOG_DIR}/mysql_schema_init.log"

      #################################################################
      # 4. Maven Build & Spring Boot Test
      #################################################################
      - name: "[echo] mvn clean package (with DB env)"
        shell: bash
        run: |
          set -Eeuo pipefail
          DB_NAME="${{ github.event.inputs.mysql_db   || 'mydb' }}"
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/${DB_NAME}?useSSL=false&serverTimezone=UTC"
          export SPRING_DATASOURCE_USERNAME="${{ github.event.inputs.mysql_user || 'root' }}"
          export SPRING_DATASOURCE_PASSWORD="${{ github.event.inputs.mysql_pass || 'password' }}"
          
          mvn -B clean package 2>&1 | tee "${LOG_DIR}/maven_build.log"
          if [ "${PIPESTATUS[0]}" != "0" ]; then
             echo "Maven build failed" && exit 1
          fi

      #################################################################
      # 5. JDBC Driver ì¤€ë¹„ (Smoke Testìš©)
      #################################################################
      - name: "[echo] Prepare MySQL JDBC driver jar"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p tmp_jars
          mvn -q dependency:copy-dependencies \
            -DincludeArtifactIds=mysql-connector-j \
            -DoutputDirectory=tmp_jars \
            -DexcludeTransitive=false
          ls -l tmp_jars | tee "${LOG_DIR}/jdbc_jars.log"

      #################################################################
      # 6. JDBC Smoke Test ì»¨í…Œì´ë„ˆ (SCALE ì ìš©)
      #   - SCALE ê°’ë§Œí¼ Java ë‚´ë¶€ì—ì„œ Loop ì‹¤í–‰
      #   - Syntax Error ë°©ì§€ë¥¼ ìœ„í•´ heredoc ëŒ€ì‹  printf ì‚¬ìš© ìœ ì§€
      #################################################################
      - name: "[echo] JDBC Smoke Container (SCALE Loop Test)"
        shell: bash
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          DB_USER="${{ github.event.inputs.mysql_user || 'root' }}"
          DB_PASS="${{ github.event.inputs.mysql_pass || 'password' }}"
          DB_NAME="${{ github.event.inputs.mysql_db   || 'mydb' }}"
          # ìž…ë ¥ê°’ ì—†ìœ¼ë©´ ê¸°ë³¸ env ê°’ ì‚¬ìš©
          SCALE_VAL="${{ github.event.inputs.scale_count || env.DEFAULT_SCALE }}"
          
          DB_URL="jdbc:mysql://host.docker.internal:3306/${DB_NAME}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true"
          
          echo "[SMOKE] Generating Java Source with SCALE=${SCALE_VAL}..." | tee "${LOG_DIR}/smoke_container.log"

          rm -f JdbcSmokeTest.java
          touch JdbcSmokeTest.java
          
          # -----------------------------------------------------------------------------------------
          # Java ì†ŒìŠ¤ ì½”ë“œ ì£¼ìž… (Shell ë³€ìˆ˜ $SCALE_VALì„ Java Code ìƒìˆ˜ë¡œ ë°•ì•„ë„£ê±°ë‚˜ envë¡œ ì²˜ë¦¬ ê°€ëŠ¥)
          # ì—¬ê¸°ì„œëŠ” Runtimeì— í™˜ê²½ë³€ìˆ˜ SCALEì„ ì½ë„ë¡ ì²˜ë¦¬í•¨.
          # -----------------------------------------------------------------------------------------
          printf "%s\n" "import java.sql.*;" >> JdbcSmokeTest.java
          printf "%s\n" "import java.util.*;" >> JdbcSmokeTest.java
          printf "%s\n" "" >> JdbcSmokeTest.java
          printf "%s\n" "public class JdbcSmokeTest {" >> JdbcSmokeTest.java
          printf "%s\n" "    public static void main(String[] args) throws Exception {" >> JdbcSmokeTest.java
          printf "%s\n" "        String url  = System.getenv(\"DB_URL\");" >> JdbcSmokeTest.java
          printf "%s\n" "        String user = System.getenv(\"DB_USER\");" >> JdbcSmokeTest.java
          printf "%s\n" "        String pass = System.getenv(\"DB_PASS\");" >> JdbcSmokeTest.java
          printf "%s\n" "        String scaleStr = System.getenv(\"SCALE\");" >> JdbcSmokeTest.java
          printf "%s\n" "        int scale = (scaleStr != null) ? Integer.parseInt(scaleStr) : 1;" >> JdbcSmokeTest.java
          printf "%s\n" "" >> JdbcSmokeTest.java
          printf "%s\n" "        System.out.println(\"[SMOKE] Connecting to: \" + url);" >> JdbcSmokeTest.java
          printf "%s\n" "        System.out.println(\"[SMOKE] Target SCALE count: \" + scale);" >> JdbcSmokeTest.java
          printf "%s\n" "" >> JdbcSmokeTest.java
          printf "%s\n" "        Class.forName(\"com.mysql.cj.jdbc.Driver\");" >> JdbcSmokeTest.java
          printf "%s\n" "" >> JdbcSmokeTest.java
          printf "%s\n" "        // 1. Connection Retry Logic" >> JdbcSmokeTest.java
          printf "%s\n" "        Connection conn = null;" >> JdbcSmokeTest.java
          printf "%s\n" "        for (int i = 1; i <= 10; i++) {" >> JdbcSmokeTest.java
          printf "%s\n" "            try {" >> JdbcSmokeTest.java
          printf "%s\n" "                conn = DriverManager.getConnection(url, user, pass);" >> JdbcSmokeTest.java
          printf "%s\n" "                System.out.println(\"[SMOKE] Connected successfully!\");" >> JdbcSmokeTest.java
          printf "%s\n" "                break;" >> JdbcSmokeTest.java
          printf "%s\n" "            } catch (SQLException e) {" >> JdbcSmokeTest.java
          printf "%s\n" "                System.out.println(\"[SMOKE] Retry \" + i + \" failed: \" + e.getMessage());" >> JdbcSmokeTest.java
          printf "%s\n" "                Thread.sleep(1000);" >> JdbcSmokeTest.java
          printf "%s\n" "            }" >> JdbcSmokeTest.java
          printf "%s\n" "        }" >> JdbcSmokeTest.java
          printf "%s\n" "        if (conn == null) throw new RuntimeException(\"DB Connection Failed\");" >> JdbcSmokeTest.java
          printf "%s\n" "" >> JdbcSmokeTest.java
          printf "%s\n" "        // 2. Massive Scale Loop" >> JdbcSmokeTest.java
          printf "%s\n" "        try (Connection c = conn) {" >> JdbcSmokeTest.java
          printf "%s\n" "            long startTime = System.currentTimeMillis();" >> JdbcSmokeTest.java
          printf "%s\n" "            for (int k = 1; k <= scale; k++) {" >> JdbcSmokeTest.java
          printf "%s\n" "                // INSERT" >> JdbcSmokeTest.java
          printf "%s\n" "                try (PreparedStatement pstmt = c.prepareStatement(\"INSERT INTO users (name, age) VALUES (?, ?)\")) {" >> JdbcSmokeTest.java
          printf "%s\n" "                    pstmt.setString(1, \"User_\" + k);" >> JdbcSmokeTest.java
          printf "%s\n" "                    pstmt.setInt(2, new Random().nextInt(100));" >> JdbcSmokeTest.java
          printf "%s\n" "                    pstmt.executeUpdate();" >> JdbcSmokeTest.java
          printf "%s\n" "                }" >> JdbcSmokeTest.java
          printf "%s\n" "                // SELECT (Log every 10th)" >> JdbcSmokeTest.java
          printf "%s\n" "                if (k % 10 == 0 || k == scale) {" >> JdbcSmokeTest.java
          printf "%s\n" "                    try (PreparedStatement pstmt = c.prepareStatement(\"SELECT count(*) from users\")) {" >> JdbcSmokeTest.java
          printf "%s\n" "                         ResultSet rs = pstmt.executeQuery();" >> JdbcSmokeTest.java
          printf "%s\n" "                         if(rs.next()) System.out.println(\"[SMOKE-LOOP] \" + k + \"/\" + scale + \" committed. Total rows: \" + rs.getInt(1));" >> JdbcSmokeTest.java
          printf "%s\n" "                    }" >> JdbcSmokeTest.java
          printf "%s\n" "                }" >> JdbcSmokeTest.java
          printf "%s\n" "            }" >> JdbcSmokeTest.java
          printf "%s\n" "            long duration = System.currentTimeMillis() - startTime;" >> JdbcSmokeTest.java
          printf "%s\n" "            System.out.println(\"[SMOKE] DONE. Duration: \" + duration + \"ms\");" >> JdbcSmokeTest.java
          printf "%s\n" "        }" >> JdbcSmokeTest.java
          printf "%s\n" "    }" >> JdbcSmokeTest.java
          printf "%s\n" "}" >> JdbcSmokeTest.java
          
          echo "[SMOKE] Compilation & Run..." | tee -a "${LOG_DIR}/smoke_container.log"
          
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -e DB_URL="${DB_URL}" \
            -e DB_USER="${DB_USER}" \
            -e DB_PASS="${DB_PASS}" \
            -e SCALE="${SCALE_VAL}" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/tmp_jars:/jars:ro" \
            -w /app \
            openjdk:17-jdk \
            bash -lc '
              javac -cp .:/jars/* JdbcSmokeTest.java
              java -cp .:/jars/* JdbcSmokeTest
            ' 2>&1 | tee -a "${LOG_DIR}/smoke_container.log"

      #################################################################
      # 7. ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      #################################################################
      - name: "[echo] Collect & Upload Artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spring-ci-artifacts-${{ github.run_id }}
          path: |
            ${{ env.LOG_DIR }}
            ${{ env.ARTIFACT_DIR }}
            target/surefire-reports
