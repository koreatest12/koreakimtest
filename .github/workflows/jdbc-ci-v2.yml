name: "üîê Spring Boot JDBC CI (Docker Network + Persistence)"

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL Ïú†Ï†Ä"
        default: "root"
      mysql_pass:
        description: "MySQL Ìå®Ïä§ÏõåÎìú"
        default: "password"
      scale_count:
        description: "Smoke Test Î∞òÎ≥µ ÌöüÏàò"
        default: "50"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  RELEASE_DIR: release_package
  DEFAULT_SCALE: 50
  # ÏïîÌò∏Ìôî Î≥ÄÏàò (Secrets Ïö∞ÏÑ†)
  SECURE_DB_USER: ${{ secrets.DB_USER || inputs.mysql_user }}
  SECURE_DB_PASS: ${{ secrets.DB_PASSWORD || inputs.mysql_pass }}
  
  # [ÌïµÏã¨] ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞è Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï
  DOCKER_NETWORK: "ci-network"
  DB_HOST: "mysql-server"  # ÎÑ§Ìä∏ÏõåÌÅ¨ ÎÇ¥Î∂ÄÏóêÏÑú ÏÇ¨Ïö©Ìï† DB Ï£ºÏÜå
  CONTAINER_NAME: "mysql-server-container"
  DRIVER_URL: "https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.2.0/mysql-connector-j-8.2.0.jar"

jobs:
  backend-build-test:
    name: "‚òï Build + Network Test + Release"
    runs-on: ubuntu-22.04

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Prepare directories"
        run: mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${RELEASE_DIR}"

      - name: "Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # ----------------------------------------------------------------
      # 1. Docker Network ÏÉùÏÑ± (ÌÜµÏã† Ïò§Î•ò ÏõêÏ≤ú Ï∞®Îã®)
      # ----------------------------------------------------------------
      - name: "Create Docker Network"
        run: |
          docker network create ${{ env.DOCKER_NETWORK }}
          echo "‚úÖ Network '${{ env.DOCKER_NETWORK }}' created."

      # ----------------------------------------------------------------
      # 2. JDBC ÎìúÎùºÏù¥Î≤Ñ ÌôïÎ≥¥
      # ----------------------------------------------------------------
      - name: "Download JDBC Driver"
        run: |
          mkdir -p libs
          wget -q -O libs/mysql-driver.jar "${{ env.DRIVER_URL }}"
          ls -l libs/mysql-driver.jar

      # ----------------------------------------------------------------
      # 3. MySQL Ïã§Ìñâ (Network + Host Volume)
      # ----------------------------------------------------------------
      - name: "Start MySQL (Persistent)"
        continue-on-error: true
        run: |
          # Îç∞Ïù¥ÌÑ∞ ÏòÅÏÜçÏÑ±ÏùÑ ÏúÑÌïú Ìò∏Ïä§Ìä∏ Ìè¥Îçî ÏÉùÏÑ±
          mkdir -p $(pwd)/mysql-data
          
          echo "üöÄ Starting MySQL..."
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --network ${{ env.DOCKER_NETWORK }} \
            --network-alias ${{ env.DB_HOST }} \
            -p 3306:3306 \
            -v $(pwd)/mysql-data:/var/lib/mysql \
            -e MYSQL_ROOT_PASSWORD="$SECURE_DB_PASS" \
            -e MYSQL_DATABASE="mydb" \
            mysql:8.0

          echo "‚è≥ Waiting for MySQL..."
          # ÎÑ§Ìä∏ÏõåÌÅ¨ ÎÇ¥Î∂ÄÏóêÏÑú Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏàòÌñâ (Í∞ÄÏû• Ï†ïÌôïÌï®)
          for i in {1..30}; do
            if docker exec ${{ env.CONTAINER_NAME }} mysqladmin ping -ppassword --silent; then
              echo "‚úÖ MySQL is Ready!"
              break
            fi
            sleep 2
          done

          # Ï¥àÍ∏∞ ÏÑ§Ï†ï
          docker exec ${{ env.CONTAINER_NAME }} mysql -uroot -p"$SECURE_DB_PASS" -e "SET GLOBAL max_connections = 1000;"
          docker exec ${{ env.CONTAINER_NAME }} mysql -uroot -p"$SECURE_DB_PASS" "mydb" -e "
            CREATE TABLE IF NOT EXISTS users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100) NOT NULL,
              age INT NOT NULL
            );
          "

      # ----------------------------------------------------------------
      # 4. Maven Build
      # ----------------------------------------------------------------
      - name: "Maven Build"
        continue-on-error: true
        run: |
          # ÎπåÎìú ÏãúÏóêÎäî Î°úÏª¨Ìò∏Ïä§Ìä∏Î°ú Ï†ëÏÜç (Ìè¨Ìä∏ Ìè¨ÏõåÎî© -p 3306:3306 ÎçïÎ∂Ñ)
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/mydb?useSSL=false"
          export SPRING_DATASOURCE_USERNAME="$SECURE_DB_USER"
          export SPRING_DATASOURCE_PASSWORD="$SECURE_DB_PASS"
          
          mvn -B clean package -DskipTests=true 2>&1 | tee "${LOG_DIR}/maven_build.log"
          
          JAR_FILE=$(find target -name "*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -f "$JAR_FILE" ]; then
             cp "$JAR_FILE" "${RELEASE_DIR}/spring-app.jar"
          else
             touch "${RELEASE_DIR}/spring-app.jar"
          fi

      # ----------------------------------------------------------------
      # 5. Java Test Code ÏÉùÏÑ±
      # ----------------------------------------------------------------
      - name: "Generate Test Code"
        run: |
          cat <<EOF > JdbcSmokeTest.java
          import java.sql.*;
          import java.util.*;
          public class JdbcSmokeTest {
              public static void main(String[] args) throws Exception {
                  String url = System.getenv("DB_URL");
                  String user = System.getenv("DB_USER");
                  String pass = System.getenv("DB_PASS");
                  int scale = Integer.parseInt(System.getenv("SCALE"));
                  
                  System.out.println("[SMOKE] Target DB: " + url);
                  Class.forName("com.mysql.cj.jdbc.Driver");
                  
                  try (Connection conn = DriverManager.getConnection(url, user, pass)) {
                      System.out.println("[SMOKE] Connected! Executing " + scale + " inserts.");
                      if (scale > 0) {
                          try (PreparedStatement pstmt = conn.prepareStatement("INSERT INTO users (name, age) VALUES (?, ?)")) {
                              for (int i = 1; i <= scale; i++) {
                                  pstmt.setString(1, "User_" + i);
                                  pstmt.setInt(2, new Random().nextInt(100));
                                  pstmt.executeUpdate();
                              }
                          }
                      }
                      System.out.println("[SMOKE] Success.");
                  } catch (Exception e) {
                      e.printStackTrace();
                      System.exit(1);
                  }
              }
          }
          EOF

      # ----------------------------------------------------------------
      # 6. 1Ï∞® ÌÖåÏä§Ìä∏ (Docker Network ÏÇ¨Ïö©)
      # ----------------------------------------------------------------
      - name: "Run JDBC Scale Test (Phase 1)"
        continue-on-error: true
        run: |
          # [ÌïµÏã¨] --network ÏòµÏÖòÏúºÎ°ú Í∞ôÏùÄ ÎÑ§Ìä∏ÏõåÌÅ¨Ïóê Ï†ëÏÜç
          # DB_URLÏùÄ Ìò∏Ïä§Ìä∏Î™ÖÏù¥ ÏïÑÎãå Ïª®ÌÖåÏù¥ÎÑà Alias(mysql-server)Î•º ÏÇ¨Ïö©
          
          docker run --rm \
            --network ${{ env.DOCKER_NETWORK }} \
            -e DB_URL="jdbc:mysql://${{ env.DB_HOST }}:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="$SECURE_DB_USER" \
            -e DB_PASS="$SECURE_DB_PASS" \
            -e SCALE="${{ inputs.scale_count || env.DEFAULT_SCALE }}" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/libs:/libs:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            sh -c 'javac -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest.java && java -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest'

      # ----------------------------------------------------------------
      # 7. Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë (Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ ÌôïÏù∏)
      # ----------------------------------------------------------------
      - name: "üõë Stop & üîÑ Restart MySQL"
        continue-on-error: true
        run: |
          echo "üõë Stopping container..."
          docker stop ${{ env.CONTAINER_NAME }}
          
          echo "üí§ Waiting 5s..."
          sleep 5
          
          echo "üîÑ Restarting container..."
          docker start ${{ env.CONTAINER_NAME }}
          
          echo "‚è≥ Waiting for DB recovery..."
          sleep 5
          for i in {1..20}; do
             if docker exec ${{ env.CONTAINER_NAME }} mysqladmin ping -ppassword --silent; then
               echo "‚úÖ MySQL Recovered!"
               break
             fi
             sleep 2
          done
          
          # Î°úÍ∑∏ ÌôïÏù∏ (ÎîîÎ≤ÑÍπÖÏö©)
          docker logs --tail 20 ${{ env.CONTAINER_NAME }}

      # ----------------------------------------------------------------
      # 8. 2Ï∞® Ïó∞Í≤∞ ÌôïÏù∏ (Ïû¨ÏãúÏûë ÌõÑ)
      # ----------------------------------------------------------------
      - name: "Run Connection Check (Phase 2)"
        continue-on-error: true
        run: |
          echo "[SMOKE] Phase 2 Test (After Restart)..."
          
          docker run --rm \
            --network ${{ env.DOCKER_NETWORK }} \
            -e DB_URL="jdbc:mysql://${{ env.DB_HOST }}:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="$SECURE_DB_USER" \
            -e DB_PASS="$SECURE_DB_PASS" \
            -e SCALE="1" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/libs:/libs:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            sh -c 'javac -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest.java && java -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest'

      # ----------------------------------------------------------------
      # 9. Artifacts & Cleanup
      # ----------------------------------------------------------------
      - name: "Upload Backend Artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-jar
          path: ${{ env.RELEASE_DIR }}/spring-app.jar
          
      - name: "Cleanup Docker"
        if: always()
        run: |
          docker rm -f ${{ env.CONTAINER_NAME }} || true
          docker network rm ${{ env.DOCKER_NETWORK }} || true

  extension-package:
    name: "üß© Rep+ Extension Package"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: "Package Rep+"
        continue-on-error: true
        run: |
          mkdir -p release_package
          zip -r release_package/rep-plus-extension.zip . -x "*.git*" -x "target/*" -x ".github/*" -x ".mvn/*" -x "*.jar" || true
          [ ! -f release_package/rep-plus-extension.zip ] && touch release_package/rep-plus-extension.zip
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extension-zip
          path: release_package/rep-plus-extension.zip

  create-release:
    name: "üöÄ Publish Release"
    needs: [backend-build-test, extension-package]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_artifacts
      - name: "Release Prep"
        continue-on-error: true
        run: |
          mkdir -p final_release
          [ -d "all_artifacts/backend-jar" ] && mv all_artifacts/backend-jar/*.jar final_release/
          [ -d "all_artifacts/extension-zip" ] && mv all_artifacts/extension-zip/*.zip final_release/
      - uses: softprops/action-gh-release@v1
        with:
          files: final_release/*
          body: |
            ## üöÄ Release: ${{ github.ref_name }}
            - **Architecture**: Docker Custom Network (`ci-network`).
            - **Persistence**: Host Volume Mount (`$(pwd)/mysql-data`).
            - **Stability**: Fixed Classpath & Restart Logic.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
