name: "ğŸ” Spring Boot CI (Compose V2 + Internal Network)"

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL ìœ ì €"
        default: "root"
      mysql_pass:
        description: "MySQL íŒ¨ìŠ¤ì›Œë“œ"
        default: "password"
      scale_count:
        description: "Smoke Test ë°˜ë³µ íšŸìˆ˜"
        default: "50"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  # ë””ë ‰í† ë¦¬ ì •ì˜
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  RELEASE_DIR: release_package
  INVENTORY_DIR: service_inventory
  DATA_DIR: ci-data
  
  # ì•”í˜¸í™” ë³€ìˆ˜
  SECURE_DB_USER: ${{ secrets.DB_USER || inputs.mysql_user }}
  SECURE_DB_PASS: ${{ secrets.DB_PASSWORD || inputs.mysql_pass }}
  DRIVER_URL: "https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.2.0/mysql-connector-j-8.2.0.jar"
  
  # ë„¤íŠ¸ì›Œí¬ ì´ë¦„ ì •ì˜
  COMPOSE_PROJECT_NAME: "ci_stack"

jobs:
  backend-orchestration:
    name: "â˜• Orchestration & Inventory Check"
    runs-on: ubuntu-22.04

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Prepare Directories"
        run: |
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${RELEASE_DIR}" "${INVENTORY_DIR}" "${DATA_DIR}"
          # ë°ì´í„° ë””ë ‰í† ë¦¬ ê¶Œí•œ ë¯¸ë¦¬ í™•ë³´
          mkdir -p "${DATA_DIR}/primary" "${DATA_DIR}/replica"
          chmod -R 777 "${DATA_DIR}"
          echo "âœ… Directories Created."

      - name: "Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # ----------------------------------------------------------------
      # 1. Docker Compose íŒŒì¼ ìƒì„± (Healthcheck & Network í¬í•¨)
      # ----------------------------------------------------------------
      - name: "Generate Docker Compose"
        run: |
          cat <<EOF > docker-compose.yml
          version: '3.8'
          
          networks:
            # ëª…ì‹œì  ë„¤íŠ¸ì›Œí¬ ì´ë¦„ ì„¤ì •
            ci-network:
              name: ci-network
              driver: bridge

          services:
            # [Service 1] Main Database
            mysql-primary:
              image: mysql:8.0
              container_name: ci-mysql-primary
              ports:
                - "3306:3306"
              environment:
                MYSQL_ROOT_PASSWORD: "${SECURE_DB_PASS}"
                MYSQL_DATABASE: "mydb"
              volumes:
                - ./${DATA_DIR}/primary:/var/lib/mysql
              networks:
                - ci-network
              command: --max_connections=1000
              # ìì²´ í—¬ìŠ¤ì²´í¬ ì¶”ê°€
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${SECURE_DB_USER}", "-p${SECURE_DB_PASS}"]
                interval: 5s
                timeout: 3s
                retries: 10

            # [Service 2] Replica Database
            mysql-replica:
              image: mysql:8.0
              container_name: ci-mysql-replica
              ports:
                - "3307:3306"
              environment:
                MYSQL_ROOT_PASSWORD: "${SECURE_DB_PASS}"
                MYSQL_DATABASE: "mydb_replica"
              volumes:
                - ./${DATA_DIR}/replica:/var/lib/mysql
              networks:
                - ci-network

            # [Service 3] Redis Cache
            redis-cache:
              image: redis:alpine
              container_name: ci-redis
              ports:
                - "6379:6379"
              networks:
                - ci-network
          EOF
          
          echo "ğŸ“„ docker-compose.yml generated."

      # ----------------------------------------------------------------
      # 2. ì„œë¹„ìŠ¤ ì‹¤í–‰ (docker compose v2 ëª…ë ¹ì–´ ì‚¬ìš©)
      # ----------------------------------------------------------------
      - name: "ğŸš€ Start Services (Compose V2)"
        run: |
          echo "Starting Stack..."
          # [ìˆ˜ì •] docker-compose -> docker compose (í•˜ì´í”ˆ ì œê±°)
          docker compose up -d
          
          echo "â³ Waiting for Healthchecks..."
          # docker compose wait ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì¤ë‹ˆë‹¤.
          # í•˜ì§€ë§Œ êµ¬ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ ì§ì ‘ loop ì²´í¬
          
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' ci-mysql-primary 2>/dev/null || echo "starting")
            echo "[$i] Primary Status: $STATUS"
            if [ "$STATUS" == "healthy" ]; then
              echo "âœ… MySQL Primary is HEALTHY!"
              break
            fi
            sleep 2
          done

      # ----------------------------------------------------------------
      # 3. ì¸ë²¤í† ë¦¬ ì ì¬ (ë””ë ‰í† ë¦¬ì— ì •ë³´ ì €ì¥)
      # ----------------------------------------------------------------
      - name: "ğŸ“‚ Archive Service Inventory"
        continue-on-error: true
        run: |
          echo "Archiving Container Data..."
          
          # 1. ì „ì²´ í”„ë¡œì„¸ìŠ¤ ëª©ë¡
          docker compose ps -a > "${INVENTORY_DIR}/compose_ps.txt"
          
          # 2. ê°œë³„ ì„œë¹„ìŠ¤ ìƒì„¸ ì •ë³´ ë° ë¡œê·¸ (ë°˜ë³µë¬¸ ì²˜ë¦¬)
          SERVICES=("ci-mysql-primary" "ci-mysql-replica" "ci-redis")
          
          for SVC in "${SERVICES[@]}"; do
            echo "Archiving $SVC..."
            if docker ps -q -f name=$SVC > /dev/null; then
               docker inspect $SVC > "${INVENTORY_DIR}/${SVC}_inspect.json"
               docker logs $SVC > "${INVENTORY_DIR}/${SVC}.log" 2>&1
            else
               echo "âš ï¸ $SVC not found running." > "${INVENTORY_DIR}/${SVC}_error.txt"
            fi
          done
          
          # 3. ë„¤íŠ¸ì›Œí¬ ì •ë³´
          docker network inspect ci-network > "${INVENTORY_DIR}/network_inspect.json"
          
          ls -R "${INVENTORY_DIR}"

      # ----------------------------------------------------------------
      # 4. Maven Build & Driver
      # ----------------------------------------------------------------
      - name: "Download Driver & Build"
        run: |
          mkdir -p libs
          wget -q -O libs/mysql-driver.jar "${{ env.DRIVER_URL }}"
          
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/mydb?useSSL=false"
          export SPRING_DATASOURCE_USERNAME="$SECURE_DB_USER"
          export SPRING_DATASOURCE_PASSWORD="$SECURE_DB_PASS"
          
          mvn -B clean package -DskipTests=true 2>&1 | tee "${LOG_DIR}/maven_build.log"
          
          JAR_FILE=$(find target -name "*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -f "$JAR_FILE" ]; then
             cp "$JAR_FILE" "${RELEASE_DIR}/spring-app.jar"
          else
             touch "${RELEASE_DIR}/spring-app.jar"
          fi

      # ----------------------------------------------------------------
      # 5. Java Test (Internal Network ì‚¬ìš©)
      # ----------------------------------------------------------------
      - name: "Run Test (Inside Network)"
        continue-on-error: true
        run: |
          cat <<EOF > JdbcSmokeTest.java
          import java.sql.*;
          import java.util.*;
          public class JdbcSmokeTest {
              public static void main(String[] args) throws Exception {
                  String url = System.getenv("DB_URL");
                  String user = System.getenv("DB_USER");
                  String pass = System.getenv("DB_PASS");
                  int scale = Integer.parseInt(System.getenv("SCALE"));
                  
                  System.out.println("[SMOKE] Target: " + url);
                  Class.forName("com.mysql.cj.jdbc.Driver");
                  
                  try (Connection conn = DriverManager.getConnection(url, user, pass)) {
                      System.out.println("[SMOKE] Connected via Internal Network!");
                      
                      Statement stmt = conn.createStatement();
                      stmt.execute("CREATE TABLE IF NOT EXISTS users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(100), age INT)");
                      
                      try (PreparedStatement pstmt = conn.prepareStatement("INSERT INTO users (name, age) VALUES (?, ?)")) {
                          for (int i = 1; i <= scale; i++) {
                              pstmt.setString(1, "User_" + i);
                              pstmt.setInt(2, new Random().nextInt(100));
                              pstmt.executeUpdate();
                          }
                      }
                      System.out.println("[SMOKE] Success: " + scale + " rows inserted.");
                  }
              }
          }
          EOF

          # [í•µì‹¬ ìˆ˜ì •]
          # 1. --network ci-network: í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆë¥¼ DBì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ë„£ìŠµë‹ˆë‹¤.
          # 2. mysql-primary: localhost ëŒ€ì‹  ì„œë¹„ìŠ¤ ì´ë¦„(DNS)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          
          docker run --rm \
            --network ci-network \
            -e DB_URL="jdbc:mysql://ci-mysql-primary:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="$SECURE_DB_USER" \
            -e DB_PASS="$SECURE_DB_PASS" \
            -e SCALE="${{ inputs.scale_count || 50 }}" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/libs:/libs:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            sh -c 'javac -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest.java && java -cp ".:/libs/mysql-driver.jar" JdbcSmokeTest'

      # ----------------------------------------------------------------
      # 6. ì¬ì‹œì‘ ë° ë°ì´í„° ê²€ì¦
      # ----------------------------------------------------------------
      - name: "ğŸ”„ Restart Stack (Persistence Check)"
        continue-on-error: true
        run: |
          echo "Restarting via Docker Compose..."
          # [ìˆ˜ì •] docker compose ëª…ë ¹ì–´ ì‚¬ìš©
          docker compose restart
          
          echo "â³ Waiting for Health status..."
          sleep 10
          
          # ì¬ì‹œì‘ í›„ì—ë„ ë°ì´í„° íŒŒì¼ì´ ë‚¨ì•„ìˆëŠ”ì§€ ë¬¼ë¦¬ì ìœ¼ë¡œ í™•ì¸
          if [ -d "${DATA_DIR}/primary/sys" ]; then
             echo "âœ… Persistence Verified. Data files exist."
             ls -l "${DATA_DIR}/primary" | head -n 5
          else
             echo "âŒ Data missing!"
             exit 1
          fi

      # ----------------------------------------------------------------
      # 7. ì •ë¦¬ ë° ì—…ë¡œë“œ
      # ----------------------------------------------------------------
      - name: "Upload Full Artifacts"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-package-artifacts
          path: |
            ${{ env.RELEASE_DIR }}/*.jar
            ${{ env.INVENTORY_DIR }}/*
            
      - name: "Cleanup"
        if: always()
        run: docker compose down -v

  extension-package:
    name: "ğŸ§© Rep+ Extension Package"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: "Package Rep+"
        continue-on-error: true
        run: |
          mkdir -p release_package
          zip -r release_package/rep-plus-extension.zip . -x "*.git*" -x "target/*" -x ".github/*" -x ".mvn/*" -x "*.jar" || true
          [ ! -f release_package/rep-plus-extension.zip ] && touch release_package/rep-plus-extension.zip
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extension-zip
          path: release_package/rep-plus-extension.zip

  create-release:
    name: "ğŸš€ Publish Release"
    needs: [backend-orchestration, extension-package]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_artifacts
      - name: "Release Prep"
        continue-on-error: true
        run: |
          mkdir -p final_release
          [ -d "all_artifacts/full-package-artifacts" ] && mv all_artifacts/full-package-artifacts/* final_release/
          [ -d "all_artifacts/extension-zip" ] && mv all_artifacts/extension-zip/*.zip final_release/
      - uses: softprops/action-gh-release@v1
        with:
          files: final_release/*
          body: |
            ## ğŸš€ Massive Release: ${{ github.ref_name }}
            - **Tech Stack**: Docker Compose V2, MySQL 8, Redis.
            - **Persistence**: Verified data survival after restart.
            - **Inventory**: Logs and Inspect data archived.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
