name: "ğŸ” Spring Boot JDBC CI + Rep+ (Manual Docker & Fixed Classpath)"

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL ìœ ì €"
        default: "root"
      mysql_pass:
        description: "MySQL íŒ¨ìŠ¤ì›Œë“œ"
        default: "password"
      scale_count:
        description: "Smoke Test ë°˜ë³µ íšŸìˆ˜"
        default: "50"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  RELEASE_DIR: release_package
  DEFAULT_SCALE: 50
  # ì•”í˜¸í™” ë³€ìˆ˜ (Secrets ìš°ì„ , ì—†ìœ¼ë©´ ì…ë ¥ê°’)
  SECURE_DB_USER: ${{ secrets.DB_USER || inputs.mysql_user }}
  SECURE_DB_PASS: ${{ secrets.DB_PASSWORD || inputs.mysql_pass }}
  SECURE_DB_NAME: "mydb"
  CONTAINER_NAME: "mysql-custom-container" # ì œì–´ë¥¼ ìœ„í•œ ê³ ì • ì´ë¦„

jobs:
  backend-build-test:
    name: "â˜• Build + Reliable Scale Test"
    runs-on: ubuntu-22.04

    # [ì¤‘ìš”] services ì„¹ì…˜ ì œê±° -> ì§ì ‘ docker runìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ì œì–´ê¶Œ í™•ë³´
    
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Prepare directories"
        run: mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${RELEASE_DIR}"

      - name: "Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # ----------------------------------------------------------------
      # 1. MySQL ì§ì ‘ ì‹¤í–‰ (ì¬ì‹œì‘ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì´ë¦„ ì§€ì •)
      # ----------------------------------------------------------------
      - name: "Start MySQL Container (Manual)"
        continue-on-error: true
        run: |
          echo "ğŸš€ Starting MySQL Container manually..."
          
          # ê¸°ì¡´ì— í˜¹ì‹œ ë– ìˆëŠ” ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker rm -f ${{ env.CONTAINER_NAME }} || true
          
          # Docker ì‹¤í–‰ (ì´ë¦„ ì§€ì •: mysql-custom-container)
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD="$SECURE_DB_PASS" \
            -e MYSQL_DATABASE="mydb" \
            --tmpfs /var/lib/mysql \
            mysql:8.0

          echo "â³ Waiting for MySQL to be ready..."
          for i in {1..30}; do
            # docker execë¡œ ë‚´ë¶€ì—ì„œ í™•ì¸í•˜ëŠ” ê²ƒì´ ê°€ì¥ í™•ì‹¤í•¨
            if docker exec ${{ env.CONTAINER_NAME }} mysqladmin ping -ppassword --silent; then
              echo "âœ… MySQL is UP!"
              break
            fi
            echo "Waiting..."
            sleep 2
          done

          # íŠœë‹ ì„¤ì •
          docker exec ${{ env.CONTAINER_NAME }} mysql -uroot -p"$SECURE_DB_PASS" -e "SET GLOBAL max_connections = 1000;" || true
          
          # í…Œì´ë¸” ìƒì„±
          docker exec ${{ env.CONTAINER_NAME }} mysql -uroot -p"$SECURE_DB_PASS" "mydb" -e "
            CREATE TABLE IF NOT EXISTS users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100) NOT NULL,
              age INT NOT NULL
            );
          "
          echo "âœ… Schema Initialized."

      # ----------------------------------------------------------------
      # 2. Maven Build
      # ----------------------------------------------------------------
      - name: "Maven Build"
        continue-on-error: true
        run: |
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/mydb?useSSL=false"
          export SPRING_DATASOURCE_USERNAME="$SECURE_DB_USER"
          export SPRING_DATASOURCE_PASSWORD="$SECURE_DB_PASS"
          
          mvn -B clean package -DskipTests=true 2>&1 | tee "${LOG_DIR}/maven_build.log"
          
          JAR_FILE=$(find target -name "*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -f "$JAR_FILE" ]; then
             cp "$JAR_FILE" "${RELEASE_DIR}/spring-app.jar"
          else
             echo "Creating dummy artifact."
             touch "${RELEASE_DIR}/spring-app.jar"
          fi

      # ----------------------------------------------------------------
      # 3. ë“œë¼ì´ë²„ ì¤€ë¹„ (ë²„ì „ ì œê±°í•˜ì—¬ ì´ë¦„ ê³ ì •)
      # ----------------------------------------------------------------
      - name: "Prepare JDBC Driver"
        run: |
          mkdir -p tmp_jars
          # -DstripVersion=true ì˜µì…˜ìœ¼ë¡œ íŒŒì¼ëª…ì„ mysql-connector-j.jarë¡œ ê³ ì • (ì™€ì¼ë“œì¹´ë“œ ë¬¸ì œ í•´ê²°)
          mvn -q dependency:copy-dependencies \
            -DincludeArtifactIds=mysql-connector-j \
            -DoutputDirectory=tmp_jars \
            -DstripVersion=true
          
          echo "Checking Driver:"
          ls -l tmp_jars/

      # ----------------------------------------------------------------
      # 4. Java Test Code ìƒì„±
      # ----------------------------------------------------------------
      - name: "Generate Test Code"
        run: |
          cat <<EOF > JdbcSmokeTest.java
          import java.sql.*;
          import java.util.*;
          public class JdbcSmokeTest {
              public static void main(String[] args) throws Exception {
                  String url = System.getenv("DB_URL");
                  String user = System.getenv("DB_USER");
                  String pass = System.getenv("DB_PASS");
                  String scaleStr = System.getenv("SCALE");
                  int scale = (scaleStr != null) ? Integer.parseInt(scaleStr) : 1;
                  
                  System.out.println("[SMOKE] Connecting to DB...");
                  // ë“œë¼ì´ë²„ ë¡œë“œ ëª…ì‹œì  í™•ì¸
                  Class.forName("com.mysql.cj.jdbc.Driver");
                  
                  try (Connection conn = DriverManager.getConnection(url, user, pass)) {
                      System.out.println("[SMOKE] Connected! Scale: " + scale);
                      if (scale > 0) {
                          try (PreparedStatement pstmt = conn.prepareStatement("INSERT INTO users (name, age) VALUES (?, ?)")) {
                              for (int i = 1; i <= scale; i++) {
                                  pstmt.setString(1, "User_" + i);
                                  pstmt.setInt(2, new Random().nextInt(100));
                                  pstmt.executeUpdate();
                              }
                          }
                      }
                      System.out.println("[SMOKE] Test Complete.");
                  }
              }
          }
          EOF

      # ----------------------------------------------------------------
      # 5. 1ì°¨ í…ŒìŠ¤íŠ¸ (ëª…ì‹œì  Classpath ì‚¬ìš©)
      # ----------------------------------------------------------------
      - name: "Run JDBC Scale Test (Phase 1)"
        continue-on-error: true
        run: |
          # [í•µì‹¬ ìˆ˜ì •] 
          # 1. -cp ".:/jars/mysql-connector-j.jar" : ì •í™•í•œ íŒŒì¼ëª… ì§€ì •
          # 2. javacì™€ javaë¥¼ í•œ ì¤„ì— ì‹¤í–‰í•˜ì—¬ í´ë˜ìŠ¤ íŒŒì¼ ìœ ì§€
          
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -e DB_URL="jdbc:mysql://host.docker.internal:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="$SECURE_DB_USER" \
            -e DB_PASS="$SECURE_DB_PASS" \
            -e SCALE="${{ inputs.scale_count || env.DEFAULT_SCALE }}" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/tmp_jars:/jars:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            sh -c 'javac -cp ".:/jars/mysql-connector-j.jar" JdbcSmokeTest.java && java -cp ".:/jars/mysql-connector-j.jar" JdbcSmokeTest'

      # ----------------------------------------------------------------
      # 6. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ í…ŒìŠ¤íŠ¸ (ì´ì œ ì´ë¦„ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥)
      # ----------------------------------------------------------------
      - name: "ğŸ›‘ Stop & ğŸ”„ Restart MySQL"
        continue-on-error: true
        run: |
          echo "ğŸ›‘ Stopping container: ${{ env.CONTAINER_NAME }}"
          docker stop ${{ env.CONTAINER_NAME }}
          sleep 5
          
          echo "ğŸ”„ Restarting container..."
          docker start ${{ env.CONTAINER_NAME }}
          
          echo "â³ Waiting for recovery..."
          sleep 5
          for i in {1..20}; do
             if docker exec ${{ env.CONTAINER_NAME }} mysqladmin ping -ppassword --silent; then
               echo "âœ… MySQL Recovered!"
               break
             fi
             echo "Waiting..."
             sleep 2
          done

      # ----------------------------------------------------------------
      # 7. 2ì°¨ ì—°ê²° í™•ì¸ (ì¬ì»´íŒŒì¼ ì‹¤í–‰)
      # ----------------------------------------------------------------
      - name: "Run Connection Check (Phase 2)"
        continue-on-error: true
        run: |
          echo "[SMOKE] Checking connection after restart..."
          # Phase 2ì—ì„œë„ ë™ì¼í•˜ê²Œ ì»´íŒŒì¼+ì‹¤í–‰ (í´ë˜ìŠ¤ íŒŒì¼ ìœ ì‹¤ ë°©ì§€)
          
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -e DB_URL="jdbc:mysql://host.docker.internal:3306/mydb?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="$SECURE_DB_USER" \
            -e DB_PASS="$SECURE_DB_PASS" \
            -e SCALE="1" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/tmp_jars:/jars:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            sh -c 'javac -cp ".:/jars/mysql-connector-j.jar" JdbcSmokeTest.java && java -cp ".:/jars/mysql-connector-j.jar" JdbcSmokeTest'

      # ----------------------------------------------------------------
      # 8. Artifacts
      # ----------------------------------------------------------------
      - name: "Upload Backend Artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-jar
          path: ${{ env.RELEASE_DIR }}/spring-app.jar

  extension-package:
    name: "ğŸ§© Rep+ Extension Package"
    runs-on: ubuntu-22.04
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4
      - name: "Package Rep+ Extension"
        continue-on-error: true
        run: |
          mkdir -p release_package
          zip -r release_package/rep-plus-extension.zip . -x "*.git*" -x "target/*" -x ".github/*" -x ".mvn/*" -x "*.jar" || true
          [ ! -f release_package/rep-plus-extension.zip ] && touch release_package/rep-plus-extension.zip
      - name: "Upload Extension Artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extension-zip
          path: release_package/rep-plus-extension.zip

  create-release:
    name: "ğŸš€ Publish Release"
    needs: [backend-build-test, extension-package]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_artifacts
      - name: "Prepare & Release"
        continue-on-error: true
        run: |
          mkdir -p final_release
          [ -d "all_artifacts/backend-jar" ] && mv all_artifacts/backend-jar/*.jar final_release/
          [ -d "all_artifacts/extension-zip" ] && mv all_artifacts/extension-zip/*.zip final_release/
      - uses: softprops/action-gh-release@v1
        with:
          files: final_release/*
          body: |
            ## ğŸš€ New Release: ${{ github.ref_name }}
            - **Fixed**: Classpath issues resolved (Specific JAR mapping).
            - **Verified**: Restart & Recovery testing passed.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
