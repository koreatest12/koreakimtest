name: "ğŸ” Spring Boot JDBC CI + Release (Scale Test V9)"

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*" ] # v1.0.0 ê°™ì€ íƒœê·¸ í‘¸ì‹œ ì‹œ ë¦´ë¦¬ì¦ˆ ë™ì‘
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL ìœ ì €"
        required: false
        default: "root"
      mysql_pass:
        description: "MySQL íŒ¨ìŠ¤ì›Œë“œ"
        required: false
        default: "password"
      mysql_db:
        description: "DBëª…"
        required: false
        default: "mydb"
      scale_count:
        description: "Smoke Test ë°˜ë³µ íšŸìˆ˜ (SCALE)"
        required: false
        default: "50"

# ë¦´ë¦¬ì¦ˆ ìƒì„±ì„ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í•„ìš”
permissions:
  contents: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  RELEASE_DIR: release_package
  DEFAULT_SCALE: 50

jobs:
  build-test-release:
    name: "Build + Scale Test + Release"
    runs-on: ubuntu-22.04
    
    # [ì„œë¹„ìŠ¤ ìµœì í™”] í…ŒìŠ¤íŠ¸ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ DB íŠœë‹
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: mydb
        ports:
          - 3306:3306
        # tmpfs ë§ˆìš´íŠ¸ë¡œ I/O ì†ë„ í–¥ìƒ ë° max_connections ì¦ê°€
        volumes:
          - /var/lib/mysql
        options: >-
          --tmpfs /var/lib/mysql
          --health-cmd="mysqladmin ping -ppassword --silent"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=20
          --max_connections=1000

    steps:
      # 

[Image of CI/CD pipeline architecture with database integration]

      
      #################################################################
      # 0. í™˜ê²½ ì¤€ë¹„
      #################################################################
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Prepare directories"
        run: |
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${RELEASE_DIR}"
          echo "Directories created."

      #################################################################
      # 1. JDK ì„¤ì •
      #################################################################
      - name: "Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      #################################################################
      # 2. MySQL ëŒ€ê¸° ë° ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
      #################################################################
      - name: "Wait for MySQL & Init Schema"
        shell: bash
        run: |
          set -Eeuo pipefail
          
          # Health Check ëŒ€ê¸° (Service ê¸°ëŠ¥ í™œìš©í•˜ì—¬ ê°„ë‹¨íˆ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë‚˜, ì´ì¤‘ í™•ì¸)
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -uroot -ppassword --silent; then
              echo "MySQL is up!"
              break
            fi
            sleep 2
          done

          # ë³€ìˆ˜ ë§¤í•‘
          DB_USER="${{ inputs.mysql_user || 'root' }}"
          DB_PASS="${{ inputs.mysql_pass || 'password' }}"
          DB_NAME="${{ inputs.mysql_db   || 'mydb' }}"
          
          # í…Œì´ë¸” ìƒì„± (ìŠ¤í‚¤ë§ˆ)
          echo "Creating table 'users'..."
          mysql -h 127.0.0.1 -P 3306 -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "
            CREATE TABLE IF NOT EXISTS users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100) NOT NULL,
              age INT NOT NULL
            );
          "

      #################################################################
      # 3. Maven Build (íŒ¨í‚¤ì§€ ìƒì„±)
      #################################################################
      - name: "Maven Build & Package"
        run: |
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/${{ inputs.mysql_db || 'mydb' }}?useSSL=false"
          export SPRING_DATASOURCE_USERNAME="${{ inputs.mysql_user || 'root' }}"
          export SPRING_DATASOURCE_PASSWORD="${{ inputs.mysql_pass || 'password' }}"
          
          mvn -B clean package -DskipTests=false 2>&1 | tee "${LOG_DIR}/maven_build.log"
          
          # JAR íŒŒì¼ í™•ë³´ (ë²„ì „ í¬í•¨ëœ íŒŒì¼ ì°¾ê¸°)
          JAR_FILE=$(find target -name "*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -f "$JAR_FILE" ]; then
            echo "Found artifact: $JAR_FILE"
            cp "$JAR_FILE" "${RELEASE_DIR}/app-release.jar"
          else
            echo "Error: JAR file not found!" && exit 1
          fi

      #################################################################
      # 4. JDBC Smoke Test (Docker ì»¨í…Œì´ë„ˆ ìˆ˜ì •ë¨)
      #################################################################
      - name: "Run JDBC Scale Test (Independent Container)"
        shell: bash
        run: |
          set -Eeuo pipefail
          
          # ë“œë¼ì´ë²„ ì¤€ë¹„
          mkdir -p tmp_jars
          mvn -q dependency:copy-dependencies -DincludeArtifactIds=mysql-connector-j -DoutputDirectory=tmp_jars

          # Java ì†ŒìŠ¤ ìƒì„± (ì´ì „ ë¡œì§ ìœ ì§€í•˜ë˜ ê°„ê²°í™”)
          cat <<EOF > JdbcSmokeTest.java
          import java.sql.*;
          import java.util.*;
          public class JdbcSmokeTest {
              public static void main(String[] args) throws Exception {
                  String url = System.getenv("DB_URL");
                  String user = System.getenv("DB_USER");
                  String pass = System.getenv("DB_PASS");
                  int scale = Integer.parseInt(System.getenv("SCALE"));
                  
                  System.out.println("[SMOKE] Connecting to " + url + " | SCALE: " + scale);
                  Class.forName("com.mysql.cj.jdbc.Driver");
                  
                  try (Connection conn = DriverManager.getConnection(url, user, pass)) {
                      System.out.println("[SMOKE] Connected!");
                      long start = System.currentTimeMillis();
                      
                      try (PreparedStatement pstmt = conn.prepareStatement("INSERT INTO users (name, age) VALUES (?, ?)")) {
                          for (int i = 1; i <= scale; i++) {
                              pstmt.setString(1, "User_" + i);
                              pstmt.setInt(2, new Random().nextInt(100));
                              pstmt.executeUpdate();
                              if (i % 10 == 0) System.out.println("[SMOKE] Inserted " + i + "/" + scale);
                          }
                      }
                      System.out.println("[SMOKE] Finished in " + (System.currentTimeMillis() - start) + "ms");
                  }
              }
          }
          EOF

          # [ìˆ˜ì •ë¨] Docker ì‹¤í–‰: ì´ë¯¸ì§€ ë³€ê²½ (openjdk:17-jdk -> eclipse-temurin:17-jdk)
          echo "Running Smoke Test in Docker..."
          docker run --rm \
            --add-host=host.docker.internal:host-gateway \
            -e DB_URL="jdbc:mysql://host.docker.internal:3306/${{ inputs.mysql_db || 'mydb' }}?useSSL=false&allowPublicKeyRetrieval=true" \
            -e DB_USER="${{ inputs.mysql_user || 'root' }}" \
            -e DB_PASS="${{ inputs.mysql_pass || 'password' }}" \
            -e SCALE="${{ inputs.scale_count || env.DEFAULT_SCALE }}" \
            -v "$(pwd)/JdbcSmokeTest.java:/app/JdbcSmokeTest.java" \
            -v "$(pwd)/tmp_jars:/jars:ro" \
            -w /app \
            eclipse-temurin:17-jdk \
            bash -c 'javac -cp .:/jars/* JdbcSmokeTest.java && java -cp .:/jars/* JdbcSmokeTest'

      #################################################################
      # 5. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ë° ë¦´ë¦¬ì¦ˆ (íŒ¨í‚¤ì§€ ì¶œì‹œ)
      #################################################################
      - name: "Upload Build Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            ${{ env.RELEASE_DIR }}/*.jar
            ${{ env.LOG_DIR }}/*.log

      - name: "Create GitHub Release (On Tag)"
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.RELEASE_DIR }}/app-release.jar
          body: |
            ## ğŸš€ New Release
            - Commit: ${{ github.sha }}
            - Time: ${{ steps.date.outputs.date }}
            - Scale Test Count: ${{ inputs.scale_count || env.DEFAULT_SCALE }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
