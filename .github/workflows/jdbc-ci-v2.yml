name: "ğŸ” Spring Boot JDBC CI + DB Test (V3 - Spring Boot)"

on:
  push:
    branches: [ "main", "develop", "feature/**" ]
  pull_request:
    branches: [ "main" ]
  # workflow_dispatch: 10ê°œ ì´í•˜ ìš”êµ¬ì‚¬í•­ ë§Œì¡± (ì´ 4ê°œ)
  workflow_dispatch:
    inputs:
      mysql_user:
        description: "MySQL ìœ ì € (ê¸°ë³¸ root)"
        required: false
        default: "root"
      mysql_pass:
        description: "MySQL íŒ¨ìŠ¤ì›Œë“œ (ê¸°ë³¸ password)"
        required: false
        default: "password"
      mysql_db:
        description: "DBëª… (ê¸°ë³¸ mydb)"
        required: false
        default: "mydb"
      table_name:
        description: "í…ŒìŠ¤íŠ¸ í…Œì´ë¸”ëª… (ê¸°ë³¸ users)"
        required: false
        default: "users"

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts

jobs:
  build-and-test:
    name: "Build + MySQL Init + Spring Boot Test"
    runs-on: ubuntu-22.04

    # GitHub Actionsì—ì„œ MySQL ì»¨í…Œì´ë„ˆë¥¼ ì„œë¹„ìŠ¤ë¡œ ë„ì›€
    services:
      mysql:
        image: mysql:8.0
        env:
          # ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œ ì‚¬ìš©í•  ê³ ì •ê°’ (dispatch inputì„ ì‚¬ìš©í•´ë„ ë¬´ë°©)
          MYSQL_ROOT_PASSWORD: password 
          MYSQL_DATABASE: mydb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -ppassword --silent"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=20

    steps:
      #################################################################
      # 0. ì¤€ë¹„: ì²´í¬ì•„ì›ƒ + ë¡œê·¸ ë””ë ‰í† ë¦¬ í™•ë³´
      #################################################################
      - name: "[echo] Checkout repo"
        uses: actions/checkout@v4

      - name: "[echo] Prepare echo dirs (logs, artifacts)"
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "[$(date +'%F %T%z')] mkdir -p ${LOG_DIR} ${ARTIFACT_DIR}"
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}"
          echo "runner.os=$(uname -a)"        | tee    "${LOG_DIR}/runner_info.log"
          echo "pwd=$(pwd)"                  | tee -a "${LOG_DIR}/runner_info.log"
          echo "ls -R top-level:"            | tee -a "${LOG_DIR}/runner_info.log"
          ls -R .                            | tee -a "${LOG_DIR}/runner_info.log"

      #################################################################
      # 1. JDK / Maven ì„¸íŒ…
      #################################################################
      - name: "[echo] Setup Temurin Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: "[echo] Show Java info"
        shell: bash
        run: |
          set -Eeuo pipefail
          java -version            | tee "${LOG_DIR}/java_version.log"
          mvn -v                   | tee "${LOG_DIR}/maven_version.log" || true

      #################################################################
      # 2. MySQL health ëŒ€ê¸° + ìŠ¤í‚¤ë§ˆ ìƒì„±
      #################################################################
      - name: "[echo] Wait for MySQL service to be healthy"
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "Waiting for mysql service health..."
          for i in {1..30}; do
            # ì„œë¹„ìŠ¤ IDë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ í—¬ìŠ¤ì²´í¬
            HEALTH=$(docker inspect --format='{{json .State.Health.Status}}' ${{ job.services.mysql.id }})
            echo "[$i] MySQL health: $HEALTH" | tee -a "${LOG_DIR}/mysql_wait.log"
            if [ "$HEALTH" = "\"healthy\"" ]; then
              echo "MySQL is healthy." | tee -a "${LOG_DIR}/mysql_wait.log"
              break
            fi
            sleep 2
          done

      - name: "[echo] Install MySQL client (for schema init)"
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y mysql-client
          mysql --version | tee "${LOG_DIR}/mysql_client_version.log"

      - name: "[echo] Init schema (CREATE TABLE users)"
        shell: bash
        run: |
          set -Eeuo pipefail
          # workflow_dispatch ì…ë ¥ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì„œë¹„ìŠ¤ì˜ ê³ ì •ê°’ ì‚¬ìš©
          DB_USER="${{ github.event.inputs.mysql_user || 'root' }}"
          DB_PASS="${{ github.event.inputs.mysql_pass || 'password' }}"
          DB_NAME="${{ github.event.inputs.mysql_db   || 'mydb' }}"
          TBL="${{ github.event.inputs.table_name     || 'users' }}"
          
          echo "Preparing schema for DB=${DB_NAME}, table=${TBL}" \
            | tee "${LOG_DIR}/mysql_schema_init.log"

          # EOF(heredoc) ëŒ€ì‹  -e í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•´ YAML ë“¤ì—¬ì“°ê¸° ë¬¸ì œë¥¼ ì›ì²œ ë°©ì§€
          SQL_CREATE="CREATE TABLE IF NOT EXISTS ${TBL} ( \
            id   INT AUTO_INCREMENT PRIMARY KEY, \
            name VARCHAR(100) NOT NULL, \
            age  INT NOT NULL \
          );"
          
          echo "Executing SQL: ${SQL_CREATE}" | tee -a "${LOG_DIR}/mysql_schema_init.log"
          
          # [Warning]ì€ mysql clientì˜ í‘œì¤€ ê²½ê³ ì´ë¯€ë¡œ ë¬´ì‹œí•©ë‹ˆë‹¤.
          mysql -h 127.0.0.1 -P 3306 -u"${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" -e "${SQL_CREATE}" \
            2>&1 | tee -a "${LOG_DIR}/mysql_schema_init.log"
          
          echo "---" | tee -a "${LOG_DIR}/mysql_schema_init.log"
          echo "Executing SQL: SHOW TABLES;" | tee -a "${LOG_DIR}/mysql_schema_init.log"
          
          mysql -h 127.0.0.1 -P 3306 -u"${DB_USER}" -p"${DB_PASS}" "${DB_NAME}" -e "SHOW TABLES;" \
            2>&1 | tee -a "${LOG_DIR}/mysql_schema_init.log"

      #################################################################
      # 3. Maven Build (Spring Boot Test í¬í•¨)
      #################################################################
      - name: "[echo] mvn -B clean package (Spring Boot Test with DB)"
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "[BUILD] mvn clean package start (with Test DB Context)" | tee "${LOG_DIR}/maven_build.log"
          
          # Spring Boot Testê°€ ì´ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì—¬ 127.0.0.1:3306 DBì— ì—°ê²°í•©ë‹ˆë‹¤.
          # (src/test/resources/application.propertiesë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ)
          export SPRING_DATASOURCE_URL="jdbc:mysql://127.0.0.1:3306/${{ github.event.inputs.mysql_db   || 'mydb' }}?useSSL=false&serverTimezone=UTC"
          export SPRING_DATASOURCE_USERNAME="${{ github.event.inputs.mysql_user || 'root' }}"
          export SPRING_DATASOURCE_PASSWORD="${{ github.event.inputs.mysql_pass || 'password' }}"

          echo "Injecting Spring Test Datasource:" | tee -a "${LOG_DIR}/maven_build.log"
          echo "SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}" | tee -a "${LOG_GDIR}/maven_build.log"
          echo "SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}" | tee -a "${LOG_DIR}/maven_build.log"

          # -B (ë°°ì¹˜ ëª¨ë“œ)ë¡œ ì‹¤í–‰. -q(quiet)ëŠ” ë¡œê·¸ë¥¼ ìœ„í•´ ì œê±°
          mvn -B clean package 2>&1 | tee -a "${LOG_DIR}/maven_build.log"
          
          BUILD_RC=${PIPESTATUS[0]}
          echo "[BUILD] mvn RC=${BUILD_RC}"      | tee -a "${LOG_DIR}/maven_build.log"
          if [ "${BUILD_RC}" != "0" ]; then
            echo "[BUILD] Maven build failed (Test failed or Compile error) âŒ" | tee -a "${LOG_DIR}/maven_build.log"
            exit 1
          else
            echo "[BUILD] Maven build OK (Test OK) âœ…"     | tee -a "${LOG_DIR}/maven_build.log"
          fi

      #################################################################
      # 4. ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì¦ì  ìˆ˜ì§‘)
      #################################################################
      - name: "[echo] Collect logs/artifacts (with Test Reports)"
        if: always() # ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "Copying logs into artifact dir..."
          cp -r "${LOG_DIR}" "${ARTIFACT_DIR}/logs" || true
          
          echo "Copying JARs into artifact dir..."
          mkdir -p "${ARTIFACT_DIR}/build_jars"
          find . -name "*.jar" -exec cp {} "${ARTIFACT_DIR}/build_jars" \; 2>/dev/null || true
          
          echo "Copying Maven test reports..."
          mkdir -p "${ARTIFACT_DIR}/test-reports"
          cp -r target/surefire-reports "${ARTIFACT_DIR}/test-reports" 2>/dev/null || true

      - name: "[echo] Upload echo logs & jars"
        if: always() # ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        uses: actions/upload-artifact@v4
        with:
            name: spring-ci-artifacts-${{ github.run_id }}
            path: ${{ env.ARTIFACT_DIR }}
            if-no-files-found: warn
