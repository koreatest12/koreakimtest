name: "ğŸš€ ì¢…í•© CI/CD íŒŒì´í”„ë¼ì¸ (Java + Python + DB + Docker + Security)"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  #########################################################
  # JOB 1: ë³´ì•ˆ ê²€ì‚¬ (CodeQL)
  #########################################################
  security-scan:
    name: "ğŸ›¡ï¸ Security Scan (CodeQL)"
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java', 'python' ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild (CodeCodeQL)
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  #########################################################
  # JOB 2: ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ë° íŒŒì¼ ìƒì„±
  #########################################################
  build-and-test:
    name: "ğŸ› ï¸ Build, Test, Cache & File Creation"
    runs-on: ubuntu-latest
    needs: security-scan

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: runner
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "ğŸ“„ ì„ì‹œ íŒŒì¼, ë””ë ‰í† ë¦¬ ë° ë”ë¯¸ ì´ë¯¸ì§€ ìƒì„±"
        run: |
          echo "ì„ì‹œ í´ë” ë° íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          mkdir -p tmp/temp-logs
          echo "ì„ì‹œ ë¡œê·¸ ë°ì´í„°" > tmp/temp-logs/app.log
          
          echo "ë°ì´í„° ë° ì—ì…‹ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
          mkdir -p data/processed
          mkdir -p assets/images
          
          echo "ë”ë¯¸ ì´ë¯¸ì§€ íŒŒì¼(ìë¦¬í‘œì‹œì)ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          touch assets/images/placeholder.png
          touch assets/images/logo.jpg
          
          echo "ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ì¶”ê°€ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          echo "ì´ê²ƒì€ ë¹Œë“œ ì •ë³´ íŒŒì¼ì…ë‹ˆë‹¤." > build-info.txt
          
          echo "--- ìƒì„±ëœ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ëª©ë¡ (ls -R) ---"
          ls -R
          echo "-------------------------------------------"

      # -----------------
      # Java (Maven) ì„¤ì •
      # -----------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and Test with Maven
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: testdb
          DB_USER: runner
          DB_PASSWORD: password
        run: |
          mvn -B package --file pom.xml
          mvn test

      - name: Submit Java Dependency Graph
        # ğŸš¨ [ì˜¤ë¥˜ ìˆ˜ì •] 'actions/' -> 'github/'ë¡œ ë³€ê²½
        uses: github/dependency-submission-action@v1 
        with:
          build-root-directory: ${{ github.workspace }}
          manifest-path: ${{ github.workspace }}/target/dependency-submission.json

      # -----------------
      # Python ì„¤ì •
      # -----------------
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache Pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Python Scripts (e.g., Data Pipeline)
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: testdb
          DB_USER: runner
          DB_PASSWORD: password
        run: |
          echo "íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          # python ./your_python_script.py
          echo "íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜)"

      - name: Submit Python Dependency Graph
        # ğŸš¨ [ì˜¤ë¥˜ ìˆ˜ì •] 'actions/' -> 'github/'ë¡œ ë³€ê²½
        uses: github/dependency-submission-action@v1
        with:
          build-root-directory: ${{ github.workspace }}
          manifest-path: ${{ github.workspace }}/requirements.txt

  #########################################################
  # JOB 3: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  #########################################################
  build-and-push-docker:
    name: "ğŸ³ Build and Push Docker Image"
    runs-on: ubuntu-latest
    needs: build-and-test

    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.java
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
