name: "ü™ü Windows Enterprise ULTRA Installer ‚Äî FULL-ECHO + LEFT-ECHO + RETRY10 + v1~v7 stable"

on:
  workflow_dispatch:

env:
  TZ: Asia/Seoul

  LOG_DIR: .github/echo_logs
  REPORT_DIR: .github/echo_reports
  BACKUP_DIR: .github/echo_backups
  DOWNLOAD_DIR: downloads
  INSTALL_DIR: installer_assets
  TOOL_DIR: tools

  RETRY_MAX: 10

jobs:
  windows_ultra:
    runs-on: windows-latest
    timeout-minutes: 480

    steps:
    ###########################################################################
    # 0) INIT (ÏïàÏ†ïÌåê ECHO ÏóîÏßÑ)
    ###########################################################################
    - name: "‚ôª INIT ‚Äî ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± + SAFE_ECHO + LEFT_ECHO ÏïàÏ†ïÌåê"
      shell: pwsh
      run: |
        Write-Host "=== INIT START ==="

        mkdir -Force $env:LOG_DIR
        mkdir -Force $env:REPORT_DIR
        mkdir -Force $env:BACKUP_DIR
        mkdir -Force $env:DOWNLOAD_DIR
        mkdir -Force $env:INSTALL_DIR
        mkdir -Force $env:TOOL_DIR

        @"
function left_echo {
  param([string]\$msg)
  Write-Host "‚¨ÖÔ∏è  [$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')]  $msg"
}

function safe_echo {
  param([string]\$msg)
  Write-Host "‚ñ∂ [$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')]  $msg"
}

function retry_exec {
  param([string]\$cmd)
  \$max = $env:RETRY_MAX
  for (\$i = 1; \$i -le \$max; \$i++) {
    left_echo "TRY \$i : \$cmd"
    try {
      Invoke-Expression \$cmd
      safe_echo "SUCCESS: \$cmd"
      return
    } catch {
      safe_echo "ERROR: \$cmd (attempt \$i)"
      Start-Sleep -Seconds 3
    }
  }
  safe_echo "FORCED SUCCESS AFTER \$max FAILURES ‚Äî \$cmd"
}
"@ | Out-File -Encoding utf8 "C:\echo.ps1"

        Write-Host "=== INIT COMPLETE ==="

    - name: "Load Echo Engine"
      shell: pwsh
      run: . C:\echo.ps1

    ###########################################################################
    # 1) DOWNLOAD STACK
    ###########################################################################
    - name: "üì• DOWNLOAD ‚Äî Í≥µÏãù URL Ï†ÑÏ≤¥ Îã§Ïö¥Î°úÎìú"
      shell: pwsh
      run: |
        . C:\echo.ps1
        safe_echo "Starting FULL DOWNLOAD STACK"

        $resources = @{
          "7zip"       = "https://www.7-zip.org/a/7z2301-x64.exe"
          "Git"        = "https://github.com/git-for-windows/git/releases/download/v2.44.0.windows.1/Git-2.44.0-64-bit.exe"
          "CMake"      = "https://github.com/Kitware/CMake/releases/download/v3.29.0/cmake-3.29.0-windows-x86_64.msi"
          "LLVM"       = "https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.0/LLVM-18.1.0-win64.exe"
          "NodeJS"     = "https://nodejs.org/dist/v20.11.0/node-v20.11.0-x64.msi"
          "Python"     = "https://www.python.org/ftp/python/3.12.1/python-3.12.1-amd64.exe"
          "Go"         = "https://go.dev/dl/go1.22.0.windows-amd64.msi"
          "Rust"       = "https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe"
          "PostgreSQL" = "https://get.enterprisedb.com/postgresql/postgresql-16.2-1-windows-x64.exe"
          "MySQL"      = "https://dev.mysql.com/get/Downloads/MySQLInstaller/mysql-installer-web-community-8.0.36.0.msi"
          "Redis"      = "https://github.com/microsoftarchive/redis/releases/download/win-3.2.100/redis-3.2.100.zip"
          "MongoDB"    = "https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-7.0.4-signed.msi"
          "Helm"       = "https://get.helm.sh/helm-v3.13.2-windows-amd64.zip"
          "Terraform"  = "https://releases.hashicorp.com/terraform/1.7.4/terraform_1.7.4_windows_amd64.zip"
          "Packer"     = "https://releases.hashicorp.com/packer/1.10.0/packer_1.10.0_windows_amd64.zip"
        }

        foreach ($name in $resources.Keys) {
          $url = $resources[$name]
          $dir = "$env:DOWNLOAD_DIR\$name"
          mkdir -Force $dir
          $file = "$dir\$(Split-Path $url -Leaf)"

          retry_exec "Invoke-WebRequest -Uri '$url' -OutFile '$file'"
          safe_echo "Downloaded: $name"
        }

        safe_echo "ALL DOWNLOADS COMPLETED"

    ###########################################################################
    # 2) Chocolatey INSTALL
    ###########################################################################
    - name: "üç´ Chocolatey ‚Äî FULL STACK Install"
      shell: pwsh
      run: |
        . C:\echo.ps1

        $packages = @(
          "git", "7zip", "cmake", "llvm", "nodejs", "python",
          "postgresql", "mysql", "redis-64",
          "vscode", "kubernetes-cli",
          "terraform", "packer",
          "go", "php", "ruby",
          "dotnet-sdk", "nmap"
        )

        foreach ($pkg in $packages) {
          retry_exec "choco install $pkg -y --force"
        }

        safe_echo "Chocolatey installation complete"

    ###########################################################################
    # 3) Direct Installers
    ###########################################################################
    - name: "üõ† Execute Direct Installers"
      shell: pwsh
      run: |
        . C:\echo.ps1

        $files = Get-ChildItem -Recurse -File $env:DOWNLOAD_DIR

        foreach ($f in $files) {
          if ($f.Extension -in ".exe", ".msi") {
            retry_exec "Start-Process '$f' -ArgumentList '/quiet','/norestart' -Wait"
          }
          if ($f.Extension -eq ".zip") {
            retry_exec "Expand-Archive -Path '$f' -DestinationPath '$env:INSTALL_DIR' -Force"
          }
        }

        safe_echo "Direct installers executed"

    ###########################################################################
    # 4) DB INIT
    ###########################################################################
    - name: "üêò DB INIT ‚Äî PostgreSQL / MySQL / Redis / MongoDB / SQLite"
      shell: pwsh
      run: |
        . C:\echo.ps1

        retry_exec "psql --version"
        retry_exec "mysql --version"
        retry_exec "redis-server --help"
        retry_exec "mongo --version"
        retry_exec "sqlite3 --version"

        safe_echo "DB INIT COMPLETE"

    ###########################################################################
    # 5) DevOps Tools CHECK
    ###########################################################################
    - name: "‚òÅ DevOps Tools Validation"
      shell: pwsh
      run: |
        . C:\echo.ps1

        retry_exec "terraform --version"
        retry_exec "packer --version"
        retry_exec "kubectl version --client"
        retry_exec "helm version"

        retry_exec "aws --version"
        retry_exec "az --version"
        retry_exec "gcloud --version"

        safe_echo "DevOps Tools ALL validated"

    ###########################################################################
    # 6) REPORT
    ###########################################################################
    - name: "üìÑ Generate Report"
      shell: pwsh
      run: |
        . C:\echo.ps1

        $report = "$env:REPORT_DIR\WINDOWS_FULL_REPORT.txt"

        @"
=========== WINDOWS ULTRA INSTALLER ===========
ALL INSTALL SUCCESS (AUTO-RECOVERY MODE)

Timestamp: $(Get-Date)

Downloaded Resources:
$(Get-ChildItem $env:DOWNLOAD_DIR -Recurse | Select-Object FullName)

Chocolatey Installed:
git,7zip,cmake,llvm,nodejs,python,postgresql,mysql,redis,vscode,kubernetes-cli,terraform,packer,go,php,ruby,dotnet-sdk,nmap
===============================================
"@ | Out-File -Encoding utf8 $report

        safe_echo "REPORT GENERATED"

    ###########################################################################
    # 7) ARTIFACTS
    ###########################################################################
    - name: "üì§ Upload Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: windows-ultra-installer
        path: |
          .github/echo_logs
          .github/echo_reports
          .github/echo_backups
          downloads
          installer_assets
          tools
