name: "ðŸš€ MCP Server Install & Copilot Sync"

on:
  push:
    paths:
      - 'mcp-python-server/**'
      - '.github/workflows/mcp-server-upgrade.yml'
      - '.mcp.json'
      - 'config/copilot/**'
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to use for MCP server validation'
        required: false
        default: '3.11'
      node_version:
        description: 'Node.js version for auxiliary MCP tooling'
        required: false
        default: '20'
      generate_copilot_summary:
        description: 'Also publish Copilot context summary as workflow output'
        type: boolean
        default: true

permissions:
  contents: read
  actions: read
  checks: write

env:
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts
  MCP_CONFIG: .github/mcp-workspace/config
  COPILOT_DIR: .github/copilot

jobs:
  prepare-and-validate:
    name: "Provision MCP Server"
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}

      - name: Install MCP server dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r mcp-python-server/requirements.txt
          pip install pytest

      - name: Compile MCP server modules
        run: |
          python -m compileall mcp-python-server

      - name: Run MCP server smoke tests
        run: |
          pytest mcp-python-server -k "not slow" --maxfail=1 --disable-warnings -q

      - name: Set up Node.js tooling
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'

      - name: Install MCP CLI helpers
        run: |
          npm install --global @modelcontextprotocol/inspector@latest

      - name: Prepare workspace directories
        run: |
          set -Eeuo pipefail
          mkdir -p "$MCP_WORKSPACE" "$MCP_ARTIFACTS" "$MCP_CONFIG" "$COPILOT_DIR"
          mkdir -p "$MCP_CONFIG/templates" "$MCP_CONFIG/snapshots" "$MCP_CONFIG/logs"
          echo "Created workspace directories:" | tee "$MCP_ARTIFACTS/structure.log"
          find "$MCP_WORKSPACE" -maxdepth 2 -type d | sort | tee -a "$MCP_ARTIFACTS/structure.log"

      - name: Generate MCP bootstrap files
        run: |
          set -Eeuo pipefail
          cat <<'JSON' > "$MCP_CONFIG/bootstrap.json"
          {
            "server": "python-utils",
            "entry_point": "mcp-python-server/server_mcp.py",
            "created_at": "${{ github.run_id }}",
            "description": "Autogenerated bootstrap configuration for GitHub Actions",
            "notes": [
              "Installs python requirements and compiles server modules",
              "Creates dedicated artifact directories for MCP data",
              "Intended for downstream tooling such as GitHub Copilot"
            ]
          }
          JSON

          cat <<'MD' > "$COPILOT_DIR/mcp-server-upgrade-summary.md"
          # MCP Server Upgrade Context

          - Workflow: `${{ github.workflow }}`
          - Run: `${{ github.run_id }}`
          - Python: `${{ steps.setup-python.outputs.python-version || inputs.python_version || '3.11' }}`
          - Node: `${{ inputs.node_version || '20' }}`
          - Artifacts Root: `$MCP_ARTIFACTS`

          Use this file to provide GitHub Copilot with fresh context about generated assets, directories, and bootstrap configuration so that follow-up automation can reference them without re-scanning the repository.
          MD

      - name: Upload MCP artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-bootstrap
          path: |
            $MCP_WORKSPACE
          retention-days: 7

      - name: Publish Copilot summary
        if: ${{ inputs.generate_copilot_summary != 'false' }}
        run: |
          echo "### MCP Server Upgrade" >> $GITHUB_STEP_SUMMARY
          echo "* Bootstrap: $MCP_CONFIG/bootstrap.json" >> $GITHUB_STEP_SUMMARY
          echo "* Copilot summary: $COPILOT_DIR/mcp-server-upgrade-summary.md" >> $GITHUB_STEP_SUMMARY
          echo "* Artifacts stored in $MCP_WORKSPACE" >> $GITHUB_STEP_SUMMARY

      - name: Upload Copilot hints as artifact
        if: ${{ inputs.generate_copilot_summary != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: copilot-context
          path: $COPILOT_DIR/mcp-server-upgrade-summary.md
          retention-days: 7

      - name: Cache MCP dependencies snapshot
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/pip
            ~/.npm
          key: mcp-${{ runner.os }}-${{ hashFiles('mcp-python-server/requirements.txt') }}-${{ inputs.node_version || '20' }}-${{ inputs.python_version || '3.11' }}
