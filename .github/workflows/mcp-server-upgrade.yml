name: "üöÄ Spring Super CI V6: MB-Optimized & Size Aware"

on:
  push:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Í∞ïÏ†ú Ï¢ÖÏÜçÏÑ± ÏóÖÎç∞Ïù¥Ìä∏'
        type: boolean
        default: false
      backup_retention:
        description: 'Î∞±ÏóÖ Î≥¥Í¥Ä Í∏∞Í∞Ñ(Ïùº)'
        default: '30'

env:
  # 1. ÏãúÏä§ÌÖú ÏÑ§Ï†ï
  APP_NAME: "finance-core-system"
  JAVA_VERSION: '17'
  DISTRIBUTION: 'temurin'
  TZ: 'Asia/Seoul'

  # 2. ÏÑúÎπÑÏä§ Ï†ïÏùò
  SERVICE_POSTGRES: "postgres:15-alpine"
  SERVICE_REDIS: "redis:7-alpine"
  SERVICE_KAFKA: "apache/kafka:latest"
  SERVICE_NGINX: "nginx:stable-alpine"

  # 3. Ï†àÎåÄ Í≤ΩÎ°ú ÏÑ§Ï†ï (ÏïàÏ†ÑÏÑ±)
  ROOT_DIR: "${{ github.workspace }}"
  ARTIFACT_DIR: "${{ github.workspace }}/super-artifacts"
  SERVICE_DIR: "${{ github.workspace }}/super-artifacts/services"
  BACKUP_DIR: "${{ github.workspace }}/super-artifacts/backup"
  AUDIT_LOG: "${{ github.workspace }}/audit-system.log"
  SIZE_REPORT: "${{ github.workspace }}/size_report_mb.txt"

permissions:
  contents: write
  packages: write

jobs:
  # ======================================================
  # JOB 1: ÏÑúÎπÑÏä§ Îã§Ïö¥Î°úÎìú, ÏïïÏ∂ï Î∞è MB Î¶¨Ìè¨ÌåÖ
  # ======================================================
  provision-services-mb:
    name: üì• Provision Services (MB Optimized)
    runs-on: ubuntu-latest
    steps:
      - name: üìù Initialize Logs & Directories
        run: |
          mkdir -p "${{ env.SERVICE_DIR }}"
          echo "[START] Workflow Initiated at $(date)" > "${{ env.AUDIT_LOG }}"
          echo "===== SIZE REPORT (MB) =====" > "${{ env.SIZE_REPORT }}"

      - name: üê≥ Download & Compress Services (MB Check)
        run: |
          echo "Downloading and Compressing Services..."
          
          IMAGES=("${{ env.SERVICE_POSTGRES }}" "${{ env.SERVICE_REDIS }}" "${{ env.SERVICE_KAFKA }}" "${{ env.SERVICE_NGINX }}")
          
          total_size=0
          
          for img in "${IMAGES[@]}"; do
            echo "Processing: $img"
            docker pull -q $img
            
            # ÌååÏùºÎ™Ö Î≥ÄÌôò
            SAFE_NAME=$(echo $img | tr '/:' '_')
            TARGET_FILE="${{ env.SERVICE_DIR }}/${SAFE_NAME}.tar.gz"
            
            # [ÏµúÏ†ÅÌôî] docker save Í≤∞Í≥ºÎ•º Î∞îÎ°ú gzipÏúºÎ°ú ÏïïÏ∂ï (MB Ï†àÏïΩ)
            docker save $img | gzip > "$TARGET_FILE"
            
            # [MB Î¶¨Ìè¨ÌåÖ] ÌååÏùº ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ (MB)
            SIZE_MB=$(du -m "$TARGET_FILE" | cut -f1)
            echo " - $SAFE_NAME: ${SIZE_MB} MB" >> "${{ env.SIZE_REPORT }}"
            echo "   -> Saved & Compressed: ${SIZE_MB} MB"
            
            # Ìï¥Ïãú ÏÉùÏÑ±
            sha256sum "$TARGET_FILE" >> "${{ env.SERVICE_DIR }}/checksums.txt"
            
            total_size=$((total_size + SIZE_MB))
          done
          
          echo "--------------------------------" >> "${{ env.SIZE_REPORT }}"
          echo "TOTAL SERVICE SIZE: ${total_size} MB" >> "${{ env.SIZE_REPORT }}"
          echo "‚úÖ Services Provisioned. Total: ${total_size} MB" >> "${{ env.AUDIT_LOG }}"

      - name: üì§ Upload Service Pack
        uses: actions/upload-artifact@v4
        with:
          name: service-pack-mb
          path: ${{ env.SERVICE_DIR }}

  # ======================================================
  # JOB 2: ÎπåÎìú, ÌÖåÏä§Ìä∏ Î∞è ÏïÑÌã∞Ìå©Ìä∏ Ïö©Îüâ Î∂ÑÏÑù
  # ======================================================
  build-and-analyze-mb:
    name: üî® Build & Analyze Size
    needs: provision-services-mb
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Source
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.DISTRIBUTION }}
          cache: 'maven'

      - name: üíæ Check Disk Before Build (MB)
        run: |
          FREE_MB=$(df -m . | awk 'NR==2 {print $4}')
          echo "Free Disk Space: ${FREE_MB} MB"
          echo "DISK_FREE_BEFORE: ${FREE_MB} MB" >> "${{ env.SIZE_REPORT }}"

      - name: üîÑ Check Updates & Build
        run: |
          # 1. ÏùòÏ°¥ÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ Ï≤¥ÌÅ¨
          mvn versions:display-dependency-updates > dependency-report.txt
          
          # 2. ÎπåÎìú (ÌÖåÏä§Ìä∏ Ïä§ÌÇµ)
          mvn clean package -DskipTests
          
          # 3. Í≤∞Í≥ºÎ¨º Ïù¥Îèô
          mkdir -p "${{ env.ARTIFACT_DIR }}/jar"
          cp target/*.jar "${{ env.ARTIFACT_DIR }}/jar/"

      - name: üìä Analyze Build Artifacts (MB)
        run: |
          echo "==== APP ARTIFACTS SIZES ====" >> "${{ env.SIZE_REPORT }}"
          
          cd "${{ env.ARTIFACT_DIR }}/jar"
          
          # JAR ÌååÏùº ÌÅ¨Í∏∞ MB Îã®ÏúÑ Ï∏°Ï†ï
          du -m *.jar | while read size name; do
            echo " - $name: ${size} MB" >> "${{ env.SIZE_REPORT }}"
          done
          
          TOTAL_JAR_MB=$(du -mc *.jar | tail -1 | cut -f1)
          echo "TOTAL JAR SIZE: ${TOTAL_JAR_MB} MB" >> "${{ env.SIZE_REPORT }}"
          
          # Ìï¥Ïãú ÏÉùÏÑ±
          sha256sum *.jar > checksum-app.sha256

      - name: üì§ Upload App Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: application-binaries-mb
          path: ${{ env.ARTIFACT_DIR }}/jar

      - name: üì§ Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            dependency-report.txt
            ${{ env.SIZE_REPORT }}

  # ======================================================
  # JOB 3: ÌÜµÌï© Î∞±ÏóÖ Î∞è ÏµúÏ¢Ö Ïö©Îüâ Î¶¨Ìè¨Ìä∏
  # ======================================================
  backup-master-mb:
    name: üíæ Master Backup (MB Report)
    needs: [provision-services-mb, build-and-analyze-mb]
    runs-on: ubuntu-latest
    steps:
      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./full-system-dump

      - name: üìù Merge Size Reports
        run: |
          mkdir -p "${{ env.BACKUP_DIR }}"
          # Í∞Å Ïû°ÏóêÏÑú ÏÉùÏÑ±Îêú Î¶¨Ìè¨Ìä∏ ÌÜµÌï© ÏãúÎèÑ (Ïó¨Í∏∞ÏÑúÎäî Îã§Ïö¥Î°úÎìúÎêú ÌååÏùº Í∏∞Î∞ò)
          find ./full-system-dump -name "size_report_mb.txt" -exec cat {} + > merged_size_report.txt || echo "No prior report found"

      - name: üì¶ Create Compressed DR Snapshot (MB Optimized)
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="DR_SNAPSHOT_${{ env.APP_NAME }}_${TIMESTAMP}.zip"
          BACKUP_PATH="${{ env.BACKUP_DIR }}/${BACKUP_NAME}"
          
          echo "Creating Master Backup..."
          
          # [ÏµúÏ†ÅÌôî] zip ÏïïÏ∂ïÎ•† ÏµúÎåÄ(-9) ÏÑ§Ï†ï
          zip -9 -r "$BACKUP_PATH" ./full-system-dump
          
          # [MB Î¶¨Ìè¨ÌåÖ] ÏµúÏ¢Ö Î∞±ÏóÖ ÌÅ¨Í∏∞ ÌôïÏù∏
          FINAL_SIZE_MB=$(du -m "$BACKUP_PATH" | cut -f1)
          
          echo "=================================="
          echo "   FINAL BACKUP SIZE: ${FINAL_SIZE_MB} MB"
          echo "=================================="
          
          # Î©îÌÉÄÎç∞Ïù¥ÌÑ∞Ïóê ÏÇ¨Ïù¥Ï¶à Í∏∞Î°ù
          echo "Backup Date: $(date)" > "${{ env.BACKUP_DIR }}/meta_info.txt"
          echo "Total Size: ${FINAL_SIZE_MB} MB" >> "${{ env.BACKUP_DIR }}/meta_info.txt"
          
          # 2GB(2048MB) Ï¥àÍ≥º Ïãú Í≤ΩÍ≥†
          if [ "$FINAL_SIZE_MB" -gt 2048 ]; then
             echo "‚ö†Ô∏è WARNING: Backup size exceeds 2GB!"
          fi

      - name: ‚òÅÔ∏è Upload Final Backup
        uses: actions/upload-artifact@v4
        with:
          name: secure-dr-backup-mb
          path: ${{ env.BACKUP_DIR }}
          retention-days: ${{ github.event.inputs.backup_retention }}

      - name: üì¢ Final Summary
        run: |
          echo "‚úÖ Workflow Completed."
          echo "Check 'secure-dr-backup-mb' artifact for the full package."
