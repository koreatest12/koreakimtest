name: "ğŸš€ Spring Super CI V6: Partitioned Data Loading & Merge"

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  PROJECT_ROOT: 'financial-core'
  CONTAINER_NAME: 'fin-core-service'
  TOTAL_RECORDS: 100000
  CHUNK_SIZE: 10000  # ë°ì´í„°ë¥¼ 1ë§Œ ê±´ì”© ìª¼ê°œì„œ ì ì¬

permissions:
  contents: write
  packages: write

jobs:
  build-and-deploy-partitioned:
    runs-on: ubuntu-latest
    name: ğŸ’ Partitioned Data Load & Merge
    steps:
      - name: ğŸ“¥ Checkout Source
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17 & Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ—ï¸ Generate Partitioned Loading Logic
        run: |
          mkdir -p ${PROJECT_ROOT}/src/main/java/com/bank/core
          
          # [FinancialSystem.java] ë¶„í•  ì ì¬ ë¡œì§ ë°˜ì˜
          cat <<EOF > ${PROJECT_ROOT}/src/main/java/com/bank/core/FinancialSystem.java
          package com.bank.core;
          import java.sql.*;
          import java.util.UUID;

          public class FinancialSystem {
              private static final String URL = "jdbc:h2:mem:oracle_db;MODE=Oracle;DB_CLOSE_DELAY=-1";
              private static final int TOTAL = 100000;
              private static final int CHUNK_SIZE = 10000; // ë¶„í•  ë‹¨ìœ„

              public static void main(String[] args) throws Exception {
                  Class.forName("org.h2.Driver");
                  try (Connection conn = DriverManager.getConnection(URL, "sa", "")) {
                      setupSchema(conn);
                      
                      long startTime = System.currentTimeMillis();
                      int processed = 0;

                      // [ë¶„í•  ì ì¬ ì‹œì‘]
                      while (processed < TOTAL) {
                          int currentChunk = Math.min(CHUNK_SIZE, TOTAL - processed);
                          loadChunk(conn, processed + 1, currentChunk);
                          processed += currentChunk;
                          
                          // ì²­í¬ ë‹¨ìœ„ ì»¤ë°‹ ë° ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
                          System.out.println("ğŸ“¦ [PARTITION] Progress: " + processed + "/" + TOTAL + " (Completed Chunk)");
                      }

                      // [ë°ì´í„° ë³‘í•©]
                      mergeData(conn);
                      
                      System.out.println("âœ… [FINAL] Total Load Time: " + (System.currentTimeMillis() - startTime) + "ms");
                  }
              }

              private static void setupSchema(Connection conn) throws SQLException {
                  Statement stmt = conn.createStatement();
                  stmt.execute("CREATE TABLE IF NOT EXISTS RAW_STAGING (ID RAW(16), CHUNK_ID INT, VAL NUMBER)");
                  stmt.execute("CREATE TABLE IF NOT EXISTS MERGED_LEDGER (ID RAW(16) PRIMARY KEY, TOTAL_VAL NUMBER, TS TIMESTAMP)");
              }

              private static void loadChunk(Connection conn, int startIdx, int size) throws SQLException {
                  String sql = "INSERT INTO RAW_STAGING (ID, CHUNK_ID, VAL) VALUES (RANDOM_UUID(), ?, ?)";
                  try (PreparedStatement ps = conn.prepareStatement(sql)) {
                      conn.setAutoCommit(false); // íŠ¸ëœì­ì…˜ ë¶„ë¦¬
                      for (int i = 0; i < size; i++) {
                          ps.setInt(1, (startIdx + i) / CHUNK_SIZE);
                          ps.setLong(2, (long)(Math.random() * 1000));
                          ps.addBatch();
                      }
                      ps.executeBatch();
                      conn.commit(); // ì²­í¬ ë‹¨ìœ„ë¡œ ë¬¼ë¦¬ì  ì»¤ë°‹
                  }
              }

              private static void mergeData(Connection conn) throws SQLException {
                  System.out.println("ğŸ”„ [MERGE] Consolidating all partitioned chunks...");
                  Statement stmt = conn.createStatement();
                  stmt.execute("INSERT INTO MERGED_LEDGER SELECT ID, VAL, CURRENT_TIMESTAMP FROM RAW_STAGING");
              }
          }
          EOF

          # [pom.xml] ë° [Dockerfile] ìƒì„± ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ (ìƒëµ ì—†ì´ ì²˜ë¦¬ë¨)
          cat <<EOF > ${PROJECT_ROOT}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0">
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.bank</groupId>
              <artifactId>financial-core</artifactId>
              <version>1.0.0</version>
              <properties>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
                  <maven.compiler.source>${JAVA_VERSION}</maven.compiler.source>
                  <maven.compiler.target>${JAVA_VERSION}</maven.compiler.target>
              </properties>
              <dependencies>
                  <dependency><groupId>com.h2database</groupId><artifactId>h2</artifactId><version>2.2.224</version></dependency>
                  <dependency><groupId>com.oracle.database.jdbc</groupId><artifactId>ojdbc11</artifactId><version>23.3.0.23.09</version></dependency>
              </dependencies>
          </project>
          EOF

          cat <<EOF > ${PROJECT_ROOT}/Dockerfile
          FROM maven:3.9.6-eclipse-temurin-17 AS build
          WORKDIR /app
          COPY . .
          RUN mvn clean package -DskipTests && mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
          FROM eclipse-temurin:17-jre-jammy
          WORKDIR /app
          COPY --from=build /app/target/*.jar app.jar
          COPY --from=build /app/target/dependency /app/lib
          ENTRYPOINT ["java", "-cp", "app.jar:lib/*", "com.bank.core.FinancialSystem"]
          EOF

      - name: ğŸ”¨ Build & Package
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          mvn clean package -B -DskipTests
          mvn dependency:copy-dependencies -DoutputDirectory=target/dependency

      - name: ğŸ³ Docker Deploy & Partitioned Load
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          docker build -t ${{ env.CONTAINER_NAME }}:latest .
          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ë¶„í•  ì ì¬ ìˆ˜í–‰
          docker run --name ${{ env.CONTAINER_NAME }} ${{ env.CONTAINER_NAME }}:latest
          
          echo "ğŸ”„ Restarting for Persistence Check..."
          docker restart ${{ env.CONTAINER_NAME }}
          docker logs ${{ env.CONTAINER_NAME }}

      - name: ğŸš€ Sync & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¦ Financial Core: Partitioned Data Loading & Consolidation [skip ci]" || echo "No changes"
          git push origin main
