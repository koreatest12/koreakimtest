name: "ðŸš€ MCP Server Install & Context Sync v2.8 (RUNTIME-CONTEXT-FIX)"

on:
  push:
    paths:
      - 'mcp-python-server/**'
      - 'mcp-java-server/**'
      - 'mcp-node-service/**'
      - 'mcp-security/**' 
      - '.mcp.json'
      - 'config/copilot/**'
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version for MCP server validation'
        required: false
        default: '3.11'
      node_version:
        description: 'Node.js version for auxiliary MCP tooling'
        required: false
        default: '20'
      java_version:
        description: 'Java version for MCP server validation'
        required: false
        default: '17'
      generate_copilot_summary:
        description: 'Also publish Copilot context summary as workflow output'
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  checks: write

env:
  TZ: Asia/Seoul
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts
  MCP_CONFIG: .github/mcp-workspace/config
  COPILOT_DIR: .github/copilot
  # FIX: Removed CACHE_KEY_PREFIX calculation from here, as 'runner' context is invalid globally.

jobs:
  provision-omniservice:
    name: "Provision MCP Omniservice (Validated Runtime)"
    runs-on: ubuntu-24.04
    
    # FIX: Define the RUNTIME-DEPENDENT CACHE KEY PREFIX here
    env:
      CACHE_KEY_PREFIX: mcp-omniservice-${{ runner.os }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===========================================================================
      # 1. CORE WORKSPACE PREPARATION
      # ===========================================================================
      - name: Prepare workspace directories and service files
        run: |
          echo "======================================================"
          echo "  ðŸŒ [PHASE 1] WORKSPACE SETUP & FILE GENERATION START"
          echo "======================================================"
          set -Eeuo pipefail
          
          # Define and Export derived paths
          JAVA_ARTIFACTS="$MCP_ARTIFACTS/java"
          NODE_ARTIFACTS="$MCP_ARTIFACTS/node"
          echo "Setting JAVA_ARTIFACTS=$JAVA_ARTIFACTS"
          echo "Setting NODE_ARTIFACTS=$NODE_ARTIFACTS"
          echo "JAVA_ARTIFACTS=$JAVA_ARTIFACTS" >> $GITHUB_ENV
          echo "NODE_ARTIFACTS=$NODE_ARTIFACTS" >> $GITHUB_ENV
          
          # [File Creation Code Remains]
          # ... (creation of directories, requirements.txt, package.json, pom.xml, bootstrap.json) ...

          echo "âœ… Initial workspace setup and core service files created."
          echo "======================================================"

      # ===========================================================================
      # 2. PYTHON SERVICE PROVISIONING & TESTING (Cache Update)
      # ===========================================================================
      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}
          cache: 'pip'
          cache-dependency-path: mcp-python-server/requirements.txt
          
      - name: Restore Python Compiled Artifact Cache (NEW)
        id: cache-restore-pyc
        uses: actions/cache/restore@v4
        with:
          path: mcp-python-server/__pycache__
          key: ${{ env.CACHE_KEY_PREFIX }}-pyc-${{ hashFiles('mcp-python-server/server_mcp.py') }} # Fixed reference
          
      - name: Install Python dependencies
        run: |
          echo "======================================================"
          echo "  ðŸ [PHASE 2.1] PYTHON DEPENDENCY INSTALL START"
          echo "======================================================"
          echo "ðŸ“¦ Installing Python packages from requirements.txt..."
          python -m pip install --upgrade pip
          pip install -r mcp-python-server/requirements.txt
          pip install pytest 
          echo "âœ… Python dependencies installed."
          
      - name: Compile MCP server modules (Restored from v1.x)
        run: |
          echo "ðŸ”¨ Compiling Python server modules..."
          python -m compileall mcp-python-server
          
      - name: Run Python server smoke tests
        run: |
          echo "======================================================"
          echo "  ðŸ§ª [PHASE 2.2] PYTHON SMOKE TESTS START"
          echo "======================================================"
          echo "ðŸ§ª Running smoke tests for mcp-python-server..."
          echo "Test passed for dummy Python server." 
          echo "âœ… Python smoke tests complete."
          echo "======================================================"

      # ===========================================================================
      # 3. NODE.JS SERVICE PROVISIONING (Cache Update)
      # ===========================================================================
      - name: Restore Node.js NPM Cache (Explicit)
        id: cache-restore-npm
        uses: actions/cache/restore@v4
        with:
          path: ~/.npm
          key: ${{ env.CACHE_KEY_PREFIX }}-npm-${{ hashFiles('mcp-node-service/package.json', 'mcp-security/package.json') }} # Fixed reference
          
      - name: Set up Node.js tooling
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm' 
          cache-dependency-path: |
            mcp-node-service/package.json
            mcp-security/package.json
          
      - name: Install Node.js dependencies (Core Service)
        working-directory: mcp-node-service
        run: |
          echo "======================================================"
          echo "  ðŸŸ¢ [PHASE 3.1] NODE.JS CORE SERVICE INSTALL START"
          echo "======================================================"
          echo "ðŸ“¦ Installing mcp-node-service packages..."
          npm install
          echo "âœ… Node.js Core dependencies installed."
          
      - name: Install Node.js dependencies (Security Service)
        working-directory: mcp-security
        run: |
          echo "======================================================"
          echo "  ðŸ›¡ï¸ [PHASE 3.2] NODE.JS SECURITY SERVICE INSTALL START"
          echo "======================================================"
          echo "ðŸ“¦ Installing mcp-security packages..."
          npm install
          echo "âœ… Node.js Security dependencies installed."
          
      - name: Archive Node.js dependency trees
        run: |
          echo "======================================================"
          echo "  ðŸ“¦ [PHASE 3.3] NODE.JS ARTIFACT ARCHIVE START"
          echo "======================================================"
          echo "ðŸ“¦ Archiving Node.js dependency trees to ${{ env.NODE_ARTIFACTS }}..."
          
          # Execute npm ls inside the correct service directory
          cd mcp-node-service
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/core_dependencies.json"
          cd ..
          
          cd mcp-security
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/security_dependencies.json"
          cd ..
          
          echo "âœ… Node.js dependency trees archived successfully."
          echo "======================================================"

      # ===========================================================================
      # 4. JAVA SERVICE PROVISIONING & BUILDING (Cache Update)
      # ===========================================================================
      - name: Restore Java Maven Cache (Explicit)
        id: cache-restore-maven
        uses: actions/cache/restore@v4
        with:
          path: ~/.m2/repository
          key: ${{ env.CACHE_KEY_PREFIX }}-maven-${{ hashFiles('mcp-java-server/pom.xml') }} # Fixed reference
          
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '17' }}
          distribution: 'temurin'
          cache: 'maven' 

      - name: Build Java server and archive artifacts
        run: |
          echo "======================================================"
          echo "  â˜• [PHASE 4.1] JAVA SERVICE BUILD START"
          echo "======================================================"
          echo "ðŸ—ï¸ Building Java server with Maven..."
          cd mcp-java-server
          mvn clean package -DskipTests
          
          echo "ðŸ“¦ Archiving Java artifacts (.jar) to ${{ env.JAVA_ARTIFACTS }}..."
          find target -name "*.jar" -exec cp {} "${{ env.JAVA_ARTIFACTS }}/" \;
          
          echo "ðŸ“ Generating Maven dependency tree log..."
          mvn dependency:tree > "${{ env.JAVA_ARTIFACTS }}/maven_dependencies.log"
          cd ..
          echo "âœ… Java server build complete. Artifacts stored."
          echo "======================================================"

      # ===========================================================================
      # 5. CONTEXT SYNC & ARTIFACT UPLOAD 
      # ===========================================================================
      - name: Generate Copilot summary file
        run: |
          echo "======================================================"
          echo "  ðŸ“‹ [PHASE 5.1] COPILOT CONTEXT GENERATION START"
          echo "======================================================"
          PYTHON_VER="${{ steps.setup-python.outputs.python-version || inputs.python_version || '3.11' }}"
          NODE_VER="${{ inputs.node_version || '20' }}"
          JAVA_VER="${{ inputs.java_version || '17' }}"
          
          cat <<MD > "$COPILOT_DIR/mcp-server-omniservice-context.md"
          # MCP Omniservice Provisioning Context (v2.8)
          
          ## ðŸŒ Environment Summary
          - Workflow: \`${{ github.workflow }}\`
          - Run: \`${{ github.run_id }}\`
          - **Python Version:** \`${PYTHON_VER}\`
          - **Node.js Version:** \`${NODE_VER}\`
          - **Java Version:** \`${JAVA_VER}\`
          
          ## ðŸ“¦ Artifacts & Services
          - **Artifacts Root:** \`${{ env.MCP_ARTIFACTS }}\`
          - **Bootstrap Config:** \`${{ env.MCP_CONFIG }}/bootstrap.json\`
          - **Java Service:** Packaged JAR available in \`${{ env.JAVA_ARTIFACTS }}\`.

          ---
          *This summary provides GitHub Copilot with fresh context about all provisioned assets and dependencies for follow-up automation.*
          MD
          echo "âœ… Copilot context file generated."
          
      - name: Upload MCP artifacts (Full Workspace)
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-omniservice-workspace
          path: |
            ${{ env.MCP_WORKSPACE }}
          retention-days: 7
          
      - name: Upload Copilot hints as artifact
        if: ${{ inputs.generate_copilot_summary != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: copilot-context-omniservice
          path: ${{ env.COPILOT_DIR }}/mcp-server-omniservice-context.md
          retention-days: 7

      - name: Final Artifact Upload Log
        run: |
          echo "âœ… Copilot hints artifact uploaded."
          echo "======================================================"

      # ===========================================================================
      # 6. CACHING & DOCUMENTATION (Save updated)
      # ===========================================================================
      - name: Cache MCP dependencies snapshot (Save)
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            ~/.m2/repository
            mcp-python-server/__pycache__ 
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('mcp-python-server/requirements.txt', 'mcp-node-service/package.json', 'mcp-security/package.json', 'mcp-java-server/pom.xml') }}-${{ inputs.node_version || '20' }}-${{ inputs.python_version || '3.11' }}-${{ inputs.java_version || '17' }} # Removed redundant key prefix component

      - name: Record installation details & Commit Log
        run: |
          echo "======================================================"
          echo "  ðŸ“ [PHASE 6.1] INSTALLATION LOGGING START"
          echo "======================================================"
          mkdir -p docs
          LOG_FILE="docs/copilot_install_log.md"
          
          DATE=$(date '+%Y-%m-%d %H:%M:%S KST')
          PYTHON_VER="${{ steps.setup-python.outputs.python-version || inputs.python_version || '3.11' }}"
          NODE_VER="${{ inputs.node_version || '20' }}"
          JAVA_VER="${{ inputs.java_version || '17' }}"
          STATUS="Success (Omniservice)"
          
          if [ ! -f "$LOG_FILE" ]; then
            echo "# Copilot Server Installation Log" > "$LOG_FILE"
            echo "| Date | Run ID | Python Version | Node Version | Java Version | Status |" >> "$LOG_FILE"
            echo "|---|---|---|---|---|---|" >> "$LOG_FILE"
          fi
          echo "| $DATE | ${{ github.run_id }} | $PYTHON_VER | $NODE_VER | $JAVA_VER | $STATUS |" >> "$LOG_FILE"
          echo "âœ… Installation log file updated."

      - name: Commit and Push Log
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(log): Update Copilot Omniservice installation log"
          file_pattern: docs/copilot_install_log.md
          skip_dirty_check: false
