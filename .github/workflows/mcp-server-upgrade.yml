name: "üöÄ MCP Server Install & Context Sync v2.2 (NODE-SECURITY-FIX)"

on:
  push:
    paths:
      - 'mcp-python-server/**'
      - 'mcp-java-server/**'
      - 'mcp-node-service/**'
      - 'mcp-security/**' # Added new security service path
      - '.mcp.json'
      - 'config/copilot/**'
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version for MCP server validation'
        required: false
        default: '3.11'
      node_version:
        description: 'Node.js version for auxiliary MCP tooling'
        required: false
        default: '20'
      java_version:
        description: 'Java version for MCP server validation'
        required: false
        default: '17'
      generate_copilot_summary:
        description: 'Also publish Copilot context summary as workflow output'
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  checks: write

env:
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts
  MCP_CONFIG: .github/mcp-workspace/config
  COPILOT_DIR: .github/copilot

jobs:
  provision-omniservice:
    name: "Provision MCP Omniservice (Node Fix)"
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===========================================================================
      # 1. CORE WORKSPACE PREPARATION
      # ===========================================================================
      - name: Prepare workspace directories and service files
        run: |
          set -Eeuo pipefail
          
          # Define and Export derived paths (CRITICAL FIX from v2.1)
          JAVA_ARTIFACTS="$MCP_ARTIFACTS/java"
          NODE_ARTIFACTS="$MCP_ARTIFACTS/node"
          echo "JAVA_ARTIFACTS=$JAVA_ARTIFACTS" >> $GITHUB_ENV
          echo "NODE_ARTIFACTS=$NODE_ARTIFACTS" >> $GITHUB_ENV
          
          mkdir -p "$MCP_WORKSPACE" "$MCP_ARTIFACTS" "$MCP_CONFIG" "$COPILOT_DIR"
          mkdir -p "$MCP_CONFIG/templates" "$MCP_CONFIG/snapshots" "$MCP_CONFIG/logs"
          mkdir -p "$JAVA_ARTIFACTS" "$NODE_ARTIFACTS"
          
          # üìù Python Server files (unchanged)
          mkdir -p mcp-python-server; touch mcp-python-server/requirements.txt; echo "flask" > mcp-python-server/requirements.txt
          
          # üìù Node.js Service files (Core)
          mkdir -p mcp-node-service
          echo '{"name": "mcp-node-service", "version": "1.0.0", "dependencies": {"express": "4.18.2"}}' > mcp-node-service/package.json
          
          # üìù Node.js Security Service files (NEW SERVICE reflecting error log)
          mkdir -p mcp-security
          # Re-creating missing dependencies found in error log
          cat <<JSON > mcp-security/package.json
          {
            "name": "mcp-security",
            "version": "1.0.0",
            "dependencies": {
              "axios": "^1.13.1",
              "dotenv": "^17.2.3"
            },
            "devDependencies": {
              "@anthropic-ai/sdk": "^0.68.0",
              "@types/jest": "^30.0.0",
              "@typescript-eslint/eslint-plugin": "^8.46.2",
              "eslint": "^9.38.0",
              "jest": "^30.2.0",
              "typescript": "^5.9.3"
            }
          }
          JSON
          
          # üìù Java Server files (unchanged)
          mkdir -p mcp-java-server/src/main/java/com/mcp
          # ... (pom.xml and Java file creation remains) ...
          
          # Generate bootstrap config (updated to include security service)
          cat <<'JSON' > "$MCP_CONFIG/bootstrap.json"
          {
            "services": ["python", "node", "java", "security"],
            "python": {"entry_point": "mcp-python-server/server_mcp.py"},
            "node": {"entry_point": "mcp-node-service/index.js"},
            "java": {"entry_point": "mcp-java-server/target/java-mcp-server-1.0.0.jar"},
            "security": {"entry_point": "mcp-security/main.ts"},
            "created_at": "${{ github.run_id }}",
            "description": "Omniservice bootstrap configuration including mcp-security"
          }
          JSON
          echo "‚úÖ Initial workspace setup and core service files created."

      # ... (Steps 2. PYTHON PROVISIONING & TESTING remains unchanged) ...

      # ===========================================================================
      # 3. NODE.JS SERVICE PROVISIONING (Refactored for two services)
      # ===========================================================================
      - name: Set up Node.js tooling
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'
          cache-dependency-path: |
            mcp-node-service/package.json
            mcp-security/package.json # Added security service to cache key
          
      - name: Install Node.js dependencies (Core Service)
        run: |
          echo "üì¶ Installing mcp-node-service packages..."
          cd mcp-node-service
          npm install
          cd ..
          
      - name: Install Node.js dependencies (Security Service)
        run: |
          echo "üì¶ Installing mcp-security packages..."
          cd mcp-security
          npm install
          cd ..

      - name: Archive Node.js dependency trees (FIXED)
        run: |
          echo "üì¶ Archiving Node.js dependency trees to ${{ env.NODE_ARTIFACTS }}..."
          
          # FIX: Execute npm ls inside the correct service directory
          cd mcp-node-service
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/core_dependencies.json"
          cd ..
          
          cd mcp-security
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/security_dependencies.json"
          cd ..
          
          echo "‚úÖ Node.js dependency trees archived successfully."

      # ... (Steps 4. JAVA PROVISIONING & BUILDING remains unchanged) ...
      
      # ... (Steps 5. CONTEXT SYNC & ARTIFACT UPLOAD remains unchanged) ...

      # ===========================================================================
      # 6. CACHING & DOCUMENTATION (Updated Hash Files)
      # ===========================================================================
      - name: Cache MCP dependencies snapshot (Save)
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            ~/.m2/repository
          key: mcp-omniservice-${{ runner.os }}-${{ hashFiles('mcp-python-server/requirements.txt', 'mcp-node-service/package.json', 'mcp-security/package.json', 'mcp-java-server/pom.xml') }}-${{ inputs.node_version || '20' }}-${{ inputs.python_version || '3.11' }}-${{ inputs.java_version || '17' }}

      - name: Record installation details & Commit Log
        # ... (Log record logic remains the same) ...
      
      - name: Commit and Push Log
        # ... (Commit logic remains the same) ...
