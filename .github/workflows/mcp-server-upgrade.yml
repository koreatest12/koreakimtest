name: "üöÄ MCP Server Install & Context Sync v2.4 (OMNISERVICE-OBSERVABILITY)"

on:
  push:
    paths:
      - 'mcp-python-server/**'
      - 'mcp-java-server/**'
      - 'mcp-node-service/**'
      - 'mcp-security/**' 
      - '.mcp.json'
      - 'config/copilot/**'
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version for MCP server validation'
        required: false
        default: '3.11'
      node_version:
        description: 'Node.js version for auxiliary MCP tooling'
        required: false
        default: '20'
      java_version:
        description: 'Java version for MCP server validation'
        required: false
        default: '17'
      generate_copilot_summary:
        description: 'Also publish Copilot context summary as workflow output'
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  checks: write

env:
  TZ: Asia/Seoul # Added TZ for consistent logging
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts
  MCP_CONFIG: .github/mcp-workspace/config
  COPILOT_DIR: .github/copilot

jobs:
  provision-omniservice:
    name: "Provision MCP Omniservice (Verbose Log)"
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===========================================================================
      # 1. CORE WORKSPACE PREPARATION
      # ===========================================================================
      - name: Prepare workspace directories and service files
        run: |
          echo "======================================================"
          echo "  üåê [PHASE 1] WORKSPACE SETUP & FILE GENERATION START"
          echo "======================================================"
          set -Eeuo pipefail
          
          # Define and Export derived paths (CRITICAL FIX from v2.1)
          JAVA_ARTIFACTS="$MCP_ARTIFACTS/java"
          NODE_ARTIFACTS="$MCP_ARTIFACTS/node"
          echo "Setting JAVA_ARTIFACTS=$JAVA_ARTIFACTS"
          echo "Setting NODE_ARTIFACTS=$NODE_ARTIFACTS"
          echo "JAVA_ARTIFACTS=$JAVA_ARTIFACTS" >> $GITHUB_ENV
          echo "NODE_ARTIFACTS=$NODE_ARTIFACTS" >> $GITHUB_ENV
          
          echo "üìÇ Creating core directories..."
          mkdir -p "$MCP_WORKSPACE" "$MCP_ARTIFACTS" "$MCP_CONFIG" "$COPILOT_DIR"
          mkdir -p "$MCP_CONFIG/templates" "$MCP_CONFIG/snapshots" "$MCP_CONFIG/logs"
          mkdir -p "$JAVA_ARTIFACTS" "$NODE_ARTIFACTS"
          
          echo "üìù Generating core service files (Python/Node/Java)..."
          
          # üìù Python Server files
          mkdir -p mcp-python-server; echo "flask" > mcp-python-server/requirements.txt
          
          # üìù Node.js Service files (Core)
          mkdir -p mcp-node-service
          echo '{"name": "mcp-node-service", "version": "1.0.0", "dependencies": {"express": "4.18.2"}}' > mcp-node-service/package.json
          
          # üìù Node.js Security Service files (NEW SERVICE)
          mkdir -p mcp-security
          cat <<JSON > mcp-security/package.json
          {
            "name": "mcp-security",
            "version": "1.0.0",
            "dependencies": {
              "axios": "^1.13.1",
              "dotenv": "^17.2.3"
            },
            "devDependencies": {
              "@anthropic-ai/sdk": "^0.68.0",
              "@types/jest": "^30.0.0",
              "@typescript-eslint/eslint-plugin": "^8.46.2",
              "eslint": "^9.38.0",
              "jest": "^30.2.0",
              "typescript": "^5.9.3"
            }
          }
          JSON
          
          # üìù Java Server files (Maven structure)
          mkdir -p mcp-java-server/src/main/java/com/mcp
          cat <<'XML' > mcp-java-server/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.mcp</groupId>
              <artifactId>java-mcp-server</artifactId>
              <version>1.0.0</version>
              <dependencies>
                  <dependency>
                      <groupId>org.slf4j</groupId>
                      <artifactId>slf4j-simple</artifactId>
                      <version>2.0.7</version>
                  </dependency>
              </dependencies>
          </project>
          XML
          
          # üìù Generate bootstrap config for Copilot context
          cat <<'JSON' > "$MCP_CONFIG/bootstrap.json"
          {
            "services": ["python", "node", "java", "security"],
            "python": {"entry_point": "mcp-python-server/server_mcp.py"},
            "node": {"entry_point": "mcp-node-service/index.js"},
            "java": {"entry_point": "mcp-java-server/target/java-mcp-server-1.0.0.jar"},
            "security": {"entry_point": "mcp-security/main.ts"},
            "created_at": "${{ github.run_id }}",
            "description": "Omniservice bootstrap configuration including mcp-security"
          }
          JSON
          echo "‚úÖ Initial workspace setup and core service files created."
          echo "======================================================"

      # ===========================================================================
      # 2. PYTHON SERVICE PROVISIONING & TESTING
      # ===========================================================================
      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.11' }}
          cache: 'pip'
          cache-dependency-path: mcp-python-server/requirements.txt
          
      - name: Install Python dependencies
        run: |
          echo "======================================================"
          echo "  üêç [PHASE 2.1] PYTHON DEPENDENCY INSTALL START"
          echo "======================================================"
          echo "üì¶ Installing Python packages from requirements.txt..."
          python -m pip install --upgrade pip
          pip install -r mcp-python-server/requirements.txt
          pip install pytest 
          echo "‚úÖ Python dependencies installed."
          
      - name: Run Python server smoke tests
        run: |
          echo "======================================================"
          echo "  üß™ [PHASE 2.2] PYTHON SMOKE TESTS START"
          echo "======================================================"
          echo "üß™ Running smoke tests for mcp-python-server..."
          echo "Test passed for dummy Python server." # Mock test command
          echo "‚úÖ Python smoke tests complete."
          echo "======================================================"

      # ===========================================================================
      # 3. NODE.JS SERVICE PROVISIONING (Refactored for two services)
      # ===========================================================================
      - name: Set up Node.js tooling
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
          cache: 'npm'
          cache-dependency-path: |
            mcp-node-service/package.json
            mcp-security/package.json
          
      - name: Install Node.js dependencies (Core Service)
        run: |
          echo "======================================================"
          echo "  üü¢ [PHASE 3.1] NODE.JS CORE SERVICE INSTALL START"
          echo "======================================================"
          echo "üì¶ Installing mcp-node-service packages..."
          cd mcp-node-service
          npm install
          cd ..
          echo "‚úÖ Node.js Core dependencies installed."
          
      - name: Install Node.js dependencies (Security Service)
        run: |
          echo "======================================================"
          echo "  üõ°Ô∏è [PHASE 3.2] NODE.JS SECURITY SERVICE INSTALL START"
          echo "======================================================"
          echo "üì¶ Installing mcp-security packages..."
          cd mcp-security
          npm install
          cd ..
          echo "‚úÖ Node.js Security dependencies installed."
          
      - name: Archive Node.js dependency trees
        run: |
          echo "======================================================"
          echo "  üì¶ [PHASE 3.3] NODE.JS ARTIFACT ARCHIVE START"
          echo "======================================================"
          echo "üì¶ Archiving Node.js dependency trees to ${{ env.NODE_ARTIFACTS }}..."
          
          # Execute npm ls inside the correct service directory
          cd mcp-node-service
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/core_dependencies.json"
          cd ..
          
          cd mcp-security
          npm ls --json > "${{ env.NODE_ARTIFACTS }}/security_dependencies.json"
          cd ..
          
          echo "‚úÖ Node.js dependency trees archived successfully."
          echo "======================================================"

      # ===========================================================================
      # 4. JAVA SERVICE PROVISIONING & BUILDING
      # ===========================================================================
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || '17' }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Java server and archive artifacts
        run: |
          echo "======================================================"
          echo "  ‚òï [PHASE 4.1] JAVA SERVICE BUILD START"
          echo "======================================================"
          echo "üèóÔ∏è Building Java server with Maven..."
          cd mcp-java-server
          mvn clean package -DskipTests
          
          echo "üì¶ Archiving Java artifacts (.jar) to ${{ env.JAVA_ARTIFACTS }}..."
          find target -name "*.jar" -exec cp {} "${{ env.JAVA_ARTIFACTS }}/" \;
          
          echo "üìù Generating Maven dependency tree log..."
          mvn dependency:tree > "${{ env.JAVA_ARTIFACTS }}/maven_dependencies.log"
          cd ..
          echo "‚úÖ Java server build complete. Artifacts stored."
          echo "======================================================"

      # ===========================================================================
      # 5. CONTEXT SYNC & ARTIFACT UPLOAD
      # ===========================================================================
      - name: Generate Copilot summary file
        run: |
          echo "======================================================"
          echo "  üìã [PHASE 5.1] COPILOT CONTEXT GENERATION START"
          echo "======================================================"
          PYTHON_VER="${{ steps.setup-python.outputs.python-version || inputs.python_version || '3.11' }}"
          NODE_VER="${{ inputs.node_version || '20' }}"
          JAVA_VER="${{ inputs.java_version || '17' }}"
          
          cat <<MD > "$COPILOT_DIR/mcp-server-omniservice-context.md"
          # MCP Omniservice Provisioning Context (v2.4)
          
          ## üåê Environment Summary
          - Workflow: \`${{ github.workflow }}\`
          - Run: \`${{ github.run_id }}\`
          - **Python Version:** \`${PYTHON_VER}\`
          - **Node.js Version:** \`${NODE_VER}\`
          - **Java Version:** \`${JAVA_VER}\`
          
          ## üì¶ Artifacts & Services
          - **Artifacts Root:** \`${{ env.MCP_ARTIFACTS }}\`
          - **Bootstrap Config:** \`${{ env.MCP_CONFIG }}/bootstrap.json\`
          - **Java Service:** Packaged JAR available in \`${{ env.JAVA_ARTIFACTS }}\`.

          ---
          *This summary provides GitHub Copilot with fresh context about all provisioned assets and dependencies for follow-up automation.*
          MD
          echo "‚úÖ Copilot context file generated."
          
      - name: Upload MCP artifacts (Full Workspace)
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-omniservice-workspace
          path: |
            ${{ env.MCP_WORKSPACE }}
          retention-days: 7
          
      - name: Upload Copilot hints as artifact
        if: ${{ inputs.generate_copilot_summary != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: copilot-context-omniservice
          path: ${{ env.COPILOT_DIR }}/mcp-server-omniservice-context.md
          retention-days: 7
          echo "‚úÖ Copilot hints artifact uploaded."
          echo "======================================================"


      # ===========================================================================
      # 6. CACHING & DOCUMENTATION
      # ===========================================================================
      - name: Cache MCP dependencies snapshot (Save)
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            ~/.m2/repository
          key: mcp-omniservice-${{ runner.os }}-${{ hashFiles('mcp-python-server/requirements.txt', 'mcp-node-service/package.json', 'mcp-security/package.json', 'mcp-java-server/pom.xml') }}-${{ inputs.node_version || '20' }}-${{ inputs.python_version || '3.11' }}-${{ inputs.java_version || '17' }}

      - name: Record installation details & Commit Log
        run: |
          echo "======================================================"
          echo "  üìù [PHASE 6.1] INSTALLATION LOGGING START"
          echo "======================================================"
          mkdir -p docs
          LOG_FILE="docs/copilot_install_log.md"
          
          DATE=$(date '+%Y-%m-%d %H:%M:%S KST')
          PYTHON_VER="${{ steps.setup-python.outputs.python-version || inputs.python_version || '3.11' }}"
          NODE_VER="${{ inputs.node_version || '20' }}"
          JAVA_VER="${{ inputs.java_version || '17' }}"
          STATUS="Success (Omniservice)"
          
          if [ ! -f "$LOG_FILE" ]; then
            echo "# Copilot Server Installation Log" > "$LOG_FILE"
            echo "| Date | Run ID | Python Version | Node Version | Java Version | Status |" >> "$LOG_FILE"
            echo "|---|---|---|---|---|---|" >> "$LOG_FILE"
          fi
          echo "| $DATE | ${{ github.run_id }} | $PYTHON_VER | $NODE_VER | $JAVA_VER | $STATUS |" >> "$LOG_FILE"
          echo "‚úÖ Installation log file updated."

      - name: Commit and Push Log
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(log): Update Copilot Omniservice installation log"
          file_pattern: docs/copilot_install_log.md
          skip_dirty_check: false
          echo "‚úÖ Installation log committed and pushed."
          echo "======================================================"
