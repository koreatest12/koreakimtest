name: "ğŸš€ Spring Super CI: Auto-Update, Provision, Build & Backup Core"

on:
  push:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 0 * * 0' # ë§¤ì£¼ ì¼ìš”ì¼ ìì •: ì •ê¸° í’€ ë°±ì—… ë° ì—…ë°ì´íŠ¸ ì ê²€
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ê°•ì œ ì¢…ì†ì„± ì—…ë°ì´íŠ¸ ì‹¤í–‰ (Maven/Gradle)'
        required: true
        type: boolean
        default: false
      backup_retention:
        description: 'ë°±ì—… ë³´ê´€ ê¸°ê°„(ì¼)'
        default: '30'

env:
  # 1. ì‹œìŠ¤í…œ ì„¤ì •
  APP_NAME: "finance-core-system"
  JAVA_VERSION: '17'
  DISTRIBUTION: 'temurin'
  
  # 2. ì„œë¹„ìŠ¤ ë²„ì „ ê´€ë¦¬ (ì´ê³³ì—ì„œ ëª¨ë“  ì„œë¹„ìŠ¤ ë²„ì „ í†µì œ)
  SERVICE_POSTGRES: "postgres:15-alpine"
  SERVICE_REDIS: "redis:7-alpine"
  SERVICE_KAFKA: "apache/kafka:latest"
  SERVICE_NGINX: "nginx:stable-alpine"
  
  # 3. ê²½ë¡œ ì„¤ì •
  ARTIFACT_DIR: "./super-artifacts"
  SERVICE_DIR: "./super-artifacts/services"
  BACKUP_DIR: "./super-artifacts/backup"
  AUDIT_LOG: "./audit-system.log"

permissions:
  contents: write  # ì—…ë°ì´íŠ¸ëœ dependencyë¥¼ ì»¤ë°‹í•˜ê¸° ìœ„í•´ í•„ìš”
  packages: write

jobs:
  # ======================================================
  # JOB 1: ì„œë¹„ìŠ¤ ë‹¤ìš´ë¡œë“œ ë° ì ì¬ (Provisioning Layer)
  # ======================================================
  provision-services:
    name: ğŸ“¥ Provision & Cache Services
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Initialize Audit Log
        run: |
          echo "[START] Workflow Initiated at $(date)" > ${{ env.AUDIT_LOG }}
          mkdir -p ${{ env.SERVICE_DIR }}

      - name: ğŸ³ Download Service Containers (Pre-loading)
        run: |
          echo "Downloading Core Services for Offline Deployment..."
          
          # ì„œë¹„ìŠ¤ ë¦¬ìŠ¤íŠ¸ ì •ì˜
          IMAGES=("${{ env.SERVICE_POSTGRES }}" "${{ env.SERVICE_REDIS }}" "${{ env.SERVICE_KAFKA }}" "${{ env.SERVICE_NGINX }}")
          
          for img in "${IMAGES[@]}"; do
            echo "Pulling $img..."
            docker pull $img
            
            # ì´ë¯¸ì§€ íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ë³€í™˜ (/: -> _)
            SAFE_NAME=$(echo $img | tr '/:' '_')
            
            # ì´ë¯¸ì§€ ì €ì¥ (tar ì•„ì¹´ì´ë¸Œ)
            echo "Saving $img to artifacts..."
            docker save $img -o ${{ env.SERVICE_DIR }}/${SAFE_NAME}.tar
            
            # í•´ì‹œ ìƒì„± (ë¬´ê²°ì„± ê²€ì¦)
            sha256sum ${{ env.SERVICE_DIR }}/${SAFE_NAME}.tar >> ${{ env.SERVICE_DIR }}/checksums.txt
          done
          
          echo "âœ… All Services Provisioned & Secured." >> ${{ env.AUDIT_LOG }}

      - name: ğŸ“¤ Upload Service Pack
        uses: actions/upload-artifact@v4
        with:
          name: service-pack-offline
          path: ${{ env.SERVICE_DIR }}

  # ======================================================
  # JOB 2: ì½”ë“œ ì—…ë°ì´íŠ¸ ë° ë¹Œë“œ (Build & Update Layer)
  # ======================================================
  build-and-auto-update:
    name: ğŸ”¨ Build, Test & Auto-Update
    needs: provision-services
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.DISTRIBUTION }}
          cache: 'maven'

      # [ìë™ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥] Maven ì¢…ì†ì„± ìµœì‹  ë²„ì „ í™•ì¸ ë° ë¦¬í¬íŠ¸
      - name: ğŸ”„ Check & Update Dependencies
        if: ${{ github.event.inputs.force_update == 'true' || github.event_name == 'schedule' }}
        run: |
          echo "Checking for library updates..."
          
          # ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ ë²„ì „ í™•ì¸
          mvn versions:display-dependency-updates > dependency-report.txt
          
          echo "==== Dependency Update Report ===="
          cat dependency-report.txt
          echo "=================================="
          
          # (ì„ íƒì‚¬í•­) ìë™ìœ¼ë¡œ ë²„ì „ ì˜¬ë¦¬ê¸° (ì£¼ì˜: í…ŒìŠ¤íŠ¸ í†µê³¼ í•„ìˆ˜)
          # mvn versions:use-latest-releases

      - name: ğŸ—ï¸ Build with Maven (Skip Tests for Speed)
        run: |
          mvn clean package -DskipTests
          mkdir -p ${{ env.ARTIFACT_DIR }}/jar
          cp target/*.jar ${{ env.ARTIFACT_DIR }}/jar/

      - name: ğŸ§¬ Integrity Check (Code Signing Simulation)
        run: |
          cd ${{ env.ARTIFACT_DIR }}/jar
          sha256sum *.jar > checksum-app.sha256
          echo "âœ… Application Build Complete & Signed." >> $GITHUB_WORKSPACE/${{ env.AUDIT_LOG }}

      - name: ğŸ“¤ Upload App Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: application-binaries
          path: ${{ env.ARTIFACT_DIR }}/jar

  # ======================================================
  # JOB 3: í†µí•© ë°±ì—… ë° ì•„ì¹´ì´ë¹™ (Backup Layer)
  # ======================================================
  backup-master-system:
    name: ğŸ’¾ Master Backup & Archiving
    needs: [provision-services, build-and-auto-update]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./full-system-dump

      - name: ğŸ“¦ Create Disaster Recovery (DR) Snapshot
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="DR_SNAPSHOT_${{ env.APP_NAME }}_${TIMESTAMP}.zip"
          
          echo "Creating Master Backup: $BACKUP_NAME"
          mkdir -p ${{ env.BACKUP_DIR }}
          
          # 1. ì„œë¹„ìŠ¤ ì´ë¯¸ì§€, ì•± ë°”ì´ë„ˆë¦¬, ë¡œê·¸ ëª¨ë‘ ì••ì¶•
          zip -r ${{ env.BACKUP_DIR }}/$BACKUP_NAME ./full-system-dump
          
          # 2. ë©”íƒ€ë°ì´í„° ìƒì„±
          echo "Backup Date: $(date)" > ${{ env.BACKUP_DIR }}/meta_info.txt
          echo "Branch: ${{ github.ref }}" >> ${{ env.BACKUP_DIR }}/meta_info.txt
          echo "Commit: ${{ github.sha }}" >> ${{ env.BACKUP_DIR }}/meta_info.txt
          
          echo "âœ… DR Snapshot Created."

      - name: â˜ï¸ Upload Secure Backup
        uses: actions/upload-artifact@v4
        with:
          name: secure-dr-backup
          path: ${{ env.BACKUP_DIR }}
          retention-days: ${{ github.event.inputs.backup_retention }}

      - name: ğŸ“¢ Audit Report Finalization
        run: |
          echo "Workflow Finished Successfully."
          # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì—¬ê¸°ì„œ Slack/Email ì•Œë¦¼ ì „ì†¡
