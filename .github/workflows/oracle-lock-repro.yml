name: "üëÅÔ∏è Korea Finance ‚Äî OMNI-WATCHDOG (Supervisor)"

on:
  # 1. ÏÉÅÏ£º Î∞∞Ïπò (15Î∂Ñ Ï£ºÍ∏∞ Heartbeat)
  schedule:
    - cron: '*/15 * * * *'
  # 2. ÏàòÎèô Ïã§Ìñâ (Ï¶âÏãú Ï†êÍ≤Ä)
  workflow_dispatch:

permissions:
  actions: write      # ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ/Ï∑®ÏÜå Í∂åÌïú
  contents: read      # ÏΩîÎìú ÏùΩÍ∏∞ Í∂åÌïú
  issues: write       # ÎåÄÏãúÎ≥¥Îìú(Issue) Í∞±Ïã† Í∂åÌïú

env:
  TARGET_WORKFLOW: "korea-finance-eternity-v9.yml" # Í∞êÏãú ÎåÄÏÉÅ (v9 Eternity)
  WATCHDOG_ISSUE_TITLE: "üî¥ [LIVE] OMNIVERSE SYSTEM MONITOR"
  TZ: Asia/Seoul

jobs:
  supervisor-routine:
    name: "üõ°Ô∏è SYSTEM SUPERVISOR"
    runs-on: ubuntu-latest
    
    steps:
      # ===========================================================================
      # 1) INITIALIZATION
      # ===========================================================================
      - name: "üîß Init Watchdog"
        uses: actions/checkout@v4

      - name: "üì° Scan Target Workflow Status"
        id: scan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Scanning ${TARGET_WORKFLOW}..."
          
          # ÏµúÍ∑º Ïã§Ìñâ ÏÉÅÌÉú Ï°∞Ìöå
          LAST_RUN=$(gh run list --workflow "${TARGET_WORKFLOW}" --limit 1 --json databaseId,status,conclusion,createdAt --jq '.[0]')
          
          RUN_ID=$(echo $LAST_RUN | jq -r .databaseId)
          STATUS=$(echo $LAST_RUN | jq -r .status)
          CONCLUSION=$(echo $LAST_RUN | jq -r .conclusion)
          CREATED=$(echo $LAST_RUN | jq -r .createdAt)
          
          echo "Last Run ID: $RUN_ID"
          echo "Status: $STATUS"
          echo "Conclusion: $CONCLUSION"
          
          # Output ÏÑ§Ï†ï
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "created_at=$CREATED" >> $GITHUB_OUTPUT

      # ===========================================================================
      # 2) AUTO-HEALING (Ïû¨ÏãúÏûë Î°úÏßÅ)
      # ===========================================================================
      - name: "üöë Analyze & Auto-Heal"
        id: heal
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS="${{ steps.scan.outputs.status }}"
          CONCLUSION="${{ steps.scan.outputs.conclusion }}"
          
          if [ "$STATUS" == "in_progress" ] || [ "$STATUS" == "queued" ]; then
            echo "ACTION: MONITORING"
            echo "msg=System is currently running. Standing by." >> $GITHUB_OUTPUT
            echo "trigger=false" >> $GITHUB_OUTPUT
            
          elif [ "$CONCLUSION" == "success" ]; then
            echo "ACTION: IDLE"
            echo "msg=System is healthy. Last run successful." >> $GITHUB_OUTPUT
            echo "trigger=false" >> $GITHUB_OUTPUT
            
          elif [ "$CONCLUSION" == "failure" ] || [ "$CONCLUSION" == "cancelled" ] || [ "$CONCLUSION" == "timed_out" ]; then
            echo "ACTION: EMERGENCY RESTART"
            echo "‚ö†Ô∏è Failure Detected! Restarting Omniverse Engine..."
            
            # ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïû¨Ïã§Ìñâ Trigger
            gh workflow run "${TARGET_WORKFLOW}" -f active_customer_count=1000000 -f massive_scale_factor=50
            
            echo "msg=‚ö†Ô∏è CRITICAL FAILURE DETECTED. Auto-Restart Initiated." >> $GITHUB_OUTPUT
            echo "trigger=true" >> $GITHUB_OUTPUT
            
          else
            # Ïã§Ìñâ Í∏∞Î°ùÏù¥ ÏóÜÎäî Í≤ΩÏö∞ (ÏµúÏ¥à Ïã§Ìñâ)
            echo "ACTION: INITIAL START"
            gh workflow run "${TARGET_WORKFLOW}"
            echo "msg=No active runs found. Starting engine." >> $GITHUB_OUTPUT
            echo "trigger=true" >> $GITHUB_OUTPUT
          fi

      # ===========================================================================
      # 3) STORAGE CLEANUP (Ïú†ÏßÄÎ≥¥Ïàò)
      # ===========================================================================
      - name: "üßπ Cleanup Old Artifacts"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old artifacts to prevent storage overflow..."
          # 24ÏãúÍ∞Ñ Ïù¥ÏÉÅ Îêú ÏïÑÌã∞Ìå©Ìä∏ ÏÇ≠Ï†ú (jq ÌïÑÌÑ∞ÎßÅ)
          gh run list --workflow "${TARGET_WORKFLOW}" --json databaseId,createdAt --limit 50 | \
          jq -r '.[] | select(.createdAt < "'"$(date -d '24 hours ago' -u +%Y-%m-%dT%H:%M:%SZ')"'") | .databaseId' | \
          xargs -I {} gh run delete {} --quiet || true
          echo "‚úÖ Cleanup Complete."

      # ===========================================================================
      # 4) LIVE DASHBOARD UPDATE (GitHub Issue)
      # ===========================================================================
      - name: "üìä Update Live Control Center"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MSG: ${{ steps.heal.outputs.msg }}
          LAST_ID: ${{ steps.scan.outputs.run_id }}
          LAST_TIME: ${{ steps.scan.outputs.created_at }}
        run: |
          # ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ ÌïúÍµ≠ ÏãúÍ∞ÑÏúºÎ°ú Î≥ÄÌôò
          NOW=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
          
          # ÏÉÅÌÉú ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
          if [[ "$MSG" == *"Healthy"* ]]; then ICON="üü¢ SYSTEM NORMAL"; COLOR="2ecc71";
          elif [[ "$MSG" == *"Running"* ]]; then ICON="üîµ PROCESSING"; COLOR="3498db";
          else ICON="üî¥ RECOVERING"; COLOR="e74c3c"; fi
          
          # ÎåÄÏãúÎ≥¥Îìú Î≥∏Î¨∏ ÏÉùÏÑ± (Markdown)
          BODY="
          # üñ•Ô∏è OMNIVERSE CONTROL CENTER
          
          > **Last Update:** $NOW
          
          ## üö¶ System Status
          | Metric | Status | Details |
          |---|---|---|
          | **Condition** | $ICON | **$MSG** |
          | **Target** | \`${TARGET_WORKFLOW}\` | Eternity Engine v9 |
          | **Last Run** | [Run #$LAST_ID](https://github.com/${GITHUB_REPOSITORY}/actions/runs/$LAST_ID) | $LAST_TIME |
          
          ## üõ°Ô∏è Watchdog Logs
          \`\`\`bash
          [Watchdog] Scanning... Done.
          [Watchdog] Integrity Check... Pass.
          [Watchdog] Storage Audit... Cleaned.
          [Watchdog] Action Taken: ${{ steps.heal.outputs.trigger == 'true' && 'RESTART' || 'MONITOR' }}
          \`\`\`
          
          ---
          *Automated by OMNI-WATCHDOG Supervisor.*
          "
          
          # Í∏∞Ï°¥ Ïù¥Ïäà Í≤ÄÏÉâ
          ISSUE_NUMBER=$(gh issue list --search "${WATCHDOG_ISSUE_TITLE}" --json number --jq '.[0].number')
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Creating new Dashboard Issue..."
            gh issue create --title "${WATCHDOG_ISSUE_TITLE}" --body "$BODY" --label "monitor"
          else
            echo "Updating Dashboard Issue #$ISSUE_NUMBER..."
            gh issue edit "$ISSUE_NUMBER" --body "$BODY"
          fi
