name: "ğŸ§ª Oracle Tablespace Lock Reproduction â€” v5 (Logfile Fix + Stable)"

on:
  workflow_dispatch:

jobs:
  reproduce:
    runs-on: ubuntu-latest

    env:
      EP: "â–¶ $(date '+%Y-%m-%d %H:%M:%S')"

    steps:
      - name: "ğŸ“‚ Step 1 â€” Prepare Workdir"
        run: |
          set -Eeuo pipefail
          echo "$EP Preparing workdir..."
          mkdir -p work
          echo "$EP Workdir ready."

      - name: "ğŸ’¾ Step 2 â€” Create 100MB Disk"
        run: |
          set -Eeuo pipefail
          echo "$EP Creating 100MB disk..."
          dd if=/dev/zero of=fake.img bs=1M count=100
          sudo mkfs.ext4 fake.img

          echo "$EP Mounting..."
          sudo mkdir -p /mnt/fakedisk
          sudo mount -o loop fake.img /mnt/fakedisk

          echo "$EP Creating pgdata with postgres permission..."
          sudo mkdir -p /mnt/fakedisk/pgdata
          sudo chown -R postgres:postgres /mnt/fakedisk/pgdata

      - name: "ğŸ“¦ Step 3 â€” Install PostgreSQL"
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      - name: "ğŸ›  Step 4 â€” Initialize PostgreSQL inside 100MB disk"
        run: |
          set -Eeuo pipefail
          echo "$EP Running initdb..."
          sudo -u postgres /usr/lib/postgresql/*/bin/initdb -D /mnt/fakedisk/pgdata
          echo "$EP initdb completed."

      - name: "ğŸ“ Step 5 â€” Create postgres log directory"
        run: |
          set -Eeuo pipefail
          echo "$EP Creating log dir..."
          sudo mkdir -p /var/log/postgres_manual
          sudo chown -R postgres:postgres /var/log/postgres_manual
          echo "$EP Log dir ready."

      - name: "ğŸš€ Step 6 â€” Start PostgreSQL (fixed log path)"
        run: |
          set -Eeuo pipefail
          echo "$EP Starting PostgreSQL manual..."
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D /mnt/fakedisk/pgdata \
            -o "-p 5432" \
            -l /var/log/postgres_manual/server.log start

          sleep 5

          echo "$EP Verifying PostgreSQL startup..."
          sudo -u postgres psql -p 5432 -c "SELECT version();" || (
            echo "ERROR: PostgreSQL did not start."
            cat /var/log/postgres_manual/server.log
            exit 1
          )

      - name: "ğŸ“„ Step 7 â€” Create schema + 300k rows"
        run: |
          set -Eeuo pipefail
          sudo -u postgres psql -p 5432 <<EOF
          CREATE TABLE branch (
            br_no VARCHAR(10),
            data TEXT
          );
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 300000);
          EOF
          echo "$EP Data inserted."

      - name: "ğŸ”’ Step 8 â€” Start Blocking Session (Session A)"
        run: |
          set -Eeuo pipefail
          echo "BEGIN; UPDATE branch SET data='LOCKED';" > block.sql
          sudo -u postgres psql -p 5432 -f block.sql &
          sleep 2
          echo "$EP Blocking session active."

      - name: "âš  Step 9 â€” Try UPDATE 580 â†’ 570 (Session B)"
        run: |
          set -Eeuo pipefail
          echo "UPDATE branch SET br_no='570' WHERE br_no='580';" > update.sql
          sudo -u postgres psql -p 5432 -f update.sql || true
          echo "$EP UPDATE issued."

      - name: "ğŸ” Step 10 â€” Check Lock Status"
        run: |
          set -Eeuo pipefail
          echo "$EP Checking locks..."
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity
          WHERE state != 'idle';
          EOF

      - name: "ğŸ’£ Step 11 â€” Generate WAL Explosion"
        run: |
          set -Eeuo pipefail
          echo "$EP Generating WAL explosion..."
          sudo -u postgres psql -p 5432 <<EOF
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 1500000);
          EOF
          echo "$EP WAL explosion done."

      - name: "ğŸ“Š Step 12 â€” Check Disk Usage"
        run: |
          set -Eeuo pipefail
          df -h /mnt/fakedisk

      - name: "ğŸ“£ Step 13 â€” Final Lock Report"
        run: |
          set -Eeuo pipefail
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity;
          EOF

      - name: "ğŸ›‘ Step 14 â€” Stop PostgreSQL"
        run: |
          set -Eeuo pipefail
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D /mnt/fakedisk/pgdata stop
          echo "$EP PostgreSQL stopped."
