name: "üáµüá≠ Manila Branch v7.1 ‚Äî FULL ECHO EXPANDED VERSION"

on:
  workflow_dispatch:

jobs:
  manila_v7_1:
    runs-on: ubuntu-latest

    env:
      VIP: "192.68.32.1"

    steps:
      #######################################################################
      # 0) INIT + ECHO HELPERS
      #######################################################################
      - name: "‚ôª Init Environment + Echo Helpers"
        shell: bash
        run: |
          mkdir -p sql report snapshots logs

          cat <<'EOF' > echo.sh
          safe_echo() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }

          echo_header() {
            echo ""
            echo "==============================================================="
            echo "üî∑ $1"
            echo "==============================================================="
          }

          echo_step() {
            echo "‚û°Ô∏è  STEP: $1"
          }

          echo_error() {
            echo "‚ùå ERROR: $1"
          }

          echo_ok() {
            echo "‚úî OK: $1"
          }
          EOF

          source echo.sh
          echo_header "INIT COMPLETE"
          echo_ok "Directory structure prepared"

      #######################################################################
      # 1) SCHEMA
      #######################################################################
      - name: "üè¶ Create Schema SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Preparing Schema SQL"

          cat <<EOF > sql/schema.sql
          CREATE TABLE IF NOT EXISTS TB_BRANCH(
            BR_NO VARCHAR(10) PRIMARY KEY,
            BR_NAME VARCHAR(200),
            CITY VARCHAR(100),
            COUNTRY VARCHAR(100),
            ADDRESS VARCHAR(300),
            VIRTUAL_IP VARCHAR(20)
          );
          CREATE TABLE IF NOT EXISTS TB_CUSTOMER(
            CUST_ID BIGSERIAL PRIMARY KEY,
            CUST_NAME VARCHAR(200),
            PHONE VARCHAR(50),
            EMAIL VARCHAR(300),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );
          CREATE TABLE IF NOT EXISTS TB_ACCOUNT(
            ACC_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            BALANCE NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );
          CREATE TABLE IF NOT EXISTS TB_SALES(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE TIMESTAMP
          );
          CREATE TABLE IF NOT EXISTS TB_LEDGER(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            TX_TYPE VARCHAR(20),
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE TIMESTAMP
          );
          CREATE TABLE IF NOT EXISTS TB_FRAUD_ALERT(
            ALERT_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            TX_TYPE VARCHAR(20),
            BR_NO VARCHAR(10),
            REASON TEXT,
            TX_DATE TIMESTAMP,
            VIRTUAL_IP VARCHAR(20)
          );
          EOF

          echo_ok "schema.sql created"

      #######################################################################
      # 2) MANILA BRANCH
      #######################################################################
      - name: "üáµüá≠ Insert Manila Branch"
        shell: bash
        run: |
          source echo.sh
          echo_header "Creating Manila Branch"

          cat <<EOF > sql/branch.sql
          INSERT INTO TB_BRANCH (BR_NO, BR_NAME, CITY, COUNTRY, ADDRESS)
          VALUES ('580','SHINHAN BANK MANILA','MANILA','PHILIPPINES','123 ROAD');
          EOF

          echo_ok "Branch SQL generated"

      #######################################################################
      # 3) 300,000 CUSTOMERS
      #######################################################################
      - name: "üë• Generate 300k Customers"
        shell: bash
        run: |
          source echo.sh
          echo_header "Generating 300,000 customers"

          cat <<EOF > sql/customers.sql
          INSERT INTO TB_CUSTOMER (CUST_NAME, PHONE, EMAIL, BR_NO)
          SELECT
            'Customer_' || g,
            '639' || (100000000 + floor(random()*900000000)),
            'cust' || g || '@mail.ph',
            '580'
          FROM generate_series(1,300000) g;
          EOF

          echo_ok "customers.sql generated"

      #######################################################################
      # 4) ACCOUNTS
      #######################################################################
      - name: "üí≥ Generate Accounts"
        shell: bash
        run: |
          source echo.sh
          echo_header "Generating account data"

          cat <<EOF > sql/accounts.sql
          INSERT INTO TB_ACCOUNT (CUST_ID, BALANCE, BR_NO)
          SELECT CUST_ID, (random()*50000)::numeric(15,2), '580'
          FROM TB_CUSTOMER;
          EOF

          echo_ok "accounts.sql generated"

      #######################################################################
      # 5) PAYMENT ‚Äî FIXED SYNTAX
      #######################################################################
      - name: "üí∏ Payment Simulation SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Creating Payment Simulation SQL"

          cat <<EOF > sql/payment.sql
          INSERT INTO TB_SALES (CUST_ID, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            CASE
              WHEN random() < 0.6 THEN (50 + random()*450)
              WHEN random() < 0.9 THEN (500 + random()*4500)
              ELSE (5000 + random()*45000)
            END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))::text || ' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(
              1,
              (1 + floor(random()*10))::int
          ) gs;
          EOF

          echo_ok "payment.sql generated"

      #######################################################################
      # 6) DEPOSIT
      #######################################################################
      - name: "üí∞ Deposit Simulation SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Creating Deposit Simulation"

          cat <<EOF > sql/deposit.sql
          INSERT INTO TB_LEDGER (CUST_ID, TX_TYPE, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            'DEPOSIT',
            CASE
              WHEN random() < 0.6 THEN (100 + random()*900)
              WHEN random() < 0.9 THEN (1000 + random()*9000)
              ELSE (10000 + random()*90000)
            END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))::text || ' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(
              1,
              (1 + floor(random()*5))::int
          ) gs;
          EOF

          echo_ok "deposit.sql generated"

      #######################################################################
      # 7) WITHDRAW
      #######################################################################
      - name: "üí∏ Withdrawal Simulation SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Creating Withdraw Simulation"

          cat <<EOF > sql/withdraw.sql
          INSERT INTO TB_LEDGER (CUST_ID, TX_TYPE, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            'WITHDRAW',
            CASE
              WHEN random() < 0.7 THEN (50 + random()*450)
              WHEN random() < 0.9 THEN (500 + random()*4500)
              ELSE (5000 + random()*25000)
            END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))::text || ' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(
              1,
              (1 + floor(random()*5))::int
          ) gs;
          EOF

          echo_ok "withdraw.sql generated"

      #######################################################################
      # 8) INSTALL POSTGRES
      #######################################################################
      - name: "üêò Install PostgreSQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Installing PostgreSQL"
          sudo apt-get update -y
          sudo apt-get install -y postgresql
          echo_ok "PostgreSQL installed"

      - name: "üöÄ Start PostgreSQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Starting PostgreSQL"
          sudo systemctl start postgresql
          sudo -u postgres psql -c "SELECT version();"
          echo_ok "PostgreSQL running"

      #######################################################################
      # 9) RUN ALL SQL
      #######################################################################
      - name: "üöÄ Execute All SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Executing All SQL Scripts"

          sudo -u postgres psql <<EOF
          \i sql/schema.sql;
          \i sql/branch.sql;
          \i sql/customers.sql;
          \i sql/accounts.sql;
          \i sql/payment.sql;
          \i sql/deposit.sql;
          \i sql/withdraw.sql;
          EOF

          echo_ok "All SQL scripts executed successfully"

      #######################################################################
      # 10) FRAUD DETECTION
      #######################################################################
      - name: "üõ° Fraud Detection SQL"
        shell: bash
        run: |
          source echo.sh
          echo_header "Creating Fraud Detection SQL"

          cat <<EOF > sql/fraud.sql
          INSERT INTO TB_FRAUD_ALERT (CUST_ID, AMOUNT, TX_TYPE, BR_NO, REASON, TX_DATE)
          SELECT
            CUST_ID,
            AMOUNT,
            TX_TYPE,
            BR_NO,
            CASE
              WHEN AMOUNT >= 20000 THEN 'HIGH_AMOUNT'
              WHEN CUST_ID IN (
                  SELECT CUST_ID
                  FROM TB_LEDGER
                  GROUP BY CUST_ID, DATE(TX_DATE)
                  HAVING COUNT(*) >= 20
              ) THEN 'HIGH_FREQUENCY'
              ELSE 'OTHER_SUSPICIOUS'
            END,
            TX_DATE
          FROM TB_LEDGER
          WHERE AMOUNT >= 20000
             OR CUST_ID IN (
                SELECT CUST_ID
                FROM TB_LEDGER
                GROUP BY CUST_ID, DATE(TX_DATE)
                HAVING COUNT(*) >= 20
             );
          EOF

          echo_ok "fraud.sql created"

      - name: "‚ö° Run Fraud Detection"
        shell: bash
        run: |
          source echo.sh
          echo_header "Running Fraud Detection"
          sudo -u postgres psql <<EOF
          \i sql/fraud.sql;
          EOF
          echo_ok "Fraud detection completed"

      #######################################################################
      # 11) SNAPSHOT BEFORE
      #######################################################################
      - name: "üì∏ Snapshot BEFORE"
        shell: bash
        run: |
          source echo.sh
          echo_header "Snapshot BEFORE Migration"

          sudo -u postgres psql <<EOF > snapshots/before.txt
          SELECT 'CUSTOMERS_580',COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='580';
          SELECT 'LEDGER_580',COUNT(*) FROM TB_LEDGER WHERE BR_NO='580';
          SELECT 'SALES_580',COUNT(*) FROM TB_SALES WHERE BR_NO='580';
          SELECT 'FRAUD_BEFORE',COUNT(*) FROM TB_FRAUD_ALERT;
          EOF

          echo_ok "Snapshot before created"

      #######################################################################
      # 12) MIGRATION 580 ‚Üí 570
      #######################################################################
      - name: "üõ† Migrate 580 ‚Üí 570"
        shell: bash
        run: |
          source echo.sh
          echo_header "Migrating 580 ‚Üí 570"

          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_CUSTOMER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_ACCOUNT SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_LEDGER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_SALES SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_FRAUD_ALERT SET BR_NO='570' WHERE BR_NO='580';
          EOF

          echo_ok "Migration complete"

      #######################################################################
      # 13) APPLY VIP
      #######################################################################
      - name: "üåê Apply Virtual IP"
        shell: bash
        run: |
          source echo.sh
          echo_header "Applying Virtual IP"

          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_CUSTOMER SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_LEDGER SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_SALES SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_FRAUD_ALERT SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          EOF

          echo_ok "Virtual IP applied"

      #######################################################################
      # 14) SNAPSHOT AFTER
      #######################################################################
      - name: "üì∏ Snapshot AFTER"
        shell: bash
        run: |
          source echo.sh
          echo_header "Snapshot AFTER Migration"

          sudo -u postgres psql <<EOF > snapshots/after.txt
          SELECT 'CUSTOMERS_570',COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='570';
          SELECT 'LEDGER_570',COUNT(*) FROM TB_LEDGER WHERE BR_NO='570';
          SELECT 'SALES_570',COUNT(*) FROM TB_SALES WHERE BR_NO='570';
          SELECT 'FRAUD_AFTER',COUNT(*) FROM TB_FRAUD_ALERT;
          SELECT 'VIP_ASSIGNED',COUNT(*) FROM TB_CUSTOMER WHERE VIRTUAL_IP='${VIP}';
          EOF

          echo_ok "Snapshot after created"

      #######################################################################
      # 15) MARKDOWN REPORT
      #######################################################################
      - name: "üìÑ Generate Markdown Report"
        shell: bash
        run: |
          source echo.sh
          echo_header "Generating markdown report"

          echo "# Manila Branch v7.1 Migration Report" > report/manila.md
          echo "## BEFORE Migration" >> report/manila.md
          cat snapshots/before.txt >> report/manila.md
          echo "" >> report/manila.md
          echo "## AFTER Migration" >> report/manila.md
          cat snapshots/after.txt >> report/manila.md
          echo "" >> report/manila.md
          echo "## FRAUD SAMPLE (TOP 50)" >> report/manila.md
          sudo -u postgres psql -c "SELECT * FROM TB_FRAUD_ALERT LIMIT 50;" >> report/manila.md

          echo_ok "Report generated"

      #######################################################################
      # 16) UPLOAD REPORT
      #######################################################################
      - name: "üì¶ Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: manila-v7.1-report
          path: report/manila.md

      #######################################################################
      # 17) FINAL SUMMARY
      #######################################################################
      - name: "üéâ FINAL SUMMARY"
        shell: bash
        run: |
          source echo.sh
          echo_header "FINAL SUMMARY"
          echo_ok "Manila Branch v7.1 (Full Echo Version) completed!"
          echo_ok "All SQL executed successfully"
          echo_ok "Migration 580‚Üí570 completed"
          echo_ok "VIP applied: ${VIP}"
          echo_ok "Fraud detection completed"
