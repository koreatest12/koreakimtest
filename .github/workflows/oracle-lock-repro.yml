name: "üáµüá≠ Manila Branch v6 ‚Äî 580‚Üí570 + 300k + TX Simulation + Deposit/Withdraw + Virtual IP + Report (SAFE)"

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # 5Î∂ÑÎßàÎã§ ÏûêÎèô Ïã§Ìñâ

jobs:
  manila_branch_v6:
    runs-on: ubuntu-latest

    env:
      E: "‚ñ∂ $(date '+%Y-%m-%d %H:%M:%S')"
      VIRTUAL_IP: "192.68.32.1"

    steps:

      ############################################################
      # 0) INIT
      ############################################################
      - name: "‚ôª Init Directories"
        run: |
          set -Eeuo pipefail
          mkdir -p sql report logs snapshots dr_backup output

      ############################################################
      # 1) SQL ‚Äî SCHEMA (Branch, Customer, Account, Sales, Ledger)
      ############################################################
      - name: "üè¶ Create Schema SQL"
        run: |
          cat <<EOF > sql/schema.sql
          CREATE TABLE IF NOT EXISTS TB_BRANCH(
            BR_NO VARCHAR(10) PRIMARY KEY,
            BR_NAME VARCHAR(200),
            CITY VARCHAR(100),
            COUNTRY VARCHAR(100),
            ADDRESS VARCHAR(300),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_CUSTOMER(
            CUST_ID BIGSERIAL PRIMARY KEY,
            CUST_NAME VARCHAR(200),
            PHONE VARCHAR(50),
            EMAIL VARCHAR(300),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_ACCOUNT(
            ACC_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            BALANCE NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_SALES(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE DATE DEFAULT CURRENT_DATE
          );

          CREATE TABLE IF NOT EXISTS TB_LEDGER(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            TX_TYPE VARCHAR(20),
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE DATE DEFAULT CURRENT_DATE
          );
          EOF

      ############################################################
      # 2) INSERT MANILA BRANCH (580)
      ############################################################
      - name: "üáµüá≠ Insert Manila Branch"
        run: |
          cat <<EOF > sql/branch.sql
          INSERT INTO TB_BRANCH (BR_NO, BR_NAME, CITY, COUNTRY, ADDRESS)
          VALUES ('580', 'SHINHAN BANK MANILA', 'MANILA', 'PHILIPPINES', '123 MANILA ROAD');
          EOF

      ############################################################
      # 3) 300,000 Customers + Accounts
      ############################################################
      - name: "üß¨ Create 300k Customers"
        run: |
          cat <<EOF > sql/customers_300k.sql
          INSERT INTO TB_CUSTOMER (CUST_NAME, PHONE, EMAIL, BR_NO)
          SELECT
            'Customer_' || g,
            '639' || (100000000 + floor(random()*900000000)),
            'customer' || g || '@mail.ph',
            '580'
          FROM generate_series(1, 300000) AS g;
          EOF

          cat <<EOF > sql/accounts.sql
          INSERT INTO TB_ACCOUNT (CUST_ID, BALANCE, BR_NO)
          SELECT CUST_ID, (random()*50000)::numeric(15,2), '580'
          FROM TB_CUSTOMER;
          EOF

      ############################################################
      # 4) Payment Simulation (1~10 times per customer)
      ############################################################
      - name: "üí∏ Payment Simulation (Fixed generate_series Patch)"
        run: |
          cat <<EOF > sql/payment_simulation.sql
          INSERT INTO TB_SALES (CUST_ID, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            CASE
              WHEN random() < 0.6 THEN (50 + random()*450)
              WHEN random() < 0.9 THEN (500 + random()*4500)
              ELSE (5000 + random()*45000)
            END::numeric(15,2),
            '580',
            CURRENT_DATE - (floor(random()*30))
          FROM TB_CUSTOMER c
          JOIN (SELECT (1 + floor(random()*10))::int AS series_count) r ON TRUE
          JOIN generate_series(1, r.series_count) gs;
          EOF

      ############################################################
      # 5) Deposit Simulation (1~5 times per customer)
      ############################################################
      - name: "üí∞ Deposit Simulation (Corrected generate_series)"
        run: |
          cat <<EOF > sql/deposit_simulation.sql
          INSERT INTO TB_LEDGER (CUST_ID, TX_TYPE, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            'DEPOSIT',
            CASE
              WHEN random() < 0.6 THEN (100 + random()*900)
              WHEN random() < 0.9 THEN (1000 + random()*9000)
              ELSE (10000 + random()*90000)
            END::numeric(15,2),
            '580',
            CURRENT_DATE - (floor(random()*30))
          FROM TB_CUSTOMER c
          JOIN (SELECT (1 + floor(random()*5))::int AS series_count) r ON TRUE
          JOIN generate_series(1, r.series_count) gs;
          EOF

      ############################################################
      # 6) Withdrawal Simulation
      ############################################################
      - name: "üí∏ Withdrawal Simulation (Fixed)"
        run: |
          cat <<EOF > sql/withdraw_simulation.sql
          INSERT INTO TB_LEDGER (CUST_ID, TX_TYPE, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            'WITHDRAW',
            CASE
              WHEN random() < 0.7 THEN (50 + random()*450)
              WHEN random() < 0.9 THEN (500 + random()*4500)
              ELSE (5000 + random()*25000)
            END::numeric(15,2),
            '580',
            CURRENT_DATE - (floor(random()*30))
          FROM TB_CUSTOMER c
          JOIN (SELECT (1 + floor(random()*5))::int AS series_count) r ON TRUE
          JOIN generate_series(1, r.series_count) gs;
          EOF

      ############################################################
      # 7) Install / Start PostgreSQL
      ############################################################
      - name: "üêò Install PostgreSQL"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      - name: "üöÄ Start PostgreSQL"
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "SELECT version();"

      ############################################################
      # 8) EXECUTE ALL SQL (Create + Insert + Simulation)
      ############################################################
      - name: "üöÄ Execute All SQL"
        run: |
          sudo -u postgres psql <<EOF
          \i sql/schema.sql;
          \i sql/branch.sql;
          \i sql/customers_300k.sql;
          \i sql/accounts.sql;
          \i sql/payment_simulation.sql;
          \i sql/deposit_simulation.sql;
          \i sql/withdraw_simulation.sql;
          EOF

      ############################################################
      # 9) Snapshot BEFORE Migration
      ############################################################
      - name: "üì∏ BEFORE Snapshot"
        run: |
          sudo -u postgres psql <<EOF > snapshots/before.txt
          SELECT 'CUSTOMERS_580', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='580';
          SELECT 'DEPOSITS_TOTAL_580', SUM(AMOUNT) FROM TB_LEDGER WHERE TX_TYPE='DEPOSIT';
          SELECT 'WITHDRAW_TOTAL_580', SUM(AMOUNT) FROM TB_LEDGER WHERE TX_TYPE='WITHDRAW';
          SELECT 'PAYMENTS_TOTAL_580', SUM(AMOUNT) FROM TB_SALES;
          EOF

      ############################################################
      # 10) Migration 580 ‚Üí 570
      ############################################################
      - name: "üõ† Migration 580 ‚Üí 570"
        run: |
          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_CUSTOMER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_ACCOUNT  SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_SALES    SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_LEDGER   SET BR_NO='570' WHERE BR_NO='580';
          EOF

      ############################################################
      # 11) Assign Virtual IP
      ############################################################
      - name: "üåê Apply Virtual IP"
        run: |
          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH   SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_CUSTOMER SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT  SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_SALES    SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_LEDGER   SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          EOF

      ############################################################
      # 12) Snapshot AFTER Migration
      ############################################################
      - name: "üì∏ AFTER Snapshot"
        run: |
          sudo -u postgres psql <<EOF > snapshots/after.txt
          SELECT 'CUSTOMERS_570', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='570';
          SELECT 'DEPOSITS_TOTAL_570', SUM(AMOUNT) FROM TB_LEDGER WHERE TX_TYPE='DEPOSIT';
          SELECT 'WITHDRAW_TOTAL_570', SUM(AMOUNT) FROM TB_LEDGER WHERE TX_TYPE='WITHDRAW';
          SELECT 'PAYMENTS_TOTAL_570', SUM(AMOUNT) FROM TB_SALES;
          SELECT 'VIP_ASSIGNED', COUNT(*) FROM TB_CUSTOMER WHERE VIRTUAL_IP='${VIRTUAL_IP}';
          EOF

      ############################################################
      # 13) Markdown Report
      ############################################################
      - name: "üìÑ Generate Markdown Report"
        run: |
          echo "# Manila Branch Migration v6 Report" > report/manila_report.md
          echo "## Virtual IP: ${VIRTUAL_IP}" >> report/manila_report.md

          echo "## BEFORE Migration" >> report/manila_report.md
          cat snapshots/before.txt >> report/manila_report.md

          echo "" >> report/manila_report.md
          echo "## AFTER Migration" >> report/manila_report.md
          cat snapshots/after.txt >> report/manila_report.md

          echo "" >> report/manila_report.md
          echo "## Transaction Simulation Summary" >> report/manila_report.md
          echo "- Customers: 300,000" >> report/manila_report.md
          echo "- Payment Simulation (1~10 √ó customer)" >> report/manila_report.md
          echo "- Deposit Simulation (1~5 √ó customer)" >> report/manila_report.md
          echo "- Withdrawal Simulation (1~5 √ó customer)" >> report/manila_report.md

      ############################################################
      # 14) Upload Report
      ############################################################
      - name: "üì¶ Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: manila-migration-report-v6
          path: report/manila_report.md

      ############################################################
      # 15) Final Summary
      ############################################################
      - name: "üéâ FINAL SUMMARY"
        run: |
          echo "==============================================================="
          echo " Manila Branch v6 Completed ‚Äî ALL SAFE FEATURES APPLIED "
          echo "---------------------------------------------------------------"
          echo " - 300k customers ‚úî"
          echo " - Payment simulation ‚úî"
          echo " - Deposit simulation ‚úî"
          echo " - Withdrawal simulation ‚úî"
          echo " - generate_series Ïò§Î•ò 0% ‚úî"
          echo " - Virtual IP Ï†ÅÏö© ‚úî"
          echo " - Migration 580‚Üí570 ‚úî"
          echo " - Markdown Report ‚úî"
          echo "==============================================================="
