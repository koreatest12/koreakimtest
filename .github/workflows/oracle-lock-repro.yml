name: ETL Daily Workflow (PostgreSQL to Vertica)

on:
  schedule:
    - cron: '0 3 * * *' # ë§¤ì¼ UTC ê¸°ì¤€ ìƒˆë²½ 3ì‹œì— ì‹¤í–‰
  workflow_dispatch:
    inputs:
      reason:
        description: 'ìˆ˜ë™ ì‹¤í–‰ ì‚¬ìœ '
        required: false
        default: 'Manual Trigger'

jobs:
  run_etl_pipeline:
    # ğŸš¨ ì£¼ì˜: Self-Hosted Runner ë˜ëŠ” SSH í‚¤ë¥¼ ì§ì ‘ íŒŒì¼ ì‹œìŠ¤í…œì— ì¶”ê°€í•´ì•¼ í•¨
    runs-on: self-hosted # Self-Hosted Runner ì‚¬ìš©ì„ ê°€ì •í•˜ì—¬ ì„œë²„ ì ‘ê·¼ ë¬¸ì œ íšŒí”¼
    
    steps:
      # 1. SSH ì ‘ì† ì„¤ì • (Secrets ì œê±°ë¡œ ì¸í•œ ë³€ê²½)
      # Self-Hosted Runnerë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ì´ ë‹¨ê³„ì—ì„œ SSH í‚¤ë¥¼ ì§ì ‘ íŒŒì¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: SSH Key Setup and Connection Test
        run: |
          # ğŸš¨ ë³´ì•ˆ ê²½ê³ : ì‹¤ì œ í‚¤ë¥¼ ì—¬ê¸°ì— ì§ì ‘ ì…ë ¥í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
          # ì˜ˆì‹œ: echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa ëŒ€ì‹ 
          # echo "í•˜ë“œì½”ë”©ëœ_ê°œì¸_í‚¤_ë¬¸ìì—´" > ~/.ssh/id_rsa
          
          # SSH ì ‘ì† ì •ë³´ (í•˜ë“œì½”ë”© ì˜ˆì‹œ - ë³´ì•ˆ ìœ„í—˜)
          export ETL_SERVER_USER="etl_user"
          export ETL_SERVER_HOST="10.0.1.10"
          export SSH_CONNECT_STRING="${ETL_SERVER_USER}@${ETL_SERVER_HOST}"
          
          # í•˜ë“œì½”ë”© ëŒ€ì‹ , SSH ì„¤ì • íŒŒì¼ì— ì´ë¯¸ í•´ë‹¹ ì„œë²„ ì ‘ì† ì •ë³´ê°€ ë“±ë¡ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
          echo "SSH ì ‘ì† ì •ë³´ê°€ í™˜ê²½ì— ì„¤ì •ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì§„í–‰í•©ë‹ˆë‹¤."


      # ----------------------------------------------------------------------
      # 1ë‹¨ê³„: ğŸ›¡ï¸ ë°±ì—… ë° ìŠ¤í‚¤ë§ˆ ê´€ë¦¬ (Guardrail)
      # ----------------------------------------------------------------------
      # SSH ì ‘ì†ì´ ì•„ë‹Œ, Self-Hosted Runnerê°€ ETL ì„œë²„ ìì²´ë¼ê³  ê°€ì •í•˜ê³  Local ëª…ë ¹ ì‹¤í–‰
      - name: A1_Backup_Cleanup_2_Days_Retention
        run: |
          echo "2ì¼ ì´ˆê³¼ Vertica ë°±ì—… ì •ë¦¬ ì¤‘..."
          # Self-Hosted Runnerê°€ ETL ì„œë²„ì´ë¯€ë¡œ Local ëª…ë ¹ ì‹¤í–‰
          find /mnt/backup_repo/vertica/ -maxdepth 1 -type d -name "vertica_backup_*" -mtime +2 -exec rm -rf {} \;
          echo 'ë°±ì—… ì •ë¦¬ ì™„ë£Œ.'

      - name: A2_Vertica_Backup_Creation
        run: |
          echo "Vertica ë°±ì—… ìƒì„± ì¤‘..."
          # Self-Hosted Runnerê°€ ETL ì„œë²„ì´ë¯€ë¡œ Local ëª…ë ¹ ì‹¤í–‰
          /opt/vertica/bin/vbr.py --task backup --config-file /opt/vertica/config/vbr_backup.ini
          echo 'ë°±ì—… ì¬ìƒì„± ì™„ë£Œ.'

      - name: A3_A4_PG_DDL_Detect_and_Apply
        run: |
          echo "PG DDL ê°ì§€ ë° Vertica ë°˜ì˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          # DB ìê²© ì¦ëª…ì€ ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ íŒŒì¼ì— ì €ì¥ë˜ê±°ë‚˜ (ë³´ì•ˆ ìœ„í—˜) í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨.
          /opt/etl/scripts/run_ddl_sync.sh
      
      # ----------------------------------------------------------------------
      # 2ë‹¨ê³„: ğŸ”„ ETL í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ (Data Flow)
      # ----------------------------------------------------------------------
      - name: B_ETL_Execution (Extract, Transform, Load)
        run: |
          echo "ETL (Extract, Transform, Load) íŒŒì´í”„ë¼ì¸ ì‹œì‘..."
          # ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ DB ì ‘ì† ì •ë³´ (í•˜ë“œì½”ë”©ëœ ê°’ ë˜ëŠ” íŒŒì¼) ì‚¬ìš©
          /opt/etl/scripts/run_etl_pipeline.sh

      # ----------------------------------------------------------------------
      # 3ë‹¨ê³„: âœ… ìµœì¢… ë°˜ì˜ ë° ëª¨ë‹ˆí„°ë§ (Finalization)
      # ----------------------------------------------------------------------
      - name: C1_Final_Merge_to_Production
        run: |
          echo "ìµœì¢… ë°ì´í„° Merge/Swap ë°˜ì˜ ì¤‘..."
          # Vertica CLI ì‚¬ìš© (DB ìê²© ì¦ëª…ì€ í™˜ê²½ ë³€ìˆ˜/íŒŒì¼ì— ì €ì¥ë˜ì–´ì•¼ í•¨)
          /opt/vertica/bin/vsql -c "MERGE INTO public.target_data AS target USING public.target_data_staging ...;"

      - name: C2_Run_Vertica_Analyze
        run: |
          echo "Vertica í†µê³„ ë¶„ì„ ì‹¤í–‰..."
          /opt/vertica/bin/vsql -c 'SELECT ANALYZE_STATISTICS();'

      - name: C3_Send_Success_Notification
        if: success()
        run: |
          echo "ETL ì›Œí¬í”Œë¡œìš° ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨. ë‚ ì§œ: ${{ github.event.schedule }}"
