name: Service Auto-Updater (Dependabot-like)

on:
  # 1. ë§¤ì¼ ìì • ìë™ ì ê²€ (ìƒì‹œ ìˆ˜í–‰)
  schedule:
    - cron: '0 0 * * *'
  # 2. ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update-services:
    name: Check & Update Services
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # --- [1. Maven ë²„ì „ ëª¨ë‹ˆí„°ë§ ë° ì—…ë°ì´íŠ¸] ---
      - name: Check for New Maven Versions
        id: check-maven
        run: |
          echo "ğŸ” Checking Apache Maven Metadata..."
          
          # Apache ê³µì‹ ì‚¬ì´íŠ¸ì—ì„œ ìµœì‹  3.x ë²„ì „ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          # (HTML íŒŒì‹±í•˜ì—¬ ë²„ì „ ìˆ«ìë§Œ ì¶”ì¶œ)
          LATEST_MAVEN=$(curl -s https://dlcdn.apache.org/maven/maven-3/ | grep -o 'href="3\.[0-9]\+\.[0-9]\+/"' | cut -d'"' -f2 | tr -d '/' | sort -V | tail -n 1)
          
          echo "Latest Maven Version on Server: $LATEST_MAVEN"
          
          # íƒ€ê²Ÿ ì›Œí¬í”Œë¡œìš° íŒŒì¼ (ê°€ì¥ ìµœê·¼ì— ë§Œë“  massive-iso íŒŒì¼ ëŒ€ìƒ)
          TARGET_FILE=".github/workflows/maven-korea-massive-iso.yml"
          
          if grep -q "$LATEST_MAVEN" "$TARGET_FILE"; then
            echo "âœ… Workflow is already using the latest Maven ($LATEST_MAVEN)."
            echo "update_maven=false" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ New Maven version found! ($LATEST_MAVEN)"
            echo "update_maven=true" >> "$GITHUB_OUTPUT"
            echo "latest_maven=$LATEST_MAVEN" >> "$GITHUB_OUTPUT"
            
            # ì›Œí¬í”Œë¡œìš° íŒŒì¼ì˜ matrix ë¶€ë¶„ì— ìƒˆ ë²„ì „ ì¶”ê°€ (sed ì‚¬ìš©)
            # ë§ˆì§€ë§‰ ë²„ì „ ë°‘ì— ìƒˆ ë²„ì „ ì¶”ê°€í•˜ëŠ” ë¡œì§
            sed -i "/- '3.9.11'/a \          - '$LATEST_MAVEN'" "$TARGET_FILE"
            echo "âœ… Added Maven $LATEST_MAVEN to workflow matrix."
          fi

      # --- [2. Java ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¢…ì†ì„± ì—…ë°ì´íŠ¸ (Virtual Dependabot)] ---
      - name: Check & Update Java Dependencies
        id: check-libs
        run: |
          TARGET_FILE=".github/workflows/maven-korea-massive-iso.yml"
          
          # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë‚´ì— í•˜ë“œì½”ë”©ëœ ë²„ì „ ì¶”ì¶œ (ì˜ˆ: commons-lang3)
          CURRENT_LANG3=$(grep -oP "commons-lang3</artifactId>\s+<version>\K[0-9\.]+" "$TARGET_FILE" || echo "0.0.0")
          
          echo "Current Commons-Lang3: $CURRENT_LANG3"
          
          # ê°€ìƒ POM ìƒì„±í•˜ì—¬ ìµœì‹  ë²„ì „ í™•ì¸
          cat <<EOF > temp_check_pom.xml
          <project>
            <modelVersion>4.0.0</modelVersion>
            <groupId>check</groupId>
            <artifactId>check</artifactId>
            <version>1.0</version>
            <dependencies>
              <dependency>
                <groupId>org.apache.commons</groupId>
                <artifactId>commons-lang3</artifactId>
                <version>$CURRENT_LANG3</version>
              </dependency>
            </dependencies>
          </project>
          EOF
          
          # Maven Versions Plugin ì‹¤í–‰
          LATEST_LANG3=$(mvn versions:display-dependency-updates -f temp_check_pom.xml | grep "commons-lang3" | grep -oP "\-> \K[0-9\.]+" | tail -n 1 || echo "")
          
          if [ ! -z "$LATEST_LANG3" ] && [ "$LATEST_LANG3" != "$CURRENT_LANG3" ]; then
             echo "âš ï¸ Update found for Commons-Lang3: $CURRENT_LANG3 -> $LATEST_LANG3"
             
             # íŒŒì¼ ë‚´ ë²„ì „ êµì²´
             sed -i "s|<version>$CURRENT_LANG3</version>|<version>$LATEST_LANG3</version>|g" "$TARGET_FILE"
             echo "update_libs=true" >> "$GITHUB_OUTPUT"
          else
             echo "âœ… Libraries are up to date."
             echo "update_libs=false" >> "$GITHUB_OUTPUT"
          fi
          
          rm temp_check_pom.xml

      # --- [3. ì‹œìŠ¤í…œ ë³´ì•ˆ ë„êµ¬(ClamAV) ë²„ì „ ë¦¬í¬íŒ…] ---
      - name: Check Security Tool Updates
        run: |
          echo "ğŸ” Checking ClamAV & System Tools..."
          sudo apt-get update > /dev/null
          
          # ì„¤ì¹˜ ê°€ëŠ¥í•œ ìµœì‹  ë²„ì „ í™•ì¸
          INSTALLED_CLAM=$(clamscan --version | cut -d' ' -f2 | cut -d'/' -f1)
          LATEST_CLAM=$(apt-cache policy clamav | grep "Candidate:" | awk '{print $2}')
          
          echo "Current ClamAV: $INSTALLED_CLAM"
          echo "Available ClamAV: $LATEST_CLAM"
          
          if [ "$INSTALLED_CLAM" != "$LATEST_CLAM" ]; then
             echo "::notice::New ClamAV version available in repo: $LATEST_CLAM (Will be installed on next run)"
          fi

      # --- [4. ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ê²½ìš° PR ìƒì„±] ---
      - name: Create Pull Request
        if: steps.check-maven.outputs.update_maven == 'true' || steps.check-libs.outputs.update_libs == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update maven and libraries"
          committer: GitHub Actions <actions@github.com>
          author: Dependabot-Like <actions@github.com>
          branch: auto-update-dependencies
          delete-branch: true
          title: "â¬†ï¸ Auto-Update: Maven & Java Dependencies"
          body: |
            ## ğŸ¤– Service Auto-Updater Report
            
            This PR updates the workflow versions to the latest available.
            
            ### ğŸ“¦ Updates
            - **Maven Version:** ${{ steps.check-maven.outputs.latest_maven }} (New version added to Matrix)
            - **Java Libraries:** Updated to latest stable versions on Maven Central.
            
            *Generated automatically by the Service Auto-Updater workflow.*
          labels: |
            dependencies
            automated-pr
