name: "ğŸ‡µğŸ‡­ Manila Shinhan Bank Branch Migration â€” 580 â†’ 570 (SAFE)"

on:
  workflow_dispatch:

jobs:
  branch_migration:
    runs-on: ubuntu-latest

    env:
      E: "â–¶ $(date '+%Y-%m-%d %H:%M:%S')"

    steps:

      ############################################################
      # 0) EchoOps / SafeEcho ì´ˆê¸° ì¤€ë¹„
      ############################################################
      - name: "â™» Init EchoOps"
        run: |
          set -Eeuo pipefail
          echo "$E Initializing EchoOps..."
          mkdir -p logs snapshots output
          echo "$E EchoOps ready."

      ############################################################
      # 1) ë§ˆë‹ë¼ ì‹ í•œì€í–‰ ì§€ì  ì •ë³´ ìƒì„±
      ############################################################
      - name: "ğŸ¦ Generate Manila Branch Metadata"
        run: |
          set -Eeuo pipefail
          echo "$E Generating Manila branch info..."

          cat <<EOF > output/manila_branch.yml
          country: "PHILIPPINES"
          city: "MANILA"
          branch_name: "SHINHAN BANK MANILA"
          old_branch_no: "580"
          new_branch_no: "570"
          created_at: "$(date '+%Y-%m-%d %H:%M:%S')"
          EOF

          cat output/manila_branch.yml

      ############################################################
      # 2) FK ê´€ê³„ ëª¨ì˜ ê²€ì‚¬ (SAFE)
      ############################################################
      - name: "ğŸ” FK Dependency Pre-Check"
        run: |
          set -Eeuo pipefail
          echo "$E Checking FK dependencies..."
          cat <<EOF > output/fk_dependencies.txt
          TB_BRANCH(BR_NO)
          TB_SALES(BR_NO)
          TB_ACCOUNT(BR_NO)
          TB_HISTORY(BR_NO)
          EOF
          cat output/fk_dependencies.txt

      ############################################################
      # 3) Pre-Snapshot (Before Migration)
      ############################################################
      - name: "ğŸ“¸ Create Pre-Migration Snapshot (Mock)"
        run: |
          set -Eeuo pipefail
          echo "$E Creating pre-snapshot..."
          echo "ROWCOUNT_580=300000" > snapshots/pre_snapshot.txt
          echo "ROWCOUNT_570=0" >> snapshots/pre_snapshot.txt
          cat snapshots/pre_snapshot.txt

      ############################################################
      # 4) PostgreSQL Lock Simulation â€” SAFE
      ############################################################
      - name: "ğŸ˜ Install PostgreSQL"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      - name: "ğŸš€ Start PostgreSQL"
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "SELECT version();"

      - name: "ğŸ“‚ Create branch table for simulation"
        run: |
          sudo -u postgres psql <<EOF
          DROP TABLE IF EXISTS branch;
          CREATE TABLE branch (
            br_no VARCHAR(10),
            data TEXT
          );
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 20000);
          EOF

      - name: "ğŸ”’ Create Lock (Session A)"
        run: |
          echo "BEGIN; UPDATE branch SET data='LOCKED';" > /tmp/block.sql
          sudo -u postgres psql -f /tmp/block.sql &
          sleep 1

      - name: "âš  Attempt Update 580 â†’ 570 (Session B)"
        continue-on-error: true
        run: |
          echo "UPDATE branch SET br_no='570' WHERE br_no='580';" > /tmp/update.sql
          sudo -u postgres psql -f /tmp/update.sql || true
          echo "$E Lock simulation (safe) completed."

      - name: "ğŸ” Show Lock State"
        run: |
          sudo -u postgres psql <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity
          WHERE state!='idle';
          EOF

      ############################################################
      # 5) ì‹¤ì œ 580 â†’ 570 ë³€ê²½ (Safe Mock)
      ############################################################
      - name: "ğŸ›  Execute Branch Code Migration"
        run: |
          echo "$E Executing migration 580 â†’ 570 (safe mock)..."

          cat <<EOF > output/migration_result.txt
          STATUS: SUCCESS
          UPDATED_ROWS: 300000
          OLD_BRANCH: 580
          NEW_BRANCH: 570
          EOF

          cat output/migration_result.txt

      ############################################################
      # 6) After Snapshot (Post Migration)
      ############################################################
      - name: "ğŸ“¸ Create Post-Migration Snapshot (Mock)"
        run: |
          echo "ROWCOUNT_580=0" > snapshots/post_snapshot.txt
          echo "ROWCOUNT_570=300000" >> snapshots/post_snapshot.txt
          cat snapshots/post_snapshot.txt

      ############################################################
      # 7) Rollback SQL ìë™ ìƒì„±
      ############################################################
      - name: "â†© Generate Rollback SQL"
        run: |
          set -Eeuo pipefail
          echo "$E Generating rollback SQL..."

          cat <<EOF > output/rollback_580.sql
          -- Rollback: Return branch code from 570 â†’ 580
          UPDATE TB_BRANCH SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_SALES SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_HISTORY SET BR_NO='580' WHERE BR_NO='570';
          EOF

          cat output/rollback_580.sql

      ############################################################
      # 8) DR Snapshot ì €ì¥(Mock)
      ############################################################
      - name: "ğŸ“¦ DR Snapshot"
        run: |
          cp -r snapshots DR_backup
          echo "$E DR Snapshot backup ready."
          ls -R DR_backup

      ############################################################
      # 9) ìµœì¢… Summary
      ############################################################
      - name: "ğŸ‰ Summary"
        run: |
          echo "==============================================================="
          echo " Manila Shinhan Branch Migration Completed (SAFE MODE) "
          echo "---------------------------------------------------------------"
          echo " - FK ê²€ì‚¬ âœ”"
          echo " - Pre-Snapshot âœ”"
          echo " - Lock Simulation âœ”"
          echo " - Migration 580 â†’ 570 âœ”"
          echo " - Rollback SQL ìƒì„± âœ”"
          echo " - DR Snapshot âœ”"
          echo "==============================================================="
          echo " SUCCESS (SAFE MODE FINISHED) "
          echo "==============================================================="
