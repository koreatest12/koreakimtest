name: "ðŸ§ª Oracle Tablespace Lock Reproduction â€” v4 (Permission Fix + Stable)"

on:
  workflow_dispatch:

jobs:
  reproduce:
    runs-on: ubuntu-latest

    env:
      EP: "â–¶ $(date '+%Y-%m-%d %H:%M:%S')"

    steps:
      - name: "ðŸ“‚ Step 1 â€” Prepare Workdir"
        run: |
          set -Eeuo pipefail
          echo "$EP Preparing working directory..."
          mkdir -p work
          cd work
          echo "$EP Workdir ready."

      - name: "ðŸ’¾ Step 2 â€” Create 100MB Disk and Mount"
        run: |
          set -Eeuo pipefail
          echo "$EP Creating 100MB disk..."
          dd if=/dev/zero of=fake.img bs=1M count=100

          echo "$EP Formatting disk..."
          sudo mkfs.ext4 fake.img

          echo "$EP Mounting disk..."
          sudo mkdir -p /mnt/fakedisk
          sudo mount -o loop fake.img /mnt/fakedisk

          echo "$EP Setting permissions for postgres..."
          sudo mkdir -p /mnt/fakedisk/pgdata
          sudo chown -R postgres:postgres /mnt/fakedisk/pgdata

          echo "$EP Mounted disk and pgdata ready."

      - name: "ðŸ“¦ Step 3 â€” Install PostgreSQL"
        run: |
          set -Eeuo pipefail
          echo "$EP Installing PostgreSQL..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql
          echo "$EP PostgreSQL installed."

      - name: "ðŸ›  Step 4 â€” InitDB inside 100MB disk (now allowed)"
        run: |
          set -Eeuo pipefail
          echo "$EP Running initdb inside /mnt/fakedisk/pgdata ..."
          sudo -u postgres /usr/lib/postgresql/*/bin/initdb -D /mnt/fakedisk/pgdata
          echo "$EP initdb completed."

      - name: "ðŸš€ Step 5 â€” Start PostgreSQL (pg_ctl)"
        run: |
          set -Eeuo pipefail
          echo "$EP Starting PostgreSQL manual..."
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D /mnt/fakedisk/pgdata \
            -o "-p 5432" \
            -l logfile start

          sleep 5

          echo "$EP Checking server status..."
          sudo -u postgres psql -p 5432 -c "SELECT version();" || exit 1

      - name: "ðŸ“„ Step 6 â€” Create Table + Insert 300k rows (BR_NO=580)"
        run: |
          set -Eeuo pipefail
          echo "$EP Creating schema and inserting rows..."
          sudo -u postgres psql -p 5432 <<EOF
          CREATE TABLE branch (
            br_no VARCHAR(10),
            data TEXT
          );
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 300000);
          EOF
          echo "$EP Data inserted."

      - name: "ðŸ”’ Step 7 â€” Start Blocking Transaction (Session A)"
        run: |
          echo "$EP Starting blocking session..."
          echo "BEGIN; UPDATE branch SET data='LOCKED';" > block.sql
          sudo -u postgres psql -p 5432 -f block.sql &
          sleep 2
          echo "$EP Blocking session A active."

      - name: "âš  Step 8 â€” Try UPDATE 580 â†’ 570 (Session B)"
        run: |
          echo "$EP Running update (expected lock)..."
          echo "UPDATE branch SET br_no='570' WHERE br_no='580';" > update.sql
          sudo -u postgres psql -p 5432 -f update.sql || true
          echo "$EP UPDATE issued."

      - name: "ðŸ”Ž Step 9 â€” Check Lock Status"
        run: |
          echo "$EP Checking lock status..."
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity
          WHERE state != 'idle';
          EOF

      - name: "ðŸ’£ Step 10 â€” WAL Explosion (simulate Undo overflow)"
        run: |
          echo "$EP Generating WAL explosion..."
          sudo -u postgres psql -p 5432 <<EOF
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 1500000);
          EOF
          echo "$EP WAL explosion triggered."

      - name: "ðŸ“Š Step 11 â€” Disk Full Check"
        run: |
          echo "$EP Disk usage:"
          df -h /mnt/fakedisk

      - name: "ðŸ“£ Step 12 â€” Final Report"
        run: |
          echo "$EP Final lock state:"
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity;
          EOF

      - name: "ðŸ›‘ Step 13 â€” Shutdown PostgreSQL"
        run: |
          echo "$EP Stopping PostgreSQL..."
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D /mnt/fakedisk/pgdata stop
          echo "$EP PostgreSQL stopped."
