name: "üáµüá≠ Manila Shinhan Branch ‚Äî SQL + FakeDB + Customer/Branch Gen + 580‚Üí570 Migration (SAFE)"

on:
  workflow_dispatch:

jobs:
  manila_branch_full:
    runs-on: ubuntu-latest

    env:
      E: "‚ñ∂ $(date '+%Y-%m-%d %H:%M:%S')"

    steps:

      ###################################################################
      # 0) EchoOps Ï¥àÍ∏∞Ìôî
      ###################################################################
      - name: "‚ôª Init EchoOps"
        run: |
          set -Eeuo pipefail
          echo "$E Initializing workflow..."
          mkdir -p sql output logs snapshots dr_backup

      ###################################################################
      # 1) Manila Branch Í∏∞Î≥∏ Ï†ïÎ≥¥ SQL ÏÉùÏÑ±
      ###################################################################
      - name: "üè¶ Generate Manila Branch Base SQL"
        run: |
          set -Eeuo pipefail
          echo "$E Generating branch SQL..."

          cat <<EOF > sql/create_branch_table.sql
          -- Branch Table (Oracle/PG Compatible)
          CREATE TABLE IF NOT EXISTS TB_BRANCH (
            BR_NO        VARCHAR(10) PRIMARY KEY,
            BR_NAME      VARCHAR(200),
            CITY         VARCHAR(100),
            COUNTRY      VARCHAR(100),
            ADDRESS      VARCHAR(300),
            OPEN_DATE    DATE DEFAULT CURRENT_DATE
          );
          EOF

          cat <<EOF > sql/insert_manila_branch.sql
          -- Manila Shinhan Bank Branch Insert
          INSERT INTO TB_BRANCH (BR_NO, BR_NAME, CITY, COUNTRY, ADDRESS)
          VALUES ('580', 'SHINHAN BANK MANILA', 'MANILA', 'PHILIPPINES', '123 MANILA ROAD');
          EOF

          cat <<EOF > sql/update_branch_580_to_570.sql
          -- Branch Code Migration 580 ‚Üí 570
          UPDATE TB_BRANCH SET BR_NO='570'
           WHERE BR_NO='580';
          EOF

          ls -R sql

      ###################################################################
      # 2) Í≥†Í∞ù/Í±∞Îûò/Ï†êÌè¨ Í∞ÄÏÉÅ Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î SQL ÏÉùÏÑ±
      ###################################################################
      - name: "üë• Generate Customer / Account / Sales SQL"
        run: |
          set -Eeuo pipefail
          echo "$E Generating customer/account/sales tables..."

          cat <<EOF > sql/create_customer_tables.sql
          -- Customer Table
          CREATE TABLE IF NOT EXISTS TB_CUSTOMER (
            CUST_ID      BIGSERIAL PRIMARY KEY,
            CUST_NAME    VARCHAR(200),
            PHONE        VARCHAR(50),
            EMAIL        VARCHAR(300),
            BR_NO        VARCHAR(10)
          );

          -- Account Table
          CREATE TABLE IF NOT EXISTS TB_ACCOUNT (
            ACC_ID       BIGSERIAL PRIMARY KEY,
            CUST_ID      BIGINT,
            BALANCE      NUMERIC(15,2),
            BR_NO        VARCHAR(10)
          );

          -- Sales/Transaction Table
          CREATE TABLE IF NOT EXISTS TB_SALES (
            TX_ID        BIGSERIAL PRIMARY KEY,
            CUST_ID      BIGINT,
            AMOUNT       NUMERIC(15,2),
            BR_NO        VARCHAR(10),
            TX_DATE      DATE DEFAULT CURRENT_DATE
          );
          EOF

          ls -R sql

      ###################################################################
      # 3) Manila Í≥†Í∞ù/Í±∞Îûò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏÉÅ ÏÉùÏÑ± SQL
      ###################################################################
      - name: "üß¨ Generate Fake Manila Customer Data SQL"
        run: |
          set -Eeuo pipefail
          echo "$E Generating fake Manila customer data..."

          cat <<EOF > sql/insert_fake_customers.sql
          -- Generate 5,000 Fake Manila Customers
          INSERT INTO TB_CUSTOMER (CUST_NAME, PHONE, EMAIL, BR_NO)
          SELECT
            'Customer_' || generate_series,
            '639' || (100000000 + floor(random() * 900000000)),
            'customer' || generate_series || '@mail.ph',
            '580'
          FROM generate_series(1,5000);
          EOF

          cat <<EOF > sql/insert_fake_accounts.sql
          INSERT INTO TB_ACCOUNT (CUST_ID, BALANCE, BR_NO)
          SELECT CUST_ID, (random() * 50000)::numeric(15,2), '580'
          FROM TB_CUSTOMER;
          EOF

          cat <<EOF > sql/insert_fake_sales.sql
          INSERT INTO TB_SALES (CUST_ID, AMOUNT, BR_NO)
          SELECT CUST_ID, (random() * 1000)::numeric(15,2), '580'
          FROM TB_CUSTOMER;
          EOF

      ###################################################################
      # 4) PostgreSQL DB Ï§ÄÎπÑ
      ###################################################################
      - name: "üêò Install PostgreSQL"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      - name: "üöÄ Start PostgreSQL"
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "SELECT version();"

      ###################################################################
      # 5) Î™®Îì† SQL Ïã§Ìñâ (ÌÖåÏù¥Î∏î ÏÉùÏÑ± + Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±)
      ###################################################################
      - name: "üìÑ Execute All SQL (Safe Load)"
        run: |
          sudo -u postgres psql <<EOF
          \i sql/create_branch_table.sql;
          \i sql/create_customer_tables.sql;
          \i sql/insert_manila_branch.sql;
          \i sql/insert_fake_customers.sql;
          \i sql/insert_fake_accounts.sql;
          \i sql/insert_fake_sales.sql;
          EOF

          echo "$E All SQL executed."

      ###################################################################
      # 6) Snapshot Before Migration
      ###################################################################
      - name: "üì∏ Pre-Migration Snapshot"
        run: |
          sudo -u postgres psql <<EOF > snapshots/pre_snapshot.txt
          SELECT 'COUNT_BRANCH_580', COUNT(*) FROM TB_BRANCH WHERE BR_NO='580';
          SELECT 'CUSTOMERS_580', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='580';
          SELECT 'ACCOUNTS_580', COUNT(*) FROM TB_ACCOUNT WHERE BR_NO='580';
          SELECT 'SALES_580', COUNT(*) FROM TB_SALES WHERE BR_NO='580';
          EOF

          cat snapshots/pre_snapshot.txt

      ###################################################################
      # 7) ÎßàÎãêÎùº ÏßÄÏ†êÏΩîÎìú Î≥ÄÍ≤Ω (580 ‚Üí 570)
      ###################################################################
      - name: "üõ† Execute Branch Migration 580 ‚Üí 570"
        run: |
          sudo -u postgres psql <<EOF
          \i sql/update_branch_580_to_570.sql;

          UPDATE TB_CUSTOMER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_ACCOUNT SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_SALES SET BR_NO='570' WHERE BR_NO='580';
          EOF

          echo "$E Migration completed."

      ###################################################################
      # 8) Snapshot After Migration
      ###################################################################
      - name: "üì∏ Post-Migration Snapshot"
        run: |
          sudo -u postgres psql <<EOF > snapshots/post_snapshot.txt
          SELECT 'COUNT_BRANCH_570', COUNT(*) FROM TB_BRANCH WHERE BR_NO='570';
          SELECT 'CUSTOMERS_570', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='570';
          SELECT 'ACCOUNTS_570', COUNT(*) FROM TB_ACCOUNT WHERE BR_NO='570';
          SELECT 'SALES_570', COUNT(*) FROM TB_SALES WHERE BR_NO='570';
          EOF

          cat snapshots/post_snapshot.txt

      ###################################################################
      # 9) Rollback SQL ÏûêÎèô ÏÉùÏÑ±
      ###################################################################
      - name: "‚Ü© Generate Rollback SQL"
        run: |
          cat <<EOF > output/rollback_manila.sql
          -- Rollback Manila Migration (570 ‚Üí 580)
          UPDATE TB_BRANCH SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_CUSTOMER SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT SET BR_NO='580' WHERE BR_NO='570';
          UPDATE TB_SALES SET BR_NO='580' WHERE BR_NO='570';
          EOF

          cat output/rollback_manila.sql

      ###################################################################
      # 10) DR Snapshot Î∞±ÏóÖ(Mock)
      ###################################################################
      - name: "üì¶ DR Snapshot Backup"
        run: |
          cp -r snapshots dr_backup/
          ls -R dr_backup

      ###################################################################
      # 11) Summary
      ###################################################################
      - name: "üéâ Final Summary"
        run: |
          echo "==============================================================="
          echo " MANILA SHINHAN BRANCH MIGRATION COMPLETE (SAFE MODE) "
          echo "---------------------------------------------------------------"
          echo " - Branch/Customer/Account/Sales SQL ÏÉùÏÑ± ‚úî"
          echo " - Manila Í∞ÄÏÉÅ Í≥†Í∞ù 5,000Î™Ö ÏÉùÏÑ± ‚úî"
          echo " - Branch 580 ‚Üí 570 Migration ‚úî"
          echo " - Snapshot Before/After ‚úî"
          echo " - Rollback SQL ÏÉùÏÑ± ‚úî"
          echo " - DR Snapshot ‚úî"
          echo "==============================================================="
