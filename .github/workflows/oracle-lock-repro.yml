name: "üáµüá≠ Manila Branch v8 ‚Äî OLD/NEW DB Dual Server + Migration + Fraud + Simulation"

on:
  workflow_dispatch:

jobs:
  manila_v8:
    runs-on: ubuntu-latest

    env:
      VIP: "192.68.32.1"
      OLD_PORT: "5432"
      NEW_PORT: "5433"
      OLD_DIR: "/var/lib/postgresql/old_data"
      NEW_DIR: "/var/lib/postgresql/new_data"

    steps:

      ###########################################################################
      # 0) INIT
      ###########################################################################
      - name: "‚ôª Init directories"
        run: |
          mkdir -p sql report snapshots logs

      ###########################################################################
      # 1) Install PostgreSQL binaries only
      ###########################################################################
      - name: "üêò Install PostgreSQL"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      ###########################################################################
      # 2) Setup OLD Server Cluster (580 Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•)
      ###########################################################################
      - name: "üè¶ Create OLD DB Cluster"
        run: |
          sudo pg_dropcluster --stop 14 main || true
          sudo pg_createcluster 14 old --datadir=${OLD_DIR}
          sudo systemctl start postgresql@14-old
          sleep 2
          sudo -u postgres psql -p ${OLD_PORT} -c "SELECT 'OLD DB READY', version();"

      ###########################################################################
      # 3) Setup NEW Server Cluster (Migration ÎåÄÏÉÅ ÏÑúÎ≤Ñ)
      ###########################################################################
      - name: "üè¶ Create NEW DB Cluster"
        run: |
          sudo pg_createcluster 14 new --port=${NEW_PORT} --datadir=${NEW_DIR}
          sudo systemctl start postgresql@14-new
          sleep 2
          sudo -u postgres psql -p ${NEW_PORT} -c "SELECT 'NEW DB READY', version();"

      ###########################################################################
      # 4) Schema for both OLD and NEW servers
      ###########################################################################
      - name: "üóÇ Deploy Schema to OLD and NEW"
        run: |
          cat <<EOF > sql/schema.sql
          CREATE TABLE IF NOT EXISTS TB_BRANCH(
            BR_NO VARCHAR(10) PRIMARY KEY,
            BR_NAME VARCHAR(200),
            CITY VARCHAR(100),
            COUNTRY VARCHAR(100),
            ADDRESS VARCHAR(300),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_CUSTOMER(
            CUST_ID BIGSERIAL PRIMARY KEY,
            CUST_NAME VARCHAR(200),
            PHONE VARCHAR(50),
            EMAIL VARCHAR(300),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_ACCOUNT(
            ACC_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            BALANCE NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_SALES(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS TB_LEDGER(
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            TX_TYPE VARCHAR(20),
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS TB_FRAUD_ALERT(
            ALERT_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            TX_TYPE VARCHAR(20),
            BR_NO VARCHAR(10),
            REASON TEXT,
            TX_DATE TIMESTAMP,
            VIRTUAL_IP VARCHAR(20)
          );
          EOF

          sudo -u postgres psql -p ${OLD_PORT} -f sql/schema.sql
          sudo -u postgres psql -p ${NEW_PORT} -f sql/schema.sql

      ###########################################################################
      # 5) INSERT MANILA BRANCH (OLD SERVER)
      ###########################################################################
      - name: "üáµüá≠ Insert Manila branch (OLD)"
        run: |
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_BRANCH VALUES (
            '580','SHINHAN BANK MANILA','MANILA','PHILIPPINES','123 ROAD',NULL
          );
          EOF

      ###########################################################################
      # 6) Generate 300k Customers on OLD Server
      ###########################################################################
      - name: "üë• 300k Customers (OLD)"
        run: |
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_CUSTOMER (CUST_NAME,PHONE,EMAIL,BR_NO)
          SELECT
            'Customer_'||g,
            '639'||(100000000+floor(random()*900000000)),
            'cust'||g||'@mail.ph',
            '580'
          FROM generate_series(1,300000) g;
          EOF

      ###########################################################################
      # 7) Accounts for all customers
      ###########################################################################
      - name: "üí≥ Accounts (OLD)"
        run: |
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_ACCOUNT (CUST_ID,BALANCE,BR_NO)
          SELECT CUST_ID,(random()*50000)::numeric(15,2),'580'
          FROM TB_CUSTOMER;
          EOF

      ###########################################################################
      # 8) Payment / Deposit / Withdrawal Simulations (OLD)
      ###########################################################################
      - name: "üí∏ TRANSACTION SIM (Payment + Deposit + Withdrawal)"
        run: |
          # PAYMENT
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_SALES (CUST_ID, AMOUNT, BR_NO, TX_DATE)
          SELECT
            c.CUST_ID,
            CASE WHEN random()<0.6 THEN (50+random()*450)
                 WHEN random()<0.9 THEN (500+random()*4500)
                 ELSE (5000+random()*45000) END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))||' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(1,(1+floor(random()*10))::int);
          EOF

          # DEPOSIT
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_LEDGER (CUST_ID,TX_TYPE,AMOUNT,BR_NO,TX_DATE)
          SELECT
            c.CUST_ID,'DEPOSIT',
            CASE WHEN random()<0.6 THEN (100+random()*900)
                 WHEN random()<0.9 THEN (1000+random()*9000)
                 ELSE (10000+random()*90000) END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))||' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(1,(1+floor(random()*5))::int);
          EOF

          # WITHDRAW
          sudo -u postgres psql -p ${OLD_PORT} <<EOF
          INSERT INTO TB_LEDGER (CUST_ID,TX_TYPE,AMOUNT,BR_NO,TX_DATE)
          SELECT
            c.CUST_ID,'WITHDRAW',
            CASE WHEN random()<0.7 THEN (50+random()*450)
                 WHEN random()<0.9 THEN (500+random()*4500)
                 ELSE (5000+random()*25000) END::numeric(15,2),
            '580',
            NOW() - ((floor(random()*30))||' days')::interval
          FROM TB_CUSTOMER c
          CROSS JOIN generate_series(1,(1+floor(random()*5))::int);
          EOF

      ###########################################################################
      # 9) MIGRATE OLD ‚Üí NEW SERVER (580 same data)
      ###########################################################################
      - name: "üöõ Data Migration OLD ‚Üí NEW"
        run: |
          sudo -u postgres pg_dump -p ${OLD_PORT} | sudo -u postgres psql -p ${NEW_PORT}

      ###########################################################################
      # 10) FRAUD DETECTION (NEW SERVER)
      ###########################################################################
      - name: "üõ° Fraud Detection (NEW)"
        run: |
          sudo -u postgres psql -p ${NEW_PORT} <<EOF
          INSERT INTO TB_FRAUD_ALERT (CUST_ID,AMOUNT,TX_TYPE,BR_NO,REASON,TX_DATE)
          SELECT
            CUST_ID,
            AMOUNT,
            TX_TYPE,
            BR_NO,
            CASE
              WHEN AMOUNT >= 20000 THEN 'HIGH_AMOUNT'
              WHEN CUST_ID IN (
                SELECT CUST_ID FROM TB_LEDGER
                GROUP BY CUST_ID,DATE(TX_DATE)
                HAVING COUNT(*)>=20
              ) THEN 'HIGH_FREQUENCY'
              ELSE 'OTHER'
            END,
            TX_DATE
          FROM TB_LEDGER
          WHERE AMOUNT >= 20000
             OR CUST_ID IN (
                SELECT CUST_ID FROM TB_LEDGER
                GROUP BY CUST_ID,DATE(TX_DATE)
                HAVING COUNT(*)>=20
             );
          EOF

      ###########################################################################
      # 11) BEFORE SNAPSHOT (OLD & NEW)
      ###########################################################################
      - name: "üì∏ Snapshot BEFORE"
        run: |
          sudo -u postgres psql -p ${OLD_PORT} <<EOF > snapshots/before_old.txt
          SELECT 'CUSTOMERS',COUNT(*) FROM TB_CUSTOMER;
          SELECT 'SALES',COUNT(*) FROM TB_SALES;
          SELECT 'LEDGER',COUNT(*) FROM TB_LEDGER;
          EOF

          sudo -u postgres psql -p ${NEW_PORT} <<EOF > snapshots/before_new.txt
          SELECT 'CUSTOMERS',COUNT(*) FROM TB_CUSTOMER;
          SELECT 'SALES',COUNT(*) FROM TB_SALES;
          SELECT 'LEDGER',COUNT(*) FROM TB_LEDGER;
          SELECT 'FRAUD',COUNT(*) FROM TB_FRAUD_ALERT;
          EOF

      ###########################################################################
      # 12) Migration 580 ‚Üí 570 ON NEW SERVER ONLY
      ###########################################################################
      - name: "üõ† 580 ‚Üí 570 Migration (NEW server)"
        run: |
          sudo -u postgres psql -p ${NEW_PORT} <<EOF
          UPDATE TB_BRANCH SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_CUSTOMER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_ACCOUNT SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_LEDGER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_SALES SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_FRAUD_ALERT SET BR_NO='570' WHERE BR_NO='580';
          EOF

      ###########################################################################
      # 13) Apply Virtual IP (NEW SERVER)
      ###########################################################################
      - name: "üåê Apply Virtual IP (NEW)"
        run: |
          sudo -u postgres psql -p ${NEW_PORT} <<EOF
          UPDATE TB_BRANCH SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_CUSTOMER SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_LEDGER SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_SALES SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          UPDATE TB_FRAUD_ALERT SET VIRTUAL_IP='${VIP}' WHERE BR_NO='570';
          EOF

      ###########################################################################
      # 14) AFTER SNAPSHOT (NEW SERVER)
      ###########################################################################
      - name: "üì∏ Snapshot AFTER"
        run: |
          sudo -u postgres psql -p ${NEW_PORT} <<EOF > snapshots/after_new.txt
          SELECT 'CUSTOMERS',COUNT(*) FROM TB_CUSTOMER;
          SELECT 'LEDGER',COUNT(*) FROM TB_LEDGER;
          SELECT 'SALES',COUNT(*) FROM TB_SALES;
          SELECT 'FRAUD',COUNT(*) FROM TB_FRAUD_ALERT;
          SELECT 'VIP_ASSIGNED',COUNT(*) FROM TB_CUSTOMER WHERE VIRTUAL_IP='${VIP}';
          EOF

      ###########################################################################
      # 15) Markdown Report
      ###########################################################################
      - name: "üìÑ Create Migration Report"
        run: |
          echo "# Manila Branch v8 ‚Äî OLD/NEW Dual-Server Migration Report" > report/manila_v8.md

          echo "## OLD Server (Before)" >> report/manila_v8.md
          cat snapshots/before_old.txt >> report/manila_v8.md
          echo "" >> report/manila_v8.md

          echo "## NEW Server (Before)" >> report/manila_v8.md
          cat snapshots/before_new.txt >> report/manila_v8.md
          echo "" >> report/manila_v8.md

          echo "## NEW Server (After Migration)" >> report/manila_v8.md
          cat snapshots/after_new.txt >> report/manila_v8.md
          echo "" >> report/manila_v8.md

      ###########################################################################
      # 16) Upload Report
      ###########################################################################
      - name: "üì¶ Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: manila-v8-report
          path: report/manila_v8.md

      ###########################################################################
      # 17) Done
      ###########################################################################
      - name: "üéâ DONE"
        run: |
          echo "==============================================================="
          echo "Manila Branch v8 COMPLETED ‚Äî OLD/NEW Dual DB System INSTALLED"
          echo "==============================================================="
