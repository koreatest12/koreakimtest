name: "ğŸ§ª Oracle Tablespace Lock Reproduction â€” v3 (Stable + Full Echo)"

on:
  workflow_dispatch:

jobs:
  reproduce:
    runs-on: ubuntu-latest

    env:
      ECHO_PREFIX: "â–¶ $(date '+%Y-%m-%d %H:%M:%S')"

    steps:
      - name: "ğŸ“‚ Step 1 â€” Prepare Env"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Creating directories..."
          mkdir -p workdir
          cd workdir
          mkdir -p pgdata
          echo "$ECHO_PREFIX Env prepared."

      - name: "ğŸ’¾ Step 2 â€” Create 100MB Fake Disk"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Creating 100MB disk image..."
          dd if=/dev/zero of=fake.img bs=1M count=100
          mkfs.ext4 fake.img
          mkdir -p mount
          sudo mount -o loop fake.img mount
          echo "$ECHO_PREFIX Disk mounted at ./mount with 100MB limit."

      - name: "ğŸ“¦ Step 3 â€” Install PostgreSQL"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Installing PostgreSQL..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql
          echo "$ECHO_PREFIX PostgreSQL installed."

      - name: "ğŸ”§ Step 4 â€” Initialize PostgreSQL into 100MB disk"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Initializing new PostgreSQL cluster..."
          sudo -u postgres /usr/lib/postgresql/*/bin/initdb -D mount/pgdata
          echo "$ECHO_PREFIX PostgreSQL initialized."

      - name: "ğŸš€ Step 5 â€” Start PostgreSQL manually (pg_ctl)"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Starting PostgreSQL manually..."
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D mount/pgdata \
            -o "-p 5432" \
            -l logfile start

          sleep 5
          echo "$ECHO_PREFIX Checking PostgreSQL..."
          sudo -u postgres psql -p 5432 -c "SELECT version();" || exit 1
          echo "$ECHO_PREFIX PostgreSQL is running."

      - name: "ğŸ“„ Step 6 â€” Create Schema + Insert 300k rows (BR_NO=580)"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Creating schema..."
          sudo -u postgres psql -p 5432 <<EOF
          CREATE TABLE branch (
            br_no VARCHAR(10),
            data TEXT
          );
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 300000);
          EOF
          echo "$ECHO_PREFIX Rows inserted."

      - name: "ğŸ”’ Step 7 â€” Start Blocking Transaction (Session A)"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Starting a blocking session..."
          echo "BEGIN; UPDATE branch SET data='LOCKED';" > block.sql
          sudo -u postgres psql -p 5432 -f block.sql &
          sleep 3
          echo "$ECHO_PREFIX Blocking session active."

      - name: "âš  Step 8 â€” Attempt UPDATE 580 â†’ 570 (Session B)"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Running UPDATE BR_NO=580 â†’ 570..."
          echo "UPDATE branch SET br_no='570' WHERE br_no='580';" > update.sql
          sudo -u postgres psql -p 5432 -f update.sql || true
          echo "$ECHO_PREFIX UPDATE issued (expected to lock)."

      - name: "ğŸ” Step 9 â€” Check Lock Status"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Checking lock status..."
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity
          WHERE state != 'idle';
          EOF

      - name: "ğŸ’£ Step 10 â€” Generate WAL explosion (simulate Undo overflow)"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Creating WAL/Undo explosion..."
          sudo -u postgres psql -p 5432 <<EOF
          INSERT INTO branch
          SELECT '580', md5(random()::text)
          FROM generate_series(1, 1200000); -- 120ë§Œ ê±´
          EOF
          echo "$ECHO_PREFIX WAL explosion triggered."

      - name: "ğŸ“Š Step 11 â€” Check Disk Full Status"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Disk usage:"
          df -h mount

      - name: "ğŸ“£ Step 12 â€” Final Lock Report"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Final lock/wait event result:"
          sudo -u postgres psql -p 5432 <<EOF
          SELECT pid, wait_event, wait_event_type, state, query
          FROM pg_stat_activity;
          EOF

          echo "$ECHO_PREFIX If UPDATE is waiting â†’ Oracle 100MB Tablespace Lock correctly reproduced."

      - name: "ğŸ›‘ Step 13 â€” Stop PostgreSQL"
        run: |
          set -Eeuo pipefail
          echo "$ECHO_PREFIX Stopping PostgreSQL..."
          sudo -u postgres /usr/lib/postgresql/*/bin/pg_ctl \
            -D mount/pgdata stop
          echo "$ECHO_PREFIX PostgreSQL stopped."
