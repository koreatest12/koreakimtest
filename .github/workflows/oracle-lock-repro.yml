name: Service Auto-Updater (Fixed)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check & Update
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # [FIX] 타겟 파일 확인 로직 추가
      - name: Verify Target Workflow Exists
        id: verify_file
        run: |
          TARGET_FILE=".github/workflows/maven-korea-massive-iso.yml"
          if [ -f "$TARGET_FILE" ]; then
            echo "✅ Target file found: $TARGET_FILE"
            echo "file_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "⚠️ Target file NOT found at $TARGET_FILE"
            echo "Listing workflows directory for debugging:"
            ls -R .github/workflows || echo "No workflows dir found"
            echo "file_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check Maven Version
        if: steps.verify_file.outputs.file_exists == 'true'
        id: check-maven
        run: |
          TARGET_FILE=".github/workflows/maven-korea-massive-iso.yml"
          LATEST_MAVEN=$(curl -s https://dlcdn.apache.org/maven/maven-3/ | grep -o 'href="3\.[0-9]\+\.[0-9]\+/"' | cut -d'"' -f2 | tr -d '/' | sort -V | tail -n 1)
          
          if grep -q "$LATEST_MAVEN" "$TARGET_FILE"; then
            echo "✅ Maven is up to date ($LATEST_MAVEN)"
          else
            echo "⚠️ New Maven version: $LATEST_MAVEN"
            # 마지막 버전을 찾아 그 뒤에 새 버전 추가
            sed -i "/- '3.9.11'/a \          - '$LATEST_MAVEN'" "$TARGET_FILE"
            echo "update_needed=true" >> "$GITHUB_OUTPUT"
            echo "latest_version=$LATEST_MAVEN" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR
        if: steps.check-maven.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update maven to ${{ steps.check-maven.outputs.latest_version }}"
          title: "⬆️ Auto-Update: Maven ${{ steps.check-maven.outputs.latest_version }}"
          body: "Automated update for massive generation workflow."
          branch: auto-update-maven
