name: "üáµüá≠ Manila Branch Migration ‚Äî 580‚Üí570 + 300k + Virtual IP Move + Auto 5min"

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # 5Î∂ÑÎßàÎã§ ÏûêÎèô Ïã§Ìñâ

jobs:
  manila_branch_v3:
    runs-on: ubuntu-latest

    env:
      E: "‚ñ∂ $(date '+%Y-%m-%d %H:%M:%S')"
      VIRTUAL_IP: "192.68.32.1"

    steps:

      ############################################################
      # 0) INITIAL SETUP
      ############################################################
      - name: "‚ôª Init Workspace"
        run: |
          set -Eeuo pipefail
          mkdir -p sql output logs snapshots dr_backup report vip_route
          echo "$E Workspace ready."

      ############################################################
      # 1) CREATE SQL FILES (BRANCH, CUSTOMER, ACCOUNT, SALES)
      ############################################################
      - name: "üè¶ Create SQL Schemas"
        run: |
          # Branch Table
          cat <<EOF > sql/create_branch_table.sql
          CREATE TABLE IF NOT EXISTS TB_BRANCH (
            BR_NO    VARCHAR(10) PRIMARY KEY,
            BR_NAME  VARCHAR(200),
            CITY     VARCHAR(100),
            COUNTRY  VARCHAR(100),
            ADDRESS  VARCHAR(300),
            VIRTUAL_IP VARCHAR(20)
          );
          EOF

          # Insert Manila Branch (580)
          cat <<EOF > sql/insert_manila_branch.sql
          INSERT INTO TB_BRANCH (BR_NO, BR_NAME, CITY, COUNTRY, ADDRESS, VIRTUAL_IP)
          VALUES ('580', 'SHINHAN BANK MANILA', 'MANILA', 'PHILIPPINES', '123 MANILA ROAD', NULL);
          EOF

          # Customer / Account / Sales Tables
          cat <<EOF > sql/create_customer_tables.sql
          CREATE TABLE IF NOT EXISTS TB_CUSTOMER (
            CUST_ID BIGSERIAL PRIMARY KEY,
            CUST_NAME VARCHAR(200),
            PHONE VARCHAR(50),
            EMAIL VARCHAR(300),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_ACCOUNT (
            ACC_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            BALANCE NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20)
          );

          CREATE TABLE IF NOT EXISTS TB_SALES (
            TX_ID BIGSERIAL PRIMARY KEY,
            CUST_ID BIGINT,
            AMOUNT NUMERIC(15,2),
            BR_NO VARCHAR(10),
            VIRTUAL_IP VARCHAR(20),
            TX_DATE DATE DEFAULT CURRENT_DATE
          );
          EOF

      ############################################################
      # 2) GENERATE 300k FAKE CUSTOMER DATA
      ############################################################
      - name: "üß¨ Create 300k Manila Customers SQL"
        run: |
          # Create 300k customers (BR_NO 580)
          cat <<EOF > sql/insert_customers_300k.sql
          INSERT INTO TB_CUSTOMER (CUST_NAME, PHONE, EMAIL, BR_NO, VIRTUAL_IP)
          SELECT
            'Customer_' || g,
            '639' || (100000000 + floor(random()*900000000)),
            'customer' || g || '@mail.ph',
            '580',
            NULL
          FROM generate_series(1,300000) AS g;
          EOF

          # Accounts + Sales
          cat <<EOF > sql/insert_accounts_sales.sql
          INSERT INTO TB_ACCOUNT (CUST_ID, BALANCE, BR_NO, VIRTUAL_IP)
          SELECT CUST_ID, (random()*50000)::numeric(15,2), '580', NULL
          FROM TB_CUSTOMER;

          INSERT INTO TB_SALES (CUST_ID, AMOUNT, BR_NO, VIRTUAL_IP)
          SELECT CUST_ID, (random()*1000)::numeric(15,2), '580', NULL
          FROM TB_CUSTOMER;
          EOF

      ############################################################
      # 3) INSTALL POSTGRESQL & START DB
      ############################################################
      - name: "üêò Install PostgreSQL"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql

      - name: "üöÄ Start PostgreSQL"
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "SELECT version();"

      ############################################################
      # 4) EXECUTE ALL SQL (CREATE + INSERT)
      ############################################################
      - name: "üìÑ Execute All SQL Files"
        run: |
          sudo -u postgres psql <<EOF
          \i sql/create_branch_table.sql;
          \i sql/create_customer_tables.sql;
          \i sql/insert_manila_branch.sql;
          \i sql/insert_customers_300k.sql;
          \i sql/insert_accounts_sales.sql;
          EOF

      ############################################################
      # 5) SNAPSHOT BEFORE MIGRATION
      ############################################################
      - name: "üì∏ Snapshot Before"
        run: |
          sudo -u postgres psql <<EOF > snapshots/before.txt
          SELECT 'BRANCH_580', COUNT(*) FROM TB_BRANCH WHERE BR_NO='580';
          SELECT 'CUSTOMER_580', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='580';
          SELECT 'ACCOUNT_580', COUNT(*) FROM TB_ACCOUNT WHERE BR_NO='580';
          SELECT 'SALES_580', COUNT(*) FROM TB_SALES WHERE BR_NO='580';
          EOF
          cat snapshots/before.txt

      ############################################################
      # 6) MIGRATION 580 ‚Üí 570
      ############################################################
      - name: "üõ† Execute Migration 580 ‚Üí 570"
        run: |
          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_CUSTOMER SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_ACCOUNT  SET BR_NO='570' WHERE BR_NO='580';
          UPDATE TB_SALES    SET BR_NO='570' WHERE BR_NO='580';
          EOF

      ############################################################
      # 7) VIRTUAL IP (192.68.32.1) MOVE
      ############################################################
      - name: "üåê Apply Virtual IP to Branch & Customer/Account/Sales"
        run: |
          sudo -u postgres psql <<EOF
          UPDATE TB_BRANCH   SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_CUSTOMER SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_ACCOUNT  SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          UPDATE TB_SALES    SET VIRTUAL_IP='${VIRTUAL_IP}' WHERE BR_NO='570';
          EOF

      ############################################################
      # 8) SNAPSHOT AFTER MIGRATION
      ############################################################
      - name: "üì∏ Snapshot After"
        run: |
          sudo -u postgres psql <<EOF > snapshots/after.txt
          SELECT 'BRANCH_570', COUNT(*) FROM TB_BRANCH WHERE BR_NO='570';
          SELECT 'CUSTOMER_570', COUNT(*) FROM TB_CUSTOMER WHERE BR_NO='570';
          SELECT 'ACCOUNT_570', COUNT(*) FROM TB_ACCOUNT WHERE BR_NO='570';
          SELECT 'SALES_570', COUNT(*) FROM TB_SALES WHERE BR_NO='570';
          SELECT 'VIP_APPLIED', COUNT(*) FROM TB_BRANCH WHERE VIRTUAL_IP='${VIRTUAL_IP}';
          EOF

          cat snapshots/after.txt

      ############################################################
      # 9) MARKDOWN REPORT GENERATION
      ############################################################
      - name: "üìÑ Generate Markdown Report (.md)"
        run: |
          echo "# Manila Migration Report" > report/manila_report.md
          echo "### Branch Migration 580 ‚Üí 570" >> report/manila_report.md
          echo "" >> report/manila_report.md

          echo "## Before Migration" >> report/manila_report.md
          cat snapshots/before.txt >> report/manila_report.md
          echo "" >> report/manila_report.md

          echo "## After Migration" >> report/manila_report.md
          cat snapshots/after.txt >> report/manila_report.md

          echo "" >> report/manila_report.md
          echo "## Virtual IP Assignment" >> report/manila_report.md
          echo "- Applied Virtual IP: **${VIRTUAL_IP}**" >> report/manila_report.md

          echo "" >> report/manila_report.md
          echo "## Status" >> report/manila_report.md
          echo "‚úî 300,000 Customers Generated" >> report/manila_report.md
          echo "‚úî Branch Migration Completed" >> report/manila_report.md
          echo "‚úî Virtual IP Assigned" >> report/manila_report.md

          cat report/manila_report.md

      ############################################################
      # 10) UPLOAD REPORT ARTIFACT
      ############################################################
      - name: "üì¶ Upload Markdown Report"
        uses: actions/upload-artifact@v4
        with:
          name: manila-migration-report-v3
          path: report/manila_report.md

      ############################################################
      # 11) FINAL SUMMARY
      ############################################################
      - name: "üéâ Summary"
        run: |
          echo "==============================================================="
          echo " Manila Branch Full Migration v3 Completed "
          echo "---------------------------------------------------------------"
          echo " - 300k Customers Generated ‚úî"
          echo " - Branch 580‚Üí570 Migration ‚úî"
          echo " - Virtual IP Assigned ‚úî (${VIRTUAL_IP})"
          echo " - Markdown Report Created ‚úî"
          echo " - Auto-run every 5 minutes ‚úî"
          echo "==============================================================="
