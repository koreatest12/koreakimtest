name: "üêß Build Linux Images ‚Äî EchoOps All-in-One"

on:
  push:
    branches: [ main, master, '**/create-and-manage-linux-images**' ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  packages: write # GHCR pushÎ•º ÏúÑÌï¥ ÌïÑÏöî

env:
  REGISTRY: ghcr.io
  ECHO_PREFIX: "[EchoOps][build-images]"

jobs:
  build:
    runs-on: ubuntu-latest
    # self-hostedÎ•º Ïì∞Í≥† Ïã∂Îã§Î©¥ ÏúÑÎ•º [self-hosted, linux, docker] Îì±ÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÎ©¥ Îê©ÎãàÎã§.

    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        include:
          - name: ubuntu
            context: ./docker/ubuntu
            dockerfile: ./docker/ubuntu/Dockerfile
          - name: ubi
            context: ./docker/ubi
            dockerfile: ./docker/ubi/Dockerfile

    steps:
      # Í≥µÌÜµ Ïª®ÌÖçÏä§Ìä∏ & Îß§Ìä∏Î¶≠Ïä§ Ï†ïÎ≥¥ Echo
      - name: Echo workflow context
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} === Workflow start ==="
          echo "${ECHO_PREFIX} Repository : ${GITHUB_REPOSITORY}"
          echo "${ECHO_PREFIX} Ref        : ${GITHUB_REF}"
          echo "${ECHO_PREFIX} Event      : ${GITHUB_EVENT_NAME}"
          echo "${ECHO_PREFIX} Actor      : ${GITHUB_ACTOR}"
          echo "${ECHO_PREFIX} Matrix.name: ${{ matrix.name }}"
          echo "${ECHO_PREFIX} Context    : ${{ matrix.context }}"
          echo "${ECHO_PREFIX} Dockerfile : ${{ matrix.dockerfile }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Echo runner info
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} Runner OS : $(uname -a)"
          echo "${ECHO_PREFIX} Working dir: $(pwd)"
          echo "${ECHO_PREFIX} Disk usage (top 20):"
          du -h . | sort -hr | head -n 20 || true

      # QEMU + Buildx ÏÑ∏ÌåÖ (Î©ÄÌã∞ÏïÑÏπò ÎπåÎìú Ï§ÄÎπÑ)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Echo QEMU setup
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} QEMU has been set up for multi-arch emulation."

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Echo Buildx info
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} Buildx builders:"
          docker buildx ls || echo "${ECHO_PREFIX} buildx ls failed"

      # Dockerfile Lint (ÏòàÏ†Ñ Î≤ÑÏ†ÑÏóêÎäî ÏóÜÎçò Í∏∞Îä•)
      - name: Lint Dockerfile (hadolint, Echo)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
        continue-on-error: true

      - name: Echo Dockerfile lint status
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} Dockerfile lint step executed for ${{ matrix.dockerfile }}"
          echo "${ECHO_PREFIX} (hadolintÎäî continue-on-error=trueÎ°ú ÏÑ§Ï†ïÎê®)"

      # Ïù¥ÎØ∏ÏßÄ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ & ÌÉúÍ∑∏ Ï†ÑÎûµ (sha / latest / tag)
      - name: Prepare image metadata (Echo)
        id: meta
        run: |
          set -euo pipefail

          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.name }}"
          SHA_TAG="${IMAGE_NAME}:sha-${GITHUB_SHA}"

          echo "${ECHO_PREFIX} === Image Metadata ==="
          echo "${ECHO_PREFIX} Base image name : ${IMAGE_NAME}"
          echo "${ECHO_PREFIX} SHA tag         : ${SHA_TAG}"
          echo "${ECHO_PREFIX} Ref type/name   : ${GITHUB_REF_TYPE:-unknown}/${GITHUB_REF_NAME:-unknown}"

          TAGS="${SHA_TAG}"

          # main Î∏åÎûúÏπòÏóêÎäî latest ÌÉúÍ∑∏ Ï∂îÍ∞Ä
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF_NAME}" == "main" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:latest"
            echo "${ECHO_PREFIX} main Î∏åÎûúÏπòÏù¥ÎØÄÎ°ú 'latest' ÌÉúÍ∑∏ Ï∂îÍ∞Ä"
          fi

          # Git ÌÉúÍ∑∏ ÎπåÎìúÏù∏ Í≤ΩÏö∞ (Ïòà: v1.2.3) Ìï¥Îãπ ÌÉúÍ∑∏ÎèÑ Î∂ÄÏó¨
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_REF_NAME}"
            echo "${ECHO_PREFIX} Git tag ÎπåÎìúÏù¥ÎØÄÎ°ú '${GITHUB_REF_NAME}' ÌÉúÍ∑∏ Ï∂îÍ∞Ä"
          fi

          echo "image_name=${IMAGE_NAME}"       >> "$GITHUB_OUTPUT"
          echo "image_sha_tag=${SHA_TAG}"      >> "$GITHUB_OUTPUT"
          echo "image_tags=${TAGS}"            >> "$GITHUB_OUTPUT"

          echo "${ECHO_PREFIX} ÏµúÏ¢Ö ÌÉúÍ∑∏ Î™©Î°ù: ${TAGS}"

      # GHCR Î°úÍ∑∏Ïù∏ (ÏòàÏ†Ñ Î≤ÑÏ†ÑÏóêÎäî ÏóÜÏóàÏßÄÎßå ÏµúÏã† Í∏∞Îä•Ïóê Ìè¨Ìï®)
      - name: Log in to GHCR (Echo)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Echo push/load policy
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "${ECHO_PREFIX} Event is pull_request ‚Üí push=false, load=true"
          else
            echo "${ECHO_PREFIX} Event is ${GITHUB_EVENT_NAME} ‚Üí push=true, load=true"
          fi

      # PRÏö©: push ÏóÜÏù¥ Î°úÏª¨ÏóêÎßå Î°úÎìúÌï¥ÏÑú ÌÖåÏä§Ìä∏ (Îã®Ïùº ÏïÑÌÇ§ÌÖçÏ≤ò)
      - name: Build image for PR (Echo + cache)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64           # PRÏóêÏÑúÎäî Îã®Ïùº ÏïÑÌÇ§ÌÖçÏ≤ò + load
          push: false
          load: true                       # smoke testÎ•º ÏúÑÌï¥ Î°úÎìú
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.image_sha_tag }}

      # PRÏù¥ ÏïÑÎãå Í≤ΩÏö∞: Î©ÄÌã∞ÏïÑÏπò ÎπåÎìú + push (loadÎäî ÏÑ†ÌÉù)
      - name: Build image for push (Echo + cache)
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64   # Î©ÄÌã∞ ÏïÑÌÇ§ÌÖçÏ≤ò ÎπåÎìú
          push: true                           # main/ÌÉúÍ∑∏ Îì±ÏóêÏÑúÎäî push
          load: false                          # Î©ÄÌã∞ÏïÑÏπò + loadÎäî ÏßÄÏõê XÏù¥ÎØÄÎ°ú false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.image_tags }}

      - name: Echo image list after build
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} Docker images (filtered by owner/repo):"
          docker images "${{ env.REGISTRY }}/${{ github.repository_owner }}/*" || true

      # Smoke test: PRÏóêÏÑúÎäî Î°úÏª¨ Î°úÎìúÎêú Ïù¥ÎØ∏ÏßÄÎ•º, push ÎπåÎìúÏóêÏÑúÎäî GHCRÏóêÏÑú pullÌï¥ÏÑú ÏÇ¨Ïö©
      - name: Smoke test image contents (Echo, PR)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          echo "${ECHO_PREFIX} [PR] Smoke testing image: ${IMAGE}"

          docker run --rm "${IMAGE}" bash -lc "
            echo '${ECHO_PREFIX} [container] ÏãúÏûë - Í∏∞Î≥∏ Í≤ΩÎ°ú Ï†êÍ≤Ä';
            echo '${ECHO_PREFIX} [container] /etc/app/permissions.conf Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏';
            test -f /etc/app/permissions.conf;

            echo '${ECHO_PREFIX} [container] /opt/app/data ÎîîÎ†âÌÑ∞Î¶¨ ÌôïÏù∏';
            test -d /opt/app/data;

            echo '${ECHO_PREFIX} [container] /var/log/app ÎîîÎ†âÌÑ∞Î¶¨ ÌôïÏù∏';
            test -d /var/log/app;

            echo '${ECHO_PREFIX} [container] uname:';
            uname -a;
          "

          echo "${ECHO_PREFIX} [PR] Smoke test ÌÜµÍ≥º: ${IMAGE}"

      - name: Smoke test image contents (Echo, push)
        if: github.event_name != 'pull_request'
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          echo "${ECHO_PREFIX} [push] Smoke testing image (pull from GHCR): ${IMAGE}"

          docker pull "${IMAGE}"
          docker run --rm "${IMAGE}" bash -lc "
            echo '${ECHO_PREFIX} [container] ÏãúÏûë - Í∏∞Î≥∏ Í≤ΩÎ°ú Ï†êÍ≤Ä';
            echo '${ECHO_PREFIX} [container] /etc/app/permissions.conf Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏';
            test -f /etc/app/permissions.conf;

            echo '${ECHO_PREFIX} [container] /opt/app/data ÎîîÎ†âÌÑ∞Î¶¨ ÌôïÏù∏';
            test -d /opt/app/data;

            echo '${ECHO_PREFIX} [container] /var/log/app ÎîîÎ†âÌÑ∞Î¶¨ ÌôïÏù∏';
            test -d /var/log/app;

            echo '${ECHO_PREFIX} [container] uname:';
            uname -a;
          "

          echo "${ECHO_PREFIX} [push] Smoke test ÌÜµÍ≥º: ${IMAGE}"

      # Trivy Î≥¥Ïïà Ïä§Ï∫î (ÏòàÏ†Ñ Î≤ÑÏ†ÑÏóêÎäî ÏóÜÍ≥†, ÏµúÏã† Í∏∞Îä•)
      - name: Scan image with Trivy (Echo)
        uses: aquasecurity/trivy-action@v0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image_sha_tag }}
          format: table
          ignore-unfixed: true
        continue-on-error: true

      - name: Echo Trivy scan status
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} Trivy scan step executed for ${{ steps.meta.outputs.image_sha_tag }}"
          echo "${ECHO_PREFIX} (continue-on-error=true ‚Üí Ï∑®ÏïΩÏ†êÏù¥ ÏûàÏñ¥ÎèÑ ÏõåÌÅ¨ÌîåÎ°úÏö∞Îäî Ïã§Ìå®ÏãúÌÇ§ÏßÄ ÏïäÏùå)"

      # ÏòàÏ†Ñ Î≤ÑÏ†ÑÏùò "docker save + upload artifact" Í∏∞Îä• + Echo + retention-days
      - name: Save image as artifact (Echo)
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.image_sha_tag }}"
          TAR_NAME="${{ matrix.name }}.tar.gz"

          echo "${ECHO_PREFIX} Ïù¥ÎØ∏ÏßÄÎ•º tar.gzÎ°ú Ï†ÄÏû• ÏãúÏûë: ${IMAGE} -> ${TAR_NAME}"
          docker pull "${IMAGE}" || true  # PRÏùò Í≤ΩÏö∞ Ïù¥ÎØ∏ Î°úÏª¨Ïóê ÏûàÏùÑ Ïàò ÏûàÏùå
          docker save "${IMAGE}" | gzip > "${TAR_NAME}"
          echo "${ECHO_PREFIX} tar.gz ÏÉùÏÑ± ÏôÑÎ£å: ${TAR_NAME}"
          ls -lh "${TAR_NAME}"

      - name: Upload artifact (Echo)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-image-${{ github.run_number }}
          path: ${{ matrix.name }}.tar.gz
          retention-days: 7

      - name: Echo workflow summary
        run: |
          set -euo pipefail
          echo "${ECHO_PREFIX} === Workflow summary for ${{ matrix.name }} ==="
          echo "${ECHO_PREFIX} Image name : ${{ steps.meta.outputs.image_name }}"
          echo "${ECHO_PREFIX} SHA tag    : ${{ steps.meta.outputs.image_sha_tag }}"
          echo "${ECHO_PREFIX} Tags       : ${{ steps.meta.outputs.image_tags }}"
          echo "${ECHO_PREFIX} Artifact   : ${{ matrix.name }}.tar.gz (retention 7 days)"
          echo "${ECHO_PREFIX} === Workflow end ==="
