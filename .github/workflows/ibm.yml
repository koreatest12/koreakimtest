name: Build and Deploy to IKS (rev7)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_iks_upgrade:
        description: "IKS í´ëŸ¬ìŠ¤í„° ë§ˆìŠ¤í„°/ì›Œì»¤ ë…¸ë“œë¥¼ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤. (ì£¼ì˜: ì‹œê°„ì´ ì˜¤ëž˜ ê±¸ë¦´ ìˆ˜ ìžˆìŒ)"
        type: boolean
        default: false

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  GITHUB_SHA: ${{ github.sha }}
  IBM_CLOUD_REGION: us-south 
  REGISTRY_HOSTNAME: us.icr.io
  IMAGE_NAME: iks-test
  IKS_CLUSTER: example-iks-cluster-name-or-id
  DEPLOYMENT_NAME: iks-test
  PORT: 5001
  
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }} # OIDC ê´€ë ¨ ë³€ìˆ˜ë“¤ì€ ì´ ì›Œí¬í”Œë¡œìš°ì—ì„  ì‚¬ìš© ì•ˆ í•¨
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}            # IBM Cloud ì›Œí¬í”Œë¡œìš°ì´ë¯€ë¡œ ë¬´ì‹œë©ë‹ˆë‹¤.
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  # --- [ JOB 1: IKS í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ] ---
  iks-upgrade:
    name: "â‘  IKS Cluster Upgrade (Optional)"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_iks_upgrade == 'true'
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check Required Secrets (Auth Check)
      id: check_auth
      shell: bash
      run: |
        if [ -z "${{ secrets.IBM_CLOUD_API_KEY }}" ]; then
          echo "âš ï¸ Warning: IBM_CLOUD_API_KEY secret is missing. Skipping upgrade." >&2
          echo "AUTH_OK=false" >> $GITHUB_ENV
          exit 0
        fi
        echo "AUTH_OK=true" >> $GITHUB_ENV
        echo "IBM_CLOUD_API_KEY=${{ secrets.IBM_CLOUD_API_KEY }}" >> $GITHUB_ENV
        
    - name: Install IBM Cloud CLI
      if: env.AUTH_OK == 'true'
      run: |
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        ibmcloud --version
        ibmcloud config --check-version=false
        ibmcloud plugin install -f kubernetes-service
        
    - name: Authenticate with IBM Cloud CLI (Retries)
      if: env.AUTH_OK == 'true'
      id: ibm_auth
      shell: bash
      run: |
        MAX_RETRIES=3
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES: Logging into IBM Cloud..."
          if ibmcloud login --apikey "${IBM_CLOUD_API_KEY}" -r "${IBM_CLOUD_REGION}" -g default; then
            echo "âœ… IBM Cloud authentication successful."
            exit 0
          else
            echo "âŒ Authentication failed on attempt $i. Retrying in 5 seconds..." >&2
            sleep 5
          fi
        done
        echo "--- Final Authentication Failure after $MAX_RETRIES retries. ---" >&2
        exit 1
      continue-on-error: true
      
    - name: Upgrade IKS Cluster Master
      if: steps.ibm_auth.outcome == 'success'
      run: |
        echo "Starting IKS Master Upgrade for cluster: ${IKS_CLUSTER}..."
        ibmcloud ks cluster master update --cluster $IKS_CLUSTER
        echo "Master upgrade initiated. Waiting for status to stabilize..."
      continue-on-error: true

    - name: Upgrade IKS Worker Nodes
      if: steps.ibm_auth.outcome == 'success'
      run: |
        echo "Starting IKS Worker Node Upgrade for cluster: ${IKS_CLUSTER}..."
        ibmcloud ks worker update --cluster $IKS_CLUSTER --all
        echo "Worker node upgrade initiated."
      continue-on-error: true
      
  # --- [ JOB 2: ê¸°ì¡´ Build & Deploy Job ] ---
  setup-build-publish-deploy:
    name: "â‘¡ Build, Publish, and Deploy"
    runs-on: ubuntu-latest
    needs: [iks-upgrade]
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Check Required Secrets (Continue on Missing)
      id: check_secrets
      shell: bash
      run: |
        echo "--- Checking Required Secrets ---"
        
        if [ -z "${{ secrets.IBM_CLOUD_API_KEY }}" ]; then
          echo "âš ï¸ Warning: IBM_CLOUD_API_KEY secret is missing. Cloud authentication will fail." >&2
          echo "AUTH_OK=false" >> $GITHUB_ENV
        else
          echo "AUTH_OK=true" >> $GITHUB_ENV
        fi

        if [ -z "${{ secrets.ICR_NAMESPACE }}" ]; then
          echo "âš ï¸ Warning: ICR_NAMESPACE secret is missing. Image build/push will fail (invalid tag)." >&2
          echo "ICR_NAMESPACE_OK=false" >> $GITHUB_ENV
        else
          echo "ICR_NAMESPACE_OK=true" >> $GITHUB_ENV
        fi
        
        echo "ICR_NAMESPACE=${{ secrets.ICR_NAMESPACE }}" >> $GITHUB_ENV
        echo "IBM_CLOUD_API_KEY=${{ secrets.IBM_CLOUD_API_KEY }}" >> $GITHUB_ENV
      
    - name: Install IBM Cloud CLI
      run: |
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        ibmcloud --version
        ibmcloud config --check-version=false
        ibmcloud plugin install -f kubernetes-service
        ibmcloud plugin install -f container-registry
        
    - name: Authenticate with IBM Cloud CLI (Retries)
      if: env.AUTH_OK == 'true'
      id: ibm_auth_deploy
      shell: bash
      run: |
        MAX_RETRIES=3
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES: Logging into IBM Cloud..."
          if ibmcloud login --apikey "${IBM_CLOUD_API_KEY}" -r "${IBM_CLOUD_REGION}" -g default; then
            echo "âœ… IBM Cloud authentication successful."
            echo "AUTH_SUCCESS=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âŒ Authentication failed on attempt $i. Retrying in 5 seconds..." >&2
            sleep 5
          fi
        done
        
        echo "AUTH_SUCCESS=false" >> $GITHUB_ENV
        echo "--- Final Authentication Failure after $MAX_RETRIES retries. ---" >&2
        exit 1
      continue-on-error: true

    - name: Build with Docker
      if: env.ICR_NAMESPACE_OK == 'true'
      id: docker_build
      run: |
        docker build -t "$REGISTRY_HOSTNAME"/"$ICR_NAMESPACE"/"$IMAGE_NAME":"$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" .
        
        if [ $? -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
      continue-on-error: true
          
    - name: Docker Registry Login and Push
      if: env.AUTH_SUCCESS == 'true' && env.BUILD_SUCCESS == 'true'
      run: |
        echo "Attempting container registry login..."
        ibmcloud cr region-set "${IBM_CLOUD_REGION}"
        ibmcloud cr login
        echo "Pushing image to ICR..."
        docker push $REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$GITHUB_SHA
      continue-on-error: true
        
    # --- [ ë°°í¬ ë° ê³µìš© ì£¼ì†Œ ì¶”ì¶œ ë¡œì§ (ìˆ˜ì • ë° ì¶”ê°€) ] ---
    - name: Deploy to IKS
      if: env.AUTH_SUCCESS == 'true' && env.BUILD_SUCCESS == 'true'
      run: |
        echo "Attempting IKS Deployment..."
        ibmcloud ks cluster config --cluster $IKS_CLUSTER
        kubectl config current-context
        
        IMAGE_TAG="$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$GITHUB_SHA"
        
        # Deployment ìƒì„±/ì—…ë°ì´íŠ¸
        kubectl create deployment $DEPLOYMENT_NAME --image=$IMAGE_TAG --dry-run -o yaml > deployment.yaml
        kubectl apply -f deployment.yaml
        kubectl rollout status deployment/$DEPLOYMENT_NAME

        # Service LoadBalancer ìƒì„±/ì—…ë°ì´íŠ¸
        kubectl create service loadbalancer $DEPLOYMENT_NAME --tcp=80:$PORT --dry-run -o yaml > service.yaml
        kubectl apply -f service.yaml
        
        kubectl get services -o wide
      continue-on-error: true

    - name: Get Service Public Hostname and Healthcheck
      id: get_host_health
      if: always() && env.AUTH_SUCCESS == 'true' # ðŸ‘ˆ ì¸ì¦ ì„±ê³µ ì‹œì—ë§Œ ì‹œë„ (ë°°í¬ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ë¬´ê´€)
      shell: bash
      run: |
        SERVICE_HOST=""
        MAX_TRIES=10
        
        # 1. ê³µìš© IPê°€ í• ë‹¹ë  ë•Œê¹Œì§€ ìž¬ì‹œë„
        for i in $(seq 1 $MAX_TRIES); do
          echo "Attempt $i/$MAX_TRIES: Getting public service IP..."
          # ì™¸ë¶€ IP (EXTERNAL-IP) ì»¬ëŸ¼ì—ì„œ pendingì´ ì•„ë‹Œ ê°’ì„ ì¶”ì¶œ
          SERVICE_HOST=$(kubectl get services $DEPLOYMENT_NAME -o jsonpath="{.status.loadBalancer.ingress[0].hostname}" 2>/dev/null)
          
          if [ -z "$SERVICE_HOST" ]; then
             SERVICE_HOST=$(kubectl get services $DEPLOYMENT_NAME -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>/dev/null)
          fi
          
          if [ -n "$SERVICE_HOST" ] && [ "$SERVICE_HOST" != "<pending>" ] && [ "$SERVICE_HOST" != "0.0.0.0" ]; then
            echo "âœ… Public Service Hostname/IP found: $SERVICE_HOST"
            break
          fi
          
          echo "Service IP still pending or not assigned. Waiting 10 seconds..."
          sleep 10
          SERVICE_HOST=""
        done

        if [ -z "$SERVICE_HOST" ]; then
          echo "âŒ Failed to get public service IP after $MAX_TRIES attempts. Skipping healthcheck."
          echo "SERVICE_URL_FINAL=(Not Available)" >> $GITHUB_ENV
          exit 0
        fi

        # 2. curl í—¬ìŠ¤ ì²´í¬
        echo "--- Running Healthcheck ---"
        CURL_URL="http://$SERVICE_HOST:$PORT"
        echo "Checking $CURL_URL..."
        
        # 3ë²ˆ ìž¬ì‹œë„
        for i in 1 2 3; do
          if curl -fsS "$CURL_URL" > /dev/null; then
            echo "âœ… Healthcheck successful (try $i)."
            echo "SERVICE_URL_FINAL=$CURL_URL" >> $GITHUB_ENV
            exit 0
          else
            echo "âŒ Healthcheck failed (try $i). Waiting 5 seconds..." >&2
            sleep 5
          fi
        done
        
        echo "--- Healthcheck failed after retries. ---" >&2
        echo "SERVICE_URL_FINAL=$CURL_URL (Check Failed)" >> $GITHUB_ENV
        exit 0
      continue-on-error: true
      
    # --- [ ìµœì¢… ê²°ê³¼ ì¶œë ¥ ] ---
    - name: Final Deployment Status
      run: |
        echo "======================================================"
        echo "ðŸŽ‰ W O R K F L O W   C O M P L E T E D (SafeContinue)"
        echo "======================================================"
        echo "Deployment Status: All steps attempted."
        echo "Deployment Name: ${DEPLOYMENT_NAME}"
        echo "IKS Cluster: ${IKS_CLUSTER}"
        echo "--- Service Endpoint ---"
        echo "**FINAL SERVICE URL: ${{ env.SERVICE_URL_FINAL || 'N/A' }}**"
        echo "======================================================"
      if: ${{ github.event.inputs.force_success_msg == 'true' || github.event.inputs.force_success_msg == '' }}
