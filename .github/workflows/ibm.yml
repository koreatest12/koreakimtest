name: Build and Deploy to IKS (rev4)

on:
  push:
    branches: [ "main" ]

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  GITHUB_SHA: ${{ github.sha }}
  IBM_CLOUD_REGION: us-south 
  REGISTRY_HOSTNAME: us.icr.io
  IMAGE_NAME: iks-test
  IKS_CLUSTER: example-iks-cluster-name-or-id
  DEPLOYMENT_NAME: iks-test
  PORT: 5001

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    # ---

    # âš ï¸ [ìˆ˜ì • ë°˜ì˜] ì‹œí¬ë¦¿ì´ ì—†ë”ë¼ë„ ì‹¤íŒ¨í•˜ì§€ ì•Šê³  ê²½ê³  í›„ ê³„ì† ì§„í–‰
    - name: Check Required Secrets (Continue on Missing)
      id: check_secrets
      shell: bash
      run: |
        echo "--- Checking Required Secrets ---"
        
        # 1. API Key ì²´í¬: ì¸ì¦ì˜ í•µì‹¬. ì—†ìœ¼ë©´ í”Œëž˜ê·¸ ì„¤ì •
        if [ -z "${{ secrets.IBM_CLOUD_API_KEY }}" ]; then
          echo "âš ï¸ Warning: IBM_CLOUD_API_KEY secret is missing. Cloud authentication will fail." >&2
          echo "AUTH_OK=false" >> $GITHUB_ENV
        else
          echo "AUTH_OK=true" >> $GITHUB_ENV
        fi

        # 2. ICR Namespace ì²´í¬: íƒœê·¸ì˜ í•µì‹¬. ì—†ìœ¼ë©´ íƒœê·¸/í‘¸ì‹œ ì‹¤íŒ¨í•¨
        if [ -z "${{ secrets.ICR_NAMESPACE }}" ]; then
          echo "âš ï¸ Warning: ICR_NAMESPACE secret is missing. Image build/push will fail (invalid tag)." >&2
          echo "ICR_NAMESPACE_OK=false" >> $GITHUB_ENV
        else
          echo "ICR_NAMESPACE_OK=true" >> $GITHUB_ENV
        fi
        
        # 3. í•„ìˆ˜ ì‹œí¬ë¦¿ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì • (ê°’ì´ ë¹„ì–´ìžˆë”ë¼ë„ ì„¤ì •ì€ ì§„í–‰)
        echo "ICR_NAMESPACE=${{ secrets.ICR_NAMESPACE }}" >> $GITHUB_ENV
        echo "IBM_CLOUD_API_KEY=${{ secrets.IBM_CLOUD_API_KEY }}" >> $GITHUB_ENV
        
        echo "Secret check complete. Proceeding regardless of status."
      
    # ---

    # Download and Install IBM Cloud CLI
    - name: Install IBM Cloud CLI
      run: |
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        ibmcloud --version
        ibmcloud config --check-version=false
        ibmcloud plugin install -f kubernetes-service
        ibmcloud plugin install -f container-registry
        
    # ---

    # Authenticate with IBM Cloud CLI
    - name: Authenticate with IBM Cloud CLI
      if: env.AUTH_OK == 'true' # ðŸ‘ˆ AUTH_OK=trueì¼ ë•Œë§Œ ì‹œë„
      id: ibm_auth
      run: |
        ibmcloud login --apikey "${IBM_CLOUD_API_KEY}" -r "${IBM_CLOUD_REGION}" -g default
        # ì¸ì¦ ì„±ê³µ ì—¬ë¶€ë¥¼ í”Œëž˜ê·¸ì— ì €ìž¥í•˜ì—¬ ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©
        if [ $? -eq 0 ]; then
          echo "AUTH_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "AUTH_SUCCESS=false" >> $GITHUB_ENV
        fi
      continue-on-error: true 
        
    # ---

    # Build the Docker image
    - name: Build with Docker
      if: env.ICR_NAMESPACE_OK == 'true' # ðŸ‘ˆ íƒœê·¸ ìƒì„±ì´ ê°€ëŠ¥í•  ë•Œë§Œ ë¹Œë“œ ì‹œë„
      id: docker_build
      run: |
        # ì˜¬ë°”ë¥¸ íƒœê·¸ ìƒì„±: $REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$GITHUB_SHA
        docker build -t "$REGISTRY_HOSTNAME"/"$ICR_NAMESPACE"/"$IMAGE_NAME":"$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" .
        # ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ë¥¼ í”Œëž˜ê·¸ì— ì €ìž¥
        if [ $? -eq 0 ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
      continue-on-error: true
          
    # ---

    # Docker Registry Login and Push
    - name: Push the image to ICR
      if: env.AUTH_SUCCESS == 'true' && env.BUILD_SUCCESS == 'true' # ðŸ‘ˆ ì¸ì¦ê³¼ ë¹Œë“œê°€ ëª¨ë‘ ì„±ê³µí–ˆì„ ë•Œë§Œ í‘¸ì‹œ ì‹œë„
      run: |
        echo "Attempting container registry login..."
        ibmcloud cr region-set "${IBM_CLOUD_REGION}"
        ibmcloud cr login
        echo "Pushing image to ICR..."
        docker push $REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$GITHUB_SHA
      continue-on-error: true
        
    # ---

    # Deploy the Docker image to the IKS cluster
    - name: Deploy to IKS
      if: env.AUTH_SUCCESS == 'true' && env.BUILD_SUCCESS == 'true' # ðŸ‘ˆ ì¸ì¦ê³¼ ë¹Œë“œê°€ ëª¨ë‘ ì„±ê³µí–ˆì„ ë•Œë§Œ ë°°í¬ ì‹œë„
      run: |
        echo "Attempting IKS Deployment..."
        # IKS í´ëŸ¬ìŠ¤í„° ì„¤ì •ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        ibmcloud ks cluster config --cluster $IKS_CLUSTER
        kubectl config current-context
        
        IMAGE_TAG="$REGISTRY_HOSTNAME/$ICR_NAMESPACE/$IMAGE_NAME:$GITHUB_SHA"
        
        # Deployment ìƒì„±/ì—…ë°ì´íŠ¸
        kubectl create deployment $DEPLOYMENT_NAME --image=$IMAGE_TAG --dry-run -o yaml > deployment.yaml
        kubectl apply -f deployment.yaml
        kubectl rollout status deployment/$DEPLOYMENT_NAME

        # Service LoadBalancer ìƒì„±/ì—…ë°ì´íŠ¸
        kubectl create service loadbalancer $DEPLOYMENT_NAME --tcp=80:$PORT --dry-run -o yaml > service.yaml
        kubectl apply -f service.yaml
        
        kubectl get services -o wide
      continue-on-error: true
