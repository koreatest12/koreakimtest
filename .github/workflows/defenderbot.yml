name: "üõ°Ô∏è DefenderBot ‚Äî FULL PIPELINE (Build‚ÜíDocker‚ÜíRelease‚ÜíUpgrade, No-Skip, Safe-Continue, Audit+RunnerDump)"

on:
  push:
    branches: [ "main" ]
    paths:
      - "pom.xml"
      - "src/**"
      - "Dockerfile"
      - "docker/**"
      - "deploy/**"
      - ".github/workflows/defenderbot.yml"
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (ex: v1.2.3). Îπà Í∞íÏù¥Î©¥ manual-<sha7>"
        required: false
        default: ""
      image_tag:
        description: "Docker image tag override. Îπà Í∞íÏù¥Î©¥ sha-<sha7>"
        required: false
        default: ""
      upgrade:
        description: "ÏõêÍ≤© ÏóÖÍ∑∏Î†àÏù¥Îìú ÏãúÎèÑ Ïó¨Î∂Ä(true/false). ÏóÜÏñ¥ÎèÑ Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏ÏùÄ Ìï≠ÏÉÅ ÏßÑÌñâ"
        required: false
        default: "false"
      distro_image:
        description: "Ï∂îÍ∞Ä base Ïù¥ÎØ∏ÏßÄ ÎπåÎìú (ubuntu|ubi|none)"
        required: false
        default: "none"
      variant:
        description: "ÏÑ†ÌÉù Ïã§Ìñâ Î™®Îìú ÎùºÎ≤® (Ïòà: docker/linux/java/python)"
        required: false
        default: ""
  workflow_call:
    inputs:
      release_tag:
        required: false
        type: string
        default: ""
      image_tag:
        required: false
        type: string
        default: ""
      upgrade:
        required: false
        type: string
        default: "false"
      distro_image:
        required: false
        type: string
        default: "none"
      variant:
        required: false
        type: string
        default: ""

permissions:
  contents: write      # GH Release
  packages: write      # GHCR push
  id-token: write      # (ÌôïÏû•: OIDC Îì±)

env:
  TZ: Asia/Seoul
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  JAVA_VERSION: "17"

  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  DIST_DIR: dist
  TARGET_JAR: target/defenderbot.jar

  CONTAINER_NAME: defenderbot
  HOST_PORT: "8080"
  CONTAINER_PORT: "8080"

concurrency:
  group: defenderbot-${{ github.ref }}
  cancel-in-progress: false

jobs:
  full-pipeline:
    name: "DefenderBot Full Pipeline (No-Skip Everything + Audit)"
    runs-on: ubuntu-24.04
    continue-on-error: true

    steps:
      ########################################################################
      # 0. Checkout Î®ºÏ†Ä (Ï§ëÏöî: checkoutÏù¥ .github ÎîîÎ†âÌÜ†Î¶¨ ÎçÆÏñ¥Ïì∞ÎØÄÎ°ú mkdirÏùÄ checkout Ïù¥ÌõÑÏóê!)
      ########################################################################
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Resolve workflow inputs
        shell: bash
        run: |
          set -Eeuo pipefail
          release=""
          image=""
          upgrade="false"
          distro="none"
          variant=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            release="${{ github.event.inputs.release_tag || '' }}"
            image="${{ github.event.inputs.image_tag || '' }}"
            upgrade="${{ github.event.inputs.upgrade || 'false' }}"
            distro="${{ github.event.inputs.distro_image || 'none' }}"
            variant="${{ github.event.inputs.variant || '' }}"
          elif [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            release="${{ inputs.release_tag }}"
            image="${{ inputs.image_tag }}"
            upgrade="${{ inputs.upgrade }}"
            distro="${{ inputs.distro_image }}"
            variant="${{ inputs.variant }}"
          fi
          echo "WF_RELEASE=$release" >> "$GITHUB_ENV"
          echo "WF_IMAGE=$image" >> "$GITHUB_ENV"
          echo "WF_UPGRADE=$upgrade" >> "$GITHUB_ENV"
          echo "WF_DISTRO=$distro" >> "$GITHUB_ENV"
          echo "WF_VARIANT=$variant" >> "$GITHUB_ENV"

          suffix="$variant"
          if [[ -z "$suffix" ]]; then
            suffix="default"
          fi
          if [[ -n "$distro" && "$distro" != "none" ]]; then
            suffix="${suffix}-${distro}"
          fi
          # sanitize (replace spaces/unsafe chars with dash)
          suffix="${suffix//[^a-zA-Z0-9_-]/-}"
          echo "ARTIFACT_SUFFIX=$suffix" >> "$GITHUB_ENV"

          if [[ -z "$variant" || "$variant" == "docker" ]]; then
            echo "IS_PRIMARY_VARIANT=true" >> "$GITHUB_ENV"
          else
            echo "IS_PRIMARY_VARIANT=false" >> "$GITHUB_ENV"
          fi

      ########################################################################
      # 1. Í≥µÏö© ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ + Ïª®ÌÖçÏä§Ìä∏/Îü¨ÎÑà ÏÉÅÌÉú Îç§ÌîÑ (Ïö¥ÏòÅ Í∞êÏÇ¨Ïö©)
      ########################################################################
      - name: Prep dirs / dump context / runner snapshot
        shell: bash
        run: |
          set -Eeuo pipefail

          # ÌïÑÏàò ÎîîÎ†âÌÜ†Î¶¨/keep ÌååÏùº Ï§ÄÎπÑ
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" target "${DIST_DIR}"
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

          # ÌååÏù¥ÌîÑÎùºÏù∏ ÏãúÏûë Î°úÍ∑∏
          echo "[`date '+%Y-%m-%d %H:%M:%S%z'`] pipeline.start" | tee "${LOG_DIR}/00_pipeline_start.log"

          # Ïã§Ìñâ Ïª®ÌÖçÏä§Ìä∏ ÏöîÏïΩ Ï†ÄÏû• (ÎàÑÍ∞Ä/Ïñ∏Ï†ú/Ïñ¥Îñ§ Î∏åÎûúÏπò/Ïñ¥Îñ§ SHA)
          {
            echo "=== PIPELINE CONTEXT DUMP ==="
            echo "EVENT_NAME=${{ github.event_name }}"
            echo "REPO=${{ github.repository }}"
            echo "REF=${{ github.ref }}"
            echo "SHA=${{ github.sha }}"
            echo "ACTOR=${{ github.actor }}"
            echo "RUN_ID=${{ github.run_id }}"
            echo "RUN_NUMBER=${{ github.run_number }}"
            echo "WORKFLOW=${{ github.workflow }}"
            echo "TZ=$TZ"
            echo "WF_RELEASE=${WF_RELEASE}"
            echo "WF_IMAGE=${WF_IMAGE}"
            echo "WF_UPGRADE=${WF_UPGRADE}"
            echo "WF_DISTRO=${WF_DISTRO}"
            echo "WF_VARIANT=${WF_VARIANT}"
            echo "-----------------------------"
            env | sort
          } | tee "${LOG_DIR}/01_context_dump.log"

          # Îü¨ÎÑà/ÌôòÍ≤Ω Ïä§ÎÉÖÏÉ∑ (ÎπåÎìú Ï†Ñ ÏÉÅÌÉú Í∏∞Î°ù)
          {
            echo "=== RUNNER SNAPSHOT (BEFORE BUILD) ==="
            echo "--- uname -a"
            uname -a || true
            echo
            echo "--- lsb_release -a"
            lsb_release -a || true
            echo
            echo "--- df -h"
            df -h || true
            echo
            echo "--- free -m"
            free -m || true
            echo
            echo "--- docker version"
            docker version || true
            echo
            echo "--- docker info"
            docker info || true
            echo
            echo "--- whoami / pwd"
            whoami || true
            pwd || true
            echo
          } | tee "${LOG_DIR}/02_runner_snapshot_prebuild.log"

      ########################################################################
      # 2. Maven Build (Ï†àÎåÄ Ï§ëÎã® Ïïà Ìï®, Ïã§Ìå®Ìï¥ÎèÑ dummy JAR Í∞ïÏ†ú ÏÉùÏÑ±)
      ########################################################################
      - name: Set up Temurin JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Maven package (PR=skipTests)
        id: maven_build
        shell: bash
        run: |
          set -Eeuo pipefail
          # (Î∞©Ïñ¥Ï†Å) ÎîîÎ†âÌÜ†Î¶¨ Îã§Ïãú Î≥¥Í∞ï
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" target "${DIST_DIR}"
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CMD="mvn -q -DskipTests package"
          else
            CMD="mvn -q package"
          fi

          echo "‚ñ∂ Running: $CMD" | tee "${LOG_DIR}/10_maven_cmd.log"

          if $CMD 2>&1 | tee "${LOG_DIR}/11_maven_build_full.log"; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "[OK] Maven build success" | tee -a "${LOG_DIR}/11_maven_build_full.log"
          else
            echo "build_status=failure" >> $GITHUB_OUTPUT
            echo "[WARN] Maven build failed, pipeline continues" | tee -a "${LOG_DIR}/11_maven_build_full.log"
          fi

          # jar ÏÇ∞Ï∂úÎ¨º ÌôïÎ≥¥
          REAL_JAR="$(ls target/*.jar 2>/dev/null | head -n1 || true)"
          if [[ -n "$REAL_JAR" ]]; then
            cp -f "$REAL_JAR" "${{ env.TARGET_JAR }}" || true
          fi

          # Ïã§Ìå® Ïãú dummy jar ÏÉùÏÑ± (ÌõÑÏÜç docker Îã®Í≥ÑÍ∞Ä Ï†àÎåÄ Î©àÏ∂îÏßÄ ÏïäÍ≤å)
          if [[ ! -f "${{ env.TARGET_JAR }}" ]]; then
            echo "[WARN] No real JAR found, creating dummy jar" | tee -a "${LOG_DIR}/11_maven_build_full.log"
            echo "Dummy JAR placeholder (build failed) $(date '+%Y-%m-%d %H:%M:%S%z')" > dummy.txt
            zip -q -j "${{ env.TARGET_JAR }}" dummy.txt || true
          fi

          # Ïã§Ìå® ÌùîÏ†Å
          if [[ "$(cat $GITHUB_OUTPUT | grep build_status | cut -d= -f2)" != "success" ]]; then
            echo "BUILD_FAILED_AT=$(date '+%Y-%m-%d %H:%M:%S%z')" > target/BUILD_FAILED.txt
          fi

          # ÎÇòÏ§ë ÏóÖÎ°úÎìúÎ•º ÏúÑÌï¥ keep Î≥¥Í∞ï
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

      - name: Upload build logs/artifacts snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defenderbot-build-step-${{ env.ARTIFACT_SUFFIX }}
          path: |
            ${{ env.LOG_DIR }}/00_pipeline_start.log
            ${{ env.LOG_DIR }}/01_context_dump.log
            ${{ env.LOG_DIR }}/02_runner_snapshot_prebuild.log
            ${{ env.LOG_DIR }}/10_maven_cmd.log
            ${{ env.LOG_DIR }}/11_maven_build_full.log
            ${{ env.LOG_DIR }}/.keep
            target/BUILD_FAILED.txt
            target/.keep
            ${{ env.TARGET_JAR }}
          if-no-files-found: warn

      ########################################################################
      # 3. Docker Build & Push (Ïù¥ÎØ∏ÏßÄ ÎπåÎìú, ÌÉúÍ∑∏ Í≥ÑÏÇ∞, Ìó¨Ïä§Ï≤¥ÌÅ¨ÍπåÏßÄ ÏãúÎèÑ)
      ########################################################################
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        continue-on-error: true

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        continue-on-error: true

      - name: Docker login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Compute image tag
        id: image_tag_calc
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" target "${DIST_DIR}"
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          FINAL_TAG="sha-${SHORT_SHA}"

          if [[ -n "${WF_IMAGE}" ]]; then
            FINAL_TAG="${WF_IMAGE}"
          fi

          echo "final_tag=$FINAL_TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG_FINAL=$FINAL_TAG" | tee "${LOG_DIR}/20_image_tag.log"

      - name: Build & Push main app image
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" target "${DIST_DIR}"
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

          IMG_TAG="${{ steps.image_tag_calc.outputs.final_tag }}"
          IMAGE_FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMG_TAG}"

          echo "‚ñ∂ Building ${IMAGE_FULL}" | tee "${LOG_DIR}/21_docker_build_main.log"

          docker buildx build \
            --platform linux/amd64 \
            --file Dockerfile \
            --tag "${IMAGE_FULL}" \
            --push \
            . 2>&1 | tee -a "${LOG_DIR}/21_docker_build_main.log" || true

          docker images 2>&1 | tee "${LOG_DIR}/22_docker_images_after_main.log" || true
          docker history "${IMAGE_FULL}" 2>&1 | tee "${LOG_DIR}/23_docker_history_main.log" || true

      - name: Docker container healthcheck (run/exit test)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}"
          touch "${LOG_DIR}/.keep"

          IMG_TAG="${{ steps.image_tag_calc.outputs.final_tag }}"
          IMAGE_FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMG_TAG}"

          echo "‚ñ∂ Smoke run container for ${IMAGE_FULL}" | tee "${LOG_DIR}/23b_docker_healthcheck.log"
          # Ïó¨Í∏∞ÏÑúÎäî Îã®ÏàúÌïòÍ≤å Ïª®ÌÖåÏù¥ÎÑà Ìïú Î≤à ÎùÑÏõåÎ≥¥Í≥† java -version ÎπÑÏä∑Ìïú ÎèôÏûëÎßå ÏãúÎèÑ.
          # Spring Boot appÏù¥Îùº Î∞îÎ°ú Ï¢ÖÎ£å Ïïà Ìï† ÏàòÎèÑ ÏûàÏßÄÎßå Ïñ¥Ï®åÎì† ÏãúÎèÑÎßå: Ïã§Ìå®Ìï¥ÎèÑ true Ï≤òÎ¶¨
          docker run --rm "${IMAGE_FULL}" sh -c 'if command -v java >/dev/null 2>&1; then java -version; elif command -v python >/dev/null 2>&1; then python --version; else echo "No java or python runtime detected"; fi' \
            2>&1 | tee -a "${LOG_DIR}/23b_docker_healthcheck.log" || true

      - name: Optionally build distro images (ubuntu / ubi)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" target "${DIST_DIR}"
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" target/.keep "${DIST_DIR}/.keep"

          DISTRO_REQ="${WF_DISTRO:-none}"
          if [[ -z "$DISTRO_REQ" ]]; then
            DISTRO_REQ="none"
          fi

          IMG_TAG="${{ steps.image_tag_calc.outputs.final_tag }}"
          echo "Requested distro build: ${DISTRO_REQ}" | tee "${LOG_DIR}/24_distro_build.log"

          case "$DISTRO_REQ" in
            ubuntu)
              if [[ -f docker/ubuntu/Dockerfile ]]; then
                docker build \
                  -t "${{ env.REGISTRY }}/${{ github.repository_owner }}/ubuntu:${IMG_TAG}" \
                  -f docker/ubuntu/Dockerfile docker/ubuntu \
                  2>&1 | tee -a "${LOG_DIR}/24_distro_build.log" || true
                docker push "${{ env.REGISTRY }}/${{ github.repository_owner }}/ubuntu:${IMG_TAG}" || true
              else
                echo "[WARN] docker/ubuntu/Dockerfile ÏóÜÏùå" | tee -a "${LOG_DIR}/24_distro_build.log"
              fi
              ;;
            ubi)
              if [[ -f docker/ubi/Dockerfile ]]; then
                docker build \
                  -t "${{ env.REGISTRY }}/${{ github.repository_owner }}/ubi:${IMG_TAG}" \
                  -f docker/ubi/Dockerfile docker/ubi \
                  2>&1 | tee -a "${LOG_DIR}/24_distro_build.log" || true
                docker push "${{ env.REGISTRY }}/${{ github.repository_owner }}/ubi:${IMG_TAG}" || true
              else
                echo "[WARN] docker/ubi/Dockerfile ÏóÜÏùå" | tee -a "${LOG_DIR}/24_distro_build.log"
              fi
              ;;
            *)
              echo "No distro image build requested or 'none'." | tee -a "${LOG_DIR}/24_distro_build.log"
              ;;
          esac

      - name: Upload docker logs/artifacts snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defenderbot-docker-step-${{ env.ARTIFACT_SUFFIX }}
          path: |
            ${{ env.LOG_DIR }}/20_image_tag.log
            ${{ env.LOG_DIR }}/21_docker_build_main.log
            ${{ env.LOG_DIR }}/22_docker_images_after_main.log
            ${{ env.LOG_DIR }}/23_docker_history_main.log
            ${{ env.LOG_DIR }}/23b_docker_healthcheck.log
            ${{ env.LOG_DIR }}/24_distro_build.log
            ${{ env.LOG_DIR }}/.keep
          if-no-files-found: warn

      ########################################################################
      # 4. Release ÏÉùÏÑ± (Ìï≠ÏÉÅ ÏãúÎèÑ, ÌÉúÍ∑∏ ÏóÜÏúºÎ©¥ manual-<sha7>)
      ########################################################################
      - name: Prepare dist dir & checksum
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        id: release_prep
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep

          echo "‚ñ∂ Copy final JAR to dist" | tee "${LOG_DIR}/30_release_prep.log"
          cp -f "${{ env.TARGET_JAR }}" "${DIST_DIR}/" 2>>"${LOG_DIR}/30_release_prep.log" || true

          if ls "${DIST_DIR}"/*.jar >/dev/null 2>&1; then
            for f in "${DIST_DIR}"/*.jar; do
              sha256sum "$f" > "$f.sha256" || true
            done
          else
            echo "[WARN] no jar in dist for checksum" | tee -a "${LOG_DIR}/30_release_prep.log"
          fi

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          FALLBACK="manual-${SHORT_SHA}"
          FINAL_REL_TAG="$FALLBACK"

          if [[ -n "${WF_RELEASE}" ]]; then
            FINAL_REL_TAG="${WF_RELEASE}"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            FINAL_REL_TAG="${GITHUB_REF##refs/tags/}"
          fi

          echo "release_tag_final=$FINAL_REL_TAG" >> $GITHUB_OUTPUT
          echo "FINAL_RELEASE_TAG=$FINAL_REL_TAG" | tee -a "${LOG_DIR}/30_release_prep.log"
          echo "FINAL_RELEASE_TAG=$FINAL_REL_TAG" >> "$GITHUB_ENV"

      - name: Upload release prep logs/artifacts snapshot
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: defenderbot-release-prep-step-${{ env.ARTIFACT_SUFFIX }}
          path: |
            ${{ env.LOG_DIR }}/30_release_prep.log
            ${{ env.LOG_DIR }}/.keep
            ${{ env.DIST_DIR }}/*.jar
            ${{ env.DIST_DIR }}/*.sha256
            ${{ env.DIST_DIR }}/.keep
          if-no-files-found: warn

      - name: Create / Update GitHub Release
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.FINAL_RELEASE_TAG }}
          name: DefenderBot ${{ env.FINAL_RELEASE_TAG }}
          draft: false
          prerelease: false
          files: |
            ${{ env.DIST_DIR }}/*.jar
            ${{ env.DIST_DIR }}/*.sha256
        continue-on-error: true

      ########################################################################
      # 5. Remote Upgrade (ssh-agent ÏóÜÏù¥, soft-pass / Îü¨ÎÑàÏÉÅÌÉú Ïû¨Í∏∞Î°ù)
      ########################################################################
      - name: Install SSH client
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y openssh-client || true
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep
          echo "[OK] ssh client ready" | tee "${LOG_DIR}/40_upgrade_sshclient.log"

          # ÏóÖÍ∑∏Î†àÏù¥Îìú ÏßÅÏ†Ñ Îü¨ÎÑà snapshot (Î∞∞Ìè¨ ÌÉÄÏù¥Î∞çÏùò ÏãúÏä§ÌÖú ÏÉÅÌÉú)
          {
            echo "=== RUNNER SNAPSHOT (BEFORE REMOTE UPGRADE) ==="
            uname -a || true
            df -h || true
            free -m || true
            docker ps -a || true
            docker images || true
          } | tee "${LOG_DIR}/40b_runner_snapshot_pre_upgrade.log"

      - name: Compute upgrade enable & tag
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        id: upgrade_calc
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep

          UPG_REQ="${WF_UPGRADE:-false}"
          case "$UPG_REQ" in
            true|TRUE|True|yes|YES)
              UPG_REQ="true"
              ;;
            *)
              UPG_REQ="false"
              ;;
          esac

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          FINAL_TAG="sha-${SHORT_SHA}"
          if [[ -n "${WF_IMAGE}" ]]; then
            FINAL_TAG="${WF_IMAGE}"
          fi

          echo "upgrade_request=$UPG_REQ" >> $GITHUB_OUTPUT
          echo "deploy_tag=$FINAL_TAG" >> $GITHUB_OUTPUT

          {
            echo "UPGRADE_REQUEST=$UPG_REQ"
            echo "DEPLOY_TAG=$FINAL_TAG"
          } | tee "${LOG_DIR}/41_upgrade_calc.log"

      - name: Register known_hosts (if host provided)
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep

          if [[ -n "${{ secrets.SERVER_HOST }}" ]]; then
            ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts || true
            echo "known_hosts updated for ${{ secrets.SERVER_HOST }}" | tee "${LOG_DIR}/42_known_hosts.log"
          else
            echo "[WARN] SERVER_HOST secret missing, will not SSH" | tee "${LOG_DIR}/42_known_hosts.log"
          fi

      - name: Remote pull & restart container
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' }}
        shell: bash
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep

          echo ">>> REMOTE UPGRADE STEP"          | tee "${LOG_DIR}/43_remote_upgrade.log"
          echo "SERVER_HOST=${SERVER_HOST}"      | tee -a "${LOG_DIR}/43_remote_upgrade.log"
          echo "SERVER_USER=${SERVER_USER}"      | tee -a "${LOG_DIR}/43_remote_upgrade.log"

          if [[ "${{ steps.upgrade_calc.outputs.upgrade_request }}" != "true" ]]; then
            echo "[INFO] upgrade_request != true, soft-pass" | tee -a "${LOG_DIR}/43_remote_upgrade.log"
            exit 0
          fi
          if [[ -z "${SERVER_HOST}" || -z "${SERVER_USER}" || -z "${GITHUB_TOKEN}" ]]; then
            echo "[WARN] Missing SERVER_HOST / SERVER_USER / GITHUB_TOKEN -> cannot SSH deploy. soft-pass." | tee -a "${LOG_DIR}/43_remote_upgrade.log"
            exit 0
          fi

          IMG_TAG="${{ steps.upgrade_calc.outputs.deploy_tag }}"
          REMOTE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMG_TAG}"
          echo "[INFO] Using remote image ${REMOTE_IMAGE}" | tee -a "${LOG_DIR}/43_remote_upgrade.log"

          # ssh-agent ÏóÜÏù¥ Í∏∞Î≥∏ ssh ÌÇ§Îßå ÏÇ¨Ïö©.
          ssh -o StrictHostKeyChecking=yes "${SERVER_USER}@${SERVER_HOST}" bash -lc "
            set -Eeuo pipefail
            echo '--- Remote Upgrade Script Started ---'

            echo \"\$GITHUB_TOKEN\" | docker login ${{ env.REGISTRY }} -u '${{ github.actor }}' --password-stdin || true

            echo 'Pulling image: ${REMOTE_IMAGE}'
            docker pull ${REMOTE_IMAGE} || true

            echo 'Stopping existing container if exists'
            docker rm -f ${{ env.CONTAINER_NAME }} 2>/dev/null || true

            echo 'Starting new container'
            docker run -d --name ${{ env.CONTAINER_NAME }} \
              -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
              --restart unless-stopped \
              ${REMOTE_IMAGE} || true

            echo '--- Remote Upgrade Script Finished ---'
          " || true

      - name: Upload upgrade logs/artifacts snapshot
        if: ${{ env.IS_PRIMARY_VARIANT == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: defenderbot-upgrade-step-${{ env.ARTIFACT_SUFFIX }}
          path: |
            ${{ env.LOG_DIR }}/40_upgrade_sshclient.log
            ${{ env.LOG_DIR }}/40b_runner_snapshot_pre_upgrade.log
            ${{ env.LOG_DIR }}/41_upgrade_calc.log
            ${{ env.LOG_DIR }}/42_known_hosts.log
            ${{ env.LOG_DIR }}/43_remote_upgrade.log
            ${{ env.LOG_DIR }}/.keep
          if-no-files-found: warn

      ########################################################################
      # 6. FINAL PIPELINE SNAPSHOT (Ï†ÑÏ≤¥ ÏàòÏßë)
      ########################################################################
      - name: Final snapshot & upload all
        if: always()
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${DIST_DIR}" target
          touch "${LOG_DIR}/.keep" "${ARTIFACT_DIR}/.keep" "${DIST_DIR}/.keep" target/.keep

          # ÌååÏù¥ÌîÑÎùºÏù∏ Ï¢ÖÎ£å Î°úÍ∑∏
          echo "[`date '+%Y-%m-%d %H:%M:%S%z'`] pipeline.end (ALL STEPS ATTEMPTED)" \
            | tee "${LOG_DIR}/99_pipeline_end.log"

          # ÎßàÏßÄÎßâ Îü¨ÎÑà ÏÉÅÌÉú Ìïú Î≤à Îçî Ï∫°Ï≤ò
          {
            echo "=== RUNNER SNAPSHOT (FINAL) ==="
            uname -a || true
            df -h || true
            free -m || true
            docker ps -a || true
            docker images || true
          } | tee "${LOG_DIR}/98_runner_snapshot_final.log"

      - name: Upload ALL logs/final snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defenderbot-full-run-${{ env.ARTIFACT_SUFFIX }}
          path: |
            ${{ env.LOG_DIR }}/
            ${{ env.ARTIFACT_DIR }}/
            ${{ env.DIST_DIR }}/
            target/
          if-no-files-found: warn
