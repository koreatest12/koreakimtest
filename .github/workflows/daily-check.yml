name: "Dependency Security Check + AutoUpgrade"

on:
  schedule:
    - cron: "0 3 * * 1"  # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC
  workflow_dispatch:
  pull_request:
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"
      - ".github/workflows/dependency-check.yml"
  push:
    branches: [ "main" ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"

permissions:
  contents: write
  pull-requests: write
  security-events: read
  id-token: write
  packages: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts

jobs:

  ##########################################################################
  # Node.js audit + upgrade
  ##########################################################################
  node-security:
    name: "Node.js Dependency Check + Upgrade"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: anthropic-cost-tracker/nodejs
            safe: anthropic-cost-tracker-nodejs
          - project: mcp-hello-js
            safe: mcp-hello-js
          - project: mcp-fs
            safe: mcp-fs

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_node
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          # helpers.sh (printfë§Œ ì‚¬ìš©)
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'            >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [$label] OK" | tee -a "$logfile"'  >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [$label] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/apt.fix.log"'      >> "$HELPER_PATH"
          printf '%s\n' '  echo "[fix] apt_fix start" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          chmod +x "$HELPER_PATH"
          echo "Node scan target: ${{ matrix.project }} (safe=${{ matrix.safe }})" | tee -a "${REPORT_DIR}/SUMMARY_node.txt"
      - name: Check project/package.json
        id: node_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/package.json" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Setup Node.js
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # intentionally no cache-dependency-path here to avoid cache errors

      - name: Install jq
        if: steps.node_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true
      - name: npm install / ci
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -f "package-lock.json" ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: npm audit (report only)
        if: steps.node_exists.outputs.exists == 'true'
        id: node_audit
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          echo "## NPM Audit for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"
          npm audit --json > audit.json || true
          npm audit >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo 0)
            CRIT_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json 2>/dev/null || echo 0)
          else
            HIGH_COUNT=0
            CRIT_COUNT=0
          fi
          echo "High severity: $HIGH_COUNT"
          echo "Critical severity: $CRIT_COUNT"
          echo "HIGH_COUNT=${HIGH_COUNT}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT_COUNT}" >> "$GITHUB_OUTPUT"
      - name: npm upgrade attempt (auto-fix vulnerabilities)
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          UPG_LOG="sec-upgrade.log"
          {
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') npm audit fix try"
            npm audit fix || true
            echo
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') npm audit fix --force try (may introduce breaking changes)"
            npm audit fix --force || true
            echo
            echo "### re-run npm audit --json after fix"
            npm audit --json || true
          } > "$UPG_LOG" 2>&1 || true
      - name: Upload Node audit artifact
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          # ì´ì œ artifact ì´ë¦„ì€ / ì—†ëŠ” safe ë¬¸ìì—´ë§Œ ì‚¬ìš©
          name: npm-audit-${{ github.run_number }}-${{ matrix.safe }}
          path: |
            ${{ matrix.project }}/audit.json
            ${{ matrix.project }}/sec-upgrade.log
          if-no-files-found: warn
          retention-days: 30

  ##########################################################################
  # Python audit + upgrade
  ##########################################################################
  python-security:
    name: "Python Dependency Check + Upgrade"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: anthropic-cost-tracker/python
            safe: anthropic-cost-tracker-python
          - project: mcp-hello-py
            safe: mcp-hello-py
          - project: mcp-python-server
            safe: mcp-python-server
          - project: mcp-apache-server
            safe: mcp-apache-server
          - project: .
            safe: root-dot

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_py
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          # ë®ì–´ì¨ë„ ë¬´ë°©
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'            >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [$label] OK" | tee -a "$logfile"'  >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [$label] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/apt.fix.log"'      >> "$HELPER_PATH"
          printf '%s\n' '  echo "[fix] apt_fix start" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          chmod +x "$HELPER_PATH"
          echo "Python scan target: ${{ matrix.project }} (safe=${{ matrix.safe }})" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check requirements.txt
        id: py_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Install security tools
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit || true
      - name: Ensure jq (for parsing)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true
      - name: pip-audit (report only)
        if: steps.py_exists.outputs.exists == 'true'
        id: py_audit
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          echo "## Pip Audit for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"
          pip-audit -r "${TARGET_DIR}/requirements.txt" --format json > "${TARGET_DIR}/pip-audit.json" || true
          pip-audit -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
          if command -v jq >/dev/null 2>&1 && [ -f "${TARGET_DIR}/pip-audit.json" ]; then
            HIGH=$(jq '[.[] | .vulns[]? | select(.severity=="HIGH")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
            CRIT=$(jq '[.[] | .vulns[]? | select(.severity=="CRITICAL")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
          else
            HIGH=0
            CRIT=0
          fi
          echo "High severity vulns: $HIGH"
          echo "Critical severity vulns: $CRIT"
          echo "HIGH_COUNT=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT}" >> "$GITHUB_OUTPUT"
      - name: safety check
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          echo "## Safety Check for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"
          safety check -r "${TARGET_DIR}/requirements.txt" --json > "${TARGET_DIR}/safety.json" || true
          safety check -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
      - name: bandit static analysis
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          bandit -r "$TARGET_DIR" -f json -o "$TARGET_DIR/bandit.json" || true
          echo "## Bandit Security Scan for $TARGET_DIR" >> "$GITHUB_STEP_SUMMARY"
          bandit -r "$TARGET_DIR" || echo "Bandit found issues" >> "$GITHUB_STEP_SUMMARY"
      - name: pip-audit --fix (auto upgrade attempt)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          UPG_LOG="${TARGET_DIR}/sec-upgrade.log"
          {
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') pip-audit --fix try"
            echo "(pip-auditê°€ ì•Œë ¤ì§„ ì·¨ì•½ íŒ¨í‚¤ì§€ë¥¼ ì—…ê·¸ë ˆì´ë“œ/íŒ¨ì¹˜ ê°€ëŠ¥í•œ ê²½ìš° ìë™ ì ìš©)"
            pip-audit -r "${TARGET_DIR}/requirements.txt" --fix || true
            echo
            echo "### re-run pip-audit for diff"
            pip-audit -r "${TARGET_DIR}/requirements.txt" --format json || true
          } > "$UPG_LOG" 2>&1 || true
      - name: Upload Python audit artifact
        if: steps.py_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: python-audit-${{ github.run_number }}-${{ matrix.safe }}
          path: |
            ${{ matrix.project }}/pip-audit.json
            ${{ matrix.project }}/safety.json
            ${{ matrix.project }}/bandit.json
            ${{ matrix.project }}/sec-upgrade.log
          if-no-files-found: warn
          retention-days: 30

  ##########################################################################
  # GitHub advisory gate on PR
  ##########################################################################
  dependency-review:
    name: "Dependency Review (PR gate)"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure

  ##########################################################################
  # Weekly scheduled run -> if any job failed, open issue
  ##########################################################################
  create-issue-on-weekly-failure:
    name: "Create Issue on Weekly Failure"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]
    if: github.event_name == 'schedule' && failure()

    steps:
      - name: Open or reuse security issue
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependency-check',
              state: 'open'
            });
            if (existing.data.length === 0) {
              const bodyText = [
                "ğŸš¨ Weekly dependency check reported failures.",
                "",
                "ì¼ë¶€ ë³´ì•ˆ ì ê²€ ë‹¨ê³„(npm audit / pip-audit / bandit / safety ë“±)ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜",
                "ìë™ ì—…ê·¸ë ˆì´ë“œ(npm audit fix / pip-audit --fix) ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.",
                "",
                `Run details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                "",
                "ì—…ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸(npm-audit-*, python-audit-*)ì˜ sec-upgrade.logë¥¼ ì°¸ê³ í•˜ì—¬",
                "ì–´ë–¤ íŒ¨í‚¤ì§€ë“¤ì´ ì‹¤ì œë¡œ ì—…ë°ì´íŠ¸/íŒ¨ì¹˜ ì‹œë„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
              ].join("\n");
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Dependency Security Check Failure (Weekly Scan w/ AutoUpgrade)",
                body: bodyText,
                labels: ["security", "dependency-check", "automated"]
              });
            }
