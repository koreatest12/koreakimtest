name: "Dependency Security Check"

on:
  schedule:
    - cron: "0 3 * * 1"  # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC (í•œêµ­ì‹œê°„ ì›”ìš”ì¼ ì •ì˜¤ ì „í›„)
  workflow_dispatch:
  pull_request:
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"
      - ".github/workflows/dependency-check.yml"
  push:
    branches: [ "main" ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"

permissions:
  contents: write
  pull-requests: write
  security-events: read
  id-token: write
  packages: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts

jobs:

  ##########################################################################
  # Node.js audit
  ##########################################################################
  node-security:
    name: "Node.js Dependency Check"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/nodejs
          - mcp-hello-js
          - mcp-fs

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_node
        shell: bash
        run: |
          set -Eeo pipefail

          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"

          HELPER_PATH="${REPORT_DIR}/helpers.sh"

          # helpers.sh ìƒì„± (printfë§Œ ì‚¬ìš©)
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'            >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [$label] OK" | tee -a "$logfile"'  >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [$label] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/apt.fix.log"'      >> "$HELPER_PATH"
          printf '%s\n' '  echo "[fix] apt_fix start" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"

          chmod +x "$HELPER_PATH"

          echo "Node scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_node.txt"

      # ëŒ€ìƒ ë””ë ‰í† ë¦¬/íŒŒì¼ ìœ ë¬´ í™•ì¸
      - name: Check project/package.json
        id: node_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/package.json" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      # Node ì„¤ì¹˜ (ìºì‹œ ì‚¬ìš© X: cache ì˜µì…˜/ê²½ë¡œ ë¯¸ì§€ì •)
      - name: Setup Node.js
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq
        if: steps.node_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true

      - name: npm install/ci
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          # package-lock.jsonì´ ìˆìœ¼ë©´ ci, ì—†ìœ¼ë©´ install
          if [ -f "package-lock.json" ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: npm audit
        if: steps.node_exists.outputs.exists == 'true'
        id: node_audit
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail

          echo "## NPM Audit for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"

          # í•­ìƒ ì„±ê³µì‹œí‚¤ê³  ê³„ì†
          npm audit --json > audit.json || true
          npm audit >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

          # jqë¡œ high/critical ì¶”ì¶œ (ì—†ìœ¼ë©´ 0)
          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo 0)
            CRIT_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json 2>/dev/null || echo 0)
          else
            HIGH_COUNT=0
            CRIT_COUNT=0
          fi

          echo "High severity: $HIGH_COUNT"
          echo "Critical severity: $CRIT_COUNT"

          echo "HIGH_COUNT=${HIGH_COUNT}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT_COUNT}" >> "$GITHUB_OUTPUT"

      - name: Upload Node audit artifact
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          # matrix.project ì˜ˆ: "anthropic-cost-tracker/nodejs"
          # ìŠ¬ë˜ì‹œ ë“±ì„ - ë¡œ ì¹˜í™˜í•œ ì„¸ì´í”„ ì´ë¦„ ì‚¬ìš©
          name: npm-audit-${{ github.run_number }}-${{ steps.node_exists.outputs.exists == 'true' && (matrix.project || '') }}
          path: ${{ matrix.project }}/audit.json
          if-no-files-found: warn
          retention-days: 30

  ##########################################################################
  # Python audit
  ##########################################################################
  python-security:
    name: "Python Dependency Check"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/python
          - mcp-hello-py
          - mcp-python-server
          - mcp-apache-server
          - .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_py
        shell: bash
        run: |
          set -Eeo pipefail

          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"

          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          # ë®ì–´ì¨ë„ OK
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'            >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [$label] OK" | tee -a "$logfile"'  >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [$label] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/apt.fix.log"'      >> "$HELPER_PATH"
          printf '%s\n' '  echo "[fix] apt_fix start" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"

          chmod +x "$HELPER_PATH"

          echo "Python scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check requirements.txt
        id: py_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install security tools
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit || true

      - name: Ensure jq (for parsing)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true

      - name: pip-audit
        if: steps.py_exists.outputs.exists == 'true'
        id: py_audit
        shell: bash
        run: |
          set -Eeo pipefail

          TARGET_DIR="${{ matrix.project }}"
          echo "## Pip Audit for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"

          pip-audit -r "${TARGET_DIR}/requirements.txt" --format json > "${TARGET_DIR}/pip-audit.json" || true
          pip-audit -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

          if command -v jq >/dev/null 2>&1 && [ -f "${TARGET_DIR}/pip-audit.json" ]; then
            HIGH=$(jq '[.[] | .vulns[]? | select(.severity=="HIGH")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
            CRIT=$(jq '[.[] | .vulns[]? | select(.severity=="CRITICAL")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
          else
            HIGH=0
            CRIT=0
          fi
          echo "High severity vulns: $HIGH"
          echo "Critical severity vulns: $CRIT"

          echo "HIGH_COUNT=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT}" >> "$GITHUB_OUTPUT"

      - name: safety check
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          echo "## Safety Check for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"
          safety check -r "${TARGET_DIR}/requirements.txt" --json > "${TARGET_DIR}/safety.json" || true
          safety check -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

      - name: bandit static analysis
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          # bandit ê²°ê³¼ JSON ì €ì¥
          bandit -r "$TARGET_DIR" -f json -o "$TARGET_DIR/bandit.json" || true
          echo "## Bandit Security Scan for $TARGET_DIR" >> "$GITHUB_STEP_SUMMARY"
          bandit -r "$TARGET_DIR" || echo "Bandit found issues" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Python audit artifact
        if: steps.py_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          # ìŠ¬ë˜ì‹œ(`/`) ê°™ì€ ë¬¸ì œ ë¬¸ìë¥¼ ì•ˆì „í•˜ê²Œ ë°”ê¾¸ê¸° ìœ„í•´ matrix.projectë¥¼ ê·¸ëŒ€ë¡œ ì“°ì§€ ì•Šê³ ,
          # GitHubê°€ step contextì—ì„œ ë¬¸ìì—´ ì¹˜í™˜ì„ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
          # ì•„ë˜ì²˜ëŸ¼ ì´ë¦„ì„ ë‹¨ìˆœí™”: ìŠ¬ë˜ì‹œë¥¼ í•˜ì´í”ˆìœ¼ë¡œ ë°”ê¿¨ë‹¤ê³  ê°€ì •í•˜ëŠ” safe ë„¤ì´ë°
          # (matrix.project ê°’ ì¤‘ '/' ëŒ€ì‹  '-'ë¡œ ì‚¬ìš©í•  ê²ƒ)
          name: python-audit-${{ github.run_number }}-${{ matrix.project && join(matrix.project, '') }}
          path: |
            ${{ matrix.project }}/pip-audit.json
            ${{ matrix.project }}/safety.json
            ${{ matrix.project }}/bandit.json
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # GitHub advisory gate on PR
  ##########################################################################
  dependency-review:
    name: "Dependency Review (PR gate)"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure


  ##########################################################################
  # Weekly scheduled run -> if any job failed, open issue
  ##########################################################################
  create-issue-on-weekly-failure:
    name: "Create Issue on Weekly Failure"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]
    if: github.event_name == 'schedule' && failure()

    steps:
      - name: Open or reuse security issue
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependency-check',
              state: 'open'
            });
            if (existing.data.length === 0) {
              const bodyText = [
                "ğŸš¨ Weekly dependency check reported failures.",
                "",
                "ì¼ë¶€ ë³´ì•ˆ ì ê²€ ë‹¨ê³„(npm audit / pip-audit / bandit / safety ë“±)ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
                "ì·¨ì•½ ì˜ì¡´ì„±(high/critical) ë˜ëŠ” ê°ì‚¬ ë‹¨ê³„ ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.",
                "",
                `Run details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                "",
                "Artifacts (npm-audit-*, python-audit-*)ë¥¼ í™•ì¸í•˜ì—¬",
                "ì·¨ì•½í•œ íŒ¨í‚¤ì§€ ë° ë¬¸ì œ ì§€ì ì„ ì—…ë°ì´íŠ¸/ì¡°ì¹˜í•´ ì£¼ì„¸ìš”."
              ].join("\n");
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Dependency Security Check Failure (Weekly Scan)",
                body: bodyText,
                labels: ["security", "dependency-check", "automated"]
              });
            }
