name: "Dependency Security Check"

on:
  schedule:
    - cron: "0 3 * * 1"  # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC (í•œêµ­ì‹œê°„ ì›”ìš”ì¼ ì •ì˜¤ì¯¤)
  workflow_dispatch:
  pull_request:
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"
      - ".github/workflows/dependency-check.yml"
  push:
    branches: [ "main" ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"

permissions:
  contents: write
  pull-requests: write
  security-events: read
  id-token: write
  packages: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts
  PERM_DIR: .github/sec_report/permissions

jobs:

  ##########################################################################
  # 0. ê³µí†µ Bootstrap: ë””ë ‰í† ë¦¬ / ê¶Œí•œ íŒŒì¼ / helpers.sh / ë³´ì•ˆ ìŠ¤ëƒ…ìƒ·
  ##########################################################################
  security-bootstrap:
    name: "Security Bootstrap (Dirs, Permissions, Helpers)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init security dirs, helper scripts, permission docs
        id: sec_boot
        shell: bash
        run: |
          set -Eeo pipefail

          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}" "${PERM_DIR}"

          # helpers.sh (printfë¡œ ìƒì„±)
          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          printf '%s\n' '#!/usr/bin/env bash'                           >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                              >> "$HELPER_PATH"
          printf '%s\n' ''                                              >> "$HELPER_PATH"
          printf '%s\n' '# LOG_BASE fallback'                           >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"'>> "$HELPER_PATH"
          printf '%s\n' ''                                              >> "$HELPER_PATH"
          printf '%s\n' '# safe_run helper'                             >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                  >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'             >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'    >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'           >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [$label] OK" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                  >> "$HELPER_PATH"
          printf '%s\n' '  else'                                        >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                               >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [$label] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                          >> "$HELPER_PATH"
          printf '%s\n' '}'                                             >> "$HELPER_PATH"
          printf '%s\n' ''                                              >> "$HELPER_PATH"
          printf '%s\n' '# apt_fix: unlock apt/dpkg and retry update'   >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/apt.fix.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "[fix] apt_fix start" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'            >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                             >> "$HELPER_PATH"

          chmod +x "$HELPER_PATH"

          # ê¶Œí•œ/ì •ì±… ë¬¸ì„œ ìƒì„±
          printf '%s\n' "# Global Security / Permission Policy"           >  "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' "Generated at: $(date '+%Y-%m-%d %H:%M:%S%z')"     >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' ""                                                >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' "- CI writes only under ${REPORT_DIR}"            >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' "- ${ARTIFACT_DIR} is for audit artifacts"        >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' "- ${LOG_DIR} may contain vuln scan logs"         >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"
          printf '%s\n' "- Never commit secrets here."                    >> "${PERM_DIR}/PERMISSIONS_GLOBAL.txt"

          printf '%s\n' "# Node Service Permission Notes"                 >  "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' "Generated at: $(date '+%Y-%m-%d %H:%M:%S%z')"     >> "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' ""                                                >> "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' "Intended Scopes:"                                >> "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' "- Read-only package.json / package-lock.json"    >> "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' "- Run npm audit locally in CI only"              >> "${PERM_DIR}/PERMISSIONS_NODE.txt"
          printf '%s\n' "- No external publish unless explicitly allowed" >> "${PERM_DIR}/PERMISSIONS_NODE.txt"

          printf '%s\n' "# Python Service Permission Notes"               >  "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' "Generated at: $(date '+%Y-%m-%d %H:%M:%S%z')"     >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' ""                                                >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' "Intended Scopes:"                                >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' "- Read-only requirements.txt"                    >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' "- Run pip-audit / safety / bandit only in CI"    >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"
          printf '%s\n' "- No production secrets in requirements.txt"     >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"

          printf '%s\n' "# SECURITY POLICY"                               >  "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' "This repo is scanned automatically for:"        >> "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' "- Vulnerable dependencies (npm audit, pip-audit, safety)" >> "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' "- Static analysis (bandit)"                      >> "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' "- Dependency review on PRs"                      >> "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' ""                                               >> "${PERM_DIR}/SECURITY_POLICY.md"
          printf '%s\n' "High/Critical findings must be fixed on SLA."   >> "${PERM_DIR}/SECURITY_POLICY.md"

          printf '%s\n' "Internal Security Readme"                       >  "${PERM_DIR}/SECURITY_README.txt"
          printf '%s\n' "Created: $(date '+%Y-%m-%d %H:%M:%S%z')"        >> "${PERM_DIR}/SECURITY_README.txt"
          printf '%s\n' "This folder documents security scans, perms."  >> "${PERM_DIR}/SECURITY_README.txt"

          # ëŸ¬ë„ˆ/ê¶Œí•œ ìŠ¤ëƒ…ìƒ·
          {
            echo "=== RUNTIME SECURITY SNAPSHOT (bootstrap) ==="
            echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S%z')"
            echo "Runner ID / UID / GID:"
            id
            echo
            echo "umask:"
            umask
            echo
            echo "REPORT_DIR tree:"
            ls -R "${REPORT_DIR}"
            echo
            echo "stat on REPORT_DIR (top-level dirs):"
            find "${REPORT_DIR}" -maxdepth 2 -type d -exec stat {} \; || true
          } | tee "${LOG_DIR}/security_snapshot_bootstrap.log"

      - name: Upload security bootstrap snapshot/artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-bootstrap-${{ github.run_number }}
          path: |
            .github/sec_report/permissions
            .github/sec_report/logs/security_snapshot_bootstrap.log
            .github/sec_report/helpers.sh
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # 1. Node.js audit (ì„œë¹„ìŠ¤ë³„ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ í™•ì¥)
  ##########################################################################
  node-security:
    name: "Node.js Dependency Check"
    runs-on: ubuntu-latest
    needs: [security-bootstrap]
    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/nodejs
          - mcp-hello-js
          - mcp-fs

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure dirs/helpers from bootstrap (self-heal)
        id: prep_node
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}" "${PERM_DIR}"
          if [ ! -f "${REPORT_DIR}/helpers.sh" ]; then
            HELPER_PATH="${REPORT_DIR}/helpers.sh"
            printf '%s\n' '#!/usr/bin/env bash' > "$HELPER_PATH"
            printf '%s\n' 'set -Eeo pipefail'  >> "$HELPER_PATH"
            printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
            printf '%s\n' 'safe_run() { local label="$1"; shift||true; local logfile="${LOG_BASE}/${label}.log"; echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START"|tee -a "$logfile"; if "$@" >>"$logfile" 2>&1; then echo "âœ… [$label] OK"|tee -a "$logfile"; else rc=$?; echo "âŒ [$label] FAILED exit=${rc}"|tee -a "$logfile"; return $rc; fi; }' >> "$HELPER_PATH"
            printf '%s\n' 'apt_fix(){ local logfile="${LOG_BASE}/apt.fix.log"; echo "[fix] apt_fix start"|tee -a "$logfile"; sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock*||true; sudo dpkg --configure -a||true; sudo apt-get update -y||sudo apt-get update -y||true; }' >> "$HELPER_PATH"
            chmod +x "$HELPER_PATH"
          fi

          SERVICE_SAFE_NAME="${{ matrix.project//\//- }}"
          echo "Node scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_node.txt"

          # ì„œë¹„ìŠ¤ë³„ ê¶Œí•œ ê¸°ë¡ append
          {
            echo "---- $(date '+%Y-%m-%d %H:%M:%S%z') NODE matrix.project=${{ matrix.project }} ----"
            echo "Intended read paths: ${{ matrix.project }}/package.json"
            echo "Intended write paths: ${REPORT_DIR}, ${LOG_DIR}, ${ARTIFACT_DIR}"
          } >> "${PERM_DIR}/PERMISSIONS_NODE.txt"

          # ì„œë¹„ìŠ¤ë³„ ìŠ¤ëƒ…ìƒ· ë¡œê·¸
          SNAP_LOG="${LOG_DIR}/security_snapshot_node_${SERVICE_SAFE_NAME}.log"
          {
            echo "=== NODE JOB SECURITY SNAPSHOT ==="
            echo "Project: ${{ matrix.project }}"
            echo "id:"; id
            echo
            echo "umask:"; umask
            echo
            echo "REPORT_DIR tree:"; ls -R "${REPORT_DIR}"
            echo
            echo "stat on REPORT_DIR:"; stat "${REPORT_DIR}" || true
          } | tee "${SNAP_LOG}"

          echo "SNAP_LOG=${SNAP_LOG}" >> "$GITHUB_OUTPUT"
          echo "SERVICE_SAFE_NAME=${SERVICE_SAFE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Check project/package.json
        id: node_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/package.json" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Install jq
        if: steps.node_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true

      - name: npm install/ci
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          npm ci || npm install

      - name: npm audit
        if: steps.node_exists.outputs.exists == 'true'
        id: node_audit
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          echo "## NPM Audit for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"

          npm audit --json > audit.json || true
          npm audit >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
            CRIT_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          else
            HIGH_COUNT=0
            CRIT_COUNT=0
          fi
          echo "High severity: $HIGH_COUNT"
          echo "Critical severity: $CRIT_COUNT"
          echo "HIGH_COUNT=${HIGH_COUNT}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT_COUNT}" >> "$GITHUB_OUTPUT"

      - name: Upload Node service artifact (full package for this service)
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          # ì•„í‹°íŒ©íŠ¸ ì´ë¦„ì€ ì„œë¹„ìŠ¤ ë‹¨ìœ„
          name: node-sec-${{ github.run_number }}-${{ steps.prep_node.outputs.SERVICE_SAFE_NAME }}
          # ì´ ì„œë¹„ìŠ¤ ê°ì‚¬ íŒ¨í‚¤ì§€ì— í•„ìš”í•œ ëª¨ë“  ê²ƒ í¬í•¨
          path: |
            ${{ matrix.project }}/audit.json
            .github/sec_report/logs/security_snapshot_node_${{ steps.prep_node.outputs.SERVICE_SAFE_NAME }}.log
            .github/sec_report/permissions/PERMISSIONS_NODE.txt
            .github/sec_report/permissions/PERMISSIONS_GLOBAL.txt
            .github/sec_report/permissions/SECURITY_POLICY.md
            .github/sec_report/SUMMARY_node.txt
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # 2. Python audit (ì„œë¹„ìŠ¤ë³„ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ í™•ì¥)
  ##########################################################################
  python-security:
    name: "Python Dependency Check"
    runs-on: ubuntu-latest
    needs: [security-bootstrap]
    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/python
          - mcp-hello-py
          - mcp-python-server
          - mcp-apache-server
          - .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure dirs/helpers from bootstrap (self-heal)
        id: prep_py
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}" "${PERM_DIR}"
          if [ ! -f "${REPORT_DIR}/helpers.sh" ]; then
            HELPER_PATH="${REPORT_DIR}/helpers.sh"
            printf '%s\n' '#!/usr/bin/env bash' > "$HELPER_PATH"
            printf '%s\n' 'set -Eeo pipefail'  >> "$HELPER_PATH"
            printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
            printf '%s\n' 'safe_run() { local label="$1"; shift||true; local logfile="${LOG_BASE}/${label}.log"; echo "â–¶ [$label] $(date "+%Y-%m-%d %H:%M:%S%z") START"|tee -a "$logfile"; if "$@" >>"$logfile" 2>&1; then echo "âœ… [$label] OK"|tee -a "$logfile"; else rc=$?; echo "âŒ [$label] FAILED exit=${rc}"|tee -a "$logfile"; return $rc; fi; }' >> "$HELPER_PATH"
            printf '%s\n' 'apt_fix(){ local logfile="${LOG_BASE}/apt.fix.log"; echo "[fix] apt_fix start"|tee -a "$logfile"; sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock*||true; sudo dpkg --configure -a||true; sudo apt-get update -y||sudo apt-get update -y||true; }' >> "$HELPER_PATH"
            chmod +x "$HELPER_PATH"
          fi

          SERVICE_SAFE_NAME="${{ matrix.project//\//- }}"
          echo "Python scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"

          # ì„œë¹„ìŠ¤ë³„ ê¶Œí•œ ê¸°ë¡ append
          {
            echo "---- $(date '+%Y-%m-%d %H:%M:%S%z') PY matrix.project=${{ matrix.project }} ----"
            echo "Intended read paths: ${{ matrix.project }}/requirements.txt"
            echo "Intended write paths: ${REPORT_DIR}, ${LOG_DIR}, ${ARTIFACT_DIR}"
          } >> "${PERM_DIR}/PERMISSIONS_PYTHON.txt"

          # ì„œë¹„ìŠ¤ë³„ ìŠ¤ëƒ…ìƒ· ë¡œê·¸
          SNAP_LOG="${LOG_DIR}/security_snapshot_py_${SERVICE_SAFE_NAME}.log"
          {
            echo "=== PYTHON JOB SECURITY SNAPSHOT ==="
            echo "Project: ${{ matrix.project }}"
            echo "id:"; id
            echo
            echo "umask:"; umask
            echo
            echo "REPORT_DIR tree:"; ls -R "${REPORT_DIR}"
            echo
            echo "stat on REPORT_DIR:"; stat "${REPORT_DIR}" || true
          } | tee "${SNAP_LOG}"

          echo "SNAP_LOG=${SNAP_LOG}" >> "$GITHUB_OUTPUT"
          echo "SERVICE_SAFE_NAME=${SERVICE_SAFE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check requirements.txt
        id: py_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install security tools
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit || true

      - name: Ensure jq (for parsing)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true

      - name: pip-audit
        if: steps.py_exists.outputs.exists == 'true'
        id: py_audit
        shell: bash
        run: |
          set -Eeo pipefail
          echo "## Pip Audit for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"

          pip-audit -r "${{ matrix.project }}/requirements.txt" --format json > "${{ matrix.project }}/pip-audit.json" || true
          pip-audit -r "${{ matrix.project }}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

          if command -v jq >/dev/null 2>&1 && [ -f "${{ matrix.project }}/pip-audit.json" ]; then
            HIGH=$(jq '[.[] | .vulns[]? | select(.severity=="HIGH")] | length' "${{ matrix.project }}/pip-audit.json" 2>/dev/null || echo 0)
            CRIT=$(jq '[.[] | .vulns[]? | select(.severity=="CRITICAL")] | length' "${{ matrix.project }}/pip-audit.json" 2>/dev/null || echo 0)
          else
            HIGH=0
            CRIT=0
          fi
          echo "High severity vulns: $HIGH"
          echo "Critical severity vulns: $CRIT"
          echo "HIGH_COUNT=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT}" >> "$GITHUB_OUTPUT"

      - name: safety check
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          echo "## Safety Check for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"
          safety check -r "${{ matrix.project }}/requirements.txt" --json > "${{ matrix.project }}/safety.json" || true
          safety check -r "${{ matrix.project }}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"

      - name: bandit static analysis
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          bandit -r "$TARGET_DIR" -f json -o "$TARGET_DIR/bandit.json" || true
          echo "## Bandit Security Scan for $TARGET_DIR" >> "$GITHUB_STEP_SUMMARY"
          bandit -r "$TARGET_DIR" || echo "Bandit found issues" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Python service artifact (full package for this service)
        if: steps.py_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          # ì„œë¹„ìŠ¤ ë‹¨ìœ„ ì•„í‹°íŒ©íŠ¸ ì´ë¦„
          name: python-sec-${{ github.run_number }}-${{ steps.prep_py.outputs.SERVICE_SAFE_NAME }}
          # ì´ ì„œë¹„ìŠ¤ ìŠ¤ìº”/ê¶Œí•œ/ìŠ¤ëƒ…ìƒ· ì „ë¶€
          path: |
            ${{ matrix.project }}/pip-audit.json
            ${{ matrix.project }}/safety.json
            ${{ matrix.project }}/bandit.json
            .github/sec_report/logs/security_snapshot_py_${{ steps.prep_py.outputs.SERVICE_SAFE_NAME }}.log
            .github/sec_report/permissions/PERMISSIONS_PYTHON.txt
            .github/sec_report/permissions/PERMISSIONS_GLOBAL.txt
            .github/sec_report/permissions/SECURITY_POLICY.md
            .github/sec_report/SUMMARY_py.txt
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # 3. GitHub advisory gate on PR
  ##########################################################################
  dependency-review:
    name: "Dependency Review (PR gate)"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure


  ##########################################################################
  # 4. Weekly scheduled run -> if any job failed, open issue
  ##########################################################################
  create-issue-on-weekly-failure:
    name: "Create Issue on Weekly Failure"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]
    if: github.event_name == 'schedule' && failure()

    steps:
      - name: Open or reuse security issue
        uses: actions/github-script@v8
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependency-check',
              state: 'open'
            });

            if (existing.data.length === 0) {
              const bodyText = [
                "ğŸš¨ Weekly dependency check reported failures.",
                "",
                "ì¼ë¶€ ë³´ì•ˆ ì ê²€ ë‹¨ê³„(npm audit / pip-audit / bandit / safety ë“±)ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
                "ì·¨ì•½ ì˜ì¡´ì„±(high/critical) ë˜ëŠ” ê°ì‚¬ ë‹¨ê³„ ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.",
                "",
                `Run details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                "",
                "Artifacts (node-sec-*, python-sec-*)ë¥¼ í™•ì¸í•˜ì—¬",
                "ê° ì„œë¹„ìŠ¤ë³„ ì·¨ì•½ íŒ¨í‚¤ì§€ / ê¶Œí•œ ìŠ¤ëƒ…ìƒ· / SECURITY_POLICY.mdë¥¼ ê²€í† í•´ ì£¼ì„¸ìš”."
              ].join("\n");

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Dependency Security Check Failure (Weekly Scan)",
                body: bodyText,
                labels: ["security", "dependency-check", "automated"]
              });
            }
