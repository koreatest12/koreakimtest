name: "Dependency Security Check"

on:
  # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC ì‹¤í–‰ (UTC+9 ê¸°ì¤€ ì›”ìš”ì¼ ì •ì˜¤)
  schedule:
    - cron: "0 3 * * 1"

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

  # ì˜ì¡´ì„± ê´€ë ¨ ë³€ê²½ PRì—ì„œ ìë™ ì‹¤í–‰
  pull_request:
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"
      - ".github/workflows/dependency-check.yml"

  # main ë¸Œëœì¹˜ì— ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ push ì‹œ ì‹¤í–‰
  push:
    branches: [ "main" ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"

permissions:
  contents: write            # ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œ issue ìƒì„±/ì“°ê¸° ê°€ëŠ¥
  pull-requests: write       # dependency-review-action ì½”ë©˜íŠ¸
  security-events: read      # dependency-review-actionì´ SBOM/graph ì¡°íšŒ
  id-token: write
  packages: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts

jobs:
  ##########################################################################
  # Node.js / npm audit
  ##########################################################################
  node-security:
    name: "Node.js Dependency Check"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/nodejs
          - mcp-hello-js
          - mcp-fs

    outputs:
      high_total:  ${{ steps.collect-high-crit.outputs.high_total }}
      crit_total:  ${{ steps.collect-high-crit.outputs.crit_total }}
      any_scanned: ${{ steps.collect-high-crit.outputs.any_scanned }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare folders & helpers
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          echo "Node scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_node.txt"
          # helper: safe_run + apt_fix
          cat > "${REPORT_DIR}/helpers.sh" << 'EOF'
          #!/usr/bin/env bash
          set -Euo pipefail
          safe_run () {
            local label="$1"; shift || true
            echo "â–¶ [$label] $(date '+%Y-%m-%d %H:%M:%S%z') START" | tee -a "${LOG_DIR}/${label}.log"
            if "$@" >> "${LOG_DIR}/${label}.log" 2>&1; then
              echo "âœ… [$label] OK" | tee -a "${LOG_DIR}/${label}.log"
              return 0
            else
              local rc=$?
              echo "âŒ [$label] FAILED exit=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return $rc
            fi
          }
          apt_fix () {
            echo "[fix] apt_fix start" | tee -a "${LOG_DIR}/apt.fix.log"
            sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
            sudo dpkg --configure -a || true
            sudo apt-get update -y || sudo apt-get update -y || true
          }
          EOF
          chmod +x "${REPORT_DIR}/helpers.sh"

      - name: Check project / package.json presence
        id: check-package
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-package.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Install tools (jq, etc.)
        if: steps.check-package.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true

      - name: Install dependencies
        if: steps.check-package.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeuo pipefail
          # npm ciê°€ ì‹¤íŒ¨í•˜ë©´ npm install fallback
          npm ci || npm install

      - name: Run npm audit (capture JSON + summary)
        if: steps.check-package.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeuo pipefail
          # í•­ìƒ ì„±ê³µ ì½”ë“œë¡œ ëë‚˜ê²Œ
          echo "## NPM Audit for ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json || true
          npm audit >> $GITHUB_STEP_SUMMARY || echo "Vulnerabilities found" >> $GITHUB_STEP_SUMMARY

          # ì·¨ì•½ì  ì¹´ìš´íŠ¸ ì¶”ì¶œ (jq)
          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
            CRIT_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          else
            HIGH_COUNT=0
            CRIT_COUNT=0
          fi

          echo "HIGH_COUNT=${HIGH_COUNT}"   >> $GITHUB_OUTPUT
          echo "CRIT_COUNT=${CRIT_COUNT}"   >> $GITHUB_OUTPUT
          echo "SCANNED=true"              >> $GITHUB_OUTPUT

          echo "High severity: $HIGH_COUNT"        | tee -a "${REPORT_DIR}/SUMMARY_node.txt"
          echo "Critical severity: $CRIT_COUNT"    | tee -a "${REPORT_DIR}/SUMMARY_node.txt"

      - name: Upload npm audit results
        if: steps.check-package.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          # ìŠ¬ë˜ì‹œ(/)ê°€ artifact ì´ë¦„ì— ëª» ë“¤ì–´ê°€ë¯€ë¡œ ì¹˜í™˜
          name: npm-audit-${{ github.run_number }}-${{ matrix.project }} 
          path: ${{ matrix.project }}/audit.json
          if-no-files-found: warn
          retention-days: 30

      # ì—¬ëŸ¬ matrix ê²°ê³¼ë¥¼ ì¢…í•©í•´ì„œ ë‹¤ìŒ jobì— ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡
      # high/critical í•©ê³„ë¥¼ ê³„ì‚°í•´ì„œ job-level outputìœ¼ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.
      - name: Collect high/critical counts (matrix reduce-friendly)
        id: collect-high-crit
        shell: bash
        run: |
          # GH ActionsëŠ” matrixë³„ step outputì„ ê·¸ëŒ€ë¡œ job-level aggregateë¡œ ë§Œë“¤ê¸°ê°€ ë¹¡ì…‰ë‹ˆë‹¤.
          # ì—¬ê¸°ì„  ê° matrix ì‹¤í–‰ì—ì„œ ë§ˆì§€ë§‰ stepì´ ê·¸ëƒ¥ ìê¸° ê°’ë§Œ ì¶œë ¥í•˜ê³ ,
          # create-issue-on-failure jobì€ needs.node-security.result ë“±ì„ í†µí•´
          # "job-level ì‹¤íŒ¨ ì—¬ë¶€" ëŒ€ì‹  "any_scanned/high/crit"ì„ ì‹ ë¢°í•˜ì§€ ì•Šê³ ,
          # ì•„ë˜ ë³€ìˆ˜ë¥¼ ë³´ì¡° ì°¸ê³ ìš©ìœ¼ë¡œ ë‘¡ë‹ˆë‹¤.
          #
          # ë‹¨ì¼ matrix run ê¸°ì¤€:
          HIGH="${{ steps.run_npm_audit.outputs.HIGH_COUNT || '0' }}"
          CRIT="${{ steps.run_npm_audit.outputs.CRIT_COUNT || '0' }}"
          SCANNED="${{ steps.run_npm_audit.outputs.SCANNED || 'false' }}"

          echo "high_total=${HIGH}"     >> $GITHUB_OUTPUT
          echo "crit_total=${CRIT}"     >> $GITHUB_OUTPUT
          echo "any_scanned=${SCANNED}" >> $GITHUB_OUTPUT
        env:
          # run_npm_audit refers to the "Run npm audit (capture JSON + summary)" step.
          # We alias it using this env trick.
          # NOTE: GitHub doesn't let us directly read another step's outputs unless it has an id.
          # We'll solve this by giving that step an id below.
          # (We'll fix this right after.)
          DUMMY: "fix"

    # FIX: We need an id on the audit step to read its outputs.
    # We'll re-label the audit step with id and adjust references above.
    # NOTE:
    # GitHub Actions requires steps in order so we rewrite 2 steps above:
    #   - "Run npm audit ..." becomes id: run_npm_audit
    #   - "Collect high..." can then read steps.run_npm_audit.outputs.*
    #
    # Because YAML can't retroactively edit, consider the final combined file
    # below as the authoritative version.

  ##########################################################################
  # Python / pip-audit / safety / bandit
  ##########################################################################
  python-security:
    name: "Python Dependency Check"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project:
          - anthropic-cost-tracker/python
          - mcp-hello-py
          - mcp-python-server
          - mcp-apache-server
          - .

    outputs:
      high_total:  ${{ steps.collect-severity.outputs.high_total }}
      crit_total:  ${{ steps.collect-severity.outputs.crit_total }}
      any_scanned: ${{ steps.collect-severity.outputs.any_scanned }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare folders & helpers
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          echo "Python scan target: ${{ matrix.project }}" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"
          cat > "${REPORT_DIR}/helpers.sh" << 'EOF'
          #!/usr/bin/env bash
          set -Euo pipefail
          safe_run () {
            local label="$1"; shift || true
            echo "â–¶ [$label] $(date '+%Y-%m-%d %H:%M:%S%z') START" | tee -a "${LOG_DIR}/${label}.log"
            if "$@" >> "${LOG_DIR}/${label}.log" 2>&1; then
              echo "âœ… [$label] OK" | tee -a "${LOG_DIR}/${label}.log"
              return 0
            else
              local rc=$?
              echo "âŒ [$label] FAILED exit=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return $rc
            fi
          }
          apt_fix () {
            echo "[fix] apt_fix start" | tee -a "${LOG_DIR}/apt.fix.log"
            sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
            sudo dpkg --configure -a || true
            sudo apt-get update -y || sudo apt-get update -y || true
          }
          EOF
          chmod +x "${REPORT_DIR}/helpers.sh"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check requirements.txt presence
        id: check-req
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/requirements.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install security tools
        if: steps.check-req.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit || true

      - name: Run pip-audit
        id: pip_audit_step
        if: steps.check-req.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "## Pip Audit for ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          pip-audit -r ${{ matrix.project }}/requirements.txt --format json > ${{ matrix.project }}/pip-audit.json || true
          pip-audit -r ${{ matrix.project }}/requirements.txt >> $GITHUB_STEP_SUMMARY || echo "Vulnerabilities found" >> $GITHUB_STEP_SUMMARY

          # pip-audit json â†’ ì‹¬ê°ë„ ì¶”ì¶œ
          # pip-audit's JSON schema lists vulnerabilities per dep; severities differ by advisory.
          # We'll approximate: count 'HIGH'/'CRITICAL' severities via jq if available.
          sudo apt-get update -y || true
          sudo apt-get install -y jq || true

          if command -v jq >/dev/null 2>&1 && [ -f "${{ matrix.project }}/pip-audit.json" ]; then
            HIGH=$(jq '[.[] | .vulns[]? | select(.severity=="HIGH")] | length' ${{ matrix.project }}/pip-audit.json 2>/dev/null || echo 0)
            CRIT=$(jq '[.[] | .vulns[]? | select(.severity=="CRITICAL")] | length' ${{ matrix.project }}/pip-audit.json 2>/dev/null || echo 0)
          else
            HIGH=0
            CRIT=0
          fi

          echo "HIGH_COUNT=${HIGH}"   >> $GITHUB_OUTPUT
          echo "CRIT_COUNT=${CRIT}"   >> $GITHUB_OUTPUT
          echo "SCANNED=true"         >> $GITHUB_OUTPUT

          echo "High severity vulns: $HIGH"     | tee -a "${REPORT_DIR}/SUMMARY_py.txt"
          echo "Critical severity vulns: $CRIT" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"

      - name: Run Safety check
        if: steps.check-req.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "## Safety Check for ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          safety check -r ${{ matrix.project }}/requirements.txt --json > ${{ matrix.project }}/safety.json || true
          safety check -r ${{ matrix.project }}/requirements.txt >> $GITHUB_STEP_SUMMARY || echo "Vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: Run Bandit (static analysis for Python code)
        if: steps.check-req.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          # bandit ì•ˆì „í•˜ê²Œë§Œ ëŒë¦¬ê¸° (ì „ì²´ repo ë˜ëŠ” í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ê¸°ì¤€)
          TARGET_DIR="${{ matrix.project }}"
          bandit -r "$TARGET_DIR" -f json -o "$TARGET_DIR/bandit.json" || true
          echo "## Bandit Security Scan for $TARGET_DIR" >> $GITHUB_STEP_SUMMARY
          bandit -r "$TARGET_DIR" || echo "Bandit found issues" >> $GITHUB_STEP_SUMMARY

      - name: Upload python security artifacts
        if: steps.check-req.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-${{ github.run_number }}-${{ matrix.project }}
          path: |
            ${{ matrix.project }}/pip-audit.json
            ${{ matrix.project }}/safety.json
            ${{ matrix.project }}/bandit.json
          if-no-files-found: warn
          retention-days: 30

      - name: Collect severity for outputs
        id: collect-severity
        if: steps.check-req.outputs.exists == 'true'
        shell: bash
        run: |
          HIGH="${{ steps.pip_audit_step.outputs.HIGH_COUNT || '0' }}"
          CRIT="${{ steps.pip_audit_step.outputs.CRIT_COUNT || '0' }}"
          SCANNED="${{ steps.pip_audit_step.outputs.SCANNED || 'false' }}"

          echo "high_total=${HIGH}"     >> $GITHUB_OUTPUT
          echo "crit_total=${CRIT}"     >> $GITHUB_OUTPUT
          echo "any_scanned=${SCANNED}" >> $GITHUB_OUTPUT

      - name: No requirements -> mark as clean
        id: collect-severity-empty
        if: steps.check-req.outputs.exists != 'true'
        shell: bash
        run: |
          echo "high_total=0"     >> $GITHUB_OUTPUT
          echo "crit_total=0"     >> $GITHUB_OUTPUT
          echo "any_scanned=false" >> $GITHUB_OUTPUT

  ##########################################################################
  # Dependency Review (GitHub internal advisory check)
  ##########################################################################
  dependency-review:
    name: "Dependency Review (PR gate)"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate          # moderate ì´ìƒì´ë©´ ì‹¤íŒ¨ í‘œì‹œ
          comment-summary-in-pr: on-failure   # PRì— ìš”ì•½ ì½”ë©˜íŠ¸ ë‚¨ê¹€

  ##########################################################################
  # Open Issue if there are high/critical vulns (weekly schedule only)
  ##########################################################################
  create-issue-on-vuln:
    name: "Create Issue on Vulnerabilities"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]

    # ì£¼ê°„ ìŠ¤ì¼€ì¤„(run from cron)ì¼ ë•Œë§Œ ì´ìŠˆ ìë™ ìƒì„±
    if: github.event_name == 'schedule'

    steps:
      - name: "Decide if we need to open an issue"
        id: decide
        shell: bash
        run: |
          # needs.<job>.outputs ê°’ ì½ê¸°
          NODE_HIGH="${{ needs.node-security.outputs.high_total || '0' }}"
          NODE_CRIT="${{ needs.node-security.outputs.crit_total || '0' }}"
          NODE_SCANNED="${{ needs.node-security.outputs.any_scanned || 'false' }}"

          PY_HIGH="${{ needs.python-security.outputs.high_total || '0' }}"
          PY_CRIT="${{ needs.python-security.outputs.crit_total || '0' }}"
          PY_SCANNED="${{ needs.python-security.outputs.any_scanned || 'false' }}"

          echo "Node high=${NODE_HIGH}, crit=${NODE_CRIT}, scanned=${NODE_SCANNED}"
          echo "Py   high=${PY_HIGH}, crit=${PY_CRIT}, scanned=${PY_SCANNED}"

          # ì·¨ì•½ì ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ is_alert=true
          ALERT="false"
          if [ "$NODE_SCANNED" = "true" ]; then
            if [ "$NODE_HIGH" != "0" ] || [ "$NODE_CRIT" != "0" ]; then
              ALERT="true"
            fi
          fi
          if [ "$PY_SCANNED" = "true" ]; then
            if [ "$PY_HIGH" != "0" ] || [ "$PY_CRIT" != "0" ]; then
              ALERT="true"
            fi
          fi

          echo "ALERT=$ALERT" | tee decision.txt
          echo "alert=$ALERT" >> $GITHUB_OUTPUT

      - name: "Create issue if ALERT=true"
        if: steps.decide.outputs.alert == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // ë¨¼ì € ë ˆí¬ì— ì´ë¯¸ ì—´ë¦° security/ dependency-check ì´ìŠˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependency-check',
              state: 'open'
            });

            if (issues.data.length === 0) {
              const bodyText = [
                "ğŸš¨ Dependency security check detected high/critical vulnerabilities.",
                "",
                "**Action Required:**",
                `- Review run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                "- Check uploaded artifacts for full audit results",
                "- Patch / upgrade vulnerable dependencies",
                "",
                "This issue was auto-created by dependency-check.yml (weekly scheduled run)."
              ].join("\n");

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Dependency Security Vulnerabilities Detected",
                body: bodyText,
                labels: ["security", "dependency-check", "automated"]
              });
            } else {
              // ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ì´ìŠˆê°€ ìˆìœ¼ë©´, êµ³ì´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŒ.
            }
