name: "ðŸ›¡ CodeQL Advanced SecureScan (Enterprise-Grade, No-Skip, AutoUpgrade, Caching, SARIF Archive)"

################################################################################
# ARCHITECTURE OVERVIEW
# ---------------------------------------------------------------------------
# - ì ˆëŒ€ ìŠ¤í‚µ ê¸ˆì§€: ì‹¤íŒ¨í•´ë„ ë§ˆì§€ë§‰ê¹Œì§€ ì§„í–‰í•˜ê³  ì¦ê±°(SARIF, ë¡œê·¸, ì—…ê·¸ë ˆì´ë“œ ì •ë³´) ë‚¨ê¹€
# - ëŸ¬ë„ˆ í™˜ê²½ ì ê²€/ì—…ë°ì´íŠ¸ ë¡œê·¸, CodeQL DB, SARIF ì „ë¶€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
# - PR / ìˆ˜ë™(dispatch) / ìŠ¤ì¼€ì¤„(run on cron) / main push ì „ë¶€ ëŒ€ì‘
# - workflow_dispatch inputsëŠ” 10ê°œ ì´í•˜ë§Œ ì‚¬ìš©
################################################################################

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - "docs/**"
  merge_group:
    branches: [ "main" ]
  schedule:
    # minute hour dom month dow   (UTC ì‹œê°„ëŒ€)
    - cron: "39 19 * * 3"
  workflow_dispatch:
    inputs:
      scan_mode:            # 1
        description: "full=ëª¨ë“  ì¿¼ë¦¬ / lite=ê°€ë²¼ìš´ ì¿¼ë¦¬"
        type: choice
        options: [full, lite]
        default: full
        required: false
      enforce_manual_build: # 2
        description: "í•­ìƒ ìˆ˜ë™ ë¹Œë“œ fallback ì‹¤í–‰í• ì§€ ì—¬ë¶€"
        type: boolean
        default: false
        required: false
      retention_days:       # 3
        description: "ì•„í‹°íŒ©íŠ¸ ë³´ê´€ ì¼ìˆ˜ (ê¸°ë³¸ 14)"
        default: "14"
        required: false
      queries_profile:      # 4
        description: "security-and-quality or +security-extended,security-and-quality"
        default: "+security-extended,security-and-quality"
        required: false

concurrency:
  group: codeql-secure-scan-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}

    # âœ… í•µì‹¬ ì •ì±…: ìž¡ ì „ì²´ ë ˆë²¨ì—ì„œ fail í—ˆìš© â†’ ë§ˆì§€ë§‰ê¹Œì§€ ì§„í–‰
    continue-on-error: true

    permissions:
      security-events: write   # allow SARIF upload to code scanning
      contents: read
      packages: read
      actions: read
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: actions
            build-mode: none
          - language: java-kotlin
            build-mode: autobuild
          - language: javascript-typescript
            build-mode: none
          - language: python
            build-mode: none
          # swift ë“± í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€

    env:
      TZ: Asia/Seoul
      LOG_DIR: .github/echo_logs
      ARTIFACT_DIR: .github/echo_artifacts
      UPGRADE_LOG_DIR: .github/echo_upgrade

      # CodeQL DB/TMP ì €ìž¥ ë£¨íŠ¸: runner.temp ëŒ€ì‹  workspace í•˜ìœ„ ìž„ì‹œ ë””ë ‰í† ë¦¬ ì‚¬ìš©
      CODEQL_DB_ROOT: ${{ github.workspace }}/.codeql_tmp

      # workflow_dispatch ìš°ì„ ìˆœìœ„ > PR ê¸°ë³¸ê°’ ìš°ì„ ìˆœìœ„
      # 1) queries_profile ìž…ë ¥ ìžˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ 
      # 2) ì•„ë‹ˆë©´ PRì€ ì–‡ì€ ì¿¼ë¦¬
      # 3) ì•„ë‹ˆë©´ ê¸°ë³¸(í™•ìž¥ ì¿¼ë¦¬ í¬í•¨)
      CODEQL_QUERIES: ${{ inputs.queries_profile || (github.event_name == 'pull_request' && 'security-and-quality') || '+security-extended,security-and-quality' }}

      # MANUAL_BUILD_ENFORCE: dispatch enforce_manual_build=true ë©´ true, ì•„ë‹ˆë©´ ê¸°ë³¸ false
      MANUAL_BUILD_ENFORCE: ${{ inputs.enforce_manual_build && 'true' || 'false' }}

      # RETENTION_DAYS: artifact ë³´ê´€ì¼ (dispatch ê°’ ì—†ìœ¼ë©´ ê¸°ë³¸ 14)
      RETENTION_DAYS: ${{ inputs.retention_days || '14' }}

      # SCAN_MODE: full / lite
      SCAN_MODE: ${{ inputs.scan_mode || 'full' }}

    steps:
      ########################################################################
      # 0. CHECKOUT SOURCE
      ########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ########################################################################
      # 1. PREP: DIR SETUP, ENV SNAPSHOT, BEST-EFFORT RUNNER UPGRADE
      ########################################################################
      - name: Prep dirs, env introspection, and best-effort OS upgrade
        if: always()
        shell: bash
        run: |
          set -Eeuo pipefail

          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${UPGRADE_LOG_DIR}" "${CODEQL_DB_ROOT}"

          # helper functions (TS/LOG) for reuse in later steps
          cat > /tmp/echo_helpers.sh << 'EOF'
          TS() { date "+%Y-%m-%d %H:%M:%S%z"; }
          LOG() { lvl="$1"; shift; echo "[$(TS)] [$lvl] $*"; }
          EOF

          # Introspection
          source /tmp/echo_helpers.sh || true
          LOG INFO "===== RUNTIME INTROSPECTION START ====="
          uname -a  || true
          lsb_release -a 2>/dev/null || true
          sw_vers 2>/dev/null || true
          df -h || true
          free -m 2>/dev/null || true
          LOG INFO "Capturing upgradable package list and attempting upgrade (Linux/macOS)."

          {
            echo "===== UPGRADE SESSION START $(date) ====="
            echo "Runner OS info:"
            uname -a || true
            lsb_release -a 2>/dev/null || true
            sw_vers 2>/dev/null || true
            echo

            if command -v apt-get >/dev/null 2>&1; then
              echo ">>> apt-get update / upgrade attempt"
              sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
              sudo dpkg --configure -a || true
              sudo apt-get update -y || true

              echo ">>> pre-upgrade upgradable list"
              apt list --upgradable 2>/dev/null || true > "${UPGRADE_LOG_DIR}/upgradable.pre.txt"

              # best-effort patch upgrade
              sudo DEBIAN_FRONTEND=noninteractive apt-get -y upgrade || true

              echo ">>> post-upgrade upgradable list"
              apt list --upgradable 2>/dev/null || true > "${UPGRADE_LOG_DIR}/upgradable.post.txt"

            else
              echo "No apt-get (likely macOS)."
              if command -v softwareupdate >/dev/null 2>&1; then
                echo ">>> macOS softwareupdate --list (read-only)"
                softwareupdate --list || true
              fi
            fi

            echo "===== UPGRADE SESSION END $(date) ====="
          } | tee "${UPGRADE_LOG_DIR}/upgrade_${{ matrix.language }}.log"

          LOG INFO "===== RUNTIME INTROSPECTION END ====="

      ########################################################################
      # 2. DEPENDENCY CACHES (ì–¸ì–´ë³„ ìºì‹œ: ì‹¤íŒ¨í•´ë„ ê³„ì†)
      ########################################################################
      - name: Cache Maven local repo
        if: contains(matrix.language, 'java')
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Cache Gradle
        if: contains(matrix.language, 'java')
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Cache Node.js deps
        if: contains(matrix.language, 'javascript') || contains(matrix.language, 'typescript')
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: node-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            node-${{ runner.os }}-

      - name: Cache pip
        if: contains(matrix.language, 'python')
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            pip-${{ runner.os }}-

      ########################################################################
      # 2.5 PREP CLEAN DB DIR (CodeQL DB ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”)
      ########################################################################
      - name: Prep clean CodeQL DB directory
        if: always()
        shell: bash
        run: |
          set -Eeuo pipefail
          DB_DIR="${CODEQL_DB_ROOT}/codeql_db_${{ matrix.language }}"
          rm -rf "${DB_DIR}" || true
          mkdir -p "${DB_DIR}"

      ########################################################################
      # 3. CODEQL INIT
      ########################################################################
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix['build-mode'] }}
          db-location: ${{ env.CODEQL_DB_ROOT }}/codeql_db_${{ matrix.language }}
          queries: ${{ env.CODEQL_QUERIES }}

      ########################################################################
      # 4. AUTOBUILD (compiled languages ì „ìš©)
      ########################################################################
      - name: Autobuild (for compiled languages)
        if: ${{ matrix.build-mode == 'autobuild' }}
        uses: github/codeql-action/autobuild@v4

      ########################################################################
      # 5. MANUAL BUILD FALLBACK (autobuild ì‹¤íŒ¨ ëŒ€ë¹„)
      ########################################################################
      - name: Manual build fallback (enforced or on autobuild failure)
        if: ${{ failure() || matrix.build-mode == 'manual' || env.MANUAL_BUILD_ENFORCE == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh || true
          LOG WARN "Autobuild failed OR manual mode enforced -> running manual fallback build"

          BUILD_LOG_FILE="${LOG_DIR}/manual_build_${{ matrix.language }}.log"

          {
            echo "===== MANUAL BUILD START $(date) ====="

            if [ -f "mvnw" ] || [ -f "pom.xml" ]; then
              echo "[manual] mvn -B -q -DskipTests package"
              mvn -B -q -DskipTests package || true

            elif [ -f "gradlew" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
              echo "[manual] ./gradlew build -x test"
              chmod +x ./gradlew || true
              ./gradlew build -x test || true

            elif [ -f "Makefile" ]; then
              echo "[manual] make"
              make || true

            elif [ -f "go.mod" ]; then
              echo "[manual] go build ./..."
              go build ./... || true

            else
              echo "[manual] No known build system found. Skipping compile."
            fi

            echo "===== MANUAL BUILD END $(date) ====="
          } | tee "${BUILD_LOG_FILE}"

          LOG INFO "Manual fallback build finished (all errors ignored, continuing)"

          {
            echo "### âš ï¸ Manual Build Fallback Log Summary (${{ matrix.language }})"
            echo "Full log uploaded as artifact: ${BUILD_LOG_FILE}"
            echo '```bash'
            tail -n 100 "${BUILD_LOG_FILE}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      ########################################################################
      # 6. CODEQL ANALYZE
      ########################################################################
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          output: ${{ env.CODEQL_DB_ROOT }}/codeql_db_${{ matrix.language }}/results-${{ matrix.language }}.sarif

      ########################################################################
      # 7. PACKAGE EVIDENCE / AUDIT TRAIL
      ########################################################################
      - name: Collect and package CodeQL DB + logs + SARIF
        if: always()
        shell: bash
        env:
          CODEQL_DB_DIR: ${{ env.CODEQL_DB_ROOT }}/codeql_db_${{ matrix.language }}
        run: |
          set -Eeuo pipefail
          source /tmp/echo_helpers.sh || true
          LOG INFO "Collecting CodeQL artifacts, SARIF, upgrade logs for audit trail"

          mkdir -p "${ARTIFACT_DIR}"

          # Snapshot DB structure for triage
          if [ -d "${CODEQL_DB_DIR}" ]; then
            ls -R "${CODEQL_DB_DIR}" \
              > "${LOG_DIR}/codeql_db_tree_${{ matrix.language }}.log" 2>&1 || true
            tar -czf "${ARTIFACT_DIR}/codeql_db_${{ matrix.language }}.tgz" \
              -C "${CODEQL_DB_DIR}" . || true
          fi

          # Copy SARIF results for code scanning + audit
          if [ -f "${CODEQL_DB_DIR}/results-${{ matrix.language }}.sarif" ]; then
            cp "${CODEQL_DB_DIR}/results-${{ matrix.language }}.sarif" \
               "${ARTIFACT_DIR}/results-${{ matrix.language }}.sarif" || true
          fi

          # Runner upgrade logs pack
          tar -czf "${ARTIFACT_DIR}/upgrade_logs_${{ matrix.language }}.tgz" \
            "${UPGRADE_LOG_DIR}" || true

          LOG INFO "Packaging complete"

      ########################################################################
      # 8. UPLOAD EVERYTHING AS ARTIFACT
      ########################################################################
      - name: Upload CodeQL & Environment Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: codeql-${{ matrix.language }}-${{ github.run_id }}
          path: |
            .github/echo_logs/**
            .github/echo_artifacts/**
            .github/echo_upgrade/**
          if-no-files-found: warn
          retention-days: ${{ env.RETENTION_DAYS }}
