name: "ðŸ”µ FULL VersionOps â€” Upgrade + Downgrade + Rollback + Backup + Restore + DockerTag + K8s (LEFT-ECHO FULL / NO SKIP)"

on:
  workflow_dispatch:

env:
  TZ: Asia/Seoul
  VERSION_FILE: .github/version/VERSION
  BACKUP_DIR: .github/version/backups
  LOG_DIR: .github/version/logs
  K8S_DEPLOY: copilot-server
  DOCKER_IMAGE: your-registry/copilot-server

jobs:
  versionops:
    runs-on: ubuntu-latest

    steps:

      ###########################################################################
      # INIT
      ###########################################################################
      - name: INIT
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
          echo "â–¶ mkdir -p ${BACKUP_DIR}"; mkdir -p "${BACKUP_DIR}"
          echo "â–¶ mkdir -p $(dirname ${VERSION_FILE})"; mkdir -p "$(dirname ${VERSION_FILE})"

          if [ ! -f "${VERSION_FILE}" ]; then
            echo "â–¶ echo 1.0.0 > ${VERSION_FILE}"; echo "1.0.0" > "${VERSION_FILE}"
          fi

          echo "â–¶ cat ${VERSION_FILE}"; cat "${VERSION_FILE}" | tee "${LOG_DIR}/00_current_version.txt"


      ###########################################################################
      # BACKUP â€” Always run
      ###########################################################################
      - name: BACKUP Current Version
        shell: bash
        run: |
          NOW=$(date +%Y%m%d_%H%M%S)
          BACK="${BACKUP_DIR}/VERSION_${NOW}.bak"

          echo "â–¶ cp ${VERSION_FILE} ${BACK}"; cp "${VERSION_FILE}" "${BACK}"
          echo "Backup created: ${BACK}" | tee "${LOG_DIR}/01_backup.txt"


      ###########################################################################
      # RESTORE (Restore previous backup) â€” Always run
      ###########################################################################
      - name: RESTORE (latest backup)
        shell: bash
        run: |
          LAST=$(ls -t ${BACKUP_DIR} | head -1)
          echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
          echo "Restored from backup: $(cat ${VERSION_FILE})" | tee "${LOG_DIR}/02_restore.txt"


      ###########################################################################
      # UPGRADE â€” Always run
      ###########################################################################
      - name: UPGRADE Version
        shell: bash
        run: |
          CUR=$(cat ${VERSION_FILE})
          echo "â–¶ CUR=${CUR}"

          NEXT=$(date +%Y.%m.%d.%H%M)
          echo "â–¶ echo ${NEXT} > ${VERSION_FILE}"; echo "${NEXT}" > "${VERSION_FILE}"

          echo "Upgraded ${CUR} â†’ ${NEXT}" | tee "${LOG_DIR}/03_upgrade.txt"


      ###########################################################################
      # DOWNGRADE â€” Always run
      ###########################################################################
      - name: DOWNGRADE Version
        shell: bash
        run: |
          CUR=$(cat ${VERSION_FILE})
          BASE=$(echo $CUR | awk -F. '{print $1"."$2"."$3}')
          DOWN="${BASE}.0000"

          echo "â–¶ echo ${DOWN} > ${VERSION_FILE}"; echo "${DOWN}" > "${VERSION_FILE}"
          echo "Downgraded ${CUR} â†’ ${DOWN}" | tee "${LOG_DIR}/04_downgrade.txt"


      ###########################################################################
      # ROLLBACK â€” Always run
      ###########################################################################
      - name: ROLLBACK to latest backup
        shell: bash
        run: |
          LAST=$(ls -t ${BACKUP_DIR} | head -1)
          echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
          echo "Rollback to $(cat ${VERSION_FILE})" | tee "${LOG_DIR}/05_rollback.txt"


      ###########################################################################
      # DOCKER TAG UPDATE â€” Always run
      ###########################################################################
      - name: Docker tag update
        shell: bash
        run: |
          VER=$(cat ${VERSION_FILE})

          echo "â–¶ docker pull ${DOCKER_IMAGE}:latest"; docker pull "${DOCKER_IMAGE}:latest" || true
          echo "â–¶ docker tag ${DOCKER_IMAGE}:latest ${DOCKER_IMAGE}:${VER}"; docker tag "${DOCKER_IMAGE}:latest" "${DOCKER_IMAGE}:${VER}" || true
          echo "â–¶ docker push ${DOCKER_IMAGE}:${VER}"; docker push "${DOCKER_IMAGE}:${VER}" || true

          echo "Docker image updated â†’ ${VER}" | tee "${LOG_DIR}/06_docker_tag.txt"


      ###########################################################################
      # KUBERNETES / EKS ROLLING UPDATE â€” Always run
      ###########################################################################
      - name: Kubernetes/EKS Auto Upgrade
        shell: bash
        run: |
          VER=$(cat ${VERSION_FILE})

          echo "â–¶ kubectl set image deployment/${K8S_DEPLOY} ${K8S_DEPLOY}=${DOCKER_IMAGE}:${VER}"
          kubectl set image deployment/${K8S_DEPLOY} ${K8S_DEPLOY}=${DOCKER_IMAGE}:${VER} || true

          echo "â–¶ kubectl rollout status deployment/${K8S_DEPLOY}"
          kubectl rollout status deployment/${K8S_DEPLOY} || true | tee "${LOG_DIR}/07_k8s_rollout.txt"


      ###########################################################################
      # FINAL SUMMARY â€” Always run
      ###########################################################################
      - name: Final Summary
        shell: bash
        run: |
          echo "=== FULL VersionOps Summary ===" | tee "${LOG_DIR}/99_final_summary.txt"
          echo "Current Version: $(cat ${VERSION_FILE})"       | tee -a "${LOG_DIR}/99_final_summary.txt"
          echo "Backups: $(ls -1 ${BACKUP_DIR} | wc -l)"       | tee -a "${LOG_DIR}/99_final_summary.txt"
          echo "Docker Image: ${DOCKER_IMAGE}"                | tee -a "${LOG_DIR}/99_final_summary.txt"
          echo "K8s Deploy: ${K8S_DEPLOY}"                    | tee -a "${LOG_DIR}/99_final_summary.txt"

      - uses: actions/upload-artifact@v4
        with:
          name: versionops-full-report
          path: ${{ env.LOG_DIR }}/
