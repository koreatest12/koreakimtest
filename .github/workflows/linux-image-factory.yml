name: "üêß Linux Image Factory ‚Äî Ultra Mega Edition"

on:
  workflow_dispatch:
    inputs:
      build_ubuntu:
        description: "Ubuntu Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±"
        type: boolean
        default: true
      build_rhel:
        description: "RHEL Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±"
        type: boolean
        default: true
      build_kali:
        description: "Kali Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±"
        type: boolean
        default: true
      build_iso:
        description: "ISO ÏÉùÏÑ± Ïó¨Î∂Ä"
        type: boolean
        default: true
      build_disk:
        description: "ÎîîÏä§ÌÅ¨ ÏÉùÏÑ±(QCOW2, VMDK)"
        type: boolean
        default: true
      bulk_directories:
        description: "ÎîîÎ†âÌÜ†Î¶¨ ÎåÄÎüâ ÏÉùÏÑ± Ïó¨Î∂Ä"
        type: boolean
        default: true

  schedule:
    - cron: "0 2 * * 1"  # Îß§Ï£º ÏõîÏöîÏùº 02:00 UTC ÏûêÎèô Ïã§Ìñâ

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  ECHOOPS: true
  SAFE_ECHO: true
  WORKSPACE: linux-images
  LOG_DIR: linux-images/logs
  ARTIFACT_DIR: linux-images/artifacts

jobs:
  mega-linux-factory:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4

      - name: üìÅ Initialize Workspace
        run: |
          set -euo pipefail
          mkdir -p ${WORKSPACE}/{artifacts,logs,tmp,iso,disks,ubuntu,rhel,kali,directories}
          echo "[Init] Workspace initialized"

      - name: üß™ EchoOps + SafeEcho Framework Load
        run: |
          set -euo pipefail

          safe_echo() {
            if [[ "${SAFE_ECHO}" == "true" ]]; then
              printf "[SAFE] %s\n" "$1"
            else
              printf "%s\n" "$1"
            fi
          }

          echo_trace() {
            if [[ "${ECHOOPS}" == "true" ]]; then
              printf "[TRACE] %s\n" "$1"
            fi
          }

          export -f safe_echo
          export -f echo_trace

          echo "EchoOps loaded"

      - name: üì¶ Install Required Image Tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            qemu-utils \
            genisoimage \
            xorriso \
            squashfs-tools \
            debootstrap \
            whois \
            make \
            wget \
            curl \
            gdisk \
            parted \
            qemu-system-x86 \
            live-build

          safe_echo "ÌïÑÏàò Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ìà¥ ÏÑ§Ïπò ÏôÑÎ£å"

      - name: üèó Ubuntu Base Image Build
        if: ${{ inputs.build_ubuntu == true }}
        run: |
          safe_echo "*** UBUNTU IMAGE BUILD START ***"
          UBUNTU_DIR="${WORKSPACE}/ubuntu"
          mkdir -p "$UBUNTU_DIR"

          debootstrap --arch=amd64 noble "$UBUNTU_DIR" http://archive.ubuntu.com/ubuntu/

          chroot "$UBUNTU_DIR" bash -c "
            apt-get update
            apt-get install -y openssh-server sudo net-tools systemd systemd-sysv curl wget vim git build-essential python3 python3-pip fail2ban ufw
            systemctl enable ssh
          "

          tar -czf ${ARTIFACT_DIR}/ubuntu-base.tar.gz -C "$UBUNTU_DIR" .

          safe_echo "*** UBUNTU BUILD COMPLETE ***"

      - name: üèó RHEL-like Image Build (Rocky)
        if: ${{ inputs.build_rhel == true }}
        run: |
          safe_echo "*** RHEL IMAGE BUILD START ***"
          RHEL_DIR="${WORKSPACE}/rhel"
          mkdir -p "$RHEL_DIR"

          curl -L https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2 \
            -o "${RHEL_DIR}/rhel-base.qcow2"

          cp "${RHEL_DIR}/rhel-base.qcow2" "${ARTIFACT_DIR}/rhel-base.qcow2"

          safe_echo "*** RHEL BUILD COMPLETE ***"

      - name: üèó Kali Linux Build
        if: ${{ inputs.build_kali == true }}
        run: |
          safe_echo "*** KALI LINUX BUILD START ***"
          KALI_DIR="${WORKSPACE}/kali"
          mkdir -p "$KALI_DIR"

          debootstrap --arch=amd64 kali-rolling "$KALI_DIR" http://http.kali.org/kali

          chroot "$KALI_DIR" bash -c "
            apt-get update
            apt-get install -y kali-linux-default metasploit-framework nmap htop openssh-server git curl python3 python3-pip
          "

          tar -czf ${ARTIFACT_DIR}/kali-base.tar.gz -C "$KALI_DIR" .

          safe_echo "*** KALI BUILD COMPLETE ***"

      - name: üíø Generate ISO Image
        if: ${{ inputs.build_iso == true }}
        run: |
          safe_echo "*** ISO BUILD START ***"
          mkdir -p iso_build/rootfs

          echo "Linux Image Factory ISO" > iso_build/rootfs/INFO.txt

          genisoimage -o ${ARTIFACT_DIR}/factory.iso iso_build/rootfs

          safe_echo "*** ISO BUILD COMPLETE ***"

      - name: üíΩ Disk Image Build (QCOW2, VMDK)
        if: ${{ inputs.build_disk == true }}
        run: |
          safe_echo "*** DISK CREATION START ***"
          qemu-img create -f qcow2 ${ARTIFACT_DIR}/linux-disk.qcow2 20G
          qemu-img create -f vmdk  ${ARTIFACT_DIR}/linux-disk.vmdk  20G
          safe_echo "*** DISK CREATION COMPLETE ***"

      - name: üìÅ Bulk Directory Factory (1000+)
        if: ${{ inputs.bulk_directories == true }}
        run: |
          safe_echo "*** DIRECTORY MASS CREATION START ***"
          for i in {1..1000}; do
            mkdir -p "${WORKSPACE}/directories/dir_$i"
          done
          safe_echo "*** DIRECTORY MASS CREATION COMPLETE ***"

      - name: üì§ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-image-factory-${{ github.run_id }}
          path: |
            linux-images/artifacts
            linux-images/logs
          if-no-files-found: error
