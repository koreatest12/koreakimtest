name: "ðŸ’  ULTRA VersionOps â€” Upgrade + Downgrade + Rollback + Canary + GitOps + BlueGreen + Terraform + Secrets (LEFT-ECHO FULL / NO SKIP)"

on:
  workflow_dispatch:

env:
  TZ: Asia/Seoul
  VERSION_FILE: .github/version/VERSION
  BACKUP_DIR: .github/version/backups
  LOG_DIR: .github/version/logs
  DOCKER_IMAGE: your-registry/copilot-server
  K8S_DEPLOY_BLUE: copilot-server-blue
  K8S_DEPLOY_GREEN: copilot-server-green
  CANARY_DEPLOY: copilot-server-canary
  ARGO_APP: copilot-server
  TF_DIR: infra/terraform
  SECRET_TARGET: "secret/copilot-server"

jobs:
  versionops:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    #######################################################################
    # INIT
    #######################################################################
    - name: INIT paths
      shell: bash
      run: |
        echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
        echo "â–¶ mkdir -p ${BACKUP_DIR}"; mkdir -p "${BACKUP_DIR}"
        echo "â–¶ mkdir -p $(dirname ${VERSION_FILE})"; mkdir -p "$(dirname ${VERSION_FILE})"

        if [ ! -f "${VERSION_FILE}" ]; then
          echo "â–¶ echo 1.0.0 > ${VERSION_FILE}"; echo "1.0.0" > "${VERSION_FILE}"
        fi

        echo "â–¶ CURRENT=\$(cat ${VERSION_FILE})"; CURRENT=$(cat ${VERSION_FILE})
        echo "Current Version=${CURRENT}" | tee "${LOG_DIR}/00_init.txt"

    #######################################################################
    # BACKUP
    #######################################################################
    - name: BACKUP
      shell: bash
      run: |
        NOW=$(date +%Y%m%d_%H%M%S)
        BK="${BACKUP_DIR}/VERSION_${NOW}.bak"

        echo "â–¶ cp ${VERSION_FILE} ${BK}"; cp "${VERSION_FILE}" "${BK}"
        echo "Backup created ${BK}" | tee "${LOG_DIR}/01_backup.txt"

    #######################################################################
    # RESTORE (just to validate backup system)
    #######################################################################
    - name: RESTORE (validation)
      shell: bash
      run: |
        LAST=$(ls -t ${BACKUP_DIR} | head -1)
        echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
        echo "Restored from backup" | tee "${LOG_DIR}/02_restore.txt"

    #######################################################################
    # UPGRADE (datetime tag)
    #######################################################################
    - name: UPGRADE version
      shell: bash
      run: |
        CUR=$(cat ${VERSION_FILE})
        NEXT=$(date +%Y.%m.%d.%H%M)

        echo "â–¶ echo ${NEXT} > ${VERSION_FILE}"; echo "${NEXT}" > "${VERSION_FILE}"
        echo "Upgrade: ${CUR} â†’ ${NEXT}" | tee "${LOG_DIR}/03_upgrade.txt"

    #######################################################################
    # DOWNGRADE
    #######################################################################
    - name: DOWNGRADE
      shell: bash
      run: |
        CUR=$(cat ${VERSION_FILE})
        DOWN=$(echo $CUR | awk -F. '{print $1"."$2"."$3".0000"}')

        echo "â–¶ echo ${DOWN} > ${VERSION_FILE}"; echo "${DOWN}" > "${VERSION_FILE}"
        echo "Downgrade: ${CUR} â†’ ${DOWN}" | tee "${LOG_DIR}/04_downgrade.txt"

    #######################################################################
    # ROLLBACK
    #######################################################################
    - name: ROLLBACK
      shell: bash
      run: |
        LAST=$(ls -t ${BACKUP_DIR} | head -1)
        echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
        echo "Rollback to $(cat ${VERSION_FILE})" | tee "${LOG_DIR}/05_rollback.txt"

    #######################################################################
    # Docker Tag Update (Multi-region push)
    #######################################################################
    - name: Docker tag update
      shell: bash
      run: |
        VER=$(cat ${VERSION_FILE})

        echo "â–¶ docker pull ${DOCKER_IMAGE}:latest"; docker pull "${DOCKER_IMAGE}:latest" || true
        echo "â–¶ docker tag ${DOCKER_IMAGE}:latest ${DOCKER_IMAGE}:${VER}"; docker tag "${DOCKER_IMAGE}:latest" "${DOCKER_IMAGE}:${VER}" || true

        # MULTI REGION EXAMPLE
        for region in asia-northeast3 us-east1 eu-west1; do
          IMG="${DOCKER_IMAGE}-${region}:${VER}"
          echo "â–¶ docker tag ${DOCKER_IMAGE}:latest ${IMG}"; docker tag "${DOCKER_IMAGE}:latest" "${IMG}" || true
          echo "â–¶ docker push ${IMG}"; docker push "${IMG}" || true
        done

        echo "Docker Tagged â†’ ${VER}" | tee "${LOG_DIR}/06_docker_push.txt"

    #######################################################################
    # Detect K8S availability
    #######################################################################
    - name: Check K8s Connection
      id: k8scheck
      shell: bash
      run: |
        echo "â–¶ kubectl version --client"; kubectl version --client || true
        if kubectl get ns >/dev/null 2>&1; then
          echo "k8s_ok=true" >> $GITHUB_OUTPUT
        else
          echo "k8s_ok=false" >> $GITHUB_OUTPUT
        fi

    #######################################################################
    # Canary Deployment
    #######################################################################
    - name: Canary Deployment
      if: always()
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[INFO] K8s not available â†’ Canary SKIPPED (treated as success)" | tee "${LOG_DIR}/07_canary.txt"
          exit 0
        fi

        VER=$(cat ${VERSION_FILE})

        echo "â–¶ kubectl set image deployment/${CANARY_DEPLOY} ${CANARY_DEPLOY}=${DOCKER_IMAGE}:${VER}"
        kubectl set image deployment/${CANARY_DEPLOY} ${CANARY_DEPLOY}=${DOCKER_IMAGE}:${VER} || true

        echo "â–¶ kubectl rollout status deployment/${CANARY_DEPLOY}"
        kubectl rollout status deployment/${CANARY_DEPLOY} || true | tee "${LOG_DIR}/07_canary.txt"

    #######################################################################
    # Blue/Green Traffic Switching
    #######################################################################
    - name: BlueGreen Deployment
      if: always()
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[INFO] K8s not available â†’ BlueGreen SKIPPED" | tee "${LOG_DIR}/08_bluegreen.txt"
          exit 0
        fi

        VER=$(cat ${VERSION_FILE})

        echo "â–¶ kubectl set image deployment/${K8S_DEPLOY_GREEN} ${K8S_DEPLOY_GREEN}=${DOCKER_IMAGE}:${VER}"
        kubectl set image deployment/${K8S_DEPLOY_GREEN} ${K8S_DEPLOY_GREEN}=${DOCKER_IMAGE}:${VER} || true

        echo "â–¶ kubectl rollout status deployment/${K8S_DEPLOY_GREEN}"
        kubectl rollout status deployment/${K8S_DEPLOY_GREEN} || true

        echo "â–¶ kubectl patch svc copilot-server -p '{\"spec\":{\"selector\":{\"version\":\"green\"}}}'"
        kubectl patch svc copilot-server -p '{"spec":{"selector":{"version":"green"}}}' || true

        echo "BlueGreen switched â†’ GREEN" | tee "${LOG_DIR}/08_bluegreen.txt"

    #######################################################################
    # GitOps (ArgoCD Sync)
    #######################################################################
    - name: GitOps (ArgoCD Sync)
      if: always()
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[INFO] K8s not available â†’ ArgoCD Sync SKIPPED" | tee "${LOG_DIR}/09_gitops.txt"
          exit 0
        fi

        echo "â–¶ argocd app sync ${ARGO_APP}"; argocd app sync "${ARGO_APP}" || true
        echo "â–¶ argocd app wait ${ARGO_APP}"; argocd app wait "${ARGO_APP}" || true

        echo "ArgoCD Sync Completed" | tee "${LOG_DIR}/09_gitops.txt"

    #######################################################################
    # Terraform Infra VersionOps
    #######################################################################
    - name: Terraform VersionOps
      shell: bash
      run: |
        VER=$(cat ${VERSION_FILE})

        echo "â–¶ cd ${TF_DIR}"; cd "${TF_DIR}" || exit 0

        echo "â–¶ terraform init"; terraform init -input=false || true
        echo "â–¶ terraform apply -auto-approve -var version=${VER}"
        terraform apply -auto-approve -var version=${VER} || true | tee "${LOG_DIR}/10_terraform.txt"

    #######################################################################
    # Secret Rotation
    #######################################################################
    - name: Secret Rotation
      shell: bash
      run: |
        NEW_SECRET=$(openssl rand -hex 24)

        echo "â–¶ echo NEW_SECRET=\${NEW_SECRET}"; echo "NEW_SECRET=${NEW_SECRET}"

        echo "â–¶ kubectl create secret generic copilot-secret --dry-run=client -o yaml --from-literal=key=${NEW_SECRET} | kubectl apply -f -"
        kubectl create secret generic copilot-secret \
          --dry-run=client -o yaml \
          --from-literal=key=${NEW_SECRET} | kubectl apply -f - || true

        echo "Secret Rotated" | tee "${LOG_DIR}/11_secret.txt"

    #######################################################################
    # FINAL SUMMARY
    #######################################################################
    - name: Final Summary
      shell: bash
      run: |
        echo "=== FINAL REPORT ===" | tee "${LOG_DIR}/99_final.txt"
        echo "Version  = $(cat ${VERSION_FILE})" | tee -a "${LOG_DIR}/99_final.txt"
        echo "Backups  = $(ls -1 ${BACKUP_DIR} | wc -l)" | tee -a "${LOG_DIR}/99_final.txt"
        echo "K8s Available = ${{ steps.k8scheck.outputs.k8s_ok }}" | tee -a "${LOG_DIR}/99_final.txt"

    - uses: actions/upload-artifact@v4
      with:
        name: versionops-ultra-report
        path: ${{ env.LOG_DIR }}/
