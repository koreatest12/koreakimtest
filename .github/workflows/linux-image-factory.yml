name: "ðŸ”„ Concurrency Control + Runner Self-Heal + Auto-Retry + Upgrade (LEFT-ECHO FULL)"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  REPORT_DIR: .github/echo_report
  VERSION_FILE: .github/echo_report/VERSION

jobs:
  ##########################################################################
  # 0. Runner ì²´í¬ & Clean-up
  ##########################################################################
  prep_and_clean:
    name: "Runner Pre-Check / Cleanup"
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      disk_ok: ${{ steps.check.outputs.disk_ok }}
      mem_ok:  ${{ steps.check.outputs.mem_ok }}

    steps:
      - name: Prep dirs
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
          echo "â–¶ mkdir -p ${REPORT_DIR}"; mkdir -p "${REPORT_DIR}"

      - name: Snapshot (before cleanup)
        shell: bash
        run: |
          {
            echo "=== SNAPSHOT BEFORE CLEANUP ==="
            echo "â–¶ uname -a"; uname -a || true
            echo "â–¶ df -h"; df -h || true
            echo "â–¶ free -m"; free -m || true
            echo "â–¶ docker ps -a"; docker ps -a || true
            echo "â–¶ docker images"; docker images || true
          } | tee "${LOG_DIR}/00_snapshot_before.txt"

      - name: Cleanup docker & cache
        shell: bash
        run: |
          {
            echo "â–¶ docker system prune -af"; docker system prune -af || true
            echo "â–¶ docker volume prune -f"; docker volume prune -f || true
            echo "â–¶ sudo apt-get clean"; sudo apt-get clean || true
            echo "â–¶ sudo apt-get autoremove -y"; sudo apt-get autoremove -y || true
          } | tee "${LOG_DIR}/01_cleanup.txt"

      - name: Resource check
        id: check
        shell: bash
        run: |
          echo "â–¶ DISK=\$(df -BG / | awk 'NR==2 {gsub(\"G\", \"\", \$4); print \$4}')"; DISK=$(df -BG / | awk 'NR==2 {gsub("G","",$4); print $4}')
          echo "â–¶ MEM=\$(free -m | awk '/Mem:/ {print \$4}')"; MEM=$(free -m | awk '/Mem:/ {print $4}')

          DISK_OK="true"
          MEM_OK="true"
          if [ "$DISK" -lt 2 ];  then DISK_OK="false"; fi
          if [ "$MEM" -lt 512 ]; then MEM_OK="false"; fi

          echo "â–¶ echo disk_ok=$DISK_OK >> \$GITHUB_OUTPUT"; echo "disk_ok=$DISK_OK" >> $GITHUB_OUTPUT
          echo "â–¶ echo mem_ok=$MEM_OK >> \$GITHUB_OUTPUT"; echo "mem_ok=$MEM_OK" >> $GITHUB_OUTPUT

          {
            echo "=== RESOURCE CHECK ==="
            echo "DISK=${DISK}G"
            echo "DISK_OK=$DISK_OK"
            echo "MEM=${MEM}MB"
            echo "MEM_OK=$MEM_OK"
          } | tee "${LOG_DIR}/02_resource_check.txt"


  ##########################################################################
  # 1. Attempt #1 (Main Build/Test)
  ##########################################################################
  attempt1:
    name: "Build & Test â€” Attempt #1"
    runs-on: ubuntu-latest
    needs: prep_and_clean
    continue-on-error: true
    outputs:
      status: ${{ steps.mark.outputs.status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: pip

      - name: Prep dirs
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
          echo "â–¶ mkdir -p ${REPORT_DIR}"; mkdir -p "${REPORT_DIR}"

      - name: Install Node deps
        shell: bash
        run: |
          echo "â–¶ npm ci"; npm ci 2>&1 | tee "${LOG_DIR}/11_npm1.txt"

      - name: Install Python deps
        shell: bash
        run: |
          echo "â–¶ pip install -r requirements.txt"; pip install -r requirements.txt 2>&1 | tee "${LOG_DIR}/12_pip1.txt"

      - name: Build/Test
        id: buildtest
        shell: bash
        run: |
          echo "=== Attempt #1 ===" | tee "${LOG_DIR}/13_run1.txt"
          echo "â–¶ npm run lint"; npm run lint 2>&1 | tee -a "${LOG_DIR}/13_run1.txt"
          echo "â–¶ npm run format:check"; npm run format:check 2>&1 | tee -a "${LOG_DIR}/13_run1.txt"
          echo "â–¶ npm run build"; npm run build 2>&1 | tee -a "${LOG_DIR}/13_run1.txt"

          if [ -d dist ] && [ -n "$(ls -A dist)" ]; then
            echo "â–¶ echo success > .result"; echo "success" > .result
          else
            echo "â–¶ echo failure > .result"; echo "failure" > .result
          fi

      - name: Mark status
        id: mark
        shell: bash
        run: |
          echo "â–¶ cat .result"; STATUS=$(cat .result)
          echo "â–¶ echo status=$STATUS >> \$GITHUB_OUTPUT"; echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Attempt1: $STATUS" | tee "${LOG_DIR}/14_status1.txt"


  ##########################################################################
  # 2. Attempt #2 (Auto Retry)
  ##########################################################################
  attempt2:
    name: "Build & Test â€” Attempt #2 (Retry)"
    runs-on: ubuntu-latest
    needs: [prep_and_clean, attempt1]
    if: ${{ needs.attempt1.outputs.status != 'success' }}
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: pip

      - name: Prep dirs
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
          echo "â–¶ mkdir -p ${REPORT_DIR}"; mkdir -p "${REPORT_DIR}"

      - name: Install Node deps
        shell: bash
        run: |
          echo "â–¶ npm ci"; npm ci 2>&1 | tee "${LOG_DIR}/21_npm2.txt"

      - name: Install Python deps
        shell: bash
        run: |
          echo "â–¶ pip install -r requirements.txt"; pip install -r requirements.txt 2>&1 | tee "${LOG_DIR}/22_pip2.txt"

      - name: Build/Test (retry)
        shell: bash
        run: |
          echo "=== Attempt #2 ===" | tee "${LOG_DIR}/23_run2.txt"
          echo "â–¶ npm run lint"; npm run lint 2>&1 | tee -a "${LOG_DIR}/23_run2.txt"
          echo "â–¶ npm run format:check"; npm run format:check 2>&1 | tee -a "${LOG_DIR}/23_run2.txt"
          echo "â–¶ npm run build"; npm run build 2>&1 | tee -a "${LOG_DIR}/23_run2.txt"


  ##########################################################################
  # 3. UPGRADE ê¸°ëŠ¥ (ALL ì ìš©)
  ##########################################################################
  upgrade:
    name: "Upgrade System (LEFT-ECHO FULL)"
    runs-on: ubuntu-latest
    needs:
      - attempt1
      - attempt2

    steps:
      - name: Prep dirs
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${REPORT_DIR}"; mkdir -p "${REPORT_DIR}"

      - name: Load current version
        shell: bash
        run: |
          if [ -f "${VERSION_FILE}" ]; then
            echo "â–¶ CURRENT=\$(cat ${VERSION_FILE})"; CURRENT=$(cat "${VERSION_FILE}")
          else
            echo "â–¶ echo 1.0.0 > ${VERSION_FILE}"; echo "1.0.0" > "${VERSION_FILE}"
            CURRENT="1.0.0"
          fi
          echo "â–¶ echo Current=$CURRENT"; echo "Current=$CURRENT"

      - name: Generate next version
        shell: bash
        run: |
          echo "â–¶ NEXT=\$(date +%Y.%m.%d.%H%M)"; NEXT=$(date +%Y.%m.%d.%H%M)
          echo "â–¶ echo $NEXT > ${VERSION_FILE}"; echo "$NEXT" > "${VERSION_FILE}"
          echo "Updated Version=$NEXT" | tee "${REPORT_DIR}/UPGRADE.txt"

      - name: Confirm
        shell: bash
        run: |
          echo "â–¶ cat ${VERSION_FILE}"; cat "${VERSION_FILE}"


  ##########################################################################
  # 4. Final Summary
  ##########################################################################
  final_report:
    name: "Final Summary"
    runs-on: ubuntu-latest
    needs:
      - prep_and_clean
      - attempt1
      - attempt2
      - upgrade
    if: always()

    steps:
      - name: Report
        shell: bash
        run: |
          echo "â–¶ mkdir -p ${REPORT_DIR}"; mkdir -p "${REPORT_DIR}"

          {
            echo "=== FINAL SUMMARY ==="
            echo "Attempt1 = ${{ needs.attempt1.outputs.status }}"
            echo "Attempt2 = ${{ needs.attempt2.result }}"
            echo "Disk OK  = ${{ needs.prep_and_clean.outputs.disk_ok }}"
            echo "Mem OK   = ${{ needs.prep_and_clean.outputs.mem_ok }}"
            echo "Version  = $(cat ${VERSION_FILE})"
          } | tee "${REPORT_DIR}/final_summary.txt"

      - uses: actions/upload-artifact@v4
        with:
          name: final-summary
          path: ${{ env.REPORT_DIR }}/
