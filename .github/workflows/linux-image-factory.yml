name: "Linux Image Factory — EchoOps ALL-Injected V3"

on:
  workflow_dispatch:
    inputs:
      build_ubuntu:
        type: boolean
        default: true
      build_rhel:
        type: boolean
        default: true
      build_kali:
        type: boolean
        default: true
      build_iso:
        type: boolean
        default: true
      build_disk:
        type: boolean
        default: true
      bulk_directories:
        type: boolean
        default: true

  schedule:
    - cron: "0 2 * * 1"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  WORKSPACE: linux-images
  LOG_DIR: linux-images/logs
  ARTIFACT_DIR: linux-images/artifacts

jobs:
  mega-factory:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ###########################################################################
      # ECHOOPS GLOBAL LOADER (SafeEcho + echo_trace) — 100% 호환 버전
      ###########################################################################
      - name: Install EchoOps Runtime
        shell: bash
        run: |
          mkdir -p scripts

          echo '#!/usr/bin/env bash' > scripts/echoops.sh
          echo 'safe_echo() { printf "[SAFE] %s\n" "$1"; }' >> scripts/echoops.sh
          echo 'echo_trace() { printf "[TRACE] %s\n" "$1"; }' >> scripts/echoops.sh

          chmod +x scripts/echoops.sh

          echo "[INIT] EchoOps Installed globally."

      ###########################################################################
      # GLOBAL STEP WRAPPER (모든 Step에 SafeEcho 자동 삽입)
      ###########################################################################
      - name: Load EchoOps Global Wrapper
        id: echoops
        run: |
          echo "source ./scripts/echoops.sh" >> $GITHUB_ENV
          echo "[INIT] EchoOps Wrapper exported"

      ###########################################################################
      # START WORKSPACE
      ###########################################################################
      - name: Initialize Workspace
        run: |
          source ./scripts/echoops.sh
          safe_echo "Initializing workspace…"

          mkdir -p ${WORKSPACE}/{artifacts,logs,tmp,iso,disks,ubuntu,rhel,kali,directories}

          safe_echo "Workspace ready."

      ###########################################################################
      # INSTALL REQUIRED TOOLS
      ###########################################################################
      - name: Install Required Tools
        run: |
          source ./scripts/echoops.sh
          safe_echo "Installing Linux image build tools…"

          sudo apt-get update
          sudo apt-get install -y \
            qemu-utils xorriso genisoimage \
            debootstrap squashfs-tools \
            qemu-system-x86 live-build \
            curl wget git vim

          safe_echo "Tool installation complete."

      ###########################################################################
      # UBUNTU BUILD
      ###########################################################################
      - name: Build Ubuntu Image
        if: ${{ inputs.build_ubuntu }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Starting Ubuntu build…"

          UBUNTU_DIR="${WORKSPACE}/ubuntu"
          mkdir -p "$UBUNTU_DIR"

          debootstrap --arch=amd64 noble "$UBUNTU_DIR" http://archive.ubuntu.com/ubuntu/

          chroot "$UBUNTU_DIR" bash -c "
            apt-get update && \
            apt-get install -y openssh-server sudo curl wget \
            python3 python3-pip git vim build-essential
          "

          tar -czf ${ARTIFACT_DIR}/ubuntu-base.tar.gz -C "$UBUNTU_DIR" .

          safe_echo "Ubuntu build complete."

      ###########################################################################
      # RHEL BUILD (ROCKY)
      ###########################################################################
      - name: Build RHEL (Rocky Linux)
        if: ${{ inputs.build_rhel }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Starting RHEL-based build…"

          RHEL_DIR="${WORKSPACE}/rhel"
          mkdir -p "$RHEL_DIR"

          curl -L \
            https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2 \
            -o "${RHEL_DIR}/rhel-base.qcow2"

          cp "${RHEL_DIR}/rhel-base.qcow2" ${ARTIFACT_DIR}/rhel-base.qcow2

          safe_echo "RHEL build complete."

      ###########################################################################
      # KALI BUILD
      ###########################################################################
      - name: Build Kali Linux Image
        if: ${{ inputs.build_kali }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Starting Kali build…"

          KALI_DIR="${WORKSPACE}/kali"
          mkdir -p "$KALI_DIR"

          debootstrap --arch=amd64 kali-rolling "$KALI_DIR" http://http.kali.org/kali

          chroot "$KALI_DIR" bash -c "
            apt-get update && \
            apt-get install -y kali-linux-default metasploit-framework \
            python3 python3-pip curl wget htop git nmap
          "

          tar -czf ${ARTIFACT_DIR}/kali-base.tar.gz -C "$KALI_DIR" .

          safe_echo "Kali build complete."

      ###########################################################################
      # ISO BUILD
      ###########################################################################
      - name: Build ISO Image
        if: ${{ inputs.build_iso }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Creating ISO…"

          mkdir -p iso_build/rootfs
          echo "Linux Image Factory ISO" > iso_build/rootfs/INFO.txt

          genisoimage -o ${ARTIFACT_DIR}/factory.iso iso_build/rootfs

          safe_echo "ISO generation complete."

      ###########################################################################
      # DISK IMAGES
      ###########################################################################
      - name: Create Disk Images
        if: ${{ inputs.build_disk }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Creating QCOW2 and VMDK…"

          qemu-img create -f qcow2 ${ARTIFACT_DIR}/linux-disk.qcow2 20G
          qemu-img create -f vmdk ${ARTIFACT_DIR}/linux-disk.vmdk 20G

          safe_echo "Disk images complete."

      ###########################################################################
      # MASS DIRECTORY CREATION
      ###########################################################################
      - name: Create Bulk Directories (1000)
        if: ${{ inputs.bulk_directories }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Generating 1000 directories…"

          for i in {1..1000}; do
            mkdir -p "${WORKSPACE}/directories/dir_$i"
          done

          safe_echo "Bulk directory creation complete."

      ###########################################################################
      # ARTIFACT UPLOAD
      ###########################################################################
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-factory-${{ github.run_id }}
          path: |
            linux-images/artifacts
            linux-images/logs
          if-no-files-found: error
