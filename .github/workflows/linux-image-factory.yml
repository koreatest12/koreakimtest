name: "ðŸ’  ULTRA VersionOps â€” Error-Free + Auto-Mock + Full Pipeline (LEFT-ECHO FULL)"

on:
  workflow_dispatch:

env:
  TZ: Asia/Seoul
  VERSION_FILE: .github/version/VERSION
  BACKUP_DIR: .github/version/backups
  LOG_DIR: .github/version/logs
  DOCKER_IMAGE: mock/copilot-server
  K8S_DEPLOY_BLUE: mock-blue
  K8S_DEPLOY_GREEN: mock-green
  CANARY_DEPLOY: mock-canary
  ARGO_APP: mock-app
  TF_DIR: infra/terraform

jobs:
  versionops:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:

    #######################################################################
    # INIT
    #######################################################################
    - name: INIT Paths
      shell: bash
      run: |
        echo "â–¶ mkdir -p ${LOG_DIR}"; mkdir -p "${LOG_DIR}"
        echo "â–¶ mkdir -p ${BACKUP_DIR}"; mkdir -p "${BACKUP_DIR}"
        echo "â–¶ mkdir -p $(dirname ${VERSION_FILE})"; mkdir -p "$(dirname ${VERSION_FILE})"

        if [ ! -f "${VERSION_FILE}" ]; then
          echo "â–¶ echo 1.0.0 > ${VERSION_FILE}"; echo "1.0.0" > "${VERSION_FILE}"
        fi

        echo "â–¶ CURRENT=$(cat ${VERSION_FILE})"; CURRENT=$(cat ${VERSION_FILE})
        echo "Current Version=${CURRENT}" | tee "${LOG_DIR}/00_init.txt"


    #######################################################################
    # BACKUP
    #######################################################################
    - name: BACKUP
      shell: bash
      run: |
        NOW=$(date +%Y%m%d_%H%M%S)
        BK="${BACKUP_DIR}/VERSION_${NOW}.bak"

        echo "â–¶ cp ${VERSION_FILE} ${BK}"; cp "${VERSION_FILE}" "${BK}"
        echo "Backup created: ${BK}" | tee "${LOG_DIR}/01_backup.txt"


    #######################################################################
    # RESTORE (test)
    #######################################################################
    - name: RESTORE (just validation)
      shell: bash
      run: |
        LAST=$(ls -t ${BACKUP_DIR} | head -1)
        echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
        echo "Restored backup" | tee "${LOG_DIR}/02_restore.txt"


    #######################################################################
    # UPGRADE
    #######################################################################
    - name: UPGRADE Version
      shell: bash
      run: |
        CUR=$(cat ${VERSION_FILE})
        NEXT=$(date +%Y.%m.%d.%H%M)
        echo "â–¶ echo ${NEXT} > ${VERSION_FILE}"; echo "${NEXT}" > "${VERSION_FILE}"
        echo "Upgrade: ${CUR} â†’ ${NEXT}" | tee "${LOG_DIR}/03_upgrade.txt"


    #######################################################################
    # DOWNGRADE
    #######################################################################
    - name: DOWNGRADE
      shell: bash
      run: |
        CUR=$(cat ${VERSION_FILE})
        DOWN=$(echo $CUR | awk -F. '{print $1"."$2"."$3".0000"}')
        echo "â–¶ echo ${DOWN} > ${VERSION_FILE}"; echo "${DOWN}" > "${VERSION_FILE}"
        echo "Downgrade: ${CUR} â†’ ${DOWN}" | tee "${LOG_DIR}/04_downgrade.txt"


    #######################################################################
    # ROLLBACK
    #######################################################################
    - name: ROLLBACK
      shell: bash
      run: |
        LAST=$(ls -t ${BACKUP_DIR} | head -1)
        echo "â–¶ cp ${BACKUP_DIR}/${LAST} ${VERSION_FILE}"; cp "${BACKUP_DIR}/${LAST}" "${VERSION_FILE}"
        echo "Rollback to $(cat ${VERSION_FILE})" | tee "${LOG_DIR}/05_rollback.txt"


    #######################################################################
    # Docker Build (Mock if needed)
    #######################################################################
    - name: Ensure Docker Mock Image
      shell: bash
      run: |
        echo "â–¶ echo 'FROM alpine' > Dockerfile"; echo "FROM alpine" > Dockerfile
        echo "â–¶ echo 'CMD echo mock image' >> Dockerfile"; echo "CMD echo mock image" >> Dockerfile

        echo "â–¶ docker build -t mock-image ."; docker build -t mock-image . || true

        # Make mock image available for tagging
        echo "â–¶ docker tag mock-image ${DOCKER_IMAGE}:latest"; docker tag mock-image "${DOCKER_IMAGE}:latest" || true


    #######################################################################
    # Docker Tag + Multi-Region Push (Mock)
    #######################################################################
    - name: Docker Tag / Push
      shell: bash
      run: |
        VER=$(cat ${VERSION_FILE})
        echo "â–¶ docker tag ${DOCKER_IMAGE}:latest ${DOCKER_IMAGE}:${VER}"
        docker tag "${DOCKER_IMAGE}:latest" "${DOCKER_IMAGE}:${VER}" || true

        for r in asia us eu; do
          IMG="${DOCKER_IMAGE}-${r}:${VER}"
          echo "â–¶ docker tag ${DOCKER_IMAGE}:latest ${IMG}"; docker tag "${DOCKER_IMAGE}:latest" "${IMG}" || true
          echo "â–¶ docker push ${IMG} (mock)"; echo "[MOCK PUSH] ${IMG}" | tee -a "${LOG_DIR}/06_docker.txt"
        done

        echo "Docker Version Tagged=${VER}" | tee "${LOG_DIR}/06_docker.txt"


    #######################################################################
    # K8S Connection Check
    #######################################################################
    - name: Check K8s
      id: k8scheck
      shell: bash
      run: |
        if kubectl get ns >/dev/null 2>&1; then
          echo "k8s_ok=true" >> $GITHUB_OUTPUT
        else
          echo "k8s_ok=false" >> $GITHUB_OUTPUT
        fi
        echo "K8s Available=${{ steps.k8scheck.outputs.k8s_ok }}" | tee "${LOG_DIR}/07_k8scheck.txt"


    #######################################################################
    # Canary Deployment (Soft-Skip)
    #######################################################################
    - name: Canary Deploy
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[SKIP] K8s unavailable â†’ Canary skipped" | tee "${LOG_DIR}/08_canary.txt"
          exit 0
        fi

        VER=$(cat ${VERSION_FILE})
        echo "â–¶ kubectl set image deployment/${CANARY_DEPLOY}=${DOCKER_IMAGE}:${VER}"
        kubectl set image deployment/${CANARY_DEPLOY} ${CANARY_DEPLOY}=${DOCKER_IMAGE}:${VER} || true

        echo "â–¶ kubectl rollout status deployment/${CANARY_DEPLOY}"
        kubectl rollout status deployment/${CANARY_DEPLOY} || true


    #######################################################################
    # Blue/Green Deployment (Soft-Skip)
    #######################################################################
    - name: BlueGreen Switch
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[SKIP] K8s unavailable â†’ BlueGreen skipped" | tee "${LOG_DIR}/09_bluegreen.txt"
          exit 0
        fi

        VER=$(cat ${VERSION_FILE})
        echo "â–¶ kubectl set image deployment/${K8S_DEPLOY_GREEN}=${DOCKER_IMAGE}:${VER}"
        kubectl set image deployment/${K8S_DEPLOY_GREEN} ${K8S_DEPLOY_GREEN}=${DOCKER_IMAGE}:${VER} || true

        echo "â–¶ kubectl patch svc copilot-server -p '{\"spec\":{\"selector\":{\"version\":\"green\"}}}'"
        kubectl patch svc copilot-server -p '{"spec":{"selector":{"version":"green"}}}' || true

        echo "BlueGreen switched to GREEN" | tee "${LOG_DIR}/09_bluegreen.txt"


    #######################################################################
    # GitOps (Soft-Skip)
    #######################################################################
    - name: GitOps
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[SKIP] K8s unavailable â†’ GitOps SKIPPED" | tee "${LOG_DIR}/10_gitops.txt"
          exit 0
        fi

        echo "â–¶ argocd app sync ${ARGO_APP}"; argocd app sync ${ARGO_APP} || true
        echo "â–¶ argocd app wait ${ARGO_APP}"; argocd app wait ${ARGO_APP} || true


    #######################################################################
    # Terraform (Mock if missing)
    #######################################################################
    - name: Terraform
      shell: bash
      run: |
        if [ ! -d "${TF_DIR}" ]; then
          echo "[MOCK] Terraform not found â†’ SKIP" | tee "${LOG_DIR}/11_tf.txt"
          exit 0
        fi

        VER=$(cat ${VERSION_FILE})

        echo "â–¶ cd ${TF_DIR}"; cd "${TF_DIR}"
        echo "â–¶ terraform init"; terraform init -input=false || true
        echo "â–¶ terraform apply -auto-approve -var version=${VER}"
        terraform apply -auto-approve -var version=${VER} || true


    #######################################################################
    # Secret Rotation (Soft-Skip)
    #######################################################################
    - name: Secret Rotation
      shell: bash
      run: |
        if [ "${{ steps.k8scheck.outputs.k8s_ok }}" != "true" ]; then
          echo "[SKIP] K8s unavailable â†’ Secret Rotation skipped" | tee "${LOG_DIR}/12_secret.txt"
          exit 0
        fi

        NEW_KEY=$(openssl rand -hex 24)
        echo "â–¶ kubectl create secret generic copilot-secret"
        kubectl create secret generic copilot-secret \
          --dry-run=client -o yaml \
          --from-literal=key=${NEW_KEY} | kubectl apply -f - || true


    #######################################################################
    # FINAL SUMMARY
    #######################################################################
    - name: Final Summary
      shell: bash
      run: |
        echo "=== FINAL REPORT ===" | tee "${LOG_DIR}/99_final.txt"
        echo "Version=$(cat ${VERSION_FILE})" | tee -a "${LOG_DIR}/99_final.txt"
        echo "Backups=$(ls -1 ${BACKUP_DIR} | wc -l)" | tee -a "${LOG_DIR}/99_final.txt"
        echo "K8sOK=${{ steps.k8scheck.outputs.k8s_ok }}" | tee -a "${LOG_DIR}/99_final.txt"

    - uses: actions/upload-artifact@v4
      with:
        name: versionops-final
        path: ${{ env.LOG_DIR }}/
