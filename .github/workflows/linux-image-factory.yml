name: "Linux Image Factory — Ultra Mega V5 (ALL ECHO FIXED)"

on:
  workflow_dispatch:
    inputs:
      build_ubuntu:
        type: boolean
        default: true
      build_rhel:
        type: boolean
        default: true
      build_kali:
        type: boolean
        default: true
      build_iso:
        type: boolean
        default: true
      build_disk:
        type: boolean
        default: true
      bulk_directories:
        type: boolean
        default: true
      advanced:
        type: boolean
        default: true

  schedule:
    - cron: "0 2 * * 1"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  WORKSPACE: linux-images
  ARTIFACT_DIR: linux-images/artifacts

jobs:
  linux-factory:
    runs-on: ubuntu-latest

    steps:
      ###########################################################################
      # 1) Checkout
      ###########################################################################
      - name: Checkout
        uses: actions/checkout@v4


      ###########################################################################
      # 2) Install EchoOps Runtime (HEREDOC-FREE • 100% SAFE)
      ###########################################################################
      - name: Install EchoOps Runtime
        run: |
          mkdir -p scripts
          echo '#!/usr/bin/env bash' > scripts/echoops.sh
          echo 'safe_echo() { printf "[SAFE] %s\n" "$1"; }' >> scripts/echoops.sh
          echo 'echo_trace() { printf "[TRACE] %s\n" "$1"; }' >> scripts/echoops.sh
          chmod +x scripts/echoops.sh
          echo "[INIT] EchoOps runtime installed successfully."


      ###########################################################################
      # 3) Initialize Workspace
      ###########################################################################
      - name: Initialize Workspace
        run: |
          source ./scripts/echoops.sh
          safe_echo "Initializing workspace…"

          mkdir -p ${WORKSPACE}/{artifacts,logs,tmp,iso,disks,ubuntu,rhel,kali,directories}

          safe_echo "Workspace ready."


      ###########################################################################
      # 4) Install All Build Tools
      ###########################################################################
      - name: Install Build Tools
        run: |
          source ./scripts/echoops.sh

          safe_echo "Installing all required system build tools..."

          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 qemu-utils xorriso genisoimage \
            grub-common grub-pc-bin grub-efi-amd64-bin \
            debootstrap live-build squashfs-tools \
            cloud-image-utils ovmf \
            build-essential flex bison libssl-dev libncurses-dev \
            lvm2 mdadm \
            wget curl git vim

          safe_echo "Build tools installation complete."


      ###########################################################################
      # 5) Build Ubuntu Image (200 packages)
      ###########################################################################
      - name: Build Ubuntu Image
        if: ${{ inputs.build_ubuntu }}
        run: |
          source ./scripts/echoops.sh

          safe_echo "Starting Ubuntu rootfs build…"

          UB="${WORKSPACE}/ubuntu"
          mkdir -p "$UB"

          debootstrap noble "$UB" http://archive.ubuntu.com/ubuntu/

          PKGS=$(printf "pkg%d " {1..200})

          chroot "$UB" bash -c "
            apt-get update &&
            apt-get install -y openssh-server sudo git vim python3 python3-pip $PKGS
          "

          tar -czf ${ARTIFACT_DIR}/ubuntu-rootfs.tar.gz -C "$UB" .

          safe_echo "Ubuntu rootfs build complete."


      ###########################################################################
      # 6) Build RHEL (Rocky Linux)
      ###########################################################################
      - name: Build RHEL Image
        if: ${{ inputs.build_rhel }}
        run: |
          source ./scripts/echoops.sh

          RL="${WORKSPACE}/rhel"
          mkdir -p "$RL"

          curl -L https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2 \
            -o "${RL}/rhel-base.qcow2"

          cp "${RL}/rhel-base.qcow2" ${ARTIFACT_DIR}/

          safe_echo "RHEL image ready."


      ###########################################################################
      # 7) Build Kali Linux
      ###########################################################################
      - name: Build Kali Linux
        if: ${{ inputs.build_kali }}
        run: |
          source ./scripts/echoops.sh

          KL="${WORKSPACE}/kali"
          mkdir -p "$KL"

          debootstrap kali-rolling "$KL" http://http.kali.org/kali

          chroot "$KL" bash -c "
            apt-get update &&
            apt-get install -y kali-linux-default metasploit-framework nmap git curl
          "

          tar -czf ${ARTIFACT_DIR}/kali-rootfs.tar.gz -C "$KL" .

          safe_echo "Kali rootfs build complete."


      ###########################################################################
      # 8) EFI + GRUB Bootable ISO
      ###########################################################################
      - name: Build EFI + GRUB Bootable ISO
        if: ${{ inputs.build_iso }}
        run: |
          source ./scripts/echoops.sh

          ISO="${WORKSPACE}/iso"
          mkdir -p "$ISO"

          echo "Linux Image Factory ISO" > "$ISO/README.txt"

          grub-mkrescue -o ${ARTIFACT_DIR}/factory-efi.iso "$ISO"

          safe_echo "EFI bootable ISO created."


      ###########################################################################
      # 9) Cloud-Init Image
      ###########################################################################
      - name: Build Cloud-Init Image
        if: ${{ inputs.advanced }}
        run: |
          source ./scripts/echoops.sh

          cloud-localds ${ARTIFACT_DIR}/cloud-init-seed.img \
            <(printf "#cloud-config\npassword: root\nchpasswd: { expire: False }\n")

          safe_echo "Cloud-init seed created."


      ###########################################################################
      # 10) Kernel Compile (Mock or Real)
      ###########################################################################
      - name: Kernel Compilation
        if: ${{ inputs.advanced }}
        run: |
          source ./scripts/echoops.sh

          safe_echo "Kernel compile step executed (mock)."


      ###########################################################################
      # 11) RAID/LVM Configuration
      ###########################################################################
      - name: RAID + LVM Setup
        if: ${{ inputs.advanced }}
        run: |
          source ./scripts/echoops.sh

          safe_echo "RAID + LVM setup simulated."


      ###########################################################################
      # 12) 10,000 directories
      ###########################################################################
      - name: Create 10000 Directories
        if: ${{ inputs.bulk_directories }}
        run: |
          source ./scripts/echoops.sh
          safe_echo "Creating 10,000 directories…"

          for i in {1..10000}; do
            mkdir -p "${WORKSPACE}/directories/dir_$i"
          done

          safe_echo "Directory generation complete."


      ###########################################################################
      # 13) Upload artifacts
      ###########################################################################
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-factory-v5-${{ github.run_id }}
          path: linux-images/artifacts
          if-no-files-found: error
