name: "AWS Full Mock Simulation — No Real Tokens Needed"

on:
  workflow_dispatch:
    inputs:
      loops:
        description: "반복 횟수"
        default: "20"
      services:
        description: "테스트 서비스 (all/mock)"
        default: "all"

jobs:
  full_mock_test:
    runs-on: ubuntu-latest

    steps:
      - name: Init Mock System
        shell: bash
        run: |
          echo "== INIT MOCK SYSTEM =="
          echo "Loops: ${{ github.event.inputs.loops }}"
          mkdir -p mock_tokens mock_services mock_logs

      - name: Generate Fake AWS Tokens
        shell: bash
        run: |
          echo "== GENERATE FAKE AWS TOKENS =="
          echo "export AWS_ACCESS_KEY_ID=FAKEKEY-$RANDOM$RANDOM" > mock_tokens/aws.env
          echo "export AWS_SECRET_ACCESS_KEY=FAKESECRET-$RANDOM$RANDOM$RANDOM" >> mock_tokens/aws.env
          echo "export AWS_SESSION_TOKEN=FAKESESSION-$RANDOM$RANDOM" >> mock_tokens/aws.env
          cat mock_tokens/aws.env

      - name: Mock Install All AWS Free Services
        shell: bash
        run: |
          echo "== INSTALL MOCK SERVICES =="
          for svc in lambda sqs sns dynamodb apigw iam sts cloudwatch codebuild codecommit glue xray; do
            echo "Installing mock $svc service ..."
            touch mock_services/$svc.installed
          done

      - name: Mock Lambda Invoke
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[Lambda MOCK] invoke function mockFn-$i :: payload={id:$i}"
          done

      - name: Mock SQS
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[SQS MOCK] queue=myq :: send message=hello-$i"
          done

      - name: Mock SNS
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[SNS MOCK] topic=myTopic :: publish=notify-$i"
          done

      - name: Mock API Gateway
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[API-GW MOCK] GET /mock/api/$i :: status=200"
          done

      - name: Mock DynamoDB
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[DynamoDB MOCK] table=Users :: key=user-$i :: result=mock-data"
          done

      - name: Mock CloudWatch Logs
        shell: bash
        run: |
          for i in $(seq 1 ${{ github.event.inputs.loops }}); do
            echo "[CloudWatch MOCK] log_event=/aws/mock/$i :: message='event-$i'"
          done

      - name: Mock IAM
        shell: bash
        run: |
          echo "[IAM MOCK] list-users"
          echo "[IAM MOCK] list-roles"
          echo "[IAM MOCK] simulate-policy"

      - name: Mock STS
        shell: bash
        run: |
          echo "[STS MOCK] get-caller-identity :: arn=fake:aws:iam::123456789012:user/mock"

      - name: Mock CodeBuild
        shell: bash
        run: |
          echo "[CodeBuild MOCK] build-start :: project=mock-build"
          echo "[CodeBuild MOCK] build-complete :: status=SUCCESS"

      - name: Mock Glue Data Catalog
        shell: bash
        run: |
          echo "[Glue MOCK] list-databases"
          echo "[Glue MOCK] list-tables"

      - name: Mock X-Ray
        shell: bash
        run: |
          echo "[X-Ray MOCK] trace=mock-trace-id :: segments=3"

      - name: Mock Directory + ISO Creation
        shell: bash
        run: |
          echo "[DIR MOCK] creating 100 mock AWS service directories"
          for d in $(seq 1 100); do
            mkdir -p mock_dirs/service_$d
            echo "service_$d info" > mock_dirs/service_$d/INFO.txt
          done
          echo "[ISO MOCK] generating mock iso image ..."
          mkdir -p mock_iso/rootfs
          echo "AWS MOCK ISO DATA" > mock_iso/rootfs/system.txt
          echo "Created mock ISO structure (no real ISO build)"

      - name: End
        shell: bash
        run: |
          echo "== ALL MOCK AWS SERVICES COMPLETE ==

      - name: "AWS FULL MOCK EXPANSION — ALL SERVICES INCLUDED"
        shell: bash
        run: |
          echo "== FULL AWS MOCK EXPANSION START =="

          # 대량 서비스 목록
          services=( ec2 rds s3 efs fsx eks ecs elb cloudfront route53 waf shield inspector config backup organizations budgets ce athena glue redshift neptune qldb timestream kinesis firehose emr stepfunctions mq sns sqs ses ssm kms secretsmanager cognito cloudformation cloudtrail cloudwatch lambda apigw ecr codecommit codedeploy codepipeline codebuild codestar eventbridge opensearch elasticache memorydb dynamodb iam sts acm directconnect sagemaker bedrock datazone datapipeline snowball transfer mediaconvert mediapackage mediastore mediatailor cloudhsm iot iotcore iotevents greengrass alexa robomaker gamelift workspaces workdocs workmail chime route53resolver migrationhub drs dms mgn)

          mkdir -p mock_aws_all

          for svc in "${services[@]}"; do
            echo "[AWS-MOCK] Installing service: $svc"
            mkdir -p mock_aws_all/$svc
            echo "SERVICE=$svc" > mock_aws_all/$svc/INFO.txt
            echo "MOCK_GENERATED=$(date)" >> mock_aws_all/$svc/INFO.txt
          done

          echo "== FULL AWS MOCK EXPANSION COMPLETE

      - name: "Generate Final Report (Markdown)"
        shell: bash
        run: |
          echo "# AWS Full Mock Simulation Final Report" > FINAL_REPORT.md
          echo "Generated: $(date)" >> FINAL_REPORT.md
          echo "## Included Services" >> FINAL_REPORT.md
          for svc in mock_aws_all/*; do
            echo "- $(basename $svc)" >> FINAL_REPORT.md
          done
          echo "## Summary" >> FINAL_REPORT.md
          echo "All AWS services have been fully mocked, directories created, tokens generated, and logs recorded." >> FINAL_REPORT.md
          mkdir -p mock_reports
          cp FINAL_REPORT.md mock_reports/

      - name: "Mock Release Build"
        shell: bash
        run: |
          echo "== MOCK RELEASE BUILD START =="
          mkdir -p mock_release
          cp FINAL_REPORT.md mock_release/FINAL_REPORT.md
          echo "MOCK_RELEASE_VERSION=v1.0.$RANDOM" > mock_release/release.info
          echo "== MOCK RELEASE BUILD COMPLETE =="

      - name: "Mock Publish Release"
        shell: bash
        run: |
          printf "%s\n" "[MOCK RELEASE] Creating fake GitHub release artifact" \
            "Release published successfully (mock)" \
            "Artifacts: FINAL_REPORT.md"
          echo "== MOCK RELEASE PUBLISH COMPLETE ==" ==" ==" ==""
