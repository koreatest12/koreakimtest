name: "ğŸ›° API Curl Test Server â€” EchoOps DR+ISO Audit Pipeline"

on:
  workflow_dispatch:
    inputs:
      target_url:            # 1
        description: "í˜¸ì¶œí•  API URL (ë¹ˆê°’ì´ë©´ Anthropic Claude messages)"
        required: false
        default: "https://api.anthropic.com/v1/messages"
      run_mode:              # 2
        description: "full=ì „ì²´ ìˆ˜í–‰ / lite=DR/íŒŒì¼ë§Œ ìƒì„± (ì™¸ë¶€ curl í˜¸ì¶œ ìŠ¤í‚µ)"
        required: false
        default: "full"

permissions:
  contents: write
  actions: read
  security-events: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  SERVICE_DIR: .github/echo_services
  PERM_DIR: .github/echo_perm
  SERVICES: "claude_api dr_center iso_builder"
  RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  curl-test-server:
    name: "Curl Test Server Runner (Echo / DR / Audit / Safe-Continue)"
    runs-on: ubuntu-22.04

    steps:
      ##################################################################
      # 0. ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      ##################################################################
      - name: "[prep] Checkout repository"
        uses: actions/checkout@v4

      ##################################################################
      # 1. ê¸°ë³¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
      #    - echo_logs / echo_artifacts / echo_services / echo_perm / echo_tmp
      ##################################################################
      - name: "[prep] Create base dirs"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
        run: |
          echo ">>> [prep] start"
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${SERVICE_DIR}" "${PERM_DIR}" .github/echo_tmp || true
          echo "[INFO] base dirs ready (RUN_ID=${RUN_ID})" | tee -a "${LOG_DIR}/prep.init.log"

      ##################################################################
      # 2. ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬ / ê¶Œí•œ íŒŒì¼ / ìƒíƒœ ë¡œê·¸ ìƒì„±
      #    - RUN_ID í¬í•¨
      #    - Heredoc ê¸ˆì§€. printf/echoë§Œ ì‚¬ìš©.
      ##################################################################
      - name: "[svc] Init service dirs + perms + status"
        env:
          SERVICES: ${{ env.SERVICES }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo ">>> [svc] start"
          for svc in $SERVICES; do
            svc_dir="${SERVICE_DIR}/${svc}"
            svc_perm="${PERM_DIR}/${svc}"

            echo "[svc:$svc] create dirs ${svc_dir}, ${svc_perm}"
            mkdir -p "$svc_dir" "$svc_perm" || true

            # README.md
            printf '%s\n' "# Service: ${svc}" > "${svc_dir}/README.md"
            printf '%s\n' "RUN_ID=${RUN_ID}" >> "${svc_dir}/README.md"

            # status.log
            printf '%s\n' "[INIT] $(date '+%Y-%m-%d %H:%M:%S%z') run=${RUN_ID} service=${svc} created" > "${svc_dir}/status.log"

            # permissions.txt
            {
              printf '%s\n' "[PERMISSIONS]"
              printf '%s\n' "service=${svc}"
              printf '%s\n' "owner=runner"
              printf '%s\n' "access=rw"
              printf '%s\n' "note=ìë™ ìƒì„±ëœ ê¶Œí•œ/ì ‘ê·¼ ì œì–´ í…œí”Œë¦¿"
              printf '%s\n' "run_id=${RUN_ID}"
            } > "${svc_perm}/permissions.txt"

            # ê¶Œí•œ (ì—ëŸ¬ ë¬´ì‹œ)
            chmod 600 "${svc_perm}/permissions.txt" || true
            chmod 640 "${svc_dir}/status.log" || true
            chmod 644 "${svc_dir}/README.md" || true

            echo "[svc:$svc] files created + chmod applied (RUN_ID=${RUN_ID})" | tee -a "${LOG_DIR}/svc.init.log"
          done
          echo ">>> [svc] done" | tee -a "${LOG_DIR}/svc.init.log"

      ##################################################################
      # 3. DR ì„¼í„° / ISO ë¹Œë” í…œí”Œë¦¿ ìƒì„±
      #    - dr_backup_plan.txt + iso_manifest.txt
      #    - status.log ì— append
      #    - ë¬´ê²°ì„± ê¸°ë¡(wc/sha256sum)
      ##################################################################
      - name: "[svc] DR / ISO templates (with integrity hash)"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo ">>> [dr+iso] start"

          dr_dir="${SERVICE_DIR}/dr_center"
          iso_dir="${SERVICE_DIR}/iso_builder"

          # DR ë°±ì—… í”Œëœ
          {
            printf '%s\n' "[DR_BACKUP_PLAN]"
            printf '%s\n' "run_id=${RUN_ID}"
            printf '%s\n' "retention_days=1"
            printf '%s\n' "description=í•˜ë£¨ ë‹¨ìœ„ DR ë°ì´í„°ì„¼í„° ë³´ê´€ ì •ì±…"
            printf '%s\n' "snapshot_policy=nightly+on-demand"
          } > "${dr_dir}/dr_backup_plan.txt"

          # ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸
          {
            printf '%s\n' "[ISO_MANIFEST]"
            printf '%s\n' "run_id=${RUN_ID}"
            printf '%s\n' "image_name=finops-snapshot.iso"
            printf '%s\n' "includes=logs,configs,sql,artifacts"
            printf '%s\n' "note=ì´ íŒŒì¼ì€ ISO ì´ë¯¸ì§€ì— í¬í•¨í•  ìì›ì„ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿ì…ë‹ˆë‹¤."
          } > "${iso_dir}/iso_manifest.txt"

          chmod 640 "${dr_dir}/dr_backup_plan.txt" || true
          chmod 640 "${iso_dir}/iso_manifest.txt" || true

          # status.log append (DR/ISO ì´ˆê¸°í™” ê¸°ë¡)
          printf '\n%s\n' "[DR_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') run=${RUN_ID} backup plan prepared" >> "${dr_dir}/status.log"  || true
          printf '\n%s\n' "[ISO_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') run=${RUN_ID} iso manifest prepared"  >> "${iso_dir}/status.log" || true

          # ë¬´ê²°ì„± ê¸°ë¡: íŒŒì¼ í¬ê¸°ì™€ sha256
          echo "--- integrity check ---" | tee -a "${LOG_DIR}/dr_iso.init.log"
          wc -c "${dr_dir}/dr_backup_plan.txt" "${iso_dir}/iso_manifest.txt" | tee -a "${LOG_DIR}/dr_iso.init.log" || true
          sha256sum "${dr_dir}/dr_backup_plan.txt" "${iso_dir}/iso_manifest.txt" | tee -a "${LOG_DIR}/dr_iso.init.log" || true

          echo ">>> [dr+iso] done" | tee -a "${LOG_DIR}/dr_iso.init.log"

      ##################################################################
      # 4. í™˜ê²½/ê¶Œí•œ ìŠ¤ëƒ…ìƒ·
      #    - df -h, uname, env | sort
      #    - ë””ë ‰í† ë¦¬ í¼ë¯¸ì…˜ / GitHub ì»¨í…ìŠ¤íŠ¸(actor, repo, ref, sha ë“±)
      ##################################################################
      - name: "[snap] Environment & permissions snapshot"
        env:
            LOG_DIR: ${{ env.LOG_DIR }}
            SERVICE_DIR: ${{ env.SERVICE_DIR }}
            ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
            PERM_DIR: ${{ env.PERM_DIR }}
        run: |
          echo ">>> [snap] start"
          {
            echo "===== ENV SNAPSHOT ====="
            date
            uname -a
            echo "--- df -h ---"
            df -h
            echo "--- env | sort ---"
            env | sort
            echo "--- permissions check (top dirs) ---"
            ls -ld "${LOG_DIR}" "${ARTIFACT_DIR}" "${SERVICE_DIR}" "${PERM_DIR}"
            echo "--- service tree depth 2 (mode/owner/group) ---"
            find "${SERVICE_DIR}" -maxdepth 2 -type f -printf "%M %u %g %p\n" 2>/dev/null
            echo "--- GitHub Context ---"
            echo "actor=${{ github.actor }}"
            echo "repo=${{ github.repository }}"
            echo "ref=${{ github.ref }}"
            echo "sha=${{ github.sha }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
          } | tee "${LOG_DIR}/env_snapshot.log"
          echo ">>> [snap] done" | tee -a "${LOG_DIR}/env_snapshot.log"

      ##################################################################
      # 5. ì™¸ë¶€ API í˜¸ì¶œ (Anthropic Claude messages)
      #
      #  - run_mode=lite ì´ë©´ curl ìŠ¤í‚µ (ë¹„ìš©/ë„¤íŠ¸ì›Œí¬ ì—†ëŠ” ëŸ¬ë„ˆ ëŒ€ë¹„)
      #  - request_body.json ì€ printfë¡œ ìƒì„±
      #  - curlì€ continue-on-error=true ë¼ì„œ ì‹¤íŒ¨í•´ë„ íŒŒì´í”„ë¼ì¸ ê³„ì†
      #  - status_code / headers / body / usage ì¶”ì¶œ / result_summary ê¸°ë¡
      #  - claude_api/status.log ì—ë„ ë‚¨ê¹€
      #
      ##################################################################
      - name: "[api] Curl call Anthropic Claude messages API (Echo Safe / run_mode aware)"
        continue-on-error: true
        env:
          INPUT_URL: ${{ github.event.inputs.target_url }}
          RUN_MODE: ${{ github.event.inputs.run_mode }}
          SECR_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LOG_DIR: ${{ env.LOG_DIR }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo ">>> [api] start (run_mode=${RUN_MODE}, RUN_ID=${RUN_ID})"

          # run_mode=lite ì´ë©´ ì‹¤ì œ ì™¸ë¶€ í˜¸ì¶œì„ ìŠ¤í‚µí•œë‹¤.
          if [ "${RUN_MODE}" = "lite" ]; then
            echo "[api] run_mode=lite -> skipping external curl call" | tee -a "${LOG_DIR}/curl_init.log"

            RESP_DIR="${LOG_DIR}/curl_response"
            mkdir -p "${RESP_DIR}"

            # placeholder ê²°ê³¼ íŒŒì¼ë“¤ ìƒì„± (ë¹ˆ ê°’, N/A ë“±)
            printf '%s\n' "N/A" > "${RESP_DIR}/status_code.txt"
            printf '%s\n' "[lite mode: no request performed]" > "${RESP_DIR}/headers.txt"
            printf '%s\n' '{"lite_mode": true, "note": "no external call performed"}' > "${RESP_DIR}/body.json"
            printf '%s\n' "[api] usage not available in lite mode" > "${RESP_DIR}/usage.log"

            svc_status="${SERVICE_DIR}/claude_api/status.log"
            {
              printf '\n%s\n' "[CALL] $(date '+%Y-%m-%d %H:%M:%S%z') run=${RUN_ID}"
              printf '%s\n' "status_code=N/A"
              printf '%s\n' "result_summary=SKIPPED_LITE_MODE"
              printf '%s\n' "note=No external network call due to lite mode"
            } >> "${svc_status}" || true

            echo ">>> [api] done (lite mode, no curl)" | tee -a "${LOG_DIR}/curl_init.log"
            exit 0
          fi

          # full ëª¨ë“œì¼ ê²½ìš° ì‹¤ì œ í˜¸ì¶œ ì§„í–‰
          TARGET_URL="${INPUT_URL}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="https://api.anthropic.com/v1/messages"
          fi

          echo "[api] TARGET_URL=${TARGET_URL}" | tee -a "${LOG_DIR}/curl_init.log"

          REQ_DIR="${LOG_DIR}/curl_request"
          RESP_DIR="${LOG_DIR}/curl_response"
          mkdir -p "$REQ_DIR" "$RESP_DIR"

          # ìš”ì²­ ë°”ë”” JSON ì‘ì„±
          {
            printf '%s\n' '{'
            printf '%s\n' '  "model": "claude-3-opus-20240229",'
            printf '%s\n' '  "max_tokens": 64,'
            printf '%s\n' '  "messages": ['
            printf '%s\n' '    { "role": "user", "content": "ì•ˆë…•, ì‚¬ìš©ëŸ‰ usage í•„ë“œ ë³´ì—¬ì¤˜." }'
            printf '%s\n' '  ]'
            printf '%s\n' '}'
          } > "${REQ_DIR}/request_body.json"

          echo "[api] request_body.json created" | tee -a "${LOG_DIR}/curl_init.log"

          status_file="${RESP_DIR}/status_code.txt"
          body_file="${RESP_DIR}/body.json"
          header_file="${RESP_DIR}/headers.txt"
          usage_log="${RESP_DIR}/usage.log"

          # í‚¤ ì¡´ì¬ ì—¬ë¶€(ê¸¸ì´ë§Œ ê¸°ë¡) â†’ ë³´ì•ˆ ê°ì‚¬ìš©
          if [ -n "${SECR_KEY}" ]; then
            key_len=${#SECR_KEY}
            echo "[api] secret key present (length=${key_len})" | tee -a "${LOG_DIR}/curl_init.log"
          else
            echo "[api] WARNING: secret key missing" | tee -a "${LOG_DIR}/curl_init.log"
          fi

          echo "[api] curl POST ${TARGET_URL}"        | tee -a "${LOG_DIR}/curl_init.log"
          echo "[api] headers: Content-Type, anthropic-version, x-api-key(masked)" | tee -a "${LOG_DIR}/curl_init.log"

          curl -sS -X POST "${TARGET_URL}" \
            -H "Content-Type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            -H "x-api-key: ${SECR_KEY}" \
            -D "${header_file}" \
            --data @"${REQ_DIR}/request_body.json" \
            -o "${body_file}" \
            --write-out "%{http_code}" > "${status_file}"

          echo "[api] curl done." | tee -a "${LOG_DIR}/curl_init.log"

          echo "[api] status code:" | tee -a "${LOG_DIR}/curl_init.log"
          cat "${status_file}"      | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] headers (first lines):" | tee -a "${LOG_DIR}/curl_init.log"
          head -n 20 "${header_file}"         | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] body (first 500 chars):" | tee -a "${LOG_DIR}/curl_init.log"
          head -c 500 "${body_file}"           | tee -a "${LOG_DIR}/curl_init.log" || true
          echo ""                              | tee -a "${LOG_DIR}/curl_init.log"

          # usage í•„ë“œ ì¶”ì¶œ ì‹œë„
          printf '%s\n' "[api] extracting usage best-effort" | tee "${usage_log}"
          grep -E '"usage"|input_tokens|output_tokens' "${body_file}" >> "${usage_log}" 2>/dev/null || true

          # status code ê¸°ë°˜ ê²°ê³¼ ìš”ì•½
          code="$(cat "${status_file}" 2>/dev/null || echo 'N/A')"
          summary="unknown"
          if [ "$code" = "200" ]; then
            summary="OK-response"
          elif [ "$code" = "401" ]; then
            summary="AUTH-FAIL (check x-api-key)"
          elif [ "$code" = "429" ]; then
            summary="RATE-LIMIT or QUOTA"
          elif [ "$code" = "N/A" ]; then
            summary="NO-RESPONSE (network/timeout?)"
          fi

          echo "[api] result_summary=${summary}" | tee -a "${LOG_DIR}/curl_init.log"

          # claude_api/status.log ì— í˜¸ì¶œ ê²°ê³¼ append
          svc_status="${SERVICE_DIR}/claude_api/status.log"
          {
            printf '\n%s\n' "[CALL] $(date '+%Y-%m-%d %H:%M:%S%z') run=${RUN_ID}"
            printf '%s%s\n' "status_code=" "$code"
            printf '%s\n' "result_summary=${summary}"
            printf '%s\n' "note=See curl_response/ for details"
          } >> "${svc_status}" || true

          # ë¯¼ê° ë¡œê·¸ ìµœì†Œ ê¶Œí•œ
          chmod 600 "${status_file}" "${header_file}" "${body_file}" "${usage_log}" 2>/dev/null || true

          echo ">>> [api] done" | tee -a "${LOG_DIR}/curl_init.log"

      ##################################################################
      # 6. ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ & index.md ë¦¬í¬íŠ¸ ìƒì„±
      #
      # - echo_services, echo_perm, echo_logs, echo_artifacts ì „ì²´ ì—…ë¡œë“œ ì¤€ë¹„
      # - index.md ìƒì„±:
      #   - ì‹¤í–‰ ìš”ì•½ (RUN_ID, run_mode ë“±)
      #   - DR ì •ì±…, ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í•µì‹¬ ë‚´ìš©
      #   - API í˜¸ì¶œ ìƒíƒœ ì½”ë“œ / result_summary
      #   - ë³µêµ¬ ì ˆì°¨(Recovery Hints)
      ##################################################################
      - name: "[collect] Prepare artifacts + index.md"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
          RUN_ID: ${{ env.RUN_ID }}
          RUN_MODE: ${{ github.event.inputs.run_mode }}
          INPUT_URL: ${{ github.event.inputs.target_url }}
        run: |
          echo ">>> [collect] start"

          mkdir -p "${ARTIFACT_DIR}/services" "${ARTIFACT_DIR}/permissions" || true
          cp -r "${SERVICE_DIR}/."     "${ARTIFACT_DIR}/services/"     || true
          cp -r "${PERM_DIR}/."        "${ARTIFACT_DIR}/permissions/"  || true

          RESP_DIR="${LOG_DIR}/curl_response"
          status_file="${RESP_DIR}/status_code.txt"
          usage_log="${RESP_DIR}/usage.log"

          # status_code / result_summary ê°€ì ¸ì˜¤ê¸°
          STATUS_CODE="N/A"
          [ -f "${status_file}" ] && STATUS_CODE="$(cat "${status_file}" 2>/dev/null || echo 'N/A')"

          RESULT_SUMMARY_LINE=$(grep -E "result_summary=" "${SERVICE_DIR}/claude_api/status.log" | tail -n 1 | sed 's/.*result_summary=//')
          if [ -z "$RESULT_SUMMARY_LINE" ]; then
            RESULT_SUMMARY_LINE="(no-summary)"
          fi

          # TARGET_URL ìµœì¢… ê¸°ë¡(ì—†ìœ¼ë©´ ê¸°ë³¸)
          TARGET_URL="${INPUT_URL}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="https://api.anthropic.com/v1/messages"
          fi

          report_file="${ARTIFACT_DIR}/index.md"
          {
            echo "# Execution Report"
            echo ""
            echo "## Run Info"
            echo "- Run ID: ${RUN_ID}"
            echo "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S%z')"
            echo "- Mode: ${RUN_MODE}"
            echo "- Target URL: ${TARGET_URL}"
            echo "- GitHub Actor: ${{ github.actor }}"
            echo "- GitHub Repo:  ${{ github.repository }}"
            echo "- Git Ref:      ${{ github.ref }}"
            echo "- Git SHA:      ${{ github.sha }}"
            echo ""
            echo "## DR Center"
            echo "- retention_days=1 (1ì¼ ë³´ê´€ ì •ì±…)"
            echo "- snapshot_policy=nightly+on-demand"
            echo "- Source: .github/echo_services/dr_center/dr_backup_plan.txt"
            echo ""
            echo "## ISO Manifest"
            echo "- image_name=finops-snapshot.iso"
            echo "- includes=logs,configs,sql,artifacts"
            echo "- Source: .github/echo_services/iso_builder/iso_manifest.txt"
            echo ""
            echo "## API Call Result"
            echo "- status_code: ${STATUS_CODE}"
            echo "- result_summary: ${RESULT_SUMMARY_LINE}"
            echo "- usage info: see curl_response/usage.log (tokens ë“±)"
            echo "- NOTE: run_mode=lite ì¸ ê²½ìš° ì‹¤ì œ ì™¸ë¶€ í˜¸ì¶œì€ ìŠ¤í‚µë¨"
            echo ""
            echo "## Recovery Hints"
            echo "1. Create service directories (see services/)."
            echo "2. Reapply permissions from permissions/ (chmod 600 etc.)."
            echo "3. Apply DR plan from dr_center/dr_backup_plan.txt."
            echo "4. Build ISO using iso_builder/iso_manifest.txt as include list."
            echo "5. Re-run external API connectivity using a valid key (if needed)."
            echo ""
            echo "## Integrity / Audit"
            echo "- env_snapshot.log: runner í™˜ê²½, ë””ìŠ¤í¬ ìƒíƒœ, GitHub ì»¨í…ìŠ¤íŠ¸(actor/ref/sha)."
            echo "- dr_iso.init.log: DR/ISO íŒŒì¼ í¬ê¸° ë° sha256 ë¬´ê²°ì„± ê¸°ë¡."
            echo "- curl_init.log: API í˜¸ì¶œ í—¤ë”/ìƒíƒœ/ì‘ë‹µ ì•ë¶€ë¶„ ë° result_summary ê¸°ë¡."
          } > "$report_file"

          chmod 644 "$report_file" || true

          echo ">>> listing ${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          ls -R "${ARTIFACT_DIR}"     | tee -a "${LOG_DIR}/artifact.bundle.log"
          echo ">>> [collect] done"   | tee -a "${LOG_DIR}/artifact.bundle.log"

      ##################################################################
      # 7. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      ##################################################################
      - name: "[artifact] Upload logs + services + perms + report"
        uses: actions/upload-artifact@v4
        with:
          name: api-curl-test-server-logs-and-services
          path: |
            .github/echo_logs
            .github/echo_artifacts
            .github/echo_services
            .github/echo_perm
          if-no-files-found: warn
          retention-days: 7

      ##################################################################
      # 8. ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸ (í•­ìƒ ì„±ê³µ ì„ ì–¸)
      #    - curl ë‹¨ê³„ëŠ” continue-on-error: true ì´ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ ì—¬ê¸° ë„ë‹¬
      ##################################################################
      - name: "[final] Overall status (ALWAYS-SUCCESS)"
        run: |
          echo "âœ… [FINAL] API Curl Test Server workflow finished."
          echo "   - ëª¨ë“  ë‹¨ê³„ echo ë¡œê¹… ë° RUN_ID=${RUN_ID} ë¡œ ì¶”ì  ê°€ëŠ¥í•˜ê²Œ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤."
          echo "   - run_mode=${{ github.event.inputs.run_mode }}: lite ëª¨ë“œë©´ ì™¸ë¶€ curl ì™„ì „íˆ ìŠ¤í‚µí•©ë‹ˆë‹¤."
          echo "   - Anthropic Claude ì •ì‹ ì—”ë“œí¬ì¸íŠ¸(${{ github.event.inputs.target_url }}) ê¸°ì¤€ í˜¸ì¶œ ë¡œì§ í¬í•¨."
          echo "   - x-api-key / anthropic-version / Content-Type í—¤ë”ë¥¼ í¬í•¨í•´ POST í˜¸ì¶œì„ ìˆ˜í–‰(ë˜ëŠ” liteë©´ skip)."
          echo "   - status_code / result_summaryë¥¼ claude_api/status.logì™€ index.mdì— ë‚¨ê²¼ìŠµë‹ˆë‹¤."
          echo "   - usage(í† í° ì†Œë¹„)ëŠ” body.jsonì—ì„œ grepí•´ usage.logë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤."
          echo "   - ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬(.github/echo_services/*)ì™€ ê¶Œí•œ íŒŒì¼(.github/echo_perm/*/permissions.txt)ì„ ìƒì„±í–ˆê³  chmod ì ìš©í–ˆìŠµë‹ˆë‹¤."
          echo "   - DR ë°±ì—… ê³„íš(dr_backup_plan.txt), ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸(iso_manifest.txt) ìƒì„± í›„ sha256 / wc -c ë¬´ê²°ì„±ê¹Œì§€ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤."
          echo "   - env_snapshot.logì— ë””ìŠ¤í¬/ê¶Œí•œìƒíƒœ, GitHub actor/ref/shaê¹Œì§€ ë‚¨ê²¨ ê°ì‚¬/ì¬í•´ë³µêµ¬ ì¦ì ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤."
          echo "   - index.md(Execution Report + Recovery Hints)ë¥¼ ì•„í‹°íŒ©íŠ¸ì— í¬í•¨ì‹œì¼œ DR ë³µêµ¬ ìˆœì„œë¥¼ ë°”ë¡œ ë³¼ ìˆ˜ ìˆê²Œ í–ˆìŠµë‹ˆë‹¤."
          echo "   - ë§ˆì§€ë§‰ ë‹¨ê³„ëŠ” í•­ìƒ ì„±ê³µìœ¼ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
          echo "DONE."
