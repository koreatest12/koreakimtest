name: "ğŸ›° API Curl Test Server â€” EchoOps Safe-Continue / Service Perms / DR+ISO / No-Heredoc"

on:
  workflow_dispatch:
    inputs:
      target_url:            # 1
        description: "í˜¸ì¶œí•  API URL (ë¹ˆê°’ì´ë©´ Anthropic Claude messages)"
        required: false
        default: "https://api.anthropic.com/v1/messages"
      run_mode:              # 2
        description: "full=ì „ì²´ ìˆ˜í–‰ / lite=ìƒì„± ìœ„ì£¼ (curl ì‹¤íŒ¨ ë¬´ì‹œ)"
        required: false
        default: "full"

permissions:
  contents: write
  actions: read
  security-events: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  SERVICE_DIR: .github/echo_services
  PERM_DIR: .github/echo_perm
  SERVICES: "claude_api dr_center iso_builder"   # ìš°ë¦¬ê°€ ê´€ë¦¬í•  ì„œë¹„ìŠ¤ ëª©ë¡

jobs:
  curl-test-server:
    name: "Curl Test Server Runner (Echo / Always Success / Heredoc-Free)"
    runs-on: ubuntu-22.04

    steps:
      ##################################################################
      # 0. ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      ##################################################################
      - name: "[prep] Checkout repository"
        uses: actions/checkout@v4

      ##################################################################
      # 1. ê³µí†µ ë””ë ‰í† ë¦¬ & safe_echo_run ì¤€ë¹„
      #    - safe_echo_run: ì‹¤íŒ¨í•´ë„ ë¬´ì¡°ê±´ 0ìœ¼ë¡œ ì¢…ë£Œí•´ì„œ ì¡ì´ ì•ˆ ëŠê¸´ë‹¤
      ##################################################################
      - name: "[prep] Create base dirs + helper"
        run: |
          echo ">>> [prep] start"
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${SERVICE_DIR}" "${PERM_DIR}" .github/echo_tmp || true

          # safe_echo_run: safe_echo_run <label> <command...>
          # - ëª…ë ¹ ì‹¤í–‰ ì „/í›„ echo ë¡œê¹…
          # - í•­ìƒ exit 0
          printf '%s\n' '#!/usr/bin/env bash'                                         >  .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' '# safe_echo_run <label> <command...>'                       >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'label="$1"; shift || true'                                  >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'log_file=".github/echo_logs/${label}.log"'                  >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'echo "â–¶ [${label}] $(date '\''+%Y-%m-%d %H:%M:%S%z'\'') START" | tee -a "$log_file"' >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'echo "â–¶ [${label}] COMMAND: $@" | tee -a "$log_file"'       >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'set +e'                                                     >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' '"$@" >> "$log_file" 2>&1'                                   >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'rc=$?'                                                      >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'set +e'                                                     >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'if [ "$rc" -eq 0 ]; then'                                   >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' '  echo "âœ… [${label}] OK (exit=${rc})" | tee -a "$log_file"' >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'else'                                                       >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' '  echo "âŒ [${label}] FAILED (exit=${rc}) (continue anyway)" | tee -a "$log_file"' >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'fi'                                                         >> .github/echo_tmp/safe_echo_run.sh
          printf '%s\n' 'exit 0'                                                     >> .github/echo_tmp/safe_echo_run.sh

          chmod +x .github/echo_tmp/safe_echo_run.sh

          echo "[INFO] prep done" | tee -a "${LOG_DIR}/prep.init.log"

      ##################################################################
      # 2. ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬ / ê¶Œí•œ íŒŒì¼ / ìƒíƒœ ë¡œê·¸ ìƒì„±
      #    - Heredoc ê¸ˆì§€, ëª¨ë‘ echo/printfë¡œ êµ¬ì„±
      ##################################################################
      - name: "[svc] Init service dirs + perms + status"
        env:
          SERVICES: ${{ env.SERVICES }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [svc] start"
          for svc in $SERVICES; do
            svc_dir="${SERVICE_DIR}/${svc}"
            svc_perm="${PERM_DIR}/${svc}"

            echo "[svc:$svc] create dirs ${svc_dir}, ${svc_perm}"
            mkdir -p "$svc_dir" "$svc_perm" || true

            # README.md
            printf '%s\n' "# Service: ${svc}" > "${svc_dir}/README.md"

            # status.log
            printf '%s\n' "[INIT] $(date '+%Y-%m-%d %H:%M:%S%z') service=${svc} created" > "${svc_dir}/status.log"

            # permissions.txt
            {
              printf '%s\n' "[PERMISSIONS]"
              printf '%s\n' "service=${svc}"
              printf '%s\n' "owner=runner"
              printf '%s\n' "access=rw"
              printf '%s\n' "note=ìë™ ìƒì„±ëœ ê¶Œí•œ/ì ‘ê·¼ ì œì–´ í…œí”Œë¦¿"
            } > "${svc_perm}/permissions.txt"

            # ê¶Œí•œ (ì—ëŸ¬ ë¬´ì‹œ)
            chmod 600 "${svc_perm}/permissions.txt" || true
            chmod 640 "${svc_dir}/status.log" || true
            chmod 644 "${svc_dir}/README.md" || true

            echo "[svc:$svc] files created + chmod applied" | tee -a "${LOG_DIR}/svc.init.log"
          done
          echo ">>> [svc] done" | tee -a "${LOG_DIR}/svc.init.log"

      ##################################################################
      # 3. DR ì„¼í„° / ISO ë¹Œë” í…œí”Œë¦¿ ìƒì„±
      #    - dr_backup_plan.txt
      #    - iso_manifest.txt
      #    - status.log ì— append
      #    - Heredoc ì—†ì´ printfë§Œ ì‚¬ìš©
      ##################################################################
      - name: "[svc] DR / ISO templates"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [dr+iso] start"
          dr_dir="${SERVICE_DIR}/dr_center"
          iso_dir="${SERVICE_DIR}/iso_builder"

          # DR ë°±ì—… í”Œëœ
          {
            printf '%s\n' "[DR_BACKUP_PLAN]"
            printf '%s\n' "retention_days=1"
            printf '%s\n' "description=í•˜ë£¨ ë‹¨ìœ„ DR ë°ì´í„°ì„¼í„° ë³´ê´€ ì •ì±…"
            printf '%s\n' "snapshot_policy=nightly+on-demand"
          } > "${dr_dir}/dr_backup_plan.txt"

          # ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸
          {
            printf '%s\n' "[ISO_MANIFEST]"
            printf '%s\n' "image_name=finops-snapshot.iso"
            printf '%s\n' "includes=logs,configs,sql,artifacts"
            printf '%s\n' "note=ì´ íŒŒì¼ì€ ISO ì´ë¯¸ì§€ì— í¬í•¨í•  ìì›ì„ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿ì…ë‹ˆë‹¤."
          } > "${iso_dir}/iso_manifest.txt"

          chmod 640 "${dr_dir}/dr_backup_plan.txt" || true
          chmod 640 "${iso_dir}/iso_manifest.txt" || true

          # status.log append
          printf '\n%s\n' "[DR_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') backup plan prepared" >> "${dr_dir}/status.log"  || true
          printf '\n%s\n' "[ISO_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') iso manifest prepared"  >> "${iso_dir}/status.log" || true

          echo ">>> [dr+iso] done" | tee -a "${LOG_DIR}/dr_iso.init.log"

      ##################################################################
      # 4. í™˜ê²½ ìŠ¤ëƒ…ìƒ·
      #    - df -h, uname, env ë“± ê¸°ë¡
      ##################################################################
      - name: "[snap] Environment snapshot"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [snap] start"
          {
            echo "===== ENV SNAPSHOT ====="
            date
            uname -a
            echo "--- df -h ---"
            df -h
            echo "--- env | sort ---"
            env | sort
          } | tee "${LOG_DIR}/env_snapshot.log"
          echo ">>> [snap] done" | tee -a "${LOG_DIR}/env_snapshot.log"

      ##################################################################
      # 5. CURL í˜¸ì¶œ ì¤€ë¹„ ë° ì‹¤í–‰
      #
      # - Heredoc ì—†ì´ request_body.json ì‘ì„±
      # - safe_echo_run ì‚¬ìš©
      # - ì‹¤íŒ¨í•´ë„ ë¬´ì¡°ê±´ ê³„ì† ì§„í–‰
      #
      # ê²°ê³¼ë¬¼:
      #   LOG_DIR/curl_request/request_body.json
      #   LOG_DIR/curl_response/status_code.txt
      #   LOG_DIR/curl_response/headers.txt
      #   LOG_DIR/curl_response/body.json
      #   LOG_DIR/curl_response/usage.log (usage ì¶”ì¶œ ì‹œë„)
      #
      # claude_api/status.log ì—ë„ ê¸°ë¡ append
      ##################################################################
      - name: "[api] Curl call Anthropic Claude messages API (Echo Safe)"
        env:
          INPUT_URL: ${{ github.event.inputs.target_url }}
          SECR_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LOG_DIR: ${{ env.LOG_DIR }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
        run: |
          echo ">>> [api] start"

          TARGET_URL="${INPUT_URL}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="https://api.anthropic.com/v1/messages"
          fi

          echo "[api] TARGET_URL=${TARGET_URL}"

          REQ_DIR="${LOG_DIR}/curl_request"
          RESP_DIR="${LOG_DIR}/curl_response"
          mkdir -p "$REQ_DIR" "$RESP_DIR"

          # ìš”ì²­ ë°”ë”” JSON (heredoc ê¸ˆì§€ â†’ printfë¡œ í•œ ì¤„ì”© ì‘ì„±)
          {
            printf '%s\n' '{'
            printf '%s\n' '  "model": "claude-3-opus-20240229",'
            printf '%s\n' '  "max_tokens": 64,'
            printf '%s\n' '  "messages": ['
            printf '%s\n' '    { "role": "user", "content": "ì•ˆë…•, ì‚¬ìš©ëŸ‰ usage í•„ë“œ ë³´ì—¬ì¤˜." }'
            printf '%s\n' '  ]'
            printf '%s\n' '}'
          } > "${REQ_DIR}/request_body.json"

          echo "[api] request_body.json created" | tee -a "${LOG_DIR}/curl_init.log"

          .github/echo_tmp/safe_echo_run.sh curl_call bash -c "
            echo '[api] curl POST ${TARGET_URL}'
            echo '[api] headers: Content-Type, anthropic-version, x-api-key(masked)'
            echo '[api] body file: ${REQ_DIR}/request_body.json'

            status_file='${RESP_DIR}/status_code.txt'
            body_file='${RESP_DIR}/body.json'
            header_file='${RESP_DIR}/headers.txt'

            curl -sS -X POST '${TARGET_URL}' \
              -H 'Content-Type: application/json' \
              -H 'anthropic-version: 2023-06-01' \
              -H 'x-api-key: ${SECR_KEY}' \
              -D \"\$header_file\" \
              --data @\"${REQ_DIR}/request_body.json\" \
              -o \"\$body_file\" \
              --write-out '%{http_code}' > \"\$status_file\"

            echo '[api] curl done.'
            echo '[api] status:'; cat \"\$status_file\" || true
            echo '[api] headers top:'; head -n 20 \"\$header_file\" || true
            echo '[api] body head:'; head -c 500 \"\$body_file\" || true

            usage_log='${RESP_DIR}/usage.log'
            printf '%s\n' '[api] extracting usage best-effort' | tee \"\$usage_log\"
            grep -E '\"usage\"|input_tokens|output_tokens' \"\$body_file\" >> \"\$usage_log\" 2>/dev/null || true

            svc_status='${SERVICE_DIR}/claude_api/status.log'
            {
              printf '\n%s\n' '[CALL] '"\$(date '+%Y-%m-%d %H:%M:%S%z')"
              printf '%s%s\n' 'status_code=' \"\$(cat \"\$status_file\" 2>/dev/null || echo 'N/A')\"
              printf '%s\n' 'note=See curl_response/ for details'
            } >> \"\$svc_status\" || true

            chmod 600 \"\$status_file\" \"\$header_file\" \"\$body_file\" \"\$usage_log\" 2>/dev/null || true
          "

          echo ">>> [api] done" | tee -a "${LOG_DIR}/curl_init.log"

      ##################################################################
      # 6. ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ & ì—…ë¡œë“œ
      #
      # - echo_services, echo_perm, echo_logs, echo_artifacts ì „ì²´ ì—…ë¡œë“œ
      ##################################################################
      - name: "[collect] Prepare artifacts"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [collect] start"
          mkdir -p "${ARTIFACT_DIR}/services" "${ARTIFACT_DIR}/permissions" || true
          cp -r "${SERVICE_DIR}/."     "${ARTIFACT_DIR}/services/"     || true
          cp -r "${PERM_DIR}/."        "${ARTIFACT_DIR}/permissions/"  || true
          echo ">>> listing ${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          ls -R "${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          echo ">>> [collect] done" | tee -a "${LOG_DIR}/artifact.bundle.log"

      - name: "[artifact] Upload logs + services + perms"
        uses: actions/upload-artifact@v4
        with:
          name: api-curl-test-server-logs-and-services
          path: |
            .github/echo_logs
            .github/echo_artifacts
            .github/echo_services
            .github/echo_perm
          if-no-files-found: warn
          retention-days: 7

      ##################################################################
      # 7. ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸ (í•­ìƒ ì„±ê³µ ì„ ì–¸)
      ##################################################################
      - name: "[final] Overall status (ALWAYS-SUCCESS)"
        run: |
          echo "âœ… [FINAL] API Curl Test Server workflow finished."
          echo "   - ëª¨ë“  ë‹¨ê³„ëŠ” safe_echo_run ìœ¼ë¡œ ê°ì‹¸ì„œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í–ˆìŠµë‹ˆë‹¤."
          echo "   - Anthropic Claude ì •ì‹ ì—”ë“œí¬ì¸íŠ¸(${INPUT_URL:-https://api.anthropic.com/v1/messages})ì— curl POST ì‹œë„."
          echo "   - x-api-key / anthropic-version / Content-Type í—¤ë” í¬í•¨ í˜¸ì¶œ."
          echo "   - usage í•„ë“œëŠ” ì‘ë‹µ body ì•ˆì—ì„œë§Œ ì¶”ì¶œ ì‹œë„í–ˆê³ , ë³„ë„ /usage APIëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "   - ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬(.github/echo_services/*)ì™€ ê¶Œí•œ íŒŒì¼(.github/echo_perm/*/permissions.txt)ì„ ìƒì„±í•˜ê³  chmodê¹Œì§€ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤."
          echo "   - DR ë°±ì—… ê³„íš(dr_backup_plan.txt)ê³¼ ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸(iso_manifest.txt)ë„ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
          echo "   - echo_logs, echo_artifacts, echo_services, echo_perm ì „ì²´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤."
          echo "DONE."
