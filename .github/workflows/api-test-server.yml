name: "ðŸ” Secure Superflow â€” No-Skip + ECHO (CodeQL+Dep+Package+Release)"

on:
  schedule:
    - cron: "0 3 * * 1"    # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_mode:             # 1
        description: "full=ëª¨ë‘ ìˆ˜í–‰ / lite=ë¦´ë¦¬ì¦ˆ ìƒëžµ"
        type: choice
        options: [full, lite]
        default: full
      boot_if_missing:      # 2
        description: "ëŒ€ìƒ í´ë”ì— í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ìžë™ ìƒì„±(ìŠ¤í‚µ ë°©ì§€)"
        type: boolean
        default: true
      node_version:         # 3
        description: "Node.js version"
        default: "20"
      py_version:           # 4
        description: "Python version"
        default: "3.11"

# ìµœì†Œ ê¶Œí•œ(ê²½ê³  ë°©ì§€). Jobì—ì„œ í•„ìš”í•œ ê¶Œí•œë§Œ ìŠ¹ê²©
permissions:
  contents: read
  security-events: read
  actions: read

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts
  SNAP_DIR: .github/sec_report/snapshots
  NODE_PROJECTS: "anthropic-cost-tracker/nodejs mcp-hello-js mcp-fs"
  PY_PROJECTS: "anthropic-cost-tracker/python mcp-hello-py mcp-python-server mcp-apache-server ."
  ECHO_OK: "âœ…"
  ECHO_WARN: "âš ï¸"
  ECHO_FAIL: "âŒ"

concurrency:
  group: secure-superflow-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 0) ê³µí†µ ì¤€ë¹„ + ìŠ¤í‚µ ë°©ì§€ ë¶€íŠ¸ìŠ¤íŠ¸ëž©(ëª¨ë‘ echoë¡œ ë¡œê¹…)
  prepare:
    name: "Prepare & Bootstrap (No-Skip + Echo)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare dirs & helper (echo functions)
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}" "${SNAP_DIR}"
          HELPER="${REPORT_DIR}/helpers.sh"
          {
            echo '#!/usr/bin/env bash'
            echo 'set -Eeuo pipefail'
            echo 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"'
            echo 'ts(){ date "+%Y-%m-%d %H:%M:%S%z"; }'
            echo 'safe_run(){ local l="$1";shift||true; local f="${LOG_BASE}/${l}.log"; echo "â–¶ [$l] $(ts)" | tee -a "$f"; if "$@" >>"$f" 2>&1; then echo "'"$ECHO_OK"' [$l] OK" | tee -a "$f"; else rc=$?; echo "'"$ECHO_FAIL"' [$l] FAIL exit=$rc" | tee -a "$f"; return $rc; fi; }'
            echo 'apt_fix(){ local f="${LOG_BASE}/apt.fix.log"; echo "[fix] apt_fix start $(ts)" | tee -a "$f"; sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true; sudo dpkg --configure -a || true; (sudo apt-get update -y || true) >/dev/null 2>&1; }'
            echo 'echo_line(){ # echo_line <file> <text...>'
            echo '  local file="$1"; shift || true'
            echo '  mkdir -p "$(dirname "$file")"'
            echo '  printf "%s\n" "$*" >> "$file"'
            echo '  printf "%s | %s\n" "$(ts)" "$*" >> "${LOG_BASE}/echo.write.log"'
            echo '}'
            echo 'echo_file(){ # echo_file <file> <marker>'
            echo '  local file="$1"; local marker="$2"'
            echo '  printf "%s\n" "----- BEGIN ${marker} $(ts) -----" | tee -a "${LOG_BASE}/echo.write.log"'
            echo '  cat "$file" | sed -e "s/^/[${marker}] /" | tee -a "${LOG_BASE}/echo.write.log" >/dev/null || true'
            echo '  printf "%s\n" "-----  END  ${marker} $(ts) -----" | tee -a "${LOG_BASE}/echo.write.log"'
            echo '}'
            echo 'snap_tree(){ # snap_tree <label> <dir>'
            echo '  local label="$1"; local dir="$2"'
            echo '  local out="${SNAP_DIR}/${label}.tree.txt"'
            echo '  mkdir -p "${SNAP_DIR}"'
            echo '  {'
            echo '    echo "### SNAPSHOT: $label $(ts)"'
            echo '    echo'
            echo '    echo "$ ls -alR $dir"'
            echo '    ls -alR "$dir" || true'
            echo '    echo'
            echo '    echo "$ sha256sum of small files"'
            echo '    find "$dir" -type f -maxdepth 3 -size -512k -print0 | xargs -0 -I{} sh -c '\''sha256sum "{}" || true'\'' || true'
            echo '  } > "$out" 2>&1'
            echo '  echo "'"$ECHO_OK"' snapshot -> $out" | tee -a "${LOG_BASE}/echo.snap.log"'
            echo '}'
          } > "$HELPER"
          chmod +x "$HELPER"

      - name: Bootstrap Node projects (echo each line)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          if [[ "${{ inputs.boot_if_missing || 'true' }}" == "true" ]]; then
            for P in $NODE_PROJECTS; do
              safe_run "node.bootstrap.$(echo "$P" | tr '/' '_')" bash -c "
                mkdir -p \"$P\"
                FILE_JSON=\"$P/package.json\"
                FILE_LOCK=\"$P/package-lock.json\"
                if [ ! -f \"\$FILE_JSON\" ]; then
                  : > \"\$FILE_JSON\"
                  echo_line \"\$FILE_JSON\" '{'
                  echo_line \"\$FILE_JSON\" '  \"name\": \"placeholder-app\",'
                  echo_line \"\$FILE_JSON\" '  \"version\": \"0.0.1\",'
                  echo_line \"\$FILE_JSON\" '  \"private\": true,'
                  echo_line \"\$FILE_JSON\" '  \"license\": \"UNLICENSED\",'
                  echo_line \"\$FILE_JSON\" '  \"scripts\": { \"audit\": \"npm audit\" }'
                  echo_line \"\$FILE_JSON\" '}'
                  echo_file  \"\$FILE_JSON\"  \"package.json:$P\"
                fi
                if [ ! -f \"\$FILE_LOCK\" ]; then
                  : > \"\$FILE_LOCK\"
                  echo_line  \"\$FILE_LOCK\" '{}'
                  echo_file   \"\$FILE_LOCK\" \"package-lock.json:$P\"
                fi
              "
            done
          fi
          snap_tree "node.bootstrap" "."

      - name: Bootstrap Python projects (echo each line)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          if [[ "${{ inputs.boot_if_missing || 'true' }}" == "true" ]]; then
            for P in $PY_PROJECTS; do
              safe_run "py.bootstrap.$(echo "$P" | tr '/' '_')" bash -c "
                mkdir -p \"$P\"
                REQ=\"$P/requirements.txt\"
                PYPROJ=\"$P/pyproject.toml\"
                if [ ! -f \"\$REQ\" ]; then
                  : > \"\$REQ\"
                  echo_line \"\$REQ\" '# placeholder deps (empty ok)'
                  echo_file  \"\$REQ\"  \"requirements.txt:$P\"
                fi
                if [ ! -f \"\$PYPROJ\" ] && [ ! -f \"$P/setup.py\" ]; then
                  : > \"\$PYPROJ\"
                  echo_line \"\$PYPROJ\" '[build-system]'
                  echo_line \"\$PYPROJ\" 'requires = [\"setuptools\", \"wheel\"]'
                  echo_line \"\$PYPROJ\" 'build-backend = \"setuptools.build_meta\"'
                  echo_line \"\$PYPROJ\" '[project]'
                  echo_line \"\$PYPROJ\" 'name = \"placeholder-py\"'
                  echo_line \"\$PYPROJ\" 'version = \"0.0.1\"'
                  echo_file  \"\$PYPROJ\" \"pyproject.toml:$P\"
                fi
              "
            done
          fi
          snap_tree "python.bootstrap" "."

      - name: Upload bootstrap snapshots & echo logs
        uses: actions/upload-artifact@v5
        with:
          name: echo-bootstrap-${{ github.run_number }}
          path: |
            ${{ env.SNAP_DIR }}/
            ${{ env.LOG_DIR }}/echo*.log
          if-no-files-found: ignore
          retention-days: 30

  # 1) CodeQL â€” í•­ìƒ ì‹¤í–‰
  codeql:
    name: "CodeQL (JS+Py) â€” Always Run"
    runs-on: ubuntu-latest
    needs: [prepare]
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - name: Init
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
        continue-on-error: true
      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript;/language:python"
        continue-on-error: true

  # 2) Node ì˜ì¡´ì„± ê°ì‚¬+ìžë™ìˆ˜ì • â€” echo ë¡œê¹…
  dep-node:
    name: "Node Dep Audit+Fix â€” Echo"
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}

      - name: Ensure jq (with echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          safe_run "apt.fix" apt_fix
          safe_run "apt.install.jq" sudo apt-get install -y jq

      - name: Audit across projects (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          for P in $NODE_PROJECTS; do
            echo "::group::[node] $P"
            safe_run "node.npm.install.$(echo "$P" | tr '/' '_')" bash -c "
              cd \"$P\"
              if [ -f package-lock.json ]; then npm ci || npm install || true; else npm install || true; fi
            "
            safe_run "node.npm.audit.$(echo "$P" | tr '/' '_')" bash -c "
              cd \"$P\"
              npm audit --json > audit.json || true
              npm audit fix || true
              npm audit fix --force || true
              [ -f audit.json ] && jq '.metadata.vulnerabilities? // {}' audit.json || true
            "
            echo "::endgroup::"
          done

      - name: Upload node audit artifacts
        uses: actions/upload-artifact@v5
        with:
          name: node-audit-${{ github.run_number }}
          path: ${{ env.NODE_PROJECTS }}/**/audit.json
          if-no-files-found: ignore
          retention-days: 30

  # 3) Python ì˜ì¡´ì„± ê°ì‚¬+ìžë™ìˆ˜ì • â€” echo ë¡œê¹…
  dep-python:
    name: "Python Dep Audit+Fix â€” Echo"
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.py_version || '3.11' }}
          cache: pip
      - name: Install tools
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          safe_run "pip.upgrade" python -m pip install --upgrade pip
          safe_run "pip.install.tools" pip install pip-audit safety bandit build

      - name: Audit across projects (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          for P in $PY_PROJECTS; do
            echo "::group::[python] $P"
            safe_run "py.pip_audit.$(echo "$P" | tr '/' '_')" pip-audit -r "$P/requirements.txt" --format json > "$P/pip-audit.json"
            safe_run "py.safety.$(echo "$P" | tr '/' '_')" bash -c "safety check -r \"$P/requirements.txt\" --json > \"$P/safety.json\""
            safe_run "py.bandit.$(echo "$P" | tr '/' '_')" bash -c "bandit -r \"$P\" -f json -o \"$P/bandit.json\""
            safe_run "py.pip_audit.fix.$(echo "$P" | tr '/' '_')" pip-audit -r "$P/requirements.txt" --fix
            echo "::endgroup::"
          done

      - name: Upload python audit artifacts
        uses: actions/upload-artifact@v5
        with:
          name: python-audit-${{ github.run_number }}
          path: |
            ${{ env.PY_PROJECTS }}/pip-audit.json
            ${{ env.PY_PROJECTS }}/safety.json
            ${{ env.PY_PROJECTS }}/bandit.json
          if-no-files-found: ignore
          retention-days: 30

  # 4) íŒ¨í‚¤ì§€ ë¹Œë“œ + ë¦´ë¦¬ì¦ˆ â€” echo ë¡œê¹…
  package-and-release:
    name: "Package & Publish Release â€” Echo"
    runs-on: ubuntu-latest
    needs: [prepare, codeql, dep-node, dep-python]
    if: always()
    permissions:
      contents: write
      packages: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '20' }}
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.py_version || '3.11' }}
          cache: pip

      - name: Install Python build tool (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          safe_run "pip.upgrade" python -m pip install --upgrade pip
          safe_run "pip.install.build" pip install build

      - name: Download all audit artifacts
        uses: actions/download-artifact@v5
        with:
          path: collected-artifacts

      - name: Build Node packages (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          mkdir -p release_payload/node
          for P in $NODE_PROJECTS; do
            echo "::group::[node-pack] $P"
            safe_run "node.pack.$(echo "$P" | tr '/' '_')" bash -c "
              cd \"$P\"
              npm install || true
              npm pack || true
            "
            find "$P" -maxdepth 1 -type f -name "*.tgz" -exec cp {} release_payload/node/ \; || true
            echo "::endgroup::"
          done
          snap_tree "node.pack.tree" "release_payload/node"

      - name: Build Python packages (echo)
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          mkdir -p release_payload/python
          for P in $PY_PROJECTS; do
            echo "::group::[py-build] $P"
            safe_run "py.build.$(echo "$P" | tr '/' '_')" bash -c "
              cd \"$P\"
              python -m build || true
            "
            [ -d "$P/dist" ] && cp "$P/dist/"* release_payload/python/ 2>/dev/null || true
            echo "::endgroup::"
          done
          snap_tree "python.build.tree" "release_payload/python"

      - name: Create bundle (GITHUB_OUTPUT + echo)
        id: bundle
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          TS=$(date '+%Y%m%d-%H%M%S')
          BUNDLE="security-scan-bundle-${TS}-${GITHUB_RUN_NUMBER}.tar.gz"
          mkdir -p final_bundle
          cp -r release_payload final_bundle/ 2>/dev/null || true
          cp -r collected-artifacts final_bundle/ 2>/dev/null || true
          tar -czf "$BUNDLE" final_bundle
          echo "bundle_name=$BUNDLE" >> "$GITHUB_OUTPUT"
          echo_line "${LOG_DIR}/bundle.list" "BUNDLE=$BUNDLE"
          snap_tree "bundle.final" "final_bundle"

      - name: Upload bundle as artifact (always)
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.bundle.outputs.bundle_name }}
          path: ${{ steps.bundle.outputs.bundle_name }}
          retention-days: 30

      - name: Publish GitHub Release via gh (skip only if lite)
        if: ${{ inputs.run_mode != 'lite' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -Eeuo pipefail
          TAG="secscan-${GITHUB_RUN_NUMBER}"
          TITLE="Security Scan ${GITHUB_RUN_NUMBER} (No-Skip + Echo)"
          BUNDLE="${{ steps.bundle.outputs.bundle_name }}"
          BODY="ì—ì½” ë¡œê¹… í¬í•¨: ìžë™ ë³´ì•ˆ ì ê²€/ì—…ê·¸ë ˆì´ë“œ/íŒ¨í‚¤ì§• ë²ˆë“¤."

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --notes "$BODY" --title "$TITLE" || true
          else
            gh release create "$TAG" "$BUNDLE" --title "$TITLE" --notes "$BODY" --latest --verify-tag=false || true
          fi
          gh release upload "$TAG" "$BUNDLE" --clobber || true

  # 5) ìŠ¤ì¼€ì¤„ ì‹¤íŒ¨ ì‹œ ì´ìŠˆ
  weekly-failure-issue:
    name: "Open Issue on Weekly Failure"
    runs-on: ubuntu-latest
    needs: [package-and-release]
    if: github.event_name == 'schedule' && failure()
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const title = "ðŸš¨ Weekly Security Flow Failure (No-Skip + Echo)";
            const body = `ìžë™ ë³´ì•ˆ ì ê²€ì—ì„œ ì‹¤íŒ¨ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
            Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: "security,dependency-check", state: "open"
            });
            if (!issues.find(i => i.title === title)) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body, labels: ["security","dependency-check","automated"]
              });
            }
