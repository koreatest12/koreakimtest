name: "ğŸ›° API Test Server (Java HttpClient) â€” Safe-Continue / Always-Succeed"

on:
  workflow_dispatch:
    inputs:
      target_url:            # 1
        description: "í˜¸ì¶œí•  API URL (ë¹ˆê°’ì´ë©´ Claude messages ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ)"
        required: false
        default: "https://api.anthropic.com/v1/messages"
      run_mode:              # 2
        description: "full=ì „ì²´ ë‹¨ê³„ / lite=ì»´íŒŒì¼ ì—†ì´ ìƒ˜í”Œ ì½”ë“œë§Œ ìƒì„±"
        required: false
        default: "full"

permissions:
  contents: write   # ë¡œê·¸/ì•„í‹°íŒ©íŠ¸ ì»¤ë°‹/ì—…ë¡œë“œ ëŒ€ë¹„
  actions: read
  security-events: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  JAVA_MAIN: ApiTest
  JAVA_FILE: ApiTest.java

jobs:
  api-test-server:
    name: "API Test Server Runner"
    runs-on: ubuntu-22.04

    steps:
      ##################################################################
      # 0. ê³µí†µ í—¬í¼ ì¤€ë¹„: safe_run
      #    - ì–´ë–¤ ëª…ë ¹ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ì¤‘ë‹¨í•˜ì§€ ì•Šê³  ê³„ì† ê°.
      #    - ê° ë‹¨ê³„ ë¡œê·¸ë¥¼ ê°œë³„ íŒŒì¼ì— ë‚¨ê¹€.
      ##################################################################
      - name: "[prep] Checkout repository"
        uses: actions/checkout@v4

      - name: "[prep] Create dirs (.github/echo_*)"
        run: |
          set -Eeuo pipefail
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" .github/echo_tmp || true
          echo "[INFO] Directories prepared: ${LOG_DIR}, ${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/prep.log"

      - name: "[prep] Write helper script safe_run.sh"
        run: |
          cat > .github/echo_tmp/safe_run.sh << 'EOF'
          #!/usr/bin/env bash
          # safe_run <label> <command...>
          # - í•­ìƒ 0ìœ¼ë¡œ ì¢…ë£Œ (íŒŒì´í”„ë¼ì¸ ì•ˆ ëŠê¹€)
          # - stdout/stderr ë‘˜ ë‹¤ ê°œë³„ ë¡œê·¸ íŒŒì¼ì—ë„ ì €ì¥
          set -Eeuo pipefail
          label="$1"; shift || true
          log_file=".github/echo_logs/${label}.log"

          echo "â–¶ [$label] $(date '+%Y-%m-%d %H:%M:%S%z') START" | tee -a "$log_file"
          if "$@" >> "$log_file" 2>&1; then
            echo "âœ… [$label] OK"     | tee -a "$log_file"
            exit 0
          else
            rc=$?
            echo "âŒ [$label] FAILED (exit=${rc})" | tee -a "$log_file"
            # ì¢…ë£Œì½”ë“œëŠ” 0ìœ¼ë¡œ ë³€ê²½í•´ì„œ ì „ì²´ ì¡ì€ ê³„ì† ì§„í–‰
            exit 0
          fi
          EOF
          chmod +x .github/echo_tmp/safe_run.sh
          echo "[INFO] safe_run.sh ready" | tee -a "${LOG_DIR}/prep.log"

      ##################################################################
      # 1. Java í™˜ê²½ ì„¤ì¹˜
      ##################################################################
      - name: "[java] Setup Temurin JDK 21"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
      - name: "[java] java -version"
        run: |
          .github/echo_tmp/safe_run.sh java_version java -version

      ##################################################################
      # 2. API í˜¸ì¶œìš© Java ì½”ë“œ ìë™ ìƒì„±
      #
      # ì´ Java ì½”ë“œëŠ”:
      #  - Java 11+ HttpClient ì‚¬ìš©
      #  - Anthropic Claude messages API ì˜ˆì‹œ POST
      #  - í—¤ë”(x-api-key ë“±) í¬í•¨
      #  - ì‘ë‹µ status code / body ì¶œë ¥
      #
      # ì£¼ì˜:
      #  ì‹¤ì œ í‚¤ëŠ” í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³  GitHub Secretsë¡œ ë„˜ê¸°ëŠ” ê²Œ ë§ë‹¤.
      #  ì—¬ê¸°ì„œëŠ” ë¹ˆ ë¬¸ìì—´/placeholderë¡œ ë‘”ë‹¤.
      ##################################################################
      - name: "[codegen] Generate ApiTest.java"
        run: |
          cat > "${JAVA_FILE}" << 'EOF'
          import java.net.URI;
          import java.net.http.HttpClient;
          import java.net.http.HttpRequest;
          import java.net.http.HttpResponse;
          import java.time.Duration;

          // ê°„ë‹¨í•œ ë°ëª¨:
          // - Anthropic Claude /v1/messages ê°™ì€ POST APIë¥¼ í˜¸ì¶œí•´ì„œ
          //   status code / response bodyë¥¼ ì¶œë ¥í•œë‹¤.
          //
          // ì‹¤íŒ¨í•´ë„ í”„ë¡œì„¸ìŠ¤ëŠ” 0ìœ¼ë¡œ ëë‚˜ë„ë¡ mainì—ì„œ try/catch ì²˜ë¦¬.
          //
          // ì£¼ì˜: ì‹¤ì œ ë°°í¬ ì‹œì—” API í‚¤ë¥¼ í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ 
          //       í™˜ê²½ë³€ìˆ˜ë‚˜ GitHub Secretsì—ì„œ ì£¼ì…í•˜ì„¸ìš”.
          public class ApiTest {
              public static void main(String[] args) {
                  String targetUrl   = System.getenv("TARGET_URL");
                  if (targetUrl == null || targetUrl.isBlank()) {
                      targetUrl = "https://api.anthropic.com/v1/messages";
                  }

                  String apiKey      = System.getenv("ANTHROPIC_API_KEY"); // ì‹œí¬ë¦¿ì—ì„œ ë„£ê¸° ê¶Œì¥
                  if (apiKey == null) {
                      apiKey = ""; // ë¹ˆ ê°’ì´ë©´ ì¸ì¦ ì‹¤íŒ¨(401) ë‚  ìˆ˜ ìˆìŒ - ì˜ë„ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
                  }

                  // Claude API ì˜ˆì‹œ ë°”ë””
                  // model / max_tokens / messages êµ¬ì¡°ëŠ” Claude messages API ê¸°ì¤€
                  String jsonBody = """
                  {
                    "model": "claude-3-opus-20240229",
                    "max_tokens": 64,
                    "messages": [
                      { "role": "user", "content": "ì•ˆë…•, ì‚¬ìš©ëŸ‰(usage) í•„ë“œë¥¼ ë³´ì—¬ì¤˜." }
                    ]
                  }
                  """;

                  HttpClient client = HttpClient.newBuilder()
                          .connectTimeout(Duration.ofSeconds(15))
                          .build();

                  HttpRequest request = HttpRequest.newBuilder()
                          .uri(URI.create(targetUrl))
                          .timeout(Duration.ofSeconds(30))
                          .header("Content-Type", "application/json")
                          .header("anthropic-version", "2023-06-01")
                          .header("x-api-key", apiKey)
                          .POST(HttpRequest.BodyPublishers.ofString(jsonBody))
                          .build();

                  try {
                      HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

                      System.out.println("=== API CALL RESULT ========================");
                      System.out.println("URL        : " + targetUrl);
                      System.out.println("StatusCode : " + response.statusCode());
                      System.out.println("Headers    : " + response.headers().map());
                      System.out.println("Body       : " + response.body());
                      System.out.println("===========================================");

                      // ì •ìƒì´ë¼ë©´ ì‘ë‹µ body ì•ˆì— usage ê°™ì€ ì •ë³´ê°€ ìˆì„ ìˆ˜ë„ ìˆìŒ
                      // (ì„±ê³µ ì‘ë‹µì´ë©´ usage.input_tokens / usage.output_tokens)
                      //
                      // 401, 400, 429 ë“±ì´ ì™€ë„ ì—¬ê¸°ê¹Œì§€ëŠ” ë„ë‹¬í•˜ë¯€ë¡œ
                      // "í˜¸ì¶œ ê²½ë¡œ" ìì²´ëŠ” ê²€ì¦ ê°€ëŠ¥

                  } catch (Exception e) {
                      // ì—¬ê¸°ì„œë„ ì ˆëŒ€ ë¹„ì •ìƒ ì¢…ë£Œí•˜ì§€ ì•Šê³ ,
                      // í…ŒìŠ¤íŠ¸ ì„œë²„ íŒŒì´í”„ë¼ì¸ì€ í•­ìƒ "ì§„í–‰" ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.
                      System.out.println("[WARN] API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ: " + e.getMessage());
                      e.printStackTrace();
                  }

                  // í•­ìƒ ì •ìƒ ì¢…ë£Œ ì½”ë“œë¡œ ì¢…ë£Œ
                  System.exit(0);
              }
          }
          EOF
          echo "[INFO] ApiTest.java generated" | tee -a "${LOG_DIR}/codegen.log"

      ##################################################################
      # 3. ì»´íŒŒì¼ & ì‹¤í–‰
      #    - safe_run.sh ë¡œ ê°ì‹¼ë‹¤.
      #    - ì‹¤íŒ¨í•˜ë”ë¼ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰.
      ##################################################################
      - name: "[build] javac ApiTest.java"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          .github/echo_tmp/safe_run.sh javac_build javac "${JAVA_FILE}"

      - name: "[run] java ApiTest (POST test)"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          # ì‹¤ì œ ì‚¬ìš©ì‹œ ì•„ë˜ Secrets ë“±ë¡ í›„ ì‚¬ìš©:
          # Settings > Secrets and variables > Actions > New repository secret
          # Name: ANTHROPIC_API_KEY
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          .github/echo_tmp/safe_run.sh java_run java "${JAVA_MAIN}"

      ##################################################################
      # 4. ì‹¤í–‰ ê²°ê³¼/í™˜ê²½ ìŠ¤ëƒ…ìƒ·ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ëª¨ì€ë‹¤.
      #    - ë‚˜ì¤‘ì— ê·¼ê±°ë¡œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥.
      ##################################################################
      - name: "[snapshot] Collect env info"
        run: |
          {
            echo "===== ENV SNAPSHOT ====="
            date
            uname -a
            echo "--- df -h ---"
            df -h
            echo "--- env | sort ---"
            env | sort
          } | tee "${LOG_DIR}/env_snapshot.log"

      - name: "[snapshot] Copy key logs to artifacts"
        run: |
          set -Eeuo pipefail
          cp -r "${LOG_DIR}" "${ARTIFACT_DIR}/logs"
          echo "[INFO] Logs copied into ${ARTIFACT_DIR}/logs" | tee -a "${LOG_DIR}/artifact.log"
          ls -R "${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.log"

      ##################################################################
      # 5. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      ##################################################################
      - name: "[artifact] Upload Echo Logs & Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: api-test-server-logs
          path: |
            .github/echo_logs
            .github/echo_artifacts
          if-no-files-found: warn
          retention-days: 7

      ##################################################################
      # 6. ìµœì¢… ìƒíƒœ ë³´ê³  (í•­ìƒ ì„±ê³µìœ¼ë¡œ ë§ˆë¬´ë¦¬)
      #    - ì—¬ê¸°ì„œ ê°•ì œë¡œ 'ì„±ê³µ' ë©”ì‹œì§€ë¥¼ ì°ì–´ì¤€ë‹¤.
      ##################################################################
      - name: "[final] Report overall status (ALWAYS-SUCCESS)"
        run: |
          echo "âœ… [FINAL] API Test Server workflow finished."
          echo "   - ê° ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨ê°€ ìˆì–´ë„ íŒŒì´í”„ë¼ì¸ì€ ê³„ì† ì§„í–‰í–ˆìŠµë‹ˆë‹¤."
          echo "   - ë¡œê·¸ëŠ” api-test-server-logs ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "   - ApiTest.java ëŠ” Java HttpClient ê¸°ë°˜ POST í…ŒìŠ¤íŠ¸ ì˜ˆì œì…ë‹ˆë‹¤."
          echo "   - Claude ì‚¬ìš©ëŸ‰(usage)ì€ ê°œë³„ í˜¸ì¶œ ì‘ë‹µ body ì•ˆì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          echo "   - ë³„ë„ '/usage' ì¡°íšŒ APIëŠ” ì—†ìœ¼ë¯€ë¡œ ì‹¤íŒ¨ì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          echo "DONE." | tee -a "${LOG_DIR}/final.log"
