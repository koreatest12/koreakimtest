name: "ğŸ›° API Curl Test Server â€” EchoOps / Safe-Continue / Service Perms / DR+ISO / Stable"

on:
  workflow_dispatch:
    inputs:
      target_url:            # 1
        description: "í˜¸ì¶œí•  API URL (ë¹ˆê°’ì´ë©´ Anthropic Claude messages)"
        required: false
        default: "https://api.anthropic.com/v1/messages"
      run_mode:              # 2
        description: "full=ì „ì²´ ìˆ˜í–‰ / lite=ìƒì„± ìœ„ì£¼ (curlë„ ì‹œë„í•˜ì§€ë§Œ ì‹¤íŒ¨ ë¬´ì‹œ)"
        required: false
        default: "full"

permissions:
  contents: write
  actions: read
  security-events: read

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  SERVICE_DIR: .github/echo_services
  PERM_DIR: .github/echo_perm

  # ê´€ë¦¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡
  SERVICES: "claude_api dr_center iso_builder"

jobs:
  curl-test-server:
    name: "Curl Test Server Runner (Echo / Always Success / No Nested Bash)"
    runs-on: ubuntu-22.04

    steps:
      ##################################################################
      # 0. ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      ##################################################################
      - name: "[prep] Checkout repository"
        uses: actions/checkout@v4

      ##################################################################
      # 1. ê¸°ë³¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
      #    - echo_logs / echo_artifacts / echo_services / echo_perm / echo_tmp
      ##################################################################
      - name: "[prep] Create base dirs"
        run: |
          echo ">>> [prep] start"
          mkdir -p "${LOG_DIR}" "${ARTIFACT_DIR}" "${SERVICE_DIR}" "${PERM_DIR}" .github/echo_tmp || true
          echo "[INFO] base dirs ready" | tee -a "${LOG_DIR}/prep.init.log"

      ##################################################################
      # 2. ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬ / ê¶Œí•œ íŒŒì¼ / ìƒíƒœ ë¡œê·¸ ìƒì„±
      #    - Heredoc ê¸ˆì§€. printf/echoë§Œ ì‚¬ìš©.
      ##################################################################
      - name: "[svc] Init service dirs + perms + status"
        env:
          SERVICES: ${{ env.SERVICES }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [svc] start"
          for svc in $SERVICES; do
            svc_dir="${SERVICE_DIR}/${svc}"
            svc_perm="${PERM_DIR}/${svc}"

            echo "[svc:$svc] create dirs ${svc_dir}, ${svc_perm}"
            mkdir -p "$svc_dir" "$svc_perm" || true

            # README.md
            printf '%s\n' "# Service: ${svc}" > "${svc_dir}/README.md"

            # status.log
            printf '%s\n' "[INIT] $(date '+%Y-%m-%d %H:%M:%S%z') service=${svc} created" > "${svc_dir}/status.log"

            # permissions.txt
            {
              printf '%s\n' "[PERMISSIONS]"
              printf '%s\n' "service=${svc}"
              printf '%s\n' "owner=runner"
              printf '%s\n' "access=rw"
              printf '%s\n' "note=ìë™ ìƒì„±ëœ ê¶Œí•œ/ì ‘ê·¼ ì œì–´ í…œí”Œë¦¿"
            } > "${svc_perm}/permissions.txt"

            # ê¶Œí•œ (ì—ëŸ¬ ë¬´ì‹œ)
            chmod 600 "${svc_perm}/permissions.txt" || true
            chmod 640 "${svc_dir}/status.log" || true
            chmod 644 "${svc_dir}/README.md" || true

            echo "[svc:$svc] files created + chmod applied" | tee -a "${LOG_DIR}/svc.init.log"
          done
          echo ">>> [svc] done" | tee -a "${LOG_DIR}/svc.init.log"

      ##################################################################
      # 3. DR ì„¼í„° / ISO ë¹Œë” í…œí”Œë¦¿ ìƒì„±
      #    - dr_backup_plan.txt
      #    - iso_manifest.txt
      #    - ì„œë¹„ìŠ¤ status.logì— append
      ##################################################################
      - name: "[svc] DR / ISO templates"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [dr+iso] start"

          dr_dir="${SERVICE_DIR}/dr_center"
          iso_dir="${SERVICE_DIR}/iso_builder"

          # DR ë°±ì—… í”Œëœ
          {
            printf '%s\n' "[DR_BACKUP_PLAN]"
            printf '%s\n' "retention_days=1"
            printf '%s\n' "description=í•˜ë£¨ ë‹¨ìœ„ DR ë°ì´í„°ì„¼í„° ë³´ê´€ ì •ì±…"
            printf '%s\n' "snapshot_policy=nightly+on-demand"
          } > "${dr_dir}/dr_backup_plan.txt"

          # ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸
          {
            printf '%s\n' "[ISO_MANIFEST]"
            printf '%s\n' "image_name=finops-snapshot.iso"
            printf '%s\n' "includes=logs,configs,sql,artifacts"
            printf '%s\n' "note=ì´ íŒŒì¼ì€ ISO ì´ë¯¸ì§€ì— í¬í•¨í•  ìì›ì„ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿ì…ë‹ˆë‹¤."
          } > "${iso_dir}/iso_manifest.txt"

          chmod 640 "${dr_dir}/dr_backup_plan.txt" || true
          chmod 640 "${iso_dir}/iso_manifest.txt" || true

          # status.log append
          printf '\n%s\n' "[DR_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') backup plan prepared" >> "${dr_dir}/status.log"  || true
          printf '\n%s\n' "[ISO_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') iso manifest prepared"  >> "${iso_dir}/status.log" || true

          echo ">>> [dr+iso] done" | tee -a "${LOG_DIR}/dr_iso.init.log"

      ##################################################################
      # 4. í™˜ê²½ ìŠ¤ëƒ…ìƒ·
      #    - df -h, uname, env ë“± ê¸°ë¡
      ##################################################################
      - name: "[snap] Environment snapshot"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [snap] start"
          {
            echo "===== ENV SNAPSHOT ====="
            date
            uname -a
            echo "--- df -h ---"
            df -h
            echo "--- env | sort ---"
            env | sort
          } | tee "${LOG_DIR}/env_snapshot.log"
          echo ">>> [snap] done" | tee -a "${LOG_DIR}/env_snapshot.log"

      ##################################################################
      # 5. CURL í˜¸ì¶œ
      #
      #  - Heredoc ì—†ì´ request_body.json ìƒì„± (printf ì‚¬ìš©)
      #  - curlë¡œ Anthropic Claude messages API POST ì‹œë„
      #  - ê²°ê³¼ (status, headers, body, usage ì¶”ì¶œ)ë¥¼ íŒŒì¼ë¡œ ì €ì¥
      #  - claude_api/status.log ì— í˜¸ì¶œ ê²°ê³¼ append
      #
      #  ì¤‘ìš”:
      #    - ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨, ì¸ì¦ ì‹¤íŒ¨(401), ë ˆì´íŠ¸ë¦¬ë°‹(429) ë“±ìœ¼ë¡œ
      #      ì´ step ìì²´ê°€ ì‹¤íŒ¨(exit code!=0)í•  ìˆ˜ ìˆë‹¤.
      #    - ê·¸ë˜ì„œ continue-on-error: true ë¥¼ ì¼ ë‹¤.
      #
      #  => ì „ì²´ ì¡ì€ ê³„ì† ì§„í–‰í•˜ê³ , ë§ˆì§€ë§‰ stepì€ âœ… SUCCESS ì¶œë ¥.
      ##################################################################
      - name: "[api] Curl call Anthropic Claude messages API (Echo Safe)"
        continue-on-error: true
        env:
          INPUT_URL: ${{ github.event.inputs.target_url }}
          SECR_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LOG_DIR: ${{ env.LOG_DIR }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
        run: |
          echo ">>> [api] start"

          TARGET_URL="${INPUT_URL}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="https://api.anthropic.com/v1/messages"
          fi

          echo "[api] TARGET_URL=${TARGET_URL}"

          REQ_DIR="${LOG_DIR}/curl_request"
          RESP_DIR="${LOG_DIR}/curl_response"
          mkdir -p "$REQ_DIR" "$RESP_DIR"

          # ìš”ì²­ ë°”ë”” JSON
          {
            printf '%s\n' '{'
            printf '%s\n' '  "model": "claude-3-opus-20240229",'
            printf '%s\n' '  "max_tokens": 64,'
            printf '%s\n' '  "messages": ['
            printf '%s\n' '    { "role": "user", "content": "ì•ˆë…•, ì‚¬ìš©ëŸ‰ usage í•„ë“œ ë³´ì—¬ì¤˜." }'
            printf '%s\n' '  ]'
            printf '%s\n' '}'
          } > "${REQ_DIR}/request_body.json"

          echo "[api] request_body.json created" | tee -a "${LOG_DIR}/curl_init.log"

          status_file="${RESP_DIR}/status_code.txt"
          body_file="${RESP_DIR}/body.json"
          header_file="${RESP_DIR}/headers.txt"
          usage_log="${RESP_DIR}/usage.log"

          echo "[api] curl POST ${TARGET_URL}"        | tee -a "${LOG_DIR}/curl_init.log"
          echo "[api] headers: Content-Type, anthropic-version, x-api-key(masked)" | tee -a "${LOG_DIR}/curl_init.log"

          # curl ì‹¤í–‰
          # -sS : ì—ëŸ¬ ì‹œ stderr í‘œì‹œ
          # -D header_file : ì‘ë‹µ í—¤ë” ì €ì¥
          # --write-out '%{http_code}' : ìƒíƒœì½”ë“œë§Œ status_fileì— ì €ì¥
          # --data @file : ìš°ë¦¬ê°€ ë§Œë“  JSON ë°”ë”” ì‚¬ìš©
          curl -sS -X POST "${TARGET_URL}" \
            -H "Content-Type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            -H "x-api-key: ${SECR_KEY}" \
            -D "${header_file}" \
            --data @"${REQ_DIR}/request_body.json" \
            -o "${body_file}" \
            --write-out "%{http_code}" > "${status_file}"

          echo "[api] curl done." | tee -a "${LOG_DIR}/curl_init.log"

          echo "[api] status code:" | tee -a "${LOG_DIR}/curl_init.log"
          cat "${status_file}"      | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] headers (first lines):" | tee -a "${LOG_DIR}/curl_init.log"
          head -n 20 "${header_file}"         | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] body (first 500 chars):" | tee -a "${LOG_DIR}/curl_init.log"
          head -c 500 "${body_file}"           | tee -a "${LOG_DIR}/curl_init.log" || true
          echo ""                              | tee -a "${LOG_DIR}/curl_init.log"

          # usage í•„ë“œ ì¶”ì¶œ ì‹œë„
          printf '%s\n' "[api] extracting usage best-effort" | tee "${usage_log}"
          grep -E '"usage"|input_tokens|output_tokens' "${body_file}" >> "${usage_log}" 2>/dev/null || true

          # claude_api/status.log ì— í˜¸ì¶œ ê²°ê³¼ append
          svc_status="${SERVICE_DIR}/claude_api/status.log"
          {
            printf '\n%s\n' "[CALL] $(date '+%Y-%m-%d %H:%M:%S%z')"
            printf '%s%s\n' "status_code=" "$(cat "${status_file}" 2>/dev/null || echo 'N/A')"
            printf '%s\n' "note=See curl_response/ for details"
          } >> "${svc_status}" || true

          # ë¯¼ê° ë¡œê·¸ ìµœì†Œ ê¶Œí•œ
          chmod 600 "${status_file}" "${header_file}" "${body_file}" "${usage_log}" 2>/dev/null || true

          echo ">>> [api] done" | tee -a "${LOG_DIR}/curl_init.log"

      ##################################################################
      # 6. ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ & ì—…ë¡œë“œ
      #    - echo_services, echo_perm, echo_logs, echo_artifacts ì „ì²´ ì—…ë¡œë“œ
      ##################################################################
      - name: "[collect] Prepare artifacts"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        run: |
          echo ">>> [collect] start"
          mkdir -p "${ARTIFACT_DIR}/services" "${ARTIFACT_DIR}/permissions" || true
          cp -r "${SERVICE_DIR}/."     "${ARTIFACT_DIR}/services/"     || true
          cp -r "${PERM_DIR}/."        "${ARTIFACT_DIR}/permissions/"  || true
          echo ">>> listing ${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          ls -R "${ARTIFACT_DIR}"     | tee -a "${LOG_DIR}/artifact.bundle.log"
          echo ">>> [collect] done"   | tee -a "${LOG_DIR}/artifact.bundle.log"

      - name: "[artifact] Upload logs + services + perms"
        uses: actions/upload-artifact@v4
        with:
          name: api-curl-test-server-logs-and-services
          path: |
            .github/echo_logs
            .github/echo_artifacts
            .github/echo_services
            .github/echo_perm
          if-no-files-found: warn
          retention-days: 7

      ##################################################################
      # 7. ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸ (í•­ìƒ ì„±ê³µ ì„ ì–¸)
      #    - curl ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆë”ë¼ë„ continue-on-error: true ë•ë¶„ì—
      #      ì¡ì€ ì—¬ê¸°ê¹Œì§€ ì˜¨ë‹¤.
      ##################################################################
      - name: "[final] Overall status (ALWAYS-SUCCESS)"
        run: |
          echo "âœ… [FINAL] API Curl Test Server workflow finished."
          echo "   - ëª¨ë“  ë‹¨ê³„ëŠ” echo ê¸°ë°˜ìœ¼ë¡œ ë¡œê¹…í–ˆìŠµë‹ˆë‹¤."
          echo "   - Anthropic Claude ì •ì‹ ì—”ë“œí¬ì¸íŠ¸(${{ github.event.inputs.target_url }})ì— curl POST ì‹œë„(ë¹ˆ ê°’ì´ë©´ https://api.anthropic.com/v1/messages)."
          echo "   - x-api-key / anthropic-version / Content-Type í—¤ë”ê¹Œì§€ í¬í•¨í•´ì„œ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤."
          echo "   - usage í•„ë“œëŠ” ì‘ë‹µ body ì•ˆì—ì„œë§Œ ì¶”ì¶œ ì‹œë„í–ˆê³ , ë³„ë„ì˜ /usage APIëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "   - ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬(.github/echo_services/*)ì™€ ê¶Œí•œ íŒŒì¼(.github/echo_perm/*/permissions.txt)ì„ ìƒì„±/ê¶Œí•œë¶€ì—¬ í–ˆìŠµë‹ˆë‹¤."
          echo "   - DR ë°±ì—… ê³„íš(dr_backup_plan.txt)ê³¼ ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸(iso_manifest.txt)ë„ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
          echo "   - echo_logs, echo_artifacts, echo_services, echo_perm ì „ì²´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤."
          echo "   - ë§ˆì§€ë§‰ ë‹¨ê³„ëŠ” í•­ìƒ ì„±ê³µìœ¼ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
          echo "DONE."
