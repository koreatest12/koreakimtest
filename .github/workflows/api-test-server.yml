name: "Dependency Security Check + AutoUpgrade + Release Publish"

on:
  schedule:
    - cron: "0 3 * * 1"  # ë§¤ì£¼ ì›”ìš”ì¼ 03:00 UTC
  workflow_dispatch:
  pull_request:
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"
      - ".github/workflows/dependency-check.yml"
  push:
    branches: [ "main" ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/requirements.txt"

permissions:
  contents: write         # ë¦´ë¦¬ì¦ˆ ìƒì„±/ì—…ë¡œë“œì— í•„ìš”
  pull-requests: write
  security-events: read
  id-token: write
  packages: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/sec_report
  LOG_DIR: .github/sec_report/logs
  ARTIFACT_DIR: .github/sec_report/artifacts

jobs:

  ##########################################################################
  # Node.js audit + upgrade
  ##########################################################################
  node-security:
    name: "Node.js Dependency Check + Upgrade"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: anthropic-cost-tracker/nodejs
            safe: anthropic-cost-tracker-nodejs
          - project: mcp-hello-js
            safe: mcp-hello-js
          - project: mcp-fs
            safe: mcp-fs

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_node
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date \"+%Y-%m-%d %H:%M:%S%z\") START" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '  if \"$@\" >> \"$logfile\" 2>&1 ; then'        >> "$HELPER_PATH"
          printf '%s\n' '    echo \"âœ… [$label] OK\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo \"âŒ [$label] FAILED exit=${rc}\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile=\"${LOG_BASE}/apt.fix.log\"'    >> "$HELPER_PATH"
          printf '%s\n' '  echo \"[fix] apt_fix start\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          chmod +x "$HELPER_PATH"
          echo "Node scan target: ${{ matrix.project }} (safe=${{ matrix.safe }})" | tee -a "${REPORT_DIR}/SUMMARY_node.txt"
      - name: Check project/package.json
        id: node_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/package.json" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Setup Node.js
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install jq
        if: steps.node_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true
      - name: npm install / ci
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -f "package-lock.json" ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: npm audit (report only)
        if: steps.node_exists.outputs.exists == 'true'
        id: node_audit
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          echo "## NPM Audit for ${{ matrix.project }}" >> "$GITHUB_STEP_SUMMARY"
          npm audit --json > audit.json || true
          npm audit >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
          if command -v jq >/dev/null 2>&1 && [ -f audit.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo 0)
            CRIT_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json 2>/dev/null || echo 0)
          else
            HIGH_COUNT=0
            CRIT_COUNT=0
          fi
          echo "High severity: $HIGH_COUNT"
          echo "Critical severity: $CRIT_COUNT"
          echo "HIGH_COUNT=${HIGH_COUNT}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT_COUNT}" >> "$GITHUB_OUTPUT"
      - name: npm upgrade attempt (auto-fix vulnerabilities)
        if: steps.node_exists.outputs.exists == 'true'
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -Eeo pipefail
          UPG_LOG="sec-upgrade.log"
          {
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') npm audit fix try"
            npm audit fix || true
            echo
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') npm audit fix --force try (may introduce breaking changes)"
            npm audit fix --force || true
            echo
            echo "### re-run npm audit --json after fix"
            npm audit --json || true
          } > "$UPG_LOG" 2>&1 || true
      - name: Upload Node audit artifact
        if: steps.node_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: npm-audit-${{ github.run_number }}-${{ matrix.safe }}
          path: |
            ${{ matrix.project }}/audit.json
            ${{ matrix.project }}/sec-upgrade.log
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # Python audit + upgrade
  ##########################################################################
  python-security:
    name: "Python Dependency Check + Upgrade"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: anthropic-cost-tracker/python
            safe: anthropic-cost-tracker-python
          - project: mcp-hello-py
            safe: mcp-hello-py
          - project: mcp-python-server
            safe: mcp-python-server
          - project: mcp-apache-server
            safe: mcp-apache-server
          - project: .
            safe: root-dot

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs and helper script (no heredoc)
        id: prep_py
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"
          HELPER_PATH="${REPORT_DIR}/helpers.sh"
          printf '%s\n' '#!/usr/bin/env bash'                            >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeo pipefail'                               >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'LOG_BASE="${LOG_DIR:-.github/sec_report/logs}"' >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'safe_run() {'                                   >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="${LOG_BASE}/${label}.log"'     >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [$label] $(date \"+%Y-%m-%d %H:%M:%S%z\") START" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '  if \"$@\" >> \"$logfile\" 2>&1 ; then'        >> "$HELPER_PATH"
          printf '%s\n' '    echo \"âœ… [$label] OK\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                   >> "$HELPER_PATH"
          printf '%s\n' '  else'                                         >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                >> "$HELPER_PATH"
          printf '%s\n' '    echo \"âŒ [$label] FAILED exit=${rc}\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                 >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                           >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          printf '%s\n' ''                                               >> "$HELPER_PATH"
          printf '%s\n' 'apt_fix() {'                                    >> "$HELPER_PATH"
          printf '%s\n' '  local logfile=\"${LOG_BASE}/apt.fix.log\"'    >> "$HELPER_PATH"
          printf '%s\n' '  echo \"[fix] apt_fix start\" | tee -a \"$logfile\"' >> "$HELPER_PATH"
          printf '%s\n' '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true' >> "$HELPER_PATH"
          printf '%s\n' '  sudo dpkg --configure -a || true'             >> "$HELPER_PATH"
          printf '%s\n' '  sudo apt-get update -y || sudo apt-get update -y || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                              >> "$HELPER_PATH"
          chmod +x "$HELPER_PATH"
          echo "Python scan target: ${{ matrix.project }} (safe=${{ matrix.safe }})" | tee -a "${REPORT_DIR}/SUMMARY_py.txt"
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check requirements.txt
        id: py_exists
        shell: bash
        run: |
          set -Eeo pipefail
          if [ -d "${{ matrix.project }}" ] && [ -f "${{ matrix.project }}/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Install security tools
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit build || true
      - name: Ensure jq (for parsing)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          sudo apt-get install -y jq || true
      - name: pip-audit (report only)
        if: steps.py_exists.outputs.exists == 'true'
        id: py_audit
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          echo "## Pip Audit for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"
          pip-audit -r "${TARGET_DIR}/requirements.txt" --format json > "${TARGET_DIR}/pip-audit.json" || true
          pip-audit -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
          if command -v jq >/dev/null 2>&1 && [ -f "${TARGET_DIR}/pip-audit.json" ]; then
            HIGH=$(jq '[.[] | .vulns[]? | select(.severity=="HIGH")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
            CRIT=$(jq '[.[] | .vulns[]? | select(.severity=="CRITICAL")] | length' "${TARGET_DIR}/pip-audit.json" 2>/dev/null || echo 0)
          else
            HIGH=0
            CRIT=0
          fi
          echo "High severity vulns: $HIGH"
          echo "Critical severity vulns: $CRIT"
          echo "HIGH_COUNT=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "CRIT_COUNT=${CRIT}" >> "$GITHUB_OUTPUT"
      - name: safety check
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          echo "## Safety Check for ${TARGET_DIR}" >> "$GITHUB_STEP_SUMMARY"
          safety check -r "${TARGET_DIR}/requirements.txt" --json > "${TARGET_DIR}/safety.json" || true
          safety check -r "${TARGET_DIR}/requirements.txt" >> "$GITHUB_STEP_SUMMARY" || echo "Vulnerabilities found" >> "$GITHUB_STEP_SUMMARY"
      - name: bandit static analysis
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          bandit -r "$TARGET_DIR" -f json -o "$TARGET_DIR/bandit.json" || true
          echo "## Bandit Security Scan for $TARGET_DIR" >> "$GITHUB_STEP_SUMMARY"
          bandit -r "$TARGET_DIR" || echo "Bandit found issues" >> "$GITHUB_STEP_SUMMARY"
      - name: pip-audit --fix (auto upgrade attempt)
        if: steps.py_exists.outputs.exists == 'true'
        shell: bash
        run: |
          set -Eeo pipefail
          TARGET_DIR="${{ matrix.project }}"
          UPG_LOG="${TARGET_DIR}/sec-upgrade.log"
          {
            echo "### $(date '+%Y-%m-%d %H:%M:%S%z') pip-audit --fix try"
            echo "(ì·¨ì•½ íŒ¨í‚¤ì§€ ìë™ ì—…ê·¸ë ˆì´ë“œ/íŒ¨ì¹˜ ì‹œë„)"
            pip-audit -r "${TARGET_DIR}/requirements.txt" --fix || true
            echo
            echo "### re-run pip-audit for diff"
            pip-audit -r "${TARGET_DIR}/requirements.txt" --format json || true
          } > "$UPG_LOG" 2>&1 || true
      - name: Upload Python audit artifact
        if: steps.py_exists.outputs.exists == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: python-audit-${{ github.run_number }}-${{ matrix.safe }}
          path: |
            ${{ matrix.project }}/pip-audit.json
            ${{ matrix.project }}/safety.json
            ${{ matrix.project }}/bandit.json
            ${{ matrix.project }}/sec-upgrade.log
          if-no-files-found: warn
          retention-days: 30


  ##########################################################################
  # GitHub advisory gate on PR
  ##########################################################################
  dependency-review:
    name: "Dependency Review (PR gate)"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure


  ##########################################################################
  # íŒ¨í‚¤ì§€ ë¹Œë“œ + ë¦´ë¦¬ì¦ˆ ì¶œì‹œì— ì‚¬ìš©í•  ë²ˆë“¤ ìƒì„± + GitHub Release ê²Œì‹œ
  ##########################################################################
  package-and-release:
    name: "Package Projects & Publish Release"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]
    continue-on-error: false   # ì´ jobì€ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ì›Œí¬í”Œë¡œìš°ëŠ” ì‹¤íŒ¨ í‘œì‹œë¨
    env:
      NODE_PROJECTS: "anthropic-cost-tracker/nodejs mcp-hello-js mcp-fs"
      PY_PROJECTS: "anthropic-cost-tracker/python mcp-hello-py mcp-python-server mcp-apache-server ."

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (for npm pack)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python (for build wheels)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python build tooling
        shell: bash
        run: |
          set -Eeo pipefail
          python -m pip install --upgrade pip
          pip install build || true
      # 1) ì´ì „ jobë“¤ì´ ì—…ë¡œë“œí•œ ëª¨ë“  audit ì•„í‹°íŒ©íŠ¸(ì·¨ì•½ì  ë³´ê³ ì„œ+ì—…ê·¸ë ˆì´ë“œ ë¡œê·¸)ë¥¼ ìˆ˜ì§‘
      - name: Download all audit artifacts
        uses: actions/download-artifact@v5
        with:
          path: collected-artifacts

      # 2) ê° Node í”„ë¡œì íŠ¸ì— ëŒ€í•´ npm pack (tgz) ìƒì„±
      - name: Build Node packages (npm pack)
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p release_payload/node
          for P in $NODE_PROJECTS; do
            if [ -d "$P" ] && [ -f "$P/package.json" ]; then
              echo "[node-pack] $P"
              (
                cd "$P"
                npm install || true
                npm pack || true
              )
              # npm pack ê²°ê³¼ *.tgz íŒŒì¼ì„ release_payload/node ë¡œ ë³µì‚¬
              find "$P" -maxdepth 1 -type f -name "*.tgz" -exec cp {} release_payload/node/ \; || true
            else
              echo "[node-pack] skip $P (no package.json)"
            fi
          done
      # 3) ê° Python í”„ë¡œì íŠ¸ì— ëŒ€í•´ sdist / wheel ìƒì„± (python -m build)
      - name: Build Python packages (python -m build)
        shell: bash
        run: |
          set -Eeo pipefail
          mkdir -p release_payload/python
          for P in $PY_PROJECTS; do
            if [ -d "$P" ] && [ -f "$P/setup.py" -o -f "$P/pyproject.toml" ]; then
              echo "[py-build] $P"
              (
                cd "$P"
                python -m build || true
              )
              # dist/* ë‚´ìš©ì„ release_payload/python ìœ¼ë¡œ ë³µì‚¬
              if [ -d "$P/dist" ]; then
                cp "$P/dist/"* release_payload/python/ 2>/dev/null || true
              fi
            else
              echo "[py-build] skip $P (no setup.py / pyproject.toml)"
            fi
          done
      # 4) release_payload + collected-artifactsë¥¼ tar.gzë¡œ ë¬¶ìŒ
      - name: Create release bundle tar.gz
        id: bundle
        shell: bash
        run: |
          set -Eeo pipefail
          TS=$(date '+%Y%m%d-%H%M%S')
          BUNDLE="security-scan-bundle-${TS}-${GITHUB_RUN_NUMBER}.tar.gz"
          mkdir -p final_bundle
          cp -r release_payload final_bundle/ 2>/dev/null || true
          cp -r collected-artifacts final_bundle/ 2>/dev/null || true
          tar -czf "$BUNDLE" final_bundle
          echo "bundle_name=$BUNDLE" >> "$GITHUB_OUTPUT"
      # 5) GitHub Release ìƒì„± (tag_nameì€ ì‹¤í–‰ë²ˆí˜¸ ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•˜ê²Œ)
      - name: Create GitHub Release (soft-fail allowed)
        id: create_release
        continue-on-error: true
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: secscan-${{ github.run_number }}
          release_name: "Security Scan ${{ github.run_number }} (AutoUpgrade+Packages)"
          draft: false
          prerelease: false
          body: |
            ìë™ ë³´ì•ˆ ì ê²€ & ì—…ê·¸ë ˆì´ë“œ ê²°ê³¼ì…ë‹ˆë‹¤.
            í¬í•¨ ë‚´ìš©:
            - Node ì˜ì¡´ì„± ê°ì‚¬ (npm audit) ë° ìë™ ìˆ˜ì • ì‹œë„ (npm audit fix / --force)
            - Python ì˜ì¡´ì„± ê°ì‚¬ (pip-audit / safety / bandit) ë° pip-audit --fix ìë™ ì‹œë„
            - sec-upgrade.log : ì‹¤ì œë¡œ ì–´ë–¤ íŒ¨í‚¤ì§€ë“¤ì´ ì—…ë°ì´íŠ¸/êµì²´ ì‹œë„ëëŠ”ì§€ ê¸°ë¡
            - ê° í”„ë¡œì íŠ¸ë³„ ë¹Œë“œ ê²°ê³¼
              * Node: npm pack (*.tgz)
              * Python: python -m build ê²°ê³¼ (sdist, wheel)
            - collected-artifacts/: ê°ì‚¬ ê²°ê³¼ JSON, ë¡œê·¸ ë“±
            - ì „ì²´ tar.gz ë²ˆë“¤ (final_bundle í¬í•¨)
      # 6) Release asset ì—…ë¡œë“œ (ë²ˆë“¤ tar.gz ì²¨ë¶€)
      - name: Upload bundle to Release (soft-fail allowed)
        if: steps.create_release.outcome != 'failure'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.bundle.outputs.bundle_name }}
          asset_name: ${{ steps.bundle.outputs.bundle_name }}
          asset_content_type: application/gzip


  ##########################################################################
  # Weekly scheduled run -> if any job failed in audits, open issue
  ##########################################################################
  create-issue-on-weekly-failure:
    name: "Create Issue on Weekly Failure"
    runs-on: ubuntu-latest
    needs: [node-security, python-security]
    if: github.event_name == 'schedule' && failure()

    steps:
      - name: Open or reuse security issue
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependency-check',
              state: 'open'
            });
            if (existing.data.length === 0) {
              const bodyText = [
                "ğŸš¨ Weekly dependency check reported failures.",
                "",
                "ì¼ë¶€ ë³´ì•ˆ ì ê²€ ë‹¨ê³„(npm audit / pip-audit / bandit / safety ë“±) ë˜ëŠ”",
                "ìë™ ì—…ê·¸ë ˆì´ë“œ(npm audit fix / pip-audit --fix)ì—ì„œ ì—ëŸ¬ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "",
                "ë¦´ë¦¬ì¦ˆ(Release)ì— ì—…ë¡œë“œëœ tar.gz ë²ˆë“¤ì—ëŠ”",
                "sec-upgrade.log, ê°ì‚¬ ê²°ê³¼, ë¹Œë“œëœ íŒ¨í‚¤ì§€(.tgz / .whl ë“±)ê°€ í¬í•¨ë©ë‹ˆë‹¤.",
                "",
                `Run details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                "",
                "ì·¨ì•½ ì˜ì¡´ì„± ë˜ëŠ” ìˆ˜ì •ì´ í•„ìš”í•œ ì˜ì—­ì„ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
              ].join("\n");
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "ğŸš¨ Dependency Security Check Failure (Weekly Scan w/ AutoUpgrade & Release)",
                body: bodyText,
                labels: ["security", "dependency-check", "automated"]
              });
            }
