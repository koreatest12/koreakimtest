name: Maven ISO Build & Release (All Versions)

on:
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force recreate release if exists'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build-iso-release:
    name: Build ISO & Release Maven ${{ matrix.maven-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      TARGET_REPO: spring-projects/spring-petclinic
      TARGET_DIR: spring-petclinic

    steps:
      # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì • ë° ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout Spring PetClinic (Stable Target)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          path: ${{ env.TARGET_DIR }}

      - name: Set up Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 2. ISO ìƒì„± ë„êµ¬ ì„¤ì¹˜
      - name: Install ISO creation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage

      # 3. Maven ë‹¤ìš´ë¡œë“œ ë° ê²€ì¦
      - name: Download Apache Maven
        run: |
          set -euo pipefail
          mkdir -p dump extracted
          
          VERSION="${{ matrix.maven-version }}"
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          
          PRIMARY_URL="${MAVEN_PRIMARY_BASE_URL}/${VERSION}/binaries/${FILENAME}"
          ARCHIVE_URL="${MAVEN_ARCHIVE_BASE_URL}/${VERSION}/binaries/${FILENAME}"

          echo "Downloading Maven ${VERSION}..."
          if curl -fL "${PRIMARY_URL}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded from Primary"
          else
            echo "âš ï¸ Primary failed, attempting Archive..."
            if curl -fL "${ARCHIVE_URL}" -o "${ARCHIVE_PATH}"; then
              echo "âœ… Downloaded from Archive"
            else
              exit 1
            fi
          fi

      - name: Extract Maven
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          ARCHIVE_PATH="dump/apache-maven-${VERSION}-bin.tar.gz"
          EXTRACT_DIR="extracted/apache-maven-${VERSION}"
          
          mkdir -p "${EXTRACT_DIR}"
          tar -xzf "${ARCHIVE_PATH}" -C "${EXTRACT_DIR}" --strip-components=1
          
          echo "MAVEN_HOME=${PWD}/${EXTRACT_DIR}" >> "$GITHUB_ENV"
          echo "${PWD}/${EXTRACT_DIR}/bin" >> "$GITHUB_PATH"

      # 4. Spring PetClinic ë¹Œë“œ (Maven ê²€ì¦ìš©)
      - name: Build Spring PetClinic
        run: |
          set -euo pipefail
          cd ${{ env.TARGET_DIR }}
          echo "Building PetClinic with Maven ${{ matrix.maven-version }}..."
          mvn -q -B -DskipTests clean package
          echo "âœ… Build Success"

      # 5. ì¬íŒ¨í‚¤ì§• (Extracted Tarball)
      - name: Repackage Extracted Maven
        run: |
          VERSION="${{ matrix.maven-version }}"
          tar -czf "dump/apache-maven-${VERSION}-extracted.tar.gz" -C "extracted/apache-maven-${VERSION}" .

      # 6. [NEW] ISO íŒŒì¼ ìƒì„±
      - name: Create ISO Image
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          ISO_ROOT="iso_root"
          mkdir -p "${ISO_ROOT}"

          # ISOì— í¬í•¨í•  íŒŒì¼ ë³µì‚¬
          echo "Copying artifacts to ISO root..."
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ISO_ROOT}/"
          cp "dump/apache-maven-${VERSION}-extracted.tar.gz" "${ISO_ROOT}/"
          
          # ë¹Œë“œëœ Spring Boot JAR íŒŒì¼ ë³µì‚¬
          mkdir -p "${ISO_ROOT}/spring-boot-app"
          cp ${{ env.TARGET_DIR }}/target/*.jar "${ISO_ROOT}/spring-boot-app/" || echo "No JAR found"

          # README ì‘ì„±
          echo "Apache Maven ${VERSION} ISO Bundle" > "${ISO_ROOT}/README.txt"
          echo "Built on $(date)" >> "${ISO_ROOT}/README.txt"
          echo "Contains: Maven Binary, Extracted Folder, and Spring PetClinic Example JAR" >> "${ISO_ROOT}/README.txt"

          # ISO ìƒì„± (mkisofs ì‚¬ìš©)
          ISO_FILENAME="dump/apache-maven-${VERSION}-bundle.iso"
          mkisofs -o "${ISO_FILENAME}" -J -R -V "Maven-${VERSION}" "${ISO_ROOT}"
          
          echo "âœ… ISO Created: ${ISO_FILENAME}"
          ls -lh "${ISO_FILENAME}"

      # 7. ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ (ISO í¬í•¨)
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "maven-${{ matrix.maven-version }}"
          name: "Apache Maven ${{ matrix.maven-version }} + ISO Bundle"
          body: |
            ## Apache Maven ${{ matrix.maven-version }} Released
            
            This release includes an **ISO image** containing the Maven binaries and a verified Spring Boot application.
            
            ### ğŸ“¦ Assets
            - **ğŸ’¿ ISO Image:** `apache-maven-${{ matrix.maven-version }}-bundle.iso` (Mountable image)
            - **ğŸ“¦ Archive:** `apache-maven-${{ matrix.maven-version }}-bin.tar.gz`
            - **ğŸ“‚ Extracted:** `apache-maven-${{ matrix.maven-version }}-extracted.tar.gz`
            
            ### âœ… Verification
            - **Build Target:** `spring-projects/spring-petclinic`
            - **Java Version:** JDK 17
            - **Status:** Build Passed
            
            *Automated ISO generation by GitHub Actions.*
          artifacts: |
            dump/apache-maven-${{ matrix.maven-version }}-bin.tar.gz
            dump/apache-maven-${{ matrix.maven-version }}-extracted.tar.gz
            dump/apache-maven-${{ matrix.maven-version }}-bundle.iso
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
