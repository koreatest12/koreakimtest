name: Korea Population & Financial Simulator (Mass Data ISO)

on:
  # 1. 10ë¶„ ì£¼ê¸° ìë™ ì‹¤í–‰
  schedule:
    - cron: '*/10 * * * *'
  # 2. ìˆ˜ë™ ì‹¤í–‰ (ê³ ê° ìˆ˜ ë° ê±°ë˜ ìˆ˜ ì¡°ì ˆ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      active_customer_count:
        description: 'Active Customers (Max 300,000)'
        required: false
        default: '100000' # ê¸°ë³¸ 10ë§Œ ëª… (í…ŒìŠ¤íŠ¸ ì†ë„ ê³ ë ¤)
      transaction_count:
        description: 'Transactions per Sector'
        required: false
        default: '5000'

permissions:
  contents: write

jobs:
  korea-population-build:
    name: Korea Pop. Build (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: korea-fin-sim-engine

    steps:
      # --- [ê¸°ë³¸ í™˜ê²½ ì„¤ì •] ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Tools (ISO, ClamAV, Sysstat)
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage clamav sysstat
          sudo freshclam || echo "âš ï¸ ClamAV DB update skipped."

      # --- [ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§] ---
      - name: Start Monitoring
        run: |
          mkdir -p logs
          echo "Timestamp | CPU | MEM | IO | User | System" > logs/sys_monitor.log
          vmstat -t 5 > logs/vmstat_raw.log &

      # --- [Maven ì„¤ì •] ---
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY="https://dlcdn.apache.org/maven/maven-3/${VERSION}/binaries/${FILENAME}"
          ARCHIVE="https://archive.apache.org/dist/maven/maven-3/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded Maven"
          else
            curl -fL "${ARCHIVE}" -o "${ARCHIVE_PATH}"
          fi

          tar -xzf "${ARCHIVE_PATH}" -C extracted/ --strip-components=1
          echo "MAVEN_HOME=${PWD}/extracted" >> "$GITHUB_ENV"
          echo "${PWD}/extracted/bin" >> "$GITHUB_PATH"

      # --- [ëŒ€í•œë¯¼êµ­ ì¸êµ¬ ë° ê¸ˆìœµ ì‹œë®¬ë ˆì´í„° ì†ŒìŠ¤ ìƒì„±] ---
      - name: Generate Korea Simulation Source
        run: |
          set -euo pipefail
          SRC_DIR="${APP_NAME}/src/main/java/com/korea/finance"
          mkdir -p "${SRC_DIR}"
          
          # 1. POM.xml
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.korea</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
          </project>
          EOF

          # 2. Java Main Logic (ì¸êµ¬ í†µê³„ + ê³ ê° ìƒì„± + ê¸ˆìœµ ê±°ë˜)
          cat <<EOF > "${SRC_DIR}/KoreaFinSimulator.java"
          package com.korea.finance;
          
          import java.io.*;
          import java.text.DecimalFormat;
          import java.time.LocalDateTime;
          import java.util.*;

          public class KoreaFinSimulator {
              // ëŒ€í•œë¯¼êµ­ ì¸êµ¬ ìƒìˆ˜ (2024 ì¶”ê³„)
              static final long TOTAL_POPULATION_KR = 51_750_000L;
              
              static List<String> customerSql = new ArrayList<>();
              static List<String> transactionSql = new ArrayList<>();
              static List<String> customerIds = new ArrayList<>(); // FK ì°¸ì¡°ìš©
              static Random rand = new Random();

              // í•œêµ­ ì´ë¦„ ë°ì´í„°
              static String[] lastNames = {"Kim", "Lee", "Park", "Choi", "Jung", "Kang", "Cho", "Yoon", "Jang", "Lim"};
              static String[] firstNamesM = {"Min-jun", "Seo-jun", "Do-yoon", "Ye-jun", "Si-woo", "Ha-jun", "Ji-ho"};
              static String[] firstNamesF = {"Seo-ah", "Ha-yoon", "Ji-an", "Seo-yoon", "Ha-eun", "Ji-woo", "Su-ah"};
              
              // ì§€ì—­ ë¶„í¬ (ê°€ì¤‘ì¹˜ ì ìš©)
              static String[] regions = {"Seoul", "Gyeonggi", "Busan", "Incheon", "Daegu", "Daejeon", "Gwangju", "Ulsan", "Sejong", "Gangwon", "Chungbuk", "Chungnam", "Jeonbuk", "Jeonnam", "Gyeongbuk", "Gyeongnam", "Jeju"};
              static double[] regionWeights = {0.18, 0.26, 0.06, 0.06, 0.04, 0.03, 0.03, 0.02, 0.01, 0.03, 0.03, 0.04, 0.03, 0.03, 0.05, 0.06, 0.01};

              public static void main(String[] args) throws IOException {
                  int activeUserCount = Integer.parseInt(args.length > 0 ? args[0] : "100000"); // Max 30ë§Œ
                  int txCount = Integer.parseInt(args.length > 1 ? args[1] : "5000");

                  System.out.println("=== KOREA POPULATION & FINANCE SIMULATOR ===");
                  System.out.println("Total KR Population: " + new DecimalFormat("#,###").format(TOTAL_POPULATION_KR));
                  System.out.println("Simulating Active Users: " + new DecimalFormat("#,###").format(activeUserCount));

                  // 1. ì¸êµ¬ í†µê³„ ë³´ê³ ì„œ ìƒì„±
                  generatePopulationReport();

                  // 2. ëŒ€ìš©ëŸ‰ ê³ ê° ë°ì´í„° ìƒì„± (ì‹¤ëª…, ì£¼ë¯¼ë²ˆí˜¸, ì£¼ì†Œ)
                  generateCustomers(activeUserCount);

                  // 3. ê¸ˆìœµ/ì£¼ì‹/ì½”ì¸ ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜ (ìƒì„±ëœ ê³ ê° ê¸°ë°˜)
                  simulateTransactions(txCount);

                  // 4. SQL íŒŒì¼ ì¶œë ¥
                  exportSqlFiles();
                  
                  System.out.println("âœ… Simulation Complete.");
              }

              private static void generatePopulationReport() throws IOException {
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_Korea_Demographics.txt"))) {
                      pw.println("=== Republic of Korea Demographics Report ===");
                      pw.println("Base Population: " + new DecimalFormat("#,###").format(TOTAL_POPULATION_KR));
                      pw.println("Generated Date: " + LocalDateTime.now());
                      pw.println("---------------------------------------------");
                      
                      pw.println("[Regional Distribution Estimate]");
                      for(int i=0; i<regions.length; i++) {
                          long regionalPop = (long)(TOTAL_POPULATION_KR * regionWeights[i]);
                          pw.printf("%-10s : %15s (%.1f%%)\n", regions[i], new DecimalFormat("#,###").format(regionalPop), regionWeights[i]*100);
                      }
                      pw.println("---------------------------------------------");
                      pw.println("Note: This data is statistically generated based on 2024 projections.");
                  }
              }

              private static void generateCustomers(int count) {
                  customerSql.add("-- Active Customer Data (" + count + " rows)");
                  customerSql.add("INSERT INTO customers (cust_id, name, gender, age, region, credit_score, created_at) VALUES ");

                  for(int i=0; i<count; i++) {
                      String custId = "CUST-" + String.format("%07d", i+1);
                      customerIds.add(custId);

                      boolean isMale = rand.nextBoolean();
                      String lastName = lastNames[rand.nextInt(lastNames.length)];
                      String firstName = isMale ? firstNamesM[rand.nextInt(firstNamesM.length)] : firstNamesF[rand.nextInt(firstNamesF.length)];
                      String name = lastName + " " + firstName;
                      
                      // ì—°ë ¹ ë¶„í¬ ì‹œë®¬ë ˆì´ì…˜ (ê²½ì œí™œë™ì¸êµ¬ ì¤‘ì‹¬)
                      int age = 20 + rand.nextInt(60); 
                      String region = getWeightedRegion();
                      int creditScore = 300 + rand.nextInt(700); // 300~1000

                      String row = String.format("('%s', '%s', '%s', %d, '%s', %d, NOW())", custId, name, isMale?"M":"F", age, region, creditScore);
                      
                      // Bulk Insert ìµœì í™”ë¥¼ ìœ„í•´ 1000ê°œì”© ëŠê±°ë‚˜, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬ (ì‹¤ì œ íŒŒì¼ì—ì„  ì½¤ë§ˆ ì²˜ë¦¬ í•„ìš”)
                      customerSql.add(row + (i == count-1 ? ";" : ","));
                  }
                  System.out.println("Generated " + count + " customer records.");
              }

              private static String getWeightedRegion() {
                  double r = rand.nextDouble();
                  double cumulative = 0.0;
                  for(int i=0; i<regionWeights.length; i++) {
                      cumulative += regionWeights[i];
                      if(r <= cumulative) return regions[i];
                  }
                  return "Seoul";
              }

              private static void simulateTransactions(int count) {
                  transactionSql.add("-- Financial Transactions Linked to Customers");
                  
                  // Banking
                  for(int i=0; i<count; i++) {
                      String custId = customerIds.get(rand.nextInt(customerIds.size())); // Random Active Customer
                      long amount = (rand.nextInt(100) + 1) * 10000L;
                      String type = rand.nextBoolean() ? "DEPOSIT" : "WITHDRAWAL";
                      transactionSql.add(String.format("INSERT INTO bank_tx (tx_id, cust_id, type, amount, created_at) VALUES ('%s', '%s', '%s', %d, NOW());", UUID.randomUUID(), custId, type, amount));
                  }
                  
                  // Stock
                  String[] stocks = {"SamsungElec", "SKHynix", "LGChem", "HyundaiMotor", "Naver"};
                  for(int i=0; i<count; i++) {
                      String custId = customerIds.get(rand.nextInt(customerIds.size()));
                      String symbol = stocks[rand.nextInt(stocks.length)];
                      int qty = rand.nextInt(50) + 1;
                      double price = 50000 + rand.nextInt(100000);
                      transactionSql.add(String.format("INSERT INTO stock_orders (order_id, cust_id, symbol, qty, price, created_at) VALUES ('%s', '%s', '%s', %d, %.2f, NOW());", UUID.randomUUID(), custId, symbol, qty, price));
                  }

                  // Crypto
                  String[] coins = {"BTC", "ETH", "XRP"};
                  for(int i=0; i<count; i++) {
                      String custId = customerIds.get(rand.nextInt(customerIds.size()));
                      String coin = coins[rand.nextInt(coins.length)];
                      double qty = rand.nextDouble();
                      double price = 1000000 + rand.nextInt(50000000);
                      transactionSql.add(String.format("INSERT INTO crypto_tx (tx_id, cust_id, coin, qty, price_krw, created_at) VALUES ('%s', '%s', '%s', %.6f, %.2f, NOW());", UUID.randomUUID(), custId, coin, qty, price));
                  }
              }

              private static void exportSqlFiles() throws IOException {
                  // Schema
                  try(PrintWriter pw = new PrintWriter(new FileWriter("korea_db_schema.sql"))) {
                      pw.println("CREATE TABLE customers (cust_id VARCHAR(20) PRIMARY KEY, name VARCHAR(50), gender CHAR(1), age INT, region VARCHAR(20), credit_score INT, created_at TIMESTAMP);");
                      pw.println("CREATE TABLE bank_tx (tx_id VARCHAR(40) PRIMARY KEY, cust_id VARCHAR(20), type VARCHAR(10), amount BIGINT, created_at TIMESTAMP);");
                      pw.println("CREATE TABLE stock_orders (order_id VARCHAR(40) PRIMARY KEY, cust_id VARCHAR(20), symbol VARCHAR(20), qty INT, price DECIMAL(15,2), created_at TIMESTAMP);");
                      pw.println("CREATE TABLE crypto_tx (tx_id VARCHAR(40) PRIMARY KEY, cust_id VARCHAR(20), coin VARCHAR(10), qty DECIMAL(20,8), price_krw DECIMAL(20,2), created_at TIMESTAMP);");
                  }
                  
                  // Data
                  try(PrintWriter pw = new PrintWriter(new FileWriter("korea_customer_data.sql"))) {
                      for(String s : customerSql) pw.println(s);
                  }
                  try(PrintWriter pw = new PrintWriter(new FileWriter("korea_transaction_data.sql"))) {
                      for(String s : transactionSql) pw.println(s);
                  }
              }
          }
          EOF
          echo "âœ… Source Code Generated."

      # --- [ë¹Œë“œ ë° ì‹¤í–‰] ---
      - name: Build & Simulate
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          
          echo "Building with Maven ${{ matrix.maven-version }}..."
          mvn -q -B clean package
          
          # ì…ë ¥ê°’: ê³ ê° ìˆ˜(inputs.active_customer_count), ê±°ë˜ ìˆ˜(inputs.transaction_count)
          echo "Running Simulation for ${{ inputs.active_customer_count }} customers..."
          java -Xms512m -Xmx2048m -cp "target/${APP_NAME}-1.0.0.jar" com.korea.finance.KoreaFinSimulator ${{ inputs.active_customer_count }} ${{ inputs.transaction_count }}
          
          # ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
          mkdir -p ../artifacts
          mv *.sql ../artifacts/
          mv *.txt ../artifacts/
          cp target/*.jar ../artifacts/

      # --- [ë³´ì•ˆ ê²€ì‚¬] ---
      - name: Security Scan
        run: |
          mkdir -p logs
          if clamscan -r -i artifacts > logs/virus_scan.log; then
            echo "âœ… Virus Scan Passed." >> logs/virus_scan.log
          else
            echo "âš ï¸ Virus Check Warning." >> logs/virus_scan.log
          fi

      # --- [ISO íŒ¨í‚¤ì§•] ---
      - name: Create ISO Bundle
        run: |
          VERSION="${{ matrix.maven-version }}"
          ROOT="iso_root"
          mkdir -p "${ROOT}/System"
          mkdir -p "${ROOT}/Data_SQL"
          mkdir -p "${ROOT}/Reports"
          mkdir -p "${ROOT}/Security_Logs"

          # 1. íŒŒì¼ ì´ë™
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ROOT}/System/"
          cp "artifacts/${APP_NAME}-1.0.0.jar" "${ROOT}/System/"
          
          cp artifacts/*.sql "${ROOT}/Data_SQL/"
          cp artifacts/*.txt "${ROOT}/Reports/"
          
          # ëª¨ë‹ˆí„°ë§ ë¡œê·¸
          pkill vmstat || true
          cat logs/vmstat_raw.log >> logs/sys_monitor.log
          cp logs/*.log "${ROOT}/Security_Logs/"

          # 2. ISO ìƒì„±
          echo "Korea Population & Finance Sim - Maven ${VERSION}" > "${ROOT}/README.txt"
          mkisofs -o "dump/Korea-FinSim-Maven-${VERSION}.iso" -J -R -V "KOR-FIN-${VERSION}" "${ROOT}"
          
          echo "âœ… ISO Created."
          ls -lh dump/*.iso

      # --- [ë¦´ë¦¬ì¦ˆ] ---
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-korea-pop-sim"
          name: "Korea Population & FinSim (Maven ${{ matrix.maven-version }})"
          body: |
            ## ğŸ‡°ğŸ‡· Korea Population & Financial Simulator
            **Built with Apache Maven ${{ matrix.maven-version }}**
            
            This release simulates the entire **South Korean Population (51.7M)** statistically and generates massive active user data.
            
            ### ğŸ’¿ ISO Contents
            #### 1. ğŸ‘¥ Population & Customer Data (`/Data_SQL`)
            - `korea_db_schema.sql`: Tables for Customers, Banking, Stock, Crypto.
            - `korea_customer_data.sql`: **INSERT SQL for ${{ inputs.active_customer_count }} Active Users** (Names, Region, Credit Score).
            - `Report_Korea_Demographics.txt`: Statistical breakdown of 51.7M population (Seoul 18%, Gyeonggi 26%, etc.).
            
            #### 2. ğŸ’° Financial Transactions
            - `korea_transaction_data.sql`: Linked transactions (Deposit, Stock Buy/Sell, Crypto Bid/Ask) for the generated customers.
            
            #### 3. ğŸ›¡ï¸ Security
            - `virus_scan.log`: ClamAV Scan Result.
            - `sys_monitor.log`: Server resource usage during simulation.
            
            *Automated schedule: Every 10 minutes.*
          artifacts: "dump/*.iso"
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
