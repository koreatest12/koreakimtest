name: Korea Finance Massive Data & Security ISO

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      active_customer_count:
        description: 'Active Customers'
        required: false
        default: '50000'
      transaction_count:
        description: 'Transactions'
        required: false
        default: '3000'

permissions:
  contents: write

jobs:
  korea-massive-build:
    name: Massive Data Build (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: korea-fin-engine

    steps:
      # --- [1. ÌôòÍ≤Ω ÏÑ§Ï†ï] ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # --- [2. ÎèÑÍµ¨ ÏÑ§Ïπò Î∞è ClamAV ÏÑ§Ï†ï (Í≤ΩÍ≥† ÏôÑÌôî)] ---
      - name: Install Tools & Configure ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage clamav clamav-daemon sysstat tree
          
          echo "üõë Stopping conflicting ClamAV daemon to release lock..."
          sudo systemctl stop clamav-freshclam || true
          
          echo "üîß Creating missing socket directories to suppress warnings..."
          sudo mkdir -p /var/run/clamav
          sudo chown clamav:clamav /var/run/clamav
          sudo chmod 755 /var/run/clamav
          
          echo "üîß Fixing log permissions..."
          sudo touch /var/log/clamav/freshclam.log
          sudo chown -R clamav:clamav /var/log/clamav
          
          echo "üîÑ Running Freshclam update..."
          # ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ clamd Ïó∞Í≤∞ Ïã§Ìå® Í≤ΩÍ≥†Îäî CLI Î™®ÎìúÏóêÏÑú Ï†ïÏÉÅÏù¥ÎØÄÎ°ú || trueÎ°ú ÎÑòÏñ¥Í∞ê
          sudo freshclam || echo "‚ö†Ô∏è Update finished with warnings (Expected)."

      # --- [3. Î¶¨ÏÜåÏä§ Î™®ÎãàÌÑ∞ÎßÅ] ---
      - name: Start Monitoring
        run: |
          mkdir -p logs
          echo "| Timestamp | CPU% | MEM% | IO Wait |" > logs/sys_monitor.md
          echo "|---|---|---|---|" >> logs/sys_monitor.md
          vmstat -t 5 | awk '{print "| " $18 " " $19 " | " $13 " | " $4 " | " $16 " |"}' >> logs/vmstat_raw.log &

      # --- [4. Maven ÏÑ§Ïπò] ---
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY="https://dlcdn.apache.org/maven/maven-3/${VERSION}/binaries/${FILENAME}"
          ARCHIVE="https://archive.apache.org/dist/maven/maven-3/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY}" -o "${ARCHIVE_PATH}"; then
            echo "‚úÖ Downloaded Maven"
          else
            curl -fL "${ARCHIVE}" -o "${ARCHIVE_PATH}"
          fi

          tar -xzf "${ARCHIVE_PATH}" -C extracted/ --strip-components=1
          echo "MAVEN_HOME=${PWD}/extracted" >> "$GITHUB_ENV"
          echo "${PWD}/extracted/bin" >> "$GITHUB_PATH"

      # --- [5. ÎåÄÎüâ ÌååÏùº Î∞è ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± (Massive Generation)] ---
      - name: Generate Massive File Structure
        run: |
          set -euo pipefail
          MASSIVE_ROOT="massive_storage/legacy_archives"
          mkdir -p "${MASSIVE_ROOT}"
          
          echo "üöÄ Starting Massive File Generation..."
          echo "Generating Years > Branches > Depts > Logs..."
          
          # 3ÎÖÑÏπò Îç∞Ïù¥ÌÑ∞ (2022~2024)
          for year in {2022..2024}; do
            # Í∞Å Ïó∞ÎèÑÎ≥Ñ 10Í∞ú ÏßÄÏ†ê
            for branch in {001..010}; do
               # Í∞Å ÏßÄÏ†êÎ≥Ñ 5Í∞ú Î∂ÄÏÑú
               for dept in "Loan" "Forex" "Deposit" "VIP" "Audit"; do
                  DIR_PATH="${MASSIVE_ROOT}/${year}/Branch_${branch}/${dept}"
                  mkdir -p "${DIR_PATH}"
                  
                  # Í∞Å Ìè¥ÎçîÏóê 20Í∞úÏùò ÎçîÎØ∏ Î°úÍ∑∏ ÌååÏùº ÏÉùÏÑ±
                  for file_num in {1..20}; do
                     echo "Encrypted Transaction Log - ${year} - ${branch} - ${dept} - ${file_num}" > "${DIR_PATH}/tx_log_${file_num}.dat"
                  done
               done
            done
          done
          
          # ÌååÏùº Í∞úÏàò ÌôïÏù∏
          FILE_COUNT=$(find massive_storage -type f | wc -l)
          DIR_COUNT=$(find massive_storage -type d | wc -l)
          
          echo "‚úÖ Massive Generation Complete."
          echo "Total Files Created: ${FILE_COUNT}"
          echo "Total Directories: ${DIR_COUNT}"
          
          # Íµ¨Ï°∞ ÏöîÏïΩ ÌååÏùº ÏÉùÏÑ±
          tree massive_storage -L 3 > massive_structure_summary.txt

      # --- [6. ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ ÏÜåÏä§ ÏÉùÏÑ±] ---
      - name: Generate Simulator Source
        run: |
          set -euo pipefail
          SRC_DIR="${APP_NAME}/src/main/java/com/korea/sim"
          mkdir -p "${SRC_DIR}"
          
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.korea</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
            <dependencies>
                <dependency>
                    <groupId>org.apache.commons</groupId>
                    <artifactId>commons-lang3</artifactId>
                    <version>3.12.0</version>
                </dependency>
            </dependencies>
          </project>
          EOF

          cat <<EOF > "${SRC_DIR}/KoreaSimApp.java"
          package com.korea.sim;
          import java.io.*;
          import java.text.DecimalFormat;
          import java.time.LocalDateTime;

          public class KoreaSimApp {
              public static void main(String[] args) throws IOException {
                  System.out.println("=== KOREA FINANCE MASSIVE SIMULATION ===");
                  generateReport();
              }
              private static void generateReport() throws IOException {
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_Executive.md"))) {
                      pw.println("# üá∞üá∑ Massive System Report");
                      pw.println("- **Build Time:** " + LocalDateTime.now());
                      pw.println("- **Data Status:** Massive Archives Generated");
                  }
              }
          }
          EOF

      # --- [7. ÎπåÎìú] ---
      - name: Build
        run: |
          cd "${APP_NAME}"
          mvn -q -B clean package
          cp target/*.jar ../

      # --- [8. Ï¢ÖÏÜçÏÑ± Î∞è Î≥¥Ïïà Î∂ÑÏÑù (ÎåÄÎüâ ÌååÏùº Ìè¨Ìï®)] ---
      - name: Security & Dependency Analysis
        run: |
          # Dependency Tree
          cd "${APP_NAME}"
          mvn -q dependency:tree -DoutputFile=../dep_tree.txt
          cd ..
          
          # Î≥¥Ïïà Î¶¨Ìè¨Ìä∏ ÏûëÏÑ±
          echo "# üõ°Ô∏è Security Audit Report" > Report_Security.md
          echo "## üì¶ SBOM (Dependencies)" >> Report_Security.md
          echo '```' >> Report_Security.md
          cat dep_tree.txt >> Report_Security.md
          echo '```' >> Report_Security.md

      # --- [9. Î∞îÏù¥Îü¨Ïä§ Ïä§Ï∫î (ÎåÄÎüâ ÌååÏùº ÎåÄÏÉÅ)] ---
      - name: Massive ClamAV Scan
        run: |
          echo "## ü¶† Massive Files ClamAV Scan" >> Report_Security.md
          echo "Target: Artifacts + Massive Storage Directory" >> Report_Security.md
          echo '```' >> Report_Security.md
          
          # ÏïÑÌã∞Ìå©Ìä∏ Î∞è ÎåÄÎüâ ÏÉùÏÑ±Îêú Ìè¥Îçî Ï†ÑÏ≤¥ Ïä§Ï∫î
          # -r: Ïû¨Í∑Ä, -i: Í∞êÏóºÎßå Ï∂úÎ†• (ÎÑàÎ¨¥ ÎßéÏúºÎØÄÎ°ú), --bell: ÏïåÎ¶º
          if clamscan -r -i massive_storage "${APP_NAME}" *.jar > logs/clamav_massive.log; then
             echo "‚úÖ All Massive Files: CLEAN" >> Report_Security.md
          else
             echo "‚ö†Ô∏è THREAT DETECTED" >> Report_Security.md
          fi
          
          # Î°úÍ∑∏ ÏöîÏïΩ Ï∂îÍ∞Ä
          tail -n 10 logs/clamav_massive.log >> Report_Security.md
          echo '```' >> Report_Security.md
          
          echo "‚úÖ Massive Scan Completed."

      # --- [10. Î¶¨ÏÜåÏä§ Î°úÍ∑∏ Ï¢ÖÎ£å] ---
      - name: Finalize Logs
        run: |
          pkill vmstat || true
          echo "# ‚öôÔ∏è System Resource Logs" > Report_Resources.md
          cat logs/sys_monitor.md >> Report_Resources.md
          cat logs/vmstat_raw.log | awk '{print "| " $0 " |"}' >> Report_Resources.md

      # --- [11. ISO Ìå®ÌÇ§Ïßï (ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®)] ---
      - name: Package Massive ISO
        run: |
          VERSION="${{ matrix.maven-version }}"
          ROOT="iso_root"
          mkdir -p "${ROOT}/00_Reports"
          mkdir -p "${ROOT}/01_Binaries"
          mkdir -p "${ROOT}/02_Massive_Archives"
          mkdir -p "${ROOT}/03_Logs"
          
          # Î≥¥Í≥†ÏÑú Î≥µÏÇ¨
          cp Report_*.md "${ROOT}/"
          cp Report_*.md "${ROOT}/00_Reports/"
          cp massive_structure_summary.txt "${ROOT}/00_Reports/"
          
          # Î∞îÏù¥ÎÑàÎ¶¨ Î≥µÏÇ¨
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ROOT}/01_Binaries/"
          cp *.jar "${ROOT}/01_Binaries/"
          
          # ÎåÄÎüâ ÌååÏùº ÏïÑÏπ¥Ïù¥Îπô (Í∑∏ÎåÄÎ°ú ÎÑ£ÏúºÎ©¥ ISO ÏÉùÏÑ±Ïù¥ ÎÑàÎ¨¥ ÎäêÎ¶¥ Ïàò ÏûàÏúºÎØÄÎ°ú tarÎ°ú Î¨∂Ïñ¥ÏÑú ISOÏóê ÌÉëÏû¨)
          # ÎåÄÎüâ ÌååÏùº Î∞è ÎîîÎ†âÌÜ†Î¶¨ Í∑∏ÎåÄÎ°ú Î∞òÏòÅ ÏöîÏ≤≠Ïóê Îî∞Îùº Ìè¥Îçî Íµ¨Ï°∞ Ïú†ÏßÄ ÏãúÎèÑ
          # (ÌååÏùº Í∞úÏàòÍ∞Ä ÎßéÏïÑ ISO ÏÉùÏÑ± ÏãúÍ∞ÑÏù¥ Í±∏Î¶¥ Ïàò ÏûàÏùå)
          echo "üì¶ Moving Massive Data to ISO Root..."
          cp -r massive_storage/* "${ROOT}/02_Massive_Archives/"
          
          # Î°úÍ∑∏
          cp logs/*.log "${ROOT}/03_Logs/"
          
          # ISO ÏÉùÏÑ±
          echo "Generating ISO..."
          mkisofs -o "dump/Korea-Massive-Sec-${VERSION}.iso" -J -R -V "MASSIVE-${VERSION}" "${ROOT}"
          
          echo "‚úÖ ISO Created."
          du -sh "dump/Korea-Massive-Sec-${VERSION}.iso"

      # --- [12. Î¶¥Î¶¨Ï¶à] ---
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-massive-iso"
          name: "Massive Data & Security (Maven ${{ matrix.maven-version }})"
          body: |
            ## üá∞üá∑ Massive Data & Security ISO
            **Maven ${{ matrix.maven-version }} | ClamAV Scanned**
            
            This release contains a simulated **Massive Legacy Archive** with thousands of generated files and directories.
            
            ### üìÇ ISO Contents
            - **Massive Archives:** `/02_Massive_Archives` (Year > Branch > Dept Structure)
            - **Security Report:** ClamAV scan results for all generated files.
            - **Resource Log:** CPU/RAM usage during massive file generation.
            
            *Automated by GitHub Actions.*
          artifacts: "dump/*.iso"
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
