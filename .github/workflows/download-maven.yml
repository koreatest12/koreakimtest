name: Korea Finance Security & MD Reporting (Mass Build)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      active_customer_count:
        description: 'Active Customers'
        required: false
        default: '50000'
      transaction_count:
        description: 'Tx per Sector'
        required: false
        default: '3000'

permissions:
  contents: write

jobs:
  korea-security-md-build:
    name: Security & MD Build (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: korea-fin-sec-engine

    steps:
      # --- [í™˜ê²½ ì„¤ì •] ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage clamav sysstat
          sudo freshclam || echo "âš ï¸ ClamAV DB update skipped."

      - name: Start Resource Monitoring
        run: |
          mkdir -p logs
          echo "| Timestamp | CPU% | MEM% | IO Wait |" > logs/sys_monitor.md
          echo "|---|---|---|---|" >> logs/sys_monitor.md
          # Markdown í¬ë§·ìœ¼ë¡œ ë¡œê·¸ ê¸°ë¡ (awk ì‚¬ìš©í•˜ì—¬ íŒŒì´í”„ í¬ë§·íŒ…)
          vmstat -t 5 | awk '{print "| " $18 " " $19 " | " $13 " | " $4 " | " $16 " |"}' >> logs/vmstat_raw.log &

      # --- [Maven ì„¤ì¹˜] ---
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY="https://dlcdn.apache.org/maven/maven-3/${VERSION}/binaries/${FILENAME}"
          ARCHIVE="https://archive.apache.org/dist/maven/maven-3/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded Maven"
          else
            curl -fL "${ARCHIVE}" -o "${ARCHIVE_PATH}"
          fi

          tar -xzf "${ARCHIVE_PATH}" -C extracted/ --strip-components=1
          echo "MAVEN_HOME=${PWD}/extracted" >> "$GITHUB_ENV"
          echo "${PWD}/extracted/bin" >> "$GITHUB_PATH"

      # --- [í†µí•© ì‹œë®¬ë ˆì´í„° ì†ŒìŠ¤ ìƒì„± (Markdown ì—”ì§„ í¬í•¨)] ---
      - name: Generate Simulator with MD Engine
        run: |
          set -euo pipefail
          SRC_DIR="${APP_NAME}/src/main/java/com/korea/sec"
          mkdir -p "${SRC_DIR}"
          
          # 1. POM.xml (ì˜ì¡´ì„± ì¶”ê°€ ì‹œë®¬ë ˆì´ì…˜)
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.korea</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
            <dependencies>
                <!-- Simulation Dependencies for Security Check -->
                <dependency>
                    <groupId>org.apache.commons</groupId>
                    <artifactId>commons-lang3</artifactId>
                    <version>3.12.0</version>
                </dependency>
                <dependency>
                    <groupId>com.google.guava</groupId>
                    <artifactId>guava</artifactId>
                    <version>31.1-jre</version>
                </dependency>
            </dependencies>
          </project>
          EOF

          # 2. Java Main Logic (MD Reports + Security Logic)
          cat <<EOF > "${SRC_DIR}/KoreaSecSimulator.java"
          package com.korea.sec;
          
          import java.io.*;
          import java.text.DecimalFormat;
          import java.time.LocalDateTime;
          import java.util.*;

          public class KoreaSecSimulator {
              static final long POPULATION = 51_750_000L;
              static Random rand = new Random();
              static List<String> regions = Arrays.asList("Seoul", "Gyeonggi", "Busan", "Incheon", "Daegu");
              
              // í†µê³„ ì§‘ê³„ìš© ë³€ìˆ˜
              static long totalBankVol = 0;
              static long totalStockVol = 0;
              static long totalCryptoVol = 0;
              
              public static void main(String[] args) throws IOException {
                  int custCount = Integer.parseInt(args.length > 0 ? args[0] : "50000");
                  int txCount = Integer.parseInt(args.length > 1 ? args[1] : "3000");

                  System.out.println("=== KOREA FINANCE SECURITY SIMULATOR ===");
                  
                  // 1. Data Simulation
                  simulateData(custCount, txCount);

                  // 2. Generate Markdown Reports
                  generateMdReports(custCount, txCount);
                  
                  System.out.println("âœ… Markdown Reports Generated.");
              }

              private static void simulateData(int custCount, int txCount) {
                  // ê°„ë‹¨í•œ í†µê³„ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ë°ì´í„° ìƒì„±ì€ ì´ì „ ë‹¨ê³„ ë¡œì§ê³¼ ë™ì¼í•˜ë‹¤ê³  ê°€ì •í•˜ê³  ìš”ì•½ë§Œ ì²˜ë¦¬)
                  for(int i=0; i<txCount; i++) {
                      totalBankVol += (rand.nextInt(100) + 1) * 10000L;
                      totalStockVol += (rand.nextInt(50) + 1) * 50000L;
                      totalCryptoVol += (rand.nextInt(1000) + 1) * 1000L;
                  }
              }

              private static void generateMdReports(int custCount, int txCount) throws IOException {
                  String date = LocalDateTime.now().toString();
                  DecimalFormat df = new DecimalFormat("#,###");

                  // Report 1: Executive Summary
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_00_Executive_Summary.md"))) {
                      pw.println("# ğŸ“Š Executive Summary: Korea Financial System");
                      pw.println("**Date:** " + date + "  ");
                      pw.println("**Maven Version:** System Build Artifact  ");
                      pw.println("");
                      pw.println("## ğŸ“Œ Key Metrics");
                      pw.println("| Metric | Value |");
                      pw.println("|---|---|");
                      pw.println("| **Total Population** | " + df.format(POPULATION) + " |");
                      pw.println("| **Active Customers** | " + df.format(custCount) + " |");
                      pw.println("| **Total Transactions** | " + df.format(txCount * 3) + " |");
                      pw.println("| **System Status** | ğŸŸ¢ Operational |");
                  }

                  // Report 2: Population
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_01_Population.md"))) {
                      pw.println("# ğŸ‘¥ Korea Demographics Report");
                      pw.println("## Regional Distribution (Simulated)");
                      pw.println("| Region | Population (Est.) | Share |");
                      pw.println("|---|---|---|");
                      pw.println("| Seoul | " + df.format(POPULATION * 0.18) + " | 18% |");
                      pw.println("| Gyeonggi | " + df.format(POPULATION * 0.26) + " | 26% |");
                      pw.println("| Busan | " + df.format(POPULATION * 0.06) + " | 6% |");
                      pw.println("| Others | " + df.format(POPULATION * 0.50) + " | 50% |");
                  }

                  // Report 3: Financial Services
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_02_Financial_Services.md"))) {
                      pw.println("# ğŸ’° Financial Services Report");
                      pw.println("## Transaction Volume by Sector");
                      pw.println("| Sector | Volume (KRW) | Status |");
                      pw.println("|---|---|---|");
                      pw.println("| **Banking** | " + df.format(totalBankVol) + " | Normal |");
                      pw.println("| **Stock Market** | " + df.format(totalStockVol) + " | Active |");
                      pw.println("| **Crypto Asset** | " + df.format(totalCryptoVol) + " | Volatile |");
                      pw.println("");
                      pw.println("## âš ï¸ Anomalies");
                      pw.println("- No major anomalies detected in transaction logs.");
                  }
              }
          }
          EOF
          echo "âœ… Simulator Source Generated."

      # --- [ë¹Œë“œ ë° ì‹¤í–‰] ---
      - name: Build & Run
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          mvn -q -B clean package
          java -cp "target/${APP_NAME}-1.0.0.jar" com.korea.sec.KoreaSecSimulator ${{ inputs.active_customer_count }} ${{ inputs.transaction_count }}
          
          # MD íŒŒì¼ ì´ë™
          mkdir -p ../artifacts/reports
          mv Report_*.md ../artifacts/reports/
          cp target/*.jar ../artifacts/

      # --- [ì¢…ì†ì„± ë° ë³´ì•ˆ ë¶„ì„ (Dependency Submission)] ---
      - name: Dependency & Security Analysis
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          
          # 1. Maven Dependency Tree ìƒì„±
          echo "Generating Dependency Tree..."
          mvn -q dependency:tree -DoutputFile=dependency_tree.txt
          
          # 2. Dependency List ìƒì„±
          mvn -q dependency:list -DoutputFile=dependency_list.txt
          
          # 3. Security Audit Report.md ìƒì„±
          echo "# ğŸ›¡ï¸ Security & Dependency Audit Report" > ../artifacts/reports/Report_03_Security_Audit.md
          echo "**Scan Date:** $(date)" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "" >> ../artifacts/reports/Report_03_Security_Audit.md
          
          echo "## ğŸ“¦ Dependency Tree (SBOM)" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> ../artifacts/reports/Report_03_Security_Audit.md
          cat dependency_tree.txt >> ../artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "" >> ../artifacts/reports/Report_03_Security_Audit.md
          
          echo "## ğŸ” Vulnerability Analysis (Simulated)" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "| Library | Version | Status | Risk |" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "|---|---|---|---|" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "| commons-lang3 | 3.12.0 | âœ… Secure | Low |" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "| guava | 31.1-jre | âœ… Secure | Low |" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "" >> ../artifacts/reports/Report_03_Security_Audit.md

      # --- [ë°”ì´ëŸ¬ìŠ¤ ìŠ¤ìº” ë° ê²°ê³¼ í†µí•©] ---
      - name: Virus Scan Integration
        run: |
          echo "## ğŸ¦  Antivirus Scan (ClamAV)" >> artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> artifacts/reports/Report_03_Security_Audit.md
          
          if clamscan -r -i artifacts > logs/clamav_scan.log; then
            echo "Result: CLEAN" >> artifacts/reports/Report_03_Security_Audit.md
            cat logs/clamav_scan.log >> artifacts/reports/Report_03_Security_Audit.md
          else
            echo "Result: WARNING" >> artifacts/reports/Report_03_Security_Audit.md
          fi
          echo '```' >> artifacts/reports/Report_03_Security_Audit.md

      # --- [ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ë¡œê·¸ ì¶”ê°€] ---
      - name: Finalize Reports
        run: |
          # ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ
          pkill vmstat || true
          
          # ë¦¬ì†ŒìŠ¤ ë³´ê³ ì„œ ìƒì„±
          echo "# âš™ï¸ System Resource Usage" > artifacts/reports/Report_04_System_Resources.md
          echo "Measured during Maven Build & Simulation" >> artifacts/reports/Report_04_System_Resources.md
          cat logs/sys_monitor.md >> artifacts/reports/Report_04_System_Resources.md
          cat logs/vmstat_raw.log | awk '{print "| " $0 " |"}' >> artifacts/reports/Report_04_System_Resources.md

      # --- [ISO íŒ¨í‚¤ì§•] ---
      - name: Package ISO
        run: |
          VERSION="${{ matrix.maven-version }}"
          ROOT="iso_root"
          mkdir -p "${ROOT}/00_Executive_Reports_MD"
          mkdir -p "${ROOT}/01_System_Binaries"
          mkdir -p "${ROOT}/02_Security_Audit"
          
          # 1. Markdown ë³´ê³ ì„œ ë°°ì¹˜ (ìµœìƒìœ„ ì ‘ê·¼ì„±)
          cp artifacts/reports/Report_00_*.md "${ROOT}/"
          cp artifacts/reports/*.md "${ROOT}/00_Executive_Reports_MD/"
          
          # 2. ì‹œìŠ¤í…œ íŒŒì¼
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ROOT}/01_System_Binaries/"
          cp "artifacts/${APP_NAME}-1.0.0.jar" "${ROOT}/01_System_Binaries/"
          
          # 3. ë³´ì•ˆ ê°ì‚¬ ìë£Œ
          cp artifacts/reports/Report_03_Security_Audit.md "${ROOT}/02_Security_Audit/"
          
          # ISO ìƒì„±
          mkisofs -o "dump/Korea-Sec-Report-${VERSION}.iso" -J -R -V "KOR-SEC-${VERSION}" "${ROOT}"
          
          echo "âœ… ISO Created."

      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-sec-md"
          name: "Korea Fin Security & MD Reports (Maven ${{ matrix.maven-version }})"
          body: |
            ## ğŸ‡°ğŸ‡· Korea Finance Security & Markdown Reports
            **Maven ${{ matrix.maven-version }} | Security Submitted**
            
            This release features **Automated Markdown Reporting** and **Dependency/Security Submission**.
            
            ### ğŸ“„ Markdown Reports (Inside ISO)
            - **`Report_00_Executive_Summary.md`**: Dashboard overview of Population & Finance.
            - **`Report_01_Population.md`**: Demographics analysis (Seoul, Gyeonggi, etc.).
            - **`Report_02_Financial_Services.md`**: Banking/Stock/Crypto volume analysis.
            - **`Report_03_Security_Audit.md`**: **SBOM (Dependency Tree)** + **ClamAV Scan Results**.
            - **`Report_04_System_Resources.md`**: Server CPU/RAM usage logs.
            
            ### ğŸ›¡ï¸ Security Features
            - **Dependency Submission:** Maven Dependency Tree analysis included.
            - **Virus Check:** Artifacts scanned with ClamAV.
            
            *Automated by GitHub Actions.*
          artifacts: |
            dump/*.iso
            artifacts/reports/*.md
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
