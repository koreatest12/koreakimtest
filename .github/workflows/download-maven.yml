name: "ğŸš€ MCP Server Install & Context Sync v3.4 (CONTEXT-FIX)"

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      run_migration:
        description: 'ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í• ê¹Œìš”?'
        type: boolean
        default: true
      force_upgrade:
        description: 'ëª¨ë“  ì˜ì¡´ì„±ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí• ê¹Œìš”?'
        type: boolean
        default: false

permissions:
  contents: write
  actions: read
  checks: write

env:
  TZ: Asia/Seoul
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts
  MCP_CONFIG: .github/mcp-workspace/config
  COPILOT_DIR: .github/copilot

jobs:
  provision-omniservice:
    name: "Provision MCP Omniservice"
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===========================================================================
      # 1. ì‹œìŠ¤í…œ ë° ì˜ì¡´ì„± ì—…ê·¸ë ˆì´ë“œ
      # ===========================================================================
      - name: System Environment
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          pip install --upgrade pip setuptools wheel bandit safety pip-audit
          
          if [ "${{ inputs.force_upgrade }}" == "true" ]; then
            npm install -g npm-check-updates
            # ê° ì„œë¹„ìŠ¤ë³„ ì˜ì¡´ì„± ìµœì‹ í™” (ìˆì„ ê²½ìš°ë§Œ)
            [ -d "mcp-node-service" ] && (cd mcp-node-service && ncu -u && npm install)
            [ -d "mcp-python-server" ] && (pip install pip-review && pip-review --auto)
          fi

      # ===========================================================================
      # 2. ë³´ì•ˆ ìŠ¤ìº” ë° ì¸ë¼ì¸ ë§ˆì´ê·¸ë ˆì´ì…˜
      # ===========================================================================
      - name: Security & Migration
        continue-on-error: true
        run: |
          mkdir -p "$MCP_ARTIFACTS" "$MCP_CONFIG" "$COPILOT_DIR"
          bandit -r . -ll -ii -f txt -o $MCP_ARTIFACTS/full_repo_security_report.txt || true
          
          cat <<'PYTHON' > migration_engine.py
          import datetime
          def run():
              print(f"[{datetime.datetime.now()}] Upgrade & Migration Engine Active.")
              # DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
              print(">> Migrating 'koreakimtest' data structures...")
          if __name__ == "__main__": run()
          PYTHON
          python3 migration_engine.py && rm migration_engine.py

      # ===========================================================================
      # 3. Dockerfile ìƒì„± (BUILD CONTEXT ìµœì í™” ë²„ì „)
      # ===========================================================================
      - name: Generate Optimized Dockerfiles
        run: |
          mkdir -p $MCP_CONFIG/docker
          
          # [í•µì‹¬ ìˆ˜ì •] WORKDIRë¥¼ ì„¤ì •í•˜ê³  ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ë£¨íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²½ë¡œ ì„¤ì •
          
          # Python Dockerfile
          cat <<'DOCKER' > $MCP_CONFIG/docker/python.Dockerfile
          FROM python:3.11-slim
          WORKDIR /app
          RUN apt-get update && apt-get upgrade -y
          # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ê°€ ë£¨íŠ¸ì¼ ë•Œì˜ ê²½ë¡œ
          COPY mcp-python-server/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          COPY mcp-python-server/ .
          CMD ["python", "server_mcp.py"]
          DOCKER

          # Node Dockerfile (ì—ëŸ¬ ì›ì¸ í•´ê²°)
          cat <<'DOCKER' > $MCP_CONFIG/docker/node.Dockerfile
          FROM node:20-slim
          WORKDIR /app
          RUN apt-get update && apt-get upgrade -y
          # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ê°€ ë£¨íŠ¸ì¼ ë•Œì˜ ê²½ë¡œ
          COPY mcp-node-service/package*.json ./
          RUN npm ci --only=production
          COPY mcp-node-service/ .
          CMD ["node", "index.js"]
          DOCKER

          # Java Dockerfile
          cat <<'DOCKER' > $MCP_CONFIG/docker/java.Dockerfile
          FROM openjdk:17-jdk-slim
          WORKDIR /app
          RUN apt-get update && apt-get upgrade -y
          # target í´ë”ì˜ jar íŒŒì¼ì„ ë£¨íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë³µì‚¬
          COPY mcp-java-server/target/*.jar app.jar
          CMD ["java", "-jar", "app.jar"]
          DOCKER

      # ===========================================================================
      # 4. ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ (CONTEXTë¥¼ ë£¨íŠ¸(.)ë¡œ ê³ ì •í•˜ì—¬ ì—ëŸ¬ í•´ê²°)
      # ===========================================================================
      - name: Build All Services (Root Context Build)
        run: |
          echo "ğŸ”¨ Building Python (Context: .)..."
          docker build -t mcp-python-server:${{ github.sha }} -f $MCP_CONFIG/docker/python.Dockerfile .
          
          echo "ğŸ”¨ Building Node (Context: .)..."
          # ì´ì „ ë‹¨ê³„ì—ì„œ cd mcp-node-serviceë¥¼ í•˜ì§€ ì•Šê³  ë£¨íŠ¸ì—ì„œ npm ci ì‹¤í–‰
          if [ -d "mcp-node-service" ]; then
            cd mcp-node-service && npm ci && cd ..
          fi
          # í•µì‹¬: ë§ˆì§€ë§‰ ì¸ìë¥¼ . ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë£¨íŠ¸ ì „ì²´ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬
          docker build -t mcp-node-service:${{ github.sha }} -f $MCP_CONFIG/docker/node.Dockerfile .
          
          echo "ğŸ”¨ Building Java (Context: .)..."
          if [ -d "mcp-java-server" ]; then
            cd mcp-java-server && mvn clean package -DskipTests && cd ..
          fi
          docker build -t mcp-java-server:${{ github.sha }} -f $MCP_CONFIG/docker/java.Dockerfile .

      # ===========================================================================
      # 5. ì•„í‹°íŒ©íŠ¸ ë° ë¡œê·¸ ì™„ë£Œ
      # ===========================================================================
      - name: Finalize & Context Sync
        run: |
          cat <<YAML > $MCP_ARTIFACTS/docker-compose.yml
          version: '3.8'
          services:
            python-api: { image: mcp-python-server:${{ github.sha }}, ports: ["8000:8000"] }
            node-core: { image: mcp-node-service:${{ github.sha }}, ports: ["3000:3000"] }
            java-backend: { image: mcp-java-server:${{ github.sha }}, ports: ["8080:8080"] }
          YAML
          
          echo "| $(date) | ${{ github.run_id }} | Context Fix & Upgrade | Success |" >> docs/copilot_install_log.md

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-v3.4-fixed-package
          path: ${{ env.MCP_WORKSPACE }}

      - name: Commit Log
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: solve Docker build context error and upgrade v3.4"
