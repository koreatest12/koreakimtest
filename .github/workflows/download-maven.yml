name: "ğŸš€ MCP Omniservice v3.1 (Scan & Migrate)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_migration:
        description: 'ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í• ê¹Œìš”?'
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  checks: write

env:
  TZ: Asia/Seoul
  MCP_WORKSPACE: .github/mcp-workspace
  MCP_ARTIFACTS: .github/mcp-workspace/artifacts

jobs:
  # 1. ì „ì—­ ë³´ì•ˆ ìŠ¤ìº” ë° í™˜ê²½ ì¤€ë¹„
  security-and-prep:
    name: "Global Security Scan & Workspace Prep"
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Artifact Directory
        run: mkdir -p ${{ env.MCP_ARTIFACTS }}

      - name: Set up Python for Security Tools
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit & Safety
        run: pip install bandit safety

      # [ìˆ˜ì •] ì „ì²´ ë””ë ‰í† ë¦¬ì— ëŒ€í•œ ë³´ì•ˆ ê²€ì‚¬ ìˆ˜í–‰ (koreakimtest ì „ì²´ ëŒ€ìƒ)
      - name: Global Bandit Scan
        continue-on-error: true # ì·¨ì•½ì ì´ ë°œê²¬ë˜ì–´ë„ ë¦¬í¬íŠ¸ë§Œ ìƒì„±í•˜ê³  í”„ë¡œì„¸ìŠ¤ ìœ ì§€
        run: |
          echo "ğŸ” Running Full Repository Security Scan..."
          bandit -r . -ll -ii -f txt -o ${{ env.MCP_ARTIFACTS }}/global_bandit_report.txt
          echo "âœ… Security report generated at artifacts."

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: global-security-report
          path: ${{ env.MCP_ARTIFACTS }}/global_bandit_report.txt

  # 2. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ì¶”ê°€ëœ ê¸°ëŠ¥)
  data-migration:
    name: "Data Migration & Sync"
    needs: security-and-prep
    if: ${{ github.event.inputs.run_migration == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Migration Script
        run: |
          echo "ğŸ”„ Starting Data Migration..."
          # ì—¬ê¸°ì— ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ëª…ë ¹ì–´ ì‘ì„± (ì˜ˆ: alembic upgrade head ë˜ëŠ” ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸)
          # ì˜ˆì‹œ: mcp-python-server ë‚´ì˜ migration.py ì‹¤í–‰
          if [ -f "mcp-python-server/migration.py" ]; then
            python3 mcp-python-server/migration.py
          else
            echo "â„¹ï¸ No migration script found, skipping."
          fi
          echo "âœ… Migration completed."

  # 3. ì„œë¹„ìŠ¤ ë¹Œë“œ ë° ë°°í¬ (ê¸°ì¡´ ë¡œì§ ìµœì í™”)
  build-and-deploy:
    name: "Build Services & Orchestrate"
    needs: data-migration
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # (ê¸°ì¡´ Docker Build ë° Artifact ìƒì„± ë¡œì§ ë™ì¼í•˜ê²Œ ìˆ˜í–‰)
      # ... [ìƒëµ: ì´ì „ v3.0ì˜ Docker build ë¡œì§ ì‚¬ìš©] ...

      - name: Generate Docker Compose
        run: |
          cat <<YAML > docker-compose.yml
          version: '3.8'
          services:
            python-api:
              image: mcp-python-server:${{ github.sha }}
            node-core:
              image: mcp-node-service:${{ github.sha }}
            java-backend:
              image: mcp-java-server:${{ github.sha }}
          YAML

      - name: Commit Log and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(log): Update v3.1 (Security Scan & Migration Complete)"
