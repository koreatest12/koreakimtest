name: Download Apache Maven (3.9.0 ~ 3.9.11)

on:
  workflow_dispatch:

jobs:
  fetch-maven:
    runs-on: ubuntu-latest

    # 3.9.0 ~ 3.9.11 전체 다운로드
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'   # 최신 3.9.x

    env:
      # ✅ 1순위: 공식 CDN (현재 릴리스용)
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      # ✅ 2순위: 공식 아카이브 (옛 버전 보관용, 404 시 여기서 받기)
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create dump directory
        run: mkdir -p dump

      - name: Set Maven version output
        id: maven
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          echo "Selected Maven version: ${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download Apache Maven archive (with archive fallback)
        run: |
          set -euo pipefail

          VERSION="${{ steps.maven.outputs.version }}"

          PRIMARY_URL="${MAVEN_PRIMARY_BASE_URL}/${VERSION}/binaries/apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_URL="${MAVEN_ARCHIVE_BASE_URL}/${VERSION}/binaries/apache-maven-${VERSION}-bin.tar.gz"

          echo "Trying primary URL: ${PRIMARY_URL}"

          # set -e 상태에서도 if 안에서는 실패해도 스크립트가 종료되지 않음
          if curl -fL "${PRIMARY_URL}" -o "dump/apache-maven-${VERSION}-bin.tar.gz"; then
            echo "✅ Downloaded from primary: ${PRIMARY_URL}"
          else
            echo "⚠️ Primary URL failed, trying archive URL: ${ARCHIVE_URL}"
            curl -fL "${ARCHIVE_URL}" -o "dump/apache-maven-${VERSION}-bin.tar.gz"
            echo "✅ Downloaded from archive: ${ARCHIVE_URL}"
          fi

      - name: List dump directory contents
        run: ls -lh dump
