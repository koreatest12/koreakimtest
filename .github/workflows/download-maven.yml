name: Financial BPR Simulation & Maven ISO (Mass Build)

on:
  workflow_dispatch:
    inputs:
      transaction_count:
        description: 'Number of virtual transactions to generate'
        required: false
        default: '1000'

permissions:
  contents: write

jobs:
  financial-simulation-build:
    name: BPR Simulation (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: finance-transaction-system

    steps:
      # 1. í™˜ê²½ ì„¤ì •
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install ISO Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage

      # 2. Maven ì„¤ì¹˜ (ê° ë²„ì „ë³„)
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY_URL="${MAVEN_PRIMARY_BASE_URL}/${VERSION}/binaries/${FILENAME}"
          ARCHIVE_URL="${MAVEN_ARCHIVE_BASE_URL}/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY_URL}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded from Primary"
          else
            echo "âš ï¸ Primary failed, attempting Archive..."
            curl -fL "${ARCHIVE_URL}" -o "${ARCHIVE_PATH}"
          fi

          EXTRACT_DIR="extracted/apache-maven-${VERSION}"
          mkdir -p "${EXTRACT_DIR}"
          tar -xzf "${ARCHIVE_PATH}" -C "${EXTRACT_DIR}" --strip-components=1
          
          echo "MAVEN_HOME=${PWD}/${EXTRACT_DIR}" >> "$GITHUB_ENV"
          echo "${PWD}/${EXTRACT_DIR}/bin" >> "$GITHUB_PATH"

      # 3. [NEW] ê¸ˆìœµ ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜ ì†ŒìŠ¤ ì½”ë“œ ìƒì„±
      # ì…ì¶œê¸ˆ ë¡œì§, ê±°ë˜ ë‚´ì—­ ìƒì„±ê¸°, BPR ë³´ê³ ì„œ ì‘ì„±ê¸°ê°€ í¬í•¨ëœ Java ì½”ë“œë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Generate Financial System Source Code
        run: |
          set -euo pipefail
          mkdir -p "${APP_NAME}/src/main/java/com/bank/core"
          
          # 3-1. POM.xml
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.bank</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
          </project>
          EOF

          # 3-2. Transaction Model (ê±°ë˜ ëª¨ë¸)
          cat <<EOF > "${APP_NAME}/src/main/java/com/bank/core/Transaction.java"
          package com.bank.core;
          import java.time.LocalDateTime;

          public class Transaction {
              private String id;
              private String type; // DEPOSIT, WITHDRAWAL
              private long amount;
              private String description;
              private LocalDateTime timestamp;

              public Transaction(String id, String type, long amount, String description) {
                  this.id = id;
                  this.type = type;
                  this.amount = amount;
                  this.description = description;
                  this.timestamp = LocalDateTime.now();
              }
              
              public String getType() { return type; }
              public long getAmount() { return amount; }
              
              @Override
              public String toString() {
                  return String.format("[%s] ID:%s | %s | %,d KRW | %s", timestamp, id, type, amount, description);
              }
          }
          EOF

          # 3-3. BPR & Simulation Logic (ë©”ì¸ ë¡œì§)
          cat <<EOF > "${APP_NAME}/src/main/java/com/bank/core/BankingSystem.java"
          package com.bank.core;

          import java.io.FileWriter;
          import java.io.IOException;
          import java.io.PrintWriter;
          import java.util.ArrayList;
          import java.util.List;
          import java.util.Random;
          import java.util.UUID;

          public class BankingSystem {
              public static void main(String[] args) throws IOException {
                  int txCount = Integer.parseInt(args.length > 0 ? args[0] : "1000");
                  System.out.println("=== Starting Virtual Real-Transaction Simulation (Tx: " + txCount + ") ===");
                  
                  List<Transaction> transactions = generateTransactions(txCount);
                  generateBPRReport(transactions);
              }

              private static List<Transaction> generateTransactions(int count) {
                  List<Transaction> list = new ArrayList<>();
                  Random rand = new Random();
                  String[] sources = {"ATM", "Mobile App", "Branch Counter", "Auto-Transfer"};
                  
                  for (int i = 0; i < count; i++) {
                      boolean isDeposit = rand.nextBoolean();
                      String type = isDeposit ? "DEPOSIT" : "WITHDRAWAL";
                      // ê°€ìƒ ì‹¤ê±°ë˜ ê¸ˆì•¡ (1,000ì› ~ 10,000,000ì›)
                      long amount = (rand.nextInt(10000) + 1) * 1000L; 
                      String desc = sources[rand.nextInt(sources.length)];
                      
                      list.add(new Transaction(UUID.randomUUID().toString().substring(0,8), type, amount, desc));
                  }
                  return list;
              }

              private static void generateBPRReport(List<Transaction> transactions) throws IOException {
                  long totalDeposit = 0;
                  long totalWithdrawal = 0;
                  int highValueCount = 0;
                  
                  // Report File
                  try (PrintWriter writer = new PrintWriter(new FileWriter("BPR_Analysis_Report.txt"))) {
                      writer.println("=== Business Process Reengineering (BPR) Report ===");
                      writer.println("Generated by Maven Build Automation");
                      writer.println("---------------------------------------------------");
                      
                      for (Transaction tx : transactions) {
                          if (tx.getType().equals("DEPOSIT")) {
                              totalDeposit += tx.getAmount();
                          } else {
                              totalWithdrawal += tx.getAmount();
                          }
                          
                          if (tx.getAmount() >= 5000000) {
                              highValueCount++;
                              writer.println("[High Value Alert] " + tx);
                          }
                      }
                      
                      long netFlow = totalDeposit - totalWithdrawal;
                      
                      writer.println("---------------------------------------------------");
                      writer.println("1. Total Transactions : " + transactions.size());
                      writer.println("2. Total Deposit Vol  : " + String.format("%,d KRW", totalDeposit));
                      writer.println("3. Total Withdraw Vol : " + String.format("%,d KRW", totalWithdrawal));
                      writer.println("4. Net Asset Flow     : " + String.format("%,d KRW", netFlow));
                      writer.println("5. High Value Tx Count: " + highValueCount);
                      writer.println("---------------------------------------------------");
                      writer.println("BPR Conclusion: System handled transaction load successfully.");
                  }
                  
                  System.out.println("âœ… BPR Report Generated: BPR_Analysis_Report.txt");
              }
          }
          EOF
          
          echo "âœ… Financial System Source Code Generated."

      # 4. ì‹œìŠ¤í…œ ë¹Œë“œ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (Maven)
      - name: Build & Run Simulation
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          
          # Maven Build
          echo "Building with Maven ${{ matrix.maven-version }}..."
          mvn -q -B clean package
          
          # Run Simulation (ê°€ìƒ ê±°ë˜ 1000ê±´ ìƒì„± -> BPR ë³´ê³ ì„œ ì¶œë ¥)
          echo "Running Transaction Simulation..."
          java -cp "target/${APP_NAME}-1.0.0.jar" com.bank.core.BankingSystem ${{ inputs.transaction_count }}
          
          # ê²°ê³¼ í™•ì¸
          cat BPR_Analysis_Report.txt
          
          # ì•„í‹°íŒ©íŠ¸ ì´ë™ ì¤€ë¹„
          mkdir -p ../generated_reports
          mv BPR_Analysis_Report.txt ../generated_reports/BPR_Report_Maven_${{ matrix.maven-version }}.txt
          cp "target/${APP_NAME}-1.0.0.jar" ../generated_reports/FinanceSystem.jar

      # 5. ISO ìƒì„± (BPR ë³´ê³ ì„œ ë° ì‹¤í–‰ ë°ì´í„° ì£¼ì…)
      - name: Create ISO with BPR Data
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          ISO_ROOT="iso_root"
          mkdir -p "${ISO_ROOT}/maven-dist"
          mkdir -p "${ISO_ROOT}/financial-reports/bpr"
          mkdir -p "${ISO_ROOT}/financial-system"

          # 5-1. Maven ë°”ì´ë„ˆë¦¬ íƒ‘ì¬
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ISO_ROOT}/maven-dist/"
          
          # 5-2. ìƒì„±ëœ BPR ë³´ê³ ì„œ ë° ì‹œìŠ¤í…œ íƒ‘ì¬
          cp "generated_reports/BPR_Report_Maven_${VERSION}.txt" "${ISO_ROOT}/financial-reports/bpr/Analysis_Report.txt"
          cp "generated_reports/FinanceSystem.jar" "${ISO_ROOT}/financial-system/"

          # 5-3. ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
          echo '#!/bin/bash' > "${ISO_ROOT}/financial-system/run_simulation.sh"
          echo 'java -cp FinanceSystem.jar com.bank.core.BankingSystem 5000' >> "${ISO_ROOT}/financial-system/run_simulation.sh"
          chmod +x "${ISO_ROOT}/financial-system/run_simulation.sh"

          # 5-4. ISO ìƒì„±
          ISO_NAME="Finance-BPR-Maven-${VERSION}.iso"
          mkisofs -o "dump/${ISO_NAME}" -J -R -V "FinBPR-${VERSION}" "${ISO_ROOT}"
          
          echo "âœ… ISO Created: ${ISO_NAME}"

      # 6. Release (ISO ë° ë³´ê³ ì„œ í¬í•¨)
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-financial-bpr"
          name: "Financial BPR System (Maven ${{ matrix.maven-version }})"
          body: |
            ## ğŸ¦ Financial BPR & Transaction System
            **Built with Apache Maven ${{ matrix.maven-version }}**
            
            This release includes a simulated banking system validation report.
            
            ### ğŸ“Š BPR (Business Process Reengineering) Features
            - **Virtual Transactions:** Generated mock Deposit/Withdrawal data.
            - **Analysis Report:** Includes Net Flow, Volume Analysis, and High-Value alerts.
            - **Verification:** System logic validated under Maven ${{ matrix.maven-version }}.
            
            ### ğŸ’¿ ISO Contents
            - `/financial-reports/bpr`: **Automated BPR Analysis Report**
            - `/financial-system`: Executable JAR + Simulation Script
            - `/maven-dist`: Official Maven Binaries
            
            *Report generated automatically by GitHub Actions workflow.*
          artifacts: |
            dump/Finance-BPR-Maven-${{ matrix.maven-version }}.iso
            generated_reports/BPR_Report_Maven_${{ matrix.maven-version }}.txt
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
