name: Sales Report Server & Maven ISO Build (Mass Deploy)

on:
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force recreate release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build-sales-server-iso:
    name: Build Sales Server & ISO (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      SERVER_APP_NAME: sales-branch-report-server

    steps:
      # 1. ê¸°ë³¸ í™˜ê²½ ì„¤ì •
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install ISO Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage

      # 2. Maven ë‹¤ìš´ë¡œë“œ ë° ì„¤ì •
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          # ë‹¤ìš´ë¡œë“œ ê²½ë¡œ ì„¤ì •
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY_URL="${MAVEN_PRIMARY_BASE_URL}/${VERSION}/binaries/${FILENAME}"
          ARCHIVE_URL="${MAVEN_ARCHIVE_BASE_URL}/${VERSION}/binaries/${FILENAME}"

          # ë‹¤ìš´ë¡œë“œ ì‹œë„
          if curl -fL "${PRIMARY_URL}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded from Primary"
          else
            echo "âš ï¸ Primary failed, attempting Archive..."
            curl -fL "${ARCHIVE_URL}" -o "${ARCHIVE_PATH}"
          fi

          # ì••ì¶• í•´ì œ
          EXTRACT_DIR="extracted/apache-maven-${VERSION}"
          mkdir -p "${EXTRACT_DIR}"
          tar -xzf "${ARCHIVE_PATH}" -C "${EXTRACT_DIR}" --strip-components=1
          
          # í™˜ê²½ë³€ìˆ˜ ë“±ë¡
          echo "MAVEN_HOME=${PWD}/${EXTRACT_DIR}" >> "$GITHUB_ENV"
          echo "${PWD}/${EXTRACT_DIR}/bin" >> "$GITHUB_PATH"

      # 3. [NEW] ì˜ì—…ì  ê¸ˆì•¡ ë³´ê³ ì„œ ìë™í™” ì„œë²„ (ì†ŒìŠ¤ ìƒì„±)
      # ì‹¤ì œ ì½”ë“œê°€ ì—†ìœ¼ë¯€ë¡œ, ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œ ë™ì ìœ¼ë¡œ ê°„ë‹¨í•œ Spring Boot ìŠ¤íƒ€ì¼ì˜ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Generate Sales Report Server Source Code
        run: |
          set -euo pipefail
          APP_DIR="${SERVER_APP_NAME}"
          mkdir -p "${APP_DIR}/src/main/java/com/finance/report"
          
          # 3-1. POM.xml ìƒì„±
          cat <<EOF > "${APP_DIR}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.finance</groupId>
            <artifactId>${SERVER_APP_NAME}</artifactId>
            <version>1.0.0-SNAPSHOT</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
            <dependencies>
                <!-- ë¡œê¹… ë“± ê¸°ë³¸ ì˜ì¡´ì„± ì‹œë®¬ë ˆì´ì…˜ -->
            </dependencies>
          </project>
          EOF

          # 3-2. Java ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„± (ë³´ê³ ì„œ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜)
          cat <<EOF > "${APP_DIR}/src/main/java/com/finance/report/ReportServerApp.java"
          package com.finance.report;
          
          import java.time.LocalDateTime;
          import java.util.Random;

          public class ReportServerApp {
              public static void main(String[] args) {
                  System.out.println("=== Sales Branch Amount Report Server Starting ===");
                  System.out.println("Maven Version: ${{ matrix.maven-version }}");
                  System.out.println("Report Time: " + LocalDateTime.now());
                  
                  String[] branches = {"Seoul-Gangnam", "Busan-Haeundae", "Incheon-Airport", "Jeju-Main"};
                  Random rand = new Random();
                  long totalAmount = 0;
                  
                  System.out.println("\n--- Branch Report ---");
                  for (String branch : branches) {
                      long amount = rand.nextInt(100000) * 1000;
                      totalAmount += amount;
                      System.out.println("Branch: " + branch + " | Amount: " + amount + " KRW");
                  }
                  System.out.println("---------------------");
                  System.out.println("Total Sales Amount: " + totalAmount + " KRW");
                  System.out.println("=== Server Process Complete ===");
              }
          }
          EOF
          
          echo "âœ… Sales Report Server source code generated."

      # 4. [NEW] ì˜ì—…ì  ë³´ê³ ì„œ ì„œë²„ ë¹Œë“œ (Maven ì‚¬ìš©)
      - name: Build Sales Report Server
        run: |
          set -euo pipefail
          cd "${SERVER_APP_NAME}"
          echo "Building Sales Report Server with Maven ${{ matrix.maven-version }}..."
          
          # Clean Package ì‹¤í–‰
          mvn -q -B clean package
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          ls -lh target/*.jar
          echo "âœ… Sales Report Server Built Successfully."

      # 5. [NEW] ISO ë©”íƒ€ë°ì´í„° ìƒì„± ë° ì •ë³´ ì£¼ì…
      - name: Prepare ISO Root & Inject Metadata
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          ISO_ROOT="iso_root"
          mkdir -p "${ISO_ROOT}/maven-bin"
          mkdir -p "${ISO_ROOT}/sales-server"
          mkdir -p "${ISO_ROOT}/metadata"

          # 5-1. ì•„í‹°íŒ©íŠ¸ ë³µì‚¬
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ISO_ROOT}/maven-bin/"
          cp "${SERVER_APP_NAME}/target/${SERVER_APP_NAME}-1.0.0-SNAPSHOT.jar" "${ISO_ROOT}/sales-server/"

          # 5-2. ë©”íƒ€ë°ì´í„° íŒŒì¼ ì£¼ì… (JSON)
          cat <<EOF > "${ISO_ROOT}/metadata/release-info.json"
          {
            "product": "Sales Report Server Bundle",
            "maven_version": "${VERSION}",
            "build_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "build_runner": "GitHub Actions",
            "components": [
              "Apache Maven Binaries",
              "Sales Branch Report Server JAR"
            ]
          }
          EOF

          # 5-3. íŒŒì¼ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± (í…ìŠ¤íŠ¸)
          echo "=== ISO File Manifest ===" > "${ISO_ROOT}/metadata/MANIFEST.txt"
          find "${ISO_ROOT}" -type f -exec sha256sum {} \; >> "${ISO_ROOT}/metadata/MANIFEST.txt"

          # 5-4. ì˜ì—…ì  ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì… (ìë™í™” í¸ì˜ì„±)
          cat <<EOF > "${ISO_ROOT}/sales-server/run_report.sh"
          #!/bin/bash
          java -cp ${SERVER_APP_NAME}-1.0.0-SNAPSHOT.jar com.finance.report.ReportServerApp
          EOF
          chmod +x "${ISO_ROOT}/sales-server/run_report.sh"

          echo "âœ… Metadata and Scripts injected into ISO root."

      # 6. ISO ìƒì„± ë° ìµœì¢… ê²€ì¦
      - name: Generate Final ISO
        run: |
          VERSION="${{ matrix.maven-version }}"
          ISO_NAME="SalesServer-Maven-${VERSION}.iso"
          
          # ISO ìƒì„±
          mkisofs -o "dump/${ISO_NAME}" -J -R -V "Maven-${VERSION}-Report" "iso_root"
          
          echo "âœ… ISO Created: dump/${ISO_NAME}"
          
          # ISO ì •ë³´ ìš”ì•½ ì¶œë ¥
          echo "ISO Size:"
          du -sh "dump/${ISO_NAME}"

      # 7. GitHub Release ë°°í¬
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-sales-server"
          name: "Sales Report Server (Maven ${{ matrix.maven-version }})"
          body: |
            ## ğŸ“Š Sales Branch Report Server + Maven ${{ matrix.maven-version }}
            
            This release includes the automated Sales Report Server built with the specific Maven version.
            
            ### ğŸ’¿ ISO Contents (`SalesServer-Maven-${{ matrix.maven-version }}.iso`)
            - `/maven-bin`: Apache Maven Binaries
            - `/sales-server`: **Sales Branch Amount Report Automation Server (JAR)**
            - `/metadata`: Build Info & Checksums
            
            ### ğŸ›  Automation Server Details
            - **App:** `${{ env.SERVER_APP_NAME }}`
            - **Function:** Generates mock sales data reports for branches (Seoul, Busan, etc.)
            - **Build Tool:** Apache Maven ${{ matrix.maven-version }}
            
            *Automated build by GitHub Actions.*
          artifacts: |
            dump/SalesServer-Maven-${{ matrix.maven-version }}.iso
            dump/apache-maven-${{ matrix.maven-version }}-bin.tar.gz
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
