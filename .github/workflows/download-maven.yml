name: Ultimate Financial Simulator & SQL ISO (Stock/Crypto/DB)

on:
  # 1. 10ë¶„ ì£¼ê¸° ìë™ ìŠ¤ì¼€ì¤„ë§
  schedule:
    - cron: '*/10 * * * *'
  # 2. ìˆ˜ë™ ì‹¤í–‰ (ê±°ë˜ëŸ‰ ì¡°ì ˆ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      transaction_count:
        description: 'Simulation Count per Sector'
        required: false
        default: '5000'

permissions:
  contents: write

jobs:
  comprehensive-finance-build:
    name: FinSim Build (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: full-stack-finance-engine

    steps:
      # --- [ê¸°ë°˜ í™˜ê²½ ì„¤ì •] ---
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install System Tools (ISO, Antivirus, Monitor)
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage clamav sysstat
          # ë°”ì´ëŸ¬ìŠ¤ DB ì—…ë°ì´íŠ¸ (ì‹¤íŒ¨ ì‹œ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ì§„í–‰)
          sudo freshclam || echo "âš ï¸ ClamAV DB update warning."

      # --- [ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œì‘] ---
      - name: Start Background Resource Monitoring
        run: |
          mkdir -p logs
          echo "Timestamp | CPU(%) | MEM(%) | IO Wait | Disk Used" > logs/sys_monitor.log
          # 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœ ë¡œê¹… (ë°±ê·¸ë¼ìš´ë“œ)
          vmstat -t 5 > logs/vmstat_raw.log &
          echo "MONITOR_PID=$!" >> "$GITHUB_ENV"

      # --- [Maven ì„¤ì¹˜] ---
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY="https://dlcdn.apache.org/maven/maven-3/${VERSION}/binaries/${FILENAME}"
          ARCHIVE="https://archive.apache.org/dist/maven/maven-3/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Downloaded from CDN"
          else
            curl -fL "${ARCHIVE}" -o "${ARCHIVE_PATH}"
            echo "âœ… Downloaded from Archive"
          fi

          tar -xzf "${ARCHIVE_PATH}" -C extracted/ --strip-components=1
          echo "MAVEN_HOME=${PWD}/extracted" >> "$GITHUB_ENV"
          echo "${PWD}/extracted/bin" >> "$GITHUB_PATH"

      # --- [í†µí•© ê¸ˆìœµ ì‹œìŠ¤í…œ ì†ŒìŠ¤ ì½”ë“œ ìƒì„±] ---
      # ë±…í‚¹, ì£¼ì‹, ì½”ì¸, SQL ìƒì„± ë¡œì§ì´ í¬í•¨ëœ Java ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
      - name: Generate Full-Stack Financial Source Code
        run: |
          set -euo pipefail
          SRC_DIR="${APP_NAME}/src/main/java/com/finance/core"
          mkdir -p "${SRC_DIR}"
          
          # 1. POM.xml
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.finance</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
          </project>
          EOF

          # 2. Main Simulation Logic (Java)
          cat <<EOF > "${SRC_DIR}/FinancialSimulator.java"
          package com.finance.core;
          
          import java.io.*;
          import java.time.LocalDateTime;
          import java.time.format.DateTimeFormatter;
          import java.util.*;

          public class FinancialSimulator {
              // ë°ì´í„° ì €ì¥ì†Œ (ì¸ë©”ëª¨ë¦¬)
              static List<String> bankingTx = new ArrayList<>();
              static List<String> stockTx = new ArrayList<>();
              static List<String> cryptoTx = new ArrayList<>();
              static List<String> sqlStatements = new ArrayList<>();
              
              static Random rand = new Random();

              public static void main(String[] args) throws IOException {
                  int count = Integer.parseInt(args.length > 0 ? args[0] : "1000");
                  System.out.println("=== Global Financial System Simulation (Maven Build) ===");
                  System.out.println("Target Volume: " + count + " per sector");

                  // 1. ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
                  simulateBanking(count);
                  simulateStocks(count);
                  simulateCrypto(count);

                  // 2. ë³´ê³ ì„œ ë° SQL ìƒì„±
                  generateReports();
                  generateSqlScripts();
                  
                  System.out.println("âœ… All Simulations & Exports Completed.");
              }

              // --- ë±…í‚¹ (ì…ì¶œê¸ˆ) ---
              private static void simulateBanking(int count) {
                  sqlStatements.add("-- Banking Transactions");
                  for(int i=0; i<count; i++) {
                      boolean isDeposit = rand.nextBoolean();
                      long amount = (rand.nextInt(5000) + 1) * 10000L;
                      String type = isDeposit ? "DEPOSIT" : "WITHDRAWAL";
                      String id = UUID.randomUUID().toString();
                      
                      String log = String.format("TX|%s|%s|%d|KRW", id, type, amount);
                      bankingTx.add(log);
                      
                      // SQL ìƒì„±
                      sqlStatements.add(String.format("INSERT INTO bank_ledger (tx_id, type, amount, cur, created_at) VALUES ('%s', '%s', %d, 'KRW', NOW());", id, type, amount));
                  }
              }

              // --- ì£¼ì‹ (Stock) ---
              private static void simulateStocks(int count) {
                  String[] tickers = {"SAMSUNG", "APPLE", "TESLA", "NVIDIA", "SKHYNIX"};
                  sqlStatements.add("-- Stock Trading");
                  
                  for(int i=0; i<count; i++) {
                      String ticker = tickers[rand.nextInt(tickers.length)];
                      boolean isBuy = rand.nextBoolean();
                      int qty = rand.nextInt(100) + 1;
                      double price = 50000 + (rand.nextDouble() * 100000); // 5ë§Œ~15ë§Œ
                      
                      String type = isBuy ? "BUY" : "SELL";
                      String id = UUID.randomUUID().toString();
                      
                      String log = String.format("STK|%s|%s|%s|%d|%.2f", id, ticker, type, qty, price);
                      stockTx.add(log);

                      sqlStatements.add(String.format("INSERT INTO stock_orders (order_id, symbol, side, qty, price, created_at) VALUES ('%s', '%s', '%s', %d, %.2f, NOW());", id, ticker, type, qty, price));
                  }
              }

              // --- ë¹„íŠ¸ì½”ì¸/ì½”ì¸ (Crypto) ---
              private static void simulateCrypto(int count) {
                  String[] coins = {"BTC", "ETH", "XRP", "DOGE", "SOL"};
                  sqlStatements.add("-- Crypto Trading");

                  for(int i=0; i<count; i++) {
                      String coin = coins[rand.nextInt(coins.length)];
                      boolean isBuy = rand.nextBoolean();
                      double qty = rand.nextDouble() * 2.5; // 0 ~ 2.5 BTC etc
                      double price = 1000 + (rand.nextDouble() * 50000000); // Volatile price
                      
                      String type = isBuy ? "BID" : "ASK";
                      String id = UUID.randomUUID().toString();

                      String log = String.format("CRY|%s|%s|%s|%.4f|%.2f", id, coin, type, qty, price);
                      cryptoTx.add(log);

                      sqlStatements.add(String.format("INSERT INTO crypto_trades (trade_id, symbol, side, qty, price_krw, created_at) VALUES ('%s', '%s', '%s', %.6f, %.2f, NOW());", id, coin, type, qty, price));
                  }
              }

              // --- ë¦¬í¬íŠ¸ íŒŒì¼ ìƒì„± ---
              private static void generateReports() throws IOException {
                  writeFile("Report_Banking_BPR.txt", bankingTx, "Banking BPR Analysis");
                  writeFile("Report_Stock_Market.txt", stockTx, "Stock Market Activity");
                  writeFile("Report_Crypto_Vol.txt", cryptoTx, "Crypto Volatility Log");
              }

              private static void writeFile(String fname, List<String> data, String header) throws IOException {
                  try(PrintWriter pw = new PrintWriter(new FileWriter(fname))) {
                      pw.println("=== " + header + " ===");
                      pw.println("Generated: " + LocalDateTime.now());
                      pw.println("Maven Build: Included");
                      pw.println("---------------------------");
                      for(String line : data) pw.println(line);
                      pw.println("---------------------------");
                      pw.println("Total Records: " + data.size());
                  }
              }

              // --- SQL ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Schema + Data) ---
              private static void generateSqlScripts() throws IOException {
                  // 1. Schema.sql
                  try(PrintWriter pw = new PrintWriter(new FileWriter("db_schema.sql"))) {
                      pw.println("-- Financial System Database Schema");
                      pw.println("CREATE TABLE bank_ledger (tx_id VARCHAR(50) PRIMARY KEY, type VARCHAR(10), amount BIGINT, cur VARCHAR(3), created_at TIMESTAMP);");
                      pw.println("CREATE TABLE stock_orders (order_id VARCHAR(50) PRIMARY KEY, symbol VARCHAR(20), side VARCHAR(4), qty INT, price DECIMAL(15,2), created_at TIMESTAMP);");
                      pw.println("CREATE TABLE crypto_trades (trade_id VARCHAR(50) PRIMARY KEY, symbol VARCHAR(10), side VARCHAR(4), qty DECIMAL(20,8), price_krw DECIMAL(20,2), created_at TIMESTAMP);");
                  }
                  
                  // 2. Data.sql
                  try(PrintWriter pw = new PrintWriter(new FileWriter("db_data_dump.sql"))) {
                      pw.println("-- Simulated Data Dump");
                      for(String sql : sqlStatements) pw.println(sql);
                  }
              }
          }
          EOF
          echo "âœ… Source Code Generated."

      # --- [ë¹Œë“œ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰] ---
      - name: Build & Run Simulation
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          
          echo "Building with Maven ${{ matrix.maven-version }}..."
          mvn -q -B clean package
          
          echo "Running Simulation..."
          java -cp "target/${APP_NAME}-1.0.0.jar" com.finance.core.FinancialSimulator ${{ inputs.transaction_count }}
          
          # ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
          mkdir -p ../artifacts/reports
          mkdir -p ../artifacts/sql
          
          mv *.txt ../artifacts/reports/
          mv *.sql ../artifacts/sql/
          cp target/*.jar ../artifacts/

      # --- [ë³´ì•ˆ ê²€ì‚¬ (Antivirus)] ---
      - name: Run ClamAV Security Scan
        run: |
          echo "Scanning artifacts for viruses..."
          mkdir -p logs
          # artifacts í´ë” ì „ì²´ ìŠ¤ìº”
          if clamscan -r -i artifacts > logs/security_scan.log; then
            echo "âœ… Virus Scan Clean." >> logs/security_scan.log
          else
            echo "âš ï¸ Potential Threat Detected." >> logs/security_scan.log
          fi
          cat logs/security_scan.log

      # --- [ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ ë° ë¡œê·¸ ì •ë¦¬] ---
      - name: Collect System Logs
        run: |
          pkill vmstat || true
          cat logs/vmstat_raw.log >> logs/sys_monitor.log

      # --- [ISO ìƒì„± (DB, SQL, ë¦¬í¬íŠ¸ í¬í•¨)] ---
      - name: Package ISO Bundle
        run: |
          VERSION="${{ matrix.maven-version }}"
          ROOT="iso_root"
          mkdir -p "${ROOT}/01_System_Binaries"
          mkdir -p "${ROOT}/02_Financial_Reports"
          mkdir -p "${ROOT}/03_Database_SQL"
          mkdir -p "${ROOT}/04_Security_Logs"

          # 1. ë°”ì´ë„ˆë¦¬ (Maven + App)
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ROOT}/01_System_Binaries/"
          cp "artifacts/${APP_NAME}-1.0.0.jar" "${ROOT}/01_System_Binaries/"

          # 2. ë¦¬í¬íŠ¸ (BPR, Stock, Crypto)
          cp artifacts/reports/*.txt "${ROOT}/02_Financial_Reports/"

          # 3. SQL ìŠ¤í¬ë¦½íŠ¸ (Schema, Data)
          cp artifacts/sql/*.sql "${ROOT}/03_Database_SQL/"

          # 4. ë¡œê·¸ (ë³´ì•ˆ, ì„±ëŠ¥)
          cp logs/security_scan.log "${ROOT}/04_Security_Logs/"
          cp logs/sys_monitor.log "${ROOT}/04_Security_Logs/"

          # 5. README ë° ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
          echo "Financial Simulator ISO - Maven ${VERSION}" > "${ROOT}/README.txt"
          echo "Includes: Banking, Stock, Crypto, SQL Dumps" >> "${ROOT}/README.txt"
          
          echo '#!/bin/bash' > "${ROOT}/run_app.sh"
          echo 'java -jar 01_System_Binaries/*.jar 5000' >> "${ROOT}/run_app.sh"
          chmod +x "${ROOT}/run_app.sh"

          # 6. ISO ìƒì„±
          ISO_NAME="FinSim-Full-Maven-${VERSION}.iso"
          mkisofs -o "dump/${ISO_NAME}" -J -R -V "FinSim-${VERSION}" "${ROOT}"
          
          echo "âœ… ISO Ready: ${ISO_NAME}"
          du -sh "dump/${ISO_NAME}"

      # --- [GitHub Release ë°°í¬] ---
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-finsim-full"
          name: "Ultimate FinSim & SQL (Maven ${{ matrix.maven-version }})"
          body: |
            ## ğŸ¦ Comprehensive Financial System Simulation
            **Built with Apache Maven ${{ matrix.maven-version }}**
            
            This release contains a full-stack financial simulation engine, SQL database dumps, and security reports.
            
            ### ğŸ’¿ ISO Contents (`FinSim-Full-Maven-${{ matrix.maven-version }}.iso`)
            
            #### 1. ğŸ’° Simulation Modules
            - **Banking:** Deposit/Withdrawal simulation (BPR Report).
            - **ğŸ“ˆ Stock:** Virtual Trading (Samsung, Apple, Tesla, etc.).
            - **ğŸª™ Crypto:** Bitcoin/Ethereum volatility simulation.
            
            #### 2. ğŸ—„ï¸ Database & SQL
            - `db_schema.sql`: Table definitions for Banking, Stock, and Crypto.
            - `db_data_dump.sql`: **INSERT statements** for all simulated transactions.
            
            #### 3. ğŸ›¡ï¸ Security & Performance
            - **Antivirus:** ClamAV Scan Report (Clean).
            - **Performance:** CPU/RAM/Disk Usage Logs (Sysstat).
            
            *Automated by GitHub Actions with 10-min schedule.*
          artifacts: "dump/*.iso"
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
