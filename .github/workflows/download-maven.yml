name: Korea Finance Security & MD ISO (Fixed ClamAV)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      active_customer_count:
        description: 'Active Customers'
        required: false
        default: '50000'
      transaction_count:
        description: 'Tx per Sector'
        required: false
        default: '3000'

permissions:
  contents: write

jobs:
  korea-fixed-build:
    name: Build & Sec Report (Maven ${{ matrix.maven-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maven-version:
          - '3.9.0'
          - '3.9.1'
          - '3.9.2'
          - '3.9.3'
          - '3.9.4'
          - '3.9.5'
          - '3.9.6'
          - '3.9.7'
          - '3.9.8'
          - '3.9.9'
          - '3.9.10'
          - '3.9.11'

    env:
      MAVEN_PRIMARY_BASE_URL: https://dlcdn.apache.org/maven/maven-3
      MAVEN_ARCHIVE_BASE_URL: https://archive.apache.org/dist/maven/maven-3
      APP_NAME: korea-fin-engine

    steps:
      # --- [1. í™˜ê²½ ì„¤ì • ë° ë„êµ¬ ì„¤ì¹˜] ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # [FIX] ClamAV Lock ì—ëŸ¬ í•´ê²° ë¡œì§ ì ìš©
      - name: Install Tools & Fix ClamAV Lock
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage clamav clamav-daemon sysstat
          
          echo "ğŸ›‘ Stopping conflicting ClamAV daemon..."
          sudo systemctl stop clamav-freshclam || true
          
          echo "ğŸ”§ Fixing log permissions..."
          sudo touch /var/log/clamav/freshclam.log
          sudo chown -R clamav:clamav /var/log/clamav
          sudo chmod 755 /var/log/clamav
          
          echo "ğŸ”„ Running manual Freshclam update..."
          # ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ë¹Œë“œëŠ” ê³„ì† ì§„í–‰í•˜ë„ë¡ ì²˜ë¦¬ (|| true)
          sudo freshclam || echo "âš ï¸ Freshclam update warning (Network/Mirror issue). Using default DB."

      # --- [2. ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œì‘] ---
      - name: Start Resource Monitoring
        run: |
          mkdir -p logs
          echo "| Timestamp | CPU% | MEM% | IO Wait |" > logs/sys_monitor.md
          echo "|---|---|---|---|" >> logs/sys_monitor.md
          vmstat -t 5 | awk '{print "| " $18 " " $19 " | " $13 " | " $4 " | " $16 " |"}' >> logs/vmstat_raw.log &

      # --- [3. Maven ì„¤ì¹˜] ---
      - name: Setup Maven ${{ matrix.maven-version }}
        run: |
          set -euo pipefail
          VERSION="${{ matrix.maven-version }}"
          mkdir -p dump extracted
          
          FILENAME="apache-maven-${VERSION}-bin.tar.gz"
          ARCHIVE_PATH="dump/${FILENAME}"
          PRIMARY="https://dlcdn.apache.org/maven/maven-3/${VERSION}/binaries/${FILENAME}"
          ARCHIVE="https://archive.apache.org/dist/maven/maven-3/${VERSION}/binaries/${FILENAME}"

          if curl -fL "${PRIMARY}" -o "${ARCHIVE_PATH}"; then
            echo "âœ… Maven Downloaded"
          else
            curl -fL "${ARCHIVE}" -o "${ARCHIVE_PATH}"
          fi

          tar -xzf "${ARCHIVE_PATH}" -C extracted/ --strip-components=1
          echo "MAVEN_HOME=${PWD}/extracted" >> "$GITHUB_ENV"
          echo "${PWD}/extracted/bin" >> "$GITHUB_PATH"

      # --- [4. ëŒ€í•œë¯¼êµ­ ê¸ˆìœµ ì‹œë®¬ë ˆì´í„° ìƒì„± (MD ì—”ì§„ í¬í•¨)] ---
      - name: Generate Simulator Source
        run: |
          set -euo pipefail
          SRC_DIR="${APP_NAME}/src/main/java/com/korea/sim"
          mkdir -p "${SRC_DIR}"
          
          # POM.xml (ë³´ì•ˆ ì˜ì¡´ì„± í¬í•¨)
          cat <<EOF > "${APP_NAME}/pom.xml"
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.korea</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties>
              <maven.compiler.source>17</maven.compiler.source>
              <maven.compiler.target>17</maven.compiler.target>
            </properties>
            <dependencies>
                <dependency>
                    <groupId>org.apache.commons</groupId>
                    <artifactId>commons-lang3</artifactId>
                    <version>3.12.0</version>
                </dependency>
                <dependency>
                    <groupId>com.fasterxml.jackson.core</groupId>
                    <artifactId>jackson-databind</artifactId>
                    <version>2.13.0</version>
                </dependency>
            </dependencies>
          </project>
          EOF

          # Java Code (ì¸êµ¬/ê¸ˆìœµ ì‹œë®¬ë ˆì´ì…˜ + MD ë¦¬í¬íŠ¸ ìƒì„±)
          cat <<EOF > "${SRC_DIR}/KoreaSimApp.java"
          package com.korea.sim;
          import java.io.*;
          import java.text.DecimalFormat;
          import java.time.LocalDateTime;
          import java.util.*;

          public class KoreaSimApp {
              static final long POPULATION = 51_750_000L;
              static Random rand = new Random();
              static DecimalFormat df = new DecimalFormat("#,###");

              public static void main(String[] args) throws IOException {
                  int custCount = Integer.parseInt(args.length > 0 ? args[0] : "50000");
                  int txCount = Integer.parseInt(args.length > 1 ? args[1] : "3000");
                  
                  System.out.println("=== KOREA FINANCE SIMULATION (FIXED BUILD) ===");
                  
                  // 1. Markdown ë¦¬í¬íŠ¸ ìƒì„±
                  generateMdReports(custCount, txCount);
                  
                  // 2. SQL ë°ì´í„° ìƒì„± (ê°„ëµí™”)
                  generateSql(custCount);
              }

              private static void generateMdReports(int custCount, int txCount) throws IOException {
                  // Executive Summary
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_00_Executive_Summary.md"))) {
                      pw.println("# ğŸ‡°ğŸ‡· Executive Summary: Korea Finance System");
                      pw.println("**Build Date:** " + LocalDateTime.now() + "  ");
                      pw.println("**Status:** âœ… System Stable  ");
                      pw.println("");
                      pw.println("## ğŸ“Š Key Indicators");
                      pw.println("| Indicator | Value | Note |");
                      pw.println("|---|---|---|");
                      pw.println("| **Total Population** | " + df.format(POPULATION) + " | 2024 Est. |");
                      pw.println("| **Active Users** | " + df.format(custCount) + " | Simulated |");
                      pw.println("| **Daily Transactions** | " + df.format(txCount * 3) + " | Bank/Stock/Crypto |");
                  }
                  
                  // Financial Sector Report
                  try(PrintWriter pw = new PrintWriter(new FileWriter("Report_02_Finance_Analysis.md"))) {
                      pw.println("# ğŸ’° Financial Sector Analysis");
                      pw.println("## 1. Banking (Deposit/Withdrawal)");
                      pw.println("- **Avg Transaction:** " + df.format(rand.nextInt(50)*10000) + " KRW");
                      pw.println("- **Stability:** High");
                      pw.println("");
                      pw.println("## 2. Stock Market (KOSPI/KOSDAQ)");
                      pw.println("- **Active Traders:** " + df.format(custCount * 0.3));
                      pw.println("- **Top Vol:** Samsung Elec, SK Hynix");
                      pw.println("");
                      pw.println("## 3. Crypto Assets");
                      pw.println("- **Volatility Index:** High");
                      pw.println("- **Top Assets:** BTC, ETH, XRP");
                  }
              }

              private static void generateSql(int count) throws IOException {
                  try(PrintWriter pw = new PrintWriter(new FileWriter("korea_customers.sql"))) {
                      pw.println("-- Active Customer Dump");
                      pw.println("INSERT INTO customers (id, name, region) VALUES");
                      pw.println("('CUST_001', 'Kim Min-su', 'Seoul'),");
                      pw.println("('CUST_002', 'Lee Ji-eun', 'Gyeonggi');");
                      pw.println("-- ... (Truncated for simulation speed)");
                  }
              }
          }
          EOF

      # --- [5. ë¹Œë“œ ë° ì‹¤í–‰] ---
      - name: Build & Simulate
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          mvn -q -B clean package
          java -cp "target/${APP_NAME}-1.0.0.jar" com.korea.sim.KoreaSimApp ${{ inputs.active_customer_count }} ${{ inputs.transaction_count }}
          
          # ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
          mkdir -p ../artifacts/reports
          mv Report_*.md ../artifacts/reports/
          cp *.sql ../artifacts/reports/
          cp target/*.jar ../artifacts/

      # --- [6. ì¢…ì†ì„± ë° ë³´ì•ˆ ë¶„ì„ (Security Submission)] ---
      - name: Dependency & Security Submission
        run: |
          set -euo pipefail
          cd "${APP_NAME}"
          
          # Dependency Tree ì¶”ì¶œ
          mvn -q dependency:tree -DoutputFile=dep_tree.txt
          
          # ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
          echo "# ğŸ›¡ï¸ Security Audit & Dependency Report" > ../artifacts/reports/Report_03_Security_Audit.md
          echo "**Scan Timestamp:** $(date)" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo "" >> ../artifacts/reports/Report_03_Security_Audit.md
          
          echo "## ğŸ“¦ Software Bill of Materials (SBOM)" >> ../artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> ../artifacts/reports/Report_03_Security_Audit.md
          cat dep_tree.txt >> ../artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> ../artifacts/reports/Report_03_Security_Audit.md

      # --- [7. ë°”ì´ëŸ¬ìŠ¤ ìŠ¤ìº” í†µí•©] ---
      - name: ClamAV Scan Integration
        run: |
          echo "## ğŸ¦  Antivirus Scan Results (ClamAV)" >> artifacts/reports/Report_03_Security_Audit.md
          echo "Scanning artifacts directory..."
          echo '```' >> artifacts/reports/Report_03_Security_Audit.md
          
          # clamscan ì‹¤í–‰ (ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œê·¸ëŠ” ê¸°ë¡ë˜ë„ë¡ ì²˜ë¦¬)
          if clamscan -r -i artifacts > logs/clamav_scan.log; then
             echo "âœ… Status: CLEAN (No threats found)" >> artifacts/reports/Report_03_Security_Audit.md
          else
             echo "âš ï¸ Status: THREAT DETECTED or WARNING" >> artifacts/reports/Report_03_Security_Audit.md
          fi
          
          cat logs/clamav_scan.log >> artifacts/reports/Report_03_Security_Audit.md
          echo '```' >> artifacts/reports/Report_03_Security_Audit.md

      # --- [8. ë¦¬ì†ŒìŠ¤ ë¡œê·¸ ë§ˆë¬´ë¦¬ê¸°] ---
      - name: Finalize Resource Log
        run: |
          pkill vmstat || true
          
          echo "# âš™ï¸ System Resource Logs" > artifacts/reports/Report_04_System_Resources.md
          cat logs/sys_monitor.md >> artifacts/reports/Report_04_System_Resources.md
          cat logs/vmstat_raw.log | awk '{print "| " $0 " |"}' >> artifacts/reports/Report_04_System_Resources.md

      # --- [9. ISO íŒ¨í‚¤ì§•] ---
      - name: Package ISO
        run: |
          VERSION="${{ matrix.maven-version }}"
          ROOT="iso_root"
          mkdir -p "${ROOT}/00_Executive_Reports"
          mkdir -p "${ROOT}/01_Binaries"
          mkdir -p "${ROOT}/02_Security_Logs"
          
          # Markdown ë³´ê³ ì„œë¥¼ ìµœìƒìœ„ì—ë„ ë³µì‚¬
          cp artifacts/reports/Report_00_*.md "${ROOT}/"
          
          # í´ë”ë³„ ì •ë¦¬
          cp artifacts/reports/*.md "${ROOT}/00_Executive_Reports/"
          cp artifacts/reports/*.sql "${ROOT}/00_Executive_Reports/"
          cp "dump/apache-maven-${VERSION}-bin.tar.gz" "${ROOT}/01_Binaries/"
          cp "artifacts/${APP_NAME}-1.0.0.jar" "${ROOT}/01_Binaries/"
          cp logs/clamav_scan.log "${ROOT}/02_Security_Logs/"
          
          # ISO ìƒì„±
          mkisofs -o "dump/Korea-Fixed-Sec-${VERSION}.iso" -J -R -V "KOR-SEC-${VERSION}" "${ROOT}"
          
          echo "âœ… ISO Created Successfully"

      # --- [10. ë¦´ë¦¬ì¦ˆ ë°°í¬] ---
      - name: Release to GitHub
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v${{ matrix.maven-version }}-fixed-sec"
          name: "Korea Fin Security & MD (Fixed ClamAV) - ${{ matrix.maven-version }}"
          body: |
            ## ğŸ‡°ğŸ‡· Korea Finance Security & MD Reports (Fixed)
            **Maven ${{ matrix.maven-version }} | ClamAV Lock Fixed**
            
            This release fixes the `freshclam` lock error and provides full security reporting.
            
            ### ğŸ› ï¸ Fix Details
            - Stopped `clamav-freshclam` daemon before update.
            - Fixed permissions for `/var/log/clamav`.
            
            ### ğŸ“„ Reports (Markdown)
            - **Executive Summary:** Overview of 51.7M Population & Transactions.
            - **Security Audit:** Dependency Tree (SBOM) + ClamAV Scan.
            - **System Resources:** CPU/Memory usage during simulation.
            
            *Automated by GitHub Actions.*
          artifacts: "dump/*.iso"
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: ${{ matrix.maven-version == '3.9.11' }}
