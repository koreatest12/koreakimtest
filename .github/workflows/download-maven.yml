name: "ğŸ‡°ğŸ‡· Korea Finance â€” ALL-ECHO ULTRA MEGA v3 (FIXED)"

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      active_customer_count:
        description: "Active Customers (DB Rows)"
        default: "50000"
      massive_folder_count:
        description: "Massive Folder Count"
        default: "100"

permissions:
  contents: write

env:
  TZ: Asia/Seoul
  LOG_DIR: .github/echo_logs
  REPORT_DIR: .github/echo_reports
  MASSIVE_DIR: massive_storage
  ISO_DIR: iso_root
  SQL_DIR: sql
  APP_NAME: korea-fin-engine

jobs:
  ultra-mega-build:
    name: "ULTRA MEGA BUILD (Fixed & Massive)"
    runs-on: ubuntu-latest

    steps:
      # ===========================================================================
      # 0) INITIALIZATION & MONITORING
      # ===========================================================================
      - name: "ğŸ”§ Init Engine & Directories"
        run: |
          mkdir -p ${LOG_DIR} ${REPORT_DIR} ${SQL_DIR} ${MASSIVE_DIR} ${ISO_DIR}
          
          # ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
          vmstat -t 5 > ${LOG_DIR}/sys_monitor_raw.log &

          echo "âœ… Init Complete. Monitor PID: $!"

      # ===========================================================================
      # 1) INSTALL PACKAGES (Dependency Fix)
      # ===========================================================================
      - name: "ğŸ“¦ Install Required Tools (Safe Mode)"
        run: |
          sudo apt-get update -qq
          # ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ í•„ìˆ˜ íŒ¨í‚¤ì§€ë§Œ ì„ ë³„ ì„¤ì¹˜
          sudo apt-get install -y -qq \
            postgresql-client \
            genisoimage xorriso \
            sysstat pv pigz tree \
            clamav clamav-daemon

      # ===========================================================================
      # 2) DOCKER DATABASE SETUP (PostgreSQL)
      # ===========================================================================
      - name: "ğŸ˜ Start PostgreSQL Containers"
        run: |
          # ê°€ë²¼ìš´ Alpine ë²„ì „ ì‚¬ìš©
          docker run -d --name pg_old -e POSTGRES_PASSWORD=postgres -p 5432:5432 postgres:16-alpine
          docker run -d --name pg_new -e POSTGRES_PASSWORD=postgres -p 5433:5432 postgres:16-alpine
          
          echo "Waiting for DB..."
          sleep 10
          docker ps

      # ===========================================================================
      # 3) DB SCHEMA & DATA INJECTION (FIXED: Pipe Method)
      # ===========================================================================
      - name: "ğŸ— Inject Schema & Massive Data (Pipe Method)"
        run: |
          # [FIX] íŒŒì¼ ê²½ë¡œ ì—ëŸ¬ í•´ê²°: í˜¸ìŠ¤íŠ¸ íŒŒì¼ì„ catìœ¼ë¡œ ì½ì–´ Docker ë‚´ë¶€ë¡œ íŒŒì´í”„ ì „ì†¡
          
          echo "Defining Schema..."
          cat <<EOF > ${SQL_DIR}/schema.sql
          CREATE TABLE customers (id SERIAL PRIMARY KEY, name TEXT, region TEXT, score INT);
          CREATE TABLE transactions (id SERIAL PRIMARY KEY, cust_id INT, amount BIGINT, tx_time TIMESTAMP DEFAULT NOW());
          CREATE TABLE audit_logs (id SERIAL PRIMARY KEY, action TEXT, log_time TIMESTAMP DEFAULT NOW());
          EOF

          echo "Applying Schema..."
          cat ${SQL_DIR}/schema.sql | docker exec -i pg_old psql -U postgres
          cat ${SQL_DIR}/schema.sql | docker exec -i pg_new psql -U postgres

          echo "Injecting Data (${{ github.event.inputs.active_customer_count }} rows)..."
          # Generate Seriesë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€ëŸ‰ ë°ì´í„° ê³ ì† ì‚½ì…
          docker exec -i pg_old psql -U postgres -c "
            INSERT INTO customers (name, region, score)
            SELECT 'User-'||g, (ARRAY['Seoul','Busan','Jeju'])[floor(random()*3)+1], (random()*1000)::int
            FROM generate_series(1, ${{ github.event.inputs.active_customer_count }}) AS g;
          "
          
          docker exec -i pg_old psql -U postgres -c "
            INSERT INTO transactions (cust_id, amount)
            SELECT (random()*${{ github.event.inputs.active_customer_count }})::int+1, (random()*1000000)::int
            FROM generate_series(1, 10000);
          "
          
          echo "âœ… DB Injection Complete."

      # ===========================================================================
      # 4) SERVER DIRECTORY SIMULATION (Add Folders/Files)
      # ===========================================================================
      - name: "ğŸ“‚ Generate Server Structure & Massive Files"
        run: |
          echo "ğŸš€ Generating Massive Server Directory Structure..."
          
          # 1. ì„œë²„ í‘œì¤€ ë””ë ‰í† ë¦¬ ì‹œë®¬ë ˆì´ì…˜
          SERVER_ROOT="${MASSIVE_DIR}/server_backup"
          mkdir -p ${SERVER_ROOT}/{etc/nginx,var/www/html,var/log/app,opt/tomcat/webapps,home/admin}
          
          # 2. ëŒ€ëŸ‰ ì„¤ì • íŒŒì¼ ìƒì„±
          for i in {1..100}; do
            echo "server_name site_${i}.com;" > "${SERVER_ROOT}/etc/nginx/site_${i}.conf"
            echo "<html><body>Site ${i}</body></html>" > "${SERVER_ROOT}/var/www/html/index_${i}.html"
          done
          
          # 3. ëŒ€ëŸ‰ ë¡œê·¸ íŒŒì¼ ìƒì„± (Massive Folder Count)
          echo "generating massive logs..."
          for i in $(seq 1 ${{ github.event.inputs.massive_folder_count }}); do
            mkdir -p "${SERVER_ROOT}/var/log/app/archive_${i}"
            # ê° í´ë”ì— 100ê°œ íŒŒì¼ ìƒì„±
            for j in {1..100}; do
               echo "Log entry [${i}-${j}] - System OK" > "${SERVER_ROOT}/var/log/app/archive_${i}/sys_${j}.log"
            done
          done
          
          FILE_COUNT=$(find ${MASSIVE_DIR} -type f | wc -l)
          echo "âœ… Generated Total Files: ${FILE_COUNT}"
          
          # êµ¬ì¡° ìš”ì•½ ì €ì¥
          tree ${MASSIVE_DIR} -L 3 > ${REPORT_DIR}/server_structure_map.txt

      # ===========================================================================
      # 5) JAVA SIMULATOR BUILD & RUN (FIXED: Run JAR)
      # ===========================================================================
      - name: "â˜• Build & Run Java App"
        run: |
          echo "Constructing Java Project..."
          mkdir -p ${APP_NAME}/src/main/java/com/korea/sim
          
          # POM.xml
          cat <<EOF > ${APP_NAME}/pom.xml
          <project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.korea</groupId>
            <artifactId>${APP_NAME}</artifactId>
            <version>1.0.0</version>
            <properties><maven.compiler.source>17</maven.compiler.source><maven.compiler.target>17</maven.compiler.target></properties>
          </project>
          EOF
          
          # Java Code
          cat <<EOF > ${APP_NAME}/src/main/java/com/korea/sim/App.java
          package com.korea.sim;
          import java.io.*;
          import java.time.LocalDateTime;
          public class App {
              public static void main(String[] args) throws IOException {
                  System.out.println("Running Java Simulator...");
                  File f = new File("population_report.md");
                  try(PrintWriter pw = new PrintWriter(f)) {
                      pw.println("# ğŸ‡°ğŸ‡· Population Report");
                      pw.println("- Generated: " + LocalDateTime.now());
                      pw.println("- Status: OK");
                  }
                  System.out.println("Report Generated: " + f.getAbsolutePath());
              }
          }
          EOF
          
          # Build
          cd ${APP_NAME}
          mvn -q -B clean package
          
          # [FIX] JAR ì‹¤í–‰ (Run the JAR to generate report)
          echo "Running JAR..."
          java -cp target/${APP_NAME}-1.0.0.jar com.korea.sim.App
          
          # Copy Artifacts
          cp target/*.jar ../${ISO_DIR}/
          cp population_report.md ../${REPORT_DIR}/

      # ===========================================================================
      # 6) CLAMAV SECURITY SCAN (Safe Mode)
      # ===========================================================================
      - name: "ğŸ›¡ï¸ Security Scan"
        run: |
          echo "Preparing ClamAV..."
          # ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ìŠ¤ìº”ì€ ì§„í–‰í•˜ë„ë¡ ì²˜ë¦¬
          sudo freshclam || echo "Using default DB"
          
          echo "Scanning Massive Directory..."
          # ëŒ€ëŸ‰ íŒŒì¼ ìŠ¤ìº” (ê°ì—¼ëœ íŒŒì¼ë§Œ ì¶œë ¥ -i)
          clamscan -r -i ${MASSIVE_DIR} > ${LOG_DIR}/virus_scan.log || true
          
          echo "Scan Complete."
          tail ${LOG_DIR}/virus_scan.log

      # ===========================================================================
      # 7) ISO PACKAGING
      # ===========================================================================
      - name: "ğŸ“€ Package ISO"
        run: |
          # 1. DB Dump
          docker exec pg_old pg_dump -U postgres > ${SQL_DIR}/full_backup.sql
          
          # 2. Organize ISO Root
          mkdir -p ${ISO_DIR}/{00_Reports,01_DB,02_Server_Backup,03_Logs}
          
          cp ${REPORT_DIR}/* ${ISO_DIR}/00_Reports/
          cp ${SQL_DIR}/* ${ISO_DIR}/01_DB/
          cp ${LOG_DIR}/* ${ISO_DIR}/03_Logs/
          
          # 3. Compress Massive Server Files (Use pigz for speed)
          echo "Compressing Massive Server Files..."
          tar -cf - ${MASSIVE_DIR} | pigz > ${ISO_DIR}/02_Server_Backup/server_full_backup.tar.gz
          
          # 4. Generate ISO
          echo "Creating ISO..."
          xorriso -as mkisofs -o dump/Korea-Ultra-Mega-v3.iso -J -R -V 'KOR-MEGA-V3' ${ISO_DIR}
          
          ls -lh dump/*.iso

      # ===========================================================================
      # 8) RELEASE
      # ===========================================================================
      - name: "ğŸš€ Release"
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "v3-ultra-mega-fixed"
          name: "ğŸ‡°ğŸ‡· ALL-ECHO ULTRA MEGA v3 (Fixed)"
          body: |
            ## ğŸ‡°ğŸ‡· Korea Finance â€” ULTRA MEGA v3 (FIXED)
            
            **Fixed Errors:**
            - âœ… **DB Error:** Fixed `No such file` by using Pipe (`| docker exec -i`).
            - âœ… **Java Report:** Fixed by running `java` explicitly.
            - âœ… **ClamAV:** Safe initialization added.
            
            **New Features:**
            - ğŸ“‚ **Server Simulation:** `/var/www`, `/etc/nginx` folder structures generated.
            - ğŸ’¾ **Massive Data:** 10,000+ files generated & compressed.
            
            *Automated by GitHub Actions.*
          artifacts: "dump/*.iso"
          allowUpdates: true
          makeLatest: true
