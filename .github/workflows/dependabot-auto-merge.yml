# ÌååÏùº Í≤ΩÎ°ú: .github/workflows/dependabot-auto-merge.yml
name: "Dependabot Auto Merge (ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ ÌÜµÌï© Ï†êÍ≤Ä Î∞è Î≥ëÌï©)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      auto_merge:        # 1
        description: "ÎπåÎìú ÌÜµÍ≥º Ïãú ÏûêÎèô merge Ìï†ÍπåÏöî?"
        type: boolean
        default: true
      repair_mode:       # 2
        description: "ÎπåÎìú/ÌÖåÏä§Ìä∏ Ïã§Ìå® Ïãú ÏûêÎèô Î≥µÍµ¨(apt/dpkg/docker Îì±) ÏãúÎèÑ"
        type: boolean
        default: true
      run_docker_check:  # 3
        description: "Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú/Ïª®ÌÖåÏù¥ÎÑà Ïä§Î™®ÌÅ¨ÎèÑ Í∞ôÏù¥ ÏàòÌñâÌï†ÏßÄ"
        type: boolean
        default: true
      run_maven_build:   # 4
        description: "Maven Ìå®ÌÇ§Ïßï ÎπåÎìúÎ•º ÏàòÌñâÌï†ÏßÄ(-DskipTestsÎ°ú Îπ†Î•¥Í≤å)"
        type: boolean
        default: true
      run_python_check:  # 5
        description: "Python Îü∞ÌÉÄÏûÑ Ï≤¥ÌÅ¨ ÏàòÌñâÌï†ÏßÄ"
        type: boolean
        default: true
      upload_artifact:   # 6
        description: "Î°úÍ∑∏/Î¶¨Ìè¨Ìä∏ artifact ÏóÖÎ°úÎìú Ïó¨Î∂Ä"
        type: boolean
        default: true
      force_labels:      # 7
        description: "Í∞ïÏ†úÎ°ú dependabot Ï≤òÎüº Ï≤òÎ¶¨ (ÎùºÎ≤® Î¨¥Ïãú)"
        type: boolean
        default: false

permissions:
  contents: write           # merge / commit Ïóê ÌïÑÏöî
  pull-requests: write      # PR merge Ïóê ÌïÑÏöî
  packages: write
  id-token: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/dependabot_report
  LOG_DIR: .github/dependabot_report/logs
  ARTIFACT_DIR: .github/dependabot_report/artifacts
  DOCKER_IMG: dependabot-ci-test:latest

jobs:
  validate_and_merge:
    name: "üîÑ Dependabot PR Í≤ÄÏ¶ù & ÏûêÎèô Î≥ëÌï©"
    runs-on: ubuntu-latest

    steps:
      ########################################################################
      # 0. Ï≤¥ÌÅ¨ÏïÑÏõÉ + Ï§ÄÎπÑ
      ########################################################################
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          # dependabot PRÎèÑ fetch Í∞ÄÎä•ÌïòÍ≤å
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: "Cache npm dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            anthropic-cost-tracker/nodejs/node_modules
            mcp-hello-js/node_modules
            mcp-fs/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: "Cache pip packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
            anthropic-cost-tracker/python/.venv
            mcp-hello-py/.venv
            mcp-python-server/.venv
            mcp-apache-server/.venv
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "Cache Maven dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            mcp-hello-java/target
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: "Prepare folders & helpers"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"

          cat > "${REPORT_DIR}/helpers.sh" << 'EOF'
          #!/usr/bin/env bash
          set -Euo pipefail

          safe_run() {
            local label="$1"; shift || true
            echo "‚ñ∂ [${label}] START $(date '+%Y-%m-%d %H:%M:%S%z')" | tee -a "${LOG_DIR}/${label}.log"
            if "$@" >> "${LOG_DIR}/${label}.log" 2>&1 ; then
              echo "‚úÖ [${label}] OK" | tee -a "${LOG_DIR}/${label}.log"
              return 0
            else
              local rc=$?
              echo "‚ùå [${label}] FAILED exit=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return $rc
            fi
          }

          apt_fix() {
            echo "[fix] attempting apt/dpkg repair..." | tee -a "${LOG_DIR}/apt.fix.log"
            sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
            sudo dpkg --configure -a || true
            sudo apt-get update -y || sudo apt-get update -y || true
          }

          ensure_docker() {
            if ! command -v docker >/dev/null 2>&1; then
              echo "[fix] docker not found, installing..." | tee -a "${LOG_DIR}/docker.ensure.log"
              apt_fix
              sudo apt-get install -y ca-certificates curl gnupg || true
              sudo install -m 0755 -d /etc/apt/keyrings || true
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg || true
              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null || true
              apt_fix
              sudo apt-get install -y docker.io docker-buildx-plugin docker-compose-plugin || true
              sudo usermod -aG docker $USER || true
            fi

            if ! docker info >/dev/null 2>&1; then
              echo "[fix] starting docker service..." | tee -a "${LOG_DIR}/docker.ensure.log"
              sudo systemctl start docker || true
              sleep 2
            fi
          }
          EOF
          chmod +x "${REPORT_DIR}/helpers.sh"

          echo "## Dependabot Auto Merge Report" > "${REPORT_DIR}/SUMMARY.txt"
          echo "Run: ${GITHUB_RUN_ID}"         >> "${REPORT_DIR}/SUMMARY.txt"
          echo "Repo: ${GITHUB_REPOSITORY}"    >> "${REPORT_DIR}/SUMMARY.txt"
          echo "PR:   ${GITHUB_REF}"           >> "${REPORT_DIR}/SUMMARY.txt"
          echo "Time: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> "${REPORT_DIR}/SUMMARY.txt"
          echo "----------------------------------------" >> "${REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 1. Ïù¥ PRÏù¥ Dependabot PRÏù∏ÏßÄ ÌôïÏù∏ (ÎùºÎ≤®Î°ú ÌåêÎã®)
      #    - ÎùºÎ≤® ÏóÜÎçîÎùºÎèÑ force_labels=trueÎ©¥ Í∑∏ÎÉ• ÏßÑÌñâ
      ########################################################################
      - name: "Check if PR is from Dependabot (label check)"
        id: depcheck
        shell: bash
        run: |
          set -Eeuo pipefail

          FORCE="${{ github.event.inputs.force_labels || 'false' }}"
          if [ "$FORCE" = "true" ]; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # GitHub API ÏóÜÏù¥ Îã®ÏàúÌïòÍ≤å event payloadÎ•º Î≥¥Í≥† guess ÌïòÎäî Î∞©Î≤ï:
          #  - github.actor == dependabot[bot] Ïù¥Î©¥ Í±∞Ïùò ÌôïÏã§
          #  - ÎùºÎ≤® Î™©Î°ù ÏïàÏóê 'dependency' Í∞ôÏùÄ Í±∞ ÏûàÏúºÎ©¥ ÏùòÏ°¥ÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ PRÏùº ÌôïÎ•† ÌÅº
          ACTOR="${{ github.actor }}"
          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'

          echo "actor=$ACTOR" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "labels=$LABELS_JSON" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          if echo "$ACTOR" | grep -qi "dependabot"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$LABELS_JSON" | grep -qi "dependency"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ÏùòÏ°¥ÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ PRÏù¥ ÏïÑÎãê ÏàòÎèÑ ÏûàÏùå
          echo "forced=false" >> $GITHUB_OUTPUT

      ########################################################################
      # 2. ÏãúÏä§ÌÖú/ÎπåÎìú Ìó¨Ïä§ Ï≤¥ÌÅ¨ (Maven / Python / Docker / Node.js) - ÏÑ†ÌÉùÏ†Å Ïã§Ìñâ
      ########################################################################
      - name: "Repair base system if needed (apt/dpkg/docker)"
        if: ${{ github.event.inputs.repair_mode != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          ensure_docker || true

      - name: "Setup Node.js with npm cache"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            anthropic-cost-tracker/nodejs/package-lock.json
            mcp-hello-js/package-lock.json
            mcp-fs/package-lock.json

      - name: "Install and cache npm dependencies"
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          echo "=== Installing npm dependencies and creating cache ===" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          # Root project
          if [ -f "package.json" ]; then
            echo "‚ñ∂ Installing root npm dependencies..." | tee -a "${LOG_DIR}/npm.install.log"
            safe_run "npm.root" npm ci || safe_run "npm.root.fallback" npm install || true
            safe_run "npm.audit.root" npm audit --json > "${REPORT_DIR}/npm_audit_root.json" || true
          fi

          # Anthropic Cost Tracker
          if [ -f "anthropic-cost-tracker/nodejs/package.json" ]; then
            echo "‚ñ∂ Installing cost-tracker npm dependencies..." | tee -a "${LOG_DIR}/npm.install.log"
            cd anthropic-cost-tracker/nodejs
            safe_run "npm.cost-tracker" npm ci || safe_run "npm.cost-tracker.fallback" npm install || true
            safe_run "npm.audit.cost-tracker" npm audit --json > "${REPORT_DIR}/npm_audit_cost_tracker.json" || true
            cd ../..
          fi

          # MCP Hello JS
          if [ -f "mcp-hello-js/package.json" ]; then
            echo "‚ñ∂ Installing mcp-hello-js npm dependencies..." | tee -a "${LOG_DIR}/npm.install.log"
            cd mcp-hello-js
            safe_run "npm.mcp-hello-js" npm ci || safe_run "npm.mcp-hello-js.fallback" npm install || true
            cd ..
          fi

          # MCP FS
          if [ -f "mcp-fs/package.json" ]; then
            echo "‚ñ∂ Installing mcp-fs npm dependencies..." | tee -a "${LOG_DIR}/npm.install.log"
            cd mcp-fs
            safe_run "npm.mcp-fs" npm ci || safe_run "npm.mcp-fs.fallback" npm install || true
            cd ..
          fi

          echo "‚úÖ npm dependencies installed and cached" | tee -a "${REPORT_DIR}/SUMMARY.txt"

      - name: "Python env quick check with pip cache"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: 'pip'
          cache-dependency-path: |
            requirements*.txt
            anthropic-cost-tracker/python/requirements.txt
            mcp-hello-py/requirements.txt
            mcp-python-server/requirements.txt
            mcp-apache-server/requirements.txt

      - name: "Install and cache pip dependencies"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          echo "=== Installing pip dependencies and creating cache ===" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          # Upgrade pip first
          safe_run "pip.upgrade" python -m pip install --upgrade pip setuptools wheel || true

          # Root project
          if [ -f "requirements.txt" ]; then
            echo "‚ñ∂ Installing root pip dependencies..." | tee -a "${LOG_DIR}/pip.install.log"
            safe_run "pip.root" pip install -r requirements.txt || true
            safe_run "pip.check.root" pip check > "${REPORT_DIR}/pip_check_root.txt" || true
          fi

          # Anthropic Cost Tracker Python
          if [ -f "anthropic-cost-tracker/python/requirements.txt" ]; then
            echo "‚ñ∂ Installing cost-tracker pip dependencies..." | tee -a "${LOG_DIR}/pip.install.log"
            safe_run "pip.cost-tracker" pip install -r anthropic-cost-tracker/python/requirements.txt || true
          fi

          # MCP Hello Python
          if [ -f "mcp-hello-py/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-hello-py pip dependencies..." | tee -a "${LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-hello-py" pip install -r mcp-hello-py/requirements.txt || true
          fi

          # MCP Python Server
          if [ -f "mcp-python-server/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-python-server pip dependencies..." | tee -a "${LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-python" pip install -r mcp-python-server/requirements.txt || true
          fi

          # MCP Apache Server
          if [ -f "mcp-apache-server/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-apache-server pip dependencies..." | tee -a "${LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-apache" pip install -r mcp-apache-server/requirements.txt || true
          fi

          # Install all other requirements files
          for req in requirements-*.txt; do
            if [ -f "$req" ]; then
              echo "‚ñ∂ Installing $req..." | tee -a "${LOG_DIR}/pip.install.log"
              safe_run "pip.${req}" pip install -r "$req" || true
            fi
          done

          # List installed packages
          pip list --format=json > "${REPORT_DIR}/pip_list.json" || true
          pip list --outdated --format=json > "${REPORT_DIR}/pip_outdated.json" || true

          echo "‚úÖ pip dependencies installed and cached" | tee -a "${REPORT_DIR}/SUMMARY.txt"

      - name: "Check for dependency updates"
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          echo "=== Checking for available updates ===" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          # npm outdated check
          if command -v npm >/dev/null 2>&1; then
            echo "‚ñ∂ Checking npm outdated packages..." | tee -a "${LOG_DIR}/npm.outdated.log"
            npm outdated --json > "${REPORT_DIR}/npm_outdated.json" || true

            # Count outdated packages
            if [ -f "${REPORT_DIR}/npm_outdated.json" ]; then
              OUTDATED_COUNT=$(jq -r 'length' "${REPORT_DIR}/npm_outdated.json" 2>/dev/null || echo "0")
              echo "Found $OUTDATED_COUNT outdated npm packages" | tee -a "${REPORT_DIR}/SUMMARY.txt"
            fi
          fi

          # pip outdated check (already done above)
          if [ -f "${REPORT_DIR}/pip_outdated.json" ]; then
            PIP_OUTDATED_COUNT=$(jq -r 'length' "${REPORT_DIR}/pip_outdated.json" 2>/dev/null || echo "0")
            echo "Found $PIP_OUTDATED_COUNT outdated pip packages" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          fi

          echo "‚úÖ Dependency update check completed" | tee -a "${REPORT_DIR}/SUMMARY.txt"

      - name: "Run python check script"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          cat > "${REPORT_DIR}/py_env.py" << 'EOF'
          import sys, json, platform
          print(json.dumps({
            "python_version": sys.version,
            "platform": platform.platform(),
            "ok": True
          }, indent=2))
          EOF

          safe_run "python.env" python "${REPORT_DIR}/py_env.py" | tee "${REPORT_DIR}/python_env.json"

      - name: "Maven build (skip tests)"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: "Run mvn -DskipTests package"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          if [ -f "pom.xml" ]; then
            safe_run "maven.build" mvn -B -ntp clean package -DskipTests || true
            # dependency tree snapshot
            mvn -B -ntp dependency:tree | head -n 200 > "${REPORT_DIR}/maven_head.txt" || true
          else
            echo "[maven] no pom.xml in this PR branch" > "${REPORT_DIR}/maven_head.txt"
          fi

      - name: "Setup Docker Buildx with cache"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: "Cache Docker layers"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: "Docker smoke build/run"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          safe_run "docker.ensure" ensure_docker || true

          # DockerfileÏù¥ ÏûàÏúºÎ©¥ Í∑∏Í±∏Î°ú, ÏóÜÏúºÎ©¥ fallback Dockerfile ÏÉùÏÑ±
          DF_FALLBACK="${REPORT_DIR}/Dockerfile.ci"
          if [ ! -f "Dockerfile" ]; then
            cat > "${DF_FALLBACK}" <<'EOF'
          FROM alpine:3.20
          RUN echo "dependabot smoke container" > /hello.txt
          CMD ["cat", "/hello.txt"]
          EOF
            DOCKERFILE="$DF_FALLBACK"
          else
            DOCKERFILE="Dockerfile"
          fi

          safe_run "docker.build" docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f "$DOCKERFILE" . -t "${DOCKER_IMG}" --load || true

          # Ï∫êÏãú ÍµêÏ≤¥ (GitHub Actions Í∂åÏû• Î∞©Ïãù)
          rm -rf /tmp/.buildx-cache || true
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

          safe_run "docker.run"  docker run --rm "${DOCKER_IMG}" || true

      ########################################################################
      # 3. Î®∏ÏßÄ Ïó¨Î∂Ä Í≤∞Ï†ï
      #    - depcheck.forced == true  => ÏùòÏ°¥ÏÑ± PRÎ°ú Í∞ÑÏ£º
      #    - auto_merge == true       => ÏûêÎèô merge ÏãúÎèÑ
      ########################################################################
      - name: "Attempt auto-merge if safe"
        if: ${{ steps.depcheck.outputs.forced == 'true' && github.event.inputs.auto_merge != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "[merge] This looks like a dependency update PR (#$PR_NUMBER)."
          echo "[merge] Trying to merge via GitHub CLI..."

          # GitHub CLIÎäî Í∏∞Î≥∏ runnerÏóê ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏùå(gh)
          # fast-forward merge or squash merge, pick one:
          gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
          gh pr merge "$PR_NUMBER" --merge --auto --delete-branch || true

          echo "auto-merge attempted" >> "${REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 4. Ï∫êÏãú Í≤ÄÏ¶ù Î∞è ÌÜµÍ≥Ñ
      ########################################################################
      - name: "Verify cache creation and generate statistics"
        shell: bash
        run: |
          set -Eeuo pipefail

          echo "=== Cache Verification and Statistics ===" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          # Check npm cache
          if command -v npm >/dev/null 2>&1; then
            NPM_CACHE_DIR=$(npm config get cache 2>/dev/null || echo "~/.npm")
            if [ -d "$NPM_CACHE_DIR" ]; then
              NPM_CACHE_SIZE=$(du -sh "$NPM_CACHE_DIR" 2>/dev/null | cut -f1 || echo "unknown")
              echo "‚úÖ npm cache size: $NPM_CACHE_SIZE" | tee -a "${REPORT_DIR}/SUMMARY.txt"
              echo "npm_cache_size=$NPM_CACHE_SIZE" >> "${REPORT_DIR}/cache_stats.txt"
            fi

            # Count node_modules
            NODE_MODULES_COUNT=$(find . -type d -name "node_modules" 2>/dev/null | wc -l || echo "0")
            echo "Found $NODE_MODULES_COUNT node_modules directories" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          fi

          # Check pip cache
          if command -v pip >/dev/null 2>&1; then
            PIP_CACHE_DIR=$(pip cache dir 2>/dev/null || echo "~/.cache/pip")
            if [ -d "$PIP_CACHE_DIR" ]; then
              PIP_CACHE_SIZE=$(du -sh "$PIP_CACHE_DIR" 2>/dev/null | cut -f1 || echo "unknown")
              echo "‚úÖ pip cache size: $PIP_CACHE_SIZE" | tee -a "${REPORT_DIR}/SUMMARY.txt"
              echo "pip_cache_size=$PIP_CACHE_SIZE" >> "${REPORT_DIR}/cache_stats.txt"
            fi

            # Count installed packages
            PIP_PACKAGE_COUNT=$(pip list --format=json 2>/dev/null | jq 'length' || echo "0")
            echo "Installed $PIP_PACKAGE_COUNT pip packages" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          fi

          # Check Maven cache
          if [ -d "$HOME/.m2/repository" ]; then
            MAVEN_CACHE_SIZE=$(du -sh "$HOME/.m2/repository" 2>/dev/null | cut -f1 || echo "unknown")
            echo "‚úÖ Maven cache size: $MAVEN_CACHE_SIZE" | tee -a "${REPORT_DIR}/SUMMARY.txt"
            echo "maven_cache_size=$MAVEN_CACHE_SIZE" >> "${REPORT_DIR}/cache_stats.txt"
          fi

          # Check Docker cache
          if [ -d "/tmp/.buildx-cache" ]; then
            DOCKER_CACHE_SIZE=$(du -sh "/tmp/.buildx-cache" 2>/dev/null | cut -f1 || echo "unknown")
            echo "‚úÖ Docker buildx cache size: $DOCKER_CACHE_SIZE" | tee -a "${REPORT_DIR}/SUMMARY.txt"
            echo "docker_cache_size=$DOCKER_CACHE_SIZE" >> "${REPORT_DIR}/cache_stats.txt"
          fi

          # Actions cache statistics
          echo "" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "GitHub Actions Cache Information:" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "- Cache keys used in this run:" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "  * npm: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "  * pip: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "  * maven: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "  * docker: ${{ runner.os }}-buildx-${{ github.sha }}" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          echo "" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "‚úÖ Cache verification completed" | tee -a "${REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 5. Î¶¨Ìè¨Ìä∏/Î°úÍ∑∏ ÏïÑÌã∞Ìå©Ìä∏ ÏóÖÎ°úÎìú
      ########################################################################
      - name: "Upload dependabot-check artifact"
        if: ${{ github.event.inputs.upload_artifact != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-check-${{ github.run_id }}
          path: .github/dependabot_report
          if-no-files-found: warn
          retention-days: 14
