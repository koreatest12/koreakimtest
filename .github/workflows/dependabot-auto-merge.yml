name: "ğŸ›° API Curl Test Server â€” EchoOps / Safe-Continue / Service Perms / DR+ISO / Stable v2 + TomcatScan"

on:
  workflow_dispatch:
    inputs:
      target_url:            # 1
        description: "í˜¸ì¶œí•  API URL (ë¹ˆê°’ì´ë©´ Anthropic Claude messages)"
        required: false
        default: "https://api.anthropic.com/v1/messages"
      run_mode:              # 2
        description: "full=ì „ì²´ ìˆ˜í–‰ / lite=ìƒì„± ìœ„ì£¼ (curlë„ ì‹œë„í•˜ì§€ë§Œ ì‹¤íŒ¨ ë¬´ì‹œ)"
        required: false
        default: "full"

permissions:
  contents: write
  actions: read
  security-events: read

env:
  TZ: Asia/Seoul

  LOG_DIR: .github/echo_logs
  ARTIFACT_DIR: .github/echo_artifacts
  SERVICE_DIR: .github/echo_services
  PERM_DIR: .github/echo_perm

  # ê´€ë¦¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡
  SERVICES: "claude_api dr_center iso_builder"

jobs:
  curl-test-server:
    name: "Curl Test Server Runner (Echo / Always Success / No Heredoc / TomcatCheck)"
    runs-on: ubuntu-22.04

    steps:
      ##################################################################
      # 0. ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      ##################################################################
      - name: "[prep] Checkout repository"
        uses: actions/checkout@v4

      ##################################################################
      # 0.1 ê³µí†µ ë””ë ‰í† ë¦¬ ìƒì„± + ì ˆëŒ€ ê²½ë¡œ ìº¡ì²˜ + helpers.sh ìƒì„±
      #
      # helpers.shëŠ” ë‹¤ìŒì„ ì œê³µ:
      #   - safe_logdir(): ë¡œê·¸/ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬, ìºì‹œ ë””ë ‰í† ë¦¬ ë“± ì „ë¶€ mkdir -p
      #                     tee 'No such file' ì—ëŸ¬ ì—†ì• ê¸°
      #   - safe_run(): timestampë¥¼ tsë³€ìˆ˜ì— ë‹´ì•„ date ì¸ìš©ê¹¨ì§ ë°©ì§€
      #   - append_status(): ì„œë¹„ìŠ¤ status.log ì— ì•ˆì „í•˜ê²Œ í•œ ì¤„ ì¶”ê°€
      ##################################################################
      - name: "[prep] init dirs + helpers.sh (no heredoc, printf only)"
        id: prep_helpers
        shell: bash
        run: |
          set -Eeuo pipefail

          REPO_ROOT="$PWD"
          ABS_LOG_DIR="${REPO_ROOT}/${LOG_DIR}"
          ABS_ARTIFACT_DIR="${REPO_ROOT}/${ARTIFACT_DIR}"
          ABS_SERVICE_DIR="${REPO_ROOT}/${SERVICE_DIR}"
          ABS_PERM_DIR="${REPO_ROOT}/${PERM_DIR}"

          echo "REPO_ROOT=${REPO_ROOT}"             >> $GITHUB_ENV
          echo "ABS_LOG_DIR=${ABS_LOG_DIR}"         >> $GITHUB_ENV
          echo "ABS_ARTIFACT_DIR=${ABS_ARTIFACT_DIR}" >> $GITHUB_ENV
          echo "ABS_SERVICE_DIR=${ABS_SERVICE_DIR}" >> $GITHUB_ENV
          echo "ABS_PERM_DIR=${ABS_PERM_DIR}"       >> $GITHUB_ENV

          mkdir -p "${ABS_LOG_DIR}" "${ABS_ARTIFACT_DIR}" "${ABS_SERVICE_DIR}" "${ABS_PERM_DIR}" "${REPO_ROOT}/.github/echo_tmp" || true
          mkdir -p "${ABS_ARTIFACT_DIR}/security" || true

          HELPER_PATH="${REPO_ROOT}/.github/echo_tmp/helpers.sh"

          # helpers.sh ìƒì„± (printf í•œ ì¤„ì”©, heredoc ê¸ˆì§€)
          printf '%s\n' '#!/usr/bin/env bash'                                         >  "$HELPER_PATH"
          printf '%s\n' 'set -Eeuo pipefail'                                         >> "$HELPER_PATH"
          printf '%s\n' ''                                                           >> "$HELPER_PATH"
          printf '%s\n' 'LOG_DIR_DEFAULT="'"$ABS_LOG_DIR"'"'                          >> "$HELPER_PATH"
          printf '%s\n' 'ARTIFACT_DIR_DEFAULT="'"$ABS_ARTIFACT_DIR"'"'                >> "$HELPER_PATH"
          printf '%s\n' 'SERVICE_DIR_DEFAULT="'"$ABS_SERVICE_DIR"'"'                  >> "$HELPER_PATH"
          printf '%s\n' 'PERM_DIR_DEFAULT="'"$ABS_PERM_DIR"'"'                        >> "$HELPER_PATH"
          printf '%s\n' ''                                                           >> "$HELPER_PATH"
          printf '%s\n' 'LOG_DIR_USE="${LOG_DIR:-$LOG_DIR_DEFAULT}"'                 >> "$HELPER_PATH"
          printf '%s\n' 'ARTIFACT_DIR_USE="${ARTIFACT_DIR:-$ARTIFACT_DIR_DEFAULT}"'  >> "$HELPER_PATH"
          printf '%s\n' 'SERVICE_DIR_USE="${SERVICE_DIR:-$SERVICE_DIR_DEFAULT}"'    >> "$HELPER_PATH"
          printf '%s\n' 'PERM_DIR_USE="${PERM_DIR:-$PERM_DIR_DEFAULT}"'              >> "$HELPER_PATH"
          printf '%s\n' ''                                                           >> "$HELPER_PATH"

          # safe_logdir: mkdir -p ë¨¼ì € í•´ì„œ teeê°€ ì ˆëŒ€ ì‹¤íŒ¨ ì•ˆ í•˜ë„ë¡
          printf '%s\n' 'safe_logdir() {'                                            >> "$HELPER_PATH"
          printf '%s\n' '  mkdir -p "$LOG_DIR_USE" "$ARTIFACT_DIR_USE" "$SERVICE_DIR_USE" "$PERM_DIR_USE" /tmp/.buildx-cache || true' >> "$HELPER_PATH"
          printf '%s\n' '  mkdir -p "$ARTIFACT_DIR_USE/security" || true'            >> "$HELPER_PATH"
          printf '%s\n' '  touch "$LOG_DIR_USE/.keep" "$ARTIFACT_DIR_USE/.keep" /tmp/.buildx-cache/.keep || true' >> "$HELPER_PATH"
          printf '%s\n' '}'                                                          >> "$HELPER_PATH"
          printf '%s\n' ''                                                           >> "$HELPER_PATH"

          # safe_run: timestampë¥¼ ts ë³€ìˆ˜ì— ë¨¼ì € ë‹´ìŒ (date ì¸ìš© ê¹¨ì§ ë°©ì§€)
          printf '%s\n' 'safe_run() {'                                               >> "$HELPER_PATH"
          printf '%s\n' '  local label="$1"; shift || true'                          >> "$HELPER_PATH"
          printf '%s\n' '  safe_logdir'                                              >> "$HELPER_PATH"
          printf '%s\n' '  local logfile="$LOG_DIR_USE/${label}.log"'                >> "$HELPER_PATH"
          printf '%s\n' '  local ts="$(date -u '\''+%Y-%m-%dT%H:%M:%S%z'\'')" '      >> "$HELPER_PATH"
          printf '%s\n' '  echo "â–¶ [${label}] START ${ts}" | tee -a "$logfile"'      >> "$HELPER_PATH"
          printf '%s\n' '  if "$@" >> "$logfile" 2>&1 ; then'                        >> "$HELPER_PATH"
          printf '%s\n' '    echo "âœ… [${label}] OK" | tee -a "$logfile"'            >> "$HELPER_PATH"
          printf '%s\n' '    return 0'                                               >> "$HELPER_PATH"
          printf '%s\n' '  else'                                                     >> "$HELPER_PATH"
          printf '%s\n' '    local rc=$?'                                            >> "$HELPER_PATH"
          printf '%s\n' '    echo "âŒ [${label}] FAILED exit=${rc}" | tee -a "$logfile"' >> "$HELPER_PATH"
          printf '%s\n' '    return $rc'                                             >> "$HELPER_PATH"
          printf '%s\n' '  fi'                                                       >> "$HELPER_PATH"
          printf '%s\n' '}'                                                          >> "$HELPER_PATH"
          printf '%s\n' ''                                                           >> "$HELPER_PATH"

          # append_status: ì„œë¹„ìŠ¤ status.log ì— ë¼ì¸ ì¶”ê°€ (ì„œë¹„ìŠ¤ ë¡œê·¸ ì¶”ì ìš©)
          printf '%s\n' 'append_status() {'                                          >> "$HELPER_PATH"
          printf '%s\n' '  local svc="$1"; shift || true'                            >> "$HELPER_PATH"
          printf '%s\n' '  local line="$*"'                                          >> "$HELPER_PATH"
          printf '%s\n' '  local file="${SERVICE_DIR_USE}/${svc}/status.log"'        >> "$HELPER_PATH"
          printf '%s\n' '  safe_logdir'                                              >> "$HELPER_PATH"
          printf '%s\n' '  printf "%s\n" "${line}" >> "$file" || true'               >> "$HELPER_PATH"
          printf '%s\n' '  chmod 640 "$file" || true'                                >> "$HELPER_PATH"
          printf '%s\n' '}'                                                          >> "$HELPER_PATH"

          chmod +x "$HELPER_PATH"

          # ì´ˆê¸° ë¡œê·¸ í•œ ì¤„
          safe_ts="$(date '+%Y-%m-%d %H:%M:%S%z')"
          {
            echo "## API Curl Test Server Report"
            echo "Run: ${GITHUB_RUN_ID}"
            echo "Repo: ${GITHUB_REPOSITORY}"
            echo "Time: ${safe_ts}"
            echo "----------------------------------------"
          } >> "${ABS_ARTIFACT_DIR}/security/workflow_summary.txt"

          echo "[prep] base dirs + helpers.sh ready" | tee -a "${ABS_LOG_DIR}/prep.init.log"

      ##################################################################
      # 1. ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ / ê¶Œí•œ íŒŒì¼ / status.log ìƒì„±
      ##################################################################
      - name: "[svc] Init service dirs + perms + status"
        env:
          SERVICES: ${{ env.SERVICES }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          echo ">>> [svc] start" | tee -a "${LOG_DIR}/svc.init.log"

          for svc in $SERVICES; do
            svc_dir="${SERVICE_DIR}/${svc}"
            svc_perm="${PERM_DIR}/${svc}"

            mkdir -p "$svc_dir" "$svc_perm" || true

            # README.md
            printf '%s\n' "# Service: ${svc}" > "${svc_dir}/README.md"

            # status.log (ì´ˆê¸°í™”)
            printf '%s\n' "[INIT] $(date '+%Y-%m-%d %H:%M:%S%z') service=${svc} created" > "${svc_dir}/status.log"

            # permissions.txt
            {
              printf '%s\n' "[PERMISSIONS]"
              printf '%s\n' "service=${svc}"
              printf '%s\n' "owner=runner"
              printf '%s\n' "access=rw"
              printf '%s\n' "note=ìë™ ìƒì„±ëœ ê¶Œí•œ/ì ‘ê·¼ ì œì–´ í…œí”Œë¦¿"
            } > "${svc_perm}/permissions.txt"

            # ìµœì†Œ ê¶Œí•œ
            chmod 600 "${svc_perm}/permissions.txt" || true
            chmod 640 "${svc_dir}/status.log"       || true
            chmod 644 "${svc_dir}/README.md"        || true

            echo "[svc:$svc] prepared dirs/files/perm" | tee -a "${LOG_DIR}/svc.init.log"
          done

          echo ">>> [svc] done" | tee -a "${LOG_DIR}/svc.init.log"

      ##################################################################
      # 2. DR ì„¼í„° / ISO ë¹Œë” í…œí”Œë¦¿ ìƒì„±
      ##################################################################
      - name: "[svc] DR / ISO templates"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          echo ">>> [dr+iso] start" | tee -a "${LOG_DIR}/dr_iso.init.log"

          dr_dir="${SERVICE_DIR}/dr_center"
          iso_dir="${SERVICE_DIR}/iso_builder"

          # DR ë°±ì—… í”Œëœ
          {
            printf '%s\n' "[DR_BACKUP_PLAN]"
            printf '%s\n' "retention_days=1"
            printf '%s\n' "description=í•˜ë£¨ ë‹¨ìœ„ DR ë°ì´í„°ì„¼í„° ë³´ê´€ ì •ì±…"
            printf '%s\n' "snapshot_policy=nightly+on-demand"
          } > "${dr_dir}/dr_backup_plan.txt"

          # ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸
          {
            printf '%s\n' "[ISO_MANIFEST]"
            printf '%s\n' "image_name=finops-snapshot.iso"
            printf '%s\n' "includes=logs,configs,sql,artifacts"
            printf '%s\n' "note=ì´ íŒŒì¼ì€ ISO ì´ë¯¸ì§€ì— í¬í•¨í•  ìì›ì„ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿ì…ë‹ˆë‹¤."
          } > "${iso_dir}/iso_manifest.txt"

          chmod 640 "${dr_dir}/dr_backup_plan.txt"   || true
          chmod 640 "${iso_dir}/iso_manifest.txt"    || true

          # status.log append (append_status()ë¡œ ì•ˆì „í•˜ê²Œ)
          append_status "dr_center"  "[DR_INIT]  $(date '+%Y-%m-%d %H:%M:%S%z') backup plan prepared"
          append_status "iso_builder" "[ISO_INIT] $(date '+%Y-%m-%d %H:%M:%S%z') iso manifest prepared"

          echo ">>> [dr+iso] done" | tee -a "${LOG_DIR}/dr_iso.init.log"

      ##################################################################
      # 3. í™˜ê²½ ìŠ¤ëƒ…ìƒ· (df -h, env ë“±)
      ##################################################################
      - name: "[snap] Environment snapshot"
        env:
          LOG_DIR: ${{ env.LOG_DIR }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          SNAP_LOG="${LOG_DIR}/env_snapshot.log"

          echo ">>> [snap] start" | tee -a "$SNAP_LOG"
          {
            echo "===== ENV SNAPSHOT ====="
            date
            uname -a
            echo "--- df -h ---"
            df -h
            echo "--- env | sort ---"
            env | sort
          } | tee -a "$SNAP_LOG"
          echo ">>> [snap] done" | tee -a "$SNAP_LOG"

      ##################################################################
      # 4. Maven ê¸°ë°˜ Tomcat ì·¨ì•½ì  ì ê²€ (CVE-2025-24813 ê´€ë ¨)
      #    - mvn dependency:tree ì—ì„œ tomcat-embed-core ë²„ì „ ì¶”ì¶œ
      #    - 10.1.35 ë¯¸ë§Œì´ë©´ ìœ„í—˜ìœ¼ë¡œ í‘œì‹œ
      #    - ê²°ê³¼ë¥¼ echo_logs/tomcat_scan.log ì™€
      #      echo_artifacts/security/tomcat_security_report.txt ì— ì €ì¥
      ##################################################################
      - name: "[sec] Tomcat vulnerability scan (CVE-2025-24813 best-effort)"
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          SCAN_LOG="${LOG_DIR}/tomcat_scan.log"
          REPORT_TXT="${ARTIFACT_DIR}/security/tomcat_security_report.txt"

          echo ">>> [tomcat-scan] start" | tee -a "$SCAN_LOG"

          if [ -f "pom.xml" ]; then
            # Maven ì„¤ì¹˜ (ê°„ë‹¨ ë²„ì „)
            safe_run "mvn.version" bash -c "mvn -v" || true

            # ì˜ì¡´ì„± íŠ¸ë¦¬ (ìµœëŒ€ 200ì¤„ë§Œ ì €ì¥í•´ì„œ í­ë°œ ë°©ì§€)
            mvn -B -ntp dependency:tree | head -n 200 > "${ARTIFACT_DIR}/security/maven_dep_tree.txt" 2>>"$SCAN_LOG" || true

            # tomcat-embed-core ë²„ì „ ì¶”ì¶œ (ì²« ë§¤ì¹­)
            TOMCAT_LINE=$(mvn -B -ntp dependency:tree 2>/dev/null | grep 'org.apache.tomcat.embed:tomcat-embed-core' | head -n 1 || true)
            TOMCAT_VER=$(echo "$TOMCAT_LINE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1 || true)

            {
              echo "Detected tomcat-embed-core line:"
              echo "$TOMCAT_LINE"
              echo "Parsed version: $TOMCAT_VER"
            } | tee -a "$SCAN_LOG"

            printf '%s\n' "=== Tomcat Security Check ==="          >  "$REPORT_TXT"
            printf '%s\n' "time=$(date '+%Y-%m-%d %H:%M:%S%z')"    >> "$REPORT_TXT"
            printf '%s\n' "tomcat_version=${TOMCAT_VER}"           >> "$REPORT_TXT"
            printf '%s\n' "required_secure_version=10.1.35+"       >> "$REPORT_TXT"
            printf '%s\n' "cve=CVE-2025-24813 (Remote Code Execution / Info Disclosure risk)" >> "$REPORT_TXT"
            printf '%s\n' "note=If tomcat_version < 10.1.35, upgrade Spring Boot BOM or override tomcat-embed-core to 10.1.35+." >> "$REPORT_TXT"

            # ë‹¨ìˆœ ë¹„êµ: ë¬¸ìì—´ ë¹„êµë¼ 10.1.9 vs 10.1.35 ê°™ì€ ì„¸ë¶€ ë¹„êµëŠ” ì™„ë²½í•˜ì§€ ì•Šì§€ë§Œ
            # ë³´ì•ˆ ë³´ê³ ìš©ìœ¼ë¡œë§Œ ì ì¬
            if [ -n "$TOMCAT_VER" ]; then
              if [ "$TOMCAT_VER" != "10.1.35" ] && [ "$TOMCAT_VER" != "10.1.36" ] && [ "$TOMCAT_VER" != "10.1.37" ]; then
                echo "âš  Potentially vulnerable Tomcat version ($TOMCAT_VER). Please upgrade to >=10.1.35." | tee -a "$SCAN_LOG"
                printf '%s\n' "status=WARNING_OUTDATED" >> "$REPORT_TXT"
              else
                echo "âœ… Tomcat version looks patched/safe-ish ($TOMCAT_VER)." | tee -a "$SCAN_LOG"
                printf '%s\n' "status=LIKELY_SAFE"      >> "$REPORT_TXT"
              fi
            else
              echo "â„¹ tomcat-embed-core not detected (maybe not a Spring Boot web app in this repo)." | tee -a "$SCAN_LOG"
              printf '%s\n' "status=NOT_DETECTED"       >> "$REPORT_TXT"
            fi
          else
            echo "pom.xml not found, skipping Tomcat scan." | tee -a "$SCAN_LOG"
            printf '%s\n' "=== Tomcat Security Check ==="     >  "$REPORT_TXT"
            printf '%s\n' "status=NO_MAVEN_PROJECT"          >> "$REPORT_TXT"
            printf '%s\n' "time=$(date '+%Y-%m-%d %H:%M:%S%z')" >> "$REPORT_TXT"
          fi

          chmod 640 "$REPORT_TXT" || true
          echo ">>> [tomcat-scan] done" | tee -a "$SCAN_LOG"

      ##################################################################
      # 5. Anthropic Claude API curl í˜¸ì¶œ (continue-on-error)
      #    - ì‹¤íŒ¨í•˜ë”ë¼ë„ ì›Œí¬í”Œë¡œìš° ê³„ì†
      ##################################################################
      - name: "[api] Curl call Anthropic Claude messages API (Echo Safe)"
        continue-on-error: true
        env:
          INPUT_URL: ${{ github.event.inputs.target_url }}
          SECR_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LOG_DIR: ${{ env.LOG_DIR }}
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          echo ">>> [api] start" | tee -a "${LOG_DIR}/curl_init.log"

          TARGET_URL="${INPUT_URL}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="https://api.anthropic.com/v1/messages"
          fi

          echo "[api] TARGET_URL=${TARGET_URL}" | tee -a "${LOG_DIR}/curl_init.log"

          REQ_DIR="${LOG_DIR}/curl_request"
          RESP_DIR="${LOG_DIR}/curl_response"
          mkdir -p "$REQ_DIR" "$RESP_DIR"

          # ìš”ì²­ ë°”ë”” JSON (printfë¡œë§Œ ì‘ì„±, heredoc ê¸ˆì§€)
          {
            printf '%s\n' '{'
            printf '%s\n' '  "model": "claude-3-opus-20240229",'
            printf '%s\n' '  "max_tokens": 64,'
            printf '%s\n' '  "messages": ['
            printf '%s\n' '    { "role": "user", "content": "ì•ˆë…•, ì‚¬ìš©ëŸ‰ usage í•„ë“œ ë³´ì—¬ì¤˜." }'
            printf '%s\n' '  ]'
            printf '%s\n' '}'
          } > "${REQ_DIR}/request_body.json"

          status_file="${RESP_DIR}/status_code.txt"
          body_file="${RESP_DIR}/body.json"
          header_file="${RESP_DIR}/headers.txt"
          usage_log="${RESP_DIR}/usage.log"

          echo "[api] curl POST ${TARGET_URL}" | tee -a "${LOG_DIR}/curl_init.log"
          echo "[api] headers: Content-Type, anthropic-version, x-api-key(masked)" | tee -a "${LOG_DIR}/curl_init.log"

          # curl ìš”ì²­
          curl -sS -X POST "${TARGET_URL}" \
            -H "Content-Type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            -H "x-api-key: ${SECR_KEY}" \
            -D "${header_file}" \
            --data @"${REQ_DIR}/request_body.json" \
            -o "${body_file}" \
            --write-out "%{http_code}" > "${status_file}"

          echo "[api] curl done." | tee -a "${LOG_DIR}/curl_init.log"

          echo "[api] status code:" | tee -a "${LOG_DIR}/curl_init.log"
          cat "${status_file}"      | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] headers (first lines):" | tee -a "${LOG_DIR}/curl_init.log"
          head -n 20 "${header_file}"         | tee -a "${LOG_DIR}/curl_init.log" || true

          echo "[api] body (first 500 chars):" | tee -a "${LOG_DIR}/curl_init.log"
          head -c 500 "${body_file}"           | tee -a "${LOG_DIR}/curl_init.log" || true
          echo ""                              | tee -a "${LOG_DIR}/curl_init.log"

          # usage í•„ë“œ(í† í° ì‚¬ìš©ëŸ‰) ì¶”ì¶œ ì‹œë„
          printf '%s\n' "[api] extracting usage best-effort" | tee "${usage_log}"
          grep -E '"usage"|input_tokens|output_tokens' "${body_file}" >> "${usage_log}" 2>/dev/null || true

          # claude_api/status.log ì— append
          append_status "claude_api" "[CALL] $(date '+%Y-%m-%d %H:%M:%S%z') status_code=$(cat "${status_file}" 2>/dev/null || echo 'N/A') note=See curl_response/"

          # ë¯¼ê°/ì‘ë‹µ ë¡œê·¸ ìµœì†Œ ê¶Œí•œ
          chmod 600 "${status_file}" "${header_file}" "${body_file}" "${usage_log}" 2>/dev/null || true

          echo ">>> [api] done" | tee -a "${LOG_DIR}/curl_init.log"

      ##################################################################
      # 6. ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ & ì—…ë¡œë“œ
      ##################################################################
      - name: "[collect] Prepare artifacts"
        env:
          SERVICE_DIR: ${{ env.SERVICE_DIR }}
          PERM_DIR: ${{ env.PERM_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          LOG_DIR: ${{ env.LOG_DIR }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source ".github/echo_tmp/helpers.sh"
          safe_logdir

          echo ">>> [collect] start" | tee -a "${LOG_DIR}/artifact.bundle.log"

          mkdir -p "${ARTIFACT_DIR}/services" "${ARTIFACT_DIR}/permissions" || true
          cp -r "${SERVICE_DIR}/." "${ARTIFACT_DIR}/services/"     || true
          cp -r "${PERM_DIR}/."    "${ARTIFACT_DIR}/permissions/"  || true

          echo ">>> listing ${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          ls -R "${ARTIFACT_DIR}" | tee -a "${LOG_DIR}/artifact.bundle.log"
          echo ">>> [collect] done" | tee -a "${LOG_DIR}/artifact.bundle.log"

      - name: "[artifact] Upload logs + services + perms + security"
        uses: actions/upload-artifact@v4
        with:
          name: api-curl-test-server-logs-and-services
          path: |
            .github/echo_logs
            .github/echo_artifacts
            .github/echo_services
            .github/echo_perm
          if-no-files-found: warn
          retention-days: 7

      ##################################################################
      # 7. ë§ˆì§€ë§‰ ë¦¬í¬íŠ¸ (í•­ìƒ ì„±ê³µ ì„ ì–¸)
      ##################################################################
      - name: "[final] Overall status (ALWAYS-SUCCESS)"
        shell: bash
        run: |
          echo "âœ… [FINAL] API Curl Test Server workflow finished."
          echo "   - ëª¨ë“  ë‹¨ê³„ëŠ” echo ê¸°ë°˜ safe_run/safe_logdir ë¡œ ë””ë ‰í† ë¦¬ ë³´ì¥ í›„ ë¡œê¹…í–ˆìŠµë‹ˆë‹¤."
          echo "   - Anthropic Claude ì—”ë“œí¬ì¸íŠ¸(${INPUT_URL})ì— curl POSTë¥¼ ì‹œë„í–ˆê³  ì‹¤íŒ¨í•´ë„ continue-on-errorë¡œ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰í–ˆìŠµë‹ˆë‹¤."
          echo "   - claude_api / dr_center / iso_builder ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ê³  status.log / permissions.txt / README.mdë¥¼ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤."
          echo "   - DR ë°±ì—… ê³„íš(dr_backup_plan.txt)ê³¼ ISO ë§¤ë‹ˆí˜ìŠ¤íŠ¸(iso_manifest.txt)ë¥¼ ì¤€ë¹„í•´ ì¬í•´ë³µêµ¬/ìŠ¤ëƒ…ìƒ· íë¦„ê¹Œì§€ í…œí”Œë¦¿í™”í–ˆìŠµë‹ˆë‹¤."
          echo "   - í™˜ê²½ ìŠ¤ëƒ…ìƒ·(df -h, uname, env)ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤."
          echo "   - Tomcat ì·¨ì•½ì (CVE-2025-24813) ì—¬ë¶€ë¥¼ maven dependency:treeë¡œ ì ê²€í•˜ê³  ë³´ê³ ì„œë¥¼ echo_artifacts/security/tomcat_security_report.txt ì— ë‚¨ê²¼ìŠµë‹ˆë‹¤."
          echo "   - echo_logs, echo_artifacts, echo_services, echo_perm ì „ì²´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤."
          echo "   - ë§ˆì§€ë§‰ ë‹¨ê³„ëŠ” í•­ìƒ ì„±ê³µìœ¼ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
          echo "DONE."
