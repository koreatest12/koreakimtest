# íŒŒì¼ ê²½ë¡œ: .github/workflows/dependabot-auto-merge.yml
name: "Dependabot Auto Merge (ìë™ ì—…ë°ì´íŠ¸ í†µí•© ì ê²€ ë° ë³‘í•©)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      auto_merge:        # 1
        description: "ë¹Œë“œ í†µê³¼ ì‹œ ìë™ merge í• ê¹Œìš”?"
        type: boolean
        default: true
      repair_mode:       # 2
        description: "ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìë™ ë³µêµ¬(apt/dpkg/docker ë“±) ì‹œë„"
        type: boolean
        default: true
      run_docker_check:  # 3
        description: "Docker ì´ë¯¸ì§€ ë¹Œë“œ/ì»¨í…Œì´ë„ˆ ìŠ¤ëª¨í¬ë„ ê°™ì´ ìˆ˜í–‰í• ì§€"
        type: boolean
        default: true
      run_maven_build:   # 4
        description: "Maven íŒ¨í‚¤ì§• ë¹Œë“œë¥¼ ìˆ˜í–‰í• ì§€(-DskipTestsë¡œ ë¹ ë¥´ê²Œ)"
        type: boolean
        default: true
      run_python_check:  # 5
        description: "Python ëŸ°íƒ€ì„ ì²´í¬ ìˆ˜í–‰í• ì§€"
        type: boolean
        default: true
      upload_artifact:   # 6
        description: "ë¡œê·¸/ë¦¬í¬íŠ¸ artifact ì—…ë¡œë“œ ì—¬ë¶€"
        type: boolean
        default: true
      force_labels:      # 7
        description: "ê°•ì œë¡œ dependabot ì²˜ëŸ¼ ì²˜ë¦¬ (ë¼ë²¨ ë¬´ì‹œ)"
        type: boolean
        default: false

permissions:
  contents: write           # merge / commit ì— í•„ìš”
  pull-requests: write      # PR merge ì— í•„ìš”
  packages: write
  id-token: write

env:
  TZ: Asia/Seoul
  REPORT_DIR: .github/dependabot_report
  LOG_DIR: .github/dependabot_report/logs
  ARTIFACT_DIR: .github/dependabot_report/artifacts
  DOCKER_IMG: dependabot-ci-test:latest

jobs:
  validate_and_merge:
    name: "ğŸ”„ Dependabot PR ê²€ì¦ & ìë™ ë³‘í•©"
    runs-on: ubuntu-latest

    steps:
      ########################################################################
      # 0. ì²´í¬ì•„ì›ƒ + ì¤€ë¹„
      ########################################################################
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          # dependabot PRë„ fetch ê°€ëŠ¥í•˜ê²Œ
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: "Cache npm dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            anthropic-cost-tracker/nodejs/node_modules
            mcp-hello-js/node_modules
            mcp-fs/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: "Cache pip packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
            anthropic-cost-tracker/python/.venv
            mcp-hello-py/.venv
            mcp-python-server/.venv
            mcp-apache-server/.venv
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "Cache Maven dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            mcp-hello-java/target
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: "Prepare folders & helpers"
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${REPORT_DIR}" "${LOG_DIR}" "${ARTIFACT_DIR}"

          cat > "${REPORT_DIR}/helpers.sh" << 'EOF'
          #!/usr/bin/env bash
          set -Euo pipefail

          safe_run() {
            local label="$1"; shift || true
            echo "â–¶ [${label}] START $(date '+%Y-%m-%d %H:%M:%S%z')" | tee -a "${LOG_DIR}/${label}.log"
            if "$@" >> "${LOG_DIR}/${label}.log" 2>&1 ; then
              echo "âœ… [${label}] OK" | tee -a "${LOG_DIR}/${label}.log"
              return 0
            else
              local rc=$?
              echo "âŒ [${label}] FAILED exit=${rc}" | tee -a "${LOG_DIR}/${label}.log"
              return $rc
            fi
          }

          apt_fix() {
            echo "[fix] attempting apt/dpkg repair..." | tee -a "${LOG_DIR}/apt.fix.log"
            sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
            sudo dpkg --configure -a || true
            sudo apt-get update -y || sudo apt-get update -y || true
          }

          ensure_docker() {
            if ! command -v docker >/dev/null 2>&1; then
              echo "[fix] docker not found, installing..." | tee -a "${LOG_DIR}/docker.ensure.log"
              apt_fix
              sudo apt-get install -y ca-certificates curl gnupg || true
              sudo install -m 0755 -d /etc/apt/keyrings || true
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg || true
              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null || true
              apt_fix
              sudo apt-get install -y docker.io docker-buildx-plugin docker-compose-plugin || true
              sudo usermod -aG docker $USER || true
            fi

            if ! docker info >/dev/null 2>&1; then
              echo "[fix] starting docker service..." | tee -a "${LOG_DIR}/docker.ensure.log"
              sudo systemctl start docker || true
              sleep 2
            fi
          }
          EOF
          chmod +x "${REPORT_DIR}/helpers.sh"

          echo "## Dependabot Auto Merge Report" > "${REPORT_DIR}/SUMMARY.txt"
          echo "Run: ${GITHUB_RUN_ID}"         >> "${REPORT_DIR}/SUMMARY.txt"
          echo "Repo: ${GITHUB_REPOSITORY}"    >> "${REPORT_DIR}/SUMMARY.txt"
          echo "PR:   ${GITHUB_REF}"           >> "${REPORT_DIR}/SUMMARY.txt"
          echo "Time: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> "${REPORT_DIR}/SUMMARY.txt"
          echo "----------------------------------------" >> "${REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 1. ì´ PRì´ Dependabot PRì¸ì§€ í™•ì¸ (ë¼ë²¨ë¡œ íŒë‹¨)
      #    - ë¼ë²¨ ì—†ë”ë¼ë„ force_labels=trueë©´ ê·¸ëƒ¥ ì§„í–‰
      ########################################################################
      - name: "Check if PR is from Dependabot (label check)"
        id: depcheck
        shell: bash
        run: |
          set -Eeuo pipefail

          FORCE="${{ github.event.inputs.force_labels || 'false' }}"
          if [ "$FORCE" = "true" ]; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # GitHub API ì—†ì´ ë‹¨ìˆœí•˜ê²Œ event payloadë¥¼ ë³´ê³  guess í•˜ëŠ” ë°©ë²•:
          #  - github.actor == dependabot[bot] ì´ë©´ ê±°ì˜ í™•ì‹¤
          #  - ë¼ë²¨ ëª©ë¡ ì•ˆì— 'dependency' ê°™ì€ ê±° ìˆìœ¼ë©´ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ PRì¼ í™•ë¥  í¼
          ACTOR="${{ github.actor }}"
          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'

          echo "actor=$ACTOR" | tee -a "${REPORT_DIR}/SUMMARY.txt"
          echo "labels=$LABELS_JSON" | tee -a "${REPORT_DIR}/SUMMARY.txt"

          if echo "$ACTOR" | grep -qi "dependabot"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$LABELS_JSON" | grep -qi "dependency"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ PRì´ ì•„ë‹ ìˆ˜ë„ ìˆìŒ
          echo "forced=false" >> $GITHUB_OUTPUT

      ########################################################################
      # 2. ì‹œìŠ¤í…œ/ë¹Œë“œ í—¬ìŠ¤ ì²´í¬ (Maven / Python / Docker / Node.js) - ì„ íƒì  ì‹¤í–‰
      ########################################################################
      - name: "Repair base system if needed (apt/dpkg/docker)"
        if: ${{ github.event.inputs.repair_mode != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"
          apt_fix || true
          ensure_docker || true

      - name: "Setup Node.js with npm cache"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            anthropic-cost-tracker/nodejs/package-lock.json
            mcp-hello-js/package-lock.json
            mcp-fs/package-lock.json

      - name: "Python env quick check with pip cache"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: 'pip'
          cache-dependency-path: |
            requirements*.txt
            anthropic-cost-tracker/python/requirements.txt
            mcp-hello-py/requirements.txt
            mcp-python-server/requirements.txt
            mcp-apache-server/requirements.txt

      - name: "Run python check script"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          cat > "${REPORT_DIR}/py_env.py" << 'EOF'
          import sys, json, platform
          print(json.dumps({
            "python_version": sys.version,
            "platform": platform.platform(),
            "ok": True
          }, indent=2))
          EOF

          safe_run "python.env" python "${REPORT_DIR}/py_env.py" | tee "${REPORT_DIR}/python_env.json"

      - name: "Maven build (skip tests)"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: "Run mvn -DskipTests package"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          if [ -f "pom.xml" ]; then
            safe_run "maven.build" mvn -B -ntp clean package -DskipTests || true
            # dependency tree snapshot
            mvn -B -ntp dependency:tree | head -n 200 > "${REPORT_DIR}/maven_head.txt" || true
          else
            echo "[maven] no pom.xml in this PR branch" > "${REPORT_DIR}/maven_head.txt"
          fi

      - name: "Setup Docker Buildx with cache"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: "Cache Docker layers"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: "Docker smoke build/run"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${REPORT_DIR}/helpers.sh"

          safe_run "docker.ensure" ensure_docker || true

          # Dockerfileì´ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ, ì—†ìœ¼ë©´ fallback Dockerfile ìƒì„±
          DF_FALLBACK="${REPORT_DIR}/Dockerfile.ci"
          if [ ! -f "Dockerfile" ]; then
            cat > "${DF_FALLBACK}" << 'EOF'
            FROM alpine:3.20
            RUN echo "dependabot smoke container" > /hello.txt
            CMD ["cat", "/hello.txt"]
            EOF
            DOCKERFILE="$DF_FALLBACK"
          else
            DOCKERFILE="Dockerfile"
          fi

          safe_run "docker.build" docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f "$DOCKERFILE" . -t "${DOCKER_IMG}" --load || true

          # ìºì‹œ êµì²´ (GitHub Actions ê¶Œì¥ ë°©ì‹)
          rm -rf /tmp/.buildx-cache || true
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

          safe_run "docker.run"  docker run --rm "${DOCKER_IMG}" || true

      ########################################################################
      # 3. ë¨¸ì§€ ì—¬ë¶€ ê²°ì •
      #    - depcheck.forced == true  => ì˜ì¡´ì„± PRë¡œ ê°„ì£¼
      #    - auto_merge == true       => ìë™ merge ì‹œë„
      ########################################################################
      - name: "Attempt auto-merge if safe"
        if: ${{ steps.depcheck.outputs.forced == 'true' && github.event.inputs.auto_merge != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "[merge] This looks like a dependency update PR (#$PR_NUMBER)."
          echo "[merge] Trying to merge via GitHub CLI..."

          # GitHub CLIëŠ” ê¸°ë³¸ runnerì— ì„¤ì¹˜ë˜ì–´ ìˆìŒ(gh)
          # fast-forward merge or squash merge, pick one:
          gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
          gh pr merge "$PR_NUMBER" --merge --auto --delete-branch || true

          echo "auto-merge attempted" >> "${REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 4. ë¦¬í¬íŠ¸/ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      ########################################################################
      - name: "Upload dependabot-check artifact"
        if: ${{ github.event.inputs.upload_artifact != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-check-${{ github.run_id }}
          path: .github/dependabot_report
          if-no-files-found: warn
          retention-days: 14
