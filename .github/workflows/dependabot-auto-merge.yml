name: "Dependabot Auto Merge (ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏+Ï∫êÏãú/ÎîîÎ†âÌÜ†Î¶¨ ÏÑ†ÏÉùÏÑ±+Ï†àÎåÄÍ≤ΩÎ°ú Î°úÍ∑∏ ÏïàÏ†ïÌôî)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      auto_merge:        # 1
        description: "ÎπåÎìú ÌÜµÍ≥º Ïãú ÏûêÎèô merge Ìï†ÍπåÏöî?"
        type: boolean
        default: true
      repair_mode:       # 2
        description: "ÎπåÎìú/ÌÖåÏä§Ìä∏ Ïã§Ìå® Ïãú apt/dpkg/docker Î≥µÍµ¨ ÏãúÎèÑ"
        type: boolean
        default: true
      run_docker_check:  # 3
        description: "Docker ÎπåÎìú/Ïª®ÌÖåÏù¥ÎÑà Ïä§Î™®ÌÅ¨ Ïã§Ìñâ?"
        type: boolean
        default: true
      run_maven_build:   # 4
        description: "Maven Ìå®ÌÇ§Ïßï (-DskipTests)"
        type: boolean
        default: true
      run_python_check:  # 5
        description: "Python ÌôòÍ≤Ω Í≤ÄÏÇ¨ / pip install"
        type: boolean
        default: true
      upload_artifact:   # 6
        description: "Î¶¨Ìè¨Ìä∏/Î°úÍ∑∏ artifact ÏóÖÎ°úÎìú"
        type: boolean
        default: true
      force_labels:      # 7
        description: "ÎùºÎ≤®/actor Í≤ÄÏÇ¨ ÏóÜÏù¥ ÏùòÏ°¥ÏÑ± PRÎ°ú Í∞ÑÏ£º"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  packages: write
  id-token: write

env:
  TZ: Asia/Seoul

  # ÏÉÅÎåÄ Í≤ΩÎ°ú Í∏∞Î∞ò Î£®Ìä∏ (repo root Í∏∞Ï§Ä)
  REPORT_DIR: .github/dependabot_report
  LOG_DIR: .github/dependabot_report/logs
  ARTIFACT_DIR: .github/dependabot_report/artifacts
  DOCKER_IMG: dependabot-ci-test:latest

jobs:
  validate_and_merge:
    name: "üîÑ Dependabot PR Í≤ÄÏ¶ù & ÏûêÎèô Î≥ëÌï© (Ï†àÎåÄÍ≤ΩÎ°ú Î°úÍ∑∏ ÏïàÏ†ïÌôî)"
    runs-on: ubuntu-latest

    steps:
      ########################################################################
      # 0. Ï≤¥ÌÅ¨ÏïÑÏõÉ
      ########################################################################
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      ########################################################################
      # 0.1 Ï†àÎåÄÍ≤ΩÎ°ú Í≥ÑÏÇ∞ Î∞è Ï∫êÏãú/ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨/Î¶¨Ìè¨Ìä∏/Î°úÍ∑∏/ÏïÑÌã∞Ìå©Ìä∏ ÏÑ†Ï†ú ÏÉùÏÑ±
      #     - Ï†àÎåÄÍ≤ΩÎ°úÎ•º Ïù¥ÌõÑ env ÌååÏùºÎ°ú exportÌï¥ÏÑú Î™®Îì† stepÏóêÏÑú Í≥µÌÜµ ÏÇ¨Ïö©
      ########################################################################
      - name: "Pre-create dirs, caches, placeholders, helpers (ABSOLUTE PATH READY)"
        id: prep_all
        shell: bash
        run: |
          set -Eeuo pipefail

          REPO_ROOT="$PWD"
          ABS_REPORT_DIR="$REPO_ROOT/${REPORT_DIR}"
          ABS_LOG_DIR="$REPO_ROOT/${LOG_DIR}"
          ABS_ARTIFACT_DIR="$REPO_ROOT/${ARTIFACT_DIR}"

          echo "ABS_REPORT_DIR=${ABS_REPORT_DIR}"   >> $GITHUB_ENV
          echo "ABS_LOG_DIR=${ABS_LOG_DIR}"         >> $GITHUB_ENV
          echo "ABS_ARTIFACT_DIR=${ABS_ARTIFACT_DIR}" >> $GITHUB_ENV
          echo "REPO_ROOT=${REPO_ROOT}"             >> $GITHUB_ENV

          # 1) Í≥µÏö© Î≥¥Í≥†/Î°úÍ∑∏/ÏïÑÌã∞Ìå©Ìä∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p "$ABS_REPORT_DIR" "$ABS_LOG_DIR" "$ABS_ARTIFACT_DIR"

          # 2) Ï∫êÏãú/ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÏÑ†Ï†ú ÏÉùÏÑ±
          mkdir -p ~/.npm || true
          mkdir -p node_modules || true
          mkdir -p anthropic-cost-tracker/nodejs/node_modules || true
          mkdir -p mcp-hello-js/node_modules || true
          mkdir -p mcp-fs/node_modules || true

          mkdir -p ~/.cache/pip || true
          mkdir -p .venv || true
          mkdir -p anthropic-cost-tracker/python/.venv || true
          mkdir -p mcp-hello-py/.venv || true
          mkdir -p mcp-python-server/.venv || true
          mkdir -p mcp-apache-server/.venv || true

          mkdir -p ~/.m2/repository || true
          mkdir -p mcp-hello-java/target || true

          mkdir -p /tmp/.buildx-cache || true

          # 3) placeholder ÌååÏùºÎì§
          touch "$ABS_REPORT_DIR/SUMMARY.txt"
          touch "$ABS_REPORT_DIR/cache_stats.txt"
          touch "$ABS_REPORT_DIR/maven_head.txt"
          touch "$ABS_REPORT_DIR/pip_check_root.txt"
          touch "$ABS_REPORT_DIR/pip_list.json"
          touch "$ABS_REPORT_DIR/pip_outdated.json"
          touch "$ABS_REPORT_DIR/npm_audit_root.json"
          touch "$ABS_REPORT_DIR/npm_audit_cost_tracker.json"
          touch "$ABS_REPORT_DIR/npm_outdated.json"
          echo '{"init":"placeholder"}' > "$ABS_REPORT_DIR/python_env.json"

          # 4) helpers.sh ÏÉùÏÑ±
          HELPER_PATH="$ABS_REPORT_DIR/helpers.sh"
          {
            echo '#!/usr/bin/env bash'
            echo 'set -Euo pipefail'
            echo ''
            # Ï†àÎåÄÍ≤ΩÎ°ú ÏÇ¨Ïö© (Îü∞ÌÉÄÏûÑÏóê env ÏûàÏùÑ ÏàòÎèÑ, ÏóÜÏùÑ ÏàòÎèÑ)
            echo 'ABS_LOG_DIR_DEFAULT="'"$ABS_LOG_DIR"'"'
            echo 'ABS_REPORT_DIR_DEFAULT="'"$ABS_REPORT_DIR"'"'
            echo 'LOG_DIR_USE="${ABS_LOG_DIR:-$ABS_LOG_DIR_DEFAULT}"'
            echo 'REPORT_DIR_USE="${ABS_REPORT_DIR:-$ABS_REPORT_DIR_DEFAULT}"'
            echo ''
            echo 'safe_logdir() {'
            echo '  mkdir -p "$LOG_DIR_USE" "$REPORT_DIR_USE" || true'
            echo '}'
            echo ''
            echo 'safe_run() {'
            echo '  local label="$1"; shift || true'
            echo '  safe_logdir'
            echo '  local logfile="$LOG_DIR_USE/${label}.log"'
            echo '  echo "‚ñ∂ [${label}] START $(date \"+%Y-%m-%d %H:%M:%S%z\")" | tee -a "$logfile"'
            echo '  if "$@" >> "$logfile" 2>&1 ; then'
            echo '    echo "‚úÖ [${label}] OK" | tee -a "$logfile"'
            echo '    return 0'
            echo '  else'
            echo '    local rc=$?'
            echo '    echo "‚ùå [${label}] FAILED exit=${rc}" | tee -a "$logfile"'
            echo '    return $rc'
            echo '  fi'
            echo '}'
            echo ''
            echo 'apt_fix() {'
            echo '  safe_logdir'
            echo '  local logfile="$LOG_DIR_USE/apt.fix.log"'
            echo '  echo "[fix] attempting apt/dpkg repair..." | tee -a "$logfile"'
            echo '  sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true'
            echo '  sudo dpkg --configure -a || true'
            echo '  sudo apt-get update -y || sudo apt-get update -y || true'
            echo '}'
            echo ''
            echo 'ensure_docker() {'
            echo '  safe_logdir'
            echo '  local logfile="$LOG_DIR_USE/docker.ensure.log"'
            echo '  if ! command -v docker >/dev/null 2>&1; then'
            echo '    echo "[fix] docker not found, installing..." | tee -a "$logfile"'
            echo '    apt_fix'
            echo '    sudo apt-get install -y ca-certificates curl gnupg || true'
            echo '    sudo install -m 0755 -d /etc/apt/keyrings || true'
            echo '    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg || true'
            echo '    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null || true'
            echo '    apt_fix'
            echo '    sudo apt-get install -y docker.io docker-buildx-plugin docker-compose-plugin || true'
            echo '    sudo usermod -aG docker $USER || true'
            echo '  fi'
            echo '  if ! docker info >/dev/null 2>&1; then'
            echo '    echo "[fix] starting docker service..." | tee -a "$logfile"'
            echo '    sudo systemctl start docker || true'
            echo '    sleep 2'
            echo '  fi'
            echo '}'
          } > "$HELPER_PATH"
          chmod +x "$HELPER_PATH"

          # 5) SUMMARY Ìó§Îçî ÏûëÏÑ±
          {
            echo "## Dependabot Auto Merge Report"
            echo "Run: ${GITHUB_RUN_ID}"
            echo "Repo: ${GITHUB_REPOSITORY}"
            echo "PR:   ${GITHUB_REF}"
            echo "Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "----------------------------------------"
          } >> "$ABS_REPORT_DIR/SUMMARY.txt"

          echo "‚úÖ prep_all complete (absolute paths, dirs, placeholders ready)"


      ########################################################################
      # 0.2 Ï∫êÏãú Íµ¨ÏÑ± (Í≤ΩÎ°úÎäî Ïù¥ÎØ∏ mkdir -p ÎêòÏñ¥ ÏûàÏùå)
      ########################################################################
      - name: "Cache npm dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            anthropic-cost-tracker/nodejs/node_modules
            mcp-hello-js/node_modules
            mcp-fs/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: "Cache pip packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
            anthropic-cost-tracker/python/.venv
            mcp-hello-py/.venv
            mcp-python-server/.venv
            mcp-apache-server/.venv
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "Cache Maven dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            mcp-hello-java/target
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      ########################################################################
      # 1. Dependabot PR Ïó¨Î∂Ä ÌôïÏù∏
      ########################################################################
      - name: "Check if PR is dependency update"
        id: depcheck
        shell: bash
        run: |
          set -Eeuo pipefail
          FORCE="${{ github.event.inputs.force_labels || 'false' }}"
          if [ "$FORCE" = "true" ]; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          ACTOR="${{ github.actor }}"
          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'
          echo "actor=$ACTOR"        | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "labels=$LABELS_JSON" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          if echo "$ACTOR" | grep -qi "dependabot"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          if echo "$LABELS_JSON" | grep -qi "dependency"; then
            echo "forced=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "forced=false" >> $GITHUB_OUTPUT

      ########################################################################
      # 2. ÏãúÏä§ÌÖú Ï§ÄÎπÑ / npm ÏÑ§Ïπò / pip ÏÑ§Ïπò / Maven / Docker
      ########################################################################
      - name: "Repair base system (apt/dpkg/docker)"
        if: ${{ github.event.inputs.repair_mode != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"
          apt_fix || true
          ensure_docker || true

      - name: "Setup Node.js (with npm cache)"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            anthropic-cost-tracker/nodejs/package-lock.json
            mcp-hello-js/package-lock.json
            mcp-fs/package-lock.json

      - name: "Install npm deps / audit / outdated (absolute logging)"
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"

          echo "=== Installing npm dependencies and creating cache ===" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

          # Îã§Ïãú Ìïú Î≤à Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ Î≥¥Ïû•
          mkdir -p "${ABS_LOG_DIR}" "${ABS_ARTIFACT_DIR}" || true

          # Root project
          if [ -f "package.json" ]; then
            echo "‚ñ∂ Installing root npm dependencies..." | tee -a "${ABS_LOG_DIR}/npm.install.log"
            safe_run "npm.root" npm ci || safe_run "npm.root.fallback" npm install || true
            safe_run "npm.audit.root" npm audit --json > "${ABS_REPORT_DIR}/npm_audit_root.json" || true
          fi

          # anthropic-cost-tracker/nodejs
          if [ -f "anthropic-cost-tracker/nodejs/package.json" ]; then
            echo "‚ñ∂ Installing cost-tracker npm dependencies..." | tee -a "${ABS_LOG_DIR}/npm.install.log"
            cd anthropic-cost-tracker/nodejs
            safe_run "npm.cost-tracker" npm ci || safe_run "npm.cost-tracker.fallback" npm install || true
            safe_run "npm.audit.cost-tracker" npm audit --json > "${ABS_REPORT_DIR}/npm_audit_cost_tracker.json" || true
            cd "$REPO_ROOT"
          fi

          # mcp-hello-js
          if [ -f "mcp-hello-js/package.json" ]; then
            echo "‚ñ∂ Installing mcp-hello-js npm dependencies..." | tee -a "${ABS_LOG_DIR}/npm.install.log"
            cd mcp-hello-js
            safe_run "npm.mcp-hello-js" npm ci || safe_run "npm.mcp-hello-js.fallback" npm install || true
            cd "$REPO_ROOT"
          fi

          # mcp-fs
          if [ -f "mcp-fs/package.json" ]; then
            echo "‚ñ∂ Installing mcp-fs npm dependencies..." | tee -a "${ABS_LOG_DIR}/npm.install.log"
            cd mcp-fs
            safe_run "npm.mcp-fs" npm ci || safe_run "npm.mcp-fs.fallback" npm install || true
            cd "$REPO_ROOT"
          fi

          # npm outdated
          if command -v npm >/dev/null 2>&1; then
            echo "‚ñ∂ npm outdated snapshot" | tee -a "${ABS_LOG_DIR}/npm.outdated.log"
            npm outdated --json > "${ABS_REPORT_DIR}/npm_outdated.json" || true
          fi

          echo "‚úÖ npm dependencies installed and cached" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

      - name: "Setup Python runtime & cache"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: 'pip'
          cache-dependency-path: |
            requirements*.txt
            anthropic-cost-tracker/python/requirements.txt
            mcp-hello-py/requirements.txt
            mcp-python-server/requirements.txt
            mcp-apache-server/requirements.txt

      - name: "Install pip deps / snapshot"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"

          echo "=== Installing pip dependencies and creating cache ===" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

          mkdir -p "${ABS_LOG_DIR}" "${ABS_ARTIFACT_DIR}" || true

          # Upgrade pip/setup tools
          safe_run "pip.upgrade" python -m pip install --upgrade pip setuptools wheel || true

          # root
          if [ -f "requirements.txt" ]; then
            echo "‚ñ∂ Installing root pip dependencies..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
            safe_run "pip.root" pip install -r requirements.txt || true
            safe_run "pip.check.root" pip check > "${ABS_REPORT_DIR}/pip_check_root.txt" || true
          fi

          # anthropic-cost-tracker/python
          if [ -f "anthropic-cost-tracker/python/requirements.txt" ]; then
            echo "‚ñ∂ Installing cost-tracker pip dependencies..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
            safe_run "pip.cost-tracker" pip install -r anthropic-cost-tracker/python/requirements.txt || true
          fi

          # mcp-hello-py
          if [ -f "mcp-hello-py/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-hello-py pip dependencies..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-hello-py" pip install -r mcp-hello-py/requirements.txt || true
          fi

          # mcp-python-server
          if [ -f "mcp-python-server/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-python-server pip dependencies..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-python" pip install -r mcp-python-server/requirements.txt || true
          fi

          # mcp-apache-server
          if [ -f "mcp-apache-server/requirements.txt" ]; then
            echo "‚ñ∂ Installing mcp-apache-server pip dependencies..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
            safe_run "pip.mcp-apache" pip install -r mcp-apache-server/requirements.txt || true
          fi

          # any requirements-*.txt
          for req in requirements-*.txt; do
            if [ -f "$req" ]; then
              echo "‚ñ∂ Installing $req ..." | tee -a "${ABS_LOG_DIR}/pip.install.log"
              safe_run "pip.$req" pip install -r "$req" || true
            fi
          done

          # snapshot list / outdated
          pip list --format=json > "${ABS_REPORT_DIR}/pip_list.json" || true
          pip list --outdated --format=json > "${ABS_REPORT_DIR}/pip_outdated.json" || true

          echo "‚úÖ pip dependencies installed and cached" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

      - name: "Record Python runtime info"
        if: ${{ github.event.inputs.run_python_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"

          mkdir -p "${ABS_LOG_DIR}" || true

          # py_env.py to snapshot runtime info
          {
            echo 'import sys, json, platform'
            echo 'print(json.dumps({'
            echo '  "python_version": sys.version,'
            echo '  "platform": platform.platform(),'
            echo '  "ok": True'
            echo '}, indent=2))'
          } > "${ABS_REPORT_DIR}/py_env.py"

          safe_run "python.env" python "${ABS_REPORT_DIR}/py_env.py" | tee "${ABS_REPORT_DIR}/python_env.json" || true

      - name: "Setup Java (Maven cache)"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: "Run mvn -DskipTests package and snapshot deps"
        if: ${{ github.event.inputs.run_maven_build != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"

          mkdir -p "${ABS_LOG_DIR}" || true

          if [ -f "pom.xml" ]; then
            safe_run "maven.build" mvn -B -ntp clean package -DskipTests || true
            mvn -B -ntp dependency:tree | head -n 200 > "${ABS_REPORT_DIR}/maven_head.txt" || true
          else
            echo "[maven] no pom.xml in this PR branch" > "${ABS_REPORT_DIR}/maven_head.txt"
          fi

      - name: "Setup Docker Buildx with cache"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: "Cache Docker layers"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: "Docker smoke build/run (fallback Dockerfile)"
        if: ${{ github.event.inputs.run_docker_check != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source "${ABS_REPORT_DIR}/helpers.sh"

          mkdir -p "${ABS_LOG_DIR}" || true

          safe_run "docker.ensure" ensure_docker || true

          DF_FALLBACK="${ABS_REPORT_DIR}/Dockerfile.ci"
          if [ ! -f "Dockerfile" ]; then
            {
              echo 'FROM alpine:3.20'
              echo 'RUN echo "dependabot smoke container" > /hello.txt'
              echo 'CMD ["cat", "/hello.txt"]'
            } > "$DF_FALLBACK"
            DOCKERFILE="$DF_FALLBACK"
          else
            DOCKERFILE="Dockerfile"
          fi

          safe_run "docker.build" docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f "$DOCKERFILE" . -t "${DOCKER_IMG}" --load || true

          # Ï∫êÏãú ÍµêÏ≤¥
          rm -rf /tmp/.buildx-cache || true
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

          safe_run "docker.run" docker run --rm "${DOCKER_IMG}" || true

      ########################################################################
      # 3. ÏûêÎèô Î®∏ÏßÄ (Ï°∞Í±¥: depcheck.forced == true && auto_merge != false)
      ########################################################################
      - name: "Attempt auto-merge if safe"
        if: ${{ steps.depcheck.outputs.forced == 'true' && github.event.inputs.auto_merge != 'false' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "[merge] dependency update PR (#$PR_NUMBER). trying merge..." | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
          gh pr merge "$PR_NUMBER" --merge  --auto --delete-branch || true
          echo "auto-merge attempted" >> "${ABS_REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 4. Ï∫êÏãú/ÌôòÍ≤Ω ÌÜµÍ≥Ñ
      ########################################################################
      - name: "Verify cache creation and generate statistics"
        shell: bash
        run: |
          set -Eeuo pipefail

          mkdir -p "${ABS_LOG_DIR}" || true

          echo "=== Cache Verification and Statistics ===" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

          # npm cache
          if command -v npm >/dev/null 2>&1; then
            NPM_CACHE_DIR=$(npm config get cache 2>/dev/null || echo "~/.npm")
            if [ -d "$NPM_CACHE_DIR" ]; then
              NPM_CACHE_SIZE=$(du -sh "$NPM_CACHE_DIR" 2>/dev/null | cut -f1 || echo "unknown")
              echo "‚úÖ npm cache size: $NPM_CACHE_SIZE" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
              echo "npm_cache_size=$NPM_CACHE_SIZE" >> "${ABS_REPORT_DIR}/cache_stats.txt"
            fi
            NODE_MODULES_COUNT=$(find . -type d -name "node_modules" 2>/dev/null | wc -l || echo "0")
            echo "Found $NODE_MODULES_COUNT node_modules directories" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          fi

          # pip cache
          if command -v pip >/dev/null 2>&1; then
            PIP_CACHE_DIR=$(pip cache dir 2>/dev/null || echo "~/.cache/pip")
            if [ -d "$PIP_CACHE_DIR" ]; then
              PIP_CACHE_SIZE=$(du -sh "$PIP_CACHE_DIR" 2>/dev/null | cut -f1 || echo "unknown")
              echo "‚úÖ pip cache size: $PIP_CACHE_SIZE" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
              echo "pip_cache_size=$PIP_CACHE_SIZE" >> "${ABS_REPORT_DIR}/cache_stats.txt"
            fi
            if command -v jq >/dev/null 2>&1 && pip list --format=json >/tmp/pip_list.json 2>/dev/null; then
              PIP_PACKAGE_COUNT=$(jq 'length' /tmp/pip_list.json 2>/dev/null || echo "0")
            else
              PIP_PACKAGE_COUNT=$(pip list 2>/dev/null | wc -l || echo "0")
            fi
            echo "Installed $PIP_PACKAGE_COUNT pip packages" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          fi

          # Maven cache
          if [ -d "$HOME/.m2/repository" ]; then
            MAVEN_CACHE_SIZE=$(du -sh "$HOME/.m2/repository" 2>/dev/null | cut -f1 || echo "unknown")
            echo "‚úÖ Maven cache size: $MAVEN_CACHE_SIZE" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
            echo "maven_cache_size=$MAVEN_CACHE_SIZE" >> "${ABS_REPORT_DIR}/cache_stats.txt"
          fi

          # Docker cache
          if [ -d "/tmp/.buildx-cache" ]; then
            DOCKER_CACHE_SIZE=$(du -sh "/tmp/.buildx-cache" 2>/dev/null | cut -f1 || echo "unknown")
            echo "‚úÖ Docker buildx cache size: $DOCKER_CACHE_SIZE" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
            echo "docker_cache_size=$DOCKER_CACHE_SIZE" >> "${ABS_REPORT_DIR}/cache_stats.txt"
          fi

          echo "" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "GitHub Actions Cache Keys:" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "  * npm:    ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "  * pip:    ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "  * maven:  ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "  * docker: ${{ runner.os }}-buildx-${{ github.sha }}" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"
          echo "‚úÖ Cache verification completed" | tee -a "${ABS_REPORT_DIR}/SUMMARY.txt"

      ########################################################################
      # 5. Î¶¨Ìè¨Ìä∏/Î°úÍ∑∏ ÏïÑÌã∞Ìå©Ìä∏ ÏóÖÎ°úÎìú
      ########################################################################
      - name: "Upload dependabot-check artifact (logs+reports+caches-meta)"
        if: ${{ github.event.inputs.upload_artifact != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-check-${{ github.run_id }}
          path: .github/dependabot_report
          if-no-files-found: warn
          retention-days: 14
