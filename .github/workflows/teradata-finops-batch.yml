name: "ğŸ¦ Teradata FinOps Batch â€” EchoOps + Audit + Snapshot + ISO + DR(1ì¼ë³´ê´€) + DBA + SafeEcho (v9)"

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      echo_trace:
        description: "ëª¨ë“  ë‹¨ê³„ì—ì„œ echo(set -x) í™œì„±í™” ì—¬ë¶€"
        type: choice
        options: ["true", "false"]
        default: "false"

permissions:
  contents: write

jobs:
  finops_pipeline:
    runs-on: ubuntu-latest
    steps:
      #######################################################################
      # 0. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      #######################################################################
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      #######################################################################
      # 1. ì „ì—­ echo_trace ì„¤ì •
      #######################################################################
      - name: ğŸ”Š ì „ì—­ echo_trace í† ê¸€
        run: |
          if [ "${{ github.event.inputs.echo_trace || 'false' }}" = "true" ]; then
            echo "ECHO_TRACE_GLOBAL=true" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = ON"
          else
            echo "ECHO_TRACE_GLOBAL=false" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = OFF"
          fi

      #######################################################################
      # 2. Bootstrap /tmp/echo_helpers.sh
      #######################################################################
      - name: âš™ï¸ Bootstrap EchoOps Helper
        run: |
          set -e
          mkdir -p /home/runner/td_data/{logs,tmp,release,history}
          cat > /tmp/echo_helpers.sh <<'EOSH'
          #!/usr/bin/env bash
          set -Eeuo pipefail
          ts() { date +%Y-%m-%dT%H:%M:%S%z; }
          echo_note() { echo "â–¶ $(ts) $*" | tee -a "/home/runner/td_data/logs/echo.log"; }
          if [ "${ECHO_TRACE_GLOBAL:-}" = "true" ]; then
            export PS4='+ $(date "+%Y-%m-%dT%H:%M:%S%z") ${BASH_SOURCE##*/}:${LINENO}: '
            set -x
          fi
          trap 'echo_note "âš ï¸ Error (exit code $?) in ${BASH_SOURCE##*/}:${LINENO}"' ERR
          EOSH
          chmod +x /tmp/echo_helpers.sh
          echo "::notice::Helper script ready (/tmp/echo_helpers.sh)"

      #######################################################################
      # 3. Echo Trace í…ŒìŠ¤íŠ¸
      #######################################################################
      - name: ğŸ§ª Echo Trace í™•ì¸ í…ŒìŠ¤íŠ¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì‹œì‘"
          echo "í˜„ì¬ PS4 ì„¤ì •:"
          echo "$PS4"
          sleep 1
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì¢…ë£Œ"

      #######################################################################
      # 4. ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ & ë³´ì•ˆ íŒ¨ì¹˜
      #######################################################################
      - name: â¬†ï¸ ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ/ë³´ì•ˆ íŒ¨ì¹˜
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘"
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y unattended-upgrades ca-certificates
          echo_note "ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      #######################################################################
      # 5. PostgreSQL ì„¤ì¹˜
      #######################################################################
      - name: ğŸ›¢ï¸ PostgreSQL ì„œë²„ ì„¤ì¹˜ ë° ë¶€íŠ¸ìŠ¤íŠ¸ë©
        run: |
          source /tmp/echo_helpers.sh
          echo_note "PostgreSQL ì„¤ì¹˜"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postgresql postgresql-contrib
          sudo systemctl start postgresql
          sudo -u postgres psql -v ON_ERROR_STOP=1 <<'SQL'
          CREATE DATABASE finops;
          DO $$BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'finops') THEN
              CREATE ROLE finops LOGIN PASSWORD 'finops';
            END IF;
          END$$;
          GRANT ALL PRIVILEGES ON DATABASE finops TO finops;
          SQL

      #######################################################################
      # 6. DR í´ëŸ¬ìŠ¤í„° êµ¬ì¶•
      #######################################################################
      - name: ğŸ›°ï¸ DR PostgreSQL ê²½ëŸ‰ ìŠ¤íƒ ë°”ì´ êµ¬ì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "DR í´ëŸ¬ìŠ¤í„° ìƒì„±"
          PG_MAJOR=$(psql -V | awk '{print $3}' | cut -d. -f1)
          sudo pg_createcluster "$PG_MAJOR" dr --start -p 5433
          sudo pg_lsclusters

      #######################################################################
      # 7. ISO/DR Resource ìƒì„± + SQL ëŒ€ëŸ‰ íŒŒì¼ ìƒì„± (ê¶Œí•œ ë¬¸ì œ ì˜êµ¬ í•´ê²°)
      #######################################################################
      - name: ğŸ§± ë¦¬ì†ŒìŠ¤/ì¿¼ë¦¬ ëŒ€ëŸ‰ ìƒì„± ë° ì£¼ì… (ê¶Œí•œ Fix ì ìš©)
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ISO/DRìš© ë¦¬ì†ŒìŠ¤ ìƒì„±"

          mkdir -p /home/runner/td_data/{iso_payloads,queries,resources}

          # ë¦¬ì†ŒìŠ¤ ìƒì„±
          seq 1 50 | xargs -I{} sh -c 'echo "RESOURCE_{}" > /home/runner/td_data/resources/resource_{}.txt'

          # SQL ìƒì„± (runner ê¶Œí•œìœ¼ë¡œ ìƒì„±)
          for i in $(seq 1 20); do
            echo "SELECT ${i} AS seq_id, now() AS generated_at;" > /home/runner/td_data/queries/query_${i}.sql
          done

          # ğŸ”¥ğŸ”¥ğŸ”¥ í•µì‹¬ FIX: postgresê°€ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì „ì²´ ê¶Œí•œ ë¶€ì—¬
          chmod -R 755 /home/runner/td_data/queries

          echo_note "ë°ì´í„°ë² ì´ìŠ¤ì— ìƒ˜í”Œ ë°ì´í„° ì£¼ì… ì‹œì‘"
          sudo -u postgres psql -d finops -v ON_ERROR_STOP=1 <<'SQL'
          CREATE TABLE IF NOT EXISTS audit_snapshots (
            id SERIAL PRIMARY KEY,
            bucket VARCHAR(32) NOT NULL,
            payload JSONB NOT NULL,
            created_at TIMESTAMPTZ DEFAULT now()
          );
          INSERT INTO audit_snapshots (bucket, payload)
          SELECT 'iso-bucket', jsonb_build_object('row', g)
          FROM generate_series(1, 100) AS g;
          SQL

          echo_note "ëŒ€ëŸ‰ SQL íŒŒì¼ ì‹¤í–‰ í…ŒìŠ¤íŠ¸"
          sudo -u postgres psql -d finops -f /home/runner/td_data/queries/query_1.sql

      #######################################################################
      # 8. ì¶”ê°€ DB ë„êµ¬ ì„¤ì¹˜
      #######################################################################
      - name: ğŸ“¦ ì¶”ê°€ DB ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜
        run: |
          source /tmp/echo_helpers.sh
          sudo apt-get install -y sqlite3 mysql-client unixodbc-bin

      #######################################################################
      # 9. ë³´ì•ˆ íˆ´ ì„¤ì¹˜
      #######################################################################
      - name: ğŸ›¡ï¸ ë°”ì´ëŸ¬ìŠ¤/ë³´ì•ˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          source /tmp/echo_helpers.sh
          sudo apt-get install -y clamav clamav-daemon
          sudo freshclam || true

      #######################################################################
      # 10. ê°€ìƒ ë°ì´í„° ìƒì„±
      #######################################################################
      - name: ğŸ“¦ ê°€ìƒ ë°ì´í„° ìƒì„±
        run: |
          source /tmp/echo_helpers.sh
          mkdir -p /home/runner/td_data/tmp
          for i in $(seq 1 5); do
            echo "ROW_${i},VALUE_$((RANDOM%1000))" >> /home/runner/td_data/tmp/sample.csv
          done

      #######################################################################
      # 11. í’ˆì§ˆê²€ì¦
      #######################################################################
      - name: âœ… í’ˆì§ˆ ê²€ì¦ ë‹¨ê³„
        run: |
          source /tmp/echo_helpers.sh
          COUNT=$(wc -l < /home/runner/td_data/tmp/sample.csv)
          if [ "$COUNT" -lt 5 ]; then exit 1; fi

      #######################################################################
      # 12. ì¢…ë£Œ
      #######################################################################
      - name: ğŸ•’ ì¢…ë£Œ ë¡œê·¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "FinOps Batch ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ"
