name: "ğŸ¦ Teradata FinOps Batch â€” EchoOps + Audit + Snapshot + ISO + DR(1ì¼ë³´ê´€) + DBA + SafeEcho"

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      echo_trace:
        description: "ëª¨ë“  ë‹¨ê³„ì—ì„œ echo(set -x) í™œì„±í™” ì—¬ë¶€"
        type: choice
        options: ["true", "false"]
        default: "false"

permissions:
  contents: write

jobs:
  finops_pipeline:
    runs-on: ubuntu-latest
    steps:
      #######################################################################
      # 0. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      #######################################################################
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      #######################################################################
      # 1. ì „ì—­ echo_trace ì„¤ì •
      #######################################################################
      - name: ğŸ”Š ì „ì—­ echo_trace í† ê¸€
        run: |
          if [ "${{ github.event.inputs.echo_trace || 'false' }}" = "true" ]; then
            echo "ECHO_TRACE_GLOBAL=true" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = ON"
          else
            echo "ECHO_TRACE_GLOBAL=false" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = OFF"
          fi
      #######################################################################
      # 2. ë¶€íŠ¸ìŠ¤íŠ¸ë© ë° /tmp/echo_helpers.sh ìƒì„±
      #######################################################################
      - name: âš™ï¸ Bootstrap EchoOps Helper
        run: |
          set -e
          mkdir -p /home/runner/td_data/{logs,tmp,release,history}
          cat > /tmp/echo_helpers.sh <<'EOSH'
          #!/usr/bin/env bash
          set -Eeuo pipefail
          ts() { date +%Y-%m-%dT%H:%M:%S%z; }
          echo_note() { echo "â–¶ $(ts) $*" | tee -a "/home/runner/td_data/logs/echo.log"; }
          # ì „ì—­ echo_trace í† ê¸€ ì‹œ trace í™œì„±í™”
          if [ "${ECHO_TRACE_GLOBAL:-}" = "true" ]; then
            export PS4='+ $(date "+%Y-%m-%dT%H:%M:%S%z") ${BASH_SOURCE##*/}:${LINENO}: '
            set -x
          fi
          trap 'echo_note "âš ï¸ Error (exit code $?) in ${BASH_SOURCE##*/}:${LINENO}"' ERR
          EOSH
          chmod +x /tmp/echo_helpers.sh
          echo "::notice::Helper script ready (/tmp/echo_helpers.sh)"
      #######################################################################
      # 3. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ - ì „ì—­ echo_trace í™•ì¸
      #######################################################################
      - name: ğŸ§ª Echo Trace í™•ì¸ í…ŒìŠ¤íŠ¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì‹œì‘"
          echo "í˜„ì¬ PS4 ì„¤ì • í™•ì¸:"
          echo "$PS4"
          echo_note "Sample command ì‹¤í–‰ ì¤‘..."
          sleep 1
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì¢…ë£Œ"
      #######################################################################
      # 4. ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ ë° íŒ¨ì¹˜
      #######################################################################
      - name: â¬†ï¸ ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ/ë³´ì•ˆ íŒ¨ì¹˜
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘"
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y unattended-upgrades ca-certificates
          echo_note "ë³´ì•ˆ íŒ¨í‚¤ì§€ ë° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ"
      #######################################################################
      # 5. ê¸°ë³¸ DB ì„œë²„ ì„¤ì¹˜ ë° ì´ˆê¸°í™”
      #######################################################################
      - name: ğŸ›¢ï¸ PostgreSQL ì„œë²„ ì„¤ì¹˜ ë° ë¶€íŠ¸ìŠ¤íŠ¸ë©
        run: |
          source /tmp/echo_helpers.sh
          echo_note "PostgreSQL ì„¤ì¹˜ ì‹œì‘"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postgresql postgresql-contrib
          echo_note "PostgreSQL ì„œë¹„ìŠ¤ ì‹œì‘"
          sudo systemctl start postgresql
          sudo systemctl status postgresql --no-pager
          echo_note "ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤/ê³„ì • ìƒì„±"
          sudo -u postgres psql -v ON_ERROR_STOP=1 <<'SQL'
          CREATE DATABASE finops;
          DO $$BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'finops') THEN
              CREATE ROLE finops LOGIN PASSWORD 'finops';
            END IF;
          END$$;
          GRANT ALL PRIVILEGES ON DATABASE finops TO finops;
          SQL
          echo_note "DB ì—°ê²° í™•ì¸"
          sudo -u postgres psql -d finops -c "SELECT version();"
          echo_note "PostgreSQL ì´ˆê¸°í™” ì™„ë£Œ"
      #######################################################################
      # 6. DR í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ë° ìƒíƒœ í™•ì¸
      #######################################################################
      - name: ğŸ›°ï¸ DR PostgreSQL ê²½ëŸ‰ ìŠ¤íƒ ë°”ì´ êµ¬ì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "DRìš© PostgreSQL í´ëŸ¬ìŠ¤í„° ìƒì„± ì‹œì‘"
          PG_MAJOR=$(psql -V | awk '{print $3}' | cut -d. -f1)
          sudo pg_createcluster "$PG_MAJOR" dr --start -p 5433
          sudo pg_lsclusters
          echo_note "DR í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸"
          sudo -u postgres psql -p 5433 -c "SELECT current_setting('port') AS port, current_setting('max_connections') AS max_conn;"
          echo_note "DR í´ëŸ¬ìŠ¤í„° ê¸°ë™ ì™„ë£Œ"
      #######################################################################
      # 7. ISO/DBìš© ë¦¬ì†ŒìŠ¤ ë° ëŒ€ëŸ‰ ì¿¼ë¦¬ ìƒì„±
      #######################################################################
      - name: ğŸ§± ë¦¬ì†ŒìŠ¤/ì¿¼ë¦¬ ëŒ€ëŸ‰ ìƒì„± ë° ì£¼ì…
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ISO/DRìš© ë¦¬ì†ŒìŠ¤ ìƒì„±"
          mkdir -p /home/runner/td_data/{iso_payloads,queries,resources}
          seq 1 50 | xargs -I{} sh -c 'echo "RESOURCE_{}" > /home/runner/td_data/resources/resource_{}.txt'
          seq 1 20 | xargs -I{} sh -c 'echo "SELECT {} AS seq_id, now() AS generated_at;" > /home/runner/td_data/queries/query_{}.sql'
          chmod -R a+r /home/runner/td_data/queries
          echo_note "ë°ì´í„°ë² ì´ìŠ¤ì— ìƒ˜í”Œ ë°ì´í„° ì£¼ì…"
          sudo -u postgres psql -d finops -v ON_ERROR_STOP=1 <<'SQL'
          CREATE TABLE IF NOT EXISTS audit_snapshots (
            id SERIAL PRIMARY KEY,
            bucket VARCHAR(32) NOT NULL,
            payload JSONB NOT NULL,
            created_at TIMESTAMPTZ DEFAULT now()
          );
          INSERT INTO audit_snapshots (bucket, payload)
          SELECT 'iso-bucket', jsonb_build_object('row', g)::jsonb
          FROM generate_series(1, 100) AS g;
          SQL
          echo_note "ëŒ€ëŸ‰ ì¿¼ë¦¬ ìƒ˜í”Œ ì‹¤í–‰"
          sudo -u postgres psql -d finops -f /home/runner/td_data/queries/query_1.sql
          sudo -u postgres psql -d finops -c "SELECT count(*) FROM audit_snapshots;"
          echo_note "ISO/DB ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œ"
      #######################################################################
      # 8. ì¶”ê°€ DB/SQL í”„ë¡œê·¸ë¨ ì„¤ì¹˜
      #######################################################################
      - name: ğŸ“¦ ì¶”ê°€ DB ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜ (SQLite/MySQL í´ë¼ì´ì–¸íŠ¸)
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ì¶”ê°€ DB ë„êµ¬ ì„¤ì¹˜ ì‹œì‘"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y sqlite3 mysql-client unixodbc-bin
          sqlite3 --version
          mysql --version
          echo_note "DB ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜ ì™„ë£Œ"
      #######################################################################
      # 9. ë°”ì´ëŸ¬ìŠ¤/ë³´ì•ˆ í”„ë¡œê·¸ë¨ ì„¤ì¹˜
      #######################################################################
      - name: ğŸ›¡ï¸ ë°”ì´ëŸ¬ìŠ¤/ë³´ì•ˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ë³´ì•ˆ ìŠ¤ìºë„ˆ ì„¤ì¹˜"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y clamav clamav-daemon
          sudo freshclam || echo "freshclam skipped (rate limit)"
          sudo systemctl start clamav-freshclam || true
          sudo systemctl status clamav-freshclam --no-pager
          echo_note "ë³´ì•ˆ êµ¬ì„± ì™„ë£Œ"
      #######################################################################
      # 10. ì˜ˆì‹œ ë°ì´í„° ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
      #######################################################################
      - name: ğŸ“¦ ê°€ìƒ ë°ì´í„° ìƒì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹œì‘"
          mkdir -p /home/runner/td_data/tmp
          for i in $(seq 1 5); do
            echo "ROW_${i},VALUE_$((RANDOM%1000))" >> /home/runner/td_data/tmp/sample.csv
          done
          echo_note "CSV íŒŒì¼ ìƒì„± ì™„ë£Œ"
          ls -lh /home/runner/td_data/tmp
      #######################################################################
      # 11. í’ˆì§ˆê²€ì¦ ë‹¨ê³„ ì˜ˆì‹œ
      #######################################################################
      - name: âœ… í’ˆì§ˆ ê²€ì¦ ë¡œê·¸ ì‘ì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "í’ˆì§ˆê²€ì¦ ì‹œì‘"
          COUNT=$(wc -l < /home/runner/td_data/tmp/sample.csv)
          echo_note "ìƒì„±ëœ í–‰ ìˆ˜: ${COUNT}"
          if [ "$COUNT" -lt 5 ]; then
            echo_note "âŒ ë°ì´í„° ë¶€ì¡±"
            exit 1
          else
            echo_note "âœ… ë°ì´í„° í’ˆì§ˆ OK"
          fi
      #######################################################################
      # 12. ì¢…ë£Œ ë° íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
      #######################################################################
      - name: ğŸ•’ ì¢…ë£Œ ë¡œê·¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "FinOps Batch ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ"