name: "ğŸ¦ Teradata FinOps Batch â€” EchoOps + Audit + Snapshot + ISO + DR(1ì¼ë³´ê´€) + DBA + SafeEcho"

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      echo_trace:
        description: "ëª¨ë“  ë‹¨ê³„ì—ì„œ echo(set -x) í™œì„±í™” ì—¬ë¶€"
        type: choice
        options: ["true", "false"]
        default: "false"

permissions:
  contents: write

jobs:
  finops_pipeline:
    runs-on: ubuntu-latest
    steps:
      #######################################################################
      # 0. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      #######################################################################
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      #######################################################################
      # 1. ì „ì—­ echo_trace ì„¤ì •
      #######################################################################
      - name: ğŸ”Š ì „ì—­ echo_trace í† ê¸€
        run: |
          if [ "${{ github.event.inputs.echo_trace || 'false' }}" = "true" ]; then
            echo "ECHO_TRACE_GLOBAL=true" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = ON"
          else
            echo "ECHO_TRACE_GLOBAL=false" >> "$GITHUB_ENV"
            echo "::notice::Global echo_trace = OFF"
          fi
      #######################################################################
      # 2. ë¶€íŠ¸ìŠ¤íŠ¸ë© ë° /tmp/echo_helpers.sh ìƒì„±
      #######################################################################
      - name: âš™ï¸ Bootstrap EchoOps Helper
        run: |
          set -e
          mkdir -p /home/runner/td_data/{logs,tmp,release,history}
          cat > /tmp/echo_helpers.sh <<'EOSH'
          #!/usr/bin/env bash
          set -Eeuo pipefail
          ts() { date +%Y-%m-%dT%H:%M:%S%z; }
          echo_note() { echo "â–¶ $(ts) $*" | tee -a "/home/runner/td_data/logs/echo.log"; }
          # ì „ì—­ echo_trace í† ê¸€ ì‹œ trace í™œì„±í™”
          if [ "${ECHO_TRACE_GLOBAL:-}" = "true" ]; then
            export PS4='+ $(date "+%Y-%m-%dT%H:%M:%S%z") ${BASH_SOURCE##*/}:${LINENO}: '
            set -x
          fi
          trap 'echo_note "âš ï¸ Error (exit code $?) in ${BASH_SOURCE##*/}:${LINENO}"' ERR
          EOSH
          chmod +x /tmp/echo_helpers.sh
          echo "::notice::Helper script ready (/tmp/echo_helpers.sh)"
      #######################################################################
      # 3. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ - ì „ì—­ echo_trace í™•ì¸
      #######################################################################
      - name: ğŸ§ª Echo Trace í™•ì¸ í…ŒìŠ¤íŠ¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì‹œì‘"
          echo "í˜„ì¬ PS4 ì„¤ì • í™•ì¸:"
          echo "$PS4"
          echo_note "Sample command ì‹¤í–‰ ì¤‘..."
          sleep 1
          echo_note "Echo Trace í…ŒìŠ¤íŠ¸ ì¢…ë£Œ"
      #######################################################################
      # 4. DB ì„œë²„ ì„¤ì¹˜ ë° ì´ˆê¸°í™”
      #######################################################################
      - name: ğŸ›¢ï¸ PostgreSQL ì„œë²„ ì„¤ì¹˜ ë° ë¶€íŠ¸ìŠ¤íŠ¸ë©
        run: |
          source /tmp/echo_helpers.sh
          echo_note "PostgreSQL ì„¤ì¹˜ ì‹œì‘"
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postgresql postgresql-contrib
          echo_note "PostgreSQL ì„œë¹„ìŠ¤ ì‹œì‘"
          sudo systemctl start postgresql
          sudo systemctl status postgresql --no-pager
          echo_note "ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤/ê³„ì • ìƒì„±"
          sudo -u postgres psql -v ON_ERROR_STOP=1 <<'SQL'
          CREATE DATABASE finops;
          DO $$BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'finops') THEN
              CREATE ROLE finops LOGIN PASSWORD 'finops';
            END IF;
          END$$;
          GRANT ALL PRIVILEGES ON DATABASE finops TO finops;
          SQL
          echo_note "DB ì—°ê²° í™•ì¸"
          sudo -u postgres psql -d finops -c "SELECT version();"
          echo_note "PostgreSQL ì´ˆê¸°í™” ì™„ë£Œ"
      #######################################################################
      # 5. ì˜ˆì‹œ ë°ì´í„° ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
      #######################################################################
      - name: ğŸ“¦ ê°€ìƒ ë°ì´í„° ìƒì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹œì‘"
          mkdir -p /home/runner/td_data/tmp
          for i in $(seq 1 5); do
            echo "ROW_${i},VALUE_$((RANDOM%1000))" >> /home/runner/td_data/tmp/sample.csv
          done
          echo_note "CSV íŒŒì¼ ìƒì„± ì™„ë£Œ"
          ls -lh /home/runner/td_data/tmp
      #######################################################################
      # 6. í’ˆì§ˆê²€ì¦ ë‹¨ê³„ ì˜ˆì‹œ
      #######################################################################
      - name: âœ… í’ˆì§ˆ ê²€ì¦ ë¡œê·¸ ì‘ì„±
        run: |
          source /tmp/echo_helpers.sh
          echo_note "í’ˆì§ˆê²€ì¦ ì‹œì‘"
          COUNT=$(wc -l < /home/runner/td_data/tmp/sample.csv)
          echo_note "ìƒì„±ëœ í–‰ ìˆ˜: ${COUNT}"
          if [ "$COUNT" -lt 5 ]; then
            echo_note "âŒ ë°ì´í„° ë¶€ì¡±"
            exit 1
          else
            echo_note "âœ… ë°ì´í„° í’ˆì§ˆ OK"
          fi
      #######################################################################
      # 7. ì¢…ë£Œ ë° íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
      #######################################################################
      - name: ğŸ•’ ì¢…ë£Œ ë¡œê·¸
        run: |
          source /tmp/echo_helpers.sh
          echo_note "FinOps Batch ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ"
