name: "ğŸ’± Trade Framework â€” Infinity LTS (Full EchoOps + Zero Syntax Error)"

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [create, lock, unlock, execute]
        default: create
      trade_id:
        required: false
        default: ""
      amount:
        required: false
        default: "0"

jobs:
  trade_framework:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Seoul
      LOG_DIR: workflow_logs
      JSON_DIR: workflow_logs/json

    steps:
      ###########################################################################
      # INIT â€” â˜… ì•ˆì • ëª¨ë“œ EchoOps
      ###########################################################################
      - name: "ğŸ”§ Init EchoOps"
        shell: bash
        run: |
          set -Eeuo pipefail

          echo "=== INIT ==="

          mkdir -p "$LOG_DIR"
          mkdir -p "$JSON_DIR"

          cat <<'EOS' > /tmp/echo.sh
#!/usr/bin/env bash
safe_echo() { echo "â–¶ $(date +'%Y-%m-%dT%H:%M:%S') Â» $1"; }
echo_trace() { echo "TRACE $(date +'%H:%M:%S') Â» $1"; }
EOS

          chmod +x /tmp/echo.sh
          source /tmp/echo.sh

          safe_echo "EchoOps Engine Loaded"
          echo "=== INIT DONE ==="

      ###########################################################################
      # CREATE â€” â˜… ëª¨ë“  echo í˜¸ì¶œ + EOF ì•ˆì „ ë²„ì „
      ###########################################################################
      - name: "ğŸ†• Create Trade"
        if: ${{ inputs.action == 'create' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo.sh

          safe_echo "[CREATE] ì‹œì‘"

          TRADE_ID="T$(date +%s)"
          AMOUNT="${{ inputs.amount }}"

          echo_trace "TRADE_ID=$TRADE_ID"
          echo_trace "AMOUNT=$AMOUNT"

          echo "TRADE_ID=$TRADE_ID" >> $GITHUB_ENV

          LOG_FILE="$LOG_DIR/trade_${TRADE_ID}_create.log"
          JSON_FILE="$JSON_DIR/trade_${TRADE_ID}.json"

          safe_echo "ë¡œê·¸ íŒŒì¼ ìƒì„±: $LOG_FILE"
          cat <<EOF > "$LOG_FILE"
[TRADE CREATE]
Trade ID: $TRADE_ID
Amount: $AMOUNT
Status: CREATED
Timestamp: $(date +'%Y-%m-%d %H:%M:%S')
EOF

          safe_echo "JSON ìƒì„±: $JSON_FILE"
          cat <<EOF > "$JSON_FILE"
{
  "trade_id": "$TRADE_ID",
  "amount": "$AMOUNT",
  "action": "create",
  "status": "created",
  "timestamp": "$(date +'%Y-%m-%d %H:%M:%S')"
}
EOF

          safe_echo "[CREATE] ì™„ë£Œ"

      ###########################################################################
      # LOCK â€” â˜… echo full + null ì•ˆì „
      ###########################################################################
      - name: "ğŸ”’ Lock Trade"
        if: ${{ inputs.action == 'lock' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo.sh

          safe_echo "[LOCK] ì‹œì‘"

          TRADE_ID="${{ inputs.trade_id }}"
          echo_trace "TRADE_ID=$TRADE_ID"

          if [[ -z "$TRADE_ID" ]]; then
            safe_echo "âŒ trade_id ì—†ìŒ"
            exit 1
          fi

          LOCK_FILE="$LOG_DIR/trade_${TRADE_ID}.lock"
          echo_trace "LOCK_FILE=$LOCK_FILE"

          echo "LOCKED" > "$LOCK_FILE"
          safe_echo "[LOCK] ì™„ë£Œ"

      ###########################################################################
      # UNLOCK â€” â˜… echo full + íŒŒì¼ ì²´í¬ ì•ˆì • ë²„ì „
      ###########################################################################
      - name: "ğŸ”“ Unlock Trade"
        if: ${{ inputs.action == 'unlock' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo.sh

          safe_echo "[UNLOCK] ì‹œì‘"

          TRADE_ID="${{ inputs.trade_id }}"
          echo_trace "TRADE_ID=$TRADE_ID"

          LOCK_FILE="$LOG_DIR/trade_${TRADE_ID}.lock"
          echo_trace "LOCK_FILE=$LOCK_FILE"

          if [[ ! -f "$LOCK_FILE" ]]; then
            safe_echo "ì´ë¯¸ í•´ì œ ìƒíƒœ"
          else
            rm -f "$LOCK_FILE"
            safe_echo "í•´ì œë¨"
          fi

          safe_echo "[UNLOCK] ì™„ë£Œ"

      ###########################################################################
      # EXECUTE â€” â˜… echo full + EOF ì•ˆì „ ë²„ì „
      ###########################################################################
      - name: "ğŸš€ Execute Trade"
        if: ${{ inputs.action == 'execute' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          source /tmp/echo.sh

          safe_echo "[EXECUTE] ì‹œì‘"

          TRADE_ID="${{ inputs.trade_id }}"
          AMOUNT="${{ inputs.amount }}"

          echo_trace "TRADE_ID=$TRADE_ID"
          echo_trace "AMOUNT=$AMOUNT"

          LOCK_FILE="$LOG_DIR/trade_${TRADE_ID}.lock"

          if [[ -f "$LOCK_FILE" ]]; then
            safe_echo "âŒ LOCK ìƒíƒœ â€” ì‹¤í–‰ ë¶ˆê°€"
            exit 1
          fi

          LOG_FILE="$LOG_DIR/trade_${TRADE_ID}_execute.log"
          JSON_FILE="$JSON_DIR/trade_${TRADE_ID}.json"

          safe_echo "ë¡œê·¸ ìƒì„±: $LOG_FILE"
          cat <<EOF > "$LOG_FILE"
[TRADE EXECUTE]
Trade ID: $TRADE_ID
Amount: $AMOUNT
Executed: OK
Timestamp: $(date +'%Y-%m-%d %H:%M:%S')
EOF

          safe_echo "JSON ê°±ì‹ : $JSON_FILE"
          cat <<EOF > "$JSON_FILE"
{
  "trade_id": "$TRADE_ID",
  "amount": "$AMOUNT",
  "action": "execute",
  "status": "executed",
  "timestamp": "$(date +'%Y-%m-%d %H:%M:%S')"
}
EOF

          safe_echo "[EXECUTE] ì™„ë£Œ"

      ###########################################################################
      # LOG UPLOAD
      ###########################################################################
      - name: "ğŸ“¤ Upload Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-framework-infinity-logs
          path: workflow_logs
